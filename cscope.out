cscope 15 $HOME\Desktop\INTEL\src\Webserver"               0000567400
	@App/App.cpp

26 
	~<¡dio.h
>

27 
	~<¡ršg.h
>

28 
	~<as£¹.h
>

30 #ifdeà
_MSC_VER


31 
	~<Shlobj.h
>

33 
	~<uni¡d.h
>

34 
	~<pwd.h
>

35 
	#MAX_PATH
 
FILENAME_MAX


	)

38 
	~"sgx_u¹s.h
"

39 
	~"sgx_u«_£rviû.h
"

40 
	~"Aµ.h
"

41 
	~"Enşave_u.h
"

43 "C" 
FILE
* 
g‘STDOUT
();

44 
	~"funùiÚs.h
"

47 
sgx_’şave_id_t
 
	gglob®_eid
 = 0;

49 
	s_sgx_”¾i¡_t
 {

50 
sgx_¡©us_t
 
	m”r
;

51 cÚ¡ *
	mmsg
;

52 cÚ¡ *
	msug
;

53 } 
	tsgx_”¾i¡_t
;

56 
sgx_”¾i¡_t
 
	gsgx_”¾i¡
[] = {

58 
SGX_ERROR_UNEXPECTED
,

60 
NULL


63 
SGX_ERROR_INVALID_PARAMETER
,

65 
NULL


68 
SGX_ERROR_OUT_OF_MEMORY
,

70 
NULL


73 
SGX_ERROR_ENCLAVE_LOST
,

78 
SGX_ERROR_INVALID_ENCLAVE
,

80 
NULL


83 
SGX_ERROR_INVALID_ENCLAVE_ID
,

85 
NULL


88 
SGX_ERROR_INVALID_SIGNATURE
,

90 
NULL


93 
SGX_ERROR_OUT_OF_EPC
,

95 
NULL


98 
SGX_ERROR_NO_DEVICE
,

103 
SGX_ERROR_MEMORY_MAP_CONFLICT
,

105 
NULL


108 
SGX_ERROR_INVALID_METADATA
,

110 
NULL


113 
SGX_ERROR_DEVICE_BUSY
,

115 
NULL


118 
SGX_ERROR_INVALID_VERSION
,

120 
NULL


123 
SGX_ERROR_INVALID_ATTRIBUTE
,

125 
NULL


128 
SGX_ERROR_ENCLAVE_FILE_ACCESS
,

130 
NULL


133 
SGX_ERROR_NDEBUG_ENCLAVE
,

135 
NULL


140 
	$´št_”rÜ_mes§ge
(
sgx_¡©us_t
 
»t
)

142 
size_t
 
idx
 = 0;

143 
size_t
 
‰l
 =  
sgx_”¾i¡
/ sgx_errlist[0];

145 
idx
 = 0; idx < 
‰l
; idx++) {

146 if(
»t
 =ğ
sgx_”¾i¡
[
idx
].
”r
) {

147 if(
NULL
 !ğ
sgx_”¾i¡
[
idx
].
sug
)

148 
	`´štf
("Info: %s\n", 
sgx_”¾i¡
[
idx
].
sug
);

149 
	`´štf
("E¼Ü: %s\n", 
sgx_”¾i¡
[
idx
].
msg
);

154 ià(
idx
 =ğ
‰l
)

155 
	`´štf
("Error: Unexpectedƒrror occurred.\n");

156 
	}
}

163 
	$š™Ÿlize_’şave
()

165 
tok’_·th
[
MAX_PATH
] = {'\0'};

166 
sgx_Ïunch_tok’_t
 
tok’
 = {0};

167 
sgx_¡©us_t
 
»t
 = 
SGX_ERROR_UNEXPECTED
;

168 
upd©ed
 = 0;

173 #ifdeà
_MSC_VER


175 ià(
S_OK
 !ğ
	`SHG‘FŞd”P©hA
(
NULL
, 
CSIDL_LOCAL_APPDATA
, NULL, 0, 
tok’_·th
)) {

176 
	`¡ºıy_s
(
tok’_·th
, 
	`_couÁof
Ñok’_·th), 
TOKEN_FILENAME
, (TOKEN_FILENAME));

178 
	`¡ºÿt_s
(
tok’_·th
, 
	`_couÁof
Ñok’_·th), "\\" 
TOKEN_FILENAME
, (TOKEN_FILENAME)+2);

182 
HANDLE
 
tok’_hªdËr
 = 
	`C»©eFeA
(
tok’_·th
, 
GENERIC_READ
|
GENERIC_WRITE
, 
FILE_SHARE_READ
, 
NULL
, 
OPEN_ALWAYS
, NULL, NULL);

183 ià(
tok’_hªdËr
 =ğ
INVALID_HANDLE_VALUE
) {

184 
	`´štf
("W¬nšg: FaedØü—‹/İ’hÏunchok’ f\"%s\".\n", 
tok’_·th
);

187 
DWORD
 
»ad_num
 = 0;

188 
	`R—dFe
(
tok’_hªdËr
, 
tok’
, (
sgx_Ïunch_tok’_t
), &
»ad_num
, 
NULL
);

189 ià(
»ad_num
 !ğ0 &&„—d_num !ğ(
sgx_Ïunch_tok’_t
)) {

191 
	`mem£t
(&
tok’
, 0x0, (
sgx_Ïunch_tok’_t
));

192 
	`´štf
("W¬nšg: Inv®id†aunchok’„—d from \"%s\".\n", 
tok’_·th
);

197 cÚ¡ *
home_dœ
 = 
	`g‘pwuid
(
	`g‘uid
())->
pw_dœ
;

199 ià(
home_dœ
 !ğ
NULL
 &&

200 (
	`¡¾’
(
home_dœ
)+¡¾’("/")+(
TOKEN_FILENAME
)+1è<ğ
MAX_PATH
) {

202 
	`¡ºıy
(
tok’_·th
, 
home_dœ
, 
	`¡¾’
(home_dir));

203 
	`¡ºÿt
(
tok’_·th
, "/", 
	`¡¾’
("/"));

204 
	`¡ºÿt
(
tok’_·th
, 
TOKEN_FILENAME
, (TOKEN_FILENAME)+1);

207 
	`¡ºıy
(
tok’_·th
, 
TOKEN_FILENAME
, (TOKEN_FILENAME));

210 
FILE
 *
å
 = 
	`fİ’
(
tok’_·th
, "rb");

211 ià(
å
 =ğ
NULL
 && (å = 
	`fİ’
(
tok’_·th
, "wb")) == NULL) {

212 
	`´štf
("W¬nšg: FaedØü—‹/İ’hÏunchok’ f\"%s\".\n", 
tok’_·th
);

215 ià(
å
 !ğ
NULL
) {

217 
size_t
 
»ad_num
 = 
	`ä—d
(
tok’
, 1, (
sgx_Ïunch_tok’_t
), 
å
);

218 ià(
»ad_num
 !ğ0 &&„—d_num !ğ(
sgx_Ïunch_tok’_t
)) {

220 
	`mem£t
(&
tok’
, 0x0, (
sgx_Ïunch_tok’_t
));

221 
	`´štf
("W¬nšg: Inv®id†aunchok’„—d from \"%s\".\n", 
tok’_·th
);

227 
»t
 = 
	`sgx_ü—‹_’şave
(
ENCLAVE_FILENAME
, 
SGX_DEBUG_FLAG
, &
tok’
, &
upd©ed
, &
glob®_eid
, 
NULL
);

228 ià(
»t
 !ğ
SGX_SUCCESS
) {

229 
	`´št_”rÜ_mes§ge
(
»t
);

230 #ifdeà
_MSC_VER


231 ià(
tok’_hªdËr
 !ğ
INVALID_HANDLE_VALUE
)

232 
	`Clo£HªdË
(
tok’_hªdËr
);

234 ià(
å
 !ğ
NULL
è
	`fşo£
(fp);

240 #ifdeà
_MSC_VER


241 ià(
upd©ed
 =ğ
FALSE
 || 
tok’_hªdËr
 =ğ
INVALID_HANDLE_VALUE
) {

243 ià(
tok’_hªdËr
 !ğ
INVALID_HANDLE_VALUE
)

244 
	`Clo£HªdË
(
tok’_hªdËr
);

249 
	`FlushFeBufãrs
(
tok’_hªdËr
);

251 
	`S‘FePoš‹r
(
tok’_hªdËr
, 0, 
NULL
, 
FILE_BEGIN
);

254 
DWORD
 
wr™e_num
 = 0;

255 
	`Wr™eFe
(
tok’_hªdËr
, 
tok’
, (
sgx_Ïunch_tok’_t
), &
wr™e_num
, 
NULL
);

256 ià(
wr™e_num
 !ğ(
sgx_Ïunch_tok’_t
))

257 
	`´štf
("W¬nšg: FaedØ§vÏunchok’Ø\"%s\".\n", 
tok’_·th
);

258 
	`Clo£HªdË
(
tok’_hªdËr
);

260 ià(
upd©ed
 =ğ
FALSE
 || 
å
 =ğ
NULL
) {

262 ià(
å
 !ğ
NULL
è
	`fşo£
(fp);

267 
å
 = 
	`äeİ’
(
tok’_·th
, "wb", fp);

268 ià(
å
 =ğ
NULL
)  0;

269 
size_t
 
wr™e_num
 = 
	`fwr™e
(
tok’
, 1, (
sgx_Ïunch_tok’_t
), 
å
);

270 ià(
wr™e_num
 !ğ(
sgx_Ïunch_tok’_t
))

271 
	`´štf
("W¬nšg: FaedØ§vÏunchok’Ø\"%s\".\n", 
tok’_·th
);

272 
	`fşo£
(
å
);

275 
	}
}

278 
	$oÿÎ_´št_¡ršg
(cÚ¡ *
¡r
)

283 
	`´štf
("%s", 
¡r
);

284 
	}
}

286 "C" 
LaunchAµ
(*);

288 
	$oÿÎ_g’”ic
(
±r
)

291 ià(
±r
 <ğ0 ||…Œ > (
funùiÚ_poš‹rs
)/(*)){

292 
	`´štf
("Inv®id funùiÚ id %Îd\n", 
±r
);

293 
	`ex™
(-1);

296  
	`LaunchAµ
(
funùiÚ_poš‹rs
[
±r
]);

297 
	}
}

299 
FILE
* 
g‘STDOUT
() {

300  
¡dout
;

304 * 
mym®loc
(
size_t
 
a
){

305  
m®loc
(
a
);

307 *
myÿÎoc
(
size_t
 
a
, size_ˆ
b
) {

308  
ÿÎoc
(
a
, 
b
);

310 *
my»®loc
(* 
a
, 
size_t
 
b
) {

311  
»®loc
(
a
, 
b
);

313 
myä“
(*
a
) {

314 
ä“
(
a
);

317 #ià
defšed
(
_MSC_VER
)

319 
	$qu”y_sgx_¡©us
()

321 
sgx_deviû_¡©us_t
 
sgx_deviû_¡©us
;

322 
sgx_¡©us_t
 
sgx_»t
 = 
	`sgx_’abË_deviû
(&
sgx_deviû_¡©us
);

323 ià(
sgx_»t
 !ğ
SGX_SUCCESS
) {

324 
	`´štf
("Failedo get SGX device status.\n");

328 
sgx_deviû_¡©us
) {

329 
SGX_ENABLED
:

331 
SGX_DISABLED_REBOOT_REQUIRED
:

332 
	`´štf
("SGX device has beenƒnabled. Please„eboot your machine.\n");

334 
SGX_DISABLED_LEGACY_OS
:

335 
	`´štf
("SGX device can't beƒnabled on‡n OShat doesn't support EFI interface.\n");

337 
SGX_DISABLED
:

338 
	`´štf
("SGX is‚otƒnabled onhis…latform. More details‡re unavailable.\n");

340 
SGX_DISABLED_SCI_AVAILABLE
:

341 
	`´štf
("SGX device can beƒnabled by‡ Software Control Interface.\n");

343 
SGX_DISABLED_MANUAL_ENABLE
:

344 
	`´štf
("SGX device can beƒnabled manually inhe BIOS setup.\n");

346 
SGX_DISABLED_HYPERV_ENABLED
:

347 
	`´štf
("Detected‡n unsupported version of Windows* 10 with Hyper-Vƒnabled.\n");

349 
SGX_DISABLED_UNSUPPORTED_CPU
:

350 
	`´štf
("SGX is‚ot supported byhis CPU.\n");

353 
	`´štf
("Unexpectedƒrror.\n");

357 
	}
}

361 
SGX_CDECL
 
	$maš
(
¬gc
, *
¬gv
[])

363 ()(
¬gc
);

364 ()(
¬gv
);

367 #ià
	`defšed
(
_MSC_VER
)

368 ià(
	`qu”y_sgx_¡©us
() < 0) {

370 
	`´štf
("Enter‡ character beforeƒxit ...\n");

371 
	`g‘ch¬
();

377 if(
	`š™Ÿlize_’şave
() < 0){

378 
	`´štf
("Enter‡ character beforeƒxit ...\n");

379 
	`g‘ch¬
();

384 
	#SWAP_AREA
 0x900000000ULL

	)

385 
	#GLOBAL_AREA
 0xA0000000000ULL

	)

387 
	`´štf
("Hello world\n");

389 if((*)
SWAP_AREA
 !ğ
	`Vœtu®AÎoc
((*)SWAP_AREA, 4096, 
MEM_RESERVE
 | 
MEM_COMMIT
, 
PAGE_READWRITE
)){

390 
	`´štf
("Swap‡llocation failed\n");

393 if((*)
GLOBAL_AREA
 !ğ
	`Vœtu®AÎoc
((*)GLOBAL_AREA, 4096*16, 
MEM_RESERVE
 | 
MEM_COMMIT
, 
PAGE_READWRITE
)){

394 
	`´štf
("global‡llocation failed\n");

397 
	#FORMAT_STRING
 "H–lØwÜld %d %d %d %d %s\n"

	)

398 
	`¡rıy_s
((*)(
SWAP_AREA
 + 0x100), (
FORMAT_STRING
) + 1, FORMAT_STRING);

400 *
v®
 = (*)
SWAP_AREA
;

402 *(*)(
v®
 + 0xf8) += (8192 * 16 - 1024- 8);

405 
»t
;

407 
	`eÿÎ_big_m®loc
(
glob®_eid
, &
»t
);

409 
»t
 = (ret + (4096*16 -1)) & ~0xffff;

410 
	`´štf
("»t:%Îx\n", 
»t
);

411 
´iv©e_¡ack_’d
 = 
»t
 + 4096 * 16;

412 
public_¡ack_’d
 = 
´iv©e_¡ack_’d
 + (1ULL << 30);

413 
public_¡ack_¡¬t
 = 
»t
 + (1ULL << 30);

414 *(*)(
v®
 + 0xf8èğ
public_¡ack_’d
 - 64 - 8;

416 
	`´štf
("public_¡ak_¡¬t:%Îx\n", 
public_¡ack_¡¬t
);

417 if((*)
public_¡ack_¡¬t
 !ğ
	`Vœtu®AÎoc
((*íublic_¡ack_¡¬t, 4096 * 16, 
MEM_RESERVE
 | 
MEM_COMMIT
 , 
PAGE_READWRITE
)){

418 
	`´štf
("Public stack creation failed\n");

423 
	`eÿÎ_maš
(
glob®_eid
);

427 
	`edg”8r_¬¿y_©Œibu‹s
();

428 
	`edg”8r_poš‹r_©Œibu‹s
();

429 
	`edg”8r_ty³_©Œibu‹s
();

430 
	`edg”8r_funùiÚ_©Œibu‹s
();

433 
	`eÿÎ_libc_funùiÚs
();

434 
	`eÿÎ_libcxx_funùiÚs
();

435 
	`eÿÎ_th»ad_funùiÚs
();

438 
	`sgx_de¡roy_’şave
(
glob®_eid
);

439 
	`SË•
(100);

440 
	`ex™
(0);

447 
	}
}

	@App/App.h

26 #iâdeà
_APP_H_


27 
	#_APP_H_


	)

29 
	~<as£¹.h
>

30 
	~<¡dio.h
>

31 
	~<¡dlib.h
>

32 
	~<¡d¬g.h
>

34 
	~"sgx_”rÜ.h
"

35 
	~"sgx_eid.h
"

37 #iâdeà
TRUE


38 
	#TRUE
 1

	)

41 #iâdeà
FALSE


42 
	#FALSE
 0

	)

45 #ià
defšed
(
_MSC_VER
)

46 
	#TOKEN_FILENAME
 "Enşave.tok’"

	)

47 
	#ENCLAVE_FILENAME
 "Enşave.sigÃd.dÎ"

	)

48 #–ià
defšed
(
__GNUC__
)

49 
	#TOKEN_FILENAME
 "’şave.tok’"

	)

50 
	#ENCLAVE_FILENAME
 "’şave.sigÃd.so"

	)

53 
sgx_’şave_id_t
 
glob®_eid
;

55 #ià
defšed
(
__ılu¥lus
)

59 
edg”8r_¬¿y_©Œibu‹s
();

60 
edg”8r_ty³_©Œibu‹s
();

61 
edg”8r_poš‹r_©Œibu‹s
();

62 
edg”8r_funùiÚ_©Œibu‹s
();

64 
eÿÎ_libc_funùiÚs
();

65 
eÿÎ_libcxx_funùiÚs
();

66 
eÿÎ_th»ad_funùiÚs
();

68 #ià
defšed
(
__ılu¥lus
)

	@App/Edger8rSyntax/Arrays.cpp

26 
	~"../Aµ.h
"

27 
	~"Enşave_u.h
"

32 
	$edg”8r_¬¿y_©Œibu‹s
()

34 
sgx_¡©us_t
 
»t
 = 
SGX_ERROR_UNEXPECTED
;

37 
¬r1
[4] = {0, 1, 2, 3};

38 
»t
 = 
	`eÿÎ_¬¿y_u£r_check
(
glob®_eid
, 
¬r1
);

39 ià(
»t
 !ğ
SGX_SUCCESS
)

40 
	`abÜt
();

43 
i
 = 0; i < 4; i++)

44 
	`as£¹
(
¬r1
[
i
] == (3 - i));

47 
¬r2
[4] = {0, 1, 2, 3};

48 
»t
 = 
	`eÿÎ_¬¿y_š
(
glob®_eid
, 
¬r2
);

49 ià(
»t
 !ğ
SGX_SUCCESS
)

50 
	`abÜt
();

53 
i
 = 0; i < 4; i++)

54 
	`as£¹
(
¬r2
[
i
] == i);

57 
¬r3
[4] = {0, 1, 2, 3};

58 
»t
 = 
	`eÿÎ_¬¿y_out
(
glob®_eid
, 
¬r3
);

59 ià(
»t
 !ğ
SGX_SUCCESS
)

60 
	`abÜt
();

63 
i
 = 0; i < 4; i++)

64 
	`as£¹
(
¬r3
[
i
] == (3 - i));

67 
¬r4
[4] = {0, 1, 2, 3};

68 
»t
 = 
	`eÿÎ_¬¿y_š_out
(
glob®_eid
, 
¬r4
);

69 ià(
»t
 !ğ
SGX_SUCCESS
)

70 
	`abÜt
();

73 
i
 = 0; i < 4; i++)

74 
	`as£¹
(
¬r4
[
i
] == (3 - i));

77 
¬¿y_t
 
¬r5
 = {0, 1, 2, 3, 4, 5, 6, 7, 8, 9};

78 
»t
 = 
	`eÿÎ_¬¿y_i§ry
(
glob®_eid
, 
¬r5
);

79 ià(
»t
 !ğ
SGX_SUCCESS
)

80 
	`abÜt
();

83 
i
 = 0; i < 10; i++)

84 
	`as£¹
(
¬r5
[
i
] == (9 - i));

85 
	}
}

	@App/Edger8rSyntax/Functions.cpp

26 
	~"../Aµ.h
"

27 
	~"Enşave_u.h
"

35 
	$edg”8r_funùiÚ_©Œibu‹s
()

37 
sgx_¡©us_t
 
»t
 = 
SGX_ERROR_UNEXPECTED
;

39 
»t
 = 
	`eÿÎ_funùiÚ_ÿÎšg_cÚvs
(
glob®_eid
);

40 ià(
»t
 !ğ
SGX_SUCCESS
)

41 
	`abÜt
();

43 
»t
 = 
	`eÿÎ_funùiÚ_public
(
glob®_eid
);

44 ià(
»t
 !ğ
SGX_SUCCESS
)

45 
	`abÜt
();

48 
ruÂed
 = 0;

49 
»t
 = 
	`eÿÎ_funùiÚ_´iv©e
(
glob®_eid
, &
ruÂed
);

50 ià(
»t
 !ğ
SGX_ERROR_ECALL_NOT_ALLOWED
 || 
ruÂed
 != 0)

51 
	`abÜt
();

52 
	}
}

57 
	$oÿÎ_funùiÚ_®low
()

59 
ruÂed
 = 0;

60 
sgx_¡©us_t
 
»t
 = 
SGX_ERROR_UNEXPECTED
;

62 
»t
 = 
	`eÿÎ_funùiÚ_´iv©e
(
glob®_eid
, &
ruÂed
);

63 ià(
»t
 !ğ
SGX_SUCCESS
 || 
ruÂed
 != 1)

64 
	`abÜt
();

65 
	}
}

	@App/Edger8rSyntax/Pointers.cpp

26 
	~"../Aµ.h
"

27 
	~"Enşave_u.h
"

32 
	$edg”8r_poš‹r_©Œibu‹s
()

34 
v®
 = 0;

35 
sgx_¡©us_t
 
»t
 = 
SGX_ERROR_UNEXPECTED
;

37 
c
[128] = {0};

38 
size_t
 
Ën
 = 0;

39 
	`mem£t
(
c
, 0xe, 128);

40 
»t
 = 
	`eÿÎ_poš‹r_u£r_check
(
glob®_eid
, &
Ën
, &
c
, 128);

41 ià(
»t
 !ğ
SGX_SUCCESS
)

42 
	`abÜt
();

43 
	`as£¹
(
	`¡rcmp
(
c
, "SGX_SUCCESS") == 0);

46 
v®
 = 0;

47 
»t
 = 
	`eÿÎ_poš‹r_š
(
glob®_eid
, &
v®
);

48 ià(
»t
 !ğ
SGX_SUCCESS
)

49 
	`abÜt
();

50 
	`as£¹
(
v®
 == 0);

52 
v®
 = 0;

53 
»t
 = 
	`eÿÎ_poš‹r_out
(
glob®_eid
, &
v®
);

54 ià(
»t
 !ğ
SGX_SUCCESS
)

55 
	`abÜt
();

56 
	`as£¹
(
v®
 == 1234);

58 
v®
 = 0;

59 
»t
 = 
	`eÿÎ_poš‹r_š_out
(
glob®_eid
, &
v®
);

60 ià(
»t
 !ğ
SGX_SUCCESS
)

61 
	`abÜt
();

62 
	`as£¹
(
v®
 == 1234);

64 
»t
 = 
	`oÿÎ_poš‹r_©Œ
(
glob®_eid
);

65 ià(
»t
 !ğ
SGX_SUCCESS
)

66 
	`abÜt
();

68 
¡r1
[] = "1234567890";

69 
»t
 = 
	`eÿÎ_poš‹r_¡ršg
(
glob®_eid
, 
¡r1
);

70 ià(
»t
 !ğ
SGX_SUCCESS
)

71 
	`abÜt
();

72 
	`as£¹
(
	`¡¾’
(
¡r1
è=ğ10 && 
	`memcmp
(str1, "0987654321", strlen(str1)) == 0);

74 cÚ¡ 
¡r2
[] = "1234567890";

75 
»t
 = 
	`eÿÎ_poš‹r_¡ršg_cÚ¡
(
glob®_eid
, 
¡r2
);

76 ià(
»t
 !ğ
SGX_SUCCESS
)

77 
	`abÜt
();

78 
	`as£¹
(
	`¡¾’
(
¡r2
è=ğ10 && 
	`memcmp
(str2, "1234567890", strlen(str2)) == 0);

80 
¡r3
[] = "1234567890";

81 
»t
 = 
	`eÿÎ_poš‹r_size
(
glob®_eid
, (*)
¡r3
, 
	`¡¾’
(str3));

82 ià(
»t
 !ğ
SGX_SUCCESS
)

83 
	`abÜt
();

84 
	`as£¹
(
	`¡¾’
(
¡r3
è=ğ10 && 
	`memcmp
(str3, "0987654321", strlen(str3)) == 0);

86 
¡r4
[] = "1234567890";

87 
»t
 = 
	`eÿÎ_poš‹r_i¥Œ_»adÚly
(
glob®_eid
, (
bufãr_t
)
¡r4
, 
	`¡¾’
(str4));

88 ià(
»t
 !ğ
SGX_SUCCESS
)

89 
	`abÜt
();

90 
	`as£¹
(
	`¡¾’
(
¡r4
è=ğ10 && 
	`memcmp
(str4, "1234567890", strlen(str4)) == 0);

92 
¬r
[10] = {0, 1, 2, 3, 4, 5, 6, 7, 8, 9};

93 
»t
 = 
	`eÿÎ_poš‹r_couÁ
(
glob®_eid
, 
¬r
, 10);

94 ià(
»t
 !ğ
SGX_SUCCESS
)

95 
	`abÜt
();

97 
i
 = 0; i < 10; i++)

98 
	`as£¹
(
¬r
[
i
] == (9 - i));

100 
	`mem£t
(
¬r
, 0x0, (arr));

101 
»t
 = 
	`eÿÎ_poš‹r_sizefunc
(
glob®_eid
, (*)
¬r
);

102 ià(
»t
 !ğ
SGX_SUCCESS
)

103 
	`abÜt
();

105 
i
 = 0; i < 10; i++)

106 
	`as£¹
(
¬r
[
i
] == i);

109 
	}
}

114 
	$oÿÎ_poš‹r_u£r_check
(* 
v®
)

116 ()
v®
;

117 
	`as£¹
(
v®
 !ğ
NULL
);

118 
	}
}

123 
	$oÿÎ_poš‹r_š
(* 
v®
)

125 *
v®
 = 1234;

126 
	}
}

131 
	$oÿÎ_poš‹r_out
(* 
v®
)

133 *
v®
 = 1234;

134 
	}
}

139 
	$oÿÎ_poš‹r_š_out
(* 
v®
)

141 *
v®
 = 1234;

142 
	}
}

	@App/Edger8rSyntax/Types.cpp

26 
	~"../Aµ.h
"

27 
	~"Enşave_u.h
"

32 
	$edg”8r_ty³_©Œibu‹s
()

34 
sgx_¡©us_t
 
»t
 = 
SGX_ERROR_UNEXPECTED
;

36 
»t
 = 
	`eÿÎ_ty³_ch¬
(
glob®_eid
, ()0x12);

37 ià(
»t
 !ğ
SGX_SUCCESS
)

38 
	`abÜt
();

40 
»t
 = 
	`eÿÎ_ty³_št
(
glob®_eid
, ()1234);

41 ià(
»t
 !ğ
SGX_SUCCESS
)

42 
	`abÜt
();

44 
»t
 = 
	`eÿÎ_ty³_æßt
(
glob®_eid
, ()1234.0);

45 ià(
»t
 !ğ
SGX_SUCCESS
)

46 
	`abÜt
();

48 
»t
 = 
	`eÿÎ_ty³_doubË
(
glob®_eid
, ()1234.5678);

49 ià(
»t
 !ğ
SGX_SUCCESS
)

50 
	`abÜt
();

52 
»t
 = 
	`eÿÎ_ty³_size_t
(
glob®_eid
, (
size_t
)12345678);

53 ià(
»t
 !ğ
SGX_SUCCESS
)

54 
	`abÜt
();

56 
»t
 = 
	`eÿÎ_ty³_wch¬_t
(
glob®_eid
, (
wch¬_t
)0x1234);

57 ià(
»t
 !ğ
SGX_SUCCESS
)

58 
	`abÜt
();

60 
¡ruù_foo_t
 
g
 = {1234, 5678};

61 
»t
 = 
	`eÿÎ_ty³_¡ruù
(
glob®_eid
, 
g
);

62 ià(
»t
 !ğ
SGX_SUCCESS
)

63 
	`abÜt
();

65 
uniÚ_foo_t
 
v®
 = {0};

66 
»t
 = 
	`eÿÎ_ty³_’um_uniÚ
(
glob®_eid
, 
ENUM_FOO_0
, &
v®
);

67 ià(
»t
 !ğ
SGX_SUCCESS
)

68 
	`abÜt
();

69 
	`as£¹
(
v®
.
uniÚ_foo_0
 == 2);

70 
	}
}

	@App/Enclave_u.c

1 
	~"Enşave_u.h
"

2 
	~<”ºo.h
>

5 
	sms_eÿÎ_big_m®loc_t
 {

6 
	mms_»tv®
;

7 } 
	tms_eÿÎ_big_m®loc_t
;

9 
	sms_eÿÎ_ty³_ch¬_t
 {

10 
	mms_v®
;

11 } 
	tms_eÿÎ_ty³_ch¬_t
;

13 
	sms_eÿÎ_ty³_št_t
 {

14 
	mms_v®
;

15 } 
	tms_eÿÎ_ty³_št_t
;

17 
	sms_eÿÎ_ty³_æßt_t
 {

18 
	mms_v®
;

19 } 
	tms_eÿÎ_ty³_æßt_t
;

21 
	sms_eÿÎ_ty³_doubË_t
 {

22 
	mms_v®
;

23 } 
	tms_eÿÎ_ty³_doubË_t
;

25 
	sms_eÿÎ_ty³_size_t_t
 {

26 
size_t
 
	mms_v®
;

27 } 
	tms_eÿÎ_ty³_size_t_t
;

29 
	sms_eÿÎ_ty³_wch¬_t_t
 {

30 
wch¬_t
 
	mms_v®
;

31 } 
	tms_eÿÎ_ty³_wch¬_t_t
;

33 
	sms_eÿÎ_ty³_¡ruù_t
 {

34 
¡ruù_foo_t
 
	mms_v®
;

35 } 
	tms_eÿÎ_ty³_¡ruù_t
;

37 
	sms_eÿÎ_ty³_’um_uniÚ_t
 {

38 
’um_foo_t
 
	mms_v®1
;

39 
uniÚ_foo_t
* 
	mms_v®2
;

40 } 
	tms_eÿÎ_ty³_’um_uniÚ_t
;

42 
	sms_eÿÎ_poš‹r_u£r_check_t
 {

43 
size_t
 
	mms_»tv®
;

44 * 
	mms_v®
;

45 
size_t
 
	mms_sz
;

46 } 
	tms_eÿÎ_poš‹r_u£r_check_t
;

48 
	sms_eÿÎ_poš‹r_š_t
 {

49 * 
	mms_v®
;

50 } 
	tms_eÿÎ_poš‹r_š_t
;

52 
	sms_eÿÎ_poš‹r_out_t
 {

53 * 
	mms_v®
;

54 } 
	tms_eÿÎ_poš‹r_out_t
;

56 
	sms_eÿÎ_poš‹r_š_out_t
 {

57 * 
	mms_v®
;

58 } 
	tms_eÿÎ_poš‹r_š_out_t
;

60 
	sms_eÿÎ_poš‹r_¡ršg_t
 {

61 * 
	mms_¡r
;

62 } 
	tms_eÿÎ_poš‹r_¡ršg_t
;

64 
	sms_eÿÎ_poš‹r_¡ršg_cÚ¡_t
 {

65 * 
	mms_¡r
;

66 } 
	tms_eÿÎ_poš‹r_¡ršg_cÚ¡_t
;

68 
	sms_eÿÎ_poš‹r_size_t
 {

69 * 
	mms_±r
;

70 
size_t
 
	mms_Ën
;

71 } 
	tms_eÿÎ_poš‹r_size_t
;

73 
	sms_eÿÎ_poš‹r_couÁ_t
 {

74 * 
	mms_¬r
;

75 
	mms_út
;

76 } 
	tms_eÿÎ_poš‹r_couÁ_t
;

78 
	sms_eÿÎ_poš‹r_i¥Œ_»adÚly_t
 {

79 
bufãr_t
 
	mms_buf
;

80 
size_t
 
	mms_Ën
;

81 } 
	tms_eÿÎ_poš‹r_i¥Œ_»adÚly_t
;

83 
	sms_eÿÎ_poš‹r_sizefunc_t
 {

84 * 
	mms_buf
;

85 } 
	tms_eÿÎ_poš‹r_sizefunc_t
;

88 
	sms_eÿÎ_¬¿y_u£r_check_t
 {

89 * 
	mms_¬r
;

90 } 
	tms_eÿÎ_¬¿y_u£r_check_t
;

92 
	sms_eÿÎ_¬¿y_š_t
 {

93 * 
	mms_¬r
;

94 } 
	tms_eÿÎ_¬¿y_š_t
;

96 
	sms_eÿÎ_¬¿y_out_t
 {

97 * 
	mms_¬r
;

98 } 
	tms_eÿÎ_¬¿y_out_t
;

100 
	sms_eÿÎ_¬¿y_š_out_t
 {

101 * 
	mms_¬r
;

102 } 
	tms_eÿÎ_¬¿y_š_out_t
;

104 
	sms_eÿÎ_¬¿y_i§ry_t
 {

105 
¬¿y_t
* 
	mms_¬r
;

106 } 
	tms_eÿÎ_¬¿y_i§ry_t
;

110 
	sms_eÿÎ_funùiÚ_´iv©e_t
 {

111 
	mms_»tv®
;

112 } 
	tms_eÿÎ_funùiÚ_´iv©e_t
;

115 
	sms_eÿÎ_sgx_ıuid_t
 {

116 * 
	mms_ıušfo
;

117 
	mms_Ëaf
;

118 } 
	tms_eÿÎ_sgx_ıuid_t
;

122 
	sms_eÿÎ_šü—£_couÁ”_t
 {

123 
size_t
 
	mms_»tv®
;

124 } 
	tms_eÿÎ_šü—£_couÁ”_t
;

128 
	sms_oÿÎ_´št_¡ršg_t
 {

129 * 
	mms_¡r
;

130 } 
	tms_oÿÎ_´št_¡ršg_t
;

132 
	sms_oÿÎ_g’”ic_t
 {

133 
	mms_»tv®
;

134 
	mms_±r
;

135 } 
	tms_oÿÎ_g’”ic_t
;

137 
	sms_oÿÎ_poš‹r_u£r_check_t
 {

138 * 
	mms_v®
;

139 } 
	tms_oÿÎ_poš‹r_u£r_check_t
;

141 
	sms_oÿÎ_poš‹r_š_t
 {

142 * 
	mms_v®
;

143 } 
	tms_oÿÎ_poš‹r_š_t
;

145 
	sms_oÿÎ_poš‹r_out_t
 {

146 * 
	mms_v®
;

147 } 
	tms_oÿÎ_poš‹r_out_t
;

149 
	sms_oÿÎ_poš‹r_š_out_t
 {

150 * 
	mms_v®
;

151 } 
	tms_oÿÎ_poš‹r_š_out_t
;

153 
	sms_memcıy_t
 {

154 * 
	mms_»tv®
;

155 * 
	mms_de¡
;

156 * 
	mms_¤c
;

157 
	mms_v®
;

158 
size_t
 
	mms_Ën
;

159 } 
	tms_memcıy_t
;

162 
	sms_sgx_oc_ıuidex_t
 {

163 * 
	mms_ıušfo
;

164 
	mms_Ëaf
;

165 
	mms_subËaf
;

166 } 
	tms_sgx_oc_ıuidex_t
;

168 
	sms_sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ_t
 {

169 
	mms_»tv®
;

170 * 
	mms_£lf
;

171 } 
	tms_sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ_t
;

173 
	sms_sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ_t
 {

174 
	mms_»tv®
;

175 * 
	mms_wa™”
;

176 } 
	tms_sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ_t
;

178 
	sms_sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ_t
 {

179 
	mms_»tv®
;

180 * 
	mms_wa™”
;

181 * 
	mms_£lf
;

182 } 
	tms_sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ_t
;

184 
	sms_sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ_t
 {

185 
	mms_»tv®
;

186 ** 
	mms_wa™”s
;

187 
size_t
 
	mms_tÙ®
;

188 } 
	tms_sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ_t
;

190 
sgx_¡©us_t
 
SGX_CDECL
 
	$Enşave_oÿÎ_´št_¡ršg
(* 
pms
)

192 
ms_oÿÎ_´št_¡ršg_t
* 
ms
 = 
	`SGX_CAST
(ms_oÿÎ_´št_¡ršg_t*, 
pms
);

193 
	`oÿÎ_´št_¡ršg
((cÚ¡ *)
ms
->
ms_¡r
);

195  
SGX_SUCCESS
;

196 
	}
}

198 
sgx_¡©us_t
 
SGX_CDECL
 
	$Enşave_oÿÎ_g’”ic
(* 
pms
)

200 
ms_oÿÎ_g’”ic_t
* 
ms
 = 
	`SGX_CAST
(ms_oÿÎ_g’”ic_t*, 
pms
);

201 
ms
->
ms_»tv®
 = 
	`oÿÎ_g’”ic
(ms->
ms_±r
);

203  
SGX_SUCCESS
;

204 
	}
}

206 
sgx_¡©us_t
 
SGX_CDECL
 
	$Enşave_oÿÎ_poš‹r_u£r_check
(* 
pms
)

208 
ms_oÿÎ_poš‹r_u£r_check_t
* 
ms
 = 
	`SGX_CAST
(ms_oÿÎ_poš‹r_u£r_check_t*, 
pms
);

209 
	`oÿÎ_poš‹r_u£r_check
(
ms
->
ms_v®
);

211  
SGX_SUCCESS
;

212 
	}
}

214 
sgx_¡©us_t
 
SGX_CDECL
 
	$Enşave_oÿÎ_poš‹r_š
(* 
pms
)

216 
ms_oÿÎ_poš‹r_š_t
* 
ms
 = 
	`SGX_CAST
(ms_oÿÎ_poš‹r_š_t*, 
pms
);

217 
	`oÿÎ_poš‹r_š
(
ms
->
ms_v®
);

219  
SGX_SUCCESS
;

220 
	}
}

222 
sgx_¡©us_t
 
SGX_CDECL
 
	$Enşave_oÿÎ_poš‹r_out
(* 
pms
)

224 
ms_oÿÎ_poš‹r_out_t
* 
ms
 = 
	`SGX_CAST
(ms_oÿÎ_poš‹r_out_t*, 
pms
);

225 
	`oÿÎ_poš‹r_out
(
ms
->
ms_v®
);

227  
SGX_SUCCESS
;

228 
	}
}

230 
sgx_¡©us_t
 
SGX_CDECL
 
	$Enşave_oÿÎ_poš‹r_š_out
(* 
pms
)

232 
ms_oÿÎ_poš‹r_š_out_t
* 
ms
 = 
	`SGX_CAST
(ms_oÿÎ_poš‹r_š_out_t*, 
pms
);

233 
	`oÿÎ_poš‹r_š_out
(
ms
->
ms_v®
);

235  
SGX_SUCCESS
;

236 
	}
}

238 
sgx_¡©us_t
 
SGX_CDECL
 
	$Enşave_memcıy
(* 
pms
)

240 
ms_memcıy_t
* 
ms
 = 
	`SGX_CAST
(ms_memcıy_t*, 
pms
);

241 
ms
->
ms_»tv®
 = 
	`memcıy
(ms->
ms_de¡
, (cÚ¡ *)ms->
ms_¤c
, ms->
ms_v®
, ms->
ms_Ën
);

243  
SGX_SUCCESS
;

244 
	}
}

246 
sgx_¡©us_t
 
SGX_CDECL
 
	$Enşave_oÿÎ_funùiÚ_®low
(* 
pms
)

248 ià(
pms
 !ğ
NULL
è 
SGX_ERROR_INVALID_PARAMETER
;

249 
	`oÿÎ_funùiÚ_®low
();

250  
SGX_SUCCESS
;

251 
	}
}

253 
sgx_¡©us_t
 
SGX_CDECL
 
	$Enşave_sgx_oc_ıuidex
(* 
pms
)

255 
ms_sgx_oc_ıuidex_t
* 
ms
 = 
	`SGX_CAST
(ms_sgx_oc_ıuidex_t*, 
pms
);

256 
	`sgx_oc_ıuidex
(
ms
->
ms_ıušfo
, ms->
ms_Ëaf
, ms->
ms_subËaf
);

258  
SGX_SUCCESS
;

259 
	}
}

261 
sgx_¡©us_t
 
SGX_CDECL
 
	$Enşave_sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ
(* 
pms
)

263 
ms_sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ_t
* 
ms
 = 
	`SGX_CAST
(ms_sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ_t*, 
pms
);

264 
ms
->
ms_»tv®
 = 
	`sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ
((cÚ¡ *)ms->
ms_£lf
);

266  
SGX_SUCCESS
;

267 
	}
}

269 
sgx_¡©us_t
 
SGX_CDECL
 
	$Enşave_sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ
(* 
pms
)

271 
ms_sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ_t
* 
ms
 = 
	`SGX_CAST
(ms_sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ_t*, 
pms
);

272 
ms
->
ms_»tv®
 = 
	`sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ
((cÚ¡ *)ms->
ms_wa™”
);

274  
SGX_SUCCESS
;

275 
	}
}

277 
sgx_¡©us_t
 
SGX_CDECL
 
	$Enşave_sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ
(* 
pms
)

279 
ms_sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ_t
* 
ms
 = 
	`SGX_CAST
(ms_sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ_t*, 
pms
);

280 
ms
->
ms_»tv®
 = 
	`sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ
((cÚ¡ *)ms->
ms_wa™”
, (cÚ¡ *)ms->
ms_£lf
);

282  
SGX_SUCCESS
;

283 
	}
}

285 
sgx_¡©us_t
 
SGX_CDECL
 
	$Enşave_sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ
(* 
pms
)

287 
ms_sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ_t
* 
ms
 = 
	`SGX_CAST
(ms_sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ_t*, 
pms
);

288 
ms
->
ms_»tv®
 = 
	`sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ
((cÚ¡ **)ms->
ms_wa™”s
, ms->
ms_tÙ®
);

290  
SGX_SUCCESS
;

291 
	}
}

294 
size_t
 
	mÄ_oÿÎ
;

295 * 
	mfunc_addr
[13];

296 } 
	goÿÎ_bË_Enşave
 = {

299 (*)(
ušŒ_t
)
Enşave_oÿÎ_´št_¡ršg
,

300 (*)(
ušŒ_t
)
Enşave_oÿÎ_g’”ic
,

301 (*)(
ušŒ_t
)
Enşave_oÿÎ_poš‹r_u£r_check
,

302 (*)(
ušŒ_t
)
Enşave_oÿÎ_poš‹r_š
,

303 (*)(
ušŒ_t
)
Enşave_oÿÎ_poš‹r_out
,

304 (*)(
ušŒ_t
)
Enşave_oÿÎ_poš‹r_š_out
,

305 (*)(
ušŒ_t
)
Enşave_memcıy
,

306 (*)(
ušŒ_t
)
Enşave_oÿÎ_funùiÚ_®low
,

307 (*)(
ušŒ_t
)
Enşave_sgx_oc_ıuidex
,

308 (*)(
ušŒ_t
)
Enşave_sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ
,

309 (*)(
ušŒ_t
)
Enşave_sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ
,

310 (*)(
ušŒ_t
)
Enşave_sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ
,

311 (*)(
ušŒ_t
)
Enşave_sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ
,

315 
sgx_¡©us_t
 
	$eÿÎ_maš
(
sgx_’şave_id_t
 
eid
)

317 
sgx_¡©us_t
 
¡©us
;

318 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 0, &
oÿÎ_bË_Enşave
, 
NULL
);

319  
¡©us
;

320 
	}
}

322 
sgx_¡©us_t
 
	$eÿÎ_big_m®loc
(
sgx_’şave_id_t
 
eid
, * 
»tv®
)

324 
sgx_¡©us_t
 
¡©us
;

325 
ms_eÿÎ_big_m®loc_t
 
ms
;

326 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 1, &
oÿÎ_bË_Enşave
, &
ms
);

327 ià(
¡©us
 =ğ
SGX_SUCCESS
 && 
»tv®
è*»tv® = 
ms
.
ms_»tv®
;

328  
¡©us
;

329 
	}
}

331 
sgx_¡©us_t
 
	$eÿÎ_ty³_ch¬
(
sgx_’şave_id_t
 
eid
, 
v®
)

333 
sgx_¡©us_t
 
¡©us
;

334 
ms_eÿÎ_ty³_ch¬_t
 
ms
;

335 
ms
.
ms_v®
 = 
v®
;

336 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 2, &
oÿÎ_bË_Enşave
, &
ms
);

337  
¡©us
;

338 
	}
}

340 
sgx_¡©us_t
 
	$eÿÎ_ty³_št
(
sgx_’şave_id_t
 
eid
, 
v®
)

342 
sgx_¡©us_t
 
¡©us
;

343 
ms_eÿÎ_ty³_št_t
 
ms
;

344 
ms
.
ms_v®
 = 
v®
;

345 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 3, &
oÿÎ_bË_Enşave
, &
ms
);

346  
¡©us
;

347 
	}
}

349 
sgx_¡©us_t
 
	$eÿÎ_ty³_æßt
(
sgx_’şave_id_t
 
eid
, 
v®
)

351 
sgx_¡©us_t
 
¡©us
;

352 
ms_eÿÎ_ty³_æßt_t
 
ms
;

353 
ms
.
ms_v®
 = 
v®
;

354 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 4, &
oÿÎ_bË_Enşave
, &
ms
);

355  
¡©us
;

356 
	}
}

358 
sgx_¡©us_t
 
	$eÿÎ_ty³_doubË
(
sgx_’şave_id_t
 
eid
, 
v®
)

360 
sgx_¡©us_t
 
¡©us
;

361 
ms_eÿÎ_ty³_doubË_t
 
ms
;

362 
ms
.
ms_v®
 = 
v®
;

363 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 5, &
oÿÎ_bË_Enşave
, &
ms
);

364  
¡©us
;

365 
	}
}

367 
sgx_¡©us_t
 
	$eÿÎ_ty³_size_t
(
sgx_’şave_id_t
 
eid
, 
size_t
 
v®
)

369 
sgx_¡©us_t
 
¡©us
;

370 
ms_eÿÎ_ty³_size_t_t
 
ms
;

371 
ms
.
ms_v®
 = 
v®
;

372 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 6, &
oÿÎ_bË_Enşave
, &
ms
);

373  
¡©us
;

374 
	}
}

376 
sgx_¡©us_t
 
	$eÿÎ_ty³_wch¬_t
(
sgx_’şave_id_t
 
eid
, 
wch¬_t
 
v®
)

378 
sgx_¡©us_t
 
¡©us
;

379 
ms_eÿÎ_ty³_wch¬_t_t
 
ms
;

380 
ms
.
ms_v®
 = 
v®
;

381 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 7, &
oÿÎ_bË_Enşave
, &
ms
);

382  
¡©us
;

383 
	}
}

385 
sgx_¡©us_t
 
	$eÿÎ_ty³_¡ruù
(
sgx_’şave_id_t
 
eid
, 
¡ruù_foo_t
 
v®
)

387 
sgx_¡©us_t
 
¡©us
;

388 
ms_eÿÎ_ty³_¡ruù_t
 
ms
;

389 
ms
.
ms_v®
 = 
v®
;

390 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 8, &
oÿÎ_bË_Enşave
, &
ms
);

391  
¡©us
;

392 
	}
}

394 
sgx_¡©us_t
 
	$eÿÎ_ty³_’um_uniÚ
(
sgx_’şave_id_t
 
eid
, 
’um_foo_t
 
v®1
, 
uniÚ_foo_t
* 
v®2
)

396 
sgx_¡©us_t
 
¡©us
;

397 
ms_eÿÎ_ty³_’um_uniÚ_t
 
ms
;

398 
ms
.
ms_v®1
 = 
v®1
;

399 
ms
.
ms_v®2
 = 
v®2
;

400 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 9, &
oÿÎ_bË_Enşave
, &
ms
);

401  
¡©us
;

402 
	}
}

404 
sgx_¡©us_t
 
	$eÿÎ_poš‹r_u£r_check
(
sgx_’şave_id_t
 
eid
, 
size_t
* 
»tv®
, * 
v®
, size_ˆ
sz
)

406 
sgx_¡©us_t
 
¡©us
;

407 
ms_eÿÎ_poš‹r_u£r_check_t
 
ms
;

408 
ms
.
ms_v®
 = 
v®
;

409 
ms
.
ms_sz
 = 
sz
;

410 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 10, &
oÿÎ_bË_Enşave
, &
ms
);

411 ià(
¡©us
 =ğ
SGX_SUCCESS
 && 
»tv®
è*»tv® = 
ms
.
ms_»tv®
;

412  
¡©us
;

413 
	}
}

415 
sgx_¡©us_t
 
	$eÿÎ_poš‹r_š
(
sgx_’şave_id_t
 
eid
, * 
v®
)

417 
sgx_¡©us_t
 
¡©us
;

418 
ms_eÿÎ_poš‹r_š_t
 
ms
;

419 
ms
.
ms_v®
 = 
v®
;

420 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 11, &
oÿÎ_bË_Enşave
, &
ms
);

421  
¡©us
;

422 
	}
}

424 
sgx_¡©us_t
 
	$eÿÎ_poš‹r_out
(
sgx_’şave_id_t
 
eid
, * 
v®
)

426 
sgx_¡©us_t
 
¡©us
;

427 
ms_eÿÎ_poš‹r_out_t
 
ms
;

428 
ms
.
ms_v®
 = 
v®
;

429 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 12, &
oÿÎ_bË_Enşave
, &
ms
);

430  
¡©us
;

431 
	}
}

433 
sgx_¡©us_t
 
	$eÿÎ_poš‹r_š_out
(
sgx_’şave_id_t
 
eid
, * 
v®
)

435 
sgx_¡©us_t
 
¡©us
;

436 
ms_eÿÎ_poš‹r_š_out_t
 
ms
;

437 
ms
.
ms_v®
 = 
v®
;

438 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 13, &
oÿÎ_bË_Enşave
, &
ms
);

439  
¡©us
;

440 
	}
}

442 
sgx_¡©us_t
 
	$eÿÎ_poš‹r_¡ršg
(
sgx_’şave_id_t
 
eid
, * 
¡r
)

444 
sgx_¡©us_t
 
¡©us
;

445 
ms_eÿÎ_poš‹r_¡ršg_t
 
ms
;

446 
ms
.
ms_¡r
 = 
¡r
;

447 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 14, &
oÿÎ_bË_Enşave
, &
ms
);

448  
¡©us
;

449 
	}
}

451 
sgx_¡©us_t
 
	$eÿÎ_poš‹r_¡ršg_cÚ¡
(
sgx_’şave_id_t
 
eid
, cÚ¡ * 
¡r
)

453 
sgx_¡©us_t
 
¡©us
;

454 
ms_eÿÎ_poš‹r_¡ršg_cÚ¡_t
 
ms
;

455 
ms
.
ms_¡r
 = (*)
¡r
;

456 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 15, &
oÿÎ_bË_Enşave
, &
ms
);

457  
¡©us
;

458 
	}
}

460 
sgx_¡©us_t
 
	$eÿÎ_poš‹r_size
(
sgx_’şave_id_t
 
eid
, * 
±r
, 
size_t
 
Ën
)

462 
sgx_¡©us_t
 
¡©us
;

463 
ms_eÿÎ_poš‹r_size_t
 
ms
;

464 
ms
.
ms_±r
 = 
±r
;

465 
ms
.
ms_Ën
 = 
Ën
;

466 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 16, &
oÿÎ_bË_Enşave
, &
ms
);

467  
¡©us
;

468 
	}
}

470 
sgx_¡©us_t
 
	$eÿÎ_poš‹r_couÁ
(
sgx_’şave_id_t
 
eid
, * 
¬r
, 
út
)

472 
sgx_¡©us_t
 
¡©us
;

473 
ms_eÿÎ_poš‹r_couÁ_t
 
ms
;

474 
ms
.
ms_¬r
 = 
¬r
;

475 
ms
.
ms_út
 = 
út
;

476 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 17, &
oÿÎ_bË_Enşave
, &
ms
);

477  
¡©us
;

478 
	}
}

480 
sgx_¡©us_t
 
	$eÿÎ_poš‹r_i¥Œ_»adÚly
(
sgx_’şave_id_t
 
eid
, 
bufãr_t
 
buf
, 
size_t
 
Ën
)

482 
sgx_¡©us_t
 
¡©us
;

483 
ms_eÿÎ_poš‹r_i¥Œ_»adÚly_t
 
ms
;

484 
ms
.
ms_buf
 = (
bufãr_t
)
buf
;

485 
ms
.
ms_Ën
 = 
Ën
;

486 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 18, &
oÿÎ_bË_Enşave
, &
ms
);

487  
¡©us
;

488 
	}
}

490 
sgx_¡©us_t
 
	$eÿÎ_poš‹r_sizefunc
(
sgx_’şave_id_t
 
eid
, * 
buf
)

492 
sgx_¡©us_t
 
¡©us
;

493 
ms_eÿÎ_poš‹r_sizefunc_t
 
ms
;

494 
ms
.
ms_buf
 = 
buf
;

495 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 19, &
oÿÎ_bË_Enşave
, &
ms
);

496  
¡©us
;

497 
	}
}

499 
sgx_¡©us_t
 
	$oÿÎ_poš‹r_©Œ
(
sgx_’şave_id_t
 
eid
)

501 
sgx_¡©us_t
 
¡©us
;

502 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 20, &
oÿÎ_bË_Enşave
, 
NULL
);

503  
¡©us
;

504 
	}
}

506 
sgx_¡©us_t
 
	$eÿÎ_¬¿y_u£r_check
(
sgx_’şave_id_t
 
eid
, 
¬r
[4])

508 
sgx_¡©us_t
 
¡©us
;

509 
ms_eÿÎ_¬¿y_u£r_check_t
 
ms
;

510 
ms
.
ms_¬r
 = (*)
¬r
;

511 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 21, &
oÿÎ_bË_Enşave
, &
ms
);

512  
¡©us
;

513 
	}
}

515 
sgx_¡©us_t
 
	$eÿÎ_¬¿y_š
(
sgx_’şave_id_t
 
eid
, 
¬r
[4])

517 
sgx_¡©us_t
 
¡©us
;

518 
ms_eÿÎ_¬¿y_š_t
 
ms
;

519 
ms
.
ms_¬r
 = (*)
¬r
;

520 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 22, &
oÿÎ_bË_Enşave
, &
ms
);

521  
¡©us
;

522 
	}
}

524 
sgx_¡©us_t
 
	$eÿÎ_¬¿y_out
(
sgx_’şave_id_t
 
eid
, 
¬r
[4])

526 
sgx_¡©us_t
 
¡©us
;

527 
ms_eÿÎ_¬¿y_out_t
 
ms
;

528 
ms
.
ms_¬r
 = (*)
¬r
;

529 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 23, &
oÿÎ_bË_Enşave
, &
ms
);

530  
¡©us
;

531 
	}
}

533 
sgx_¡©us_t
 
	$eÿÎ_¬¿y_š_out
(
sgx_’şave_id_t
 
eid
, 
¬r
[4])

535 
sgx_¡©us_t
 
¡©us
;

536 
ms_eÿÎ_¬¿y_š_out_t
 
ms
;

537 
ms
.
ms_¬r
 = (*)
¬r
;

538 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 24, &
oÿÎ_bË_Enşave
, &
ms
);

539  
¡©us
;

540 
	}
}

542 
sgx_¡©us_t
 
	$eÿÎ_¬¿y_i§ry
(
sgx_’şave_id_t
 
eid
, 
¬¿y_t
 
¬r
)

544 
sgx_¡©us_t
 
¡©us
;

545 
ms_eÿÎ_¬¿y_i§ry_t
 
ms
;

546 
ms
.
ms_¬r
 = (
¬¿y_t
 *)&
¬r
[0];

547 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 25, &
oÿÎ_bË_Enşave
, &
ms
);

548  
¡©us
;

549 
	}
}

551 
sgx_¡©us_t
 
	$eÿÎ_funùiÚ_ÿÎšg_cÚvs
(
sgx_’şave_id_t
 
eid
)

553 
sgx_¡©us_t
 
¡©us
;

554 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 26, &
oÿÎ_bË_Enşave
, 
NULL
);

555  
¡©us
;

556 
	}
}

558 
sgx_¡©us_t
 
	$eÿÎ_funùiÚ_public
(
sgx_’şave_id_t
 
eid
)

560 
sgx_¡©us_t
 
¡©us
;

561 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 27, &
oÿÎ_bË_Enşave
, 
NULL
);

562  
¡©us
;

563 
	}
}

565 
sgx_¡©us_t
 
	$eÿÎ_funùiÚ_´iv©e
(
sgx_’şave_id_t
 
eid
, * 
»tv®
)

567 
sgx_¡©us_t
 
¡©us
;

568 
ms_eÿÎ_funùiÚ_´iv©e_t
 
ms
;

569 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 28, &
oÿÎ_bË_Enşave
, &
ms
);

570 ià(
¡©us
 =ğ
SGX_SUCCESS
 && 
»tv®
è*»tv® = 
ms
.
ms_»tv®
;

571  
¡©us
;

572 
	}
}

574 
sgx_¡©us_t
 
	$eÿÎ_m®loc_ä“
(
sgx_’şave_id_t
 
eid
)

576 
sgx_¡©us_t
 
¡©us
;

577 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 29, &
oÿÎ_bË_Enşave
, 
NULL
);

578  
¡©us
;

579 
	}
}

581 
sgx_¡©us_t
 
	$eÿÎ_sgx_ıuid
(
sgx_’şave_id_t
 
eid
, 
ıušfo
[4], 
Ëaf
)

583 
sgx_¡©us_t
 
¡©us
;

584 
ms_eÿÎ_sgx_ıuid_t
 
ms
;

585 
ms
.
ms_ıušfo
 = (*)
ıušfo
;

586 
ms
.
ms_Ëaf
 = 
Ëaf
;

587 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 30, &
oÿÎ_bË_Enşave
, &
ms
);

588  
¡©us
;

589 
	}
}

591 
sgx_¡©us_t
 
	$eÿÎ_exû±iÚ
(
sgx_’şave_id_t
 
eid
)

593 
sgx_¡©us_t
 
¡©us
;

594 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 31, &
oÿÎ_bË_Enşave
, 
NULL
);

595  
¡©us
;

596 
	}
}

598 
sgx_¡©us_t
 
	$eÿÎ_m­
(
sgx_’şave_id_t
 
eid
)

600 
sgx_¡©us_t
 
¡©us
;

601 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 32, &
oÿÎ_bË_Enşave
, 
NULL
);

602  
¡©us
;

603 
	}
}

605 
sgx_¡©us_t
 
	$eÿÎ_šü—£_couÁ”
(
sgx_’şave_id_t
 
eid
, 
size_t
* 
»tv®
)

607 
sgx_¡©us_t
 
¡©us
;

608 
ms_eÿÎ_šü—£_couÁ”_t
 
ms
;

609 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 33, &
oÿÎ_bË_Enşave
, &
ms
);

610 ià(
¡©us
 =ğ
SGX_SUCCESS
 && 
»tv®
è*»tv® = 
ms
.
ms_»tv®
;

611  
¡©us
;

612 
	}
}

614 
sgx_¡©us_t
 
	$eÿÎ_´oduûr
(
sgx_’şave_id_t
 
eid
)

616 
sgx_¡©us_t
 
¡©us
;

617 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 34, &
oÿÎ_bË_Enşave
, 
NULL
);

618  
¡©us
;

619 
	}
}

621 
sgx_¡©us_t
 
	$eÿÎ_cÚsum”
(
sgx_’şave_id_t
 
eid
)

623 
sgx_¡©us_t
 
¡©us
;

624 
¡©us
 = 
	`sgx_eÿÎ
(
eid
, 35, &
oÿÎ_bË_Enşave
, 
NULL
);

625  
¡©us
;

626 
	}
}

	@App/Enclave_u.h

1 #iâdeà
ENCLAVE_U_H__


2 
	#ENCLAVE_U_H__


	)

4 
	~<¡dšt.h
>

5 
	~<wch¬.h
>

6 
	~<¡ddef.h
>

7 
	~<¡ršg.h
>

8 
	~"sgx_edg”8r.h
"

10 
	~"u£r_ty³s.h
"

12 
	#SGX_CAST
(
ty³
, 
™em
è(Ñy³)(™em))

	)

14 #ifdeà
__ılu¥lus


18 
	s¡ruù_foo_t
 {

19 
ušt32_t
 
¡ruù_foo_0
;

20 
ušt64_t
 
¡ruù_foo_1
;

21 } 
	t¡ruù_foo_t
;

23 
	e’um_foo_t
 {

24 
ENUM_FOO_0
 = 0,

25 
ENUM_FOO_1
 = 1,

26 } 
	t’um_foo_t
;

28 
	uuniÚ_foo_t
 {

29 
ušt32_t
 
uniÚ_foo_0
;

30 
ušt32_t
 
uniÚ_foo_1
;

31 
ušt64_t
 
uniÚ_foo_3
;

32 } 
	tuniÚ_foo_t
;

34 
SGX_UBRIDGE
(
SGX_NOCONVENTION
, 
oÿÎ_´št_¡ršg
, (cÚ¡ * 
¡r
));

35 
SGX_UBRIDGE
(
SGX_NOCONVENTION
, 
oÿÎ_g’”ic
, (
±r
));

36 
SGX_UBRIDGE
(
SGX_NOCONVENTION
, 
oÿÎ_poš‹r_u£r_check
, (* 
v®
));

37 
SGX_UBRIDGE
(
SGX_NOCONVENTION
, 
oÿÎ_poš‹r_š
, (* 
v®
));

38 
SGX_UBRIDGE
(
SGX_NOCONVENTION
, 
oÿÎ_poš‹r_out
, (* 
v®
));

39 
SGX_UBRIDGE
(
SGX_NOCONVENTION
, 
oÿÎ_poš‹r_š_out
, (* 
v®
));

40 
SGX_DLLIMPORT
 * 
SGX_UBRIDGE
(
SGX_CDECL
, 
memcıy
, (* 
de¡
, cÚ¡ * 
¤c
, 
v®
, 
size_t
 
Ën
));

41 
SGX_UBRIDGE
(
SGX_NOCONVENTION
, 
oÿÎ_funùiÚ_®low
, ());

42 
SGX_UBRIDGE
(
SGX_CDECL
, 
sgx_oc_ıuidex
, (
ıušfo
[4], 
Ëaf
, 
subËaf
));

43 
SGX_UBRIDGE
(
SGX_CDECL
, 
sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ
, (cÚ¡ * 
£lf
));

44 
SGX_UBRIDGE
(
SGX_CDECL
, 
sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ
, (cÚ¡ * 
wa™”
));

45 
SGX_UBRIDGE
(
SGX_CDECL
, 
sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ
, (cÚ¡ * 
wa™”
, cÚ¡ * 
£lf
));

46 
SGX_UBRIDGE
(
SGX_CDECL
, 
sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ
, (cÚ¡ ** 
wa™”s
, 
size_t
 
tÙ®
));

48 
sgx_¡©us_t
 
eÿÎ_maš
(
sgx_’şave_id_t
 
eid
);

49 
sgx_¡©us_t
 
eÿÎ_big_m®loc
(
sgx_’şave_id_t
 
eid
, * 
»tv®
);

50 
sgx_¡©us_t
 
eÿÎ_ty³_ch¬
(
sgx_’şave_id_t
 
eid
, 
v®
);

51 
sgx_¡©us_t
 
eÿÎ_ty³_št
(
sgx_’şave_id_t
 
eid
, 
v®
);

52 
sgx_¡©us_t
 
eÿÎ_ty³_æßt
(
sgx_’şave_id_t
 
eid
, 
v®
);

53 
sgx_¡©us_t
 
eÿÎ_ty³_doubË
(
sgx_’şave_id_t
 
eid
, 
v®
);

54 
sgx_¡©us_t
 
eÿÎ_ty³_size_t
(
sgx_’şave_id_t
 
eid
, 
size_t
 
v®
);

55 
sgx_¡©us_t
 
eÿÎ_ty³_wch¬_t
(
sgx_’şave_id_t
 
eid
, 
wch¬_t
 
v®
);

56 
sgx_¡©us_t
 
eÿÎ_ty³_¡ruù
(
sgx_’şave_id_t
 
eid
, 
¡ruù_foo_t
 
v®
);

57 
sgx_¡©us_t
 
eÿÎ_ty³_’um_uniÚ
(
sgx_’şave_id_t
 
eid
, 
’um_foo_t
 
v®1
, 
uniÚ_foo_t
* 
v®2
);

58 
sgx_¡©us_t
 
eÿÎ_poš‹r_u£r_check
(
sgx_’şave_id_t
 
eid
, 
size_t
* 
»tv®
, * 
v®
, size_ˆ
sz
);

59 
sgx_¡©us_t
 
eÿÎ_poš‹r_š
(
sgx_’şave_id_t
 
eid
, * 
v®
);

60 
sgx_¡©us_t
 
eÿÎ_poš‹r_out
(
sgx_’şave_id_t
 
eid
, * 
v®
);

61 
sgx_¡©us_t
 
eÿÎ_poš‹r_š_out
(
sgx_’şave_id_t
 
eid
, * 
v®
);

62 
sgx_¡©us_t
 
eÿÎ_poš‹r_¡ršg
(
sgx_’şave_id_t
 
eid
, * 
¡r
);

63 
sgx_¡©us_t
 
eÿÎ_poš‹r_¡ršg_cÚ¡
(
sgx_’şave_id_t
 
eid
, cÚ¡ * 
¡r
);

64 
sgx_¡©us_t
 
eÿÎ_poš‹r_size
(
sgx_’şave_id_t
 
eid
, * 
±r
, 
size_t
 
Ën
);

65 
sgx_¡©us_t
 
eÿÎ_poš‹r_couÁ
(
sgx_’şave_id_t
 
eid
, * 
¬r
, 
út
);

66 
sgx_¡©us_t
 
eÿÎ_poš‹r_i¥Œ_»adÚly
(
sgx_’şave_id_t
 
eid
, 
bufãr_t
 
buf
, 
size_t
 
Ën
);

67 
sgx_¡©us_t
 
eÿÎ_poš‹r_sizefunc
(
sgx_’şave_id_t
 
eid
, * 
buf
);

68 
sgx_¡©us_t
 
oÿÎ_poš‹r_©Œ
(
sgx_’şave_id_t
 
eid
);

69 
sgx_¡©us_t
 
eÿÎ_¬¿y_u£r_check
(
sgx_’şave_id_t
 
eid
, 
¬r
[4]);

70 
sgx_¡©us_t
 
eÿÎ_¬¿y_š
(
sgx_’şave_id_t
 
eid
, 
¬r
[4]);

71 
sgx_¡©us_t
 
eÿÎ_¬¿y_out
(
sgx_’şave_id_t
 
eid
, 
¬r
[4]);

72 
sgx_¡©us_t
 
eÿÎ_¬¿y_š_out
(
sgx_’şave_id_t
 
eid
, 
¬r
[4]);

73 
sgx_¡©us_t
 
eÿÎ_¬¿y_i§ry
(
sgx_’şave_id_t
 
eid
, 
¬¿y_t
 
¬r
);

74 
sgx_¡©us_t
 
eÿÎ_funùiÚ_ÿÎšg_cÚvs
(
sgx_’şave_id_t
 
eid
);

75 
sgx_¡©us_t
 
eÿÎ_funùiÚ_public
(
sgx_’şave_id_t
 
eid
);

76 
sgx_¡©us_t
 
eÿÎ_funùiÚ_´iv©e
(
sgx_’şave_id_t
 
eid
, * 
»tv®
);

77 
sgx_¡©us_t
 
eÿÎ_m®loc_ä“
(
sgx_’şave_id_t
 
eid
);

78 
sgx_¡©us_t
 
eÿÎ_sgx_ıuid
(
sgx_’şave_id_t
 
eid
, 
ıušfo
[4], 
Ëaf
);

79 
sgx_¡©us_t
 
eÿÎ_exû±iÚ
(
sgx_’şave_id_t
 
eid
);

80 
sgx_¡©us_t
 
eÿÎ_m­
(
sgx_’şave_id_t
 
eid
);

81 
sgx_¡©us_t
 
eÿÎ_šü—£_couÁ”
(
sgx_’şave_id_t
 
eid
, 
size_t
* 
»tv®
);

82 
sgx_¡©us_t
 
eÿÎ_´oduûr
(
sgx_’şave_id_t
 
eid
);

83 
sgx_¡©us_t
 
eÿÎ_cÚsum”
(
sgx_’şave_id_t
 
eid
);

85 #ifdeà
__ılu¥lus


	@App/TrustedLibrary/Libc.cpp

26 
	~"../Aµ.h
"

27 
	~"Enşave_u.h
"

32 
	$eÿÎ_libc_funùiÚs
()

34 
sgx_¡©us_t
 
»t
 = 
SGX_ERROR_UNEXPECTED
;

36 
»t
 = 
	`eÿÎ_m®loc_ä“
(
glob®_eid
);

37 ià(
»t
 !ğ
SGX_SUCCESS
)

38 
	`abÜt
();

40 
ıuid
[4] = {0x1, 0x0, 0x0, 0x0};

41 
»t
 = 
	`eÿÎ_sgx_ıuid
(
glob®_eid
, 
ıuid
, 0x0);

42 ià(
»t
 !ğ
SGX_SUCCESS
)

43 
	`abÜt
();

44 
	}
}

	@App/TrustedLibrary/Libcxx.cpp

25 
	~<¡dio.h
>

27 
	~"../Aµ.h
"

28 
	~"Enşave_u.h
"

33 
	$eÿÎ_libcxx_funùiÚs
()

35 
sgx_¡©us_t
 
»t
 = 
SGX_ERROR_UNEXPECTED
;

37 
»t
 = 
	`eÿÎ_exû±iÚ
(
glob®_eid
);

38 ià(
»t
 !ğ
SGX_SUCCESS
)

39 
	`abÜt
();

41 
»t
 = 
	`eÿÎ_m­
(
glob®_eid
);

42 ià(
»t
 !ğ
SGX_SUCCESS
)

43 
	`abÜt
();

44 
	}
}

	@App/TrustedLibrary/Thread.cpp

26 
	~<th»ad
>

27 
	~<¡dio.h
>

28 
usšg
 
Çme¥aû
 
	g¡d
;

30 
	~"../Aµ.h
"

31 
	~"Enşave_u.h
"

33 
size_t
 
	gcouÁ”
 = 0;

35 
	$šü—£_couÁ”
()

37 
size_t
 
úr
 = 0;

38 
sgx_¡©us_t
 
»t
 = 
SGX_ERROR_UNEXPECTED
;

39 
»t
 = 
	`eÿÎ_šü—£_couÁ”
(
glob®_eid
, &
úr
);

40 ià(
úr
 !ğ0è
couÁ”
 = cnr;

41 ià(
»t
 !ğ
SGX_SUCCESS
)

42 
	`abÜt
();

43 
	}
}

45 
	$d©a_´oduûr
()

47 
sgx_¡©us_t
 
»t
 = 
SGX_ERROR_UNEXPECTED
;

48 
»t
 = 
	`eÿÎ_´oduûr
(
glob®_eid
);

49 ià(
»t
 !ğ
SGX_SUCCESS
)

50 
	`abÜt
();

51 
	}
}

53 
	$d©a_cÚsum”
()

55 
sgx_¡©us_t
 
»t
 = 
SGX_ERROR_UNEXPECTED
;

56 
»t
 = 
	`eÿÎ_cÚsum”
(
glob®_eid
);

57 ià(
»t
 !ğ
SGX_SUCCESS
)

58 
	`abÜt
();

59 
	}
}

64 
	$eÿÎ_th»ad_funùiÚs
()

66 
th»ad
 
	`add”1
(
šü—£_couÁ”
);

67 
th»ad
 
	`add”2
(
šü—£_couÁ”
);

68 
th»ad
 
	`add”3
(
šü—£_couÁ”
);

69 
th»ad
 
	`add”4
(
šü—£_couÁ”
);

71 
add”1
.
	`još
();

72 
add”2
.
	`još
();

73 
add”3
.
	`još
();

74 
add”4
.
	`još
();

76 
	`as£¹
(
couÁ”
 =ğ4*
LOOPS_PER_THREAD
);

78 
	`´štf
("Info:ƒxecutinghread synchronization,…lease wait... \n");

80 
th»ad
 
	`cÚsum”1
(
d©a_cÚsum”
);

81 
th»ad
 
	`´oduûr0
(
d©a_´oduûr
);

82 
th»ad
 
	`cÚsum”2
(
d©a_cÚsum”
);

83 
th»ad
 
	`cÚsum”3
(
d©a_cÚsum”
);

84 
th»ad
 
	`cÚsum”4
(
d©a_cÚsum”
);

86 
cÚsum”1
.
	`još
();

87 
cÚsum”2
.
	`još
();

88 
cÚsum”3
.
	`još
();

89 
cÚsum”4
.
	`još
();

90 
´oduûr0
.
	`još
();

91 
	}
}

	@App/functions.h

1 
	~"šşudes.h
"

2 * 
	gfunùiÚ_poš‹rs
[] = {

3 
NULL
,

4 (*)
Clo£HªdË
,

5 (*)
C»©ePe
,

6 (*)
C»©eProûssW
,

7 (*)
Du¶iÿ‹HªdË
,

8 (*)
FšdClo£
,

9 (*)
FšdFœ¡FeW
,

10 (*)
FšdNextFeW
,

11 (*)
G‘Cu¼’tProûss
,

12 (*)
G‘FeA‰ribu‹sW
,

13 (*)
G‘FuÎP©hNameW
,

14 (*)
G‘La¡E¼Ü
,

15 (*)
G‘LoÿlTime
,

16 (*)
G‘StdHªdË
,

17 (*)
MuÉiBy‹ToWideCh¬
,

18 (*)
R—dFe
,

19 (*)
RegClo£Key
,

20 (*)
RegEnumKeyExW
,

21 (*)
RegO³nKeyExW
,

22 (*)
RegQu”yV®ueExW
,

23 (*)
S‘HªdËInfÜm©iÚ
,

24 (*)
S‘La¡E¼Ü
,

25 (*)
SË•
,

26 (*)
Sy¡emTimeToFeTime
,

27 (*)
WSAG‘La¡E¼Ü
,

28 (*)
WSAS¹up
,

29 (*)
WideCh¬ToMuÉiBy‹
,

30 (*)
Wr™eFe
,

31 (*)
__WSAFDIsS‘
,

32 (*)
__aüt_iob_func
 ,

33 (*)
__¡dio_commÚ_vårštf
 ,

34 (*)
__¡dio_commÚ_v¥rštf
,

35 (*)
__¡dio_commÚ_vssÿnf
,

36 (*)
_©oi64
,

37 (*)
_begšth»ad
,

38 (*)
_”ºo
,

39 (*)
_f’o
,

40 (*)
_gmtime64
,

41 (*)
_loÿÉime64
,

42 (*)
_rmdœ
,

43 (*)
_¡rdup
,

44 (*)
_was£¹
,

45 (*)
_wfİ’
,

46 (*)
_wİ’
,

47 (*)
_w¡©64
,

48 (*)
acû±
,

49 (*)
bšd
,

50 (*)
şo£sock‘
,

51 (*)
cÚÃù
,

52 (*)
fşo£
,

53 (*)
fæush
,

54 (*)
fg‘c
,

55 (*)
fg‘s
,

56 (*)
åutc
,

57 (*)
åuts
,

58 (*)
ä—d
,

59 (*)
f£ek
,

60 (*)
fwr™e
,

61 (*)
g‘’v
,

62 (*)
g‘³”Çme
,

63 (*)
g‘sockÇme
,

64 (*)
g‘sockİt
,

65 (*)
htÚl
,

66 (*)
htÚs
,

67 (*)
š‘_Áß
,

68 (*)
ioùlsock‘
,

69 (*)
li¡’
,

70 (*)
Áohl
,

71 (*)
Áohs
,

72 (*)
¿nd
,

73 (*)
»cv
,

74 (*)
»cväom
,

75 (*)
£Ëù
,

76 (*)
£nd
,

77 (*)
£ndto
,

78 (*)
£tsockİt
,

79 (*)
shutdown
,

80 (*)
sock‘
,

81 (*)
wcsÿt
,

82 (*)
mym®loc
,

83 (*)
my»®loc
,

84 (*)
myÿÎoc
,

85 (*)
myä“
,

86 (*)
fİ’
,

87 (*)
ex™
,

	@App/includes.h

4 
	#_begšth»ad
 (*)1

	)

8 
	~<time.h
>

9 
	~<dœeù.h
>

12 #´agm¨
comm’t
(
lib
, "Ws2_32.lib")

13 #´agm¨
w¬nšg
(
di§bË
:4996)

17 * 
mym®loc
(
size_t
);

18 * 
myÿÎoc
(
size_t
, size_t);

19 * 
my»®loc
(*, 
size_t
);

20 
myä“
(*);

	@Enclave/Edger8rSyntax/Arrays.cpp

27 
	~"sgx_Œts.h
"

28 
	~"../Enşave.h
"

29 
	~"Enşave_t.h
"

34 
	$eÿÎ_¬¿y_u£r_check
(
¬r
[4])

36 ià(
	`sgx_is_outside_’şave
(
¬r
, 4 * ()) != 1)

37 
	`abÜt
();

39 
i
 = 0; i < 4; i++) {

40 
	`as£¹
(
¬r
[
i
] == i);

41 
¬r
[
i
] = 3 - i;

43 
	}
}

49 
	$eÿÎ_¬¿y_š
(
¬r
[4])

51 
i
 = 0; i < 4; i++) {

52 
	`as£¹
(
¬r
[
i
] == i);

53 
¬r
[
i
] = (3 - i);

55 
	}
}

61 
	$eÿÎ_¬¿y_out
(
¬r
[4])

63 
i
 = 0; i < 4; i++) {

65 
	`as£¹
(
¬r
[
i
] == 0);

66 
¬r
[
i
] = (3 - i);

68 
	}
}

74 
	$eÿÎ_¬¿y_š_out
(
¬r
[4])

76 
i
 = 0; i < 4; i++) {

77 
	`as£¹
(
¬r
[
i
] == i);

78 
¬r
[
i
] = (3 - i);

80 
	}
}

85 
	$eÿÎ_¬¿y_i§ry
(
¬¿y_t
 
¬r
)

87 ià(
	`sgx_is_outside_’şave
(
¬r
, (
¬¿y_t
)) != 1)

88 
	`abÜt
();

90 
n
 = (
¬¿y_t
)/(
¬r
[0]);

91 
i
 = 0; i < 
n
; i++) {

92 
	`as£¹
(
¬r
[
i
] == i);

93 
¬r
[
i
] = (
n
 - 1 - i);

95 
	}
}

	@Enclave/Edger8rSyntax/Functions.cpp

28 
	~<¡ršg.h
>

29 
	~<¡dio.h
>

31 
	~"../Enşave.h
"

32 
	~"Enşave_t.h
"

37 
	$eÿÎ_funùiÚ_ÿÎšg_cÚvs
()

39 
sgx_¡©us_t
 
»t
 = 
SGX_ERROR_UNEXPECTED
;

41 
s1
[] = "1234567890";

42 
s2
[] = "0987654321";

44 
buf
[
BUFSIZ
] = {'\0'};

45 
	`memıy
(
buf
, 
s1
, 
	`¡¾’
(s1));

47 
»t
 = 
	`memcıy
(
NULL
, 
s1
, 
s2
, '\0', 
	`¡¾’
(s1));

49 ià(
»t
 !ğ
SGX_SUCCESS
)

50 
	`abÜt
();

51 
	`as£¹
(
	`memcmp
(
s1
, 
s2
, 
	`¡¾’
(s1)) == 0);

54 
	}
}

59 
	$eÿÎ_funùiÚ_public
()

61 
sgx_¡©us_t
 
»t
 = 
SGX_ERROR_UNEXPECTED
;

63 
»t
 = 
	`oÿÎ_funùiÚ_®low
();

64 ià(
»t
 !ğ
SGX_SUCCESS
)

65 
	`abÜt
();

68 
	}
}

73 
	$eÿÎ_funùiÚ_´iv©e
()

76 
	}
}

	@Enclave/Edger8rSyntax/Pointers.cpp

28 
	~<sys/ty³s.h
>

29 
	~<¡ršg.h
>

31 
	~"sgx_Œts.h
"

32 
	~"../Enşave.h
"

33 
	~"Enşave_t.h
"

38 
št32_t
 
	$checksum_š‹º®
(*
buf
, 
size_t
 
couÁ
)

40 
št32_t
 
sum
 = 0;

41 
št16_t
 *
±r
 = (št16_ˆ*)
buf
;

44 
couÁ
 > 1) {

45 
sum
 = sum + *
±r
++;

46 
couÁ
 = count - 2;

50 ià(
couÁ
 > 0)

51 
sum
 = sum + *((*)
±r
);

53  ~
sum
;

54 
	}
}

59 
size_t
 
	$eÿÎ_poš‹r_u£r_check
(*
v®
, 
size_t
 
sz
)

62 ià(
	`sgx_is_outside_’şave
(
v®
, 
sz
) != 1)

63 
	`abÜt
();

65 
tmp
[100] = {0};

66 
size_t
 
Ën
 = 
sz
>100?100:sz;

70 
	`memıy
(
tmp
, 
v®
, 
Ën
);

72 
št32_t
 
sum
 = 
	`checksum_š‹º®
((*)
tmp
, 
Ën
);

73 
	`´štf
("Checksum(0x%p, %zu) = 0x%x\n",

74 
v®
, 
Ën
, 
sum
);

77 
	`memıy
(
v®
, "SGX_SUCCESS", 
Ën
>12?12:len);

79  
Ën
;

80 
	}
}

86 
	$eÿÎ_poš‹r_š
(*
v®
)

88 ià(
	`sgx_is_w™hš_’şave
(
v®
, ()) != 1)

89 
	`abÜt
();

90 *
v®
 = 1234;

91 
	}
}

96 
	$eÿÎ_poš‹r_out
(*
v®
)

98 ià(
	`sgx_is_w™hš_’şave
(
v®
, ()) != 1)

99 
	`abÜt
();

100 
	`as£¹
(*
v®
 == 0);

101 *
v®
 = 1234;

102 
	}
}

107 
	$eÿÎ_poš‹r_š_out
(*
v®
)

109 ià(
	`sgx_is_w™hš_’şave
(
v®
, ()) != 1)

110 
	`abÜt
();

111 *
v®
 = 1234;

112 
	}
}

117 
	$oÿÎ_poš‹r_©Œ
()

119 
sgx_¡©us_t
 
»t
 = 
SGX_ERROR_UNEXPECTED
;

121 
v®
 = 0;

122 
»t
 = 
	`oÿÎ_poš‹r_u£r_check
(&
v®
);

123 ià(
»t
 !ğ
SGX_SUCCESS
)

124 
	`abÜt
();

126 
v®
 = 0;

127 
»t
 = 
	`oÿÎ_poš‹r_š
(&
v®
);

128 ià(
»t
 !ğ
SGX_SUCCESS
)

129 
	`abÜt
();

130 
	`as£¹
(
v®
 == 0);

132 
v®
 = 0;

133 
»t
 = 
	`oÿÎ_poš‹r_out
(&
v®
);

134 ià(
»t
 !ğ
SGX_SUCCESS
)

135 
	`abÜt
();

136 
	`as£¹
(
v®
 == 1234);

138 
v®
 = 0;

139 
»t
 = 
	`oÿÎ_poš‹r_š_out
(&
v®
);

140 ià(
»t
 !ğ
SGX_SUCCESS
)

141 
	`abÜt
();

142 
	`as£¹
(
v®
 == 1234);

145 
	}
}

150 
	$eÿÎ_poš‹r_¡ršg
(*
¡r
)

152 
	`¡ºıy
(
¡r
, "0987654321", 
	`¡¾’
(str));

153 
	}
}

158 
	$eÿÎ_poš‹r_¡ršg_cÚ¡
(cÚ¡ *
¡r
)

160 * 
‹mp
 = 
Ãw
 [
	`¡¾’
(
¡r
)];

161 
	`¡ºıy
(
‹mp
, 
¡r
, 
	`¡¾’
(str));

162 
d–‘e
 []
‹mp
;

163 
	}
}

168 
	$eÿÎ_poš‹r_size
(*
±r
, 
size_t
 
Ën
)

170 
	`¡ºıy
((*)
±r
, "0987654321", 
Ën
);

171 
	}
}

176 
	$eÿÎ_poš‹r_couÁ
(*
¬r
, 
út
)

178 
i
 = (
út
 - 1); i >= 0; i--)

179 
¬r
[
i
] = (
út
 - 1 - i);

180 
	}
}

186 
	$eÿÎ_poš‹r_i¥Œ_»adÚly
(
bufãr_t
 
buf
, 
size_t
 
Ën
)

188 
	`¡ºıy
((*)
buf
, "0987654321", 
Ën
);

189 
	}
}

194 
size_t
 
	$g‘_bufãr_Ën
(cÚ¡ * 
buf
)

196 ()
buf
;

198 
	}
}

203 
	$eÿÎ_poš‹r_sizefunc
(*
buf
)

205 *
tmp
 = (*)
buf
;

206 
i
 = 0; i < 10; i++) {

207 
	`as£¹
(
tmp
[
i
] == 0);

208 
tmp
[
i
] = i;

210 
	}
}

	@Enclave/Edger8rSyntax/Types.cpp

28 
	~"sgx_Œts.h
"

29 
	~"../Enşave.h
"

30 
	~"Enşave_t.h
"

31 
	~<lim™s
>

32 
	~<cm©h
>

35 
	#UNUSED
(
v®
è()(v®)

	)

37 
	#ULP
 2

	)

40 
boŞ
 
	$®mo¡_equ®
(
x
, 
y
)

44  
¡d
::
	`abs
(
x
-
y
è<ğ¡d::
num”ic_lim™s
<>::
	`•sÚ
(è* std::abs(x+yè* 
ULP
;

45 
	}
}

48 
boŞ
 
	$®mo¡_equ®
(
x
, 
y
)

52  
¡d
::
	`abs
(
x
-
y
è<ğ¡d::
num”ic_lim™s
<>::
	`•sÚ
(è* std::abs(x+yè* 
ULP
;

53 
	}
}

58 
	$eÿÎ_ty³_ch¬
(
v®
)

60 
	`as£¹
(
v®
 == 0x12);

61 #iâdeà
DEBUG


62 
	`UNUSED
(
v®
);

64 
	}
}

69 
	$eÿÎ_ty³_št
(
v®
)

71 
	`as£¹
(
v®
 == 1234);

72 #iâdeà
DEBUG


73 
	`UNUSED
(
v®
);

75 
	}
}

80 
	$eÿÎ_ty³_æßt
(
v®
)

82 
	`as£¹
(
	`®mo¡_equ®
(
v®
, ()1234.0));

83 #iâdeà
DEBUG


84 
	`UNUSED
(
v®
);

86 
	}
}

91 
	$eÿÎ_ty³_doubË
(
v®
)

93 
	`as£¹
(
	`®mo¡_equ®
(
v®
, ()1234.5678));

94 #iâdeà
DEBUG


95 
	`UNUSED
(
v®
);

97 
	}
}

102 
	$eÿÎ_ty³_size_t
(
size_t
 
v®
)

104 
	`as£¹
(
v®
 =ğ(
size_t
)12345678);

105 #iâdeà
DEBUG


106 
	`UNUSED
(
v®
);

108 
	}
}

113 
	$eÿÎ_ty³_wch¬_t
(
wch¬_t
 
v®
)

115 
	`as£¹
(
v®
 =ğ(
wch¬_t
)0x1234);

116 #iâdeà
DEBUG


117 
	`UNUSED
(
v®
);

119 
	}
}

124 
	$eÿÎ_ty³_¡ruù
(
¡ruù_foo_t
 
v®
)

126 
	`as£¹
(
v®
.
¡ruù_foo_0
 == 1234);

127 
	`as£¹
(
v®
.
¡ruù_foo_1
 == 5678);

128 #iâdeà
DEBUG


129 
	`UNUSED
(
v®
);

131 
	}
}

138 
	$eÿÎ_ty³_’um_uniÚ
(
’um_foo_t
 
v®1
, 
uniÚ_foo_t
 *
v®2
)

140 ià(
	`sgx_is_outside_’şave
(
v®2
, (
uniÚ_foo_t
)) != 1)

141 
	`abÜt
();

142 
v®2
->
uniÚ_foo_0
 = 1;

143 
v®2
->
uniÚ_foo_1
 = 2;

144 
	`as£¹
(
v®1
 =ğ
ENUM_FOO_0
);

145 #iâdeà
DEBUG


146 
	`UNUSED
(
v®1
);

148 
	}
}

	@Enclave/Enclave.cpp

26 
	~<¡d¬g.h
>

27 
	~<¡dio.h
>

29 
	~"Enşave.h
"

30 
	~"Enşave_t.h
"

46 
	$eÿÎ_maš
()

53 
	`oÿÎ_g’”ic
(100);

57 
	}
}

	@Enclave/Enclave.h

26 #iâdeà
_ENCLAVE_H_


27 
	#_ENCLAVE_H_


	)

29 
	~<¡dlib.h
>

30 
	~<as£¹.h
>

32 #ià
defšed
(
__ılu¥lus
)

36 
´štf
(cÚ¡ *
fmt
, ...);

38 #ià
defšed
(
__ılu¥lus
)

	@Enclave/Enclave_t.c

1 
	~"Enşave_t.h
"

3 
	~"sgx_Œts.h
"

5 
	~<”ºo.h
>

6 
	~<¡ršg.h
>

7 
	~<¡dlib.h
>

9 
	#CHECK_REF_POINTER
(
±r
, 
siz
) do { \

10 ià(!(
±r
è|| ! 
	`sgx_is_outside_’şave
(ÕŒ), (
siz
))) \

11  
SGX_ERROR_INVALID_PARAMETER
;\

12 } 0)

	)

14 
	#CHECK_UNIQUE_POINTER
(
±r
, 
siz
) do { \

15 ià((
±r
è&& ! 
	`sgx_is_outside_’şave
(ÕŒ), (
siz
))) \

16  
SGX_ERROR_INVALID_PARAMETER
;\

17 } 0)

	)

21 
	sms_eÿÎ_big_m®loc_t
 {

22 
	mms_»tv®
;

23 } 
	tms_eÿÎ_big_m®loc_t
;

25 
	sms_eÿÎ_ty³_ch¬_t
 {

26 
	mms_v®
;

27 } 
	tms_eÿÎ_ty³_ch¬_t
;

29 
	sms_eÿÎ_ty³_št_t
 {

30 
	mms_v®
;

31 } 
	tms_eÿÎ_ty³_št_t
;

33 
	sms_eÿÎ_ty³_æßt_t
 {

34 
	mms_v®
;

35 } 
	tms_eÿÎ_ty³_æßt_t
;

37 
	sms_eÿÎ_ty³_doubË_t
 {

38 
	mms_v®
;

39 } 
	tms_eÿÎ_ty³_doubË_t
;

41 
	sms_eÿÎ_ty³_size_t_t
 {

42 
size_t
 
	mms_v®
;

43 } 
	tms_eÿÎ_ty³_size_t_t
;

45 
	sms_eÿÎ_ty³_wch¬_t_t
 {

46 
wch¬_t
 
	mms_v®
;

47 } 
	tms_eÿÎ_ty³_wch¬_t_t
;

49 
	sms_eÿÎ_ty³_¡ruù_t
 {

50 
¡ruù_foo_t
 
	mms_v®
;

51 } 
	tms_eÿÎ_ty³_¡ruù_t
;

53 
	sms_eÿÎ_ty³_’um_uniÚ_t
 {

54 
’um_foo_t
 
	mms_v®1
;

55 
uniÚ_foo_t
* 
	mms_v®2
;

56 } 
	tms_eÿÎ_ty³_’um_uniÚ_t
;

58 
	sms_eÿÎ_poš‹r_u£r_check_t
 {

59 
size_t
 
	mms_»tv®
;

60 * 
	mms_v®
;

61 
size_t
 
	mms_sz
;

62 } 
	tms_eÿÎ_poš‹r_u£r_check_t
;

64 
	sms_eÿÎ_poš‹r_š_t
 {

65 * 
	mms_v®
;

66 } 
	tms_eÿÎ_poš‹r_š_t
;

68 
	sms_eÿÎ_poš‹r_out_t
 {

69 * 
	mms_v®
;

70 } 
	tms_eÿÎ_poš‹r_out_t
;

72 
	sms_eÿÎ_poš‹r_š_out_t
 {

73 * 
	mms_v®
;

74 } 
	tms_eÿÎ_poš‹r_š_out_t
;

76 
	sms_eÿÎ_poš‹r_¡ršg_t
 {

77 * 
	mms_¡r
;

78 } 
	tms_eÿÎ_poš‹r_¡ršg_t
;

80 
	sms_eÿÎ_poš‹r_¡ršg_cÚ¡_t
 {

81 * 
	mms_¡r
;

82 } 
	tms_eÿÎ_poš‹r_¡ršg_cÚ¡_t
;

84 
	sms_eÿÎ_poš‹r_size_t
 {

85 * 
	mms_±r
;

86 
size_t
 
	mms_Ën
;

87 } 
	tms_eÿÎ_poš‹r_size_t
;

89 
	sms_eÿÎ_poš‹r_couÁ_t
 {

90 * 
	mms_¬r
;

91 
	mms_út
;

92 } 
	tms_eÿÎ_poš‹r_couÁ_t
;

94 
	sms_eÿÎ_poš‹r_i¥Œ_»adÚly_t
 {

95 
bufãr_t
 
	mms_buf
;

96 
size_t
 
	mms_Ën
;

97 } 
	tms_eÿÎ_poš‹r_i¥Œ_»adÚly_t
;

99 
	sms_eÿÎ_poš‹r_sizefunc_t
 {

100 * 
	mms_buf
;

101 } 
	tms_eÿÎ_poš‹r_sizefunc_t
;

104 
	sms_eÿÎ_¬¿y_u£r_check_t
 {

105 * 
	mms_¬r
;

106 } 
	tms_eÿÎ_¬¿y_u£r_check_t
;

108 
	sms_eÿÎ_¬¿y_š_t
 {

109 * 
	mms_¬r
;

110 } 
	tms_eÿÎ_¬¿y_š_t
;

112 
	sms_eÿÎ_¬¿y_out_t
 {

113 * 
	mms_¬r
;

114 } 
	tms_eÿÎ_¬¿y_out_t
;

116 
	sms_eÿÎ_¬¿y_š_out_t
 {

117 * 
	mms_¬r
;

118 } 
	tms_eÿÎ_¬¿y_š_out_t
;

120 
	sms_eÿÎ_¬¿y_i§ry_t
 {

121 
¬¿y_t
* 
	mms_¬r
;

122 } 
	tms_eÿÎ_¬¿y_i§ry_t
;

126 
	sms_eÿÎ_funùiÚ_´iv©e_t
 {

127 
	mms_»tv®
;

128 } 
	tms_eÿÎ_funùiÚ_´iv©e_t
;

131 
	sms_eÿÎ_sgx_ıuid_t
 {

132 * 
	mms_ıušfo
;

133 
	mms_Ëaf
;

134 } 
	tms_eÿÎ_sgx_ıuid_t
;

138 
	sms_eÿÎ_šü—£_couÁ”_t
 {

139 
size_t
 
	mms_»tv®
;

140 } 
	tms_eÿÎ_šü—£_couÁ”_t
;

144 
	sms_oÿÎ_´št_¡ršg_t
 {

145 * 
	mms_¡r
;

146 } 
	tms_oÿÎ_´št_¡ršg_t
;

148 
	sms_oÿÎ_g’”ic_t
 {

149 
	mms_»tv®
;

150 
	mms_±r
;

151 } 
	tms_oÿÎ_g’”ic_t
;

153 
	sms_oÿÎ_poš‹r_u£r_check_t
 {

154 * 
	mms_v®
;

155 } 
	tms_oÿÎ_poš‹r_u£r_check_t
;

157 
	sms_oÿÎ_poš‹r_š_t
 {

158 * 
	mms_v®
;

159 } 
	tms_oÿÎ_poš‹r_š_t
;

161 
	sms_oÿÎ_poš‹r_out_t
 {

162 * 
	mms_v®
;

163 } 
	tms_oÿÎ_poš‹r_out_t
;

165 
	sms_oÿÎ_poš‹r_š_out_t
 {

166 * 
	mms_v®
;

167 } 
	tms_oÿÎ_poš‹r_š_out_t
;

169 
	sms_memcıy_t
 {

170 * 
	mms_»tv®
;

171 * 
	mms_de¡
;

172 * 
	mms_¤c
;

173 
	mms_v®
;

174 
size_t
 
	mms_Ën
;

175 } 
	tms_memcıy_t
;

178 
	sms_sgx_oc_ıuidex_t
 {

179 * 
	mms_ıušfo
;

180 
	mms_Ëaf
;

181 
	mms_subËaf
;

182 } 
	tms_sgx_oc_ıuidex_t
;

184 
	sms_sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ_t
 {

185 
	mms_»tv®
;

186 * 
	mms_£lf
;

187 } 
	tms_sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ_t
;

189 
	sms_sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ_t
 {

190 
	mms_»tv®
;

191 * 
	mms_wa™”
;

192 } 
	tms_sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ_t
;

194 
	sms_sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ_t
 {

195 
	mms_»tv®
;

196 * 
	mms_wa™”
;

197 * 
	mms_£lf
;

198 } 
	tms_sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ_t
;

200 
	sms_sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ_t
 {

201 
	mms_»tv®
;

202 ** 
	mms_wa™”s
;

203 
size_t
 
	mms_tÙ®
;

204 } 
	tms_sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ_t
;

206 #ifdeà
_MSC_VER


207 #´agm¨
w¬nšg
(
push
)

208 #´agm¨
w¬nšg
(
di§bË
: 4127)

209 #´agm¨
w¬nšg
(
di§bË
: 4200)

212 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_maš
(* 
pms
)

214 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

215 ià(
pms
 !ğ
NULL
è 
SGX_ERROR_INVALID_PARAMETER
;

216 
	`eÿÎ_maš
();

217  
¡©us
;

218 
	}
}

220 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_big_m®loc
(* 
pms
)

222 
ms_eÿÎ_big_m®loc_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_big_m®loc_t*, 
pms
);

223 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

225 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_big_m®loc_t
));

227 
ms
->
ms_»tv®
 = 
	`eÿÎ_big_m®loc
();

230  
¡©us
;

231 
	}
}

233 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_ty³_ch¬
(* 
pms
)

235 
ms_eÿÎ_ty³_ch¬_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_ty³_ch¬_t*, 
pms
);

236 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

238 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_ty³_ch¬_t
));

240 
	`eÿÎ_ty³_ch¬
(
ms
->
ms_v®
);

243  
¡©us
;

244 
	}
}

246 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_ty³_št
(* 
pms
)

248 
ms_eÿÎ_ty³_št_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_ty³_št_t*, 
pms
);

249 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

251 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_ty³_št_t
));

253 
	`eÿÎ_ty³_št
(
ms
->
ms_v®
);

256  
¡©us
;

257 
	}
}

259 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_ty³_æßt
(* 
pms
)

261 
ms_eÿÎ_ty³_æßt_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_ty³_æßt_t*, 
pms
);

262 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

264 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_ty³_æßt_t
));

266 
	`eÿÎ_ty³_æßt
(
ms
->
ms_v®
);

269  
¡©us
;

270 
	}
}

272 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_ty³_doubË
(* 
pms
)

274 
ms_eÿÎ_ty³_doubË_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_ty³_doubË_t*, 
pms
);

275 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

277 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_ty³_doubË_t
));

279 
	`eÿÎ_ty³_doubË
(
ms
->
ms_v®
);

282  
¡©us
;

283 
	}
}

285 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_ty³_size_t
(* 
pms
)

287 
ms_eÿÎ_ty³_size_t_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_ty³_size_t_t*, 
pms
);

288 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

290 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_ty³_size_t_t
));

292 
	`eÿÎ_ty³_size_t
(
ms
->
ms_v®
);

295  
¡©us
;

296 
	}
}

298 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_ty³_wch¬_t
(* 
pms
)

300 
ms_eÿÎ_ty³_wch¬_t_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_ty³_wch¬_t_t*, 
pms
);

301 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

303 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_ty³_wch¬_t_t
));

305 
	`eÿÎ_ty³_wch¬_t
(
ms
->
ms_v®
);

308  
¡©us
;

309 
	}
}

311 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_ty³_¡ruù
(* 
pms
)

313 
ms_eÿÎ_ty³_¡ruù_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_ty³_¡ruù_t*, 
pms
);

314 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

316 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_ty³_¡ruù_t
));

318 
	`eÿÎ_ty³_¡ruù
(
ms
->
ms_v®
);

321  
¡©us
;

322 
	}
}

324 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_ty³_’um_uniÚ
(* 
pms
)

326 
ms_eÿÎ_ty³_’um_uniÚ_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_ty³_’um_uniÚ_t*, 
pms
);

327 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

328 
uniÚ_foo_t
* 
_tmp_v®2
 = 
ms
->
ms_v®2
;

330 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_ty³_’um_uniÚ_t
));

332 
	`eÿÎ_ty³_’um_uniÚ
(
ms
->
ms_v®1
, 
_tmp_v®2
);

335  
¡©us
;

336 
	}
}

338 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_poš‹r_u£r_check
(* 
pms
)

340 
ms_eÿÎ_poš‹r_u£r_check_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_poš‹r_u£r_check_t*, 
pms
);

341 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

342 * 
_tmp_v®
 = 
ms
->
ms_v®
;

344 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_poš‹r_u£r_check_t
));

346 
ms
->
ms_»tv®
 = 
	`eÿÎ_poš‹r_u£r_check
(
_tmp_v®
, ms->
ms_sz
);

349  
¡©us
;

350 
	}
}

352 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_poš‹r_š
(* 
pms
)

354 
ms_eÿÎ_poš‹r_š_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_poš‹r_š_t*, 
pms
);

355 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

356 * 
_tmp_v®
 = 
ms
->
ms_v®
;

357 
size_t
 
_Ën_v®
 = (*
_tmp_v®
);

358 * 
_š_v®
 = 
NULL
;

360 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_poš‹r_š_t
));

361 
	`CHECK_UNIQUE_POINTER
(
_tmp_v®
, 
_Ën_v®
);

363 ià(
_tmp_v®
 !ğ
NULL
) {

364 
_š_v®
 = (*)
	`m®loc
(
_Ën_v®
);

365 ià(
_š_v®
 =ğ
NULL
) {

366 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

367 
”r
;

370 
	`memıy
(
_š_v®
, 
_tmp_v®
, 
_Ën_v®
);

372 
	`eÿÎ_poš‹r_š
(
_š_v®
);

373 
”r
:

374 ià(
_š_v®
è
	`ä“
(_in_val);

376  
¡©us
;

377 
	}
}

379 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_poš‹r_out
(* 
pms
)

381 
ms_eÿÎ_poš‹r_out_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_poš‹r_out_t*, 
pms
);

382 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

383 * 
_tmp_v®
 = 
ms
->
ms_v®
;

384 
size_t
 
_Ën_v®
 = (*
_tmp_v®
);

385 * 
_š_v®
 = 
NULL
;

387 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_poš‹r_out_t
));

388 
	`CHECK_UNIQUE_POINTER
(
_tmp_v®
, 
_Ën_v®
);

390 ià(
_tmp_v®
 !ğ
NULL
) {

391 ià((
_š_v®
 = (*)
	`m®loc
(
_Ën_v®
)è=ğ
NULL
) {

392 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

393 
”r
;

396 
	`mem£t
((*)
_š_v®
, 0, 
_Ën_v®
);

398 
	`eÿÎ_poš‹r_out
(
_š_v®
);

399 
”r
:

400 ià(
_š_v®
) {

401 
	`memıy
(
_tmp_v®
, 
_š_v®
, 
_Ën_v®
);

402 
	`ä“
(
_š_v®
);

405  
¡©us
;

406 
	}
}

408 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_poš‹r_š_out
(* 
pms
)

410 
ms_eÿÎ_poš‹r_š_out_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_poš‹r_š_out_t*, 
pms
);

411 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

412 * 
_tmp_v®
 = 
ms
->
ms_v®
;

413 
size_t
 
_Ën_v®
 = (*
_tmp_v®
);

414 * 
_š_v®
 = 
NULL
;

416 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_poš‹r_š_out_t
));

417 
	`CHECK_UNIQUE_POINTER
(
_tmp_v®
, 
_Ën_v®
);

419 ià(
_tmp_v®
 !ğ
NULL
) {

420 
_š_v®
 = (*)
	`m®loc
(
_Ën_v®
);

421 ià(
_š_v®
 =ğ
NULL
) {

422 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

423 
”r
;

426 
	`memıy
(
_š_v®
, 
_tmp_v®
, 
_Ën_v®
);

428 
	`eÿÎ_poš‹r_š_out
(
_š_v®
);

429 
”r
:

430 ià(
_š_v®
) {

431 
	`memıy
(
_tmp_v®
, 
_š_v®
, 
_Ën_v®
);

432 
	`ä“
(
_š_v®
);

435  
¡©us
;

436 
	}
}

438 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_poš‹r_¡ršg
(* 
pms
)

440 
ms_eÿÎ_poš‹r_¡ršg_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_poš‹r_¡ršg_t*, 
pms
);

441 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

442 * 
_tmp_¡r
 = 
ms
->
ms_¡r
;

443 
size_t
 
_Ën_¡r
 = 
_tmp_¡r
 ? 
	`¡¾’
(_tmp_str) + 1 : 0;

444 * 
_š_¡r
 = 
NULL
;

446 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_poš‹r_¡ršg_t
));

447 
	`CHECK_UNIQUE_POINTER
(
_tmp_¡r
, 
_Ën_¡r
);

449 ià(
_tmp_¡r
 !ğ
NULL
) {

450 
_š_¡r
 = (*)
	`m®loc
(
_Ën_¡r
);

451 ià(
_š_¡r
 =ğ
NULL
) {

452 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

453 
”r
;

456 
	`memıy
(
_š_¡r
, 
_tmp_¡r
, 
_Ën_¡r
);

457 
_š_¡r
[
_Ën_¡r
 - 1] = '\0';

459 
	`eÿÎ_poš‹r_¡ršg
(
_š_¡r
);

460 
”r
:

461 ià(
_š_¡r
) {

462 
	`memıy
(
_tmp_¡r
, 
_š_¡r
, 
_Ën_¡r
);

463 
	`ä“
(
_š_¡r
);

466  
¡©us
;

467 
	}
}

469 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_poš‹r_¡ršg_cÚ¡
(* 
pms
)

471 
ms_eÿÎ_poš‹r_¡ršg_cÚ¡_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_poš‹r_¡ršg_cÚ¡_t*, 
pms
);

472 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

473 * 
_tmp_¡r
 = 
ms
->
ms_¡r
;

474 
size_t
 
_Ën_¡r
 = 
_tmp_¡r
 ? 
	`¡¾’
(_tmp_str) + 1 : 0;

475 * 
_š_¡r
 = 
NULL
;

477 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_poš‹r_¡ršg_cÚ¡_t
));

478 
	`CHECK_UNIQUE_POINTER
(
_tmp_¡r
, 
_Ën_¡r
);

480 ià(
_tmp_¡r
 !ğ
NULL
) {

481 
_š_¡r
 = (*)
	`m®loc
(
_Ën_¡r
);

482 ià(
_š_¡r
 =ğ
NULL
) {

483 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

484 
”r
;

487 
	`memıy
((*)
_š_¡r
, 
_tmp_¡r
, 
_Ën_¡r
);

488 
_š_¡r
[
_Ën_¡r
 - 1] = '\0';

490 
	`eÿÎ_poš‹r_¡ršg_cÚ¡
((cÚ¡ *)
_š_¡r
);

491 
”r
:

492 ià(
_š_¡r
è
	`ä“
((*)_in_str);

494  
¡©us
;

495 
	}
}

497 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_poš‹r_size
(* 
pms
)

499 
ms_eÿÎ_poš‹r_size_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_poš‹r_size_t*, 
pms
);

500 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

501 * 
_tmp_±r
 = 
ms
->
ms_±r
;

502 
size_t
 
_tmp_Ën
 = 
ms
->
ms_Ën
;

503 
size_t
 
_Ën_±r
 = 
_tmp_Ën
;

504 * 
_š_±r
 = 
NULL
;

506 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_poš‹r_size_t
));

507 
	`CHECK_UNIQUE_POINTER
(
_tmp_±r
, 
_Ën_±r
);

509 ià(
_tmp_±r
 !ğ
NULL
) {

510 
_š_±r
 = (*)
	`m®loc
(
_Ën_±r
);

511 ià(
_š_±r
 =ğ
NULL
) {

512 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

513 
”r
;

516 
	`memıy
(
_š_±r
, 
_tmp_±r
, 
_Ën_±r
);

518 
	`eÿÎ_poš‹r_size
(
_š_±r
, 
_tmp_Ën
);

519 
”r
:

520 ià(
_š_±r
) {

521 
	`memıy
(
_tmp_±r
, 
_š_±r
, 
_Ën_±r
);

522 
	`ä“
(
_š_±r
);

525  
¡©us
;

526 
	}
}

528 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_poš‹r_couÁ
(* 
pms
)

530 
ms_eÿÎ_poš‹r_couÁ_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_poš‹r_couÁ_t*, 
pms
);

531 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

532 * 
_tmp_¬r
 = 
ms
->
ms_¬r
;

533 
_tmp_út
 = 
ms
->
ms_út
;

534 
size_t
 
_Ën_¬r
 = 
_tmp_út
 * (*
_tmp_¬r
);

535 * 
_š_¬r
 = 
NULL
;

537 ià((
size_t
)
_tmp_út
 > (
SIZE_MAX
 / (*
_tmp_¬r
))) {

538 
¡©us
 = 
SGX_ERROR_INVALID_PARAMETER
;

539 
”r
;

542 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_poš‹r_couÁ_t
));

543 
	`CHECK_UNIQUE_POINTER
(
_tmp_¬r
, 
_Ën_¬r
);

545 ià(
_tmp_¬r
 !ğ
NULL
) {

546 
_š_¬r
 = (*)
	`m®loc
(
_Ën_¬r
);

547 ià(
_š_¬r
 =ğ
NULL
) {

548 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

549 
”r
;

552 
	`memıy
(
_š_¬r
, 
_tmp_¬r
, 
_Ën_¬r
);

554 
	`eÿÎ_poš‹r_couÁ
(
_š_¬r
, 
_tmp_út
);

555 
”r
:

556 ià(
_š_¬r
) {

557 
	`memıy
(
_tmp_¬r
, 
_š_¬r
, 
_Ën_¬r
);

558 
	`ä“
(
_š_¬r
);

561  
¡©us
;

562 
	}
}

564 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_poš‹r_i¥Œ_»adÚly
(* 
pms
)

566 
ms_eÿÎ_poš‹r_i¥Œ_»adÚly_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_poš‹r_i¥Œ_»adÚly_t*, 
pms
);

567 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

568 
bufãr_t
 
_tmp_buf
 = 
ms
->
ms_buf
;

569 
size_t
 
_tmp_Ën
 = 
ms
->
ms_Ën
;

570 
size_t
 
_Ën_buf
 = 
_tmp_Ën
;

571 
bufãr_t
 
_š_buf
 = 
NULL
;

573 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_poš‹r_i¥Œ_»adÚly_t
));

574 
	`CHECK_UNIQUE_POINTER
(
_tmp_buf
, 
_Ën_buf
);

576 ià(
_tmp_buf
 !ğ
NULL
) {

577 
_š_buf
 = (
bufãr_t
)
	`m®loc
(
_Ën_buf
);

578 ià(
_š_buf
 =ğ
NULL
) {

579 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

580 
”r
;

583 
	`memıy
((*)
_š_buf
, 
_tmp_buf
, 
_Ën_buf
);

585 
	`eÿÎ_poš‹r_i¥Œ_»adÚly
(
_š_buf
, 
_tmp_Ën
);

586 
”r
:

587 ià(
_š_buf
è
	`ä“
((*)_in_buf);

589  
¡©us
;

590 
	}
}

592 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_poš‹r_sizefunc
(* 
pms
)

594 
ms_eÿÎ_poš‹r_sizefunc_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_poš‹r_sizefunc_t*, 
pms
);

595 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

596 * 
_tmp_buf
 = 
ms
->
ms_buf
;

597 
size_t
 
_Ën_buf
 = ((
_tmp_buf
è? 
	`g‘_bufãr_Ën
(_tmp_buf) : 0);

598 * 
_š_buf
 = 
NULL
;

600 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_poš‹r_sizefunc_t
));

601 
	`CHECK_UNIQUE_POINTER
(
_tmp_buf
, 
_Ën_buf
);

603 ià(
_tmp_buf
 !ğ
NULL
) {

604 
_š_buf
 = (*)
	`m®loc
(
_Ën_buf
);

605 ià(
_š_buf
 =ğ
NULL
) {

606 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

607 
”r
;

610 
	`memıy
(
_š_buf
, 
_tmp_buf
, 
_Ën_buf
);

613 ià(
	`g‘_bufãr_Ën
(
_š_buf
è!ğ
_Ën_buf
) {

614 
¡©us
 = 
SGX_ERROR_INVALID_PARAMETER
;

615 
”r
;

618 
	`eÿÎ_poš‹r_sizefunc
(
_š_buf
);

619 
”r
:

620 ià(
_š_buf
) {

621 
	`memıy
(
_tmp_buf
, 
_š_buf
, 
_Ën_buf
);

622 
	`ä“
(
_š_buf
);

625  
¡©us
;

626 
	}
}

628 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_oÿÎ_poš‹r_©Œ
(* 
pms
)

630 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

631 ià(
pms
 !ğ
NULL
è 
SGX_ERROR_INVALID_PARAMETER
;

632 
	`oÿÎ_poš‹r_©Œ
();

633  
¡©us
;

634 
	}
}

636 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_¬¿y_u£r_check
(* 
pms
)

638 
ms_eÿÎ_¬¿y_u£r_check_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_¬¿y_u£r_check_t*, 
pms
);

639 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

640 * 
_tmp_¬r
 = 
ms
->
ms_¬r
;

642 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_¬¿y_u£r_check_t
));

644 
	`eÿÎ_¬¿y_u£r_check
(
_tmp_¬r
);

647  
¡©us
;

648 
	}
}

650 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_¬¿y_š
(* 
pms
)

652 
ms_eÿÎ_¬¿y_š_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_¬¿y_š_t*, 
pms
);

653 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

654 * 
_tmp_¬r
 = 
ms
->
ms_¬r
;

655 
size_t
 
_Ën_¬r
 = 4 * (*
_tmp_¬r
);

656 * 
_š_¬r
 = 
NULL
;

658 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_¬¿y_š_t
));

659 
	`CHECK_UNIQUE_POINTER
(
_tmp_¬r
, 
_Ën_¬r
);

661 ià(
_tmp_¬r
 !ğ
NULL
) {

662 
_š_¬r
 = (*)
	`m®loc
(
_Ën_¬r
);

663 ià(
_š_¬r
 =ğ
NULL
) {

664 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

665 
”r
;

668 
	`memıy
(
_š_¬r
, 
_tmp_¬r
, 
_Ën_¬r
);

670 
	`eÿÎ_¬¿y_š
(
_š_¬r
);

671 
”r
:

672 ià(
_š_¬r
è
	`ä“
(_in_arr);

674  
¡©us
;

675 
	}
}

677 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_¬¿y_out
(* 
pms
)

679 
ms_eÿÎ_¬¿y_out_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_¬¿y_out_t*, 
pms
);

680 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

681 * 
_tmp_¬r
 = 
ms
->
ms_¬r
;

682 
size_t
 
_Ën_¬r
 = 4 * (*
_tmp_¬r
);

683 * 
_š_¬r
 = 
NULL
;

685 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_¬¿y_out_t
));

686 
	`CHECK_UNIQUE_POINTER
(
_tmp_¬r
, 
_Ën_¬r
);

688 ià(
_tmp_¬r
 !ğ
NULL
) {

689 ià((
_š_¬r
 = (*)
	`m®loc
(
_Ën_¬r
)è=ğ
NULL
) {

690 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

691 
”r
;

694 
	`mem£t
((*)
_š_¬r
, 0, 
_Ën_¬r
);

696 
	`eÿÎ_¬¿y_out
(
_š_¬r
);

697 
”r
:

698 ià(
_š_¬r
) {

699 
	`memıy
(
_tmp_¬r
, 
_š_¬r
, 
_Ën_¬r
);

700 
	`ä“
(
_š_¬r
);

703  
¡©us
;

704 
	}
}

706 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_¬¿y_š_out
(* 
pms
)

708 
ms_eÿÎ_¬¿y_š_out_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_¬¿y_š_out_t*, 
pms
);

709 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

710 * 
_tmp_¬r
 = 
ms
->
ms_¬r
;

711 
size_t
 
_Ën_¬r
 = 4 * (*
_tmp_¬r
);

712 * 
_š_¬r
 = 
NULL
;

714 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_¬¿y_š_out_t
));

715 
	`CHECK_UNIQUE_POINTER
(
_tmp_¬r
, 
_Ën_¬r
);

717 ià(
_tmp_¬r
 !ğ
NULL
) {

718 
_š_¬r
 = (*)
	`m®loc
(
_Ën_¬r
);

719 ià(
_š_¬r
 =ğ
NULL
) {

720 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

721 
”r
;

724 
	`memıy
(
_š_¬r
, 
_tmp_¬r
, 
_Ën_¬r
);

726 
	`eÿÎ_¬¿y_š_out
(
_š_¬r
);

727 
”r
:

728 ià(
_š_¬r
) {

729 
	`memıy
(
_tmp_¬r
, 
_š_¬r
, 
_Ën_¬r
);

730 
	`ä“
(
_š_¬r
);

733  
¡©us
;

734 
	}
}

736 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_¬¿y_i§ry
(* 
pms
)

738 
ms_eÿÎ_¬¿y_i§ry_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_¬¿y_i§ry_t*, 
pms
);

739 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

741 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_¬¿y_i§ry_t
));

743 
	`eÿÎ_¬¿y_i§ry
((
ms
->
ms_¬r
 !ğ
NULL
) ? (*ms->ms_arr) : NULL);

746  
¡©us
;

747 
	}
}

749 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_funùiÚ_ÿÎšg_cÚvs
(* 
pms
)

751 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

752 ià(
pms
 !ğ
NULL
è 
SGX_ERROR_INVALID_PARAMETER
;

753 
	`eÿÎ_funùiÚ_ÿÎšg_cÚvs
();

754  
¡©us
;

755 
	}
}

757 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_funùiÚ_public
(* 
pms
)

759 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

760 ià(
pms
 !ğ
NULL
è 
SGX_ERROR_INVALID_PARAMETER
;

761 
	`eÿÎ_funùiÚ_public
();

762  
¡©us
;

763 
	}
}

765 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_funùiÚ_´iv©e
(* 
pms
)

767 
ms_eÿÎ_funùiÚ_´iv©e_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_funùiÚ_´iv©e_t*, 
pms
);

768 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

770 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_funùiÚ_´iv©e_t
));

772 
ms
->
ms_»tv®
 = 
	`eÿÎ_funùiÚ_´iv©e
();

775  
¡©us
;

776 
	}
}

778 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_m®loc_ä“
(* 
pms
)

780 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

781 ià(
pms
 !ğ
NULL
è 
SGX_ERROR_INVALID_PARAMETER
;

782 
	`eÿÎ_m®loc_ä“
();

783  
¡©us
;

784 
	}
}

786 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_sgx_ıuid
(* 
pms
)

788 
ms_eÿÎ_sgx_ıuid_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_sgx_ıuid_t*, 
pms
);

789 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

790 * 
_tmp_ıušfo
 = 
ms
->
ms_ıušfo
;

791 
size_t
 
_Ën_ıušfo
 = 4 * (*
_tmp_ıušfo
);

792 * 
_š_ıušfo
 = 
NULL
;

794 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_sgx_ıuid_t
));

795 
	`CHECK_UNIQUE_POINTER
(
_tmp_ıušfo
, 
_Ën_ıušfo
);

797 ià(
_tmp_ıušfo
 !ğ
NULL
) {

798 
_š_ıušfo
 = (*)
	`m®loc
(
_Ën_ıušfo
);

799 ià(
_š_ıušfo
 =ğ
NULL
) {

800 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

801 
”r
;

804 
	`memıy
(
_š_ıušfo
, 
_tmp_ıušfo
, 
_Ën_ıušfo
);

806 
	`eÿÎ_sgx_ıuid
(
_š_ıušfo
, 
ms
->
ms_Ëaf
);

807 
”r
:

808 ià(
_š_ıušfo
) {

809 
	`memıy
(
_tmp_ıušfo
, 
_š_ıušfo
, 
_Ën_ıušfo
);

810 
	`ä“
(
_š_ıušfo
);

813  
¡©us
;

814 
	}
}

816 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_exû±iÚ
(* 
pms
)

818 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

819 ià(
pms
 !ğ
NULL
è 
SGX_ERROR_INVALID_PARAMETER
;

820 
	`eÿÎ_exû±iÚ
();

821  
¡©us
;

822 
	}
}

824 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_m­
(* 
pms
)

826 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

827 ià(
pms
 !ğ
NULL
è 
SGX_ERROR_INVALID_PARAMETER
;

828 
	`eÿÎ_m­
();

829  
¡©us
;

830 
	}
}

832 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_šü—£_couÁ”
(* 
pms
)

834 
ms_eÿÎ_šü—£_couÁ”_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_šü—£_couÁ”_t*, 
pms
);

835 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

837 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_šü—£_couÁ”_t
));

839 
ms
->
ms_»tv®
 = 
	`eÿÎ_šü—£_couÁ”
();

842  
¡©us
;

843 
	}
}

845 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_´oduûr
(* 
pms
)

847 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

848 ià(
pms
 !ğ
NULL
è 
SGX_ERROR_INVALID_PARAMETER
;

849 
	`eÿÎ_´oduûr
();

850  
¡©us
;

851 
	}
}

853 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_cÚsum”
(* 
pms
)

855 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

856 ià(
pms
 !ğ
NULL
è 
SGX_ERROR_INVALID_PARAMETER
;

857 
	`eÿÎ_cÚsum”
();

858  
¡©us
;

859 
	}
}

861 
SGX_EXTERNC
 const struct {

862 
size_t
 
	mÄ_eÿÎ
;

863 ¡ruù {* 
	mÿÎ_addr
; 
ušt8_t
 
	mis_´iv
;} 
	meÿÎ_bË
[36];

864 } 
	gg_eÿÎ_bË
 = {

867 {(*)(
ušŒ_t
)
sgx_eÿÎ_maš
, 0},

868 {(*)(
ušŒ_t
)
sgx_eÿÎ_big_m®loc
, 0},

869 {(*)(
ušŒ_t
)
sgx_eÿÎ_ty³_ch¬
, 0},

870 {(*)(
ušŒ_t
)
sgx_eÿÎ_ty³_št
, 0},

871 {(*)(
ušŒ_t
)
sgx_eÿÎ_ty³_æßt
, 0},

872 {(*)(
ušŒ_t
)
sgx_eÿÎ_ty³_doubË
, 0},

873 {(*)(
ušŒ_t
)
sgx_eÿÎ_ty³_size_t
, 0},

874 {(*)(
ušŒ_t
)
sgx_eÿÎ_ty³_wch¬_t
, 0},

875 {(*)(
ušŒ_t
)
sgx_eÿÎ_ty³_¡ruù
, 0},

876 {(*)(
ušŒ_t
)
sgx_eÿÎ_ty³_’um_uniÚ
, 0},

877 {(*)(
ušŒ_t
)
sgx_eÿÎ_poš‹r_u£r_check
, 0},

878 {(*)(
ušŒ_t
)
sgx_eÿÎ_poš‹r_š
, 0},

879 {(*)(
ušŒ_t
)
sgx_eÿÎ_poš‹r_out
, 0},

880 {(*)(
ušŒ_t
)
sgx_eÿÎ_poš‹r_š_out
, 0},

881 {(*)(
ušŒ_t
)
sgx_eÿÎ_poš‹r_¡ršg
, 0},

882 {(*)(
ušŒ_t
)
sgx_eÿÎ_poš‹r_¡ršg_cÚ¡
, 0},

883 {(*)(
ušŒ_t
)
sgx_eÿÎ_poš‹r_size
, 0},

884 {(*)(
ušŒ_t
)
sgx_eÿÎ_poš‹r_couÁ
, 0},

885 {(*)(
ušŒ_t
)
sgx_eÿÎ_poš‹r_i¥Œ_»adÚly
, 0},

886 {(*)(
ušŒ_t
)
sgx_eÿÎ_poš‹r_sizefunc
, 0},

887 {(*)(
ušŒ_t
)
sgx_oÿÎ_poš‹r_©Œ
, 0},

888 {(*)(
ušŒ_t
)
sgx_eÿÎ_¬¿y_u£r_check
, 0},

889 {(*)(
ušŒ_t
)
sgx_eÿÎ_¬¿y_š
, 0},

890 {(*)(
ušŒ_t
)
sgx_eÿÎ_¬¿y_out
, 0},

891 {(*)(
ušŒ_t
)
sgx_eÿÎ_¬¿y_š_out
, 0},

892 {(*)(
ušŒ_t
)
sgx_eÿÎ_¬¿y_i§ry
, 0},

893 {(*)(
ušŒ_t
)
sgx_eÿÎ_funùiÚ_ÿÎšg_cÚvs
, 0},

894 {(*)(
ušŒ_t
)
sgx_eÿÎ_funùiÚ_public
, 0},

895 {(*)(
ušŒ_t
)
sgx_eÿÎ_funùiÚ_´iv©e
, 1},

896 {(*)(
ušŒ_t
)
sgx_eÿÎ_m®loc_ä“
, 0},

897 {(*)(
ušŒ_t
)
sgx_eÿÎ_sgx_ıuid
, 0},

898 {(*)(
ušŒ_t
)
sgx_eÿÎ_exû±iÚ
, 0},

899 {(*)(
ušŒ_t
)
sgx_eÿÎ_m­
, 0},

900 {(*)(
ušŒ_t
)
sgx_eÿÎ_šü—£_couÁ”
, 0},

901 {(*)(
ušŒ_t
)
sgx_eÿÎ_´oduûr
, 0},

902 {(*)(
ušŒ_t
)
sgx_eÿÎ_cÚsum”
, 0},

906 
SGX_EXTERNC
 const struct {

907 
size_t
 
	mÄ_oÿÎ
;

908 
ušt8_t
 
	m’Œy_bË
[13][36];

909 } 
	gg_dyn_’Œy_bË
 = {

929 
sgx_¡©us_t
 
SGX_CDECL
 
	$oÿÎ_´št_¡ršg
(cÚ¡ * 
¡r
)

931 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

932 
size_t
 
_Ën_¡r
 = 
¡r
 ? 
	`¡¾’
(str) + 1 : 0;

934 
ms_oÿÎ_´št_¡ršg_t
* 
ms
 = 
NULL
;

935 
size_t
 
oÿÎoc_size
 = (
ms_oÿÎ_´št_¡ršg_t
);

936 *
__tmp
 = 
NULL
;

938 
oÿÎoc_size
 +ğ(
¡r
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(¡r, 
_Ën_¡r
)) ? _len_str : 0;

940 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

941 ià(
__tmp
 =ğ
NULL
) {

942 
	`sgx_ocä“
();

943  
SGX_ERROR_UNEXPECTED
;

945 
ms
 = (
ms_oÿÎ_´št_¡ršg_t
*)
__tmp
;

946 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_oÿÎ_´št_¡ršg_t
));

948 ià(
¡r
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(¡r, 
_Ën_¡r
)) {

949 
ms
->
ms_¡r
 = (*)
__tmp
;

950 
__tmp
 = (*)((
size_t
)__tm°+ 
_Ën_¡r
);

951 
	`memıy
((*)
ms
->
ms_¡r
, 
¡r
, 
_Ën_¡r
);

952 } ià(
¡r
 =ğ
NULL
) {

953 
ms
->
ms_¡r
 = 
NULL
;

955 
	`sgx_ocä“
();

956  
SGX_ERROR_INVALID_PARAMETER
;

959 
¡©us
 = 
	`sgx_oÿÎ
(0, 
ms
);

962 
	`sgx_ocä“
();

963  
¡©us
;

964 
	}
}

966 
sgx_¡©us_t
 
SGX_CDECL
 
	$oÿÎ_g’”ic
(* 
»tv®
, 
±r
)

968 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

970 
ms_oÿÎ_g’”ic_t
* 
ms
 = 
NULL
;

971 
size_t
 
oÿÎoc_size
 = (
ms_oÿÎ_g’”ic_t
);

972 *
__tmp
 = 
NULL
;

975 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

976 ià(
__tmp
 =ğ
NULL
) {

977 
	`sgx_ocä“
();

978  
SGX_ERROR_UNEXPECTED
;

980 
ms
 = (
ms_oÿÎ_g’”ic_t
*)
__tmp
;

981 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_oÿÎ_g’”ic_t
));

983 
ms
->
ms_±r
 = 
±r
;

984 
¡©us
 = 
	`sgx_oÿÎ
(1, 
ms
);

986 ià(
»tv®
è*»tv® = 
ms
->
ms_»tv®
;

988 
	`sgx_ocä“
();

989  
¡©us
;

990 
	}
}

992 
sgx_¡©us_t
 
SGX_CDECL
 
	$oÿÎ_poš‹r_u£r_check
(* 
v®
)

994 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

996 
ms_oÿÎ_poš‹r_u£r_check_t
* 
ms
 = 
NULL
;

997 
size_t
 
oÿÎoc_size
 = (
ms_oÿÎ_poš‹r_u£r_check_t
);

998 *
__tmp
 = 
NULL
;

1001 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

1002 ià(
__tmp
 =ğ
NULL
) {

1003 
	`sgx_ocä“
();

1004  
SGX_ERROR_UNEXPECTED
;

1006 
ms
 = (
ms_oÿÎ_poš‹r_u£r_check_t
*)
__tmp
;

1007 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_oÿÎ_poš‹r_u£r_check_t
));

1009 
ms
->
ms_v®
 = 
	`SGX_CAST
(*, 
v®
);

1010 
¡©us
 = 
	`sgx_oÿÎ
(2, 
ms
);

1013 
	`sgx_ocä“
();

1014  
¡©us
;

1015 
	}
}

1017 
sgx_¡©us_t
 
SGX_CDECL
 
	$oÿÎ_poš‹r_š
(* 
v®
)

1019 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

1020 
size_t
 
_Ën_v®
 = (*
v®
);

1022 
ms_oÿÎ_poš‹r_š_t
* 
ms
 = 
NULL
;

1023 
size_t
 
oÿÎoc_size
 = (
ms_oÿÎ_poš‹r_š_t
);

1024 *
__tmp
 = 
NULL
;

1026 
oÿÎoc_size
 +ğ(
v®
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(v®, 
_Ën_v®
)) ? _len_val : 0;

1028 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

1029 ià(
__tmp
 =ğ
NULL
) {

1030 
	`sgx_ocä“
();

1031  
SGX_ERROR_UNEXPECTED
;

1033 
ms
 = (
ms_oÿÎ_poš‹r_š_t
*)
__tmp
;

1034 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_oÿÎ_poš‹r_š_t
));

1036 ià(
v®
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(v®, 
_Ën_v®
)) {

1037 
ms
->
ms_v®
 = (*)
__tmp
;

1038 
__tmp
 = (*)((
size_t
)__tm°+ 
_Ën_v®
);

1039 
	`memıy
(
ms
->
ms_v®
, 
v®
, 
_Ën_v®
);

1040 } ià(
v®
 =ğ
NULL
) {

1041 
ms
->
ms_v®
 = 
NULL
;

1043 
	`sgx_ocä“
();

1044  
SGX_ERROR_INVALID_PARAMETER
;

1047 
¡©us
 = 
	`sgx_oÿÎ
(3, 
ms
);

1050 
	`sgx_ocä“
();

1051  
¡©us
;

1052 
	}
}

1054 
sgx_¡©us_t
 
SGX_CDECL
 
	$oÿÎ_poš‹r_out
(* 
v®
)

1056 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

1057 
size_t
 
_Ën_v®
 = (*
v®
);

1059 
ms_oÿÎ_poš‹r_out_t
* 
ms
 = 
NULL
;

1060 
size_t
 
oÿÎoc_size
 = (
ms_oÿÎ_poš‹r_out_t
);

1061 *
__tmp
 = 
NULL
;

1063 
oÿÎoc_size
 +ğ(
v®
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(v®, 
_Ën_v®
)) ? _len_val : 0;

1065 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

1066 ià(
__tmp
 =ğ
NULL
) {

1067 
	`sgx_ocä“
();

1068  
SGX_ERROR_UNEXPECTED
;

1070 
ms
 = (
ms_oÿÎ_poš‹r_out_t
*)
__tmp
;

1071 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_oÿÎ_poš‹r_out_t
));

1073 ià(
v®
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(v®, 
_Ën_v®
)) {

1074 
ms
->
ms_v®
 = (*)
__tmp
;

1075 
__tmp
 = (*)((
size_t
)__tm°+ 
_Ën_v®
);

1076 
	`mem£t
(
ms
->
ms_v®
, 0, 
_Ën_v®
);

1077 } ià(
v®
 =ğ
NULL
) {

1078 
ms
->
ms_v®
 = 
NULL
;

1080 
	`sgx_ocä“
();

1081  
SGX_ERROR_INVALID_PARAMETER
;

1084 
¡©us
 = 
	`sgx_oÿÎ
(4, 
ms
);

1086 ià(
v®
è
	`memıy
((*)v®, 
ms
->
ms_v®
, 
_Ën_v®
);

1088 
	`sgx_ocä“
();

1089  
¡©us
;

1090 
	}
}

1092 
sgx_¡©us_t
 
SGX_CDECL
 
	$oÿÎ_poš‹r_š_out
(* 
v®
)

1094 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

1095 
size_t
 
_Ën_v®
 = (*
v®
);

1097 
ms_oÿÎ_poš‹r_š_out_t
* 
ms
 = 
NULL
;

1098 
size_t
 
oÿÎoc_size
 = (
ms_oÿÎ_poš‹r_š_out_t
);

1099 *
__tmp
 = 
NULL
;

1101 
oÿÎoc_size
 +ğ(
v®
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(v®, 
_Ën_v®
)) ? _len_val : 0;

1103 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

1104 ià(
__tmp
 =ğ
NULL
) {

1105 
	`sgx_ocä“
();

1106  
SGX_ERROR_UNEXPECTED
;

1108 
ms
 = (
ms_oÿÎ_poš‹r_š_out_t
*)
__tmp
;

1109 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_oÿÎ_poš‹r_š_out_t
));

1111 ià(
v®
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(v®, 
_Ën_v®
)) {

1112 
ms
->
ms_v®
 = (*)
__tmp
;

1113 
__tmp
 = (*)((
size_t
)__tm°+ 
_Ën_v®
);

1114 
	`memıy
(
ms
->
ms_v®
, 
v®
, 
_Ën_v®
);

1115 } ià(
v®
 =ğ
NULL
) {

1116 
ms
->
ms_v®
 = 
NULL
;

1118 
	`sgx_ocä“
();

1119  
SGX_ERROR_INVALID_PARAMETER
;

1122 
¡©us
 = 
	`sgx_oÿÎ
(5, 
ms
);

1124 ià(
v®
è
	`memıy
((*)v®, 
ms
->
ms_v®
, 
_Ën_v®
);

1126 
	`sgx_ocä“
();

1127  
¡©us
;

1128 
	}
}

1130 
sgx_¡©us_t
 
SGX_CDECL
 
	$memcıy
(** 
»tv®
, * 
de¡
, cÚ¡ * 
¤c
, 
v®
, 
size_t
 
Ën
)

1132 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

1133 
size_t
 
_Ën_de¡
 = 
Ën
;

1134 
size_t
 
_Ën_¤c
 = 
Ën
;

1136 
ms_memcıy_t
* 
ms
 = 
NULL
;

1137 
size_t
 
oÿÎoc_size
 = (
ms_memcıy_t
);

1138 *
__tmp
 = 
NULL
;

1140 
oÿÎoc_size
 +ğ(
de¡
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(de¡, 
_Ën_de¡
)) ? _len_dest : 0;

1141 
oÿÎoc_size
 +ğ(
¤c
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(¤c, 
_Ën_¤c
)) ? _len_src : 0;

1143 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

1144 ià(
__tmp
 =ğ
NULL
) {

1145 
	`sgx_ocä“
();

1146  
SGX_ERROR_UNEXPECTED
;

1148 
ms
 = (
ms_memcıy_t
*)
__tmp
;

1149 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_memcıy_t
));

1151 ià(
de¡
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(de¡, 
_Ën_de¡
)) {

1152 
ms
->
ms_de¡
 = (*)
__tmp
;

1153 
__tmp
 = (*)((
size_t
)__tm°+ 
_Ën_de¡
);

1154 
	`memıy
(
ms
->
ms_de¡
, 
de¡
, 
_Ën_de¡
);

1155 } ià(
de¡
 =ğ
NULL
) {

1156 
ms
->
ms_de¡
 = 
NULL
;

1158 
	`sgx_ocä“
();

1159  
SGX_ERROR_INVALID_PARAMETER
;

1162 ià(
¤c
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(¤c, 
_Ën_¤c
)) {

1163 
ms
->
ms_¤c
 = (*)
__tmp
;

1164 
__tmp
 = (*)((
size_t
)__tm°+ 
_Ën_¤c
);

1165 
	`memıy
((*)
ms
->
ms_¤c
, 
¤c
, 
_Ën_¤c
);

1166 } ià(
¤c
 =ğ
NULL
) {

1167 
ms
->
ms_¤c
 = 
NULL
;

1169 
	`sgx_ocä“
();

1170  
SGX_ERROR_INVALID_PARAMETER
;

1173 
ms
->
ms_v®
 = 
v®
;

1174 
ms
->
ms_Ën
 = 
Ën
;

1175 
¡©us
 = 
	`sgx_oÿÎ
(6, 
ms
);

1177 ià(
»tv®
è*»tv® = 
ms
->
ms_»tv®
;

1178 ià(
de¡
è
	`memıy
((*)de¡, 
ms
->
ms_de¡
, 
_Ën_de¡
);

1180 
	`sgx_ocä“
();

1181  
¡©us
;

1182 
	}
}

1184 
sgx_¡©us_t
 
SGX_CDECL
 
	$oÿÎ_funùiÚ_®low
()

1186 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

1187 
¡©us
 = 
	`sgx_oÿÎ
(7, 
NULL
);

1189  
¡©us
;

1190 
	}
}

1192 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_oc_ıuidex
(
ıušfo
[4], 
Ëaf
, 
subËaf
)

1194 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

1195 
size_t
 
_Ën_ıušfo
 = 4 * (*
ıušfo
);

1197 
ms_sgx_oc_ıuidex_t
* 
ms
 = 
NULL
;

1198 
size_t
 
oÿÎoc_size
 = (
ms_sgx_oc_ıuidex_t
);

1199 *
__tmp
 = 
NULL
;

1201 
oÿÎoc_size
 +ğ(
ıušfo
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(ıušfo, 
_Ën_ıušfo
)) ? _len_cpuinfo : 0;

1203 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

1204 ià(
__tmp
 =ğ
NULL
) {

1205 
	`sgx_ocä“
();

1206  
SGX_ERROR_UNEXPECTED
;

1208 
ms
 = (
ms_sgx_oc_ıuidex_t
*)
__tmp
;

1209 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_sgx_oc_ıuidex_t
));

1211 ià(
ıušfo
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(ıušfo, 
_Ën_ıušfo
)) {

1212 
ms
->
ms_ıušfo
 = (*)
__tmp
;

1213 
__tmp
 = (*)((
size_t
)__tm°+ 
_Ën_ıušfo
);

1214 
	`memıy
(
ms
->
ms_ıušfo
, 
ıušfo
, 
_Ën_ıušfo
);

1215 } ià(
ıušfo
 =ğ
NULL
) {

1216 
ms
->
ms_ıušfo
 = 
NULL
;

1218 
	`sgx_ocä“
();

1219  
SGX_ERROR_INVALID_PARAMETER
;

1222 
ms
->
ms_Ëaf
 = 
Ëaf
;

1223 
ms
->
ms_subËaf
 = 
subËaf
;

1224 
¡©us
 = 
	`sgx_oÿÎ
(8, 
ms
);

1226 ià(
ıušfo
è
	`memıy
((*)ıušfo, 
ms
->
ms_ıušfo
, 
_Ën_ıušfo
);

1228 
	`sgx_ocä“
();

1229  
¡©us
;

1230 
	}
}

1232 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ
(* 
»tv®
, cÚ¡ * 
£lf
)

1234 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

1236 
ms_sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ_t
* 
ms
 = 
NULL
;

1237 
size_t
 
oÿÎoc_size
 = (
ms_sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ_t
);

1238 *
__tmp
 = 
NULL
;

1241 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

1242 ià(
__tmp
 =ğ
NULL
) {

1243 
	`sgx_ocä“
();

1244  
SGX_ERROR_UNEXPECTED
;

1246 
ms
 = (
ms_sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ_t
*)
__tmp
;

1247 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ_t
));

1249 
ms
->
ms_£lf
 = 
	`SGX_CAST
(*, 
£lf
);

1250 
¡©us
 = 
	`sgx_oÿÎ
(9, 
ms
);

1252 ià(
»tv®
è*»tv® = 
ms
->
ms_»tv®
;

1254 
	`sgx_ocä“
();

1255  
¡©us
;

1256 
	}
}

1258 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ
(* 
»tv®
, cÚ¡ * 
wa™”
)

1260 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

1262 
ms_sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ_t
* 
ms
 = 
NULL
;

1263 
size_t
 
oÿÎoc_size
 = (
ms_sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ_t
);

1264 *
__tmp
 = 
NULL
;

1267 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

1268 ià(
__tmp
 =ğ
NULL
) {

1269 
	`sgx_ocä“
();

1270  
SGX_ERROR_UNEXPECTED
;

1272 
ms
 = (
ms_sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ_t
*)
__tmp
;

1273 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ_t
));

1275 
ms
->
ms_wa™”
 = 
	`SGX_CAST
(*, 
wa™”
);

1276 
¡©us
 = 
	`sgx_oÿÎ
(10, 
ms
);

1278 ià(
»tv®
è*»tv® = 
ms
->
ms_»tv®
;

1280 
	`sgx_ocä“
();

1281  
¡©us
;

1282 
	}
}

1284 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ
(* 
»tv®
, cÚ¡ * 
wa™”
, cÚ¡ * 
£lf
)

1286 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

1288 
ms_sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ_t
* 
ms
 = 
NULL
;

1289 
size_t
 
oÿÎoc_size
 = (
ms_sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ_t
);

1290 *
__tmp
 = 
NULL
;

1293 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

1294 ià(
__tmp
 =ğ
NULL
) {

1295 
	`sgx_ocä“
();

1296  
SGX_ERROR_UNEXPECTED
;

1298 
ms
 = (
ms_sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ_t
*)
__tmp
;

1299 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ_t
));

1301 
ms
->
ms_wa™”
 = 
	`SGX_CAST
(*, 
wa™”
);

1302 
ms
->
ms_£lf
 = 
	`SGX_CAST
(*, 
£lf
);

1303 
¡©us
 = 
	`sgx_oÿÎ
(11, 
ms
);

1305 ià(
»tv®
è*»tv® = 
ms
->
ms_»tv®
;

1307 
	`sgx_ocä“
();

1308  
¡©us
;

1309 
	}
}

1311 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ
(* 
»tv®
, cÚ¡ ** 
wa™”s
, 
size_t
 
tÙ®
)

1313 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

1314 
size_t
 
_Ën_wa™”s
 = 
tÙ®
 * (*
wa™”s
);

1316 
ms_sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ_t
* 
ms
 = 
NULL
;

1317 
size_t
 
oÿÎoc_size
 = (
ms_sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ_t
);

1318 *
__tmp
 = 
NULL
;

1320 
oÿÎoc_size
 +ğ(
wa™”s
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(wa™”s, 
_Ën_wa™”s
)) ? _len_waiters : 0;

1322 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

1323 ià(
__tmp
 =ğ
NULL
) {

1324 
	`sgx_ocä“
();

1325  
SGX_ERROR_UNEXPECTED
;

1327 
ms
 = (
ms_sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ_t
*)
__tmp
;

1328 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ_t
));

1330 ià(
wa™”s
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(wa™”s, 
_Ën_wa™”s
)) {

1331 
ms
->
ms_wa™”s
 = (**)
__tmp
;

1332 
__tmp
 = (*)((
size_t
)__tm°+ 
_Ën_wa™”s
);

1333 
	`memıy
((*)
ms
->
ms_wa™”s
, 
wa™”s
, 
_Ën_wa™”s
);

1334 } ià(
wa™”s
 =ğ
NULL
) {

1335 
ms
->
ms_wa™”s
 = 
NULL
;

1337 
	`sgx_ocä“
();

1338  
SGX_ERROR_INVALID_PARAMETER
;

1341 
ms
->
ms_tÙ®
 = 
tÙ®
;

1342 
¡©us
 = 
	`sgx_oÿÎ
(12, 
ms
);

1344 ià(
»tv®
è*»tv® = 
ms
->
ms_»tv®
;

1346 
	`sgx_ocä“
();

1347  
¡©us
;

1348 
	}
}

1350 #ifdeà
_MSC_VER


1351 #´agm¨
w¬nšg
(
pİ
)

	@Enclave/Enclave_t.h

1 #iâdeà
ENCLAVE_T_H__


2 
	#ENCLAVE_T_H__


	)

4 
	~<¡dšt.h
>

5 
	~<wch¬.h
>

6 
	~<¡ddef.h
>

7 
	~"sgx_edg”8r.h
"

9 
	~"u£r_ty³s.h
"

11 
	#SGX_CAST
(
ty³
, 
™em
è(Ñy³)(™em))

	)

13 #ifdeà
__ılu¥lus


17 
	s¡ruù_foo_t
 {

18 
ušt32_t
 
¡ruù_foo_0
;

19 
ušt64_t
 
¡ruù_foo_1
;

20 } 
	t¡ruù_foo_t
;

22 
	e’um_foo_t
 {

23 
ENUM_FOO_0
 = 0,

24 
ENUM_FOO_1
 = 1,

25 } 
	t’um_foo_t
;

27 
	uuniÚ_foo_t
 {

28 
ušt32_t
 
uniÚ_foo_0
;

29 
ušt32_t
 
uniÚ_foo_1
;

30 
ušt64_t
 
uniÚ_foo_3
;

31 } 
	tuniÚ_foo_t
;

33 
size_t
 
g‘_bufãr_Ën
(cÚ¡ * 
v®
);

35 
eÿÎ_maš
();

36 
eÿÎ_big_m®loc
();

37 
eÿÎ_ty³_ch¬
(
v®
);

38 
eÿÎ_ty³_št
(
v®
);

39 
eÿÎ_ty³_æßt
(
v®
);

40 
eÿÎ_ty³_doubË
(
v®
);

41 
eÿÎ_ty³_size_t
(
size_t
 
v®
);

42 
eÿÎ_ty³_wch¬_t
(
wch¬_t
 
v®
);

43 
eÿÎ_ty³_¡ruù
(
¡ruù_foo_t
 
v®
);

44 
eÿÎ_ty³_’um_uniÚ
(
’um_foo_t
 
v®1
, 
uniÚ_foo_t
* 
v®2
);

45 
size_t
 
eÿÎ_poš‹r_u£r_check
(* 
v®
, size_ˆ
sz
);

46 
eÿÎ_poš‹r_š
(* 
v®
);

47 
eÿÎ_poš‹r_out
(* 
v®
);

48 
eÿÎ_poš‹r_š_out
(* 
v®
);

49 
eÿÎ_poš‹r_¡ršg
(* 
¡r
);

50 
eÿÎ_poš‹r_¡ršg_cÚ¡
(cÚ¡ * 
¡r
);

51 
eÿÎ_poš‹r_size
(* 
±r
, 
size_t
 
Ën
);

52 
eÿÎ_poš‹r_couÁ
(* 
¬r
, 
út
);

53 
eÿÎ_poš‹r_i¥Œ_»adÚly
(
bufãr_t
 
buf
, 
size_t
 
Ën
);

54 
eÿÎ_poš‹r_sizefunc
(* 
buf
);

55 
oÿÎ_poš‹r_©Œ
();

56 
eÿÎ_¬¿y_u£r_check
(
¬r
[4]);

57 
eÿÎ_¬¿y_š
(
¬r
[4]);

58 
eÿÎ_¬¿y_out
(
¬r
[4]);

59 
eÿÎ_¬¿y_š_out
(
¬r
[4]);

60 
eÿÎ_¬¿y_i§ry
(
¬¿y_t
 
¬r
);

61 
eÿÎ_funùiÚ_ÿÎšg_cÚvs
();

62 
eÿÎ_funùiÚ_public
();

63 
eÿÎ_funùiÚ_´iv©e
();

64 
eÿÎ_m®loc_ä“
();

65 
eÿÎ_sgx_ıuid
(
ıušfo
[4], 
Ëaf
);

66 
eÿÎ_exû±iÚ
();

67 
eÿÎ_m­
();

68 
size_t
 
eÿÎ_šü—£_couÁ”
();

69 
eÿÎ_´oduûr
();

70 
eÿÎ_cÚsum”
();

72 
sgx_¡©us_t
 
SGX_CDECL
 
oÿÎ_´št_¡ršg
(cÚ¡ * 
¡r
);

73 
sgx_¡©us_t
 
SGX_CDECL
 
oÿÎ_g’”ic
(* 
»tv®
, 
±r
);

74 
sgx_¡©us_t
 
SGX_CDECL
 
oÿÎ_poš‹r_u£r_check
(* 
v®
);

75 
sgx_¡©us_t
 
SGX_CDECL
 
oÿÎ_poš‹r_š
(* 
v®
);

76 
sgx_¡©us_t
 
SGX_CDECL
 
oÿÎ_poš‹r_out
(* 
v®
);

77 
sgx_¡©us_t
 
SGX_CDECL
 
oÿÎ_poš‹r_š_out
(* 
v®
);

78 
sgx_¡©us_t
 
SGX_CDECL
 
memcıy
(** 
»tv®
, * 
de¡
, cÚ¡ * 
¤c
, 
v®
, 
size_t
 
Ën
);

79 
sgx_¡©us_t
 
SGX_CDECL
 
oÿÎ_funùiÚ_®low
();

80 
sgx_¡©us_t
 
SGX_CDECL
 
sgx_oc_ıuidex
(
ıušfo
[4], 
Ëaf
, 
subËaf
);

81 
sgx_¡©us_t
 
SGX_CDECL
 
sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ
(* 
»tv®
, cÚ¡ * 
£lf
);

82 
sgx_¡©us_t
 
SGX_CDECL
 
sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ
(* 
»tv®
, cÚ¡ * 
wa™”
);

83 
sgx_¡©us_t
 
SGX_CDECL
 
sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ
(* 
»tv®
, cÚ¡ * 
wa™”
, cÚ¡ * 
£lf
);

84 
sgx_¡©us_t
 
SGX_CDECL
 
sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ
(* 
»tv®
, cÚ¡ ** 
wa™”s
, 
size_t
 
tÙ®
);

86 #ifdeà
__ılu¥lus


	@Enclave/TrustedLibrary/Libc.cpp

26 
	~<¡ršg.h
>

27 
	~<sgx_ıuid.h
>

29 
	~"sgx_Œts.h
"

30 
	~"../Enşave.h
"

31 
	~"Enşave_t.h
"

36 
	$eÿÎ_m®loc_ä“
()

38 *
±r
 = 
	`m®loc
(100);

39 
	`as£¹
(
±r
 !ğ
NULL
);

40 
	`mem£t
(
±r
, 0x0, 100);

41 
	`ä“
(
±r
);

42 
	}
}

47 
	$eÿÎ_sgx_ıuid
(
ıušfo
[4], 
Ëaf
)

49 
sgx_¡©us_t
 
»t
 = 
	`sgx_ıuid
(
ıušfo
, 
Ëaf
);

50 ià(
»t
 !ğ
SGX_SUCCESS
)

51 
	`abÜt
();

52 
	}
}

	@Enclave/TrustedLibrary/Libcxx.cpp

26 
	~<c¡dlib
>

27 
	~<¡ršg
>

29 
	~"../Enşave.h
"

30 
	~"Enşave_t.h
"

37 
	$eÿÎ_exû±iÚ
()

39 
¡d
::
¡ršg
 
foo
 = "foo";

40 
Œy
 {

41 
throw
 
¡d
::
	`ruÁime_”rÜ
(
foo
);

43 
	`ÿtch
 (
¡d
::
ruÁime_”rÜ
 cÚ¡& 
e
) {

44 
	`as£¹
Ğ
foo
 =ğ
e
.
	`wh©
() );

45 
¡d
::
ruÁime_”rÜ
 
	`şÚe
("");

46 
şÚe
 = 
e
;

47 
	`as£¹
(
foo
 =ğ
şÚe
.
	`wh©
() );

49 
	`ÿtch
 (...) {

50 
	`as£¹
Ğ
çl£
 );

52 
	}
}

54 
	~<m­
>

55 
	~<®gÜ™hm
>

57 
usšg
 
Çme¥aû
 
	g¡d
;

63 
	$eÿÎ_m­
()

65 
m­
<, , 
	tËss
<> > 
	tm­_t
;

66 
m­_t
::
	tv®ue_ty³
 
	tm­_v®ue
;

67 
m­_t
 
m
;

69 
m
.
	`š£¹
(
	`m­_v®ue
('a', 1));

70 
m
.
	`š£¹
(
	`m­_v®ue
('b', 2));

71 
m
.
	`š£¹
(
	`m­_v®ue
('c', 3));

72 
m
.
	`š£¹
(
	`m­_v®ue
('d', 4));

74 
	`as£¹
(
m
['a'] == 1);

75 
	`as£¹
(
m
['b'] == 2);

76 
	`as£¹
(
m
['c'] == 3);

77 
	`as£¹
(
m
['d'] == 4);

79 
	`as£¹
(
m
.
	`fšd
('e'è=ğm.
	`’d
());

82 
	}
}

	@Enclave/TrustedLibrary/Thread.cpp

26 
	~"../Enşave.h
"

27 
	~"Enşave_t.h
"

29 
	~<sgx_th»ad.h
>

31 
size_t
 
	gglob®_couÁ”
 = 0;

32 
sgx_th»ad_mu‹x_t
 
	gglob®_mu‹x
 = 
SGX_THREAD_MUTEX_INITIALIZER
;

34 
	#BUFFER_SIZE
 50

	)

37 
	mbuf
[
BUFFER_SIZE
];

38 
	moccup›d
;

39 
	mÃxtš
;

40 
	mÃxtout
;

41 
sgx_th»ad_mu‹x_t
 
	mmu‹x
;

42 
sgx_th»ad_cÚd_t
 
	mmÜe
;

43 
sgx_th»ad_cÚd_t
 
	mËss
;

44 } 
	tcÚd_bufãr_t
;

46 
cÚd_bufãr_t
 
	gbufãr
 = {{0, 0, 0, 0, 0, 0}, 0, 0, 0,

47 
SGX_THREAD_MUTEX_INITIALIZER
, 
SGX_THREAD_COND_INITIALIZER
, SGX_THREAD_COND_INITIALIZER};

53 
size_t
 
	$eÿÎ_šü—£_couÁ”
()

55 
size_t
 
»t
 = 0;

56 
i
 = 0; i < 
LOOPS_PER_THREAD
; i++) {

57 
	`sgx_th»ad_mu‹x_lock
(&
glob®_mu‹x
);

59 
size_t
 
tmp
 = 
glob®_couÁ”
;

60 
glob®_couÁ”
 = ++
tmp
;

61 ià(4*
LOOPS_PER_THREAD
 =ğ
glob®_couÁ”
)

62 
»t
 = 
glob®_couÁ”
;

63 
	`sgx_th»ad_mu‹x_uÆock
(&
glob®_mu‹x
);

65  
»t
;

66 
	}
}

68 
	$eÿÎ_´oduûr
()

70 
i
 = 0; i < 4*
LOOPS_PER_THREAD
; i++) {

71 
cÚd_bufãr_t
 *
b
 = &
bufãr
;

72 
	`sgx_th»ad_mu‹x_lock
(&
b
->
mu‹x
);

73 
b
->
occup›d
 >ğ
BUFFER_SIZE
)

74 
	`sgx_th»ad_cÚd_wa™
(&
b
->
Ëss
, &b->
mu‹x
);

75 
b
->
buf
[b->
Ãxtš
] = b->nextin;

76 
b
->
Ãxtš
++;

77 
b
->
Ãxtš
 %ğ
BUFFER_SIZE
;

78 
b
->
occup›d
++;

79 
	`sgx_th»ad_cÚd_sigÇl
(&
b
->
mÜe
);

80 
	`sgx_th»ad_mu‹x_uÆock
(&
b
->
mu‹x
);

82 
	}
}

84 
	$eÿÎ_cÚsum”
()

86 
i
 = 0; i < 
LOOPS_PER_THREAD
; i++) {

87 
cÚd_bufãr_t
 *
b
 = &
bufãr
;

88 
	`sgx_th»ad_mu‹x_lock
(&
b
->
mu‹x
);

89 
b
->
occup›d
 <= 0)

90 
	`sgx_th»ad_cÚd_wa™
(&
b
->
mÜe
, &b->
mu‹x
);

91 
b
->
buf
[b->
Ãxtout
++] = 0;

92 
b
->
Ãxtout
 %ğ
BUFFER_SIZE
;

93 
b
->
occup›d
--;

94 
	`sgx_th»ad_cÚd_sigÇl
(&
b
->
Ëss
);

95 
	`sgx_th»ad_mu‹x_uÆock
(&
b
->
mu‹x
);

97 
	}
}

	@Enclave/copy_globals.c

1 
_sgx_public_glob®s_¡¬t
;

2 
_sgx_public_glob®s_’d
;

3 
´štf
 (const *, ...);

5 
	$cİy_glob®s
()

7 * 
¡¬t
 = (*)&
_sgx_public_glob®s_¡¬t
;

8 * 
¡İ
 = (*)&
_sgx_public_glob®s_’d
;

9 *
de¡
 = (*)0xA0000000000;

11 
¡¬t
; s¹<
¡İ
; s¹++, 
de¡
++){

13 *
de¡
 = *
¡¬t
;

16 
	}
}

19 * 
m®loc
(
size_t
);

20 
	$eÿÎ_big_m®loc
()

22  ()
	`m®loc
(4096*32);

23 
	}
}

	@Enclave/hello.c

9 
	~<¡dio.h
>

11 
	$maš
() {

12 
	`´štf
("Starting web server\n");

15 
	}
}

	@Enclave/library.c

1 
	#_CRT_SECURE_NO_WARNINGS


	)

2 
	~<¡ršg.h
>

3 
	~<io.h
>

4 
	~<”ºo.h
>

5 
	~<¡dio.h
>

6 
	~<¡dlib.h
>

7 
	~<ùy³.h
>

8 
	~<m©h.h
>

11 
	#PUBLIC_LOWER
 (*)0x0

	)

12 
	#PUBLIC_UPPER
 (*)0xffffffffffffffff

	)

13 
	#PRIVATE_LOWER
 (*)0x0

	)

14 
	#PRIVATE_UPPER
 (*)0xffffffffffffffff

	)

21 
	~<wšdows.h
>

35 
	$as£¹_public
(cÚ¡ * 
s
){

36 if(
s
 < 
PUBLIC_LOWER
 || s >ğ
PUBLIC_UPPER
){

37 
	`´štf
("Publiøouˆoàbound‡cûs © %p\n", 
s
);

38 
	`ex™
(-1);

40 
	}
}

42 
	$as£¹_´iv©e
(cÚ¡ * 
s
){

43 if(
s
 < 
PRIVATE_LOWER
 || s >ğ
PRIVATE_UPPER
){

44 
	`´štf
("Priv©ouˆoàbound‡cûs © %p\n", 
s
);

45 
	`ex™
(-1);

47 
	}
}

49 
	$g‘_’üy±_Ëngth
(cÚ¡ *
t
, 
size_t
 
n
){

50  
n
*2;

51 
	}
}

53 
	$is_´iv©e_fe
(cÚ¡ * 
·th
){

54 
Ëngth
 = 
	`¡¾’
(
·th
);

55 if(
	`¡rcmp
(".±xt" , &
·th
[
Ëngth
-5])==0)

58 
	}
}

60 
	$’üy±
(* 
de¡
, cÚ¡ *
¤c
, 
size_t
 
n
 ) {

61 
i
;

62 
i
=0;i<
n
; i++) {

63 
de¡
[
i
]='*';

66 
	}
}

68 
	efd_ty³
 {

69 
	mUNDEFINED
=0, 
	mPUBLIC
, 
	mPRIVATE


72 
fd_ty³
 
	gfds_ty³
[2050] = {0};

75 
FILE
* 
	$fİ’__w¿µ”
(cÚ¡ * 
f’ame
, cÚ¡ * 
mode
) {

76 
FILE
* 
»t
 = 
	`fİ’
(
f’ame
, 
mode
);

77 if(
	`is_´iv©e_fe
(
f’ame
))

78 
fds_ty³
[
	`_f’o
(
»t
)] = 
PRIVATE
;

80 
fds_ty³
[
	`_f’o
(
»t
)] = 
PUBLIC
;

81  
»t
;

82 
	}
}

84 
	$fşo£__w¿µ”
(
FILE
* 
¡»am
) {

85 
fd
 = 
	`_f’o
(
¡»am
);

86 
»t
 = 
	`fşo£
(
¡»am
);

87 ià(
»t
==0)

88 
fds_ty³
[
fd
] = 
UNDEFINED
;

89  
»t
;

90 
	}
}

92 
size_t
 
	$ä—d__w¿µ”
Ğ* 
±r
, 
size_t
 
size
, size_ˆ
couÁ
, 
FILE
 * 
¡»am
 ) {

93 
	`as£¹_public
(
±r
);

94 
	`as£¹_public
((*)
±r
 + 
size
*
couÁ
);

95 
fd_ty³
 
ty³
 = 
fds_ty³
[
	`_f’o
(
¡»am
)];

96 if(
ty³
 =ğ
UNDEFINED
){

97 
	`´štf
("Attempting„ead on unknown file\n");

98 
	`ex™
(-1);

99 }if(
ty³
 =ğ
PRIVATE
) {

100 
	`´štf
("Attemptingo„ead…rivate file with…ublic_read\n");

101 
	`ex™
(-1);

103  
	`ä—d
(
±r
, 
size
, 
couÁ
, 
¡»am
);

104 
	}
}

106 * 
mym®loc
(
size_t
);

107 
size_t
 
	$ä—d_´iv©e__w¿µ”
 ( * 
±r
, 
size_t
 
size
, size_ˆ
couÁ
, 
FILE
 * 
¡»am
 ) {

121 *
public_±r
 = 
	`mym®loc
(
size
);

122 
fmt
[] = "Pointer from malloc = %p\n";

123 
	`´štf
(
fmt
, 
public_±r
);

124 
»t
 = 
	`ä—d
(
public_±r
, 
size
, 
couÁ
, 
¡»am
);

127 
	`myä“
(
public_±r
);

128  
»t
;

130 
	}
}

	@Enclave/main.c

1 
´štf
(const *, ...);

5 
	$dummy
() {

6 
	}
}

10 
	$maš
(){

11 
Çme
[100];

16 
	`´štf
("Hello world\n");

22 
	}
}

	@Enclave/mongoose.c

1 
	~"mÚgoo£.h
"

2 #ifdeà
MG_MODULE_LINES


10 #iâdeà
CS_MONGOOSE_SRC_INTERNAL_H_


11 
	#CS_MONGOOSE_SRC_INTERNAL_H_


	)

13 #iâdeà
MG_MALLOC


14 
	#MG_MALLOC
 
m®loc


	)

17 #iâdeà
MG_CALLOC


18 
	#MG_CALLOC
 
ÿÎoc


	)

21 #iâdeà
MG_REALLOC


22 
	#MG_REALLOC
 
»®loc


	)

25 #iâdeà
MG_FREE


26 
	#MG_FREE
 
ä“


	)

29 #iâdeà
MBUF_REALLOC


30 
	#MBUF_REALLOC
 
MG_REALLOC


	)

33 #iâdeà
MBUF_FREE


34 
	#MBUF_FREE
 
MG_FREE


	)

37 
	#MG_SET_PTRPTR
(
_±r
, 
_v
) \

39 ià(
_±r
è*(_±rèğ
_v
; \

40 } 0)

	)

42 #iâdeà
MG_INTERNAL


43 
	#MG_INTERNAL
 

	)

46 #ifdeà
PICOTCP


47 
	#NO_LIBC


	)

48 
	#MG_DISABLE_PFS


	)

55 
	#MG_CTL_MSG_MESSAGE_SIZE
 8192

	)

58 
	gmiüoF»q
;

59 
	gÏ¡Time
;

60 
»adrdtsc
();

63 
	g¡¬‹d_couÁ”
 = 0;

64 
	gabsŞu‹_couÁ”
 = 0;

65 
	g¡¬t_couÁ”
;

66 
	g¡İ_couÁ”
;

71 
MG_INTERNAL
 
mg_cÚÃùiÚ
 *
mg_do_cÚÃù
(mg_cÚÃùiÚ *
nc
,

72 
´Ùo
,

73 
sock‘_add»ss
 *
§
);

75 
MG_INTERNAL
 
mg_·r£_add»ss
(cÚ¡ *
¡r
, 
sock‘_add»ss
 *
§
,

76 *
´Ùo
, *
ho¡
, 
size_t
 
ho¡_Ën
);

77 
MG_INTERNAL
 
mg_ÿÎ
(
mg_cÚÃùiÚ
 *
nc
,

78 
mg_ev’t_hªdËr_t
 
ev_hªdËr
, 
ev
, *
ev_d©a
);

79 
mg_fÜw¬d
(
mg_cÚÃùiÚ
 *
äom
, mg_cÚÃùiÚ *
to
);

80 
MG_INTERNAL
 
mg_add_cÚn
(
mg_mgr
 *
mgr
, 
mg_cÚÃùiÚ
 *
c
);

81 
MG_INTERNAL
 
mg_»move_cÚn
(
mg_cÚÃùiÚ
 *
c
);

82 
MG_INTERNAL
 
mg_cÚÃùiÚ
 *
mg_ü—‹_cÚÃùiÚ
(

83 
mg_mgr
 *
mgr
, 
mg_ev’t_hªdËr_t
 
ÿÎback
,

84 
mg_add_sock_İts
 
İts
);

85 #ifdeà
_WIN32


87 
to_wch¬
(cÚ¡ *
·th
, 
wch¬_t
 *
wbuf
, 
size_t
 
wbuf_Ën
);

90 
	sùl_msg
 {

91 
mg_ev’t_hªdËr_t
 
	mÿÎback
;

92 
	mmes§ge
[
MG_CTL_MSG_MESSAGE_SIZE
];

95 #ià
MG_ENABLE_MQTT


96 
	gmg_mq‰_mes§ge
;

97 
MG_INTERNAL
 
·r£_mq‰
(
mbuf
 *
io
, 
mg_mq‰_mes§ge
 *
mm
);

101 *(*
‹¡_m®loc
)(
size_t
 
size
);

102 *(*
‹¡_ÿÎoc
)(
size_t
 
couÁ
, size_ˆ
size
);

104 #iâdeà
MIN


105 
	#MIN
(
a
, 
b
è(×è< (bè? (aè: (b))

	)

108 #ià
MG_ENABLE_HTTP


109 
	gmg_£rve_h‰p_İts
;

122 
MG_INTERNAL
 
size_t
 
mg_hªdË_chunked
(
mg_cÚÃùiÚ
 *
nc
,

123 
h‰p_mes§ge
 *
hm
, *
buf
,

124 
size_t
 
bËn
);

126 
MG_INTERNAL
 
mg_h‰p_commÚ_u¾_·r£
(cÚ¡ *
u¾
, cÚ¡ *
schema
,

127 cÚ¡ *
schema_s
, *
u£_s¦
,

128 **
u£r
, **
·ss
, **
addr
,

129 *
pÜt_i
, cÚ¡ **
·th
);

131 #ià
MG_ENABLE_FILESYSTEM


132 
MG_INTERNAL
 
mg_uri_to_loÿl_·th
(
h‰p_mes§ge
 *
hm
,

133 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
,

134 **
loÿl_·th
,

135 
mg_¡r
 *
»mašd”
);

136 
MG_INTERNAL
 
time_t
 
mg_·r£_d©e_¡ršg
(cÚ¡ *
d©‘ime
);

137 
MG_INTERNAL
 
mg_is_nÙ_modif›d
(
h‰p_mes§ge
 *
hm
, 
cs_¡©_t
 *
¡
);

139 #ià
MG_ENABLE_HTTP_CGI


140 
MG_INTERNAL
 
mg_hªdË_cgi
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
´og
,

141 cÚ¡ 
mg_¡r
 *
·th_šfo
,

142 cÚ¡ 
h‰p_mes§ge
 *
hm
,

143 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
);

144 
	gmg_h‰p_´Ùo_d©a_cgi
;

145 
MG_INTERNAL
 
mg_h‰p_ä“_´Ùo_d©a_cgi
(
mg_h‰p_´Ùo_d©a_cgi
 *
d
);

147 #ià
MG_ENABLE_HTTP_SSI


148 
MG_INTERNAL
 
mg_hªdË_ssi_»que¡
(
mg_cÚÃùiÚ
 *
nc
,

149 
h‰p_mes§ge
 *
hm
,

150 cÚ¡ *
·th
,

151 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
);

153 #ià
MG_ENABLE_HTTP_WEBDAV


154 
MG_INTERNAL
 
mg_is_dav_»que¡
(cÚ¡ 
mg_¡r
 *
s
);

155 
MG_INTERNAL
 
mg_hªdË_´İfšd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

156 
cs_¡©_t
 *
¡p
, 
h‰p_mes§ge
 *
hm
,

157 
mg_£rve_h‰p_İts
 *
İts
);

158 
MG_INTERNAL
 
mg_hªdË_lock
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
);

159 
MG_INTERNAL
 
mg_hªdË_mkcŞ
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

160 
h‰p_mes§ge
 *
hm
);

161 
MG_INTERNAL
 
mg_hªdË_move
(
mg_cÚÃùiÚ
 *
c
,

162 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
,

163 cÚ¡ *
·th
, 
h‰p_mes§ge
 *
hm
);

164 
MG_INTERNAL
 
mg_hªdË_d–‘e
(
mg_cÚÃùiÚ
 *
nc
,

165 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
,

166 cÚ¡ *
·th
);

167 
MG_INTERNAL
 
mg_hªdË_put
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

168 
h‰p_mes§ge
 *
hm
);

170 #ià
MG_ENABLE_HTTP_WEBSOCKET


171 
MG_INTERNAL
 
mg_ws_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
, *
ev_d©a
);

172 
MG_INTERNAL
 
mg_ws_hªdshake
(
mg_cÚÃùiÚ
 *
nc
,

173 cÚ¡ 
mg_¡r
 *
key
);

177 
MG_INTERNAL
 
mg_g‘_”ºo
();

179 
MG_INTERNAL
 
mg_şo£_cÚn
(
mg_cÚÃùiÚ
 *
cÚn
);

181 
MG_INTERNAL
 
mg_h‰p_commÚ_u¾_·r£
(cÚ¡ *
u¾
, cÚ¡ *
schema
,

182 cÚ¡ *
schema_s
, *
u£_s¦
,

183 **
u£r
, **
·ss
, **
addr
,

184 *
pÜt_i
, cÚ¡ **
·th
);

186 #ià
MG_ENABLE_SNTP


187 
MG_INTERNAL
 
mg_¢_·r£_»¶y
(cÚ¡ *
buf
, 
Ën
,

188 
mg_¢_mes§ge
 *
msg
);

192 #ifdeà
MG_MODULE_LINES


200 #iâdeà
CS_COMMON_CS_DBG_H_


201 
	#CS_COMMON_CS_DBG_H_


	)

205 #ià
CS_ENABLE_STDIO


206 
	~<¡dio.h
>

209 #iâdeà
CS_ENABLE_DEBUG


210 
	#CS_ENABLE_DEBUG
 0

	)

213 #iâdeà
CS_LOG_ENABLE_TS_DIFF


214 
	#CS_LOG_ENABLE_TS_DIFF
 0

	)

217 #ifdeà
__ılu¥lus


221 
	ecs_log_Ëv–
 {

222 
LL_NONE
 = -1,

223 
LL_ERROR
 = 0,

224 
LL_WARN
 = 1,

225 
LL_INFO
 = 2,

226 
LL_DEBUG
 = 3,

227 
LL_VERBOSE_DEBUG
 = 4,

229 
_LL_MIN
 = -2,

230 
_LL_MAX
 = 5,

233 
cs_log_£t_Ëv–
(
cs_log_Ëv–
 
Ëv–
);

235 #ià
CS_ENABLE_STDIO


237 
cs_log_£t_fe
(
FILE
 *
fe
);

238 
cs_log_Ëv–
 cs_log_level;

239 
cs_log_´št_´efix
(cÚ¡ *
func
);

240 
cs_log_´štf
(cÚ¡ *
fmt
, ...);

242 
	#LOG
(
l
, 
x
) \

244 ià(
cs_log_Ëv–
 >ğ
l
) { \

245 
	`cs_log_´št_´efix
(
__func__
); \

246 
cs_log_´štf
 
x
; \

248 } 0)

	)

250 #iâdeà
CS_NDEBUG


252 
	#DBG
(
x
) \

254 ià(
cs_log_Ëv–
 >ğ
LL_VERBOSE_DEBUG
) { \

255 
	`cs_log_´št_´efix
(
__func__
); \

256 
cs_log_´štf
 
x
; \

258 } 0)

	)

262 
	#DBG
(
x
)

	)

268 
	#LOG
(
l
, 
x
)

	)

269 
	#DBG
(
x
)

	)

273 #ifdeà
__ılu¥lus


278 #ifdeà
MG_MODULE_LINES


288 
	~<¡d¬g.h
>

289 
	~<¡dio.h
>

293 
cs_log_Ëv–
 cs_log_Ëv– 
	gWEAK
 =

294 #ià
CS_ENABLE_DEBUG


295 
LL_VERBOSE_DEBUG
;

297 
	gLL_ERROR
;

300 #ià
CS_ENABLE_STDIO


302 
FILE
 *
cs_log_fe
 
	gWEAK
 = 
NULL
;

304 #ià
CS_LOG_ENABLE_TS_DIFF


305 
cs_log_ts
 
	gWEAK
;

308 
	$cs_log_´št_´efix
(cÚ¡ *
func
è
WEAK
;

309 
	$cs_log_´št_´efix
(cÚ¡ *
func
) {

310 
´efix
[21];

311 
	`¡ºıy
(
´efix
, 
func
, 20);

312 
´efix
[20] = '\0';

313 ià(
cs_log_fe
 =ğ
NULL
ècs_log_fğ
¡d”r
;

314 
	`årštf
(
cs_log_fe
, "%-20 ", 
´efix
);

315 #ià
CS_LOG_ENABLE_TS_DIFF


317 
now
 = 
	`cs_time
();

318 
	`årštf
(
cs_log_fe
, "%7u ", (è((
now
 - 
cs_log_ts
) * 1000000));

319 
cs_log_ts
 = 
now
;

322 
	}
}

324 
	$cs_log_´štf
(cÚ¡ *
fmt
, ...è
WEAK
;

325 
	$cs_log_´štf
(cÚ¡ *
fmt
, ...) {

326 
va_li¡
 
­
;

327 
	`va_¡¬t
(
­
, 
fmt
);

328 
	`vårštf
(
cs_log_fe
, 
fmt
, 
­
);

329 
	`va_’d
(
­
);

330 
	`åutc
('\n', 
cs_log_fe
);

331 
	`fæush
(
cs_log_fe
);

332 
	}
}

334 
	$cs_log_£t_fe
(
FILE
 *
fe
è
WEAK
;

335 
	$cs_log_£t_fe
(
FILE
 *
fe
) {

336 
cs_log_fe
 = 
fe
;

337 
	}
}

341 
	$cs_log_£t_Ëv–
(
cs_log_Ëv–
 
Ëv–
è
WEAK
;

342 
	$cs_log_£t_Ëv–
(
cs_log_Ëv–
 
Ëv–
) {

343 
cs_log_Ëv–
 = 
Ëv–
;

344 #ià
CS_LOG_ENABLE_TS_DIFF
 && 
CS_ENABLE_STDIO


345 
cs_log_ts
 = 
	`cs_time
();

347 
	}
}

348 #ifdeà
MG_MODULE_LINES


356 #iâdeà
EXCLUDE_COMMON


360 
	~<¡ršg.h
>

366 
	#NUM_UPPERCASES
 ('Z' - 'A' + 1)

	)

367 
	#NUM_LETTERS
 (
NUM_UPPERCASES
 * 2)

	)

368 
	#NUM_DIGITS
 ('9' - '0' + 1)

	)

375 
	$cs_ba£64_em™_code
(
cs_ba£64_ùx
 *
ùx
, 
v
) {

376 ià(
v
 < 
NUM_UPPERCASES
) {

377 
ùx
->
	`b64_putc
(
v
 + 'A', ctx->
u£r_d©a
);

378 } ià(
v
 < (
NUM_LETTERS
)) {

379 
ùx
->
	`b64_putc
(
v
 - 
NUM_UPPERCASES
 + 'a', ctx->
u£r_d©a
);

380 } ià(
v
 < (
NUM_LETTERS
 + 
NUM_DIGITS
)) {

381 
ùx
->
	`b64_putc
(
v
 - 
NUM_LETTERS
 + '0', ctx->
u£r_d©a
);

383 
ùx
->
	`b64_putc
(
v
 - 
NUM_LETTERS
 - 
NUM_DIGITS
 == 0 ? '+' : '/',

384 
ùx
->
u£r_d©a
);

386 
	}
}

388 
	$cs_ba£64_em™_chunk
(
cs_ba£64_ùx
 *
ùx
) {

389 
a
, 
b
, 
c
;

391 
a
 = 
ùx
->
chunk
[0];

392 
b
 = 
ùx
->
chunk
[1];

393 
c
 = 
ùx
->
chunk
[2];

395 
	`cs_ba£64_em™_code
(
ùx
, 
a
 >> 2);

396 
	`cs_ba£64_em™_code
(
ùx
, ((
a
 & 3è<< 4è| (
b
 >> 4));

397 ià(
ùx
->
chunk_size
 > 1) {

398 
	`cs_ba£64_em™_code
(
ùx
, (
b
 & 15è<< 2 | (
c
 >> 6));

400 ià(
ùx
->
chunk_size
 > 2) {

401 
	`cs_ba£64_em™_code
(
ùx
, 
c
 & 63);

403 
	}
}

405 
	$cs_ba£64_š™
(
cs_ba£64_ùx
 *
ùx
, 
cs_ba£64_putc_t
 
b64_putc
,

406 *
u£r_d©a
) {

407 
ùx
->
chunk_size
 = 0;

408 
ùx
->
b64_putc
 = b64_putc;

409 
ùx
->
u£r_d©a
 = user_data;

410 
	}
}

412 
	$cs_ba£64_upd©e
(
cs_ba£64_ùx
 *
ùx
, cÚ¡ *
¡r
, 
size_t
 
Ën
) {

413 cÚ¡ *
¤c
 = (cÚ¡ *è
¡r
;

414 
size_t
 
i
;

415 
i
 = 0; i < 
Ën
; i++) {

416 
ùx
->
chunk
[ùx->
chunk_size
++] = 
¤c
[
i
];

417 ià(
ùx
->
chunk_size
 == 3) {

418 
	`cs_ba£64_em™_chunk
(
ùx
);

419 
ùx
->
chunk_size
 = 0;

422 
	}
}

424 
	$cs_ba£64_fšish
(
cs_ba£64_ùx
 *
ùx
) {

425 ià(
ùx
->
chunk_size
 > 0) {

426 
i
;

427 
	`mem£t
(&
ùx
->
chunk
[ùx->
chunk_size
], 0, 3 - ctx->chunk_size);

428 
	`cs_ba£64_em™_chunk
(
ùx
);

429 
i
 = 0; i < (3 - 
ùx
->
chunk_size
); i++) {

430 
ùx
->
	`b64_putc
('=', ctx->
u£r_d©a
);

433 
	}
}

435 
	#BASE64_ENCODE_BODY
 \

436 cÚ¡ *
b64
 = \

438 
i
, 
j
, 
a
, 
b
, 
c
; \

440 
i
 = 
j
 = 0; i < 
¤c_Ën
; i += 3) { \

441 
a
 = 
¤c
[
i
]; \

442 
b
 = 
i
 + 1 >ğ
¤c_Ën
 ? 0 : 
¤c
[i + 1]; \

443 
c
 = 
i
 + 2 >ğ
¤c_Ën
 ? 0 : 
¤c
[i + 2]; \

445 
	`BASE64_OUT
(
b64
[
a
 >> 2]); \

446 
	`BASE64_OUT
(
b64
[((
a
 & 3è<< 4è| (
b
 >> 4)]); \

447 ià(
i
 + 1 < 
¤c_Ën
) { \

448 
	`BASE64_OUT
(
b64
[(
b
 & 15è<< 2 | (
c
 >> 6)]); \

450 ià(
i
 + 2 < 
¤c_Ën
) { \

451 
	`BASE64_OUT
(
b64
[
c
 & 63]); \

455 
j
 % 4 != 0) { \

456 
	`BASE64_OUT
('='); \

458 
	`BASE64_FLUSH
()

	)

460 
	#BASE64_OUT
(
ch
) \

462 
d¡
[
j
++] = (
ch
); \

463 } 0)

	)

465 
	#BASE64_FLUSH
() \

467 
d¡
[
j
++] = '\0'; \

468 } 0)

	)

470 
	$cs_ba£64_’code
(cÚ¡ *
¤c
, 
¤c_Ën
, *
d¡
) {

471 
BASE64_ENCODE_BODY
;

472 
	}
}

474 #undeà
BASE64_OUT


475 #undeà
BASE64_FLUSH


477 #ià
CS_ENABLE_STDIO


478 
	#BASE64_OUT
(
ch
) \

480 
	`årštf
(
f
, "%c", (
ch
)); \

481 
j
++; \

482 } 0)

	)

484 
	#BASE64_FLUSH
()

	)

486 
	$cs_åršt_ba£64
(
FILE
 *
f
, cÚ¡ *
¤c
, 
¤c_Ën
) {

487 
BASE64_ENCODE_BODY
;

488 
	}
}

490 #undeà
BASE64_OUT


491 #undeà
BASE64_FLUSH


495 
	$äom_b64
(
ch
) {

497 cÚ¡ 
b
[128] = {

531  
b
[
ch
 & 127];

532 
	}
}

534 
	$cs_ba£64_decode
(cÚ¡ *
s
, 
Ën
, *
d¡
, *
dec_Ën
) {

535 
a
, 
b
, 
c
, 
d
;

536 
Üig_Ën
 = 
Ën
;

537 *
Üig_d¡
 = 
d¡
;

538 
Ën
 >ğ4 && (
a
 = 
	`äom_b64
(
s
[0])) != 255 &&

539 (
b
 = 
	`äom_b64
(
s
[1])è!ğ255 && (
c
 = from_b64(s[2])) != 255 &&

540 (
d
 = 
	`äom_b64
(
s
[3])) != 255) {

541 
s
 += 4;

542 
Ën
 -= 4;

543 ià(
a
 =ğ200 || 
b
 == 200) ;

544 *
d¡
++ = 
a
 << 2 | 
b
 >> 4;

545 ià(
c
 == 200) ;

546 *
d¡
++ = 
b
 << 4 | 
c
 >> 2;

547 ià(
d
 == 200) ;

548 *
d¡
++ = 
c
 << 6 | 
d
;

550 *
d¡
 = 0;

551 ià(
dec_Ën
 !ğ
NULL
è*dec_ËÀğ(
d¡
 - 
Üig_d¡
);

552  
Üig_Ën
 - 
Ën
;

553 
	}
}

556 #ifdeà
MG_MODULE_LINES


564 #iâdeà
CS_COMMON_CS_DIRENT_H_


565 
	#CS_COMMON_CS_DIRENT_H_


	)

567 
	~<lim™s.h
>

571 #ifdeà
__ılu¥lus


575 #ifdeà
CS_DEFINE_DIRENT


576 ¡ruù { 
dummy
; } 
	tDIR
;

578 
	sdœ’t
 {

579 
	md_šo
;

580 #ifdeà
_WIN32


581 
	md_Çme
[
MAX_PATH
];

584 
	md_Çme
[256];

588 
DIR
 *
İ’dœ
(cÚ¡ *
dœ_Çme
);

589 
şo£dœ
(
DIR
 *
dœ
);

590 
dœ’t
 *
»addœ
(
DIR
 *
dœ
);

593 #ifdeà
__ılu¥lus


598 #ifdeà
MG_MODULE_LINES


606 #iâdeà
EXCLUDE_COMMON


615 #iâdeà
MG_FREE


616 
	#MG_FREE
 
ä“


	)

619 #iâdeà
MG_MALLOC


620 
	#MG_MALLOC
 
m®loc


	)

623 #ifdeà
_WIN32


624 
	swš32_dœ
 {

625 
DIR
 
	md
;

626 
HANDLE
 
	mhªdË
;

627 
WIN32_FIND_DATAW
 
	mšfo
;

628 
dœ’t
 
	m»suÉ
;

631 
DIR
 *
	$İ’dœ
(cÚ¡ *
Çme
) {

632 
wš32_dœ
 *
dœ
 = 
NULL
;

633 
wch¬_t
 
w·th
[
MAX_PATH
];

634 
DWORD
 
©Œs
;

636 ià(
Çme
 =ğ
NULL
) {

637 
	`S‘La¡E¼Ü
(
ERROR_BAD_ARGUMENTS
);

638 } ià((
dœ
 = (
wš32_dœ
 *è
	`MG_MALLOC
((*dœ))è=ğ
NULL
) {

639 
	`S‘La¡E¼Ü
(
ERROR_NOT_ENOUGH_MEMORY
);

641 
	`to_wch¬
(
Çme
, 
w·th
, 
	`ARRAY_SIZE
(wpath));

642 
©Œs
 = 
	`G‘FeA‰ribu‹sW
(
w·th
);

643 ià(
©Œs
 !ğ0xFFFFFFFF && (©Œ & 
FILE_ATTRIBUTE_DIRECTORY
)) {

644 (è
	`wcsÿt
(
w·th
, 
L
"\\*");

645 
dœ
->
hªdË
 = 
	`FšdFœ¡FeW
(
w·th
, &dœ->
šfo
);

646 
dœ
->
»suÉ
.
d_Çme
[0] = '\0';

648 
	`MG_FREE
(
dœ
);

649 
dœ
 = 
NULL
;

653  (
DIR
 *è
dœ
;

654 
	}
}

656 
	$şo£dœ
(
DIR
 *
d
) {

657 
wš32_dœ
 *
dœ
 = (wš32_dœ *è
d
;

658 
»suÉ
 = 0;

660 ià(
dœ
 !ğ
NULL
) {

661 ià(
dœ
->
hªdË
 !ğ
INVALID_HANDLE_VALUE
)

662 
»suÉ
 = 
	`FšdClo£
(
dœ
->
hªdË
) ? 0 : -1;

663 
	`MG_FREE
(
dœ
);

665 
»suÉ
 = -1;

666 
	`S‘La¡E¼Ü
(
ERROR_BAD_ARGUMENTS
);

669  
»suÉ
;

670 
	}
}

672 
dœ’t
 *
	$»addœ
(
DIR
 *
d
) {

673 
wš32_dœ
 *
dœ
 = (wš32_dœ *è
d
;

674 
dœ’t
 *
»suÉ
 = 
NULL
;

676 ià(
dœ
) {

677 
	`mem£t
(&
dœ
->
»suÉ
, 0, (dir->result));

678 ià(
dœ
->
hªdË
 !ğ
INVALID_HANDLE_VALUE
) {

679 
»suÉ
 = &
dœ
->result;

680 (è
	`WideCh¬ToMuÉiBy‹
(
CP_UTF8
, 0, 
dœ
->
šfo
.
cFeName
, -1,

681 
»suÉ
->
d_Çme
, ÔesuÉ->d_Çme), 
NULL
,

682 
NULL
);

684 ià(!
	`FšdNextFeW
(
dœ
->
hªdË
, &dœ->
šfo
)) {

685 (è
	`FšdClo£
(
dœ
->
hªdË
);

686 
dœ
->
hªdË
 = 
INVALID_HANDLE_VALUE
;

690 
	`S‘La¡E¼Ü
(
ERROR_FILE_NOT_FOUND
);

693 
	`S‘La¡E¼Ü
(
ERROR_BAD_ARGUMENTS
);

696  
»suÉ
;

697 
	}
}

703 
	tcs_dœ’t_dummy
;

704 #ifdeà
MG_MODULE_LINES


714 #iâdeà
_WIN32


715 
	~<¡ddef.h
>

719 #ià!(
defšed
(
__ARMCC_VERSION
è|| defšed(
__ICCARM__
)) && \

720 !
defšed
(
__TI_COMPILER_VERSION__
) && \

721 (!
defšed
(
CS_PLATFORM
è|| 
	gCS_PLATFORM
 !ğ
CS_P_NXP_LPC
)

722 
	~<sys/time.h
>

725 
	~<wšdows.h
>

728 
	$cs_time
(è
WEAK
;

729 
	$cs_time
() {

730 
now
;

731 #iâdeà
_WIN32


732 
timev®
 
tv
;

733 ià(
	`g‘timeofday
(&
tv
, 
NULL
 ) != 0)  0;

734 
now
 = (è
tv
.
tv_£c
 + (((ètv.
tv_u£c
) / 1000000.0);

736 
SYSTEMTIME
 
sy¢ow
;

737 
FILETIME
 
áime
;

738 
	`G‘LoÿlTime
(&
sy¢ow
);

739 
	`Sy¡emTimeToFeTime
(&
sy¢ow
, &
áime
);

748 
now
 = (è(((
št64_t
è
áime
.
dwLowD©eTime
 +

749 ((
št64_t
è
áime
.
dwHighD©eTime
 << 32)) /

753  
now
;

754 
	}
}

755 #ifdeà
MG_MODULE_LINES


763 #iâdeà
CS_COMMON_CS_ENDIAN_H_


764 
	#CS_COMMON_CS_ENDIAN_H_


	)

771 #ià!
defšed
(
BYTE_ORDER
è&& defšed(
__BYTE_ORDER
)

772 
	#BYTE_ORDER
 
__BYTE_ORDER


	)

773 #iâdeà
LITTLE_ENDIAN


774 
	#LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

776 #iâdeà
BIG_ENDIAN


777 
	#BIG_ENDIAN
 
__LITTLE_ENDIAN


	)

782 #ifdeà
MG_MODULE_LINES


805 #ià!
defšed
(
EXCLUDE_COMMON
)

806 #ià!
DISABLE_MD5


810 
	$by‹Rev”£
(*
buf
, 
lÚgs
) {

812 #ià
BYTE_ORDER
 =ğ
BIG_ENDIAN


814 
ušt32_t
 
t
 = (ušt32_t)((è
buf
[3] << 8 | buf[2]) << 16 |

815 ((è
buf
[1] << 8 | buf[0]);

816 *(
ušt32_t
 *è
buf
 = 
t
;

817 
buf
 += 4;

818 } --
lÚgs
);

820 (è
buf
;

821 (è
lÚgs
;

823 
	}
}

825 
	#F1
(
x
, 
y
, 
z
è(z ^ (x & (y ^ z)))

	)

826 
	#F2
(
x
, 
y
, 
z
è
	`F1
(z, x, y)

	)

827 
	#F3
(
x
, 
y
, 
z
è(x ^ y ^ z)

	)

828 
	#F4
(
x
, 
y
, 
z
è(y ^ (x | ~z))

	)

830 
	#MD5STEP
(
f
, 
w
, 
x
, 
y
, 
z
, 
d©a
, 
s
) \

831 (
w
 +ğ
	`f
(
x
, 
y
, 
z
è+ 
d©a
, w = w << 
s
 | w >> (32 - s), w +ğx)

	)

837 
	$MD5_In™
(
MD5_CTX
 *
ùx
) {

838 
ùx
->
buf
[0] = 0x67452301;

839 
ùx
->
buf
[1] = 0xefcdab89;

840 
ùx
->
buf
[2] = 0x98badcfe;

841 
ùx
->
buf
[3] = 0x10325476;

843 
ùx
->
b™s
[0] = 0;

844 
ùx
->
b™s
[1] = 0;

845 
	}
}

847 
	$MD5T¿nsfÜm
(
ušt32_t
 
buf
[4], ušt32_ˆcÚ¡ 
š
[16]) {

848 
ušt32_t
 
a
, 
b
, 
c
, 
d
;

850 
a
 = 
buf
[0];

851 
b
 = 
buf
[1];

852 
c
 = 
buf
[2];

853 
d
 = 
buf
[3];

855 
	`MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
š
[0] + 0xd76aa478, 7);

856 
	`MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
š
[1] + 0xe8c7b756, 12);

857 
	`MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
š
[2] + 0x242070db, 17);

858 
	`MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
š
[3] + 0xc1bdceee, 22);

859 
	`MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
š
[4] + 0xf57c0faf, 7);

860 
	`MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
š
[5] + 0x4787c62a, 12);

861 
	`MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
š
[6] + 0xa8304613, 17);

862 
	`MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
š
[7] + 0xfd469501, 22);

863 
	`MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
š
[8] + 0x698098d8, 7);

864 
	`MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
š
[9] + 0x8b44f7af, 12);

865 
	`MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
š
[10] + 0xffff5bb1, 17);

866 
	`MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
š
[11] + 0x895cd7be, 22);

867 
	`MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
š
[12] + 0x6b901122, 7);

868 
	`MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
š
[13] + 0xfd987193, 12);

869 
	`MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
š
[14] + 0xa679438e, 17);

870 
	`MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
š
[15] + 0x49b40821, 22);

872 
	`MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
š
[1] + 0xf61e2562, 5);

873 
	`MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
š
[6] + 0xc040b340, 9);

874 
	`MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
š
[11] + 0x265e5a51, 14);

875 
	`MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
š
[0] + 0xe9b6c7aa, 20);

876 
	`MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
š
[5] + 0xd62f105d, 5);

877 
	`MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
š
[10] + 0x02441453, 9);

878 
	`MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
š
[15] + 0xd8a1e681, 14);

879 
	`MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
š
[4] + 0xe7d3fbc8, 20);

880 
	`MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
š
[9] + 0x21e1cde6, 5);

881 
	`MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
š
[14] + 0xc33707d6, 9);

882 
	`MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
š
[3] + 0xf4d50d87, 14);

883 
	`MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
š
[8] + 0x455a14ed, 20);

884 
	`MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
š
[13] + 0xa9e3e905, 5);

885 
	`MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
š
[2] + 0xfcefa3f8, 9);

886 
	`MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
š
[7] + 0x676f02d9, 14);

887 
	`MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
š
[12] + 0x8d2a4c8a, 20);

889 
	`MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
š
[5] + 0xfffa3942, 4);

890 
	`MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
š
[8] + 0x8771f681, 11);

891 
	`MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
š
[11] + 0x6d9d6122, 16);

892 
	`MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
š
[14] + 0xfde5380c, 23);

893 
	`MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
š
[1] + 0xa4beea44, 4);

894 
	`MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
š
[4] + 0x4bdecfa9, 11);

895 
	`MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
š
[7] + 0xf6bb4b60, 16);

896 
	`MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
š
[10] + 0xbebfbc70, 23);

897 
	`MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
š
[13] + 0x289b7ec6, 4);

898 
	`MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
š
[0] + 0xeaa127fa, 11);

899 
	`MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
š
[3] + 0xd4ef3085, 16);

900 
	`MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
š
[6] + 0x04881d05, 23);

901 
	`MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
š
[9] + 0xd9d4d039, 4);

902 
	`MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
š
[12] + 0xe6db99e5, 11);

903 
	`MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
š
[15] + 0x1fa27cf8, 16);

904 
	`MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
š
[2] + 0xc4ac5665, 23);

906 
	`MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
š
[0] + 0xf4292244, 6);

907 
	`MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
š
[7] + 0x432aff97, 10);

908 
	`MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
š
[14] + 0xab9423a7, 15);

909 
	`MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
š
[5] + 0xfc93a039, 21);

910 
	`MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
š
[12] + 0x655b59c3, 6);

911 
	`MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
š
[3] + 0x8f0ccc92, 10);

912 
	`MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
š
[10] + 0xffeff47d, 15);

913 
	`MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
š
[1] + 0x85845dd1, 21);

914 
	`MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
š
[8] + 0x6fa87e4f, 6);

915 
	`MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
š
[15] + 0xfe2ce6e0, 10);

916 
	`MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
š
[6] + 0xa3014314, 15);

917 
	`MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
š
[13] + 0x4e0811a1, 21);

918 
	`MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
š
[4] + 0xf7537e82, 6);

919 
	`MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
š
[11] + 0xbd3af235, 10);

920 
	`MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
š
[2] + 0x2ad7d2bb, 15);

921 
	`MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
š
[9] + 0xeb86d391, 21);

923 
buf
[0] +ğ
a
;

924 
buf
[1] +ğ
b
;

925 
buf
[2] +ğ
c
;

926 
buf
[3] +ğ
d
;

927 
	}
}

929 
	$MD5_Upd©e
(
MD5_CTX
 *
ùx
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

930 
ušt32_t
 
t
;

932 
t
 = 
ùx
->
b™s
[0];

933 ià((
ùx
->
b™s
[0] = 
t
 + ((
ušt32_t
è
Ën
 << 3)) <) ctx->bits[1]++;

934 
ùx
->
b™s
[1] +ğ(
ušt32_t
è
Ën
 >> 29;

936 
t
 = (t >> 3) & 0x3f;

938 ià(
t
) {

939 *
p
 = (*è
ùx
->
š
 + 
t
;

941 
t
 = 64 -;

942 ià(
Ën
 < 
t
) {

943 
	`memıy
(
p
, 
buf
, 
Ën
);

946 
	`memıy
(
p
, 
buf
, 
t
);

947 
	`by‹Rev”£
(
ùx
->
š
, 16);

948 
	`MD5T¿nsfÜm
(
ùx
->
buf
, (
ušt32_t
 *èùx->
š
);

949 
buf
 +ğ
t
;

950 
Ën
 -ğ
t
;

953 
Ën
 >= 64) {

954 
	`memıy
(
ùx
->
š
, 
buf
, 64);

955 
	`by‹Rev”£
(
ùx
->
š
, 16);

956 
	`MD5T¿nsfÜm
(
ùx
->
buf
, (
ušt32_t
 *èùx->
š
);

957 
buf
 += 64;

958 
Ën
 -= 64;

961 
	`memıy
(
ùx
->
š
, 
buf
, 
Ën
);

962 
	}
}

964 
	$MD5_Fš®
(
dige¡
[16], 
MD5_CTX
 *
ùx
) {

965 
couÁ
;

966 *
p
;

967 
ušt32_t
 *
a
;

969 
couÁ
 = (
ùx
->
b™s
[0] >> 3) & 0x3F;

971 
p
 = 
ùx
->
š
 + 
couÁ
;

972 *
p
++ = 0x80;

973 
couÁ
 = 64 - 1 - count;

974 ià(
couÁ
 < 8) {

975 
	`mem£t
(
p
, 0, 
couÁ
);

976 
	`by‹Rev”£
(
ùx
->
š
, 16);

977 
	`MD5T¿nsfÜm
(
ùx
->
buf
, (
ušt32_t
 *èùx->
š
);

978 
	`mem£t
(
ùx
->
š
, 0, 56);

980 
	`mem£t
(
p
, 0, 
couÁ
 - 8);

982 
	`by‹Rev”£
(
ùx
->
š
, 14);

984 
a
 = (
ušt32_t
 *è
ùx
->
š
;

985 
a
[14] = 
ùx
->
b™s
[0];

986 
a
[15] = 
ùx
->
b™s
[1];

988 
	`MD5T¿nsfÜm
(
ùx
->
buf
, (
ušt32_t
 *èùx->
š
);

989 
	`by‹Rev”£
((*è
ùx
->
buf
, 4);

990 
	`memıy
(
dige¡
, 
ùx
->
buf
, 16);

991 
	`mem£t
((*è
ùx
, 0, (*ctx));

992 
	}
}

995 *
	$cs_md5
(
buf
[33], ...) {

996 
hash
[16];

997 cÚ¡ *
p
;

998 
va_li¡
 
­
;

999 
MD5_CTX
 
ùx
;

1001 
	`MD5_In™
(&
ùx
);

1003 
	`va_¡¬t
(
­
, 
buf
);

1004 (
p
 = 
	`va_¬g
(
­
, cÚ¡ *èè!ğ
NULL
) {

1005 
size_t
 
Ën
 = 
	`va_¬g
(
­
, size_t);

1006 
	`MD5_Upd©e
(&
ùx
, 
p
, 
Ën
);

1008 
	`va_’d
(
­
);

1010 
	`MD5_Fš®
(
hash
, &
ùx
);

1011 
	`cs_to_hex
(
buf
, 
hash
, (hash));

1013  
buf
;

1014 
	}
}

1017 #ifdeà
MG_MODULE_LINES


1025 #iâdeà
EXCLUDE_COMMON


1027 
	~<as£¹.h
>

1028 
	~<¡ršg.h
>

1031 #iâdeà
MBUF_REALLOC


1032 
	#MBUF_REALLOC
 
»®loc


	)

1035 #iâdeà
MBUF_FREE


1036 
	#MBUF_FREE
 
ä“


	)

1039 
	$mbuf_š™
(
mbuf
 *mbuf, 
size_t
 
š™Ÿl_size
è
WEAK
;

1040 
	$mbuf_š™
(
mbuf
 *mbuf, 
size_t
 
š™Ÿl_size
) {

1041 
mbuf
->
Ën
 = mbuf->
size
 = 0;

1042 
mbuf
->
buf
 = 
NULL
;

1043 
	`mbuf_»size
(
mbuf
, 
š™Ÿl_size
);

1044 
	}
}

1046 
	$mbuf_ä“
(
mbuf
 *mbufè
WEAK
;

1047 
	$mbuf_ä“
(
mbuf
 *mbuf) {

1048 ià(
mbuf
->
buf
 !ğ
NULL
) {

1049 
	`MBUF_FREE
(
mbuf
->
buf
);

1050 
	`mbuf_š™
(
mbuf
, 0);

1052 
	}
}

1054 
	$mbuf_»size
(
mbuf
 *
a
, 
size_t
 
Ãw_size
è
WEAK
;

1055 
	$mbuf_»size
(
mbuf
 *
a
, 
size_t
 
Ãw_size
) {

1056 ià(
Ãw_size
 > 
a
->
size
 || (Ãw_siz<‡->siz&&‚ew_siz>ğa->
Ën
)) {

1057 *
buf
 = (*è
	`MBUF_REALLOC
(
a
->buf, 
Ãw_size
);

1063 ià(
buf
 =ğ
NULL
 && 
Ãw_size
 != 0) ;

1064 
a
->
buf
 = buf;

1065 
a
->
size
 = 
Ãw_size
;

1067 
	}
}

1069 
	$mbuf_Œim
(
mbuf
 *mbufè
WEAK
;

1070 
	$mbuf_Œim
(
mbuf
 *mbuf) {

1071 
	`mbuf_»size
(
mbuf
, mbuf->
Ën
);

1072 
	}
}

1074 
size_t
 
	$mbuf_š£¹
(
mbuf
 *
a
, 
size_t
 
off
, cÚ¡ *
buf
, size_tè
WEAK
;

1075 
size_t
 
	$mbuf_š£¹
(
mbuf
 *
a
, 
size_t
 
off
, cÚ¡ *
buf
, size_ˆ
Ën
) {

1076 *
p
 = 
NULL
;

1078 
	`as£¹
(
a
 !ğ
NULL
);

1079 
	`as£¹
(
a
->
Ën
 <ğa->
size
);

1080 
	`as£¹
(
off
 <ğ
a
->
Ën
);

1083 ià(~(
size_t
è0 - (size_tè
a
->
buf
 < 
Ën
)  0;

1085 ià(
a
->
Ën
 +†’ <ğa->
size
) {

1086 
	`memmove
(
a
->
buf
 + 
off
 + 
Ën
,‡->buf + off,‡->len - off);

1087 ià(
buf
 !ğ
NULL
) {

1088 
	`memıy
(
a
->
buf
 + 
off
, buf, 
Ën
);

1090 
a
->
Ën
 +=†en;

1092 
size_t
 
Ãw_size
 = (size_t)((
a
->
Ën
 +†’è* 
MBUF_SIZE_MULTIPLIER
);

1093 ià((
p
 = (*è
	`MBUF_REALLOC
(
a
->
buf
, 
Ãw_size
)è!ğ
NULL
) {

1094 
a
->
buf
 = 
p
;

1095 
	`memmove
(
a
->
buf
 + 
off
 + 
Ën
,‡->buf + off,‡->len - off);

1096 ià(
buf
 !ğ
NULL
è
	`memıy
(
a
->buà+ 
off
, buf, 
Ën
);

1097 
a
->
Ën
 +=†en;

1098 
a
->
size
 = 
Ãw_size
;

1100 
Ën
 = 0;

1104  
Ën
;

1105 
	}
}

1107 
size_t
 
	$mbuf_­³nd
(
mbuf
 *
a
, cÚ¡ *
buf
, 
size_t
 
Ën
è
WEAK
;

1108 
size_t
 
	$mbuf_­³nd
(
mbuf
 *
a
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

1109  
	`mbuf_š£¹
(
a
,‡->
Ën
, 
buf
,†en);

1110 
	}
}

1112 
	$mbuf_»move
(
mbuf
 *
mb
, 
size_t
 
n
è
WEAK
;

1113 
	$mbuf_»move
(
mbuf
 *
mb
, 
size_t
 
n
) {

1114 ià(
n
 > 0 &&‚ <ğ
mb
->
Ën
) {

1115 
	`memmove
(
mb
->
buf
, mb->buà+ 
n
, mb->
Ën
 -‚);

1116 
mb
->
Ën
 -ğ
n
;

1118 
	}
}

1121 #ifdeà
MG_MODULE_LINES


1131 
	~<¡dlib.h
>

1132 
	~<¡ršg.h
>

1134 
	$mg_nÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
, 
size_t
 
Ën
è
WEAK
;

1136 
mg_¡r
 
	$mg_mk_¡r
(cÚ¡ *
s
è
WEAK
;

1137 
mg_¡r
 
	$mg_mk_¡r
(cÚ¡ *
s
) {

1138 
mg_¡r
 
»t
 = {
s
, 0};

1139 ià(
s
 !ğ
NULL
è
»t
.
Ën
 = 
	`¡¾’
(s);

1140  
»t
;

1141 
	}
}

1143 
mg_¡r
 
	$mg_mk_¡r_n
(cÚ¡ *
s
, 
size_t
 
Ën
è
WEAK
;

1144 
mg_¡r
 
	$mg_mk_¡r_n
(cÚ¡ *
s
, 
size_t
 
Ën
) {

1145 
mg_¡r
 
»t
 = {
s
, 
Ën
};

1146  
»t
;

1147 
	}
}

1149 
	$mg_vcmp
(cÚ¡ 
mg_¡r
 *
¡r1
, cÚ¡ *
¡r2
è
WEAK
;

1150 
	$mg_vcmp
(cÚ¡ 
mg_¡r
 *
¡r1
, cÚ¡ *
¡r2
) {

1151 
size_t
 
n2
 = 
	`¡¾’
(
¡r2
), 
n1
 = 
¡r1
->
Ën
;

1152 
r
 = 
	`memcmp
(
¡r1
->
p
, 
¡r2
, (
n1
 < 
n2
) ?‚1 :‚2);

1153 ià(
r
 == 0) {

1154  
n1
 - 
n2
;

1156  
r
;

1157 
	}
}

1159 
	$mg_vÿ£cmp
(cÚ¡ 
mg_¡r
 *
¡r1
, cÚ¡ *
¡r2
è
WEAK
;

1160 
	$mg_vÿ£cmp
(cÚ¡ 
mg_¡r
 *
¡r1
, cÚ¡ *
¡r2
) {

1161 
size_t
 
n2
 = 
	`¡¾’
(
¡r2
), 
n1
 = 
¡r1
->
Ën
;

1162 
r
 = 
	`mg_nÿ£cmp
(
¡r1
->
p
, 
¡r2
, (
n1
 < 
n2
) ?‚1 :‚2);

1163 ià(
r
 == 0) {

1164  
n1
 - 
n2
;

1166  
r
;

1167 
	}
}

1169 
mg_¡r
 
	$mg_¡rdup
(cÚ¡ 
mg_¡r
 
s
è
WEAK
;

1170 
mg_¡r
 
	$mg_¡rdup
(cÚ¡ 
mg_¡r
 
s
) {

1171 
mg_¡r
 
r
 = {
NULL
, 0};

1172 ià(
s
.
Ën
 > 0 && s.
p
 !ğ
NULL
) {

1173 
r
.
p
 = (*è
	`m®loc
(
s
.
Ën
);

1174 ià(
r
.
p
 !ğ
NULL
) {

1175 
	`memıy
((*è
r
.
p
, 
s
.p, s.
Ën
);

1176 
r
.
Ën
 = 
s
.len;

1179  
r
;

1180 
	}
}

1182 
	$mg_¡rcmp
(cÚ¡ 
mg_¡r
 
¡r1
, cÚ¡ mg_¡¸
¡r2
è
WEAK
;

1183 
	$mg_¡rcmp
(cÚ¡ 
mg_¡r
 
¡r1
, cÚ¡ mg_¡¸
¡r2
) {

1184 
size_t
 
i
 = 0;

1185 
i
 < 
¡r1
.
Ën
 && i < 
¡r2
.len) {

1186 ià(
¡r1
.
p
[
i
] < 
¡r2
.p[i])  -1;

1187 ià(
¡r1
.
p
[
i
] > 
¡r2
.p[i])  1;

1188 
i
++;

1190 ià(
i
 < 
¡r1
.
Ën
)  1;

1191 ià(
i
 < 
¡r2
.
Ën
)  -1;

1193 
	}
}

1195 
	$mg_¡ºcmp
(cÚ¡ 
mg_¡r
, cÚ¡ mg_¡r, 
size_t
 
n
è
WEAK
;

1196 
	$mg_¡ºcmp
(cÚ¡ 
mg_¡r
 
¡r1
, cÚ¡ mg_¡¸
¡r2
, 
size_t
 
n
) {

1197 
mg_¡r
 
s1
 = 
¡r1
;

1198 
mg_¡r
 
s2
 = 
¡r2
;

1200 ià(
s1
.
Ën
 > 
n
) {

1201 
s1
.
Ën
 = 
n
;

1203 ià(
s2
.
Ën
 > 
n
) {

1204 
s2
.
Ën
 = 
n
;

1206  
	`mg_¡rcmp
(
s1
, 
s2
);

1207 
	}
}

1208 #ifdeà
MG_MODULE_LINES


1216 #ià!
DISABLE_SHA1
 && !
defšed
(
EXCLUDE_COMMON
)

1220 
	#SHA1HANDSOFF


	)

1221 #ià
defšed
(
__sun
)

1225 
	uch¬64lÚg16
 {

1226 
	mc
[64];

1227 
ušt32_t
 
	ml
[16];

1230 
	#rŞ
(
v®ue
, 
b™s
è(((v®ueè<< (b™s)è| ((v®ueè>> (32 - (b™s))))

	)

1232 
ušt32_t
 
	$blk0
(
ch¬64lÚg16
 *
block
, 
i
) {

1234 #ià
BYTE_ORDER
 =ğ
LITTLE_ENDIAN


1235 
block
->
l
[
i
] =

1236 (
	`rŞ
(
block
->
l
[
i
], 24) & 0xFF00FF00) | (rol(block->l[i], 8) & 0x00FF00FF);

1238  
block
->
l
[
i
];

1239 
	}
}

1242 #undeà
blk


1243 #undeà
R0


1244 #undeà
R1


1245 #undeà
R2


1246 #undeà
R3


1247 #undeà
R4


1249 
	#blk
(
i
) \

1250 (
block
->
l
[
i
 & 15] = 
	`rŞ
(block->l[(i + 13) & 15] ^ block->l[(i + 8) & 15] ^ \

1251 
block
->
l
[(
i
 + 2) & 15] ^ block->l[i & 15], \

1252 1))

	)

1253 
	#R0
(
v
, 
w
, 
x
, 
y
, 
z
, 
i
) \

1254 
z
 +ğ((
w
 & (
x
 ^ 
y
)è^ yè+ 
	`blk0
(
block
, 
i
è+ 0x5A827999 + 
	`rŞ
(
v
, 5); \

1255 
w
 = 
	`rŞ
(w, 30);

	)

1256 
	#R1
(
v
, 
w
, 
x
, 
y
, 
z
, 
i
) \

1257 
z
 +ğ((
w
 & (
x
 ^ 
y
)è^ yè+ 
	`blk
(
i
è+ 0x5A827999 + 
	`rŞ
(
v
, 5); \

1258 
w
 = 
	`rŞ
(w, 30);

	)

1259 
	#R2
(
v
, 
w
, 
x
, 
y
, 
z
, 
i
) \

1260 
z
 +ğ(
w
 ^ 
x
 ^ 
y
è+ 
	`blk
(
i
è+ 0x6ED9EBA1 + 
	`rŞ
(
v
, 5); \

1261 
w
 = 
	`rŞ
(w, 30);

	)

1262 
	#R3
(
v
, 
w
, 
x
, 
y
, 
z
, 
i
) \

1263 
z
 +ğ(((
w
 | 
x
è& 
y
è| (w & x)è+ 
	`blk
(
i
è+ 0x8F1BBCDC + 
	`rŞ
(
v
, 5); \

1264 
w
 = 
	`rŞ
(w, 30);

	)

1265 
	#R4
(
v
, 
w
, 
x
, 
y
, 
z
, 
i
) \

1266 
z
 +ğ(
w
 ^ 
x
 ^ 
y
è+ 
	`blk
(
i
è+ 0xCA62C1D6 + 
	`rŞ
(
v
, 5); \

1267 
w
 = 
	`rŞ
(w, 30);

	)

1269 
	$cs_sha1_ŒªsfÜm
(
ušt32_t
 
¡©e
[5], cÚ¡ 
bufãr
[64]) {

1270 
ušt32_t
 
a
, 
b
, 
c
, 
d
, 
e
;

1271 
ch¬64lÚg16
 
block
[1];

1273 
	`memıy
(
block
, 
bufãr
, 64);

1274 
a
 = 
¡©e
[0];

1275 
b
 = 
¡©e
[1];

1276 
c
 = 
¡©e
[2];

1277 
d
 = 
¡©e
[3];

1278 
e
 = 
¡©e
[4];

1279 
	`R0
(
a
, 
b
, 
c
, 
d
, 
e
, 0);

1280 
	`R0
(
e
, 
a
, 
b
, 
c
, 
d
, 1);

1281 
	`R0
(
d
, 
e
, 
a
, 
b
, 
c
, 2);

1282 
	`R0
(
c
, 
d
, 
e
, 
a
, 
b
, 3);

1283 
	`R0
(
b
, 
c
, 
d
, 
e
, 
a
, 4);

1284 
	`R0
(
a
, 
b
, 
c
, 
d
, 
e
, 5);

1285 
	`R0
(
e
, 
a
, 
b
, 
c
, 
d
, 6);

1286 
	`R0
(
d
, 
e
, 
a
, 
b
, 
c
, 7);

1287 
	`R0
(
c
, 
d
, 
e
, 
a
, 
b
, 8);

1288 
	`R0
(
b
, 
c
, 
d
, 
e
, 
a
, 9);

1289 
	`R0
(
a
, 
b
, 
c
, 
d
, 
e
, 10);

1290 
	`R0
(
e
, 
a
, 
b
, 
c
, 
d
, 11);

1291 
	`R0
(
d
, 
e
, 
a
, 
b
, 
c
, 12);

1292 
	`R0
(
c
, 
d
, 
e
, 
a
, 
b
, 13);

1293 
	`R0
(
b
, 
c
, 
d
, 
e
, 
a
, 14);

1294 
	`R0
(
a
, 
b
, 
c
, 
d
, 
e
, 15);

1295 
	`R1
(
e
, 
a
, 
b
, 
c
, 
d
, 16);

1296 
	`R1
(
d
, 
e
, 
a
, 
b
, 
c
, 17);

1297 
	`R1
(
c
, 
d
, 
e
, 
a
, 
b
, 18);

1298 
	`R1
(
b
, 
c
, 
d
, 
e
, 
a
, 19);

1299 
	`R2
(
a
, 
b
, 
c
, 
d
, 
e
, 20);

1300 
	`R2
(
e
, 
a
, 
b
, 
c
, 
d
, 21);

1301 
	`R2
(
d
, 
e
, 
a
, 
b
, 
c
, 22);

1302 
	`R2
(
c
, 
d
, 
e
, 
a
, 
b
, 23);

1303 
	`R2
(
b
, 
c
, 
d
, 
e
, 
a
, 24);

1304 
	`R2
(
a
, 
b
, 
c
, 
d
, 
e
, 25);

1305 
	`R2
(
e
, 
a
, 
b
, 
c
, 
d
, 26);

1306 
	`R2
(
d
, 
e
, 
a
, 
b
, 
c
, 27);

1307 
	`R2
(
c
, 
d
, 
e
, 
a
, 
b
, 28);

1308 
	`R2
(
b
, 
c
, 
d
, 
e
, 
a
, 29);

1309 
	`R2
(
a
, 
b
, 
c
, 
d
, 
e
, 30);

1310 
	`R2
(
e
, 
a
, 
b
, 
c
, 
d
, 31);

1311 
	`R2
(
d
, 
e
, 
a
, 
b
, 
c
, 32);

1312 
	`R2
(
c
, 
d
, 
e
, 
a
, 
b
, 33);

1313 
	`R2
(
b
, 
c
, 
d
, 
e
, 
a
, 34);

1314 
	`R2
(
a
, 
b
, 
c
, 
d
, 
e
, 35);

1315 
	`R2
(
e
, 
a
, 
b
, 
c
, 
d
, 36);

1316 
	`R2
(
d
, 
e
, 
a
, 
b
, 
c
, 37);

1317 
	`R2
(
c
, 
d
, 
e
, 
a
, 
b
, 38);

1318 
	`R2
(
b
, 
c
, 
d
, 
e
, 
a
, 39);

1319 
	`R3
(
a
, 
b
, 
c
, 
d
, 
e
, 40);

1320 
	`R3
(
e
, 
a
, 
b
, 
c
, 
d
, 41);

1321 
	`R3
(
d
, 
e
, 
a
, 
b
, 
c
, 42);

1322 
	`R3
(
c
, 
d
, 
e
, 
a
, 
b
, 43);

1323 
	`R3
(
b
, 
c
, 
d
, 
e
, 
a
, 44);

1324 
	`R3
(
a
, 
b
, 
c
, 
d
, 
e
, 45);

1325 
	`R3
(
e
, 
a
, 
b
, 
c
, 
d
, 46);

1326 
	`R3
(
d
, 
e
, 
a
, 
b
, 
c
, 47);

1327 
	`R3
(
c
, 
d
, 
e
, 
a
, 
b
, 48);

1328 
	`R3
(
b
, 
c
, 
d
, 
e
, 
a
, 49);

1329 
	`R3
(
a
, 
b
, 
c
, 
d
, 
e
, 50);

1330 
	`R3
(
e
, 
a
, 
b
, 
c
, 
d
, 51);

1331 
	`R3
(
d
, 
e
, 
a
, 
b
, 
c
, 52);

1332 
	`R3
(
c
, 
d
, 
e
, 
a
, 
b
, 53);

1333 
	`R3
(
b
, 
c
, 
d
, 
e
, 
a
, 54);

1334 
	`R3
(
a
, 
b
, 
c
, 
d
, 
e
, 55);

1335 
	`R3
(
e
, 
a
, 
b
, 
c
, 
d
, 56);

1336 
	`R3
(
d
, 
e
, 
a
, 
b
, 
c
, 57);

1337 
	`R3
(
c
, 
d
, 
e
, 
a
, 
b
, 58);

1338 
	`R3
(
b
, 
c
, 
d
, 
e
, 
a
, 59);

1339 
	`R4
(
a
, 
b
, 
c
, 
d
, 
e
, 60);

1340 
	`R4
(
e
, 
a
, 
b
, 
c
, 
d
, 61);

1341 
	`R4
(
d
, 
e
, 
a
, 
b
, 
c
, 62);

1342 
	`R4
(
c
, 
d
, 
e
, 
a
, 
b
, 63);

1343 
	`R4
(
b
, 
c
, 
d
, 
e
, 
a
, 64);

1344 
	`R4
(
a
, 
b
, 
c
, 
d
, 
e
, 65);

1345 
	`R4
(
e
, 
a
, 
b
, 
c
, 
d
, 66);

1346 
	`R4
(
d
, 
e
, 
a
, 
b
, 
c
, 67);

1347 
	`R4
(
c
, 
d
, 
e
, 
a
, 
b
, 68);

1348 
	`R4
(
b
, 
c
, 
d
, 
e
, 
a
, 69);

1349 
	`R4
(
a
, 
b
, 
c
, 
d
, 
e
, 70);

1350 
	`R4
(
e
, 
a
, 
b
, 
c
, 
d
, 71);

1351 
	`R4
(
d
, 
e
, 
a
, 
b
, 
c
, 72);

1352 
	`R4
(
c
, 
d
, 
e
, 
a
, 
b
, 73);

1353 
	`R4
(
b
, 
c
, 
d
, 
e
, 
a
, 74);

1354 
	`R4
(
a
, 
b
, 
c
, 
d
, 
e
, 75);

1355 
	`R4
(
e
, 
a
, 
b
, 
c
, 
d
, 76);

1356 
	`R4
(
d
, 
e
, 
a
, 
b
, 
c
, 77);

1357 
	`R4
(
c
, 
d
, 
e
, 
a
, 
b
, 78);

1358 
	`R4
(
b
, 
c
, 
d
, 
e
, 
a
, 79);

1359 
¡©e
[0] +ğ
a
;

1360 
¡©e
[1] +ğ
b
;

1361 
¡©e
[2] +ğ
c
;

1362 
¡©e
[3] +ğ
d
;

1363 
¡©e
[4] +ğ
e
;

1366 
	`mem£t
(
block
, 0, (block));

1367 
a
 = 
b
 = 
c
 = 
d
 = 
e
 = 0;

1368 (è
a
;

1369 (è
b
;

1370 (è
c
;

1371 (è
d
;

1372 (è
e
;

1373 
	}
}

1375 
	$cs_sha1_š™
(
cs_sha1_ùx
 *
cÚ‹xt
) {

1376 
cÚ‹xt
->
¡©e
[0] = 0x67452301;

1377 
cÚ‹xt
->
¡©e
[1] = 0xEFCDAB89;

1378 
cÚ‹xt
->
¡©e
[2] = 0x98BADCFE;

1379 
cÚ‹xt
->
¡©e
[3] = 0x10325476;

1380 
cÚ‹xt
->
¡©e
[4] = 0xC3D2E1F0;

1381 
cÚ‹xt
->
couÁ
[0] = context->count[1] = 0;

1382 
	}
}

1384 
	$cs_sha1_upd©e
(
cs_sha1_ùx
 *
cÚ‹xt
, cÚ¡ *
d©a
,

1385 
ušt32_t
 
Ën
) {

1386 
ušt32_t
 
i
, 
j
;

1388 
j
 = 
cÚ‹xt
->
couÁ
[0];

1389 ià((
cÚ‹xt
->
couÁ
[0] +ğ
Ën
 << 3è< 
j
) context->count[1]++;

1390 
cÚ‹xt
->
couÁ
[1] +ğ(
Ën
 >> 29);

1391 
j
 = (j >> 3) & 63;

1392 ià((
j
 + 
Ën
) > 63) {

1393 
	`memıy
(&
cÚ‹xt
->
bufãr
[
j
], 
d©a
, (
i
 = 64 - j));

1394 
	`cs_sha1_ŒªsfÜm
(
cÚ‹xt
->
¡©e
, cÚ‹xt->
bufãr
);

1395 ; 
i
 + 63 < 
Ën
; i += 64) {

1396 
	`cs_sha1_ŒªsfÜm
(
cÚ‹xt
->
¡©e
, &
d©a
[
i
]);

1398 
j
 = 0;

1400 
i
 = 0;

1401 
	`memıy
(&
cÚ‹xt
->
bufãr
[
j
], &
d©a
[
i
], 
Ën
 - i);

1402 
	}
}

1404 
	$cs_sha1_fš®
(
dige¡
[20], 
cs_sha1_ùx
 *
cÚ‹xt
) {

1405 
i
;

1406 
fš®couÁ
[8], 
c
;

1408 
i
 = 0; i < 8; i++) {

1409 
fš®couÁ
[
i
] = (è((
cÚ‹xt
->
couÁ
[(i >= 4 ? 0 : 1)] >>

1410 ((3 - (
i
 & 3)) * 8)) &

1413 
c
 = 0200;

1414 
	`cs_sha1_upd©e
(
cÚ‹xt
, &
c
, 1);

1415 (
cÚ‹xt
->
couÁ
[0] & 504) != 448) {

1416 
c
 = 0000;

1417 
	`cs_sha1_upd©e
(
cÚ‹xt
, &
c
, 1);

1419 
	`cs_sha1_upd©e
(
cÚ‹xt
, 
fš®couÁ
, 8);

1420 
i
 = 0; i < 20; i++) {

1421 
dige¡
[
i
] =

1422 (è((
cÚ‹xt
->
¡©e
[
i
 >> 2] >> ((3 - (i & 3)) * 8)) & 255);

1424 
	`mem£t
(
cÚ‹xt
, '\0', (*context));

1425 
	`mem£t
(&
fš®couÁ
, '\0', (finalcount));

1426 
	}
}

1428 
	$cs_hmac_sha1
(cÚ¡ *
key
, 
size_t
 
keyËn
,

1429 cÚ¡ *
d©a
, 
size_t
 
d©®’
,

1430 
out
[20]) {

1431 
cs_sha1_ùx
 
ùx
;

1432 
buf1
[64], 
buf2
[64], 
tmp_key
[20], 
i
;

1434 ià(
keyËn
 > (
buf1
)) {

1435 
	`cs_sha1_š™
(&
ùx
);

1436 
	`cs_sha1_upd©e
(&
ùx
, 
key
, 
keyËn
);

1437 
	`cs_sha1_fš®
(
tmp_key
, &
ùx
);

1438 
key
 = 
tmp_key
;

1439 
keyËn
 = (
tmp_key
);

1442 
	`mem£t
(
buf1
, 0, (buf1));

1443 
	`mem£t
(
buf2
, 0, (buf2));

1444 
	`memıy
(
buf1
, 
key
, 
keyËn
);

1445 
	`memıy
(
buf2
, 
key
, 
keyËn
);

1447 
i
 = 0; i < (
buf1
); i++) {

1448 
buf1
[
i
] ^= 0x36;

1449 
buf2
[
i
] ^= 0x5c;

1452 
	`cs_sha1_š™
(&
ùx
);

1453 
	`cs_sha1_upd©e
(&
ùx
, 
buf1
, (buf1));

1454 
	`cs_sha1_upd©e
(&
ùx
, 
d©a
, 
d©®’
);

1455 
	`cs_sha1_fš®
(
out
, &
ùx
);

1457 
	`cs_sha1_š™
(&
ùx
);

1458 
	`cs_sha1_upd©e
(&
ùx
, 
buf2
, (buf2));

1459 
	`cs_sha1_upd©e
(&
ùx
, 
out
, 20);

1460 
	`cs_sha1_fš®
(
out
, &
ùx
);

1461 
	}
}

1464 #ifdeà
MG_MODULE_LINES


1472 #iâdeà
EXCLUDE_COMMON


1477 #iâdeà
C_DISABLE_BUILTIN_SNPRINTF


1478 
	#C_DISABLE_BUILTIN_SNPRINTF
 0

	)

1481 #iâdeà
MG_MALLOC


1482 
	#MG_MALLOC
 
m®loc


	)

1485 #iâdeà
MG_FREE


1486 
	#MG_FREE
 
ä“


	)

1489 
size_t
 
	$c_¡ºËn
(cÚ¡ *
s
, 
size_t
 
maxËn
è
WEAK
;

1490 
size_t
 
	$c_¡ºËn
(cÚ¡ *
s
, 
size_t
 
maxËn
) {

1491 
size_t
 
l
 = 0;

1492 ; 
l
 < 
maxËn
 && 
s
[l] != '\0';†++) {

1494  
l
;

1495 
	}
}

1497 
	#C_SNPRINTF_APPEND_CHAR
(
ch
) \

1499 ià(
i
 < (è
buf_size
è
buf
[i] = 
ch
; \

1500 
i
++; \

1501 } 0)

	)

1503 
	#C_SNPRINTF_FLAG_ZERO
 1

	)

1505 #ià
C_DISABLE_BUILTIN_SNPRINTF


1506 
	$c_v¢´štf
(*
buf
, 
size_t
 
buf_size
, cÚ¡ *
fmt
, 
va_li¡
 
­
è
WEAK
;

1507 
	$c_v¢´štf
(*
buf
, 
size_t
 
buf_size
, cÚ¡ *
fmt
, 
va_li¡
 
­
) {

1508  
	`v¢´štf
(
buf
, 
buf_size
, 
fmt
, 
­
);

1509 
	}
}

1511 
	$c_™ß
(*
buf
, 
size_t
 
buf_size
, 
št64_t
 
num
, 
ba£
, 
æags
,

1512 
f›ld_width
) {

1513 
tmp
[40];

1514 
i
 = 0, 
k
 = 0, 
Ãg
 = 0;

1516 ià(
num
 < 0) {

1517 
Ãg
++;

1518 
num
 = -num;

1523 
»m
 = 
num
 % 
ba£
;

1524 ià(
»m
 < 10) {

1525 
tmp
[
k
++] = '0' + 
»m
;

1527 
tmp
[
k
++] = 'a' + (
»m
 - 10);

1529 
num
 /ğ
ba£
;

1530 } 
num
 > 0);

1533 ià(
æags
 && 
C_SNPRINTF_FLAG_ZERO
) {

1534 
k
 < 
f›ld_width
 && k < (è(
tmp
) - 1) {

1535 
tmp
[
k
++] = '0';

1540 ià(
Ãg
) {

1541 
tmp
[
k
++] = '-';

1545 --
k
 >= 0) {

1546 
	`C_SNPRINTF_APPEND_CHAR
(
tmp
[
k
]);

1549  
i
;

1550 
	}
}

1552 
	$c_v¢´štf
(*
buf
, 
size_t
 
buf_size
, cÚ¡ *
fmt
, 
va_li¡
 
­
è
WEAK
;

1553 
	$c_v¢´štf
(*
buf
, 
size_t
 
buf_size
, cÚ¡ *
fmt
, 
va_li¡
 
­
) {

1554 
ch
, 
i
 = 0, 
Ën_mod
, 
æags
, 
´ecisiÚ
, 
f›ld_width
;

1556 (
ch
 = *
fmt
++) != '\0') {

1557 ià(
ch
 != '%') {

1558 
	`C_SNPRINTF_APPEND_CHAR
(
ch
);

1568 
æags
 = 
f›ld_width
 = 
´ecisiÚ
 = 
Ën_mod
 = 0;

1571 ià(*
fmt
 == '0') {

1572 
æags
 |ğ
C_SNPRINTF_FLAG_ZERO
;

1576 *
fmt
 >= '0' && *fmt <= '9') {

1577 
f›ld_width
 *= 10;

1578 
f›ld_width
 +ğ*
fmt
++ - '0';

1581 ià(*
fmt
 == '*') {

1582 
f›ld_width
 = 
	`va_¬g
(
­
, );

1583 
fmt
++;

1587 ià(*
fmt
 == '.') {

1588 
fmt
++;

1589 ià(*
fmt
 == '*') {

1590 
´ecisiÚ
 = 
	`va_¬g
(
­
, );

1591 
fmt
++;

1593 *
fmt
 >= '0' && *fmt <= '9') {

1594 
´ecisiÚ
 *= 10;

1595 
´ecisiÚ
 +ğ*
fmt
++ - '0';

1601 *
fmt
) {

1610 
Ën_mod
 = *
fmt
++;

1611 ià(*
fmt
 == 'h') {

1612 
Ën_mod
 = 'H';

1613 
fmt
++;

1615 ià(*
fmt
 == 'l') {

1616 
Ën_mod
 = 'q';

1617 
fmt
++;

1622 
ch
 = *
fmt
++;

1623 ià(
ch
 == 's') {

1624 cÚ¡ *
s
 = 
	`va_¬g
(
­
, const *);

1625 
j
;

1626 
·d
 = 
f›ld_width
 - (
´ecisiÚ
 >ğ0 ? 
	`c_¡ºËn
(
s
,…recision) : 0);

1627 
j
 = 0; j < 
·d
; j++) {

1628 
	`C_SNPRINTF_APPEND_CHAR
(' ');

1632 ià(
s
 !ğ
NULL
) {

1634 
j
 = 0; (
´ecisiÚ
 <ğ0 || j <…»cisiÚè&& 
s
[j] != '\0'; j++) {

1635 
	`C_SNPRINTF_APPEND_CHAR
(
s
[
j
]);

1638 } ià(
ch
 == 'c') {

1639 
ch
 = 
	`va_¬g
(
­
, );

1640 
	`C_SNPRINTF_APPEND_CHAR
(
ch
);

1641 } ià(
ch
 =ğ'd' && 
Ën_mod
 == 0) {

1642 
i
 +ğ
	`c_™ß
(
buf
 + i, 
buf_size
 - i, 
	`va_¬g
(
­
, ), 10, 
æags
,

1643 
f›ld_width
);

1644 } ià(
ch
 =ğ'd' && 
Ën_mod
 == 'l') {

1645 
i
 +ğ
	`c_™ß
(
buf
 + i, 
buf_size
 - i, 
	`va_¬g
(
­
, ), 10, 
æags
,

1646 
f›ld_width
);

1647 #ifdeà
SSIZE_MAX


1648 } ià(
ch
 =ğ'd' && 
Ën_mod
 == 'z') {

1649 
i
 +ğ
	`c_™ß
(
buf
 + i, 
buf_size
 - i, 
	`va_¬g
(
­
, 
ssize_t
), 10, 
æags
,

1650 
f›ld_width
);

1652 } ià(
ch
 =ğ'd' && 
Ën_mod
 == 'q') {

1653 
i
 +ğ
	`c_™ß
(
buf
 + i, 
buf_size
 - i, 
	`va_¬g
(
­
, 
št64_t
), 10, 
æags
,

1654 
f›ld_width
);

1655 } ià((
ch
 =ğ'x' || ch =ğ'u'è&& 
Ën_mod
 == 0) {

1656 
i
 +ğ
	`c_™ß
(
buf
 + i, 
buf_size
 - i, 
	`va_¬g
(
­
, ),

1657 
ch
 =ğ'x' ? 16 : 10, 
æags
, 
f›ld_width
);

1658 } ià((
ch
 =ğ'x' || ch =ğ'u'è&& 
Ën_mod
 == 'l') {

1659 
i
 +ğ
	`c_™ß
(
buf
 + i, 
buf_size
 - i, 
	`va_¬g
(
­
, ),

1660 
ch
 =ğ'x' ? 16 : 10, 
æags
, 
f›ld_width
);

1661 } ià((
ch
 =ğ'x' || ch =ğ'u'è&& 
Ën_mod
 == 'z') {

1662 
i
 +ğ
	`c_™ß
(
buf
 + i, 
buf_size
 - i, 
	`va_¬g
(
­
, 
size_t
),

1663 
ch
 =ğ'x' ? 16 : 10, 
æags
, 
f›ld_width
);

1664 } ià(
ch
 == 'p') {

1665 
num
 = (è(
ušŒ_t
è
	`va_¬g
(
­
, *);

1666 
	`C_SNPRINTF_APPEND_CHAR
('0');

1667 
	`C_SNPRINTF_APPEND_CHAR
('x');

1668 
i
 +ğ
	`c_™ß
(
buf
 + i, 
buf_size
 - i, 
num
, 16, 
æags
, 0);

1670 #iâdeà
NO_LIBC


1675 
	`abÜt
();

1682 ià(
buf_size
 > 0) {

1683 
buf
[
i
 < (è
buf_size
 ? i : () buf_size - 1] = '\0';

1686  
i
;

1687 
	}
}

1690 
	$c_¢´štf
(*
buf
, 
size_t
 
buf_size
, cÚ¡ *
fmt
, ...è
WEAK
;

1691 
	$c_¢´štf
(*
buf
, 
size_t
 
buf_size
, cÚ¡ *
fmt
, ...) {

1692 
»suÉ
;

1693 
va_li¡
 
­
;

1694 
	`va_¡¬t
(
­
, 
fmt
);

1695 
»suÉ
 = 
	`c_v¢´štf
(
buf
, 
buf_size
, 
fmt
, 
­
);

1696 
	`va_’d
(
­
);

1697  
»suÉ
;

1698 
	}
}

1700 #ifdeà
_WIN32


1701 
	$to_wch¬
(cÚ¡ *
·th
, 
wch¬_t
 *
wbuf
, 
size_t
 
wbuf_Ën
) {

1702 
»t
;

1703 
buf
[
MAX_PATH
 * 2], 
buf2
[MAX_PATH * 2], *
p
;

1705 
	`¡ºıy
(
buf
, 
·th
, (buf));

1706 
buf
[(buf) - 1] = '\0';

1709 
p
 = 
buf
 + 
	`¡¾’
(buf) - 1;

1710 
p
 > 
buf
 &&…[-1] != ':' && (p[0] == '\\' ||…[0] == '/')) *p-- = '\0';

1712 
	`mem£t
(
wbuf
, 0, 
wbuf_Ën
 * (
wch¬_t
));

1713 
»t
 = 
	`MuÉiBy‹ToWideCh¬
(
CP_UTF8
, 0, 
buf
, -1, 
wbuf
, (è
wbuf_Ën
);

1719 
	`WideCh¬ToMuÉiBy‹
(
CP_UTF8
, 0, 
wbuf
, (è
wbuf_Ën
, 
buf2
, (buf2),

1720 
NULL
, NULL);

1721 ià(
	`¡rcmp
(
buf
, 
buf2
) != 0) {

1722 
wbuf
[0] = 
L
'\0';

1723 
»t
 = 0;

1726  
»t
;

1727 
	}
}

1731 cÚ¡ *
	$c_¡º¡r
(cÚ¡ *
s
, cÚ¡ *
fšd
, 
size_t
 
¦’
è
WEAK
;

1732 cÚ¡ *
	$c_¡º¡r
(cÚ¡ *
s
, cÚ¡ *
fšd
, 
size_t
 
¦’
) {

1733 
size_t
 
fšd_Ëngth
 = 
	`¡¾’
(
fšd
);

1734 
size_t
 
i
;

1736 
i
 = 0; i < 
¦’
; i++) {

1737 ià(
i
 + 
fšd_Ëngth
 > 
¦’
) {

1738  
NULL
;

1741 ià(
	`¡ºcmp
(&
s
[
i
], 
fšd
, 
fšd_Ëngth
) == 0) {

1742  &
s
[
i
];

1746  
NULL
;

1747 
	}
}

1749 #ià
CS_ENABLE_STRDUP


1750 *
	$¡rdup
(cÚ¡ *
¤c
è
WEAK
;

1751 *
	$¡rdup
(cÚ¡ *
¤c
) {

1752 
size_t
 
Ën
 = 
	`¡¾’
(
¤c
) + 1;

1753 *
»t
 = 
	`m®loc
(
Ën
);

1754 ià(
»t
 !ğ
NULL
) {

1755 
	`¡rıy
(
»t
, 
¤c
);

1757  
»t
;

1758 
	}
}

1761 
	$cs_to_hex
(*
to
, cÚ¡ *
p
, 
size_t
 
Ën
è
WEAK
;

1762 
	$cs_to_hex
(*
to
, cÚ¡ *
p
, 
size_t
 
Ën
) {

1763 cÚ¡ *
hex
 = "0123456789abcdef";

1765 ; 
Ën
--; 
p
++) {

1766 *
to
++ = 
hex
[
p
[0] >> 4];

1767 *
to
++ = 
hex
[
p
[0] & 0x0f];

1769 *
to
 = '\0';

1770 
	}
}

1772 
	$fourb™
(
ch
) {

1773 ià(
ch
 >= '0' && ch <= '9') {

1774  
ch
 - '0';

1775 } ià(
ch
 >= 'a' && ch <= 'f') {

1776  
ch
 - 'a' + 10;

1777 } ià(
ch
 >= 'A' && ch <= 'F') {

1778  
ch
 - 'A' + 10;

1781 
	}
}

1783 
	$cs_äom_hex
(*
to
, cÚ¡ *
p
, 
size_t
 
Ën
è
WEAK
;

1784 
	$cs_äom_hex
(*
to
, cÚ¡ *
p
, 
size_t
 
Ën
) {

1785 
size_t
 
i
;

1787 
i
 = 0; i < 
Ën
; i += 2) {

1788 *
to
++ = (
	`fourb™
(
p
[
i
]) << 4) + fourbit(p[i + 1]);

1790 *
to
 = '\0';

1791 
	}
}

1793 #ià
CS_ENABLE_TO64


1794 
št64_t
 
	$cs_to64
(cÚ¡ *
s
è
WEAK
;

1795 
št64_t
 
	$cs_to64
(cÚ¡ *
s
) {

1796 
št64_t
 
»suÉ
 = 0;

1797 
št64_t
 
Ãg
 = 1;

1798 *
s
 && 
	`is¥aû
(() *s)) s++;

1799 ià(*
s
 == '-') {

1800 
Ãg
 = -1;

1801 
s
++;

1803 
	`isdig™
((è*
s
)) {

1804 
»suÉ
 *= 10;

1805 
»suÉ
 +ğ(*
s
 - '0');

1806 
s
++;

1808  
»suÉ
 * 
Ãg
;

1809 
	}
}

1812 
	$¡r_ut_low”ÿ£
(cÚ¡ *
s
) {

1813  
	`tŞow”
(*(cÚ¡ *è
s
);

1814 
	}
}

1816 
	$mg_nÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
, 
size_t
 
Ën
è
WEAK
;

1817 
	$mg_nÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
, 
size_t
 
Ën
) {

1818 
diff
 = 0;

1820 ià(
Ën
 > 0) do {

1821 
diff
 = 
	`¡r_ut_low”ÿ£
(
s1
++è- sŒ_ut_low”ÿ£(
s2
++);

1822 } 
diff
 =ğ0 && 
s1
[-1] !ğ'\0' && --
Ën
 > 0);

1824  
diff
;

1825 
	}
}

1827 
	$mg_ÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
è
WEAK
;

1828 
	$mg_ÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

1829  
	`mg_nÿ£cmp
(
s1
, 
s2
, (
size_t
) ~0);

1830 
	}
}

1832 
	$mg_a¥rštf
(**
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, ...è
WEAK
;

1833 
	$mg_a¥rštf
(**
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, ...) {

1834 
»t
;

1835 
va_li¡
 
­
;

1836 
	`va_¡¬t
(
­
, 
fmt
);

1837 
»t
 = 
	`mg_av´štf
(
buf
, 
size
, 
fmt
, 
­
);

1838 
	`va_’d
(
­
);

1839  
»t
;

1840 
	}
}

1842 
	$mg_av´štf
(**
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, 
va_li¡
 
­
è
WEAK
;

1843 
	$mg_av´štf
(**
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, 
va_li¡
 
­
) {

1844 
va_li¡
 
­_cİy
;

1845 
Ën
;

1847 
	`va_cİy
(
­_cİy
, 
­
);

1848 
Ën
 = 
	`v¢´štf
(*
buf
, 
size
, 
fmt
, 
­_cİy
);

1849 
	`va_’d
(
­_cİy
);

1851 ià(
Ën
 < 0) {

1855 *
buf
 = 
NULL
;

1856 
Ën
 < 0) {

1857 
	`MG_FREE
(*
buf
);

1858 
size
 *= 2;

1859 ià((*
buf
 = (*è
	`MG_MALLOC
(
size
)è=ğ
NULL
) ;

1860 
	`va_cİy
(
­_cİy
, 
­
);

1861 
Ën
 = 
	`v¢´štf
(*
buf
, 
size
, 
fmt
, 
­_cİy
);

1862 
	`va_’d
(
­_cİy
);

1865 } ià(
Ën
 >ğ(è
size
) {

1867 ià((*
buf
 = (*è
	`MG_MALLOC
(
Ën
 + 1)è=ğ
NULL
) {

1868 
Ën
 = -1;

1870 
	`va_cİy
(
­_cİy
, 
­
);

1871 
Ën
 = 
	`v¢´štf
(*
buf
,†’ + 1, 
fmt
, 
­_cİy
);

1872 
	`va_’d
(
­_cİy
);

1876  
Ën
;

1877 
	}
}

1880 #ifdeà
MG_MODULE_LINES


1888 #iâdeà
CS_MONGOOSE_SRC_TUN_H_


1889 
	#CS_MONGOOSE_SRC_TUN_H_


	)

1891 #ià
MG_ENABLE_TUN


1896 #iâdeà
MG_TUN_RECONNECT_INTERVAL


1897 
	#MG_TUN_RECONNECT_INTERVAL
 1

	)

1900 
	#MG_TUN_PROTO_NAME
 "mg_tun"

	)

1902 
	#MG_TUN_DATA_FRAME
 0x0

	)

1903 
	#MG_TUN_F_END_STREAM
 0x1

	)

1913 
	smg_tun_äame
 {

1914 
ušt8_t
 
	mty³
;

1915 
ušt8_t
 
	mæags
;

1916 
ušt32_t
 
	m¡»am_id
;

1917 
mg_¡r
 
	mbody
;

1920 
	smg_tun_s¦_İts
 {

1921 #ià
MG_ENABLE_SSL


1922 cÚ¡ *
	ms¦_û¹
;

1923 cÚ¡ *
	ms¦_key
;

1924 cÚ¡ *
	ms¦_ÿ_û¹
;

1926 
	mdummy
;

1930 
	smg_tun_ş›Á
 {

1931 
mg_mgr
 *
	mmgr
;

1932 
mg_içû
 *
	miçû
;

1933 cÚ¡ *
	mdi¥_u¾
;

1934 
mg_tun_s¦_İts
 
	ms¦
;

1936 
ušt32_t
 
	mÏ¡_¡»am_id
;

1938 
mg_cÚÃùiÚ
 *
	mdi¥
;

1939 
mg_cÚÃùiÚ
 *
	mli¡’”
;

1940 
mg_cÚÃùiÚ
 *
	m»cÚÃù
;

1943 #ifdeà
__ılu¥lus


1947 
mg_cÚÃùiÚ
 *
mg_tun_bšd_İt
(
mg_mgr
 *
mgr
,

1948 cÚ¡ *
di¥©ch”
,

1949 
mg_ev’t_hªdËr_t
 
hªdËr
,

1950 
mg_bšd_İts
 
İts
);

1952 
mg_tun_·r£_äame
(*
d©a
, 
size_t
 
Ën
, 
mg_tun_äame
 *
äame
);

1954 
mg_tun_£nd_äame
(
mg_cÚÃùiÚ
 *
ws
, 
ušt32_t
 
¡»am_id
,

1955 
ušt8_t
 
ty³
, ušt8_ˆ
æags
, 
mg_¡r
 
msg
);

1957 
mg_tun_de¡roy_ş›Á
(
mg_tun_ş›Á
 *
ş›Á
);

1959 #ifdeà
__ılu¥lus


1966 #ifdeà
MG_MODULE_LINES


1994 
	#MG_MAX_HOST_LEN
 200

	)

1996 
	#MG_COPY_COMMON_CONNECTION_OPTIONS
(
d¡
, 
¤c
) \

1997 
	`memıy
(
d¡
, 
¤c
, (*d¡));

	)

2000 
	#_MG_ALLOWED_CONNECT_FLAGS_MASK
 \

2001 (
MG_F_USER_1
 | 
MG_F_USER_2
 | 
MG_F_USER_3
 | 
MG_F_USER_4
 | 
MG_F_USER_5
 | \

2002 
MG_F_USER_6
 | 
MG_F_WEBSOCKET_NO_DEFRAG
 | 
MG_F_ENABLE_BROADCAST
)

	)

2004 
	#_MG_CALLBACK_MODIFIABLE_FLAGS_MASK
 \

2005 (
MG_F_USER_1
 | 
MG_F_USER_2
 | 
MG_F_USER_3
 | 
MG_F_USER_4
 | 
MG_F_USER_5
 | \

2006 
MG_F_USER_6
 | 
MG_F_WEBSOCKET_NO_DEFRAG
 | 
MG_F_SEND_AND_CLOSE
 | \

2007 
MG_F_CLOSE_IMMEDIATELY
 | 
MG_F_IS_WEBSOCKET
 | 
MG_F_DELETE_CHUNK
)

	)

2009 #iâdeà
šŒ_t


2010 
	#šŒ_t
 

	)

2013 
MG_INTERNAL
 
	$mg_add_cÚn
(
mg_mgr
 *
mgr
, 
mg_cÚÃùiÚ
 *
c
) {

2014 
	`DBG
(("%°%p", 
mgr
, 
c
));

2015 
c
->
mgr
 = mgr;

2016 
c
->
Ãxt
 = 
mgr
->
aùive_cÚÃùiÚs
;

2017 
mgr
->
aùive_cÚÃùiÚs
 = 
c
;

2018 
c
->
´ev
 = 
NULL
;

2019 ià(
c
->
Ãxt
 !ğ
NULL
èc->Ãxt->
´ev
 = c;

2020 ià(
c
->
sock
 !ğ
INVALID_SOCKET
) {

2021 
c
->
içû
->
vbË
->
	`add_cÚn
(c);

2023 
	}
}

2025 
MG_INTERNAL
 
	$mg_»move_cÚn
(
mg_cÚÃùiÚ
 *
cÚn
) {

2026 ià(
cÚn
->
´ev
 =ğ
NULL
ècÚn->
mgr
->
aùive_cÚÃùiÚs
 = cÚn->
Ãxt
;

2027 ià(
cÚn
->
´ev
ècÚn->´ev->
Ãxt
 = conn->next;

2028 ià(
cÚn
->
Ãxt
ècÚn->Ãxt->
´ev
 = conn->prev;

2029 
cÚn
->
´ev
 = cÚn->
Ãxt
 = 
NULL
;

2030 
cÚn
->
içû
->
vbË
->
	`»move_cÚn
(conn);

2031 
	}
}

2033 
MG_INTERNAL
 
	$mg_ÿÎ
(
mg_cÚÃùiÚ
 *
nc
,

2034 
mg_ev’t_hªdËr_t
 
ev_hªdËr
, 
ev
, *
ev_d©a
) {

2035 ià(
ev_hªdËr
 =ğ
NULL
) {

2040 
ev_hªdËr
 = 
nc
->
´Ùo_hªdËr
 ?‚c->´Ùo_hªdË¸:‚c->
hªdËr
;

2042 ià(
ev
 !ğ
MG_EV_POLL
) {

2043 
	`DBG
(("%°% ev=%dƒv_d©a=%°æags=%lu„mbl=%d smbl=%d", 
nc
,

2044 
ev_hªdËr
 =ğ
nc
->
hªdËr
 ? "u£r" : "´Ùo", 
ev
, 
ev_d©a
,‚c->
æags
,

2045 (è
nc
->
»cv_mbuf
.
Ën
, (ènc->
£nd_mbuf
.len));

2048 #ià!
	`defšed
(
NO_LIBC
è&& 
MG_ENABLE_HEXDUMP


2050 ià(
nc
->
mgr
->
hexdump_fe
 !ğ
NULL
 && 
ev
 !ğ
MG_EV_POLL
 &&

2051 
ev
 !ğ
MG_EV_SEND
 ) {

2052 ià(
ev
 =ğ
MG_EV_RECV
) {

2053 
	`mg_hexdump_cÚÃùiÚ
(
nc
,‚c->
mgr
->
hexdump_fe
,‚c->
»cv_mbuf
.
buf
,

2054 *(*è
ev_d©a
, 
ev
);

2056 
	`mg_hexdump_cÚÃùiÚ
(
nc
,‚c->
mgr
->
hexdump_fe
, 
NULL
, 0, 
ev
);

2061 ià(
ev_hªdËr
 !ğ
NULL
) {

2062 
æags_befÜe
 = 
nc
->
æags
;

2063 
size_t
 
»cv_mbuf_befÜe
 = 
nc
->
»cv_mbuf
.
Ën
, 
»cved
;

2064 
	`ev_hªdËr
(
nc
, 
ev
, 
ev_d©a
);

2065 
»cved
 = (
»cv_mbuf_befÜe
 - 
nc
->
»cv_mbuf
.
Ën
);

2067 ià(
ev_hªdËr
 =ğ
nc
->
hªdËr
 &&‚c->
æags
 !ğ
æags_befÜe
) {

2068 
nc
->
æags
 = (
æags_befÜe
 & ~
_MG_CALLBACK_MODIFIABLE_FLAGS_MASK
) |

2069 (
nc
->
æags
 & 
_MG_CALLBACK_MODIFIABLE_FLAGS_MASK
);

2071 ià(
»cved
 > 0 && !(
nc
->
æags
 & 
MG_F_UDP
)) {

2072 
nc
->
içû
->
vbË
->
	`»cved
Òc, 
»cved
);

2075 ià(
ev
 !ğ
MG_EV_POLL
) {

2076 
	`DBG
(("%°aá” % æags=%lu„mbl=%d smbl=%d", 
nc
,

2077 
ev_hªdËr
 =ğ
nc
->
hªdËr
 ? "u£r" : "´Ùo",‚c->
æags
,

2078 (è
nc
->
»cv_mbuf
.
Ën
, (ènc->
£nd_mbuf
.len));

2080 
	}
}

2082 
	$mg_if_tim”
(
mg_cÚÃùiÚ
 *
c
, 
now
) {

2083 ià(
c
->
ev_tim”_time
 > 0 && 
now
 >= c->ev_timer_time) {

2084 
Şd_v®ue
 = 
c
->
ev_tim”_time
;

2085 
	`mg_ÿÎ
(
c
, 
NULL
, 
MG_EV_TIMER
, &
now
);

2090 ià(
c
->
ev_tim”_time
 =ğ
Şd_v®ue
) {

2091 
c
->
ev_tim”_time
 = 0;

2094 
	}
}

2096 
	$mg_if_pŞl
(
mg_cÚÃùiÚ
 *
nc
, 
time_t
 
now
) {

2097 ià(!(
nc
->
æags
 & 
MG_F_SSL
è|| (nc->æag & 
MG_F_SSL_HANDSHAKE_DONE
)) {

2098 
	`mg_ÿÎ
(
nc
, 
NULL
, 
MG_EV_POLL
, &
now
);

2100 
	}
}

2102 
	$mg_de¡roy_cÚn
(
mg_cÚÃùiÚ
 *
cÚn
, 
de¡roy_if
) {

2103 ià(
de¡roy_if
è
cÚn
->
içû
->
vbË
->
	`de¡roy_cÚn
(conn);

2104 ià(
cÚn
->
´Ùo_d©a
 !ğ
NULL
 && cÚn->
´Ùo_d©a_de¡ruùÜ
 != NULL) {

2105 
cÚn
->
	`´Ùo_d©a_de¡ruùÜ
(cÚn->
´Ùo_d©a
);

2107 #ià
MG_ENABLE_SSL


2108 
	`mg_s¦_if_cÚn_ä“
(
cÚn
);

2110 
	`mbuf_ä“
(&
cÚn
->
»cv_mbuf
);

2111 
	`mbuf_ä“
(&
cÚn
->
£nd_mbuf
);

2113 
	`mem£t
(
cÚn
, 0, (*conn));

2114 
	`MG_FREE
(
cÚn
);

2115 
	}
}

2117 
	$mg_şo£_cÚn
(
mg_cÚÃùiÚ
 *
cÚn
) {

2118 
	`DBG
(("%°%lu %d", 
cÚn
, cÚn->
æags
, cÚn->
sock
));

2119 
	`mg_»move_cÚn
(
cÚn
);

2120 
cÚn
->
içû
->
vbË
->
	`de¡roy_cÚn
(conn);

2121 
	`mg_ÿÎ
(
cÚn
, 
NULL
, 
MG_EV_CLOSE
, NULL);

2122 
	`mg_de¡roy_cÚn
(
cÚn
, 0 );

2123 
	}
}

2125 
	$mg_mgr_š™
(
mg_mgr
 *
m
, *
u£r_d©a
) {

2126 
mg_mgr_š™_İts
 
İts
;

2127 
	`mem£t
(&
İts
, 0, (opts));

2128 
	`mg_mgr_š™_İt
(
m
, 
u£r_d©a
, 
İts
);

2129 
	}
}

2131 
	$mg_mgr_š™_İt
(
mg_mgr
 *
m
, *
u£r_d©a
,

2132 
mg_mgr_š™_İts
 
İts
) {

2133 
	`mem£t
(
m
, 0, (*m));

2134 #ià
MG_ENABLE_BROADCAST


2135 
m
->
ùl
[0] = m->ùl[1] = 
INVALID_SOCKET
;

2137 
m
->
u£r_d©a
 = user_data;

2139 #ifdeà
_WIN32


2141 
WSADATA
 
d©a
;

2142 
	`WSAS¹up
(
	`MAKEWORD
(2, 2), &
d©a
);

2144 #–ià
	`defšed
(
__unix__
)

2147 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

2150 #ià
MG_ENABLE_SSL


2152 
š™_dÚe
;

2153 ià(!
š™_dÚe
) {

2154 
	`mg_s¦_if_š™
();

2155 
š™_dÚe
++;

2160 
i
;

2161 ià(
İts
.
num_içûs
 == 0) {

2162 
İts
.
num_içûs
 = 
mg_num_içûs
;

2163 
İts
.
içûs
 = 
mg_içûs
;

2165 ià(
İts
.
maš_içû
 !ğ
NULL
) {

2166 
İts
.
içûs
[
MG_MAIN_IFACE
] = o±s.
maš_içû
;

2168 
m
->
num_içûs
 = 
İts
.num_ifaces;

2169 
m
->
içûs
 =

2170 (
mg_içû
 **è
	`MG_MALLOC
((*
m
->
içûs
è* 
İts
.
num_içûs
);

2171 
i
 = 0; i < 
mg_num_içûs
; i++) {

2172 
m
->
içûs
[
i
] = 
	`mg_if_ü—‹_içû
(
İts
.ifaces[i], m);

2173 
m
->
içûs
[
i
]->
vbË
->
	`š™
(m->ifaces[i]);

2176 
	`DBG
(("=================================="));

2177 
	`DBG
(("š™ mgr=%p", 
m
));

2178 
	}
}

2180 #ià
MG_ENABLE_JAVASCRIPT


2181 
v7_”r
 
	$mg_£nd_js
(
v7
 *v7, 
v7_v®_t
 *
»s
) {

2182 
v7_v®_t
 
¬g0
 = 
	`v7_¬g
(
v7
, 0);

2183 
v7_v®_t
 
¬g1
 = 
	`v7_¬g
(
v7
, 1);

2184 
mg_cÚÃùiÚ
 *
c
 = (mg_cÚÃùiÚ *è
	`v7_g‘_±r
(
v7
, 
¬g0
);

2185 
size_t
 
Ën
 = 0;

2187 ià(
	`v7_is_¡ršg
(
¬g1
)) {

2188 cÚ¡ *
d©a
 = 
	`v7_g‘_¡ršg
(
v7
, &
¬g1
, &
Ën
);

2189 
	`mg_£nd
(
c
, 
d©a
, 
Ën
);

2192 *
»s
 = 
	`v7_mk_numb”
(
v7
, 
Ën
);

2194  
V7_OK
;

2195 
	}
}

2197 
v7_”r
 
	$mg_’abË_javasüt
(
mg_mgr
 *
m
, 
v7
 *v7,

2198 cÚ¡ *
š™_fe_Çme
) {

2199 
v7_v®_t
 
v
;

2200 
m
->
v7
 = v7;

2201 
	`v7_£t_m‘hod
(
v7
, 
	`v7_g‘_glob®
(v7), "mg_£nd", 
mg_£nd_js
);

2202  
	`v7_exec_fe
(
v7
, 
š™_fe_Çme
, &
v
);

2203 
	}
}

2206 
	$mg_mgr_ä“
(
mg_mgr
 *
m
) {

2207 
mg_cÚÃùiÚ
 *
cÚn
, *
tmp_cÚn
;

2209 
	`DBG
(("%p", 
m
));

2210 ià(
m
 =ğ
NULL
) ;

2212 
	`mg_mgr_pŞl
(
m
, 0);

2214 #ià
MG_ENABLE_BROADCAST


2215 ià(
m
->
ùl
[0] !ğ
INVALID_SOCKET
è
	`şo£sock‘
(m->ctl[0]);

2216 ià(
m
->
ùl
[1] !ğ
INVALID_SOCKET
è
	`şo£sock‘
(m->ctl[1]);

2217 
m
->
ùl
[0] = m->ùl[1] = 
INVALID_SOCKET
;

2220 
cÚn
 = 
m
->
aùive_cÚÃùiÚs
; cÚÀ!ğ
NULL
; cÚÀğ
tmp_cÚn
) {

2221 
tmp_cÚn
 = 
cÚn
->
Ãxt
;

2222 
	`mg_şo£_cÚn
(
cÚn
);

2226 
i
;

2227 
i
 = 0; i < 
m
->
num_içûs
; i++) {

2228 
m
->
içûs
[
i
]->
vbË
->
	`ä“
(m->ifaces[i]);

2229 
	`MG_FREE
(
m
->
içûs
[
i
]);

2231 
	`MG_FREE
(
m
->
içûs
);

2233 
	}
}

2235 
time_t
 
	$mg_mgr_pŞl
(
mg_mgr
 *
m
, 
timeout_ms
) {

2236 
i
;

2237 
time_t
 
now
 = 0;

2239 ià(
m
->
num_içûs
 == 0) {

2240 
	`LOG
(
LL_ERROR
, ("cannot…oll:‚o interfaces"));

2244 
i
 = 0; i < 
m
->
num_içûs
; i++) {

2245 
now
 = 
m
->
içûs
[
i
]->
vbË
->
	`pŞl
(m->içûs[i], 
timeout_ms
);

2247  
now
;

2248 
	}
}

2250 
	$mg_v´štf
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
fmt
, 
va_li¡
 
­
) {

2251 
mem
[
MG_VPRINTF_BUFFER_SIZE
], *
buf
 = mem;

2252 
Ën
;

2254 ià((
Ën
 = 
	`mg_av´štf
(&
buf
, (
mem
), 
fmt
, 
­
)) > 0) {

2255 
	`mg_£nd
(
nc
, 
buf
, 
Ën
);

2257 ià(
buf
 !ğ
mem
 && buà!ğ
NULL
) {

2258 
	`MG_FREE
(
buf
);

2261  
Ën
;

2262 
	}
}

2264 
	$mg_´štf
(
mg_cÚÃùiÚ
 *
cÚn
, cÚ¡ *
fmt
, ...) {

2265 
Ën
;

2266 
va_li¡
 
­
;

2267 
	`va_¡¬t
(
­
, 
fmt
);

2268 
Ën
 = 
	`mg_v´štf
(
cÚn
, 
fmt
, 
­
);

2269 
	`va_’d
(
­
);

2270  
Ën
;

2271 
	}
}

2273 #ià
MG_ENABLE_SYNC_RESOLVER


2275 
	$mg_»sŞve2
(cÚ¡ *
ho¡
, 
š_addr
 *
ša
) {

2276 #ià
MG_ENABLE_GETADDRINFO


2277 
rv
 = 0;

2278 
addršfo
 
hšts
, *
£rvšfo
, *
p
;

2279 
sockaddr_š
 *
h
 = 
NULL
;

2280 
	`mem£t
(&
hšts
, 0,  hints);

2281 
hšts
.
ai_çmy
 = 
AF_INET
;

2282 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

2283 ià((
rv
 = 
	`g‘addršfo
(
ho¡
, 
NULL
, NULL, &
£rvšfo
)) != 0) {

2284 
	`DBG
(("g‘addršfo(%sèçed: %s", 
ho¡
, 
	`¡»¼Ü
(
	`mg_g‘_”ºo
())));

2287 
p
 = 
£rvšfo
;… !ğ
NULL
;… =…->
ai_Ãxt
) {

2288 
	`memıy
(&
h
, &
p
->
ai_addr
, (
sockaddr_š
 *));

2289 
	`memıy
(
ša
, &
h
->
sš_addr
, (ina));

2291 
	`ä“addršfo
(
£rvšfo
);

2294 
ho¡’t
 *
he
;

2295 ià((
he
 = 
	`g‘ho¡byÇme
(
ho¡
)è=ğ
NULL
) {

2296 
	`DBG
(("g‘ho¡byÇme(%sèçed: %s", 
ho¡
, 
	`¡»¼Ü
(
	`mg_g‘_”ºo
())));

2298 
	`memıy
(
ša
, 
he
->
h_addr_li¡
[0], (*ina));

2303 
	}
}

2305 
	$mg_»sŞve
(cÚ¡ *
ho¡
, *
buf
, 
size_t
 
n
) {

2306 
š_addr
 
ad
;

2307  
	`mg_»sŞve2
(
ho¡
, &
ad
è? 
	`¢´štf
(
buf
, 
n
, "%s", 
	`š‘_Áß
(ad)) : 0;

2308 
	}
}

2311 
MG_INTERNAL
 
mg_cÚÃùiÚ
 *
	$mg_ü—‹_cÚÃùiÚ_ba£
(

2312 
mg_mgr
 *
mgr
, 
mg_ev’t_hªdËr_t
 
ÿÎback
,

2313 
mg_add_sock_İts
 
İts
) {

2314 
mg_cÚÃùiÚ
 *
cÚn
;

2316 ià((
cÚn
 = (
mg_cÚÃùiÚ
 *è
	`MG_CALLOC
(1, (*cÚn))è!ğ
NULL
) {

2317 
cÚn
->
sock
 = 
INVALID_SOCKET
;

2318 
cÚn
->
hªdËr
 = 
ÿÎback
;

2319 
cÚn
->
mgr
 = mgr;

2320 
cÚn
->
Ï¡_io_time
 = (
time_t
è
	`mg_time
();

2321 
cÚn
->
içû
 =

2322 (
İts
.
içû
 !ğ
NULL
 ? o±s.içû : 
mgr
->
içûs
[
MG_MAIN_IFACE
]);

2323 
cÚn
->
æags
 = 
İts
.æag & 
_MG_ALLOWED_CONNECT_FLAGS_MASK
;

2324 
cÚn
->
u£r_d©a
 = 
İts
.user_data;

2330 
cÚn
->
»cv_mbuf_lim™
 = ~0;

2332 
	`MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, "failedo create connection");

2335  
cÚn
;

2336 
	}
}

2338 
MG_INTERNAL
 
mg_cÚÃùiÚ
 *
	$mg_ü—‹_cÚÃùiÚ
(

2339 
mg_mgr
 *
mgr
, 
mg_ev’t_hªdËr_t
 
ÿÎback
,

2340 
mg_add_sock_İts
 
İts
) {

2341 
mg_cÚÃùiÚ
 *
cÚn
 = 
	`mg_ü—‹_cÚÃùiÚ_ba£
(
mgr
, 
ÿÎback
, 
İts
);

2343 ià(
cÚn
 !ğ
NULL
 && !cÚn->
içû
->
vbË
->
	`ü—‹_cÚn
(conn)) {

2344 
	`MG_FREE
(
cÚn
);

2345 
cÚn
 = 
NULL
;

2347 ià(
cÚn
 =ğ
NULL
) {

2348 
	`MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, "failedo init connection");

2351  
cÚn
;

2352 
	}
}

2367 
MG_INTERNAL
 
	$mg_·r£_add»ss
(cÚ¡ *
¡r
, 
sock‘_add»ss
 *
§
,

2368 *
´Ùo
, *
ho¡
, 
size_t
 
ho¡_Ën
) {

2369 
a
, 
b
, 
c
, 
d
, 
pÜt
 = 0;

2370 
ch
, 
Ën
 = 0;

2371 #ià
MG_ENABLE_IPV6


2372 
buf
[100];

2380 
	`mem£t
(
§
, 0, (*sa));

2381 
§
->
sš
.
sš_çmy
 = 
AF_INET
;

2383 *
´Ùo
 = 
SOCK_STREAM
;

2385 ià(
	`¡ºcmp
(
¡r
, "udp://", 6) == 0) {

2386 
¡r
 += 6;

2387 *
´Ùo
 = 
SOCK_DGRAM
;

2388 } ià(
	`¡ºcmp
(
¡r
, "tcp://", 6) == 0) {

2389 
¡r
 += 6;

2392 ià(
	`ssÿnf
(
¡r
, "%u.%u.%u.%u:%u%n", &
a
, &
b
, &
c
, &
d
, &
pÜt
, &
Ën
) == 5) {

2394 
§
->
sš
.
sš_addr
.
s_addr
 =

2395 
	`htÚl
(((
ušt32_t
è
a
 << 24è| ((ušt32_tè
b
 << 16è| 
c
 << 8 | 
d
);

2396 
§
->
sš
.
sš_pÜt
 = 
	`htÚs
((
ušt16_t
è
pÜt
);

2397 #ià
MG_ENABLE_IPV6


2398 } ià(
	`ssÿnf
(
¡r
, "[%99[^]]]:%u%n", 
buf
, &
pÜt
, &
Ën
) == 2 &&

2399 
	`š‘_±Ú
(
AF_INET6
, 
buf
, &
§
->
sš6
.
sš6_addr
)) {

2401 
§
->
sš6
.
sš6_çmy
 = 
AF_INET6
;

2402 
§
->
sš
.
sš_pÜt
 = 
	`htÚs
((
ušt16_t
è
pÜt
);

2404 #ià
MG_ENABLE_ASYNC_RESOLVER


2405 } ià(
	`¡¾’
(
¡r
è< 
ho¡_Ën
 &&

2406 
	`ssÿnf
(
¡r
, "%[^ :]:%u%n", 
ho¡
, &
pÜt
, &
Ën
) == 2) {

2407 
§
->
sš
.
sš_pÜt
 = 
	`htÚs
((
ušt16_t
è
pÜt
);

2408 ià(
	`mg_»sŞve_äom_ho¡s_fe
(
ho¡
, 
§
) != 0) {

2415 ià(
	`mg_nÿ£cmp
(
ho¡
, "localhost", 9) != 0) {

2419 #ià
MG_ENABLE_SYNC_RESOLVER


2420 ià(!
	`mg_»sŞve2
(
ho¡
, &
§
->
sš
.
sš_addr
)) {

2428 } ià(
	`ssÿnf
(
¡r
, ":%u%n", &
pÜt
, &
Ën
) == 1 ||

2429 
	`ssÿnf
(
¡r
, "%u%n", &
pÜt
, &
Ën
) == 1) {

2431 
§
->
sš
.
sš_pÜt
 = 
	`htÚs
((
ušt16_t
è
pÜt
);

2437 (è
ho¡
;

2438 (è
ho¡_Ën
;

2440 
ch
 = 
¡r
[
Ën
];

2441  
pÜt
 < 0xffffUL && (
ch
 =ğ'\0' || ch =ğ',' || 
	`is¥aû
(ch)è? 
Ën
 : -1;

2442 
	}
}

2444 
mg_cÚÃùiÚ
 *
	$mg_if_acû±_Ãw_cÚn
(
mg_cÚÃùiÚ
 *
lc
) {

2445 
mg_add_sock_İts
 
İts
;

2446 
mg_cÚÃùiÚ
 *
nc
;

2447 
	`mem£t
(&
İts
, 0, (opts));

2448 
nc
 = 
	`mg_ü—‹_cÚÃùiÚ
(
lc
->
mgr
,†c->
hªdËr
, 
İts
);

2449 ià(
nc
 =ğ
NULL
)  NULL;

2450 
nc
->
li¡’”
 = 
lc
;

2451 
nc
->
´Ùo_hªdËr
 = 
lc
->proto_handler;

2452 
nc
->
u£r_d©a
 = 
lc
->user_data;

2453 
nc
->
»cv_mbuf_lim™
 = 
lc
->recv_mbuf_limit;

2454 
nc
->
içû
 = 
lc
->iface;

2455 ià(
lc
->
æags
 & 
MG_F_SSL
è
nc
->flags |= MG_F_SSL;

2456 
	`mg_add_cÚn
(
nc
->
mgr
,‚c);

2457 
	`DBG
(("%°%°%d %d", 
lc
, 
nc
,‚c->
sock
, (ènc->
æags
));

2458  
nc
;

2459 
	}
}

2461 
	$mg_if_acû±_tı_cb
(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
,

2462 
size_t
 
§_Ën
) {

2463 (è
§_Ën
;

2464 
nc
->
§
 = *sa;

2465 
	`mg_ÿÎ
(
nc
, 
NULL
, 
MG_EV_ACCEPT
, &nc->
§
);

2466 
	}
}

2468 
	$mg_£nd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
, 
Ën
) {

2469 
nc
->
Ï¡_io_time
 = (
time_t
è
	`mg_time
();

2470 ià(
nc
->
æags
 & 
MG_F_UDP
) {

2471 
nc
->
içû
->
vbË
->
	`udp_£nd
Òc, 
buf
, 
Ën
);

2473 
nc
->
içû
->
vbË
->
	`tı_£nd
Òc, 
buf
, 
Ën
);

2475 #ià!
	`defšed
(
NO_LIBC
è&& 
MG_ENABLE_HEXDUMP


2476 ià(
nc
->
mgr
 &&‚c->mgr->
hexdump_fe
 !ğ
NULL
) {

2477 
	`mg_hexdump_cÚÃùiÚ
(
nc
,‚c->
mgr
->
hexdump_fe
, 
buf
, 
Ën
, 
MG_EV_SEND
);

2480 
	}
}

2482 
	$mg_if_£Á_cb
(
mg_cÚÃùiÚ
 *
nc
, 
num_£Á
) {

2483 ià(
num_£Á
 < 0) {

2484 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

2486 
	`mg_ÿÎ
(
nc
, 
NULL
, 
MG_EV_SEND
, &
num_£Á
);

2487 
	}
}

2489 
MG_INTERNAL
 
	$mg_»cv_commÚ
(
mg_cÚÃùiÚ
 *
nc
, *
buf
, 
Ën
,

2490 
own
) {

2491 
	`DBG
(("%°%d %u", 
nc
, 
Ën
, (ènc->
»cv_mbuf
.len));

2492 ià(
nc
->
æags
 & 
MG_F_CLOSE_IMMEDIATELY
) {

2493 
	`DBG
(("%°disÿrded %d by‹s", 
nc
, 
Ën
));

2498 ià(
own
) {

2499 
	`MG_FREE
(
buf
);

2503 
nc
->
Ï¡_io_time
 = (
time_t
è
	`mg_time
();

2504 ià(!
own
) {

2505 
	`mbuf_­³nd
(&
nc
->
»cv_mbuf
, 
buf
, 
Ën
);

2506 } ià(
nc
->
»cv_mbuf
.
Ën
 == 0) {

2508 
	`mbuf_ä“
(&
nc
->
»cv_mbuf
);

2509 
nc
->
»cv_mbuf
.
buf
 = (*) buf;

2510 
nc
->
»cv_mbuf
.
size
 =‚c->»cv_mbuf.
Ën
 =†en;

2512 
	`mbuf_­³nd
(&
nc
->
»cv_mbuf
, 
buf
, 
Ën
);

2513 
	`MG_FREE
(
buf
);

2515 
	`mg_ÿÎ
(
nc
, 
NULL
, 
MG_EV_RECV
, &
Ën
);

2516 
	}
}

2518 
	$mg_if_»cv_tı_cb
(
mg_cÚÃùiÚ
 *
nc
, *
buf
, 
Ën
, 
own
) {

2519 
	`mg_»cv_commÚ
(
nc
, 
buf
, 
Ën
, 
own
);

2520 
	}
}

2522 
	$mg_if_»cv_udp_cb
(
mg_cÚÃùiÚ
 *
nc
, *
buf
, 
Ën
,

2523 
sock‘_add»ss
 *
§
, 
size_t
 
§_Ën
) {

2524 
	`as£¹
(
nc
->
æags
 & 
MG_F_UDP
);

2525 
	`DBG
(("%°%u", 
nc
, (è
Ën
));

2526 ià(
nc
->
æags
 & 
MG_F_LISTENING
) {

2527 
mg_cÚÃùiÚ
 *
lc
 = 
nc
;

2532 
nc
 = 
	`mg_Ãxt
(
lc
->
mgr
, 
NULL
);‚c != NULL;‚c = mg_next(lc->mgr,‚c)) {

2533 ià(
	`memcmp
(&
nc
->
§
.§, &§->§, 
§_Ën
è=ğ0 &&‚c->
li¡’”
 =ğ
lc
) {

2537 ià(
nc
 =ğ
NULL
) {

2538 
mg_add_sock_İts
 
İts
;

2539 
	`mem£t
(&
İts
, 0, (opts));

2541 
nc
 = 
	`mg_ü—‹_cÚÃùiÚ_ba£
(
lc
->
mgr
,†c->
hªdËr
, 
İts
);

2542 ià(
nc
 !ğ
NULL
) {

2543 
nc
->
sock
 = 
lc
->sock;

2544 
nc
->
li¡’”
 = 
lc
;

2545 
nc
->
§
 = *sa;

2546 
nc
->
´Ùo_hªdËr
 = 
lc
->proto_handler;

2547 
nc
->
u£r_d©a
 = 
lc
->user_data;

2548 
nc
->
»cv_mbuf_lim™
 = 
lc
->recv_mbuf_limit;

2549 
nc
->
æags
 = 
MG_F_UDP
;

2561 
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

2562 
	`mg_add_cÚn
(
lc
->
mgr
, 
nc
);

2563 
	`mg_ÿÎ
(
nc
, 
NULL
, 
MG_EV_ACCEPT
, &nc->
§
);

2565 
	`DBG
(("OOM"));

2570 ià(
nc
 !ğ
NULL
) {

2571 
	`mg_»cv_commÚ
(
nc
, 
buf
, 
Ën
, 1);

2574 
	`MG_FREE
(
buf
);

2575 
nc
->
içû
->
vbË
->
	`»cved
Òc, 
Ën
);

2577 
	}
}

2585 
MG_INTERNAL
 
mg_cÚÃùiÚ
 *
	$mg_do_cÚÃù
(
mg_cÚÃùiÚ
 *
nc
,

2586 
´Ùo
,

2587 
sock‘_add»ss
 *
§
) {

2588 
	`DBG
(("%°%s://%s:%hu", 
nc
, 
´Ùo
 =ğ
SOCK_DGRAM
 ? "udp" : "tcp",

2589 
	`š‘_Áß
(
§
->
sš
.
sš_addr
), 
	`Áohs
(§->sš.
sš_pÜt
)));

2591 
nc
->
æags
 |ğ
MG_F_CONNECTING
;

2592 ià(
´Ùo
 =ğ
SOCK_DGRAM
) {

2593 
nc
->
içû
->
vbË
->
	`cÚÃù_udp
(nc);

2595 
nc
->
içû
->
vbË
->
	`cÚÃù_tı
Òc, 
§
);

2597 
	`mg_add_cÚn
(
nc
->
mgr
,‚c);

2598  
nc
;

2599 
	}
}

2601 
	$mg_if_cÚÃù_cb
(
mg_cÚÃùiÚ
 *
nc
, 
”r
) {

2602 
	`DBG
(("%°cÚÃù,ƒ¼=%d", 
nc
, 
”r
));

2603 
nc
->
æags
 &ğ~
MG_F_CONNECTING
;

2604 ià(
”r
 != 0) {

2605 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

2607 
	`mg_ÿÎ
(
nc
, 
NULL
, 
MG_EV_CONNECT
, &
”r
);

2608 
	}
}

2610 #ià
MG_ENABLE_ASYNC_RESOLVER


2617 
	$»sŞve_cb
(
mg_dns_mes§ge
 *
msg
, *
d©a
,

2618 
mg_»sŞve_”r
 
e
) {

2619 
mg_cÚÃùiÚ
 *
nc
 = (mg_cÚÃùiÚ *è
d©a
;

2620 
i
;

2621 
çu»
 = -1;

2623 
nc
->
æags
 &ğ~
MG_F_RESOLVING
;

2624 ià(
msg
 !ğ
NULL
) {

2628 
i
 = 0; i < 
msg
->
num_ªsw”s
; i++) {

2629 ià(
msg
->
ªsw”s
[
i
].
¹y³
 =ğ
MG_DNS_A_RECORD
) {

2634 
	`mg_dns_·r£_»cÜd_d©a
(
msg
, &msg->
ªsw”s
[
i
], &
nc
->
§
.
sš
.
sš_addr
,

2636 
	`mg_do_cÚÃù
(
nc
,‚c->
æags
 & 
MG_F_UDP
 ? 
SOCK_DGRAM
 : 
SOCK_STREAM
,

2637 &
nc
->
§
);

2643 ià(
e
 =ğ
MG_RESOLVE_TIMEOUT
) {

2644 
now
 = 
	`mg_time
();

2645 
	`mg_ÿÎ
(
nc
, 
NULL
, 
MG_EV_TIMER
, &
now
);

2651 
	`mg_ÿÎ
(
nc
, 
NULL
, 
MG_EV_CONNECT
, &
çu»
);

2652 
	`mg_ÿÎ
(
nc
, 
NULL
, 
MG_EV_CLOSE
, NULL);

2653 
	`mg_de¡roy_cÚn
(
nc
, 1 );

2654 
	}
}

2657 
mg_cÚÃùiÚ
 *
	$mg_cÚÃù
(
mg_mgr
 *
mgr
, cÚ¡ *
add»ss
,

2658 
mg_ev’t_hªdËr_t
 
ÿÎback
) {

2659 
mg_cÚÃù_İts
 
İts
;

2660 
	`mem£t
(&
İts
, 0, (opts));

2661  
	`mg_cÚÃù_İt
(
mgr
, 
add»ss
, 
ÿÎback
, 
İts
);

2662 
	}
}

2664 
mg_cÚÃùiÚ
 *
	$mg_cÚÃù_İt
(
mg_mgr
 *
mgr
, cÚ¡ *
add»ss
,

2665 
mg_ev’t_hªdËr_t
 
ÿÎback
,

2666 
mg_cÚÃù_İts
 
İts
) {

2667 
mg_cÚÃùiÚ
 *
nc
 = 
NULL
;

2668 
´Ùo
, 
rc
;

2669 
mg_add_sock_İts
 
add_sock_İts
;

2670 
ho¡
[
MG_MAX_HOST_LEN
];

2672 
	`MG_COPY_COMMON_CONNECTION_OPTIONS
(&
add_sock_İts
, &
İts
);

2674 ià((
nc
 = 
	`mg_ü—‹_cÚÃùiÚ
(
mgr
, 
ÿÎback
, 
add_sock_İts
)è=ğ
NULL
) {

2675  
NULL
;

2678 ià((
rc
 = 
	`mg_·r£_add»ss
(
add»ss
, &
nc
->
§
, &
´Ùo
, 
ho¡
, (host))) <

2681 
	`MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, "cannot…arse‡ddress");

2682 
	`mg_de¡roy_cÚn
(
nc
, 1 );

2683  
NULL
;

2686 
nc
->
æags
 |ğ
İts
.æag & 
_MG_ALLOWED_CONNECT_FLAGS_MASK
;

2687 
nc
->
æags
 |ğ(
´Ùo
 =ğ
SOCK_DGRAM
è? 
MG_F_UDP
 : 0;

2688 
nc
->
u£r_d©a
 = 
İts
.user_data;

2690 #ià
MG_ENABLE_SSL


2691 
	`DBG
(("%°% %s,%s,%s", 
nc
, 
add»ss
, (
İts
.
s¦_û¹
 ? opts.ssl_cert : "-"),

2692 (
İts
.
s¦_key
 ? opts.ssl_key : "-"),

2693 (
İts
.
s¦_ÿ_û¹
 ? opts.ssl_ca_cert : "-")));

2695 ià(
İts
.
s¦_û¹
 !ğ
NULL
 || o±s.
s¦_ÿ_û¹
 != NULL ||

2696 
İts
.
s¦_psk_id’t™y
 !ğ
NULL
) {

2697 cÚ¡ *
”r_msg
 = 
NULL
;

2698 
mg_s¦_if_cÚn_·¿ms
 
·¿ms
;

2699 ià(
nc
->
æags
 & 
MG_F_UDP
) {

2700 
	`MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, "SSL for UDP is‚ot supported");

2701 
	`mg_de¡roy_cÚn
(
nc
, 1 );

2702  
NULL
;

2704 
	`mem£t
(&
·¿ms
, 0, (params));

2705 
·¿ms
.
û¹
 = 
İts
.
s¦_û¹
;

2706 
·¿ms
.
key
 = 
İts
.
s¦_key
;

2707 
·¿ms
.
ÿ_û¹
 = 
İts
.
s¦_ÿ_û¹
;

2708 
·¿ms
.
ch”_su™es
 = 
İts
.
s¦_ch”_su™es
;

2709 
·¿ms
.
psk_id’t™y
 = 
İts
.
s¦_psk_id’t™y
;

2710 
·¿ms
.
psk_key
 = 
İts
.
s¦_psk_key
;

2711 ià(
İts
.
s¦_ÿ_û¹
 !ğ
NULL
) {

2712 ià(
İts
.
s¦_£rv”_Çme
 !ğ
NULL
) {

2713 ià(
	`¡rcmp
(
İts
.
s¦_£rv”_Çme
, "*") != 0) {

2714 
·¿ms
.
£rv”_Çme
 = 
İts
.
s¦_£rv”_Çme
;

2716 } ià(
rc
 == 0) {

2717 
·¿ms
.
£rv”_Çme
 = 
ho¡
;

2720 ià(
	`mg_s¦_if_cÚn_š™
(
nc
, &
·¿ms
, &
”r_msg
è!ğ
MG_SSL_OK
) {

2721 
	`MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, 
”r_msg
);

2722 
	`mg_de¡roy_cÚn
(
nc
, 1 );

2723  
NULL
;

2725 
nc
->
æags
 |ğ
MG_F_SSL
;

2729 ià(
rc
 == 0) {

2730 #ià
MG_ENABLE_ASYNC_RESOLVER


2735 
mg_cÚÃùiÚ
 *
dns_cÚn
 = 
NULL
;

2736 
mg_»sŞve_async_İts
 
o
;

2737 
	`mem£t
(&
o
, 0, (o));

2738 
o
.
dns_cÚn
 = &dns_conn;

2739 ià(
	`mg_»sŞve_async_İt
(
nc
->
mgr
, 
ho¡
, 
MG_DNS_A_RECORD
, 
»sŞve_cb
,‚c,

2740 
o
) != 0) {

2741 
	`MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, "cannot schedule DNS†ookup");

2742 
	`mg_de¡roy_cÚn
(
nc
, 1 );

2743  
NULL
;

2745 
nc
->
´iv_2
 = 
dns_cÚn
;

2746 
nc
->
æags
 |ğ
MG_F_RESOLVING
;

2747  
nc
;

2749 
	`MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, "Resolver is disabled");

2750 
	`mg_de¡roy_cÚn
(
nc
, 1 );

2751  
NULL
;

2755  
	`mg_do_cÚÃù
(
nc
, 
´Ùo
, &nc->
§
);

2757 
	}
}

2759 
mg_cÚÃùiÚ
 *
	$mg_bšd
(
mg_mgr
 *
¤v
, cÚ¡ *
add»ss
,

2760 
mg_ev’t_hªdËr_t
 
ev’t_hªdËr
) {

2761 
mg_bšd_İts
 
İts
;

2762 
	`mem£t
(&
İts
, 0, (opts));

2763  
	`mg_bšd_İt
(
¤v
, 
add»ss
, 
ev’t_hªdËr
, 
İts
);

2764 
	}
}

2766 
mg_cÚÃùiÚ
 *
	$mg_bšd_İt
(
mg_mgr
 *
mgr
, cÚ¡ *
add»ss
,

2767 
mg_ev’t_hªdËr_t
 
ÿÎback
,

2768 
mg_bšd_İts
 
İts
) {

2769 
sock‘_add»ss
 
§
;

2770 
mg_cÚÃùiÚ
 *
nc
 = 
NULL
;

2771 
´Ùo
, 
rc
;

2772 
mg_add_sock_İts
 
add_sock_İts
;

2773 
ho¡
[
MG_MAX_HOST_LEN
];

2775 
	`MG_COPY_COMMON_CONNECTION_OPTIONS
(&
add_sock_İts
, &
İts
);

2777 #ià
MG_ENABLE_TUN


2778 ià(
	`mg_¡ºcmp
(
	`mg_mk_¡r
(
add»ss
), mg_mk_str("ws://"), 5) == 0 ||

2779 
	`mg_¡ºcmp
(
	`mg_mk_¡r
(
add»ss
), mg_mk_str("wss://"), 6) == 0) {

2780  
	`mg_tun_bšd_İt
(
mgr
, 
add»ss
, 
ÿÎback
, 
İts
);

2784 ià(
	`mg_·r£_add»ss
(
add»ss
, &
§
, &
´Ùo
, 
ho¡
, (host)) <= 0) {

2785 
	`MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, "cannot…arse‡ddress");

2786  
NULL
;

2789 
nc
 = 
	`mg_ü—‹_cÚÃùiÚ
(
mgr
, 
ÿÎback
, 
add_sock_İts
);

2790 ià(
nc
 =ğ
NULL
) {

2791  
NULL
;

2794 
nc
->
§
 = sa;

2795 
nc
->
æags
 |ğ
MG_F_LISTENING
;

2796 ià(
´Ùo
 =ğ
SOCK_DGRAM
è
nc
->
æags
 |ğ
MG_F_UDP
;

2798 #ià
MG_ENABLE_SSL


2799 
	`DBG
(("%°% %s,%s,%s", 
nc
, 
add»ss
, (
İts
.
s¦_û¹
 ? opts.ssl_cert : "-"),

2800 (
İts
.
s¦_key
 ? opts.ssl_key : "-"),

2801 (
İts
.
s¦_ÿ_û¹
 ? opts.ssl_ca_cert : "-")));

2803 ià(
İts
.
s¦_û¹
 !ğ
NULL
 || o±s.
s¦_ÿ_û¹
 != NULL) {

2804 cÚ¡ *
”r_msg
 = 
NULL
;

2805 
mg_s¦_if_cÚn_·¿ms
 
·¿ms
;

2806 ià(
nc
->
æags
 & 
MG_F_UDP
) {

2807 
	`MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, "SSL for UDP is‚ot supported");

2808 
	`mg_de¡roy_cÚn
(
nc
, 1 );

2809  
NULL
;

2811 
	`mem£t
(&
·¿ms
, 0, (params));

2812 
·¿ms
.
û¹
 = 
İts
.
s¦_û¹
;

2813 
·¿ms
.
key
 = 
İts
.
s¦_key
;

2814 
·¿ms
.
ÿ_û¹
 = 
İts
.
s¦_ÿ_û¹
;

2815 
·¿ms
.
ch”_su™es
 = 
İts
.
s¦_ch”_su™es
;

2816 ià(
	`mg_s¦_if_cÚn_š™
(
nc
, &
·¿ms
, &
”r_msg
è!ğ
MG_SSL_OK
) {

2817 
	`MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, 
”r_msg
);

2818 
	`mg_de¡roy_cÚn
(
nc
, 1 );

2819  
NULL
;

2821 
nc
->
æags
 |ğ
MG_F_SSL
;

2825 ià(
nc
->
æags
 & 
MG_F_UDP
) {

2826 
rc
 = 
nc
->
içû
->
vbË
->
	`li¡’_udp
Òc, &nc->
§
);

2828 
rc
 = 
nc
->
içû
->
vbË
->
	`li¡’_tı
Òc, &nc->
§
);

2830 ià(
rc
 != 0) {

2831 
	`DBG
(("FaedØİ’†i¡’”: %d", 
rc
));

2832 
	`MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, "failedo open†istener");

2833 
	`mg_de¡roy_cÚn
(
nc
, 1 );

2834  
NULL
;

2836 
	`mg_add_cÚn
(
nc
->
mgr
,‚c);

2838  
nc
;

2839 
	}
}

2841 
mg_cÚÃùiÚ
 *
	$mg_Ãxt
(
mg_mgr
 *
s
, 
mg_cÚÃùiÚ
 *
cÚn
) {

2842  
cÚn
 =ğ
NULL
 ? 
s
->
aùive_cÚÃùiÚs
 : cÚn->
Ãxt
;

2843 
	}
}

2845 #ià
MG_ENABLE_BROADCAST


2846 
	$mg_brßdÿ¡
(
mg_mgr
 *
mgr
, 
mg_ev’t_hªdËr_t
 
cb
, *
d©a
,

2847 
size_t
 
Ën
) {

2848 
ùl_msg
 ctl_msg;

2857 ià(
mgr
->
ùl
[0] !ğ
INVALID_SOCKET
 && 
d©a
 !ğ
NULL
 &&

2858 
Ën
 < (
ùl_msg
.
mes§ge
)) {

2859 
size_t
 
dummy
;

2861 
ùl_msg
.
ÿÎback
 = 
cb
;

2862 
	`memıy
(
ùl_msg
.
mes§ge
, 
d©a
, 
Ën
);

2863 
dummy
 = 
	`MG_SEND_FUNC
(
mgr
->
ùl
[0], (*è&
ùl_msg
,

2864 
	`off£tof
(
ùl_msg
, 
mes§ge
è+ 
Ën
, 0);

2865 
dummy
 = 
	`MG_RECV_FUNC
(
mgr
->
ùl
[0], (*è&
Ën
, 1, 0);

2866 (è
dummy
;

2868 
	}
}

2871 
	$isby‹
(
n
) {

2872  
n
 >= 0 &&‚ <= 255;

2873 
	}
}

2875 
	$·r£_Ãt
(cÚ¡ *
¥ec
, 
ušt32_t
 *
Ãt
, ušt32_ˆ*
mask
) {

2876 
n
, 
a
, 
b
, 
c
, 
d
, 
¦ash
 = 32, 
Ën
 = 0;

2878 ià((
	`ssÿnf
(
¥ec
, "%d.%d.%d.%d/%d%n", &
a
, &
b
, &
c
, &
d
, &
¦ash
, &
n
) == 5 ||

2879 
	`ssÿnf
(
¥ec
, "%d.%d.%d.%d%n", &
a
, &
b
, &
c
, &
d
, &
n
) == 4) &&

2880 
	`isby‹
(
a
è&& isby‹(
b
è&& isby‹(
c
è&& isby‹(
d
è&& 
¦ash
 >= 0 &&

2881 
¦ash
 < 33) {

2882 
Ën
 = 
n
;

2883 *
Ãt
 =

2884 ((
ušt32_t
è
a
 << 24è| ((ušt32_tè
b
 << 16è| ((ušt32_tè
c
 << 8è| 
d
;

2885 *
mask
 = 
¦ash
 ? 0xffffffffU << (32 - slash) : 0;

2888  
Ën
;

2889 
	}
}

2891 
	$mg_check__aş
(cÚ¡ *
aş
, 
ušt32_t
 
»mÙe_
) {

2892 
®lowed
, 
æag
;

2893 
ušt32_t
 
Ãt
, 
mask
;

2894 
mg_¡r
 
vec
;

2897 
®lowed
 = (
aş
 =ğ
NULL
 || *acl == '\0') ? '+' : '-';

2899 (
aş
 = 
	`mg_Ãxt_comma_li¡_’Œy
×ş, &
vec
, 
NULL
)) != NULL) {

2900 
æag
 = 
vec
.
p
[0];

2901 ià((
æag
 != '+' && flag != '-') ||

2902 
	`·r£_Ãt
(&
vec
.
p
[1], &
Ãt
, &
mask
) == 0) {

2906 ià(
Ãt
 =ğ(
»mÙe_
 & 
mask
)) {

2907 
®lowed
 = 
æag
;

2911 
	`DBG
(("%08x %c", 
»mÙe_
, 
®lowed
));

2912  
®lowed
 == '+';

2913 
	}
}

2916 
	$mg_fÜw¬d
(
mg_cÚÃùiÚ
 *
äom
, mg_cÚÃùiÚ *
to
) {

2917 
	`mg_£nd
(
to
, 
äom
->
»cv_mbuf
.
buf
, from->»cv_mbuf.
Ën
);

2918 
	`mbuf_»move
(&
äom
->
»cv_mbuf
, from->»cv_mbuf.
Ën
);

2919 
	}
}

2921 
	$mg_£t_tim”
(
mg_cÚÃùiÚ
 *
c
, 
time¡amp
) {

2922 
»suÉ
 = 
c
->
ev_tim”_time
;

2923 
c
->
ev_tim”_time
 = 
time¡amp
;

2929 
	`DBG
(("%°%°%d -> %lu", 
c
, c->
´iv_2
, c->
æags
 & 
MG_F_RESOLVING
,

2930 (è
time¡amp
));

2931 ià((
c
->
æags
 & 
MG_F_RESOLVING
è&& c->
´iv_2
 !ğ
NULL
) {

2932 ((
mg_cÚÃùiÚ
 *è
c
->
´iv_2
)->
ev_tim”_time
 = 
time¡amp
;

2934  
»suÉ
;

2935 
	}
}

2937 
	$mg_sock_£t
(
mg_cÚÃùiÚ
 *
nc
, 
sock_t
 
sock
) {

2938 ià(
sock
 !ğ
INVALID_SOCKET
) {

2939 
nc
->
içû
->
vbË
->
	`sock_£t
Òc, 
sock
);

2941 
	}
}

2943 
	$mg_if_g‘_cÚn_addr
(
mg_cÚÃùiÚ
 *
nc
, 
»mÙe
,

2944 
sock‘_add»ss
 *
§
) {

2945 
nc
->
içû
->
vbË
->
	`g‘_cÚn_addr
Òc, 
»mÙe
, 
§
);

2946 
	}
}

2948 
mg_cÚÃùiÚ
 *
	$mg_add_sock_İt
(
mg_mgr
 *
s
, 
sock_t
 
sock
,

2949 
mg_ev’t_hªdËr_t
 
ÿÎback
,

2950 
mg_add_sock_İts
 
İts
) {

2951 
mg_cÚÃùiÚ
 *
nc
 = 
	`mg_ü—‹_cÚÃùiÚ_ba£
(
s
, 
ÿÎback
, 
İts
);

2952 ià(
nc
 !ğ
NULL
) {

2953 
	`mg_sock_£t
(
nc
, 
sock
);

2954 
	`mg_add_cÚn
(
nc
->
mgr
,‚c);

2956  
nc
;

2957 
	}
}

2959 
mg_cÚÃùiÚ
 *
	$mg_add_sock
(
mg_mgr
 *
s
, 
sock_t
 
sock
,

2960 
mg_ev’t_hªdËr_t
 
ÿÎback
) {

2961 
mg_add_sock_İts
 
İts
;

2962 
	`mem£t
(&
İts
, 0, (opts));

2963  
	`mg_add_sock_İt
(
s
, 
sock
, 
ÿÎback
, 
İts
);

2964 
	}
}

2966 
	$mg_time
() {

2967  
	`cs_time
();

2968 
	}
}

2969 #ifdeà
MG_MODULE_LINES


2977 #iâdeà
CS_MONGOOSE_SRC_NET_IF_SOCKET_H_


2978 
	#CS_MONGOOSE_SRC_NET_IF_SOCKET_H_


	)

2982 #ifdeà
__ılu¥lus


2986 #iâdeà
MG_ENABLE_NET_IF_SOCKET


2987 
	#MG_ENABLE_NET_IF_SOCKET
 
MG_NET_IF
 =ğ
MG_NET_IF_SOCKET


	)

2990 
mg_içû_vbË
 
mg_sock‘_içû_vbË
;

2992 #ifdeà
__ılu¥lus


2997 #ifdeà
MG_MODULE_LINES


3005 #iâdeà
CS_MONGOOSE_SRC_NET_IF_TUN_H_


3006 
	#CS_MONGOOSE_SRC_NET_IF_TUN_H_


	)

3008 #ià
MG_ENABLE_TUN


3012 
	gmg_tun_ş›Á
;

3014 #ifdeà
__ılu¥lus


3018 
mg_içû_vbË
 
mg_tun_içû_vbË
;

3020 
mg_cÚÃùiÚ
 *
mg_tun_if_fšd_cÚn
(
mg_tun_ş›Á
 *
ş›Á
,

3021 
ušt32_t
 
¡»am_id
);

3023 #ifdeà
__ılu¥lus


3030 #ifdeà
MG_MODULE_LINES


3038 
mg_içû_vbË
 
mg_deçuÉ_içû_vbË
;

3040 #ià
MG_ENABLE_TUN


3041 
mg_içû_vbË
 *
	gmg_içûs
[] = {&
mg_deçuÉ_içû_vbË
,

3042 &
mg_tun_içû_vbË
};

3044 
mg_içû_vbË
 *
	gmg_içûs
[] = {&
mg_deçuÉ_içû_vbË
};

3047 
	gmg_num_içûs
 = (è((
mg_içûs
) / (mg_ifaces[0]));

3049 
mg_içû
 *
	$mg_if_ü—‹_içû
(
mg_içû_vbË
 *
vbË
,

3050 
mg_mgr
 *
mgr
) {

3051 
mg_içû
 *
içû
 = (mg_içû *è
	`MG_CALLOC
(1, (*iface));

3052 
içû
->
mgr
 = mgr;

3053 
içû
->
d©a
 = 
NULL
;

3054 
içû
->
vbË
 = vtable;

3055  
içû
;

3056 
	}
}

3058 
mg_içû
 *
	$mg_fšd_içû
(
mg_mgr
 *
mgr
,

3059 
mg_içû_vbË
 *
vbË
,

3060 
mg_içû
 *
äom
) {

3061 
i
 = 0;

3062 ià(
äom
 !ğ
NULL
) {

3063 
i
 = 0; i < 
mgr
->
num_içûs
; i++) {

3064 ià(
mgr
->
içûs
[
i
] =ğ
äom
) {

3065 
i
++;

3071 ; 
i
 < 
mgr
->
num_içûs
; i++) {

3072 ià(
mgr
->
içûs
[
i
]->
vbË
 == vtable) {

3073  
mgr
->
içûs
[
i
];

3076  
NULL
;

3077 
	}
}

3078 #ifdeà
MG_MODULE_LINES


3086 #ià
MG_ENABLE_NET_IF_SOCKET


3092 
	#MG_TCP_RECV_BUFFER_SIZE
 1024

	)

3093 
	#MG_UDP_RECV_BUFFER_SIZE
 1500

	)

3095 
sock_t
 
mg_İ’_li¡’šg_sock‘
(
sock‘_add»ss
 *
§
, 
ty³
,

3096 
´Ùo
);

3097 #ià
MG_ENABLE_SSL


3098 
mg_s¦_begš
(
mg_cÚÃùiÚ
 *
nc
);

3101 
	$mg_£t_nÚ_blockšg_mode
(
sock_t
 
sock
) {

3102 #ifdeà
_WIN32


3103 
Ú
 = 1;

3104 
	`ioùlsock‘
(
sock
, 
FIONBIO
, &
Ú
);

3106 
æags
 = 
	`fú
(
sock
, 
F_GETFL
, 0);

3107 
	`fú
(
sock
, 
F_SETFL
, 
æags
 | 
O_NONBLOCK
);

3109 
	}
}

3111 
	$mg_is_”rÜ
(
n
) {

3112 
”r
 = 
	`mg_g‘_”ºo
();

3113  (
n
 < 0 && 
”r
 !ğ
EINPROGRESS
 &&ƒ¼ !ğ
EWOULDBLOCK


3114 #iâdeà
WINCE


3115 && 
”r
 !ğ
EAGAIN
 &&ƒ¼ !ğ
EINTR


3117 #ifdeà
_WIN32


3118 && 
	`WSAG‘La¡E¼Ü
(è!ğ
WSAEINTR
 &&

3119 
	`WSAG‘La¡E¼Ü
(è!ğ
WSAEWOULDBLOCK


3122 
	}
}

3124 
	$mg_sock‘_if_cÚÃù_tı
(
mg_cÚÃùiÚ
 *
nc
,

3125 cÚ¡ 
sock‘_add»ss
 *
§
) {

3126 
rc
, 
´Ùo
 = 0;

3127 
nc
->
sock
 = 
	`sock‘
(
AF_INET
, 
SOCK_STREAM
, 
´Ùo
);

3128 ià(
nc
->
sock
 =ğ
INVALID_SOCKET
) {

3129 
nc
->
”r
 = 
	`mg_g‘_”ºo
() ? mg_get_errno() : 1;

3132 #ià!
	`defšed
(
MG_ESP8266
)

3133 
	`mg_£t_nÚ_blockšg_mode
(
nc
->
sock
);

3135 
rc
 = 
	`cÚÃù
(
nc
->
sock
, &
§
->§, (§->
sš
));

3136 
nc
->
”r
 = 
	`mg_is_”rÜ
(
rc
è? 
	`mg_g‘_”ºo
() : 0;

3137 
	`DBG
(("%°sock %d„ø%dƒ¼nØ%dƒ¼ %d", 
nc
,‚c->
sock
, 
rc
, 
	`mg_g‘_”ºo
(),

3138 
nc
->
”r
));

3139 
	}
}

3141 
	$mg_sock‘_if_cÚÃù_udp
(
mg_cÚÃùiÚ
 *
nc
) {

3142 
nc
->
sock
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

3143 ià(
nc
->
sock
 =ğ
INVALID_SOCKET
) {

3144 
nc
->
”r
 = 
	`mg_g‘_”ºo
() ? mg_get_errno() : 1;

3147 ià(
nc
->
æags
 & 
MG_F_ENABLE_BROADCAST
) {

3148 
İtv®
 = 1;

3149 
	`£tsockİt
(
nc
->
sock
, 
SOL_SOCKET
, 
SO_BROADCAST
, (cÚ¡ *è&
İtv®
,

3150 (
İtv®
));

3152 
nc
->
”r
 = 0;

3153 
	}
}

3155 
	$mg_sock‘_if_li¡’_tı
(
mg_cÚÃùiÚ
 *
nc
,

3156 
sock‘_add»ss
 *
§
) {

3157 
´Ùo
 = 0;

3158 
sock_t
 
sock
 = 
	`mg_İ’_li¡’šg_sock‘
(
§
, 
SOCK_STREAM
, 
´Ùo
);

3159 ià(
sock
 =ğ
INVALID_SOCKET
) {

3160  (
	`mg_g‘_”ºo
() ? mg_get_errno() : 1);

3162 
	`mg_sock_£t
(
nc
, 
sock
);

3164 
	}
}

3166 
	$mg_sock‘_if_li¡’_udp
(
mg_cÚÃùiÚ
 *
nc
,

3167 
sock‘_add»ss
 *
§
) {

3168 
sock_t
 
sock
 = 
	`mg_İ’_li¡’šg_sock‘
(
§
, 
SOCK_DGRAM
, 0);

3169 ià(
sock
 =ğ
INVALID_SOCKET
è (
	`mg_g‘_”ºo
() ? mg_get_errno() : 1);

3170 
	`mg_sock_£t
(
nc
, 
sock
);

3172 
	}
}

3174 
	$mg_sock‘_if_tı_£nd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
,

3175 
size_t
 
Ën
) {

3176 
	`mbuf_­³nd
(&
nc
->
£nd_mbuf
, 
buf
, 
Ën
);

3177 
	}
}

3179 
	$mg_sock‘_if_udp_£nd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
,

3180 
size_t
 
Ën
) {

3181 
	`mbuf_­³nd
(&
nc
->
£nd_mbuf
, 
buf
, 
Ën
);

3182 
	}
}

3184 
	$mg_sock‘_if_»cved
(
mg_cÚÃùiÚ
 *
nc
, 
size_t
 
Ën
) {

3185 (è
nc
;

3186 (è
Ën
;

3187 
	}
}

3189 
	$mg_sock‘_if_ü—‹_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

3190 (è
nc
;

3192 
	}
}

3194 
	$mg_sock‘_if_de¡roy_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

3195 ià(
nc
->
sock
 =ğ
INVALID_SOCKET
) ;

3196 ià(!(
nc
->
æags
 & 
MG_F_UDP
)) {

3197 
	`şo£sock‘
(
nc
->
sock
);

3200 ià(
nc
->
li¡’”
 =ğ
NULL
è
	`şo£sock‘
Òc->
sock
);

3202 
nc
->
sock
 = 
INVALID_SOCKET
;

3203 
	}
}

3205 
	$mg_acû±_cÚn
(
mg_cÚÃùiÚ
 *
lc
) {

3206 
mg_cÚÃùiÚ
 *
nc
;

3207 
sock‘_add»ss
 
§
;

3208 
sockËn_t
 
§_Ën
 = (
§
);

3210 
sock_t
 
sock
 = 
	`acû±
(
lc
->sock, &
§
.§, &
§_Ën
);

3211 ià(
sock
 =ğ
INVALID_SOCKET
) {

3212 ià(
	`mg_is_”rÜ
(-1)è
	`DBG
(("%p: faedØacû±: %d", 
lc
, 
	`mg_g‘_”ºo
()));

3215 
nc
 = 
	`mg_if_acû±_Ãw_cÚn
(
lc
);

3216 ià(
nc
 =ğ
NULL
) {

3217 
	`şo£sock‘
(
sock
);

3220 
	`DBG
(("%°cÚÀäom %s:%d", 
nc
, 
	`š‘_Áß
(
§
.
sš
.
sš_addr
),

3221 
	`Áohs
(
§
.
sš
.
sš_pÜt
)));

3222 
	`mg_sock_£t
(
nc
, 
sock
);

3223 #ià
MG_ENABLE_SSL


3224 ià(
lc
->
æags
 & 
MG_F_SSL
) {

3225 ià(
	`mg_s¦_if_cÚn_acû±
(
nc
, 
lc
è!ğ
MG_SSL_OK
è
	`mg_şo£_cÚn
(nc);

3229 
	`mg_if_acû±_tı_cb
(
nc
, &
§
, 
§_Ën
);

3232 
	}
}

3235 
sock_t
 
	$mg_İ’_li¡’šg_sock‘
(
sock‘_add»ss
 *
§
, 
ty³
,

3236 
´Ùo
) {

3237 
sockËn_t
 
§_Ën
 =

3238 (
§
->§.
§_çmy
 =ğ
AF_INET
è? (§->
sš
è: (§->
sš6
);

3239 
sock_t
 
sock
 = 
INVALID_SOCKET
;

3240 #ià!
MG_LWIP


3241 
Ú
 = 1;

3243 ià((
sock
 = 
	`sock‘
(
§
->§.
§_çmy
, 
ty³
, 
´Ùo
)è!ğ
INVALID_SOCKET
 &&

3244 #ià!
MG_LWIP


3245 #ià
	`defšed
(
_WIN32
è&& defšed(
SO_EXCLUSIVEADDRUSE
è&& !defšed(
WINCE
)

3247 !
	`£tsockİt
(
sock
, 
SOL_SOCKET
, 
SO_EXCLUSIVEADDRUSE
, (*è&
Ú
,

3248 (
Ú
)) &&

3251 #ià!
	`defšed
(
_WIN32
è|| !defšed(
SO_EXCLUSIVEADDRUSE
)

3261 !
	`£tsockİt
(
sock
, 
SOL_SOCKET
, 
SO_REUSEADDR
, (*è&
Ú
, (on)) &&

3264 !
	`bšd
(
sock
, &
§
->§, 
§_Ën
) &&

3265 (
ty³
 =ğ
SOCK_DGRAM
 || 
	`li¡’
(
sock
, 
SOMAXCONN
) == 0)) {

3266 #ià!
MG_LWIP


3267 
	`mg_£t_nÚ_blockšg_mode
(
sock
);

3269 (è
	`g‘sockÇme
(
sock
, &
§
->§, &
§_Ën
);

3272 } ià(
sock
 !ğ
INVALID_SOCKET
) {

3273 
	`şo£sock‘
(
sock
);

3274 
sock
 = 
INVALID_SOCKET
;

3277  
sock
;

3278 
	}
}

3280 
	$mg_wr™e_to_sock‘
(
mg_cÚÃùiÚ
 *
nc
) {

3281 
mbuf
 *
io
 = &
nc
->
£nd_mbuf
;

3282 
n
 = 0;

3284 #ià
MG_LWIP


3286 ià(
io
->
Ën
 == 0) ;

3289 
	`as£¹
(
io
->
Ën
 > 0);

3291 ià(
nc
->
æags
 & 
MG_F_UDP
) {

3292 
n
 =

3293 
	`£ndto
(
nc
->
sock
, 
io
->
buf
, io->
Ën
, 0, &nc->
§
.§, Òc->§.
sš
));

3294 
	`DBG
(("%°%d %d %d %s:%hu", 
nc
,‚c->
sock
, 
n
, 
	`mg_g‘_”ºo
(),

3295 
	`š‘_Áß
(
nc
->
§
.
sš
.
sš_addr
), 
	`Áohs
Òc->§.sš.
sš_pÜt
)));

3296 ià(
n
 > 0) {

3297 
	`mbuf_»move
(
io
, 
n
);

3298 
	`mg_if_£Á_cb
(
nc
, 
n
);

3303 #ià
MG_ENABLE_SSL


3304 ià(
nc
->
æags
 & 
MG_F_SSL
) {

3305 ià(
nc
->
æags
 & 
MG_F_SSL_HANDSHAKE_DONE
) {

3306 
n
 = 
	`mg_s¦_if_wr™e
(
nc
, 
io
->
buf
, io->
Ën
);

3307 
	`DBG
(("%°%d by‹ -> %d (SSL)", 
nc
, 
n
,‚c->
sock
));

3308 ià(
n
 < 0) {

3309 ià(
n
 !ğ
MG_SSL_WANT_READ
 &&‚ !ğ
MG_SSL_WANT_WRITE
) {

3310 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

3315 
nc
->
æags
 &ğ~(
MG_F_WANT_READ
 | 
MG_F_WANT_WRITE
);

3318 
	`mg_s¦_begš
(
nc
);

3327 
n
 = (è
	`MG_SEND_FUNC
(
nc
->
sock
, 
io
->
buf
, io->
Ën
, 0);

3329 
	`DBG
(("%°%d by‹ -> %d", 
nc
, 
n
,‚c->
sock
));

3330 ià(
n
 < 0 && 
	`mg_is_”rÜ
(n)) {

3332 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

3337 ià(
n
 > 0) {

3338 
	`mbuf_»move
(
io
, 
n
);

3339 
	`mg_if_£Á_cb
(
nc
, 
n
);

3341 
	}
}

3343 
MG_INTERNAL
 
size_t
 
	$»cv_ava_size
(
mg_cÚÃùiÚ
 *
cÚn
, 
size_t
 
max
) {

3344 
size_t
 
ava
;

3345 ià(
cÚn
->
»cv_mbuf_lim™
 < cÚn->
»cv_mbuf
.
Ën
)  0;

3346 
ava
 = 
cÚn
->
»cv_mbuf_lim™
 - cÚn->
»cv_mbuf
.
Ën
;

3347  
ava
 > 
max
 ? max :‡vail;

3348 
	}
}

3350 
	$mg_hªdË_tı_»ad
(
mg_cÚÃùiÚ
 *
cÚn
) {

3351 
n
 = 0;

3352 *
buf
 = (*è
	`MG_MALLOC
(
MG_TCP_RECV_BUFFER_SIZE
);

3354 ià(
buf
 =ğ
NULL
) {

3355 
	`DBG
(("OOM"));

3359 #ià
MG_ENABLE_SSL


3360 ià(
cÚn
->
æags
 & 
MG_F_SSL
) {

3361 ià(
cÚn
->
æags
 & 
MG_F_SSL_HANDSHAKE_DONE
) {

3365 (
n
 = 
	`mg_s¦_if_»ad
(
cÚn
, 
buf
, 
MG_TCP_RECV_BUFFER_SIZE
)) > 0) {

3366 
	`DBG
(("%°%d by‹ <- %d (SSL)", 
cÚn
, 
n
, cÚn->
sock
));

3367 
	`mg_if_»cv_tı_cb
(
cÚn
, 
buf
, 
n
, 1 );

3368 
buf
 = 
NULL
;

3369 ià(
cÚn
->
æags
 & 
MG_F_CLOSE_IMMEDIATELY
) ;

3371 
buf
 = (*è
	`MG_MALLOC
(
MG_TCP_RECV_BUFFER_SIZE
);

3372 ià(
buf
 =ğ
NULL
) ;

3374 
	`MG_FREE
(
buf
);

3375 ià(
n
 < 0 &&‚ !ğ
MG_SSL_WANT_READ
è
cÚn
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

3377 
	`MG_FREE
(
buf
);

3378 
	`mg_s¦_begš
(
cÚn
);

3384 
n
 = (è
	`MG_RECV_FUNC
(
cÚn
->
sock
, 
buf
,

3385 
	`»cv_ava_size
(
cÚn
, 
MG_TCP_RECV_BUFFER_SIZE
), 0);

3388 
	`DBG
(("%°%d by‹ (PLAINè<- %d", 
cÚn
, 
n
, cÚn->
sock
));

3389 ià(
n
 > 0) {

3390 
	`mg_if_»cv_tı_cb
(
cÚn
, 
buf
, 
n
, 1 );

3392 
	`MG_FREE
(
buf
);

3394 ià(
n
 == 0) {

3396 
cÚn
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

3397 } ià(
	`mg_is_”rÜ
(
n
)) {

3398 
cÚn
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

3401 
	}
}

3403 
	$mg_»cväom
(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
,

3404 
sockËn_t
 *
§_Ën
, **
buf
) {

3405 
n
;

3406 *
buf
 = (*è
	`MG_MALLOC
(
MG_UDP_RECV_BUFFER_SIZE
);

3407 ià(*
buf
 =ğ
NULL
) {

3408 
	`DBG
(("Out of memory"));

3409  -
ENOMEM
;

3411 
n
 = 
	`»cväom
(
nc
->
sock
, *
buf
, 
MG_UDP_RECV_BUFFER_SIZE
, 0, &
§
->§, 
§_Ën
);

3414 ià(
n
 <= 0) {

3415 
	`DBG
(("%°»cväom: %s", 
nc
, 
	`¡»¼Ü
(
	`mg_g‘_”ºo
())));

3416 
	`MG_FREE
(*
buf
);

3418  
n
;

3419 
	}
}

3421 
	$mg_hªdË_udp_»ad
(
mg_cÚÃùiÚ
 *
nc
) {

3422 *
buf
 = 
NULL
;

3423 
sock‘_add»ss
 
§
;

3424 
sockËn_t
 
§_Ën
 = (
§
);

3425 
n
 = 
	`mg_»cväom
(
nc
, &
§
, &
§_Ën
, &
buf
);

3426 
	`DBG
(("%°%d by‹ äom %s:%d", 
nc
, 
n
, 
	`š‘_Áß
Òc->
§
.
sš
.
sš_addr
),

3427 
	`Áohs
(
nc
->
§
.
sš
.
sš_pÜt
)));

3428 
	`mg_if_»cv_udp_cb
(
nc
, 
buf
, 
n
, &
§
, 
§_Ën
);

3429 
	}
}

3431 #ià
MG_ENABLE_SSL


3432 
	$mg_s¦_begš
(
mg_cÚÃùiÚ
 *
nc
) {

3433 
£rv”_side
 = (
nc
->
li¡’”
 !ğ
NULL
);

3434 
mg_s¦_if_»suÉ
 
»s
 = 
	`mg_s¦_if_hªdshake
(
nc
);

3435 
	`DBG
(("%°%d„e %d", 
nc
, 
£rv”_side
, 
»s
));

3437 ià(
»s
 =ğ
MG_SSL_OK
) {

3438 
nc
->
æags
 |ğ
MG_F_SSL_HANDSHAKE_DONE
;

3439 
nc
->
æags
 &ğ~(
MG_F_WANT_READ
 | 
MG_F_WANT_WRITE
);

3441 ià(
£rv”_side
) {

3442 
sock‘_add»ss
 
§
;

3443 
sockËn_t
 
§_Ën
 = (
§
);

3444 (è
	`g‘³”Çme
(
nc
->
sock
, &
§
.§, &
§_Ën
);

3445 
	`mg_if_acû±_tı_cb
(
nc
, &
§
, 
§_Ën
);

3447 
	`mg_if_cÚÃù_cb
(
nc
, 0);

3449 } ià(
»s
 !ğ
MG_SSL_WANT_READ
 &&„e !ğ
MG_SSL_WANT_WRITE
) {

3450 ià(!
£rv”_side
) {

3451 
	`mg_if_cÚÃù_cb
(
nc
, 
»s
);

3453 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

3455 
	}
}

3458 
	#_MG_F_FD_CAN_READ
 1

	)

3459 
	#_MG_F_FD_CAN_WRITE
 1 << 1

	)

3460 
	#_MG_F_FD_ERROR
 1 << 2

	)

3462 
	$mg_mgr_hªdË_cÚn
(
mg_cÚÃùiÚ
 *
nc
, 
fd_æags
, 
now
) {

3463 
wÜth_loggšg
 =

3464 
fd_æags
 !ğ0 || (
nc
->
æags
 & (
MG_F_WANT_READ
 | 
MG_F_WANT_WRITE
));

3465 ià(
wÜth_loggšg
) {

3466 
	`DBG
(("%°fd=%d fd_æags=%d‚c_æags=%lu„mbl=%d smbl=%d", 
nc
,‚c->
sock
,

3467 
fd_æags
, 
nc
->
æags
, (ènc->
»cv_mbuf
.
Ën
,

3468 (è
nc
->
£nd_mbuf
.
Ën
));

3471 ià(
nc
->
æags
 & 
MG_F_CONNECTING
) {

3472 ià(
fd_æags
 != 0) {

3473 
”r
 = 0;

3474 #ià!
	`defšed
(
MG_ESP8266
)

3475 ià(!(
nc
->
æags
 & 
MG_F_UDP
)) {

3476 
sockËn_t
 
Ën
 = (
”r
);

3477 
»t
 =

3478 
	`g‘sockİt
(
nc
->
sock
, 
SOL_SOCKET
, 
SO_ERROR
, (*è&
”r
, &
Ën
);

3479 ià(
»t
 != 0) {

3480 
”r
 = 1;

3481 } ià(
”r
 =ğ
EAGAIN
 ||ƒ¼ =ğ
EWOULDBLOCK
) {

3482 
”r
 = 0;

3489 
”r
 = 
nc
->err;

3491 #ià
MG_ENABLE_SSL


3492 ià((
nc
->
æags
 & 
MG_F_SSL
è&& 
”r
 == 0) {

3493 
	`mg_s¦_begš
(
nc
);

3495 
	`mg_if_cÚÃù_cb
(
nc
, 
”r
);

3498 
	`mg_if_cÚÃù_cb
(
nc
, 
”r
);

3500 } ià(
nc
->
”r
 != 0) {

3501 
	`mg_if_cÚÃù_cb
(
nc
,‚c->
”r
);

3505 ià(
fd_æags
 & 
_MG_F_FD_CAN_READ
) {

3506 ià(
nc
->
æags
 & 
MG_F_UDP
) {

3507 
	`mg_hªdË_udp_»ad
(
nc
);

3509 ià(
nc
->
æags
 & 
MG_F_LISTENING
) {

3515 
	`mg_acû±_cÚn
(
nc
);

3517 
	`mg_hªdË_tı_»ad
(
nc
);

3522 ià(!(
nc
->
æags
 & 
MG_F_CLOSE_IMMEDIATELY
)) {

3523 ià((
fd_æags
 & 
_MG_F_FD_CAN_WRITE
è&& 
nc
->
£nd_mbuf
.
Ën
 > 0) {

3524 
	`mg_wr™e_to_sock‘
(
nc
);

3526 
	`mg_if_pŞl
(
nc
, (
time_t
è
now
);

3527 
	`mg_if_tim”
(
nc
, 
now
);

3530 ià(
wÜth_loggšg
) {

3531 
	`DBG
(("%°aá” fd=%d‚c_æags=%lu„mbl=%d smbl=%d", 
nc
,‚c->
sock
,‚c->
æags
,

3532 (è
nc
->
»cv_mbuf
.
Ën
, (ènc->
£nd_mbuf
.len));

3534 
	}
}

3536 #ià
MG_ENABLE_BROADCAST


3537 
	$mg_mgr_hªdË_ùl_sock
(
mg_mgr
 *
mgr
) {

3538 
ùl_msg
 ctl_msg;

3539 
Ën
 =

3540 (è
	`MG_RECV_FUNC
(
mgr
->
ùl
[1], (*è&
ùl_msg
, (ctl_msg), 0);

3541 
size_t
 
dummy
 = 
	`MG_SEND_FUNC
(
mgr
->
ùl
[1], 
ùl_msg
.
mes§ge
, 1, 0);

3542 
	`DBG
(("»ad %d from c sock‘", 
Ën
));

3543 (è
dummy
;

3544 ià(
Ën
 >ğ(è(
ùl_msg
.
ÿÎback
è&& c_msg.ÿÎback !ğ
NULL
) {

3545 
mg_cÚÃùiÚ
 *
nc
;

3546 
nc
 = 
	`mg_Ãxt
(
mgr
, 
NULL
);‚c != NULL;‚c = mg_next(mgr,‚c)) {

3547 
ùl_msg
.
	`ÿÎback
(
nc
, 
MG_EV_POLL
, c_msg.
mes§ge
);

3550 
	}
}

3554 
	$mg_sock‘_if_sock_£t
(
mg_cÚÃùiÚ
 *
nc
, 
sock_t
 
sock
) {

3555 
	`mg_£t_nÚ_blockšg_mode
(
sock
);

3556 
	`mg_£t_şo£_Ú_exec
(
sock
);

3557 
nc
->
sock
 = sock;

3558 
	`DBG
(("%°%d", 
nc
, 
sock
));

3559 
	}
}

3561 
	$mg_sock‘_if_š™
(
mg_içû
 *
içû
) {

3562 (è
içû
;

3563 
	`DBG
(("%°usšg s–eù()", 
içû
->
mgr
));

3564 #ià
MG_ENABLE_BROADCAST


3566 
	`mg_sock‘·œ
(
içû
->
mgr
->
ùl
, 
SOCK_DGRAM
);

3567 } 
içû
->
mgr
->
ùl
[0] =ğ
INVALID_SOCKET
);

3569 
	}
}

3571 
	$mg_sock‘_if_ä“
(
mg_içû
 *
içû
) {

3572 (è
içû
;

3573 
	}
}

3575 
	$mg_sock‘_if_add_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

3576 (è
nc
;

3577 
	}
}

3579 
	$mg_sock‘_if_»move_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

3580 (è
nc
;

3581 
	}
}

3583 
	$mg_add_to_£t
(
sock_t
 
sock
, 
fd_£t
 *
£t
, sock_ˆ*
max_fd
) {

3584 ià(
sock
 !ğ
INVALID_SOCKET


3585 #ifdeà
__unix__


3586 && 
sock
 < (
sock_t
è
FD_SETSIZE


3589 
	`FD_SET
(
sock
, 
£t
);

3590 ià(*
max_fd
 =ğ
INVALID_SOCKET
 || 
sock
 > *max_fd) {

3591 *
max_fd
 = 
sock
;

3594 
	}
}

3596 
time_t
 
	$mg_sock‘_if_pŞl
(
mg_içû
 *
içû
, 
timeout_ms
) {

3597 
mg_mgr
 *
mgr
 = 
içû
->mgr;

3598 
now
 = 
	`mg_time
();

3599 
mš_tim”
;

3600 
mg_cÚÃùiÚ
 *
nc
, *
tmp
;

3601 
timev®
 
tv
;

3602 
fd_£t
 
»ad_£t
, 
wr™e_£t
, 
”r_£t
;

3603 
sock_t
 
max_fd
 = 
INVALID_SOCKET
;

3604 
num_fds
, 
num_ev
, 
num_tim”s
 = 0;

3605 #ifdeà
__unix__


3606 
Œy_dup
 = 1;

3609 
	`FD_ZERO
(&
»ad_£t
);

3610 
	`FD_ZERO
(&
wr™e_£t
);

3611 
	`FD_ZERO
(&
”r_£t
);

3612 #ià
MG_ENABLE_BROADCAST


3613 
	`mg_add_to_£t
(
mgr
->
ùl
[1], &
»ad_£t
, &
max_fd
);

3620 
mš_tim”
 = 0;

3621 
nc
 = 
mgr
->
aùive_cÚÃùiÚs
, 
num_fds
 = 0;‚ø!ğ
NULL
;‚øğ
tmp
) {

3622 
tmp
 = 
nc
->
Ãxt
;

3624 ià(
nc
->
sock
 !ğ
INVALID_SOCKET
) {

3625 
num_fds
++;

3627 #ifdeà
__unix__


3629 ià(
nc
->
sock
 >ğ(
sock_t
è
FD_SETSIZE
 && 
Œy_dup
) {

3630 
Ãw_sock
 = 
	`dup
(
nc
->
sock
);

3631 ià(
Ãw_sock
 >ğ0 &&‚ew_sock < (
sock_t
è
FD_SETSIZE
) {

3632 
	`şo£sock‘
(
nc
->
sock
);

3633 
	`DBG
(("Ãw sock %d -> %d", 
nc
->
sock
, 
Ãw_sock
));

3634 
nc
->
sock
 = 
Ãw_sock
;

3636 
Œy_dup
 = 0;

3641 ià(!(
nc
->
æags
 & 
MG_F_WANT_WRITE
) &&

3642 
nc
->
»cv_mbuf
.
Ën
 <‚c->
»cv_mbuf_lim™
 &&

3643 (!(
nc
->
æags
 & 
MG_F_UDP
è||‚c->
li¡’”
 =ğ
NULL
)) {

3644 
	`mg_add_to_£t
(
nc
->
sock
, &
»ad_£t
, &
max_fd
);

3647 ià(((
nc
->
æags
 & 
MG_F_CONNECTING
è&& !Òc->æag & 
MG_F_WANT_READ
)) ||

3648 (
nc
->
£nd_mbuf
.
Ën
 > 0 && !Òc->
æags
 & 
MG_F_CONNECTING
))) {

3649 
	`mg_add_to_£t
(
nc
->
sock
, &
wr™e_£t
, &
max_fd
);

3650 
	`mg_add_to_£t
(
nc
->
sock
, &
”r_£t
, &
max_fd
);

3654 ià(
nc
->
ev_tim”_time
 > 0) {

3655 ià(
num_tim”s
 =ğ0 || 
nc
->
ev_tim”_time
 < 
mš_tim”
) {

3656 
mš_tim”
 = 
nc
->
ev_tim”_time
;

3658 
num_tim”s
++;

3666 ià(
num_tim”s
 > 0) {

3667 
tim”_timeout_ms
 = (
mš_tim”
 - 
	`mg_time
()) * 1000 + 1 ;

3668 ià(
tim”_timeout_ms
 < 
timeout_ms
) {

3669 
timeout_ms
 = (è
tim”_timeout_ms
;

3672 ià(
timeout_ms
 < 0)imeout_ms = 0;

3674 
tv
.
tv_£c
 = 
timeout_ms
 / 1000;

3675 
tv
.
tv_u£c
 = (
timeout_ms
 % 1000) * 1000;

3677 
num_ev
 = 
	`£Ëù
((è
max_fd
 + 1, &
»ad_£t
, &
wr™e_£t
, &
”r_£t
, &
tv
);

3679 
now
 = 
	`mg_time
();

3681 
	`DBG
(("£Ëù @ %ld‚um_ev=%d oà%d,imeout=%d", (è
now
, 
num_ev
, 
num_fds
,

3682 
timeout_ms
));

3685 #ià
MG_ENABLE_BROADCAST


3686 ià(
num_ev
 > 0 && 
mgr
->
ùl
[1] !ğ
INVALID_SOCKET
 &&

3687 
	`FD_ISSET
(
mgr
->
ùl
[1], &
»ad_£t
)) {

3688 
	`mg_mgr_hªdË_ùl_sock
(
mgr
);

3692 
nc
 = 
mgr
->
aùive_cÚÃùiÚs
;‚ø!ğ
NULL
;‚øğ
tmp
) {

3693 
fd_æags
 = 0;

3694 ià(
nc
->
sock
 !ğ
INVALID_SOCKET
) {

3695 ià(
num_ev
 > 0) {

3696 
fd_æags
 = (
	`FD_ISSET
(
nc
->
sock
, &
»ad_£t
) &&

3697 (!(
nc
->
æags
 & 
MG_F_UDP
è||‚c->
li¡’”
 =ğ
NULL
)

3698 ? 
_MG_F_FD_CAN_READ


3700 (
	`FD_ISSET
(
nc
->
sock
, &
wr™e_£t
è? 
_MG_F_FD_CAN_WRITE
 : 0) |

3701 (
	`FD_ISSET
(
nc
->
sock
, &
”r_£t
è? 
_MG_F_FD_ERROR
 : 0);

3703 #ià
MG_LWIP


3705 ià((
nc
->
æags
 & 
MG_F_UDP
è&&‚c->
li¡’”
 =ğ
NULL
) {

3706 
fd_æags
 |ğ
_MG_F_FD_CAN_WRITE
;

3710 
tmp
 = 
nc
->
Ãxt
;

3711 
	`mg_mgr_hªdË_cÚn
(
nc
, 
fd_æags
, 
now
);

3714 
nc
 = 
mgr
->
aùive_cÚÃùiÚs
;‚ø!ğ
NULL
;‚øğ
tmp
) {

3715 
tmp
 = 
nc
->
Ãxt
;

3716 ià((
nc
->
æags
 & 
MG_F_CLOSE_IMMEDIATELY
) ||

3717 (
nc
->
£nd_mbuf
.
Ën
 =ğ0 && (nc->
æags
 & 
MG_F_SEND_AND_CLOSE
))) {

3718 
	`mg_şo£_cÚn
(
nc
);

3722  (
time_t
è
now
;

3723 
	}
}

3725 #ià
MG_ENABLE_BROADCAST


3726 
	$mg_sock‘·œ
(
sock_t
 
¥
[2], 
sock_ty³
) {

3727 
sock‘_add»ss
 
§
;

3728 
sock_t
 
sock
;

3729 
sockËn_t
 
Ën
 = (
§
.
sš
);

3730 
»t
 = 0;

3732 
sock
 = 
¥
[0] = sp[1] = 
INVALID_SOCKET
;

3734 (è
	`mem£t
(&
§
, 0, (sa));

3735 
§
.
sš
.
sš_çmy
 = 
AF_INET
;

3736 
§
.
sš
.
sš_pÜt
 = 
	`htÚs
(0);

3737 
§
.
sš
.
sš_addr
.
s_addr
 = 
	`htÚl
(0x7f000001);

3739 ià((
sock
 = 
	`sock‘
(
AF_INET
, 
sock_ty³
, 0)è=ğ
INVALID_SOCKET
) {

3740 } ià(
	`bšd
(
sock
, &
§
.§, 
Ën
) != 0) {

3741 } ià(
sock_ty³
 =ğ
SOCK_STREAM
 && 
	`li¡’
(
sock
, 1) != 0) {

3742 } ià(
	`g‘sockÇme
(
sock
, &
§
.§, &
Ën
) != 0) {

3743 } ià((
¥
[0] = 
	`sock‘
(
AF_INET
, 
sock_ty³
, 0)è=ğ
INVALID_SOCKET
) {

3744 } ià(
	`cÚÃù
(
¥
[0], &
§
.§, 
Ën
) != 0) {

3745 } ià(
sock_ty³
 =ğ
SOCK_DGRAM
 &&

3746 (
	`g‘sockÇme
(
¥
[0], &
§
.§, &
Ën
) != 0 ||

3747 
	`cÚÃù
(
sock
, &
§
.§, 
Ën
) != 0)) {

3748 } ià((
¥
[1] = (
sock_ty³
 =ğ
SOCK_DGRAM
 ? 
sock


3749 : 
	`acû±
(
sock
, &
§
.§, &
Ën
))) ==

3750 
INVALID_SOCKET
) {

3752 
	`mg_£t_şo£_Ú_exec
(
¥
[0]);

3753 
	`mg_£t_şo£_Ú_exec
(
¥
[1]);

3754 ià(
sock_ty³
 =ğ
SOCK_STREAM
è
	`şo£sock‘
(
sock
);

3755 
»t
 = 1;

3758 ià(!
»t
) {

3759 ià(
¥
[0] !ğ
INVALID_SOCKET
è
	`şo£sock‘
(sp[0]);

3760 ià(
¥
[1] !ğ
INVALID_SOCKET
è
	`şo£sock‘
(sp[1]);

3761 ià(
sock
 !ğ
INVALID_SOCKET
è
	`şo£sock‘
(sock);

3762 
sock
 = 
¥
[0] = sp[1] = 
INVALID_SOCKET
;

3765  
»t
;

3766 
	}
}

3769 
	$mg_sock_g‘_addr
(
sock_t
 
sock
, 
»mÙe
,

3770 
sock‘_add»ss
 *
§
) {

3771 
sockËn_t
 
¦’
 = (*
§
);

3772 
	`mem£t
(
§
, 0, 
¦’
);

3773 ià(
»mÙe
) {

3774 
	`g‘³”Çme
(
sock
, &
§
->§, &
¦’
);

3776 
	`g‘sockÇme
(
sock
, &
§
->§, &
¦’
);

3778 
	}
}

3780 
	$mg_sock_to_¡r
(
sock_t
 
sock
, *
buf
, 
size_t
 
Ën
, 
æags
) {

3781 
sock‘_add»ss
 
§
;

3782 
	`mg_sock_g‘_addr
(
sock
, 
æags
 & 
MG_SOCK_STRINGIFY_REMOTE
, &
§
);

3783 
	`mg_sock_addr_to_¡r
(&
§
, 
buf
, 
Ën
, 
æags
);

3784 
	}
}

3786 
	$mg_sock‘_if_g‘_cÚn_addr
(
mg_cÚÃùiÚ
 *
nc
, 
»mÙe
,

3787 
sock‘_add»ss
 *
§
) {

3788 
	`mg_sock_g‘_addr
(
nc
->
sock
, 
»mÙe
, 
§
);

3789 
	}
}

3792 
	#MG_SOCKET_IFACE_VTABLE
 \

3794 
mg_sock‘_if_š™
, \

3795 
mg_sock‘_if_ä“
, \

3796 
mg_sock‘_if_add_cÚn
, \

3797 
mg_sock‘_if_»move_cÚn
, \

3798 
mg_sock‘_if_pŞl
, \

3799 
mg_sock‘_if_li¡’_tı
, \

3800 
mg_sock‘_if_li¡’_udp
, \

3801 
mg_sock‘_if_cÚÃù_tı
, \

3802 
mg_sock‘_if_cÚÃù_udp
, \

3803 
mg_sock‘_if_tı_£nd
, \

3804 
mg_sock‘_if_udp_£nd
, \

3805 
mg_sock‘_if_»cved
, \

3806 
mg_sock‘_if_ü—‹_cÚn
, \

3807 
mg_sock‘_if_de¡roy_cÚn
, \

3808 
mg_sock‘_if_sock_£t
, \

3809 
mg_sock‘_if_g‘_cÚn_addr
, \

3810 }

	)

3813 
mg_içû_vbË
 
	gmg_sock‘_içû_vbË
 = 
MG_SOCKET_IFACE_VTABLE
;

3814 #ià
MG_NET_IF
 =ğ
MG_NET_IF_SOCKET


3815 
mg_içû_vbË
 
	gmg_deçuÉ_içû_vbË
 = 
MG_SOCKET_IFACE_VTABLE
;

3819 #ifdeà
MG_MODULE_LINES


3827 #ià
MG_ENABLE_TUN


3836 
	#MG_TCP_RECV_BUFFER_SIZE
 1024

	)

3837 
	#MG_UDP_RECV_BUFFER_SIZE
 1500

	)

3839 
	$mg_tun_if_cÚÃù_tı
(
mg_cÚÃùiÚ
 *
nc
,

3840 cÚ¡ 
sock‘_add»ss
 *
§
) {

3841 (è
nc
;

3842 (è
§
;

3843 
	}
}

3845 
	$mg_tun_if_cÚÃù_udp
(
mg_cÚÃùiÚ
 *
nc
) {

3846 (è
nc
;

3847 
	}
}

3849 
	$mg_tun_if_li¡’_tı
(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
) {

3850 (è
nc
;

3851 (è
§
;

3853 
	}
}

3855 
	$mg_tun_if_li¡’_udp
(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
) {

3856 (è
nc
;

3857 (è
§
;

3859 
	}
}

3861 
	$mg_tun_if_tı_£nd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

3862 
mg_tun_ş›Á
 *
ş›Á
 = (mg_tun_ş›Á *è
nc
->
içû
->
d©a
;

3863 
ušt32_t
 
¡»am_id
 = (ušt32_t)(
ušŒ_t
è
nc
->
mgr_d©a
;

3864 
mg_¡r
 
msg
 = {(*è
buf
, 
Ën
};

3865 #ià
MG_ENABLE_HEXDUMP


3866 
hex
[512];

3867 
	`mg_hexdump
(
buf
, 
Ën
, 
hex
, (hex));

3868 
	`LOG
(
LL_DEBUG
, ("£ndšgØ¡»am %zu:\n%s", 
¡»am_id
, 
hex
));

3871 
	`mg_tun_£nd_äame
(
ş›Á
->
di¥
, 
¡»am_id
, 
MG_TUN_DATA_FRAME
, 0, 
msg
);

3872 
	}
}

3874 
	$mg_tun_if_udp_£nd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

3875 (è
nc
;

3876 (è
buf
;

3877 (è
Ën
;

3878 
	}
}

3880 
	$mg_tun_if_»cved
(
mg_cÚÃùiÚ
 *
nc
, 
size_t
 
Ën
) {

3881 (è
nc
;

3882 (è
Ën
;

3883 
	}
}

3885 
	$mg_tun_if_ü—‹_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

3886 (è
nc
;

3888 
	}
}

3890 
	$mg_tun_if_de¡roy_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

3891 
mg_tun_ş›Á
 *
ş›Á
 = (mg_tun_ş›Á *è
nc
->
içû
->
d©a
;

3893 ià(
nc
->
æags
 & 
MG_F_LISTENING
) {

3894 
	`mg_tun_de¡roy_ş›Á
(
ş›Á
);

3895 } ià(
ş›Á
->
di¥
) {

3896 
ušt32_t
 
¡»am_id
 = (ušt32_t)(
ušŒ_t
è
nc
->
mgr_d©a
;

3897 
mg_¡r
 
msg
 = {
NULL
, 0};

3899 
	`LOG
(
LL_DEBUG
, ("şosšg %zu:", 
¡»am_id
));

3900 
	`mg_tun_£nd_äame
(
ş›Á
->
di¥
, 
¡»am_id
, 
MG_TUN_DATA_FRAME
,

3901 
MG_TUN_F_END_STREAM
, 
msg
);

3903 
	}
}

3906 
	$mg_tun_if_sock_£t
(
mg_cÚÃùiÚ
 *
nc
, 
sock_t
 
sock
) {

3907 (è
nc
;

3908 (è
sock
;

3909 
	}
}

3911 
	$mg_tun_if_š™
(
mg_içû
 *
içû
) {

3912 (è
içû
;

3913 
	}
}

3915 
	$mg_tun_if_ä“
(
mg_içû
 *
içû
) {

3916 (è
içû
;

3917 
	}
}

3919 
	$mg_tun_if_add_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

3920 
nc
->
sock
 = 
INVALID_SOCKET
;

3921 
	}
}

3923 
	$mg_tun_if_»move_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

3924 (è
nc
;

3925 
	}
}

3927 
time_t
 
	$mg_tun_if_pŞl
(
mg_içû
 *
içû
, 
timeout_ms
) {

3928 (è
içû
;

3929 (è
timeout_ms
;

3930  (
time_t
è
	`cs_time
();

3931 
	}
}

3933 
	$mg_tun_if_g‘_cÚn_addr
(
mg_cÚÃùiÚ
 *
nc
, 
»mÙe
,

3934 
sock‘_add»ss
 *
§
) {

3935 (è
nc
;

3936 (è
»mÙe
;

3937 (è
§
;

3938 
	}
}

3940 
mg_cÚÃùiÚ
 *
	$mg_tun_if_fšd_cÚn
(
mg_tun_ş›Á
 *
ş›Á
,

3941 
ušt32_t
 
¡»am_id
) {

3942 
mg_cÚÃùiÚ
 *
nc
 = 
NULL
;

3944 
nc
 = 
ş›Á
->
mgr
->
aùive_cÚÃùiÚs
;‚ø!ğ
NULL
;‚øğnc->
Ãxt
) {

3945 ià(
nc
->
içû
 !ğ
ş›Á
->içû || (nc->
æags
 & 
MG_F_LISTENING
)) {

3948 ià(
¡»am_id
 =ğ(
ušt32_t
)(
ušŒ_t
è
nc
->
mgr_d©a
) {

3949  
nc
;

3953 ià(
¡»am_id
 > 
ş›Á
->
Ï¡_¡»am_id
) {

3955 
	`LOG
(
LL_DEBUG
, ("Ãw sŒ—m 0x%lx,‡cû±šg", 
¡»am_id
));

3956 
nc
 = 
	`mg_if_acû±_Ãw_cÚn
(
ş›Á
->
li¡’”
);

3957 
nc
->
mgr_d©a
 = (*è(
ušŒ_t
è
¡»am_id
;

3958 
ş›Á
->
Ï¡_¡»am_id
 = 
¡»am_id
;

3960 
	`LOG
(
LL_DEBUG
, ("IgnÜšg sŒ—m 0x%lx (Ï¡_¡»am_id 0x%lx)", 
¡»am_id
,

3961 
ş›Á
->
Ï¡_¡»am_id
));

3964  
nc
;

3965 
	}
}

3968 
	#MG_TUN_IFACE_VTABLE
 \

3970 
mg_tun_if_š™
, \

3971 
mg_tun_if_ä“
, \

3972 
mg_tun_if_add_cÚn
, \

3973 
mg_tun_if_»move_cÚn
, \

3974 
mg_tun_if_pŞl
, \

3975 
mg_tun_if_li¡’_tı
, \

3976 
mg_tun_if_li¡’_udp
, \

3977 
mg_tun_if_cÚÃù_tı
, \

3978 
mg_tun_if_cÚÃù_udp
, \

3979 
mg_tun_if_tı_£nd
, \

3980 
mg_tun_if_udp_£nd
, \

3981 
mg_tun_if_»cved
, \

3982 
mg_tun_if_ü—‹_cÚn
, \

3983 
mg_tun_if_de¡roy_cÚn
, \

3984 
mg_tun_if_sock_£t
, \

3985 
mg_tun_if_g‘_cÚn_addr
, \

3986 }

	)

3989 
mg_içû_vbË
 
	gmg_tun_içû_vbË
 = 
MG_TUN_IFACE_VTABLE
;

3992 #ifdeà
MG_MODULE_LINES


4000 #ià
MG_ENABLE_SSL
 && 
MG_SSL_IF
 =ğ
MG_SSL_IF_OPENSSL


4002 #ifdeà
__APPLE__


4003 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Wdeprecated-declarations"

4006 
	~<İ’s¦/s¦.h
>

4008 
	smg_s¦_if_ùx
 {

4009 
SSL
 *
	ms¦
;

4010 
SSL_CTX
 *
	ms¦_ùx
;

4011 
mbuf
 
	mpsk
;

4012 
size_t
 
	mid’t™y_Ën
;

4015 
	$mg_s¦_if_š™
() {

4016 
	`SSL_lib¿ry_š™
();

4017 
	}
}

4019 
mg_s¦_if_»suÉ
 
	$mg_s¦_if_cÚn_acû±
(
mg_cÚÃùiÚ
 *
nc
,

4020 
mg_cÚÃùiÚ
 *
lc
) {

4021 
mg_s¦_if_ùx
 *
ùx
 =

4022 (
mg_s¦_if_ùx
 *è
	`MG_CALLOC
(1, (*
ùx
));

4023 
mg_s¦_if_ùx
 *
lc_ùx
 = (mg_s¦_if_ùx *è
lc
->
s¦_if_d©a
;

4024 
nc
->
s¦_if_d©a
 = 
ùx
;

4025 ià(
ùx
 =ğ
NULL
 || 
lc_ùx
 =ğNULLè 
MG_SSL_ERROR
;

4026 
ùx
->
s¦_ùx
 = 
lc_ùx
->ssl_ctx;

4027 ià((
ùx
->
s¦
 = 
	`SSL_Ãw
(ùx->
s¦_ùx
)è=ğ
NULL
) {

4028  
MG_SSL_ERROR
;

4030  
MG_SSL_OK
;

4031 
	}
}

4033 
mg_s¦_if_»suÉ
 
mg_u£_û¹
(
SSL_CTX
 *
ùx
, cÚ¡ *
û¹
,

4034 cÚ¡ *
key
, cÚ¡ **
”r_msg
);

4035 
mg_s¦_if_»suÉ
 
mg_u£_ÿ_û¹
(
SSL_CTX
 *
ùx
, cÚ¡ *
û¹
);

4036 
mg_s¦_if_»suÉ
 
mg_£t_ch”_li¡
(
SSL_CTX
 *
ùx
, cÚ¡ *
ş
);

4037 
mg_s¦_if_»suÉ
 
mg_s¦_if_os¦_£t_psk
(
mg_s¦_if_ùx
 *
ùx
,

4038 cÚ¡ *
id’t™y
,

4039 cÚ¡ *
key_¡r
);

4042 
mg_s¦_if_»suÉ
 
	$mg_s¦_if_cÚn_š™
(

4043 
mg_cÚÃùiÚ
 *
nc
, cÚ¡ 
mg_s¦_if_cÚn_·¿ms
 *
·¿ms
,

4044 cÚ¡ **
”r_msg
) {

4045 
mg_s¦_if_ùx
 *
ùx
 =

4046 (
mg_s¦_if_ùx
 *è
	`MG_CALLOC
(1, (*
ùx
));

4047 
	`DBG
(("%°%s,%s,%s", 
nc
, (
·¿ms
->
û¹
 ?…arams->cert : ""),

4048 (
·¿ms
->
key
 ?…arams->key : ""),

4049 (
·¿ms
->
ÿ_û¹
 ?…arams->ca_cert : "")));

4050 ià(
ùx
 =ğ
NULL
) {

4051 
	`MG_SET_PTRPTR
(
”r_msg
, "Out of memory");

4052  
MG_SSL_ERROR
;

4054 
nc
->
s¦_if_d©a
 = 
ùx
;

4055 ià(
nc
->
æags
 & 
MG_F_LISTENING
) {

4056 
ùx
->
s¦_ùx
 = 
	`SSL_CTX_Ãw
(
	`SSLv23_£rv”_m‘hod
());

4058 
ùx
->
s¦_ùx
 = 
	`SSL_CTX_Ãw
(
	`SSLv23_ş›Á_m‘hod
());

4060 ià(
ùx
->
s¦_ùx
 =ğ
NULL
) {

4061 
	`MG_SET_PTRPTR
(
”r_msg
, "Failedo create SSL context");

4062  
MG_SSL_ERROR
;

4065 ià(
·¿ms
->
û¹
 !ğ
NULL
 &&

4066 
	`mg_u£_û¹
(
ùx
->
s¦_ùx
, 
·¿ms
->
û¹
,…¬ams->
key
, 
”r_msg
) !=

4067 
MG_SSL_OK
) {

4068  
MG_SSL_ERROR
;

4071 ià(
·¿ms
->
ÿ_û¹
 !ğ
NULL
 &&

4072 
	`mg_u£_ÿ_û¹
(
ùx
->
s¦_ùx
, 
·¿ms
->
ÿ_û¹
è!ğ
MG_SSL_OK
) {

4073 
	`MG_SET_PTRPTR
(
”r_msg
, "Invalid SSL CA cert");

4074  
MG_SSL_ERROR
;

4077 ià(
·¿ms
->
£rv”_Çme
 !ğ
NULL
) {

4078 #ifdeà
KR_VERSION


4079 
	`SSL_CTX_kr_£t_v”ify_Çme
(
ùx
->
s¦_ùx
, 
·¿ms
->
£rv”_Çme
);

4085 ià(
	`mg_£t_ch”_li¡
(
ùx
->
s¦_ùx
, 
·¿ms
->
ch”_su™es
è!ğ
MG_SSL_OK
) {

4086 
	`MG_SET_PTRPTR
(
”r_msg
, "Invalid cipher suite†ist");

4087  
MG_SSL_ERROR
;

4090 
	`mbuf_š™
(&
ùx
->
psk
, 0);

4091 ià(
	`mg_s¦_if_os¦_£t_psk
(
ùx
, 
·¿ms
->
psk_id’t™y
,…¬ams->
psk_key
) !=

4092 
MG_SSL_OK
) {

4093 
	`MG_SET_PTRPTR
(
”r_msg
, "Invalid PSK settings");

4094  
MG_SSL_ERROR
;

4097 ià(!(
nc
->
æags
 & 
MG_F_LISTENING
) &&

4098 (
ùx
->
s¦
 = 
	`SSL_Ãw
(ùx->
s¦_ùx
)è=ğ
NULL
) {

4099 
	`MG_SET_PTRPTR
(
”r_msg
, "Failedo create SSL session");

4100  
MG_SSL_ERROR
;

4103 
nc
->
æags
 |ğ
MG_F_SSL
;

4105  
MG_SSL_OK
;

4106 
	}
}

4108 
mg_s¦_if_»suÉ
 
	$mg_s¦_if_s¦_”r
(
mg_cÚÃùiÚ
 *
nc
,

4109 
»s
) {

4110 
mg_s¦_if_ùx
 *
ùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

4111 
”r
 = 
	`SSL_g‘_”rÜ
(
ùx
->
s¦
, 
»s
);

4112 ià(
”r
 =ğ
SSL_ERROR_WANT_READ
è 
MG_SSL_WANT_READ
;

4113 ià(
”r
 =ğ
SSL_ERROR_WANT_WRITE
è 
MG_SSL_WANT_WRITE
;

4114 
	`DBG
(("%°%°SSLƒ¼Ü: %d %d", 
nc
, 
ùx
->
s¦_ùx
, 
»s
, 
”r
));

4115 
nc
->
”r
 =ƒrr;

4116  
MG_SSL_ERROR
;

4117 
	}
}

4119 
mg_s¦_if_»suÉ
 
	$mg_s¦_if_hªdshake
(
mg_cÚÃùiÚ
 *
nc
) {

4120 
mg_s¦_if_ùx
 *
ùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

4121 
£rv”_side
 = (
nc
->
li¡’”
 !ğ
NULL
);

4122 
»s
;

4124 ià(
	`SSL_g‘_fd
(
ùx
->
s¦
) < 0) {

4125 ià(
	`SSL_£t_fd
(
ùx
->
s¦
, 
nc
->
sock
è!ğ1è 
MG_SSL_ERROR
;

4127 
»s
 = 
£rv”_side
 ? 
	`SSL_acû±
(
ùx
->
s¦
è: 
	`SSL_cÚÃù
(ctx->ssl);

4128 ià(
»s
 !ğ1è 
	`mg_s¦_if_s¦_”r
(
nc
,„es);

4129  
MG_SSL_OK
;

4130 
	}
}

4132 
	$mg_s¦_if_»ad
(
mg_cÚÃùiÚ
 *
nc
, *
buf
, 
size_t
 
buf_size
) {

4133 
mg_s¦_if_ùx
 *
ùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

4134 
n
 = 
	`SSL_»ad
(
ùx
->
s¦
, 
buf
, 
buf_size
);

4135 
	`DBG
(("%°%d -> %d", 
nc
, (è
buf_size
, 
n
));

4136 ià(
n
 < 0è 
	`mg_s¦_if_s¦_”r
(
nc
,‚);

4137 ià(
n
 =ğ0è
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

4138  
n
;

4139 
	}
}

4141 
	$mg_s¦_if_wr™e
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
d©a
, 
size_t
 
Ën
) {

4142 
mg_s¦_if_ùx
 *
ùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

4143 
n
 = 
	`SSL_wr™e
(
ùx
->
s¦
, 
d©a
, 
Ën
);

4144 
	`DBG
(("%°%d -> %d", 
nc
, (è
Ën
, 
n
));

4145 ià(
n
 <ğ0è 
	`mg_s¦_if_s¦_”r
(
nc
,‚);

4146  
n
;

4147 
	}
}

4149 
	$mg_s¦_if_cÚn_ä“
(
mg_cÚÃùiÚ
 *
nc
) {

4150 
mg_s¦_if_ùx
 *
ùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

4151 ià(
ùx
 =ğ
NULL
) ;

4152 
nc
->
s¦_if_d©a
 = 
NULL
;

4153 ià(
ùx
->
s¦
 !ğ
NULL
è
	`SSL_ä“
(ctx->ssl);

4154 ià(
ùx
->
s¦_ùx
 !ğ
NULL
 && 
nc
->
li¡’”
 =ğNULLè
	`SSL_CTX_ä“
(ctx->ssl_ctx);

4155 
	`mbuf_ä“
(&
ùx
->
psk
);

4156 
	`mem£t
(
ùx
, 0, (*ctx));

4157 
	`MG_FREE
(
ùx
);

4158 
	}
}

4164 cÚ¡ 
	gmg_s_ch”_li¡
[] =

4165 #ià
defšed
(
MG_SSL_CRYPTO_MODERN
)

4175 #–ià
defšed
(
MG_SSL_CRYPTO_OLD
)

4207 #ià!
MG_DISABLE_PFS
 && !
defšed
(
KR_VERSION
)

4208 cÚ¡ 
	gmg_s_deçuÉ_dh_·¿ms
[] =

4220 
mg_s¦_if_»suÉ
 
	$mg_u£_ÿ_û¹
(
SSL_CTX
 *
ùx
, cÚ¡ *
û¹
) {

4221 ià(
û¹
 =ğ
NULL
 || 
	`¡rcmp
(cert, "*") == 0) {

4222  
MG_SSL_OK
;

4224 
	`SSL_CTX_£t_v”ify
(
ùx
, 
SSL_VERIFY_PEER
 | 
SSL_VERIFY_FAIL_IF_NO_PEER_CERT
, 0);

4225  
	`SSL_CTX_lßd_v”ify_loÿtiÚs
(
ùx
, 
û¹
, 
NULL
è=ğ1 ? 
MG_SSL_OK


4226 : 
MG_SSL_ERROR
;

4227 
	}
}

4229 
mg_s¦_if_»suÉ
 
	$mg_u£_û¹
(
SSL_CTX
 *
ùx
, cÚ¡ *
û¹
,

4230 cÚ¡ *
key
,

4231 cÚ¡ **
”r_msg
) {

4232 ià(
key
 =ğ
NULL
èkey = 
û¹
;

4233 ià(
û¹
 =ğ
NULL
 || c”t[0] =ğ'\0' || 
key
 == NULL || key[0] == '\0') {

4234  
MG_SSL_OK
;

4235 } ià(
	`SSL_CTX_u£_û¹ifiÿ‹_fe
(
ùx
, 
û¹
, 1) == 0) {

4236 
	`MG_SET_PTRPTR
(
”r_msg
, "Invalid SSL cert");

4237  
MG_SSL_ERROR
;

4238 } ià(
	`SSL_CTX_u£_Priv©eKey_fe
(
ùx
, 
key
, 1) == 0) {

4239 
	`MG_SET_PTRPTR
(
”r_msg
, "Invalid SSL key");

4240  
MG_SSL_ERROR
;

4241 } ià(
	`SSL_CTX_u£_û¹ifiÿ‹_chaš_fe
(
ùx
, 
û¹
) == 0) {

4242 
	`MG_SET_PTRPTR
(
”r_msg
, "Invalid CA bundle");

4243  
MG_SSL_ERROR
;

4245 
	`SSL_CTX_£t_mode
(
ùx
, 
SSL_MODE_ACCEPT_MOVING_WRITE_BUFFER
);

4246 #ià!
MG_DISABLE_PFS
 && !
	`defšed
(
KR_VERSION
)

4247 
BIO
 *
bio
 = 
NULL
;

4248 
DH
 *
dh
 = 
NULL
;

4251 
bio
 = 
	`BIO_Ãw_fe
(
û¹
, "r");

4252 ià(
bio
 !ğ
NULL
) {

4253 
dh
 = 
	`PEM_»ad_bio_DH·¿ms
(
bio
, 
NULL
, NULL, NULL);

4254 
	`BIO_ä“
(
bio
);

4260 ià(
dh
 =ğ
NULL
) {

4261 
bio
 = 
	`BIO_Ãw_mem_buf
((*è
mg_s_deçuÉ_dh_·¿ms
, -1);

4262 
dh
 = 
	`PEM_»ad_bio_DH·¿ms
(
bio
, 
NULL
, NULL, NULL);

4263 
	`BIO_ä“
(
bio
);

4265 ià(
dh
 !ğ
NULL
) {

4266 
	`SSL_CTX_£t_tmp_dh
(
ùx
, 
dh
);

4267 
	`SSL_CTX_£t_İtiÚs
(
ùx
, 
SSL_OP_SINGLE_DH_USE
);

4268 
	`DH_ä“
(
dh
);

4270 #ià
OPENSSL_VERSION_NUMBER
 > 0x10002000L

4271 
	`SSL_CTX_£t_ecdh_auto
(
ùx
, 1);

4275  
MG_SSL_OK
;

4276 
	}
}

4278 
mg_s¦_if_»suÉ
 
	$mg_£t_ch”_li¡
(
SSL_CTX
 *
ùx
, cÚ¡ *
ş
) {

4279  (
	`SSL_CTX_£t_ch”_li¡
(
ùx
, 
ş
 ? cÈ: 
mg_s_ch”_li¡
) == 1

4280 ? 
MG_SSL_OK


4281 : 
MG_SSL_ERROR
);

4282 
	}
}

4284 #iâdeà
KR_VERSION


4285 
	$mg_s¦_if_os¦_psk_cb
(
SSL
 *
s¦
, cÚ¡ *
hšt
,

4286 *
id’t™y
,

4287 
max_id’t™y_Ën
,

4288 *
psk
,

4289 
max_psk_Ën
) {

4290 
mg_s¦_if_ùx
 *
ùx
 =

4291 (
mg_s¦_if_ùx
 *è
s¦
->
ùx
->
msg_ÿÎback_¬g
;

4292 
size_t
 
key_Ën
 = 
ùx
->
psk
.
Ën
 - ctx->
id’t™y_Ën
 - 1;

4293 
	`DBG
(("hšt: '%s'", (
hšt
 ? hint : "")));

4294 ià(
ùx
->
id’t™y_Ën
 + 1 > 
max_id’t™y_Ën
) {

4295 
	`DBG
(("identityoo†ong"));

4298 ià(
key_Ën
 > 
max_psk_Ën
) {

4299 
	`DBG
(("keyoo†ong"));

4302 
	`memıy
(
id’t™y
, 
ùx
->
psk
.
buf
, ctx->
id’t™y_Ën
 + 1);

4303 
	`memıy
(
psk
, 
ùx
->psk.
buf
 + ctx->
id’t™y_Ën
 + 1, 
key_Ën
);

4304 (è
s¦
;

4305  
key_Ën
;

4306 
	}
}

4308 
mg_s¦_if_»suÉ
 
	$mg_s¦_if_os¦_£t_psk
(
mg_s¦_if_ùx
 *
ùx
,

4309 cÚ¡ *
id’t™y
,

4310 cÚ¡ *
key_¡r
) {

4311 
key
[32];

4312 
size_t
 
key_Ën
;

4313 
size_t
 
i
 = 0;

4314 ià(
id’t™y
 =ğ
NULL
 && 
key_¡r
 =ğNULLè 
MG_SSL_OK
;

4315 ià(
id’t™y
 =ğ
NULL
 || 
key_¡r
 =ğNULLè 
MG_SSL_ERROR
;

4316 
key_Ën
 = 
	`¡¾’
(
key_¡r
);

4317 ià(
key_Ën
 !ğ32 && key_ËÀ!ğ64è 
MG_SSL_ERROR
;

4318 
	`mem£t
(
key
, 0, (key));

4319 
key_Ën
 = 0;

4320 
i
 = 0; 
key_¡r
[i] != '\0'; i++) {

4321 
c
;

4322 
hc
 = 
	`tŞow”
((è
key_¡r
[
i
]);

4323 ià(
hc
 >= '0' && hc <= '9') {

4324 
c
 = 
hc
 - '0';

4325 } ià(
hc
 >= 'a' && hc <= 'f') {

4326 
c
 = 
hc
 - 'a' + 0xa;

4328  
MG_SSL_ERROR
;

4330 
key_Ën
 = 
i
 / 2;

4331 
key
[
key_Ën
] <<= 4;

4332 
key
[
key_Ën
] |ğ
c
;

4334 
key_Ën
++;

4335 
	`DBG
(("id’t™y = '%s', key = (%u)", 
id’t™y
, (è
key_Ën
));

4336 
ùx
->
id’t™y_Ën
 = 
	`¡¾’
(
id’t™y
);

4337 
	`mbuf_­³nd
(&
ùx
->
psk
, 
id’t™y
, ctx->
id’t™y_Ën
 + 1);

4338 
	`mbuf_­³nd
(&
ùx
->
psk
, 
key
, 
key_Ën
);

4339 
	`SSL_CTX_£t_psk_ş›Á_ÿÎback
(
ùx
->
s¦_ùx
, 
mg_s¦_if_os¦_psk_cb
);

4341 
ùx
->
s¦_ùx
->
msg_ÿÎback_¬g
 = ctx;

4342  
MG_SSL_OK
;

4343 
	}
}

4345 
mg_s¦_if_»suÉ
 
	$mg_s¦_if_os¦_£t_psk
(
mg_s¦_if_ùx
 *
ùx
,

4346 cÚ¡ *
id’t™y
,

4347 cÚ¡ *
key_¡r
) {

4348 (è
ùx
;

4349 (è
id’t™y
;

4350 (è
key_¡r
;

4352  
MG_SSL_ERROR
;

4353 
	}
}

4356 cÚ¡ *
	$mg_£t_s¦
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
û¹
,

4357 cÚ¡ *
ÿ_û¹
) {

4358 cÚ¡ *
”r_msg
 = 
NULL
;

4359 
mg_s¦_if_cÚn_·¿ms
 
·¿ms
;

4360 
	`mem£t
(&
·¿ms
, 0, (params));

4361 
·¿ms
.
û¹
 = cert;

4362 
·¿ms
.
ÿ_û¹
 = ca_cert;

4363 ià(
	`mg_s¦_if_cÚn_š™
(
nc
, &
·¿ms
, &
”r_msg
è!ğ
MG_SSL_OK
) {

4364  
”r_msg
;

4366  
NULL
;

4367 
	}
}

4370 #ifdeà
MG_MODULE_LINES


4378 #ià
MG_ENABLE_SSL
 && 
MG_SSL_IF
 =ğ
MG_SSL_IF_MBEDTLS


4380 
	~<mbeds/debug.h
>

4381 
	~<mbeds/eı.h
>

4382 
	~<mbeds/¶©fÜm.h
>

4383 
	~<mbeds/s¦.h
>

4384 
	~<mbeds/x509_üt.h
>

4386 
	$mg_s¦_mbed_log
(*
ùx
, 
Ëv–
, cÚ¡ *
fe
, 
lše
,

4387 cÚ¡ *
¡r
) {

4388 
cs_log_Ëv–
 
cs_Ëv–
;

4389 
Ëv–
) {

4391 
cs_Ëv–
 = 
LL_ERROR
;

4395 
cs_Ëv–
 = 
LL_DEBUG
;

4398 
cs_Ëv–
 = 
LL_VERBOSE_DEBUG
;

4401 
	`LOG
(
cs_Ëv–
, ("%°%.*s", 
ùx
, (è(
	`¡¾’
(
¡r
) - 1), str));

4402 (è
fe
;

4403 (è
lše
;

4404 
	}
}

4406 
	smg_s¦_if_ùx
 {

4407 
mbeds_s¦_cÚfig
 *
	mcÚf
;

4408 
mbeds_s¦_cÚ‹xt
 *
	ms¦
;

4409 
mbeds_x509_üt
 *
	mû¹
;

4410 
mbeds_pk_cÚ‹xt
 *
	mkey
;

4411 
mbeds_x509_üt
 *
	mÿ_û¹
;

4412 
mbuf
 
	mch”_su™es
;

4416 
mg_s¦_if_mbed_¿ndom
(*
ùx
, *
buf
, 
size_t
 
Ën
);

4418 
	$mg_s¦_if_š™
() {

4419 
	}
}

4421 
mg_s¦_if_»suÉ
 
	$mg_s¦_if_cÚn_acû±
(
mg_cÚÃùiÚ
 *
nc
,

4422 
mg_cÚÃùiÚ
 *
lc
) {

4423 
mg_s¦_if_ùx
 *
ùx
 =

4424 (
mg_s¦_if_ùx
 *è
	`MG_CALLOC
(1, (*
ùx
));

4425 
mg_s¦_if_ùx
 *
lc_ùx
 = (mg_s¦_if_ùx *è
lc
->
s¦_if_d©a
;

4426 
nc
->
s¦_if_d©a
 = 
ùx
;

4427 ià(
ùx
 =ğ
NULL
 || 
lc_ùx
 =ğNULLè 
MG_SSL_ERROR
;

4428 
ùx
->
s¦
 = (
mbeds_s¦_cÚ‹xt
 *è
	`MG_CALLOC
(1, (*ctx->ssl));

4429 ià(
	`mbeds_s¦_£tup
(
ùx
->
s¦
, 
lc_ùx
->
cÚf
) != 0) {

4430  
MG_SSL_ERROR
;

4432  
MG_SSL_OK
;

4433 
	}
}

4435 
mg_s¦_if_»suÉ
 
mg_u£_û¹
(
mg_s¦_if_ùx
 *
ùx
,

4436 cÚ¡ *
û¹
, cÚ¡ *
key
,

4437 cÚ¡ **
”r_msg
);

4438 
mg_s¦_if_»suÉ
 
mg_u£_ÿ_û¹
(
mg_s¦_if_ùx
 *
ùx
,

4439 cÚ¡ *
û¹
);

4440 
mg_s¦_if_»suÉ
 
mg_£t_ch”_li¡
(
mg_s¦_if_ùx
 *
ùx
,

4441 cÚ¡ *
ch”s
);

4442 
mg_s¦_if_»suÉ
 
mg_s¦_if_mbed_£t_psk
(
mg_s¦_if_ùx
 *
ùx
,

4443 cÚ¡ *
id’t™y
,

4444 cÚ¡ *
key
);

4446 
mg_s¦_if_»suÉ
 
	$mg_s¦_if_cÚn_š™
(

4447 
mg_cÚÃùiÚ
 *
nc
, cÚ¡ 
mg_s¦_if_cÚn_·¿ms
 *
·¿ms
,

4448 cÚ¡ **
”r_msg
) {

4449 
mg_s¦_if_ùx
 *
ùx
 =

4450 (
mg_s¦_if_ùx
 *è
	`MG_CALLOC
(1, (*
ùx
));

4451 
	`DBG
(("%°%s,%s,%s", 
nc
, (
·¿ms
->
û¹
 ?…arams->cert : ""),

4452 (
·¿ms
->
key
 ?…arams->key : ""),

4453 (
·¿ms
->
ÿ_û¹
 ?…arams->ca_cert : "")));

4455 ià(
ùx
 =ğ
NULL
) {

4456 
	`MG_SET_PTRPTR
(
”r_msg
, "Out of memory");

4457  
MG_SSL_ERROR
;

4459 
nc
->
s¦_if_d©a
 = 
ùx
;

4460 
ùx
->
cÚf
 = (
mbeds_s¦_cÚfig
 *è
	`MG_CALLOC
(1, (*ctx->conf));

4461 
	`mbuf_š™
(&
ùx
->
ch”_su™es
, 0);

4462 
	`mbeds_s¦_cÚfig_š™
(
ùx
->
cÚf
);

4463 
	`mbeds_s¦_cÚf_dbg
(
ùx
->
cÚf
, 
mg_s¦_mbed_log
, 
nc
);

4464 ià(
	`mbeds_s¦_cÚfig_deçuÉs
(

4465 
ùx
->
cÚf
, (
nc
->
æags
 & 
MG_F_LISTENING
 ? 
MBEDTLS_SSL_IS_SERVER


4466 : 
MBEDTLS_SSL_IS_CLIENT
),

4467 
MBEDTLS_SSL_TRANSPORT_STREAM
, 
MBEDTLS_SSL_PRESET_DEFAULT
) != 0) {

4468 
	`MG_SET_PTRPTR
(
”r_msg
, "Failedo init SSL config");

4469  
MG_SSL_ERROR
;

4473 
	`mbeds_s¦_cÚf_mš_v”siÚ
(
ùx
->
cÚf
, 
MBEDTLS_SSL_MAJOR_VERSION_3
,

4474 
MBEDTLS_SSL_MINOR_VERSION_3
);

4475 
	`mbeds_s¦_cÚf_ºg
(
ùx
->
cÚf
, 
mg_s¦_if_mbed_¿ndom
, 
nc
);

4477 ià(
·¿ms
->
û¹
 !ğ
NULL
 &&

4478 
	`mg_u£_û¹
(
ùx
, 
·¿ms
->
û¹
,…¬ams->
key
, 
”r_msg
è!ğ
MG_SSL_OK
) {

4479  
MG_SSL_ERROR
;

4482 ià(
·¿ms
->
ÿ_û¹
 !ğ
NULL
 &&

4483 
	`mg_u£_ÿ_û¹
(
ùx
, 
·¿ms
->
ÿ_û¹
è!ğ
MG_SSL_OK
) {

4484 
	`MG_SET_PTRPTR
(
”r_msg
, "Invalid SSL CA cert");

4485  
MG_SSL_ERROR
;

4488 ià(
	`mg_£t_ch”_li¡
(
ùx
, 
·¿ms
->
ch”_su™es
è!ğ
MG_SSL_OK
) {

4489 
	`MG_SET_PTRPTR
(
”r_msg
, "Invalid cipher suite†ist");

4490  
MG_SSL_ERROR
;

4493 ià(
	`mg_s¦_if_mbed_£t_psk
(
ùx
, 
·¿ms
->
psk_id’t™y
,…¬ams->
psk_key
) !=

4494 
MG_SSL_OK
) {

4495 
	`MG_SET_PTRPTR
(
”r_msg
, "Invalid PSK settings");

4496  
MG_SSL_ERROR
;

4499 ià(!(
nc
->
æags
 & 
MG_F_LISTENING
)) {

4500 
ùx
->
s¦
 = (
mbeds_s¦_cÚ‹xt
 *è
	`MG_CALLOC
(1, (*ctx->ssl));

4501 
	`mbeds_s¦_š™
(
ùx
->
s¦
);

4502 ià(
	`mbeds_s¦_£tup
(
ùx
->
s¦
, ctx->
cÚf
) != 0) {

4503 
	`MG_SET_PTRPTR
(
”r_msg
, "Failedo create SSL session");

4504  
MG_SSL_ERROR
;

4506 ià(
·¿ms
->
£rv”_Çme
 !ğ
NULL
 &&

4507 
	`mbeds_s¦_£t_ho¡Çme
(
ùx
->
s¦
, 
·¿ms
->
£rv”_Çme
) != 0) {

4508  
MG_SSL_ERROR
;

4512 #ifdeà
MG_SSL_IF_MBEDTLS_MAX_FRAG_LEN


4513 ià(
	`mbeds_s¦_cÚf_max_äag_Ën
(
ùx
->
cÚf
,

4514 #ià
MG_SSL_IF_MBEDTLS_MAX_FRAG_LEN
 == 512

4515 
MBEDTLS_SSL_MAX_FRAG_LEN_512


4516 #–ià
MG_SSL_IF_MBEDTLS_MAX_FRAG_LEN
 == 1024

4517 
MBEDTLS_SSL_MAX_FRAG_LEN_1024


4518 #–ià
MG_SSL_IF_MBEDTLS_MAX_FRAG_LEN
 == 2048

4519 
MBEDTLS_SSL_MAX_FRAG_LEN_2048


4520 #–ià
MG_SSL_IF_MBEDTLS_MAX_FRAG_LEN
 == 4096

4521 
MBEDTLS_SSL_MAX_FRAG_LEN_4096


4523 #”rÜ 
Inv®id
 
MG_SSL_IF_MBEDTLS_MAX_FRAG_LEN


4526  
MG_SSL_ERROR
;

4530 
nc
->
æags
 |ğ
MG_F_SSL
;

4532  
MG_SSL_OK
;

4533 
	}
}

4535 #ià
MG_NET_IF
 =ğ
MG_NET_IF_LWIP_LOW_LEVEL


4536 
s¦_sock‘_£nd
(*
ùx
, cÚ¡ *
buf
, 
size_t
 
Ën
);

4537 
s¦_sock‘_»cv
(*
ùx
, *
buf
, 
size_t
 
Ën
);

4539 
	$s¦_sock‘_£nd
(*
ùx
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

4540 
mg_cÚÃùiÚ
 *
nc
 = (mg_cÚÃùiÚ *è
ùx
;

4541 
n
 = (è
	`MG_SEND_FUNC
(
nc
->
sock
, 
buf
, 
Ën
, 0);

4542 
	`LOG
(
LL_DEBUG
, ("%°%d -> %d", 
nc
, (è
Ën
, 
n
));

4543 ià(
n
 >= 0) ‚;

4544 
n
 = 
	`mg_g‘_”ºo
();

4545  ((
n
 =ğ
EAGAIN
 ||‚ =ğ
EINPROGRESS
è? 
MBEDTLS_ERR_SSL_WANT_WRITE
 : -1);

4546 
	}
}

4548 
	$s¦_sock‘_»cv
(*
ùx
, *
buf
, 
size_t
 
Ën
) {

4549 
mg_cÚÃùiÚ
 *
nc
 = (mg_cÚÃùiÚ *è
ùx
;

4550 
n
 = (è
	`MG_RECV_FUNC
(
nc
->
sock
, 
buf
, 
Ën
, 0);

4551 
	`LOG
(
LL_DEBUG
, ("%°%d <- %d", 
nc
, (è
Ën
, 
n
));

4552 ià(
n
 >= 0) ‚;

4553 
n
 = 
	`mg_g‘_”ºo
();

4554  ((
n
 =ğ
EAGAIN
 ||‚ =ğ
EINPROGRESS
è? 
MBEDTLS_ERR_SSL_WANT_READ
 : -1);

4555 
	}
}

4558 
mg_s¦_if_»suÉ
 
	$mg_s¦_if_mbed_”r
(
mg_cÚÃùiÚ
 *
nc
,

4559 
»t
) {

4560 ià(
»t
 =ğ
MBEDTLS_ERR_SSL_WANT_READ
è 
MG_SSL_WANT_READ
;

4561 ià(
»t
 =ğ
MBEDTLS_ERR_SSL_WANT_WRITE
è 
MG_SSL_WANT_WRITE
;

4562 ià(
»t
 !=

4563 
MBEDTLS_ERR_SSL_PEER_CLOSE_NOTIFY
) {

4564 
	`LOG
(
LL_ERROR
, ("%°SSLƒ¼Ü: %d", 
nc
, 
»t
));

4566 
nc
->
”r
 = 
»t
;

4567 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

4568  
MG_SSL_ERROR
;

4569 
	}
}

4571 
	$mg_s¦_if_mbed_ä“_û¹s_ªd_keys
(
mg_s¦_if_ùx
 *
ùx
) {

4572 ià(
ùx
->
û¹
 !ğ
NULL
) {

4573 
	`mbeds_x509_üt_ä“
(
ùx
->
û¹
);

4574 
	`MG_FREE
(
ùx
->
û¹
);

4575 
ùx
->
û¹
 = 
NULL
;

4576 
	`mbeds_pk_ä“
(
ùx
->
key
);

4577 
	`MG_FREE
(
ùx
->
key
);

4578 
ùx
->
key
 = 
NULL
;

4580 ià(
ùx
->
ÿ_û¹
 !ğ
NULL
) {

4581 
	`mbeds_s¦_cÚf_ÿ_chaš
(
ùx
->
cÚf
, 
NULL
, NULL);

4582 
	`mbeds_x509_üt_ä“
(
ùx
->
ÿ_û¹
);

4583 
	`MG_FREE
(
ùx
->
ÿ_û¹
);

4584 
ùx
->
ÿ_û¹
 = 
NULL
;

4586 
	}
}

4588 
mg_s¦_if_»suÉ
 
	$mg_s¦_if_hªdshake
(
mg_cÚÃùiÚ
 *
nc
) {

4589 
mg_s¦_if_ùx
 *
ùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

4590 
”r
;

4592 ià(
ùx
->
s¦
->
p_bio
 =ğ
NULL
) {

4593 
	`mbeds_s¦_£t_bio
(
ùx
->
s¦
, 
nc
, 
s¦_sock‘_£nd
, 
s¦_sock‘_»cv
, 
NULL
);

4595 
”r
 = 
	`mbeds_s¦_hªdshake
(
ùx
->
s¦
);

4596 ià(
”r
 !ğ0è 
	`mg_s¦_if_mbed_”r
(
nc
,ƒrr);

4597 #ifdeà
MG_SSL_IF_MBEDTLS_FREE_CERTS


4602 
	`mbeds_x509_üt_ä“
(
ùx
->
s¦
->
£ssiÚ
->
³”_û¹
);

4603 
	`mbeds_ä“
(
ùx
->
s¦
->
£ssiÚ
->
³”_û¹
);

4604 
ùx
->
s¦
->
£ssiÚ
->
³”_û¹
 = 
NULL
;

4606 ià(
nc
->
li¡’”
 =ğ
NULL
) {

4607 ià(
ùx
->
cÚf
->
key_û¹
 !ğ
NULL
) {

4609 
	`MG_FREE
(
ùx
->
cÚf
->
key_û¹
);

4610 
ùx
->
cÚf
->
key_û¹
 = 
NULL
;

4612 
	`mbeds_s¦_cÚf_ÿ_chaš
(
ùx
->
cÚf
, 
NULL
, NULL);

4613 
	`mg_s¦_if_mbed_ä“_û¹s_ªd_keys
(
ùx
);

4616  
MG_SSL_OK
;

4617 
	}
}

4619 
	$mg_s¦_if_»ad
(
mg_cÚÃùiÚ
 *
nc
, *
buf
, 
size_t
 
buf_size
) {

4620 
mg_s¦_if_ùx
 *
ùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

4621 
n
 = 
	`mbeds_s¦_»ad
(
ùx
->
s¦
, (*è
buf
, 
buf_size
);

4622 
	`DBG
(("%°%d -> %d", 
nc
, (è
buf_size
, 
n
));

4623 ià(
n
 < 0è 
	`mg_s¦_if_mbed_”r
(
nc
,‚);

4624 ià(
n
 =ğ0è
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

4625  
n
;

4626 
	}
}

4628 
	$mg_s¦_if_wr™e
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
d©a
, 
size_t
 
Ën
) {

4629 
mg_s¦_if_ùx
 *
ùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

4630 
n
 = 
	`mbeds_s¦_wr™e
(
ùx
->
s¦
, (cÚ¡ *è
d©a
, 
Ën
);

4631 
	`DBG
(("%°%d -> %d", 
nc
, (è
Ën
, 
n
));

4632 ià(
n
 < 0è 
	`mg_s¦_if_mbed_”r
(
nc
,‚);

4633  
n
;

4634 
	}
}

4636 
	$mg_s¦_if_cÚn_ä“
(
mg_cÚÃùiÚ
 *
nc
) {

4637 
mg_s¦_if_ùx
 *
ùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

4638 ià(
ùx
 =ğ
NULL
) ;

4639 
nc
->
s¦_if_d©a
 = 
NULL
;

4640 ià(
ùx
->
s¦
 !ğ
NULL
) {

4641 
	`mbeds_s¦_ä“
(
ùx
->
s¦
);

4642 
	`MG_FREE
(
ùx
->
s¦
);

4644 
	`mg_s¦_if_mbed_ä“_û¹s_ªd_keys
(
ùx
);

4645 ià(
ùx
->
cÚf
 !ğ
NULL
) {

4646 
	`mbeds_s¦_cÚfig_ä“
(
ùx
->
cÚf
);

4647 
	`MG_FREE
(
ùx
->
cÚf
);

4649 
	`mbuf_ä“
(&
ùx
->
ch”_su™es
);

4650 
	`mem£t
(
ùx
, 0, (*ctx));

4651 
	`MG_FREE
(
ùx
);

4652 
	}
}

4654 
mg_s¦_if_»suÉ
 
	$mg_u£_ÿ_û¹
(
mg_s¦_if_ùx
 *
ùx
,

4655 cÚ¡ *
ÿ_û¹
) {

4656 ià(
ÿ_û¹
 =ğ
NULL
 || 
	`¡rcmp
(ca_cert, "*") == 0) {

4657  
MG_SSL_OK
;

4659 
ùx
->
ÿ_û¹
 = (
mbeds_x509_üt
 *è
	`MG_CALLOC
(1, (*ctx->ca_cert));

4660 
	`mbeds_x509_üt_š™
(
ùx
->
ÿ_û¹
);

4661 ià(
	`mbeds_x509_üt_·r£_fe
(
ùx
->
ÿ_û¹
, ca_cert) != 0) {

4662  
MG_SSL_ERROR
;

4664 
	`mbeds_s¦_cÚf_ÿ_chaš
(
ùx
->
cÚf
, ctx->
ÿ_û¹
, 
NULL
);

4665 
	`mbeds_s¦_cÚf_authmode
(
ùx
->
cÚf
, 
MBEDTLS_SSL_VERIFY_REQUIRED
);

4666  
MG_SSL_OK
;

4667 
	}
}

4669 
mg_s¦_if_»suÉ
 
	$mg_u£_û¹
(
mg_s¦_if_ùx
 *
ùx
,

4670 cÚ¡ *
û¹
, cÚ¡ *
key
,

4671 cÚ¡ **
”r_msg
) {

4672 ià(
key
 =ğ
NULL
èkey = 
û¹
;

4673 ià(
û¹
 =ğ
NULL
 || c”t[0] =ğ'\0' || 
key
 == NULL || key[0] == '\0') {

4674  
MG_SSL_OK
;

4676 
ùx
->
û¹
 = (
mbeds_x509_üt
 *è
	`MG_CALLOC
(1, (*ctx->cert));

4677 
	`mbeds_x509_üt_š™
(
ùx
->
û¹
);

4678 
ùx
->
key
 = (
mbeds_pk_cÚ‹xt
 *è
	`MG_CALLOC
(1, (*ctx->key));

4679 
	`mbeds_pk_š™
(
ùx
->
key
);

4680 ià(
	`mbeds_x509_üt_·r£_fe
(
ùx
->
û¹
, cert) != 0) {

4681 
	`MG_SET_PTRPTR
(
”r_msg
, "Invalid SSL cert");

4682  
MG_SSL_ERROR
;

4684 ià(
	`mbeds_pk_·r£_keyfe
(
ùx
->
key
, key, 
NULL
) != 0) {

4685 
	`MG_SET_PTRPTR
(
”r_msg
, "Invalid SSL key");

4686  
MG_SSL_ERROR
;

4688 ià(
	`mbeds_s¦_cÚf_own_û¹
(
ùx
->
cÚf
, ctx->
û¹
, ctx->
key
) != 0) {

4689 
	`MG_SET_PTRPTR
(
”r_msg
, "Invalid SSL key or cert");

4690  
MG_SSL_ERROR
;

4692  
MG_SSL_OK
;

4693 
	}
}

4695 cÚ¡ 
	gmg_s_ch”_li¡
[] = {

4696 
MBEDTLS_TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
,

4697 
MBEDTLS_TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
,

4698 
MBEDTLS_TLS_DHE_RSA_WITH_AES_128_GCM_SHA256
,

4699 
MBEDTLS_TLS_DHE_RSA_WITH_AES_128_CBC_SHA256
,

4700 
MBEDTLS_TLS_ECDH_ECDSA_WITH_AES_128_GCM_SHA256
,

4701 
MBEDTLS_TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA256
,

4702 
MBEDTLS_TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA
,

4703 
MBEDTLS_TLS_ECDH_RSA_WITH_AES_128_GCM_SHA256
,

4704 
MBEDTLS_TLS_ECDH_RSA_WITH_AES_128_CBC_SHA256
,

4705 
MBEDTLS_TLS_ECDH_RSA_WITH_AES_128_CBC_SHA
,

4706 
MBEDTLS_TLS_RSA_WITH_AES_128_GCM_SHA256
,

4707 
MBEDTLS_TLS_RSA_WITH_AES_128_CBC_SHA256
,

4708 
MBEDTLS_TLS_RSA_WITH_AES_128_CBC_SHA
, 0};

4716 
mg_s¦_if_»suÉ
 
	$mg_£t_ch”_li¡
(
mg_s¦_if_ùx
 *
ùx
,

4717 cÚ¡ *
ch”s
) {

4718 ià(
ch”s
 !ğ
NULL
) {

4719 
l
, 
id
;

4720 cÚ¡ *
s
 = 
ch”s
, *
e
;

4721 
tmp
[50];

4722 
s
 !ğ
NULL
) {

4723 
e
 = 
	`¡rchr
(
s
, ':');

4724 
l
 = (
e
 !ğ
NULL
 ? (- 
s
è: (è
	`¡¾’
(s));

4725 
	`¡ºıy
(
tmp
, 
s
, 
l
);

4726 
tmp
[
l
] = '\0';

4727 
id
 = 
	`mbeds_s¦_g‘_ch”su™e_id
(
tmp
);

4728 
	`DBG
(("% -> %04x", 
tmp
, 
id
));

4729 ià(
id
 != 0) {

4730 
	`mbuf_­³nd
(&
ùx
->
ch”_su™es
, &
id
, (id));

4732 
s
 = (
e
 !ğ
NULL
 ?ƒ + 1 : NULL);

4734 ià(
ùx
->
ch”_su™es
.
Ën
 =ğ0è 
MG_SSL_ERROR
;

4735 
id
 = 0;

4736 
	`mbuf_­³nd
(&
ùx
->
ch”_su™es
, &
id
, (id));

4737 
	`mbuf_Œim
(&
ùx
->
ch”_su™es
);

4738 
	`mbeds_s¦_cÚf_ch”su™es
(
ùx
->
cÚf
,

4739 (cÚ¡ *è
ùx
->
ch”_su™es
.
buf
);

4741 
	`mbeds_s¦_cÚf_ch”su™es
(
ùx
->
cÚf
, 
mg_s_ch”_li¡
);

4743  
MG_SSL_OK
;

4744 
	}
}

4746 
mg_s¦_if_»suÉ
 
	$mg_s¦_if_mbed_£t_psk
(
mg_s¦_if_ùx
 *
ùx
,

4747 cÚ¡ *
id’t™y
,

4748 cÚ¡ *
key_¡r
) {

4749 
key
[32];

4750 
size_t
 
key_Ën
;

4751 ià(
id’t™y
 =ğ
NULL
 && 
key_¡r
 =ğNULLè 
MG_SSL_OK
;

4752 ià(
id’t™y
 =ğ
NULL
 || 
key_¡r
 =ğNULLè 
MG_SSL_ERROR
;

4753 
key_Ën
 = 
	`¡¾’
(
key_¡r
);

4754 ià(
key_Ën
 !ğ32 && key_ËÀ!ğ64è 
MG_SSL_ERROR
;

4755 
size_t
 
i
 = 0;

4756 
	`mem£t
(
key
, 0, (key));

4757 
key_Ën
 = 0;

4758 
i
 = 0; 
key_¡r
[i] != '\0'; i++) {

4759 
c
;

4760 
hc
 = 
	`tŞow”
((è
key_¡r
[
i
]);

4761 ià(
hc
 >= '0' && hc <= '9') {

4762 
c
 = 
hc
 - '0';

4763 } ià(
hc
 >= 'a' && hc <= 'f') {

4764 
c
 = 
hc
 - 'a' + 0xa;

4766  
MG_SSL_ERROR
;

4768 
key_Ën
 = 
i
 / 2;

4769 
key
[
key_Ën
] <<= 4;

4770 
key
[
key_Ën
] |ğ
c
;

4772 
key_Ën
++;

4773 
	`DBG
(("id’t™y = '%s', key = (%u)", 
id’t™y
, (è
key_Ën
));

4775 ià(
	`mbeds_s¦_cÚf_psk
(
ùx
->
cÚf
, (cÚ¡ *è
key
, 
key_Ën
,

4776 (cÚ¡ *è
id’t™y
,

4777 
	`¡¾’
(
id’t™y
)) != 0) {

4778  
MG_SSL_ERROR
;

4780  
MG_SSL_OK
;

4781 
	}
}

4783 cÚ¡ *
	$mg_£t_s¦
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
û¹
,

4784 cÚ¡ *
ÿ_û¹
) {

4785 cÚ¡ *
”r_msg
 = 
NULL
;

4786 
mg_s¦_if_cÚn_·¿ms
 
·¿ms
;

4787 
	`mem£t
(&
·¿ms
, 0, (params));

4788 
·¿ms
.
û¹
 = cert;

4789 
·¿ms
.
ÿ_û¹
 = ca_cert;

4790 ià(
	`mg_s¦_if_cÚn_š™
(
nc
, &
·¿ms
, &
”r_msg
è!ğ
MG_SSL_OK
) {

4791  
”r_msg
;

4793  
NULL
;

4794 
	}
}

4797 #ifdeà
MG_SSL_MBED_DUMMY_RANDOM


4798 
	$mg_s¦_if_mbed_¿ndom
(*
ùx
, *
buf
, 
size_t
 
Ën
) {

4799 (è
ùx
;

4800 
Ën
--è*
buf
++ = 
	`¿nd
();

4802 
	}
}

4806 #ifdeà
MG_MODULE_LINES


4822 
	$·r£_uri_compÚ’t
(cÚ¡ **
p
, cÚ¡ *
’d
, 
£p
,

4823 
mg_¡r
 *
»s
) {

4824 
»s
->
p
 = *p;

4825 ; *
p
 < 
’d
; (*p)++) {

4826 ià(**
p
 =ğ
£p
) {

4830 
»s
->
Ën
 = (*
p
) -„es->p;

4831 ià(*
p
 < 
’d
) (*p)++;

4832 
	}
}

4834 
	$mg_·r£_uri
(
mg_¡r
 
uri
, mg_¡¸*
scheme
,

4835 
mg_¡r
 *
u£r_šfo
, mg_¡¸*
ho¡
,

4836 *
pÜt
, 
mg_¡r
 *
·th
, mg_¡¸*
qu”y
,

4837 
mg_¡r
 *
äagm’t
) {

4838 
mg_¡r
 
rscheme
 = {0, 0}, 
ru£r_šfo
 = {0, 0}, 
rho¡
 = {0, 0},

4839 
½©h
 = {0, 0}, 
rqu”y
 = {0, 0}, 
räagm’t
 = {0, 0};

4840 
½Üt
 = 0;

4842 
P_START
,

4843 
P_SCHEME_OR_PORT
,

4844 
P_USER_INFO
,

4845 
P_HOST
,

4846 
P_PORT
,

4847 
P_REST


4848 } 
¡©e
 = 
P_START
;

4850 cÚ¡ *
p
 = 
uri
.p, *
’d
 =… + uri.
Ën
;

4851 
p
 < 
’d
) {

4852 
¡©e
) {

4853 
P_START
:

4860 ; 
p
 < 
’d
;…++) {

4861 ià(*
p
 == ':') {

4862 
¡©e
 = 
P_SCHEME_OR_PORT
;

4864 } ià(*
p
 == '/') {

4865 
¡©e
 = 
P_REST
;

4869 ià(
¡©e
 =ğ
P_START
 || s‹ =ğ
P_REST
) {

4870 
rho¡
.
p
 = 
uri
.p;

4871 
rho¡
.
Ën
 = 
p
 - 
uri
.p;

4874 
P_SCHEME_OR_PORT
:

4875 ià(
’d
 - 
p
 >ğ3 && 
	`¡ºcmp
(p, "://", 3) == 0) {

4876 
rscheme
.
p
 = 
uri
.p;

4877 
rscheme
.
Ën
 = 
p
 - 
uri
.p;

4878 
¡©e
 = 
P_USER_INFO
;

4879 
p
 += 2;

4881 
rho¡
.
p
 = 
uri
.p;

4882 
rho¡
.
Ën
 = 
p
 - 
uri
.p;

4883 
¡©e
 = 
P_PORT
;

4886 
P_USER_INFO
:

4887 
p
++;

4888 
ru£r_šfo
.
p
 =…;

4889 ; 
p
 < 
’d
;…++) {

4890 ià(*
p
 == '@') {

4891 
¡©e
 = 
P_HOST
;

4893 } ià(*
p
 == '/') {

4897 ià(
p
 =ğ
’d
 || *p == '/') {

4899 
¡©e
 = 
P_HOST
;

4900 
p
 = 
ru£r_šfo
.p;

4902 
ru£r_šfo
.
Ën
 = 
p
 -„user_info.p;

4904 
P_HOST
:

4905 ià(*
p
 == '@')…++;

4906 
rho¡
.
p
 =…;

4907 ; 
p
 < 
’d
;…++) {

4908 ià(*
p
 == ':') {

4909 
¡©e
 = 
P_PORT
;

4911 } ià(*
p
 == '/') {

4912 
¡©e
 = 
P_REST
;

4916 
rho¡
.
Ën
 = 
p
 -„host.p;

4918 
P_PORT
:

4919 
p
++;

4920 ; 
p
 < 
’d
;…++) {

4921 ià(*
p
 == '/') {

4922 
¡©e
 = 
P_REST
;

4925 
½Üt
 *= 10;

4926 
½Üt
 +ğ*
p
 - '0';

4929 
P_REST
:

4931 
	`·r£_uri_compÚ’t
(&
p
, 
’d
, '?', &
½©h
);

4932 
	`·r£_uri_compÚ’t
(&
p
, 
’d
, '#', &
rqu”y
);

4933 
	`·r£_uri_compÚ’t
(&
p
, 
’d
, '\0', &
räagm’t
);

4938 ià(
scheme
 !ğ0è*schemğ
rscheme
;

4939 ià(
u£r_šfo
 !ğ0è*u£r_šfØğ
ru£r_šfo
;

4940 ià(
ho¡
 !ğ0è*ho¡ = 
rho¡
;

4941 ià(
pÜt
 !ğ0è*pÜˆğ
½Üt
;

4942 ià(
·th
 !ğ0è*·th = 
½©h
;

4943 ià(
qu”y
 !ğ0è*qu”y = 
rqu”y
;

4944 ià(
äagm’t
 !ğ0è*äagm’ˆğ
räagm’t
;

4947 
	}
}

4950 
	$mg_nÜm®ize_uri_·th
(cÚ¡ 
mg_¡r
 *
š
, mg_¡¸*
out
) {

4951 cÚ¡ *
s
 = 
š
->
p
, *
£
 = s + in->
Ën
;

4952 *
ı
 = (*è
out
->
p
, *
d
;

4954 ià(
š
->
Ën
 =ğ0 || *
s
 != '/') {

4955 
out
->
Ën
 = 0;

4959 
d
 = 
ı
;

4961 
s
 < 
£
) {

4962 cÚ¡ *
Ãxt
 = 
s
;

4963 
mg_¡r
 
compÚ’t
;

4964 
	`·r£_uri_compÚ’t
(&
Ãxt
, 
£
, '/', &
compÚ’t
);

4965 ià(
	`mg_vcmp
(&
compÚ’t
, ".") == 0) {

4967 } ià(
	`mg_vcmp
(&
compÚ’t
, "..") == 0) {

4969 ià(
d
 > 
ı
 + 1 && *(d - 1) == '/') d--;

4970 
d
 > 
ı
 && *(d - 1) != '/') d--;

4972 
	`memmove
(
d
, 
s
, 
Ãxt
 - s);

4973 
d
 +ğ
Ãxt
 - 
s
;

4975 
s
 = 
Ãxt
;

4977 ià(
d
 =ğ
ı
) *d++ = '/';

4979 
out
->
p
 = 
ı
;

4980 
out
->
Ën
 = 
d
 - 
ı
;

4982 
	}
}

4983 #ifdeà
MG_MODULE_LINES


4991 #ià
MG_ENABLE_HTTP


4998 cÚ¡ *
	gmg_v”siÚ_h—d”
 = "MÚgoo£/" 
MG_VERSION
;

5000 
	emg_h‰p_´Ùo_d©a_ty³
 { 
	mDATA_NONE
, 
	mDATA_FILE
, 
	mDATA_PUT
 };

5002 
	smg_h‰p_´Ùo_d©a_fe
 {

5003 
FILE
 *
	må
;

5004 
št64_t
 
	mş
;

5005 
št64_t
 
	m£Á
;

5006 
	mk“·live
;

5007 
mg_h‰p_´Ùo_d©a_ty³
 
	mty³
;

5010 #ià
MG_ENABLE_HTTP_CGI


5011 
	smg_h‰p_´Ùo_d©a_cgi
 {

5012 
mg_cÚÃùiÚ
 *
	mcgi_nc
;

5016 
	smg_h‰p_´Ùo_d©a_chuncked
 {

5017 
št64_t
 
	mbody_Ën
;

5020 
	smg_h‰p_’dpošt
 {

5021 
mg_h‰p_’dpošt
 *
	mÃxt
;

5022 cÚ¡ *
	mÇme
;

5023 
size_t
 
	mÇme_Ën
;

5024 
mg_ev’t_hªdËr_t
 
	mhªdËr
;

5027 
	emg_h‰p_muÉ¬t_¡»am_¡©e
 {

5028 
	mMPS_BEGIN
,

5029 
	mMPS_WAITING_FOR_BOUNDARY
,

5030 
	mMPS_WAITING_FOR_CHUNK
,

5031 
	mMPS_GOT_CHUNK
,

5032 
	mMPS_GOT_BOUNDARY
,

5033 
	mMPS_FINALIZE
,

5034 
	mMPS_FINISHED


5037 
	smg_h‰p_muÉ¬t_¡»am
 {

5038 cÚ¡ *
	mbound¬y
;

5039 
	mbound¬y_Ën
;

5040 cÚ¡ *
	mv¬_Çme
;

5041 cÚ¡ *
	mfe_Çme
;

5042 *
	mu£r_d©a
;

5043 
	m´ev_io_Ën
;

5044 
mg_h‰p_muÉ¬t_¡»am_¡©e
 
	m¡©e
;

5045 
	m´oûssšg_·¹
;

5048 
	smg_»v”£_´oxy_d©a
 {

5049 
mg_cÚÃùiÚ
 *
	mlšked_cÚn
;

5052 
	smg_h‰p_´Ùo_d©a
 {

5053 #ià
MG_ENABLE_FILESYSTEM


5054 
mg_h‰p_´Ùo_d©a_fe
 
	mfe
;

5056 #ià
MG_ENABLE_HTTP_CGI


5057 
mg_h‰p_´Ùo_d©a_cgi
 
	mcgi
;

5059 #ià
MG_ENABLE_HTTP_STREAMING_MULTIPART


5060 
mg_h‰p_muÉ¬t_¡»am
 
	mmp_¡»am
;

5062 
mg_h‰p_´Ùo_d©a_chuncked
 
	mchunk
;

5063 
mg_h‰p_’dpošt
 *
	m’dpošts
;

5064 
mg_ev’t_hªdËr_t
 
	m’dpošt_hªdËr
;

5065 
mg_»v”£_´oxy_d©a
 
	m»v”£_´oxy_d©a
;

5068 
mg_h‰p_cÚn_de¡ruùÜ
(*
´Ùo_d©a
);

5069 
mg_cÚÃùiÚ
 *
mg_cÚÃù_h‰p_ba£
(

5070 
mg_mgr
 *
mgr
, 
mg_ev’t_hªdËr_t
 
ev_hªdËr
,

5071 
mg_cÚÃù_İts
 
İts
, cÚ¡ *
schema
, cÚ¡ *
schema_s¦
,

5072 cÚ¡ *
u¾
, cÚ¡ **
·th
, **
u£r
, **
·ss
, **
addr
);

5074 
mg_h‰p_´Ùo_d©a
 *
	$mg_h‰p_g‘_´Ùo_d©a
(

5075 
mg_cÚÃùiÚ
 *
c
) {

5076 ià(
c
->
´Ùo_d©a
 =ğ
NULL
) {

5077 
c
->
´Ùo_d©a
 = 
	`MG_CALLOC
(1, (
mg_h‰p_´Ùo_d©a
));

5078 
c
->
´Ùo_d©a_de¡ruùÜ
 = 
mg_h‰p_cÚn_de¡ruùÜ
;

5081  (
mg_h‰p_´Ùo_d©a
 *è
c
->
´Ùo_d©a
;

5082 
	}
}

5084 #ià
MG_ENABLE_HTTP_STREAMING_MULTIPART


5085 
	$mg_h‰p_ä“_´Ùo_d©a_mp_¡»am
(

5086 
mg_h‰p_muÉ¬t_¡»am
 *
mp
) {

5087 
	`ä“
((*è
mp
->
bound¬y
);

5088 
	`ä“
((*è
mp
->
v¬_Çme
);

5089 
	`ä“
((*è
mp
->
fe_Çme
);

5090 
	`mem£t
(
mp
, 0, (*mp));

5091 
	}
}

5094 #ià
MG_ENABLE_FILESYSTEM


5095 
	$mg_h‰p_ä“_´Ùo_d©a_fe
(
mg_h‰p_´Ùo_d©a_fe
 *
d
) {

5096 ià(
d
 !ğ
NULL
) {

5097 ià(
d
->
å
 !ğ
NULL
) {

5098 
	`fşo£
(
d
->
å
);

5100 
	`mem£t
(
d
, 0, (
mg_h‰p_´Ùo_d©a_fe
));

5102 
	}
}

5105 
	$mg_h‰p_ä“_´Ùo_d©a_’dpošts
(
mg_h‰p_’dpošt
 **
•
) {

5106 
mg_h‰p_’dpošt
 *
cu¼’t
 = *
•
;

5108 
cu¼’t
 !ğ
NULL
) {

5109 
mg_h‰p_’dpošt
 *
tmp
 = 
cu¼’t
->
Ãxt
;

5110 
	`ä“
((*è
cu¼’t
->
Çme
);

5111 
	`ä“
(
cu¼’t
);

5112 
cu¼’t
 = 
tmp
;

5115 
•
 = 
NULL
;

5116 
	}
}

5118 
	$mg_h‰p_ä“_»v”£_´oxy_d©a
(
mg_»v”£_´oxy_d©a
 *
½d
) {

5119 ià(
½d
->
lšked_cÚn
 !ğ
NULL
) {

5125 
mg_h‰p_´Ùo_d©a
 *
pd
 = 
	`mg_h‰p_g‘_´Ùo_d©a
(
½d
->
lšked_cÚn
);

5126 ià(
pd
->
»v”£_´oxy_d©a
.
lšked_cÚn
 !ğ
NULL
) {

5127 
pd
->
»v”£_´oxy_d©a
.
lšked_cÚn
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

5128 
pd
->
»v”£_´oxy_d©a
.
lšked_cÚn
 = 
NULL
;

5130 
½d
->
lšked_cÚn
 = 
NULL
;

5132 
	}
}

5134 
	$mg_h‰p_cÚn_de¡ruùÜ
(*
´Ùo_d©a
) {

5135 
mg_h‰p_´Ùo_d©a
 *
pd
 = (mg_h‰p_´Ùo_d©¨*è
´Ùo_d©a
;

5136 #ià
MG_ENABLE_FILESYSTEM


5137 
	`mg_h‰p_ä“_´Ùo_d©a_fe
(&
pd
->
fe
);

5139 #ià
MG_ENABLE_HTTP_CGI


5140 
	`mg_h‰p_ä“_´Ùo_d©a_cgi
(&
pd
->
cgi
);

5142 #ià
MG_ENABLE_HTTP_STREAMING_MULTIPART


5143 
	`mg_h‰p_ä“_´Ùo_d©a_mp_¡»am
(&
pd
->
mp_¡»am
);

5145 
	`mg_h‰p_ä“_´Ùo_d©a_’dpošts
(&
pd
->
’dpošts
);

5146 
	`mg_h‰p_ä“_»v”£_´oxy_d©a
(&
pd
->
»v”£_´oxy_d©a
);

5147 
	`ä“
(
´Ùo_d©a
);

5148 
	}
}

5150 #ià
MG_ENABLE_FILESYSTEM


5152 
	#MIME_ENTRY
(
_ext
, 
_ty³
) \

5153 { 
_ext
, (_extè- 1, 
_ty³
 }

	)

5155 cÚ¡ *
	mex‹nsiÚ
;

5156 
size_t
 
	mext_Ën
;

5157 cÚ¡ *
	mmime_ty³
;

5158 } 
	gmg_¡©ic_butš_mime_ty³s
[] = {

5159 
MIME_ENTRY
("html", "text/html"),

5160 
MIME_ENTRY
("html", "text/html"),

5161 
MIME_ENTRY
("htm", "text/html"),

5162 
MIME_ENTRY
("shtm", "text/html"),

5163 
MIME_ENTRY
("shtml", "text/html"),

5164 
MIME_ENTRY
("css", "text/css"),

5165 
MIME_ENTRY
("js", "application/x-javascript"),

5166 
MIME_ENTRY
("ico", "image/x-icon"),

5167 
MIME_ENTRY
("gif", "image/gif"),

5168 
MIME_ENTRY
("jpg", "image/jpeg"),

5169 
MIME_ENTRY
("jpeg", "image/jpeg"),

5170 
MIME_ENTRY
("png", "image/png"),

5171 
MIME_ENTRY
("svg", "image/svg+xml"),

5172 
MIME_ENTRY
("txt", "text/plain"),

5173 
MIME_ENTRY
("torrent", "application/x-bittorrent"),

5174 
MIME_ENTRY
("wav", "audio/x-wav"),

5175 
MIME_ENTRY
("mp3", "audio/x-mp3"),

5176 
MIME_ENTRY
("mid", "audio/mid"),

5177 
MIME_ENTRY
("m3u", "audio/x-mpegurl"),

5178 
MIME_ENTRY
("ogg", "application/ogg"),

5179 
MIME_ENTRY
("ram", "audio/x-pn-realaudio"),

5180 
MIME_ENTRY
("xml", "text/xml"),

5181 
MIME_ENTRY
("ttf", "application/x-font-ttf"),

5182 
MIME_ENTRY
("json", "application/json"),

5183 
MIME_ENTRY
("xslt", "application/xml"),

5184 
MIME_ENTRY
("xsl", "application/xml"),

5185 
MIME_ENTRY
("ra", "audio/x-pn-realaudio"),

5186 
MIME_ENTRY
("doc", "application/msword"),

5187 
MIME_ENTRY
("exe", "application/octet-stream"),

5188 
MIME_ENTRY
("zip", "application/x-zip-compressed"),

5189 
MIME_ENTRY
("xls", "application/excel"),

5190 
MIME_ENTRY
("tgz", "application/x-tar-gz"),

5191 
MIME_ENTRY
("tar", "application/x-tar"),

5192 
MIME_ENTRY
("gz", "application/x-gunzip"),

5193 
MIME_ENTRY
("arj", "application/x-arj-compressed"),

5194 
MIME_ENTRY
("rar", "application/x-rar-compressed"),

5195 
MIME_ENTRY
("rtf", "application/rtf"),

5196 
MIME_ENTRY
("pdf", "application/pdf"),

5197 
MIME_ENTRY
("swf", "application/x-shockwave-flash"),

5198 
MIME_ENTRY
("mpg", "video/mpeg"),

5199 
MIME_ENTRY
("webm", "video/webm"),

5200 
MIME_ENTRY
("mpeg", "video/mpeg"),

5201 
MIME_ENTRY
("mov", "video/quicktime"),

5202 
MIME_ENTRY
("mp4", "video/mp4"),

5203 
MIME_ENTRY
("m4v", "video/x-m4v"),

5204 
MIME_ENTRY
("asf", "video/x-ms-asf"),

5205 
MIME_ENTRY
("avi", "video/x-msvideo"),

5206 
MIME_ENTRY
("bmp", "image/bmp"),

5207 {
NULL
, 0, NULL}};

5209 
mg_¡r
 
	$mg_g‘_mime_ty³
(cÚ¡ *
·th
, cÚ¡ *
dæt
,

5210 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
) {

5211 cÚ¡ *
ext
, *
ov”rides
;

5212 
size_t
 
i
, 
·th_Ën
;

5213 
mg_¡r
 
r
, 
k
, 
v
;

5215 
·th_Ën
 = 
	`¡¾’
(
·th
);

5217 
ov”rides
 = 
İts
->
cu¡om_mime_ty³s
;

5218 (
ov”rides
 = 
	`mg_Ãxt_comma_li¡_’Œy
(ov”rides, &
k
, &
v
)è!ğ
NULL
) {

5219 
ext
 = 
·th
 + (
·th_Ën
 - 
k
.
Ën
);

5220 ià(
·th_Ën
 > 
k
.
Ën
 && 
	`mg_vÿ£cmp
(&k, 
ext
) == 0) {

5221  
v
;

5225 
i
 = 0; 
mg_¡©ic_butš_mime_ty³s
[i].
ex‹nsiÚ
 !ğ
NULL
; i++) {

5226 
ext
 = 
·th
 + (
·th_Ën
 - 
mg_¡©ic_butš_mime_ty³s
[
i
].
ext_Ën
);

5227 ià(
·th_Ën
 > 
mg_¡©ic_butš_mime_ty³s
[
i
].
ext_Ën
 && 
ext
[-1] == '.' &&

5228 
	`mg_ÿ£cmp
(
ext
, 
mg_¡©ic_butš_mime_ty³s
[
i
].
ex‹nsiÚ
) == 0) {

5229 
r
.
p
 = 
mg_¡©ic_butš_mime_ty³s
[
i
].
mime_ty³
;

5230 
r
.
Ën
 = 
	`¡¾’
Ô.
p
);

5231  
r
;

5235 
r
.
p
 = 
dæt
;

5236 
r
.
Ën
 = 
	`¡¾’
Ô.
p
);

5237  
r
;

5238 
	}
}

5247 
	$mg_h‰p_g‘_»que¡_Ën
(cÚ¡ *
s
, 
buf_Ën
) {

5248 cÚ¡ *
buf
 = (*è
s
;

5249 
i
;

5251 
i
 = 0; i < 
buf_Ën
; i++) {

5252 ià(!
	`i¥ršt
(
buf
[
i
]) && buf[i] != '\r' && buf[i] != '\n' && buf[i] < 128) {

5254 } ià(
buf
[
i
] =ğ'\n' && i + 1 < 
buf_Ën
 && buf[i + 1] == '\n') {

5255  
i
 + 2;

5256 } ià(
buf
[
i
] =ğ'\n' && i + 2 < 
buf_Ën
 && buf[i + 1] == '\r' &&

5257 
buf
[
i
 + 2] == '\n') {

5258  
i
 + 3;

5263 
	}
}

5265 cÚ¡ *
	$mg_h‰p_·r£_h—d”s
(cÚ¡ *
s
, cÚ¡ *
’d
,

5266 
Ën
, 
h‰p_mes§ge
 *
»q
) {

5267 
i
 = 0;

5268 
i
 < (è
	`ARRAY_SIZE
(
»q
->
h—d”_Çmes
) - 1) {

5269 
mg_¡r
 *
k
 = &
»q
->
h—d”_Çmes
[
i
], *
v
 = &»q->
h—d”_v®ues
[i];

5271 
s
 = 
	`mg_sk
(s, 
’d
, ": ", 
k
);

5272 
s
 = 
	`mg_sk
(s, 
’d
, "\r\n", 
v
);

5274 
v
->
Ën
 > 0 && v->
p
[v->len - 1] == ' ') {

5275 
v
->
Ën
--;

5283 ià(
k
->
Ën
 !ğ0 && 
v
->len == 0) {

5287 ià(
k
->
Ën
 =ğ0 || 
v
->len == 0) {

5288 
k
->
p
 = 
v
->°ğ
NULL
;

5289 
k
->
Ën
 = 
v
->len = 0;

5293 ià(!
	`mg_nÿ£cmp
(
k
->
p
, "Content-Length", 14)) {

5294 
»q
->
body
.
Ën
 = (
size_t
è
	`to64
(
v
->
p
);

5295 
»q
->
mes§ge
.
Ën
 =†’ +„eq->
body
.len;

5298 
i
++;

5301  
s
;

5302 
	}
}

5304 
	$mg_·r£_h‰p
(cÚ¡ *
s
, 
n
, 
h‰p_mes§ge
 *
hm
, 
is_»q
) {

5305 cÚ¡ *
’d
, *
qs
;

5306 
Ën
 = 
	`mg_h‰p_g‘_»que¡_Ën
(
s
, 
n
);

5308 ià(
Ën
 <= 0) †en;

5310 
	`mem£t
(
hm
, 0, (*hm));

5311 
hm
->
mes§ge
.
p
 = 
s
;

5312 
hm
->
body
.
p
 = 
s
 + 
Ën
;

5313 
hm
->
mes§ge
.
Ën
 = hm->
body
.ËÀğ(
size_t
) ~0;

5314 
’d
 = 
s
 + 
Ën
;

5317 
s
 < 
’d
 && 
	`is¥aû
(*(*) s)) s++;

5319 ià(
is_»q
) {

5321 
s
 = 
	`mg_sk
(s, 
’d
, " ", &
hm
->
m‘hod
);

5322 
s
 = 
	`mg_sk
(s, 
’d
, " ", &
hm
->
uri
);

5323 
s
 = 
	`mg_sk
(s, 
’d
, "\r\n", &
hm
->
´Ùo
);

5324 ià(
hm
->
uri
.
p
 <ğhm->
m‘hod
.°|| hm->
´Ùo
.p <= hm->uri.p)  -1;

5327 ià((
qs
 = (*è
	`memchr
(
hm
->
uri
.
p
, '?', hm->uri.
Ën
)è!ğ
NULL
) {

5328 
hm
->
qu”y_¡ršg
.
p
 = 
qs
 + 1;

5329 
hm
->
qu”y_¡ršg
.
Ën
 = &hm->
uri
.
p
[hm->uri.Ën] - (
qs
 + 1);

5330 
hm
->
uri
.
Ën
 = 
qs
 - hm->uri.
p
;

5333 
s
 = 
	`mg_sk
(s, 
’d
, " ", &
hm
->
´Ùo
);

5334 ià(
’d
 - 
s
 < 4 || s[3] != ' ')  -1;

5335 
hm
->
»¥_code
 = 
	`©oi
(
s
);

5336 ià(
hm
->
»¥_code
 < 100 || hm->resp_code >= 600)  -1;

5337 
s
 += 4;

5338 
s
 = 
	`mg_sk
(s, 
’d
, "\r\n", &
hm
->
»¥_¡©us_msg
);

5341 
s
 = 
	`mg_h‰p_·r£_h—d”s
(s, 
’d
, 
Ën
, 
hm
);

5358 ià(
hm
->
body
.
Ën
 =ğ(
size_t
è~0 && 
is_»q
 &&

5359 
	`mg_vÿ£cmp
(&
hm
->
m‘hod
, "PUT") != 0 &&

5360 
	`mg_vÿ£cmp
(&
hm
->
m‘hod
, "POST") != 0) {

5361 
hm
->
body
.
Ën
 = 0;

5362 
hm
->
mes§ge
.
Ën
 =†en;

5365  
Ën
;

5366 
	}
}

5368 
mg_¡r
 *
	$mg_g‘_h‰p_h—d”
(
h‰p_mes§ge
 *
hm
, cÚ¡ *
Çme
) {

5369 
size_t
 
i
, 
Ën
 = 
	`¡¾’
(
Çme
);

5371 
i
 = 0; 
hm
->
h—d”_Çmes
[i].
Ën
 > 0; i++) {

5372 
mg_¡r
 *
h
 = &
hm
->
h—d”_Çmes
[
i
], *
v
 = &hm->
h—d”_v®ues
[i];

5373 ià(
h
->
p
 !ğ
NULL
 && h->
Ën
 =ğËÀ&& !
	`mg_nÿ£cmp
(h->p, 
Çme
,†en))

5374  
v
;

5377  
NULL
;

5378 
	}
}

5380 #ià
MG_ENABLE_FILESYSTEM


5381 
	$mg_h‰p_Œªsãr_fe_d©a
(
mg_cÚÃùiÚ
 *
nc
) {

5382 
mg_h‰p_´Ùo_d©a
 *
pd
 = 
	`mg_h‰p_g‘_´Ùo_d©a
(
nc
);

5383 
buf
[
MG_MAX_HTTP_SEND_MBUF
];

5384 
size_t
 
n
 = 0, 
to_»ad
 = 0, 
Ëá
 = (size_t)(
pd
->
fe
.
ş
 -…d->fe.
£Á
);

5385 ià(
pd
->
fe
.
ty³
 =ğ
DATA_FILE
) {

5386 
mbuf
 *
io
 = &
nc
->
£nd_mbuf
;

5387 ià(
io
->
Ën
 < (
buf
)) {

5388 
to_»ad
 = (
buf
è- 
io
->
Ën
;

5391 ià(
Ëá
 > 0 && 
to_»ad
 >†eft) {

5392 
to_»ad
 = 
Ëá
;

5394 ià(
to_»ad
 == 0) {

5396 } ià(
pd
->
fe
.
£Á
 <…d->fe.
ş
 &&

5397 (
n
 = 
	`ä—d
(
buf
, 1, 
to_»ad
, 
pd
->
fe
.
å
)) > 0) {

5419 
	`mg_£nd
(
nc
, 
buf
, 
to_»ad
);

5420 
pd
->
fe
.
£Á
 +ğ
to_»ad
;

5423 ià(!
pd
->
fe
.
k“·live
è
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

5424 
	`mg_h‰p_ä“_´Ùo_d©a_fe
(&
pd
->
fe
);

5426 } ià(
pd
->
fe
.
ty³
 =ğ
DATA_PUT
) {

5427 
mbuf
 *
io
 = &
nc
->
»cv_mbuf
;

5428 
size_t
 
to_wr™e
 = 
Ëá
 <ğ0 ? 0 :†eá < 
io
->
Ën
 ? (size_t)†eft : io->len;

5429 
size_t
 
n
 = 
	`fwr™e
(
io
->
buf
, 1, 
to_wr™e
, 
pd
->
fe
.
å
);

5430 ià(
n
 > 0) {

5431 
	`mbuf_»move
(
io
, 
n
);

5432 
pd
->
fe
.
£Á
 +ğ
n
;

5434 ià(
n
 =ğ0 || 
pd
->
fe
.
£Á
 >ğpd->fe.
ş
) {

5435 ià(!
pd
->
fe
.
k“·live
è
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

5436 
	`mg_h‰p_ä“_´Ùo_d©a_fe
(&
pd
->
fe
);

5440 #ià
MG_ENABLE_HTTP_CGI


5441 ià(
pd
->
cgi
.
cgi_nc
 !ğ
NULL
) {

5443 ià(
pd
->
cgi
.
cgi_nc
 !ğ
NULL
) {

5444 
	`mg_fÜw¬d
(
nc
, 
pd
->
cgi
.
cgi_nc
);

5446 
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

5450 
	}
}

5452 
	$mg_h‰p_Œªsãr_fe_d©a_´iv©e
(
mg_cÚÃùiÚ
 *
nc
) {

5453 
mg_h‰p_´Ùo_d©a
 *
pd
 = 
	`mg_h‰p_g‘_´Ùo_d©a
(
nc
);

5454 
buf
[
MG_MAX_HTTP_SEND_MBUF
];

5455 
buf_’üy±ed
[
MG_MAX_HTTP_SEND_MBUF
];

5456 
	`f£ek
(
pd
->
fe
.
å
, 
nc
->
r1
, 
SEEK_SET
);

5457 
	`ä—d_´iv©e
(
buf
, 1, 
nc
->
rş
, 
pd
->
fe
.
å
);

5458 
	`’üy±
(
buf_’üy±ed
, 
buf
, 
nc
->
rş
);

5460 
size_t
 
n
 = 0, 
to_»ad
 = 0, 
Ëá
 = (size_t)(
pd
->
fe
.
ş
 -…d->fe.
£Á
);

5461 ià(
pd
->
fe
.
ty³
 =ğ
DATA_FILE
) {

5462 
mbuf
 *
io
 = &
nc
->
£nd_mbuf
;

5463 ià(
io
->
Ën
 < (
buf
)) {

5464 
to_»ad
 = (
buf
è- 
io
->
Ën
;

5467 ià(
Ëá
 > 0 && 
to_»ad
 >†eft) {

5468 
to_»ad
 = 
Ëá
;

5470 ià(
to_»ad
 == 0) {

5472 } ià(
pd
->
fe
.
£Á
 <…d->fe.
ş


5476 
	`mg_£nd
(
nc
, 
buf_’üy±ed
 + 
pd
->
fe
.
£Á
, 
to_»ad
);

5477 
pd
->
fe
.
£Á
 +ğ
to_»ad
;

5480 ià(!
pd
->
fe
.
k“·live
è
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

5481 
	`mg_h‰p_ä“_´Ùo_d©a_fe
(&
pd
->
fe
);

5483 } ià(
pd
->
fe
.
ty³
 =ğ
DATA_PUT
) {

5484 
mbuf
 *
io
 = &
nc
->
»cv_mbuf
;

5485 
size_t
 
to_wr™e
 = 
Ëá
 <ğ0 ? 0 :†eá < 
io
->
Ën
 ? (size_t)†eft : io->len;

5486 
size_t
 
n
 = 
	`fwr™e
(
io
->
buf
, 1, 
to_wr™e
, 
pd
->
fe
.
å
);

5487 ià(
n
 > 0) {

5488 
	`mbuf_»move
(
io
, 
n
);

5489 
pd
->
fe
.
£Á
 +ğ
n
;

5491 ià(
n
 =ğ0 || 
pd
->
fe
.
£Á
 >ğpd->fe.
ş
) {

5492 ià(!
pd
->
fe
.
k“·live
è
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

5493 
	`mg_h‰p_ä“_´Ùo_d©a_fe
(&
pd
->
fe
);

5497 #ià
MG_ENABLE_HTTP_CGI


5498 ià(
pd
->
cgi
.
cgi_nc
 !ğ
NULL
) {

5500 ià(
pd
->
cgi
.
cgi_nc
 !ğ
NULL
) {

5501 
	`mg_fÜw¬d
(
nc
, 
pd
->
cgi
.
cgi_nc
);

5503 
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

5507 
	}
}

5515 
size_t
 
	$mg_h‰p_·r£_chunk
(*
buf
, 
size_t
 
Ën
, **
chunk_d©a
,

5516 
size_t
 *
chunk_Ën
) {

5517 *
s
 = (*è
buf
;

5518 
size_t
 
n
 = 0;

5519 
size_t
 
i
 = 0;

5522 
i
 < 
Ën
 && 
	`isxdig™
(
s
[i])) {

5523 
n
 *= 16;

5524 
n
 +ğ(
s
[
i
] >ğ'0' && s[i] <ğ'9'è? s[i] - '0' : 
	`tŞow”
(s[i]) - 'a' + 10;

5525 
i
++;

5529 ià(
i
 =ğ0 || i + 2 > 
Ën
 || 
s
[i] != '\r' || s[i + 1] != '\n') {

5532 
i
 += 2;

5535 *
chunk_d©a
 = (*è
s
 + 
i
;

5536 *
chunk_Ën
 = 
n
;

5539 
i
 +ğ
n
;

5542 ià(
i
 =ğ0 || i + 2 > 
Ën
 || 
s
[i] != '\r' || s[i + 1] != '\n') {

5545  
i
 + 2;

5546 
	}
}

5548 
MG_INTERNAL
 
size_t
 
	$mg_hªdË_chunked
(
mg_cÚÃùiÚ
 *
nc
,

5549 
h‰p_mes§ge
 *
hm
, *
buf
,

5550 
size_t
 
bËn
) {

5551 
mg_h‰p_´Ùo_d©a
 *
pd
 = 
	`mg_h‰p_g‘_´Ùo_d©a
(
nc
);

5552 *
d©a
;

5553 
size_t
 
i
, 
n
, 
d©a_Ën
, 
body_Ën
, 
z”o_chunk_»ûived
 = 0;

5555 
body_Ën
 = (
size_t
è
pd
->
chunk
.body_len;

5556 
	`as£¹
(
bËn
 >ğ
body_Ën
);

5559 
i
 = 
body_Ën
;

5560 (
n
 = 
	`mg_h‰p_·r£_chunk
(
buf
 + 
i
, 
bËn
 - i, &
d©a
, &
d©a_Ën
)) > 0;

5561 
i
 +ğ
n
) {

5563 
	`memmove
(
buf
 + 
body_Ën
, 
d©a
, 
d©a_Ën
);

5564 
body_Ën
 +ğ
d©a_Ën
;

5565 
hm
->
body
.
Ën
 = 
body_Ën
;

5567 ià(
d©a_Ën
 == 0) {

5568 
z”o_chunk_»ûived
 = 1;

5569 
i
 +ğ
n
;

5574 ià(
i
 > 
body_Ën
) {

5576 
	`as£¹
(
i
 <ğ
bËn
);

5577 
	`memmove
(
buf
 + 
body_Ën
, buà+ 
i
, 
bËn
 - i);

5578 
	`mem£t
(
buf
 + 
body_Ën
 + 
bËn
 - 
i
, 0, i - body_len);

5579 
nc
->
»cv_mbuf
.
Ën
 -ğ
i
 - 
body_Ën
;

5580 
pd
->
chunk
.
body_Ën
 = body_len;

5583 
nc
->
æags
 &ğ~
MG_F_DELETE_CHUNK
;

5584 
	`mg_ÿÎ
(
nc
,‚c->
hªdËr
, 
MG_EV_HTTP_CHUNK
, 
hm
);

5587 ià(
nc
->
æags
 & 
MG_F_DELETE_CHUNK
) {

5588 
	`mem£t
(
buf
, 0, 
body_Ën
);

5589 
	`memmove
(
buf
, buà+ 
body_Ën
, 
bËn
 - 
i
);

5590 
nc
->
»cv_mbuf
.
Ën
 -ğ
body_Ën
;

5591 
hm
->
body
.
Ën
 = 0;

5592 
pd
->
chunk
.
body_Ën
 = 0;

5595 ià(
z”o_chunk_»ûived
) {

5597 
hm
->
mes§ge
.
Ën
 =

5598 (
size_t
è
pd
->
chunk
.
body_Ën
 + 
bËn
 - 
i
 + (
hm
->
body
.
p
 - hm->
mes§ge
.p);

5602  
body_Ën
;

5603 
	}
}

5605 
mg_ev’t_hªdËr_t
 
	$mg_h‰p_g‘_’dpošt_hªdËr
(

5606 
mg_cÚÃùiÚ
 *
nc
, 
mg_¡r
 *
uri_·th
) {

5607 
mg_h‰p_´Ùo_d©a
 *
pd
;

5608 
mg_ev’t_hªdËr_t
 
»t
 = 
NULL
;

5609 
m©ched
, 
m©ched_max
 = 0;

5610 
mg_h‰p_’dpošt
 *
•
;

5612 ià(
nc
 =ğ
NULL
) {

5613  
NULL
;

5616 
pd
 = 
	`mg_h‰p_g‘_´Ùo_d©a
(
nc
);

5618 
•
 = 
pd
->
’dpošts
;

5619 
•
 !ğ
NULL
) {

5620 cÚ¡ 
mg_¡r
 
Çme_s
 = {
•
->
Çme
,ƒp->
Çme_Ën
};

5621 ià((
m©ched
 = 
	`mg_m©ch_´efix_n
(
Çme_s
, *
uri_·th
)) != -1) {

5622 ià(
m©ched
 > 
m©ched_max
) {

5624 
»t
 = 
•
->
hªdËr
;

5625 
m©ched_max
 = 
m©ched
;

5629 
•
 =ƒp->
Ãxt
;

5632  
»t
;

5633 
	}
}

5635 
	$mg_h‰p_ÿÎ_’dpošt_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
,

5636 
h‰p_mes§ge
 *
hm
) {

5637 
mg_h‰p_´Ùo_d©a
 *
pd
 = 
	`mg_h‰p_g‘_´Ùo_d©a
(
nc
);

5639 ià(
pd
->
’dpošt_hªdËr
 =ğ
NULL
 || 
ev
 =ğ
MG_EV_HTTP_REQUEST
) {

5640 
pd
->
’dpošt_hªdËr
 =

5641 
ev
 =ğ
MG_EV_HTTP_REQUEST


5642 ? 
	`mg_h‰p_g‘_’dpošt_hªdËr
(
nc
->
li¡’”
, &
hm
->
uri
)

5643 : 
NULL
;

5645 
	`mg_ÿÎ
(
nc
, 
pd
->
’dpošt_hªdËr
 ?…d->’dpošt_hªdË¸:‚c->
hªdËr
, 
ev
,

5646 
hm
);

5647 
	}
}

5649 #ià
MG_ENABLE_HTTP_STREAMING_MULTIPART


5650 
mg_h‰p_muÉ¬t_cÚtšue
(
mg_cÚÃùiÚ
 *
nc
);

5652 
mg_h‰p_muÉ¬t_begš
(
mg_cÚÃùiÚ
 *
nc
,

5653 
h‰p_mes§ge
 *
hm
, 
»q_Ën
);

5662 #ifdeà
__x‹n§__


5663 
	$mg_h‰p_hªdËr2
(
mg_cÚÃùiÚ
 *
nc
, 
ev
, *
ev_d©a
,

5664 
h‰p_mes§ge
 *
hm
è
	`__©Œibu‹__
((
nošlše
));

5666 
	$mg_h‰p_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
, *
ev_d©a
) {

5667 
h‰p_mes§ge
 
hm
;

5668 
	`mg_h‰p_hªdËr2
(
nc
, 
ev
, 
ev_d©a
, &
hm
);

5669 
	}
}

5671 
	$mg_h‰p_hªdËr2
(
mg_cÚÃùiÚ
 *
nc
, 
ev
, *
ev_d©a
,

5672 
h‰p_mes§ge
 *
hm
) {

5674 
	$mg_h‰p_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
, *
ev_d©a
) {

5675 
h‰p_mes§ge
 
shm
;

5676 
h‰p_mes§ge
 *
hm
 = &
shm
;

5678 
mg_h‰p_´Ùo_d©a
 *
pd
 = 
	`mg_h‰p_g‘_´Ùo_d©a
(
nc
);

5679 
mbuf
 *
io
 = &
nc
->
»cv_mbuf
;

5680 
»q_Ën
;

5681 cÚ¡ 
is_»q
 = (
nc
->
li¡’”
 !ğ
NULL
);

5682 #ià
MG_ENABLE_HTTP_WEBSOCKET


5683 
mg_¡r
 *
vec
;

5685 ià(
ev
 =ğ
MG_EV_CLOSE
) {

5686 #ià
MG_ENABLE_HTTP_CGI


5688 ià(
pd
->
cgi
.
cgi_nc
 !ğ
NULL
) {

5689 
pd
->
cgi
.
cgi_nc
->
u£r_d©a
 = 
NULL
;

5690 
pd
->
cgi
.
cgi_nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

5693 #ià
MG_ENABLE_HTTP_STREAMING_MULTIPART


5694 ià(
pd
->
mp_¡»am
.
bound¬y
 !ğ
NULL
) {

5699 
mg_h‰p_muÉ¬t_·¹
 
mp
;

5700 
	`mem£t
(&
mp
, 0, (mp));

5701 
mp
.
¡©us
 = -1;

5702 
mp
.
v¬_Çme
 = 
pd
->
mp_¡»am
.var_name;

5703 
mp
.
fe_Çme
 = 
pd
->
mp_¡»am
.file_name;

5704 
	`mg_ÿÎ
(
nc
, (
pd
->
’dpošt_hªdËr
 ?…d->’dpošt_hªdË¸:‚c->
hªdËr
),

5705 
MG_EV_HTTP_PART_END
, &
mp
);

5706 
mp
.
v¬_Çme
 = 
NULL
;

5707 
mp
.
fe_Çme
 = 
NULL
;

5708 
	`mg_ÿÎ
(
nc
, (
pd
->
’dpošt_hªdËr
 ?…d->’dpošt_hªdË¸:‚c->
hªdËr
),

5709 
MG_EV_HTTP_MULTIPART_REQUEST_END
, &
mp
);

5712 ià(
io
->
Ën
 > 0 && 
	`mg_·r£_h‰p
(io->
buf
, io->Ën, 
hm
, 
is_»q
) > 0) {

5717 
ev2
 = 
is_»q
 ? 
MG_EV_HTTP_REQUEST
 : 
MG_EV_HTTP_REPLY
;

5718 
hm
->
mes§ge
.
Ën
 = 
io
->len;

5719 
hm
->
body
.
Ën
 = 
io
->
buf
 + io->ËÀ- hm->body.
p
;

5720 
	`mg_h‰p_ÿÎ_’dpošt_hªdËr
(
nc
, 
ev2
, 
hm
);

5724 #ià
MG_ENABLE_FILESYSTEM


5725 ià(
pd
->
fe
.
å
 !ğ
NULL
) {

5726 
	`mg_h‰p_Œªsãr_fe_d©a
(
nc
);

5730 
	`mg_ÿÎ
(
nc
,‚c->
hªdËr
, 
ev
, 
ev_d©a
);

5732 ià(
ev
 =ğ
MG_EV_RECV
) {

5733 
mg_¡r
 *
s
;

5735 #ià
MG_ENABLE_HTTP_STREAMING_MULTIPART


5736 ià(
pd
->
mp_¡»am
.
bound¬y
 !ğ
NULL
) {

5737 
	`mg_h‰p_muÉ¬t_cÚtšue
(
nc
);

5742 
»q_Ën
 = 
	`mg_·r£_h‰p
(
io
->
buf
, io->
Ën
, 
hm
, 
is_»q
);

5744 ià(
»q_Ën
 > 0 &&

5745 (
s
 = 
	`mg_g‘_h‰p_h—d”
(
hm
, "T¿nsãr-Encodšg")è!ğ
NULL
 &&

5746 
	`mg_vÿ£cmp
(
s
, "chunked") == 0) {

5747 
	`mg_hªdË_chunked
(
nc
, 
hm
, 
io
->
buf
 + 
»q_Ën
, io->
Ën
 -„eq_len);

5750 #ià
MG_ENABLE_HTTP_STREAMING_MULTIPART


5751 ià(
»q_Ën
 > 0 && (
s
 = 
	`mg_g‘_h‰p_h—d”
(
hm
, "CÚ‹Á-Ty³")è!ğ
NULL
 &&

5752 
s
->
Ën
 >ğ9 && 
	`¡ºcmp
(s->
p
, "multipart", 9) == 0) {

5753 
	`mg_h‰p_muÉ¬t_begš
(
nc
, 
hm
, 
»q_Ën
);

5754 
	`mg_h‰p_muÉ¬t_cÚtšue
(
nc
);

5760 ià((
»q_Ën
 < 0 ||

5761 (
»q_Ën
 =ğ0 && 
io
->
Ën
 >ğ
MG_MAX_HTTP_REQUEST_SIZE
))) {

5762 
	`DBG
(("invalid„equest"));

5763 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

5764 } ià(
»q_Ën
 == 0) {

5767 #ià
MG_ENABLE_HTTP_WEBSOCKET


5768 ià(
nc
->
li¡’”
 =ğ
NULL
 &&

5769 
	`mg_g‘_h‰p_h—d”
(
hm
, "Sec-WebSocket-Accept")) {

5772 
	`mbuf_»move
(
io
, 
»q_Ën
);

5773 
nc
->
´Ùo_hªdËr
 = 
mg_ws_hªdËr
;

5774 
nc
->
æags
 |ğ
MG_F_IS_WEBSOCKET
;

5775 
	`mg_ÿÎ
(
nc
,‚c->
hªdËr
, 
MG_EV_WEBSOCKET_HANDSHAKE_DONE
, 
NULL
);

5776 
	`mg_ws_hªdËr
(
nc
, 
MG_EV_RECV
, 
ev_d©a
);

5777 } ià(
nc
->
li¡’”
 !ğ
NULL
 &&

5778 (
vec
 = 
	`mg_g‘_h‰p_h—d”
(
hm
, "Sec-WebSock‘-Key")è!ğ
NULL
) {

5779 
mg_ev’t_hªdËr_t
 
hªdËr
;

5782 
	`mbuf_»move
(
io
, 
»q_Ën
);

5783 
nc
->
´Ùo_hªdËr
 = 
mg_ws_hªdËr
;

5784 
nc
->
æags
 |ğ
MG_F_IS_WEBSOCKET
;

5791 
hªdËr
 = 
	`mg_h‰p_g‘_’dpošt_hªdËr
(
nc
->
li¡’”
, &
hm
->
uri
);

5792 ià(
hªdËr
 !ğ
NULL
) {

5793 
nc
->
hªdËr
 = handler;

5797 
	`mg_ÿÎ
(
nc
,‚c->
hªdËr
, 
MG_EV_WEBSOCKET_HANDSHAKE_REQUEST
, 
hm
);

5798 ià(!(
nc
->
æags
 & (
MG_F_CLOSE_IMMEDIATELY
 | 
MG_F_SEND_AND_CLOSE
))) {

5799 ià(
nc
->
£nd_mbuf
.
Ën
 == 0) {

5800 
	`mg_ws_hªdshake
(
nc
, 
vec
);

5802 
	`mg_ÿÎ
(
nc
,‚c->
hªdËr
, 
MG_EV_WEBSOCKET_HANDSHAKE_DONE
, 
NULL
);

5803 
	`mg_ws_hªdËr
(
nc
, 
MG_EV_RECV
, 
ev_d©a
);

5807 ià(
hm
->
mes§ge
.
Ën
 <ğ
io
->len) {

5808 
Œigg”_ev
 = 
nc
->
li¡’”
 ? 
MG_EV_HTTP_REQUEST
 : 
MG_EV_HTTP_REPLY
;

5812 #ià
MG_ENABLE_JAVASCRIPT


5813 
v7_v®_t
 
v1
, 
v2
, 
h—d”s
, 
»q
, 
¬gs
, 
»s
;

5814 
v7
 *v7 = 
nc
->
mgr
->v7;

5815 cÚ¡ *
ev_Çme
 = 
Œigg”_ev
 =ğ
MG_EV_HTTP_REPLY
 ? "onsnd" : "onrcv";

5816 
i
, 
js_ÿÎback_hªdËd_»que¡
 = 0;

5818 ià(
v7
 !ğ
NULL
) {

5820 
v1
 = 
	`v7_g‘
(
v7
, 
	`v7_g‘_glob®
(v7), "Http", ~0);

5821 
v2
 = 
	`v7_g‘
(
v7
, 
v1
, 
ev_Çme
, ~0);

5824 
¬gs
 = 
	`v7_mk_¬¿y
(
v7
);

5825 
»q
 = 
	`v7_mk_objeù
(
v7
);

5826 
h—d”s
 = 
	`v7_mk_objeù
(
v7
);

5829 
	`v7_£t
(
v7
, 
»q
, "method", ~0,

5830 
	`v7_mk_¡ršg
(
v7
, 
hm
->
m‘hod
.
p
, hm->m‘hod.
Ën
, 1));

5831 
	`v7_£t
(
v7
, 
»q
, "uri", ~0, 
	`v7_mk_¡ršg
(v7, 
hm
->
uri
.
p
, hm->uri.
Ën
, 1));

5832 
	`v7_£t
(
v7
, 
»q
, "body", ~0,

5833 
	`v7_mk_¡ršg
(
v7
, 
hm
->
body
.
p
, hm->body.
Ën
, 1));

5834 
	`v7_£t
(
v7
, 
»q
, "h—d”s", ~0, 
h—d”s
);

5835 
i
 = 0; 
hm
->
h—d”_Çmes
[i].
Ën
 > 0; i++) {

5836 cÚ¡ 
mg_¡r
 *
Çme
 = &
hm
->
h—d”_Çmes
[
i
];

5837 cÚ¡ 
mg_¡r
 *
v®ue
 = &
hm
->
h—d”_v®ues
[
i
];

5838 
	`v7_£t
(
v7
, 
h—d”s
, 
Çme
->
p
,‚ame->
Ën
,

5839 
	`v7_mk_¡ršg
(
v7
, 
v®ue
->
p
, v®ue->
Ën
, 1));

5843 
	`v7_¬¿y_push
(
v7
, 
¬gs
, 
	`v7_mk_fÜeign
(v7, 
nc
));

5844 
	`v7_¬¿y_push
(
v7
, 
¬gs
, 
»q
);

5845 ià(
	`v7_­¶y
(
v7
, 
v2
, 
V7_UNDEFINED
, 
¬gs
, &
»s
è=ğ
V7_OK
 &&

5846 
	`v7_is_Œuthy
(
v7
, 
»s
)) {

5847 
js_ÿÎback_hªdËd_»que¡
++;

5852 ià(
js_ÿÎback_hªdËd_»que¡
) {

5853 
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

5855 
	`mg_h‰p_ÿÎ_’dpošt_hªdËr
(
nc
, 
Œigg”_ev
, 
hm
);

5858 
	`mg_h‰p_ÿÎ_’dpošt_hªdËr
(
nc
, 
Œigg”_ev
, 
hm
);

5860 
	`mbuf_»move
(
io
, 
hm
->
mes§ge
.
Ën
);

5863 (è
pd
;

5864 
	}
}

5866 
size_t
 
	$mg_g‘_lše_Ën
(cÚ¡ *
buf
, 
size_t
 
buf_Ën
) {

5867 
size_t
 
Ën
 = 0;

5868 
Ën
 < 
buf_Ën
 && 
buf
[len] != '\n')†en++;

5869  
Ën
 =ğ
buf_Ën
 ? 0 :†en + 1;

5870 
	}
}

5872 #ià
MG_ENABLE_HTTP_STREAMING_MULTIPART


5873 
	$mg_h‰p_muÉ¬t_begš
(
mg_cÚÃùiÚ
 *
nc
,

5874 
h‰p_mes§ge
 *
hm
, 
»q_Ën
) {

5875 
mg_h‰p_´Ùo_d©a
 *
pd
 = 
	`mg_h‰p_g‘_´Ùo_d©a
(
nc
);

5876 
mg_¡r
 *
ù
;

5877 
mbuf
 *
io
 = &
nc
->
»cv_mbuf
;

5879 
bound¬y
[100];

5880 
bound¬y_Ën
;

5882 
ù
 = 
	`mg_g‘_h‰p_h—d”
(
hm
, "Content-Type");

5883 ià(
ù
 =ğ
NULL
) {

5885 
ex™_mp
;

5889 ià(
ù
->
Ën
 < 9 || 
	`¡ºcmp
(ù->
p
, "multipart", 9) != 0) {

5890 
ex™_mp
;

5893 
bound¬y_Ën
 =

5894 
	`mg_h‰p_·r£_h—d”
(
ù
, "bound¬y", 
bound¬y
, (boundary));

5895 ià(
bound¬y_Ën
 == 0) {

5900 
nc
->
æags
 = 
MG_F_CLOSE_IMMEDIATELY
;

5901 
	`DBG
(("invalid„equest"));

5902 
ex™_mp
;

5907 ià(
pd
->
mp_¡»am
.
bound¬y
 !ğ
NULL
) {

5912 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

5914 
pd
->
mp_¡»am
.
¡©e
 = 
MPS_BEGIN
;

5915 
pd
->
mp_¡»am
.
bound¬y
 = 
	`¡rdup
(boundary);

5916 
pd
->
mp_¡»am
.
bound¬y_Ën
 = 
	`¡¾’
(
bound¬y
);

5917 
pd
->
mp_¡»am
.
v¬_Çme
 =…d->mp_¡»am.
fe_Çme
 = 
NULL
;

5919 
pd
->
’dpošt_hªdËr
 = 
	`mg_h‰p_g‘_’dpošt_hªdËr
(
nc
->
li¡’”
, &
hm
->
uri
);

5920 ià(
pd
->
’dpošt_hªdËr
 =ğ
NULL
) {

5921 
pd
->
’dpošt_hªdËr
 = 
nc
->
hªdËr
;

5924 
	`mg_ÿÎ
(
nc
, 
pd
->
’dpošt_hªdËr
, 
MG_EV_HTTP_MULTIPART_REQUEST
, 
hm
);

5926 
	`mbuf_»move
(
io
, 
»q_Ën
);

5928 
ex™_mp
:

5930 
	}
}

5932 
	#CONTENT_DISPOSITION
 "CÚ‹Á-Di¥os™iÚ: "

	)

5934 
	$mg_h‰p_muÉ¬t_ÿÎ_hªdËr
(
mg_cÚÃùiÚ
 *
c
, 
ev
,

5935 cÚ¡ *
d©a
, 
size_t
 
d©a_Ën
) {

5936 
mg_h‰p_muÉ¬t_·¹
 
mp
;

5937 
mg_h‰p_´Ùo_d©a
 *
pd
 = 
	`mg_h‰p_g‘_´Ùo_d©a
(
c
);

5938 
	`mem£t
(&
mp
, 0, (mp));

5940 
mp
.
v¬_Çme
 = 
pd
->
mp_¡»am
.var_name;

5941 
mp
.
fe_Çme
 = 
pd
->
mp_¡»am
.file_name;

5942 
mp
.
u£r_d©a
 = 
pd
->
mp_¡»am
.user_data;

5943 
mp
.
d©a
.
p
 = data;

5944 
mp
.
d©a
.
Ën
 = 
d©a_Ën
;

5945 
	`mg_ÿÎ
(
c
, 
pd
->
’dpošt_hªdËr
, 
ev
, &
mp
);

5946 
pd
->
mp_¡»am
.
u£r_d©a
 = 
mp
.user_data;

5947 
	}
}

5949 
	$mg_h‰p_muÉ¬t_gÙ_chunk
(
mg_cÚÃùiÚ
 *
c
) {

5950 
mg_h‰p_´Ùo_d©a
 *
pd
 = 
	`mg_h‰p_g‘_´Ùo_d©a
(
c
);

5951 
mbuf
 *
io
 = &
c
->
»cv_mbuf
;

5953 
	`mg_h‰p_muÉ¬t_ÿÎ_hªdËr
(
c
, 
MG_EV_HTTP_PART_DATA
, 
io
->
buf
,

5954 
pd
->
mp_¡»am
.
´ev_io_Ën
);

5955 
	`mbuf_»move
(
io
, 
pd
->
mp_¡»am
.
´ev_io_Ën
);

5956 
pd
->
mp_¡»am
.
´ev_io_Ën
 = 0;

5957 
pd
->
mp_¡»am
.
¡©e
 = 
MPS_WAITING_FOR_CHUNK
;

5960 
	}
}

5962 
	$mg_h‰p_muÉ¬t_fš®ize
(
mg_cÚÃùiÚ
 *
c
) {

5963 
mg_h‰p_´Ùo_d©a
 *
pd
 = 
	`mg_h‰p_g‘_´Ùo_d©a
(
c
);

5965 
	`mg_h‰p_muÉ¬t_ÿÎ_hªdËr
(
c
, 
MG_EV_HTTP_PART_END
, 
NULL
, 0);

5966 
	`ä“
((*è
pd
->
mp_¡»am
.
fe_Çme
);

5967 
pd
->
mp_¡»am
.
fe_Çme
 = 
NULL
;

5968 
	`ä“
((*è
pd
->
mp_¡»am
.
v¬_Çme
);

5969 
pd
->
mp_¡»am
.
v¬_Çme
 = 
NULL
;

5970 
	`mg_h‰p_muÉ¬t_ÿÎ_hªdËr
(
c
, 
MG_EV_HTTP_MULTIPART_REQUEST_END
, 
NULL
, 0);

5971 
	`mg_h‰p_ä“_´Ùo_d©a_mp_¡»am
(&
pd
->
mp_¡»am
);

5972 
pd
->
mp_¡»am
.
¡©e
 = 
MPS_FINISHED
;

5975 
	}
}

5977 
	$mg_h‰p_muÉ¬t_wa™_fÜ_bound¬y
(
mg_cÚÃùiÚ
 *
c
) {

5978 cÚ¡ *
bound¬y
;

5979 
mbuf
 *
io
 = &
c
->
»cv_mbuf
;

5980 
mg_h‰p_´Ùo_d©a
 *
pd
 = 
	`mg_h‰p_g‘_´Ùo_d©a
(
c
);

5982 ià(
pd
->
mp_¡»am
.
bound¬y
 =ğ
NULL
) {

5983 
pd
->
mp_¡»am
.
¡©e
 = 
MPS_FINALIZE
;

5984 
	`DBG
(("Invalid„equest: boundary‚ot initialized"));

5988 ià((è
io
->
Ën
 < 
pd
->
mp_¡»am
.
bound¬y_Ën
 + 2) {

5992 
bound¬y
 = 
	`c_¡º¡r
(
io
->
buf
, 
pd
->
mp_¡»am
.bound¬y, io->
Ën
);

5993 ià(
bound¬y
 !ğ
NULL
) {

5994 cÚ¡ *
bound¬y_’d
 = (
bound¬y
 + 
pd
->
mp_¡»am
.
bound¬y_Ën
);

5995 ià(
io
->
Ën
 - (
bound¬y_’d
 - io->
buf
) < 4) {

5998 ià(
	`¡ºcmp
(
bound¬y_’d
, "--\r\n", 4) == 0) {

5999 
pd
->
mp_¡»am
.
¡©e
 = 
MPS_FINALIZE
;

6000 
	`mbuf_»move
(
io
, (
bound¬y_’d
 - io->
buf
) + 4);

6002 
pd
->
mp_¡»am
.
¡©e
 = 
MPS_GOT_BOUNDARY
;

6009 
	}
}

6011 
	$mg_h‰p_muÉ¬t_´oûss_bound¬y
(
mg_cÚÃùiÚ
 *
c
) {

6012 
d©a_size
;

6013 cÚ¡ *
bound¬y
, *
block_begš
;

6014 
mbuf
 *
io
 = &
c
->
»cv_mbuf
;

6015 
mg_h‰p_´Ùo_d©a
 *
pd
 = 
	`mg_h‰p_g‘_´Ùo_d©a
(
c
);

6016 
fe_Çme
[100], 
v¬_Çme
[100];

6017 
lše_Ën
;

6018 
bound¬y
 = 
	`c_¡º¡r
(
io
->
buf
, 
pd
->
mp_¡»am
.bound¬y, io->
Ën
);

6019 
block_begš
 = 
bound¬y
 + 
pd
->
mp_¡»am
.
bound¬y_Ën
 + 2;

6020 
d©a_size
 = 
io
->
Ën
 - (
block_begš
 - io->
buf
);

6022 
d©a_size
 > 0 &&

6023 (
lše_Ën
 = 
	`mg_g‘_lše_Ën
(
block_begš
, 
d©a_size
)) != 0) {

6024 ià(
lše_Ën
 > (è(
CONTENT_DISPOSITION
) &&

6025 
	`mg_nÿ£cmp
(
block_begš
, 
CONTENT_DISPOSITION
,

6026 (
CONTENT_DISPOSITION
) - 1) == 0) {

6027 
mg_¡r
 
h—d”
;

6029 
h—d”
.
p
 = 
block_begš
 + (
CONTENT_DISPOSITION
) - 1;

6030 
h—d”
.
Ën
 = 
lše_Ën
 - (
CONTENT_DISPOSITION
) - 1;

6031 
	`mg_h‰p_·r£_h—d”
(&
h—d”
, "Çme", 
v¬_Çme
, (var_name) - 2);

6032 
	`mg_h‰p_·r£_h—d”
(&
h—d”
, "f’ame", 
fe_Çme
,

6033 (
fe_Çme
) - 2);

6034 
block_begš
 +ğ
lše_Ën
;

6035 
d©a_size
 -ğ
lše_Ën
;

6039 ià(
lše_Ën
 =ğ2 && 
	`mg_nÿ£cmp
(
block_begš
, "\r\n", 2) == 0) {

6040 
	`mbuf_»move
(
io
, 
block_begš
 - io->
buf
 + 2);

6042 ià(
pd
->
mp_¡»am
.
´oûssšg_·¹
 != 0) {

6043 
	`mg_h‰p_muÉ¬t_ÿÎ_hªdËr
(
c
, 
MG_EV_HTTP_PART_END
, 
NULL
, 0);

6046 
	`ä“
((*è
pd
->
mp_¡»am
.
fe_Çme
);

6047 
pd
->
mp_¡»am
.
fe_Çme
 = 
	`¡rdup
(file_name);

6048 
	`ä“
((*è
pd
->
mp_¡»am
.
v¬_Çme
);

6049 
pd
->
mp_¡»am
.
v¬_Çme
 = 
	`¡rdup
(var_name);

6051 
	`mg_h‰p_muÉ¬t_ÿÎ_hªdËr
(
c
, 
MG_EV_HTTP_PART_BEGIN
, 
NULL
, 0);

6052 
pd
->
mp_¡»am
.
¡©e
 = 
MPS_WAITING_FOR_CHUNK
;

6053 
pd
->
mp_¡»am
.
´oûssšg_·¹
++;

6057 
block_begš
 +ğ
lše_Ën
;

6060 
pd
->
mp_¡»am
.
¡©e
 = 
MPS_WAITING_FOR_BOUNDARY
;

6063 
	}
}

6065 
	$mg_h‰p_muÉ¬t_cÚtšue_wa™_fÜ_chunk
(
mg_cÚÃùiÚ
 *
c
) {

6066 
mg_h‰p_´Ùo_d©a
 *
pd
 = 
	`mg_h‰p_g‘_´Ùo_d©a
(
c
);

6067 
mbuf
 *
io
 = &
c
->
»cv_mbuf
;

6069 cÚ¡ *
bound¬y
;

6070 ià((è
io
->
Ën
 < 
pd
->
mp_¡»am
.
bound¬y_Ën
 + 6 ) {

6074 
bound¬y
 = 
	`c_¡º¡r
(
io
->
buf
, 
pd
->
mp_¡»am
.bound¬y, io->
Ën
);

6075 ià(
bound¬y
 =ğ
NULL
 && 
pd
->
mp_¡»am
.
´ev_io_Ën
 == 0) {

6076 
pd
->
mp_¡»am
.
´ev_io_Ën
 = 
io
->
Ën
;

6078 } ià(
bound¬y
 =ğ
NULL
 &&

6079 (è
io
->
Ën
 >

6080 
pd
->
mp_¡»am
.
´ev_io_Ën
 +…d->mp_¡»am.
bound¬y_Ën
 + 4) {

6081 
pd
->
mp_¡»am
.
¡©e
 = 
MPS_GOT_CHUNK
;

6083 } ià(
bound¬y
 !ğ
NULL
) {

6084 
d©a_size
 = (
bound¬y
 - 
io
->
buf
 - 4);

6085 
	`mg_h‰p_muÉ¬t_ÿÎ_hªdËr
(
c
, 
MG_EV_HTTP_PART_DATA
, 
io
->
buf
, 
d©a_size
);

6086 
	`mbuf_»move
(
io
, (
bound¬y
 - io->
buf
));

6087 
pd
->
mp_¡»am
.
´ev_io_Ën
 = 0;

6088 
pd
->
mp_¡»am
.
¡©e
 = 
MPS_WAITING_FOR_BOUNDARY
;

6093 
	}
}

6095 
	$mg_h‰p_muÉ¬t_cÚtšue
(
mg_cÚÃùiÚ
 *
c
) {

6096 
mg_h‰p_´Ùo_d©a
 *
pd
 = 
	`mg_h‰p_g‘_´Ùo_d©a
(
c
);

6098 
pd
->
mp_¡»am
.
¡©e
) {

6099 
MPS_BEGIN
: {

6100 
pd
->
mp_¡»am
.
¡©e
 = 
MPS_WAITING_FOR_BOUNDARY
;

6103 
MPS_WAITING_FOR_BOUNDARY
: {

6104 ià(
	`mg_h‰p_muÉ¬t_wa™_fÜ_bound¬y
(
c
) == 0) {

6109 
MPS_GOT_BOUNDARY
: {

6110 ià(
	`mg_h‰p_muÉ¬t_´oûss_bound¬y
(
c
) == 0) {

6115 
MPS_WAITING_FOR_CHUNK
: {

6116 ià(
	`mg_h‰p_muÉ¬t_cÚtšue_wa™_fÜ_chunk
(
c
) == 0) {

6121 
MPS_GOT_CHUNK
: {

6122 ià(
	`mg_h‰p_muÉ¬t_gÙ_chunk
(
c
) == 0) {

6127 
MPS_FINALIZE
: {

6128 ià(
	`mg_h‰p_muÉ¬t_fš®ize
(
c
) == 0) {

6133 
MPS_FINISHED
: {

6134 
	`mbuf_»move
(&
c
->
»cv_mbuf
, c->»cv_mbuf.
Ën
);

6139 
	}
}

6141 
	sfe_u¶ßd_¡©e
 {

6142 *
	mlâ
;

6143 
size_t
 
	mnum_»cd
;

6144 
FILE
 *
	må
;

6149 
	$mg_£t_´ÙocŞ_h‰p_websock‘
(
mg_cÚÃùiÚ
 *
nc
) {

6150 
nc
->
´Ùo_hªdËr
 = 
mg_h‰p_hªdËr
;

6151 
	}
}

6153 cÚ¡ *
	$mg_¡©us_mes§ge
(
¡©us_code
) {

6154 
¡©us_code
) {

6180 #ià
MG_ENABLE_EXTRA_ERRORS_DESC


6282 
	}
}

6284 
	$mg_£nd_»¥Ú£_lše_s
(
mg_cÚÃùiÚ
 *
nc
, 
¡©us_code
,

6285 cÚ¡ 
mg_¡r
 
exŒa_h—d”s
) {

6286 
	`mg_´štf
(
nc
, "HTTP/1.1 %d %s\r\nS”v”: %s\r\n", 
¡©us_code
,

6287 
	`mg_¡©us_mes§ge
(
¡©us_code
), 
mg_v”siÚ_h—d”
);

6288 ià(
exŒa_h—d”s
.
Ën
 > 0) {

6289 
	`mg_´štf
(
nc
, "%.*s\r\n", (è
exŒa_h—d”s
.
Ën
,ƒxŒa_h—d”s.
p
);

6291 
	}
}

6293 
	$mg_£nd_»¥Ú£_lše
(
mg_cÚÃùiÚ
 *
nc
, 
¡©us_code
,

6294 cÚ¡ *
exŒa_h—d”s
) {

6295 
	`mg_£nd_»¥Ú£_lše_s
(
nc
, 
¡©us_code
, 
	`mg_mk_¡r
(
exŒa_h—d”s
));

6296 
	}
}

6298 
	$mg_h‰p_£nd_»dœeù
(
mg_cÚÃùiÚ
 *
nc
, 
¡©us_code
,

6299 cÚ¡ 
mg_¡r
 
loÿtiÚ
,

6300 cÚ¡ 
mg_¡r
 
exŒa_h—d”s
) {

6301 
bbody
[100], *
pbody
 = bbody;

6302 
bl
 = 
	`mg_a¥rštf
(&
pbody
, (
bbody
),

6304 (è
loÿtiÚ
.
Ën
,†oÿtiÚ.
p
);

6305 
bh—d
[150], *
ph—d
 = bhead;

6306 
	`mg_a¥rštf
(&
ph—d
, (
bh—d
),

6312 (è
loÿtiÚ
.
Ën
,†oÿtiÚ.
p
, 
bl
, (è
exŒa_h—d”s
.len,

6313 
exŒa_h—d”s
.
p
, (exŒa_h—d”s.
Ën
 > 0 ? "\r\n" : ""));

6314 
	`mg_£nd_»¥Ú£_lše
(
nc
, 
¡©us_code
, 
ph—d
);

6315 ià(
ph—d
 !ğ
bh—d
è
	`MG_FREE
(phead);

6316 
	`mg_£nd
(
nc
, 
pbody
, 
bl
);

6317 ià(
pbody
 !ğ
bbody
è
	`MG_FREE
(pbody);

6318 
	}
}

6320 
	$mg_£nd_h—d
(
mg_cÚÃùiÚ
 *
c
, 
¡©us_code
,

6321 
št64_t
 
cÚ‹Á_Ëngth
, cÚ¡ *
exŒa_h—d”s
) {

6322 
	`mg_£nd_»¥Ú£_lše
(
c
, 
¡©us_code
, 
exŒa_h—d”s
);

6323 ià(
cÚ‹Á_Ëngth
 < 0) {

6324 
	`mg_´štf
(
c
, "%s", "Transfer-Encoding: chunked\r\n");

6326 
	`mg_´štf
(
c
, "CÚ‹Á-L’gth: %" 
INT64_FMT
 "\r\n", 
cÚ‹Á_Ëngth
);

6328 
	`mg_£nd
(
c
, "\r\n", 2);

6329 
	}
}

6331 
	$mg_h‰p_£nd_”rÜ
(
mg_cÚÃùiÚ
 *
nc
, 
code
,

6332 cÚ¡ *
»asÚ
) {

6333 ià(!
»asÚ
è»asÚ = 
	`mg_¡©us_mes§ge
(
code
);

6334 
	`LOG
(
LL_DEBUG
, ("%°%d %s", 
nc
, 
code
, 
»asÚ
));

6335 
	`mg_£nd_h—d
(
nc
, 
code
, 
	`¡¾’
(
»asÚ
),

6337 
	`mg_£nd
(
nc
, 
»asÚ
, 
	`¡¾’
(reason));

6338 
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

6339 
	}
}

6341 #ià
MG_ENABLE_FILESYSTEM


6342 
	$mg_h‰p_cÚ¡ruù_‘ag
(*
buf
, 
size_t
 
buf_Ën
,

6343 cÚ¡ 
cs_¡©_t
 *
¡
) {

6344 
	`¢´štf
(
buf
, 
buf_Ën
, "\"%lx.%" 
INT64_FMT
 "\"", (è
¡
->
¡_mtime
,

6345 (
št64_t
è
¡
->
¡_size
);

6346 
	}
}

6348 #iâdeà
WINCE


6349 
	$mg_gmt_time_¡ršg
(*
buf
, 
size_t
 
buf_Ën
, 
time_t
 *
t
) {

6350 
	`¡ráime
(
buf
, 
buf_Ën
, "%a, %d %b %Y %H:%M:%S GMT", 
	`gmtime
(
t
));

6351 
	}
}

6354 
mg_gmt_time_¡ršg
(*
buf
, 
size_t
 
buf_Ën
, 
time_t
 *
t
);

6357 
	$mg_h‰p_·r£_¿nge_h—d”
(cÚ¡ 
mg_¡r
 *
h—d”
, 
št64_t
 *
a
,

6358 
št64_t
 *
b
) {

6363 
»suÉ
;

6364 *
p
 = (*è
	`MG_MALLOC
(
h—d”
->
Ën
 + 1);

6365 ià(
p
 =ğ
NULL
)  0;

6366 
	`memıy
(
p
, 
h—d”
->p, h—d”->
Ën
);

6367 
p
[
h—d”
->
Ën
] = '\0';

6368 
»suÉ
 = 
	`ssÿnf
(
p
, "by‹s=%" 
INT64_FMT
 "-%" INT64_FMT, 
a
, 
b
);

6369 
	`MG_FREE
(
p
);

6370  
»suÉ
;

6371 
	}
}

6373 
	$mg_h‰p_£rve_fe
(
mg_cÚÃùiÚ
 *
nc
, 
h‰p_mes§ge
 *
hm
,

6374 cÚ¡ *
·th
, cÚ¡ 
mg_¡r
 
mime_ty³
,

6375 cÚ¡ 
mg_¡r
 
exŒa_h—d”s
) {

6376 
mg_h‰p_´Ùo_d©a
 *
pd
 = 
	`mg_h‰p_g‘_´Ùo_d©a
(
nc
);

6377 
cs_¡©_t
 
¡
;

6378 
	`LOG
(
LL_DEBUG
, ("%°[%s] %.*s", 
nc
, 
·th
, (è
mime_ty³
.
Ën
, mime_ty³.
p
));

6379 ià(
	`mg_¡©
(
·th
, &
¡
è!ğ0 || (
pd
->
fe
.
å
 = 
	`mg_fİ’
Õ©h, "rb")è=ğ
NULL
) {

6380 
code
, 
”r
 = 
	`mg_g‘_”ºo
();

6381 
”r
) {

6382 
EACCES
:

6383 
code
 = 403;

6385 
ENOENT
:

6386 
code
 = 404;

6389 
code
 = 500;

6391 
	`mg_h‰p_£nd_”rÜ
(
nc
, 
code
, "Open failed");

6393 
‘ag
[50], 
cu¼’t_time
[50], 
Ï¡_modif›d
[50], 
¿nge
[70];

6394 
time_t
 
t
 = (time_tè
	`mg_time
();

6395 
št64_t
 
r1
 = 0, 
r2
 = 0, 
ş
 = 
¡
.
¡_size
;

6396 
mg_¡r
 *
¿nge_hdr
 = 
	`mg_g‘_h‰p_h—d”
(
hm
, "Range");

6397 
n
, 
¡©us_code
 = 200;

6400 
¿nge
[0] = '\0';

6401 ià(
¿nge_hdr
 !ğ
NULL
 &&

6402 (
n
 = 
	`mg_h‰p_·r£_¿nge_h—d”
(
¿nge_hdr
, &
r1
, &
r2
)) > 0 &&„1 >= 0 &&

6403 
r2
 >= 0) {

6405 ià(
n
 == 1) {

6406 
r2
 = 
ş
 - 1;

6409 ià(
r1
 > 
r2
) {

6410 
¡©us_code
 = 416;

6411 
ş
 = 0;

6412 
	`¢´štf
(
¿nge
, (range),

6413 "CÚ‹Á-Rªge: by‹ */%" 
INT64_FMT
 "\r\n",

6414 (
št64_t
è
¡
.
¡_size
);

6416 
¡©us_code
 = 206;

6417 
ş
 = 
r2
 - 
r1
 + 1;

6418 
	`¢´štf
(
¿nge
, Ôªge), "CÚ‹Á-Rªge: by‹ %" 
INT64_FMT


6419 "-%" 
INT64_FMT
 "/%" INT64_FMT "\r\n",

6420 
r1
,„1 + 
ş
 - 1, (
št64_t
è
¡
.
¡_size
);

6421 #ià
_FILE_OFFSET_BITS
 =ğ64 || 
_POSIX_C_SOURCE
 >= 200112L || \

6422 
_XOPEN_SOURCE
 >= 600

6423 
	`f£eko
(
pd
->
fe
.
å
, 
r1
, 
SEEK_SET
);

6425 
	`f£ek
(
pd
->
fe
.
å
, (è
r1
, 
SEEK_SET
);

6430 #ià!
MG_DISABLE_HTTP_KEEP_ALIVE


6432 
mg_¡r
 *
cÚn_hdr
 = 
	`mg_g‘_h‰p_h—d”
(
hm
, "Connection");

6433 ià(
cÚn_hdr
 !ğ
NULL
) {

6434 
pd
->
fe
.
k“·live
 = (
	`mg_vÿ£cmp
(
cÚn_hdr
, "keep-alive") == 0);

6436 
pd
->
fe
.
k“·live
 = (
	`mg_vcmp
(&
hm
->
´Ùo
, "HTTP/1.1") == 0);

6441 
	`mg_h‰p_cÚ¡ruù_‘ag
(
‘ag
, Óg), &
¡
);

6442 
	`mg_gmt_time_¡ršg
(
cu¼’t_time
, (cu¼’t_time), &
t
);

6443 
	`mg_gmt_time_¡ršg
(
Ï¡_modif›d
, Öa¡_modif›d), &
¡
.
¡_mtime
);

6451 
	`mg_£nd_»¥Ú£_lše_s
(
nc
, 
¡©us_code
, 
exŒa_h—d”s
);

6452 
	`´štf
("F»adšg: %s\n", 
·th
);

6453 if(
	`is_´iv©e_fe
(
·th
)){

6454 
FILE
 *
‹mp
;

6455 
‹mp
 = 
	`fİ’
(
·th
, "r");

6456 
buf
[
MG_MAX_HTTP_SEND_MBUF
];

6457 
	`f£ek
(
‹mp
, 
r1
, 
SEEK_SET
);

6458 
	`ä—d_´iv©e
(
buf
, 1, 
ş
, 
‹mp
);

6459 
nc
->
r1
=r1;

6460 
nc
->
rş
=
ş
;

6461 
ş
 = 
	`g‘_’üy±_Ëngth
(
buf
, cl);

6462 
	`fşo£
(
‹mp
);

6465 
	`mg_´štf
(
nc
,

6471 "CÚ‹Á-L’gth: %" 
SIZE_T_FMT


6474 
cu¼’t_time
, 
Ï¡_modif›d
, (è
mime_ty³
.
Ën
, mime_ty³.
p
,

6475 (
pd
->
fe
.
k“·live
 ? "k“p-®ive" : "şo£"), (
size_t
è
ş
, 
¿nge
,

6476 
‘ag
);

6478 
pd
->
fe
.
ş
 = cl;

6479 
pd
->
fe
.
ty³
 = 
DATA_FILE
;

6480 if(
	`is_´iv©e_fe
(
·th
))

6481 
	`mg_h‰p_Œªsãr_fe_d©a_´iv©e
(
nc
);

6483 
	`mg_h‰p_Œªsãr_fe_d©a
(
nc
);

6485 
	}
}

6487 
	$mg_h‰p_£rve_fe2
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

6488 
h‰p_mes§ge
 *
hm
,

6489 
mg_£rve_h‰p_İts
 *
İts
) {

6490 #ià
MG_ENABLE_HTTP_SSI


6491 ià(
	`mg_m©ch_´efix
(
İts
->
ssi_·‰”n
, 
	`¡¾’
(İts->ssi_·‰”n), 
·th
) > 0) {

6492 
	`mg_hªdË_ssi_»que¡
(
nc
, 
hm
, 
·th
, 
İts
);

6496 
	`mg_h‰p_£rve_fe
(
nc
, 
hm
, 
·th
, 
	`mg_g‘_mime_ty³
Õ©h, "‹xt/¶aš", 
İts
),

6497 
	`mg_mk_¡r
(
İts
->
exŒa_h—d”s
));

6498 
	}
}

6502 
	$mg_u¾_decode
(cÚ¡ *
¤c
, 
¤c_Ën
, *
d¡
, 
d¡_Ën
,

6503 
is_fÜm_u¾_’coded
) {

6504 
i
, 
j
, 
a
, 
b
;

6505 
	#HEXTOI
(
x
è(
	`isdig™
(xè? x - '0' : x - 'W')

	)

6507 
i
 = 
j
 = 0; i < 
¤c_Ën
 && j < 
d¡_Ën
 - 1; i++, j++) {

6508 ià(
¤c
[
i
] == '%') {

6509 ià(
i
 < 
¤c_Ën
 - 2 && 
	`isxdig™
(*(cÚ¡ *è(
¤c
 + i + 1)) &&

6510 
	`isxdig™
(*(cÚ¡ *è(
¤c
 + 
i
 + 2))) {

6511 
a
 = 
	`tŞow”
(*(cÚ¡ *è(
¤c
 + 
i
 + 1));

6512 
b
 = 
	`tŞow”
(*(cÚ¡ *è(
¤c
 + 
i
 + 2));

6513 
d¡
[
j
] = (è((
	`HEXTOI
(
a
è<< 4è| HEXTOI(
b
));

6514 
i
 += 2;

6518 } ià(
is_fÜm_u¾_’coded
 && 
¤c
[
i
] == '+') {

6519 
d¡
[
j
] = ' ';

6521 
d¡
[
j
] = 
¤c
[
i
];

6525 
d¡
[
j
] = '\0';

6527  
i
 >ğ
¤c_Ën
 ? 
j
 : -1;

6528 
	}
}

6530 
	$mg_g‘_h‰p_v¬
(cÚ¡ 
mg_¡r
 *
buf
, cÚ¡ *
Çme
, *
d¡
,

6531 
size_t
 
d¡_Ën
) {

6532 cÚ¡ *
p
, *
e
, *
s
;

6533 
size_t
 
Çme_Ën
;

6534 
Ën
;

6536 ià(
d¡
 =ğ
NULL
 || 
d¡_Ën
 == 0) {

6537 
Ën
 = -2;

6538 } ià(
buf
->
p
 =ğ
NULL
 || 
Çme
 =ğNULL || buf->
Ën
 == 0) {

6539 
Ën
 = -1;

6540 
d¡
[0] = '\0';

6542 
Çme_Ën
 = 
	`¡¾’
(
Çme
);

6543 
e
 = 
buf
->
p
 + buf->
Ën
;

6544 
Ën
 = -1;

6545 
d¡
[0] = '\0';

6547 
p
 = 
buf
->p;… + 
Çme_Ën
 < 
e
;…++) {

6548 ià((
p
 =ğ
buf
->°||…[-1] =ğ'&'è&&…[
Çme_Ën
] == '=' &&

6549 !
	`mg_nÿ£cmp
(
Çme
, 
p
, 
Çme_Ën
)) {

6550 
p
 +ğ
Çme_Ën
 + 1;

6551 
s
 = (cÚ¡ *è
	`memchr
(
p
, '&', (
size_t
)(
e
 -…));

6552 ià(
s
 =ğ
NULL
) {

6553 
s
 = 
e
;

6555 
Ën
 = 
	`mg_u¾_decode
(
p
, (
size_t
)(
s
 -…), 
d¡
, 
d¡_Ën
, 1);

6556 ià(
Ën
 == -1) {

6557 
Ën
 = -2;

6564  
Ën
;

6565 
	}
}

6567 
	$mg_£nd_h‰p_chunk
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

6568 
chunk_size
[50];

6569 
n
;

6571 
n
 = 
	`¢´štf
(
chunk_size
, (chunk_size), "%lX\r\n", (è
Ën
);

6572 
	`mg_£nd
(
nc
, 
chunk_size
, 
n
);

6573 
	`mg_£nd
(
nc
, 
buf
, 
Ën
);

6574 
	`mg_£nd
(
nc
, "\r\n", 2);

6575 
	}
}

6577 
	$mg_´štf_h‰p_chunk
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
fmt
, ...) {

6578 
mem
[
MG_VPRINTF_BUFFER_SIZE
], *
buf
 = mem;

6579 
Ën
;

6580 
va_li¡
 
­
;

6582 
	`va_¡¬t
(
­
, 
fmt
);

6583 
Ën
 = 
	`mg_av´štf
(&
buf
, (
mem
), 
fmt
, 
­
);

6584 
	`va_’d
(
­
);

6586 ià(
Ën
 >= 0) {

6587 
	`mg_£nd_h‰p_chunk
(
nc
, 
buf
, 
Ën
);

6591 ià(
buf
 !ğ
mem
 && buà!ğ
NULL
) {

6592 
	`MG_FREE
(
buf
);

6595 
	}
}

6597 
	$mg_´štf_html_esÿ³
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
fmt
, ...) {

6598 
mem
[
MG_VPRINTF_BUFFER_SIZE
], *
buf
 = mem;

6599 
i
, 
j
, 
Ën
;

6600 
va_li¡
 
­
;

6602 
	`va_¡¬t
(
­
, 
fmt
);

6603 
Ën
 = 
	`mg_av´štf
(&
buf
, (
mem
), 
fmt
, 
­
);

6604 
	`va_’d
(
­
);

6606 ià(
Ën
 >= 0) {

6607 
i
 = 
j
 = 0; i < 
Ën
; i++) {

6608 ià(
buf
[
i
] == '<' || buf[i] == '>') {

6609 
	`mg_£nd
(
nc
, 
buf
 + 
j
, 
i
 - j);

6610 
	`mg_£nd
(
nc
, 
buf
[
i
] == '<' ? "&lt;" : "&gt;", 4);

6611 
j
 = 
i
 + 1;

6614 
	`mg_£nd
(
nc
, 
buf
 + 
j
, 
i
 - j);

6618 ià(
buf
 !ğ
mem
 && buà!ğ
NULL
) {

6619 
	`MG_FREE
(
buf
);

6622 
	}
}

6624 
	$mg_h‰p_·r£_h—d”
(
mg_¡r
 *
hdr
, cÚ¡ *
v¬_Çme
, *
buf
,

6625 
size_t
 
buf_size
) {

6626 
ch
 = ' ', 
ch1
 = ',', 
Ën
 = 0, 
n
 = 
	`¡¾’
(
v¬_Çme
);

6627 cÚ¡ *
p
, *
’d
 = 
hdr
 ? hdr->°+ hdr->
Ën
 : 
NULL
, *
s
 = NULL;

6629 ià(
buf
 !ğ
NULL
 && 
buf_size
 > 0) buf[0] = '\0';

6630 ià(
hdr
 =ğ
NULL
)  0;

6633 
s
 = 
hdr
->
p
; s !ğ
NULL
 && s + 
n
 < 
’d
; s++) {

6634 ià((
s
 =ğ
hdr
->
p
 || s[-1] =ğ
ch
 || s[-1] =ğ
ch1
 || s[-1] == ';') &&

6635 
s
[
n
] =ğ'=' && !
	`¡ºcmp
(s, 
v¬_Çme
,‚))

6639 ià(
s
 !ğ
NULL
 && &s[
n
 + 1] < 
’d
) {

6640 
s
 +ğ
n
 + 1;

6641 ià(*
s
 == '"' || *s == '\'') {

6642 
ch
 = 
ch1
 = *
s
++;

6644 
p
 = 
s
;

6645 
p
 < 
’d
 &&…[0] !ğ
ch
 &&…[0] !ğ
ch1
 && 
Ën
 < (è
buf_size
) {

6646 ià(
ch
 !ğ' ' && 
p
[0] == '\\' &&…[1] == ch)…++;

6647 
buf
[
Ën
++] = *
p
++;

6649 ià(
Ën
 >ğ(è
buf_size
 || (
ch
 !ğ' ' && *
p
 != ch)) {

6650 
Ën
 = 0;

6652 ià(
Ën
 > 0 && 
s
[len - 1] == ',')†en--;

6653 ià(
Ën
 > 0 && 
s
[len - 1] == ';')†en--;

6654 
buf
[
Ën
] = '\0';

6658  
Ën
;

6659 
	}
}

6661 
	$mg_g‘_h‰p_basic_auth
(
h‰p_mes§ge
 *
hm
, *
u£r
, 
size_t
 
u£r_Ën
,

6662 *
·ss
, 
size_t
 
·ss_Ën
) {

6663 
mg_¡r
 *
hdr
 = 
	`mg_g‘_h‰p_h—d”
(
hm
, "Authorization");

6664 ià(
hdr
 =ğ
NULL
)  -1;

6665  
	`mg_·r£_h‰p_basic_auth
(
hdr
, 
u£r
, 
u£r_Ën
, 
·ss
, 
·ss_Ën
);

6666 
	}
}

6668 
	$mg_·r£_h‰p_basic_auth
(
mg_¡r
 *
hdr
, *
u£r
, 
size_t
 
u£r_Ën
,

6669 *
·ss
, 
size_t
 
·ss_Ën
) {

6670 *
buf
 = 
NULL
;

6671 
fmt
[64];

6672 
»s
 = 0;

6674 ià(
	`mg_¡ºcmp
(*
hdr
, 
	`mg_mk_¡r
("Basic "), 6) != 0)  -1;

6676 
buf
 = (*è
	`MG_MALLOC
(
hdr
->
Ën
);

6677 
	`cs_ba£64_decode
((*è
hdr
->
p
 + 6, hdr->
Ën
, 
buf
, 
NULL
);

6680 
	`¢´štf
(
fmt
, (fmt), "%%%" 
SIZE_T_FMT
 "[^:]:%%%" SIZE_T_FMT "[^\n]",

6681 
u£r_Ën
 - 1, 
·ss_Ën
 - 1);

6682 ià(
	`ssÿnf
(
buf
, 
fmt
, 
u£r
, 
·ss
) == 0) {

6683 
»s
 = -1;

6686 
	`MG_FREE
(
buf
);

6687  
»s
;

6688 
	}
}

6690 #ià
MG_ENABLE_FILESYSTEM


6691 
	$mg_is_fe_hidd’
(cÚ¡ *
·th
,

6692 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
,

6693 
exşude_¥ecŸls
) {

6694 cÚ¡ *
p1
 = 
İts
->
³r_dœeùÜy_auth_fe
;

6695 cÚ¡ *
p2
 = 
İts
->
hidd’_fe_·‰”n
;

6698 cÚ¡ *
pdœ
 = 
	`¡¼chr
(
·th
, 
DIRSEP
);

6699 ià(
pdœ
 !ğ
NULL
) {

6700 
·th
 = 
pdœ
 + 1;

6703  (
exşude_¥ecŸls
 && (!
	`¡rcmp
(
·th
, ".") || !strcmp(path, ".."))) ||

6704 (
p1
 !ğ
NULL
 &&

6705 
	`mg_m©ch_´efix
(
p1
, 
	`¡¾’
Õ1), 
·th
) == () strlen(p1)) ||

6706 (
p2
 !ğ
NULL
 && 
	`mg_m©ch_´efix
Õ2, 
	`¡¾’
Õ2), 
·th
) > 0);

6707 
	}
}

6709 #ià!
MG_DISABLE_HTTP_DIGEST_AUTH


6710 
	$mg_mkmd5»¥
(cÚ¡ *
m‘hod
, 
size_t
 
m‘hod_Ën
, cÚ¡ *
uri
,

6711 
size_t
 
uri_Ën
, cÚ¡ *
ha1
, size_ˆ
ha1_Ën
,

6712 cÚ¡ *
nÚû
, 
size_t
 
nÚû_Ën
, cÚ¡ *
nc
,

6713 
size_t
 
nc_Ën
, cÚ¡ *
úÚû
, size_ˆ
úÚû_Ën
,

6714 cÚ¡ *
qİ
, 
size_t
 
qİ_Ën
, *
»¥
) {

6715 cÚ¡ 
cŞÚ
[] = ":";

6716 cÚ¡ 
size_t
 
Úe
 = 1;

6717 
ha2
[33];

6719 
	`cs_md5
(
ha2
, 
m‘hod
, 
m‘hod_Ën
, 
cŞÚ
, 
Úe
, 
uri
, 
uri_Ën
, 
NULL
);

6720 
	`cs_md5
(
»¥
, 
ha1
, 
ha1_Ën
, 
cŞÚ
, 
Úe
, 
nÚû
, 
nÚû_Ën
, cŞÚ, oÃ, 
nc
,

6721 
nc_Ën
, 
cŞÚ
, 
Úe
, 
úÚû
, 
úÚû_Ën
, cŞÚ, oÃ, 
qİ
, 
qİ_Ën
,

6722 
cŞÚ
, 
Úe
, 
ha2
, (ha2è- 1, 
NULL
);

6723 
	}
}

6725 
	$mg_h‰p_ü—‹_dige¡_auth_h—d”
(*
buf
, 
size_t
 
buf_Ën
,

6726 cÚ¡ *
m‘hod
, cÚ¡ *
uri
,

6727 cÚ¡ *
auth_domaš
, cÚ¡ *
u£r
,

6728 cÚ¡ *
·sswd
) {

6729 cÚ¡ 
cŞÚ
[] = ":", 
qİ
[] = "auth";

6730 cÚ¡ 
size_t
 
Úe
 = 1;

6731 
ha1
[33], 
»¥
[33], 
úÚû
[40];

6733 
	`¢´štf
(
úÚû
, (úÚû), "%x", (è
	`mg_time
());

6734 
	`cs_md5
(
ha1
, 
u£r
, (
size_t
è
	`¡¾’
(u£r), 
cŞÚ
, 
Úe
, 
auth_domaš
,

6735 (
size_t
è
	`¡¾’
(
auth_domaš
), 
cŞÚ
, 
Úe
, 
·sswd
,

6736 (
size_t
è
	`¡¾’
(
·sswd
), 
NULL
);

6737 
	`mg_mkmd5»¥
(
m‘hod
, 
	`¡¾’
(m‘hod), 
uri
, sŒËn(uri), 
ha1
, (ha1) - 1,

6738 
úÚû
, 
	`¡¾’
(úÚû), "1", 
Úe
, cnÚû, sŒËn(úÚû), 
qİ
,

6739 (
qİ
è- 1, 
»¥
);

6740  
	`¢´štf
(
buf
, 
buf_Ën
,

6744 
u£r
, 
auth_domaš
, 
uri
, 
qİ
, 
úÚû
, cnÚû, 
»¥
);

6745 
	}
}

6753 
	$mg_check_nÚû
(cÚ¡ *
nÚû
) {

6754 
now
 = (è
	`mg_time
();

6755 
v®
 = (è
	`¡¹oul
(
nÚû
, 
NULL
, 16);

6756  
now
 < 
v®
 ||‚ow - val < 3600;

6757 
	}
}

6759 
	$mg_h‰p_check_dige¡_auth
(
h‰p_mes§ge
 *
hm
, cÚ¡ *
auth_domaš
,

6760 
FILE
 *
å
) {

6761 
mg_¡r
 *
hdr
;

6762 
buf
[128], 
f_u£r
[(buf)], 
f_ha1
[(buf)], 
f_domaš
[(buf)];

6763 
u£r
[50], 
úÚû
[33], 
»¥Ú£
[40], 
uri
[200], 
qİ
[20], 
nc
[20], 
nÚû
[30];

6764 
ex³ùed_»¥Ú£
[33];

6767 ià(
hm
 =ğ
NULL
 || 
å
 == NULL ||

6768 (
hdr
 = 
	`mg_g‘_h‰p_h—d”
(
hm
, "AuthÜiz©iÚ")è=ğ
NULL
 ||

6769 
	`mg_h‰p_·r£_h—d”
(
hdr
, "u£ºame", 
u£r
, (user)) == 0 ||

6770 
	`mg_h‰p_·r£_h—d”
(
hdr
, "úÚû", 
úÚû
, (cnonce)) == 0 ||

6771 
	`mg_h‰p_·r£_h—d”
(
hdr
, "»¥Ú£", 
»¥Ú£
, (response)) == 0 ||

6772 
	`mg_h‰p_·r£_h—d”
(
hdr
, "uri", 
uri
, (uri)) == 0 ||

6773 
	`mg_h‰p_·r£_h—d”
(
hdr
, "qİ", 
qİ
, (qop)) == 0 ||

6774 
	`mg_h‰p_·r£_h—d”
(
hdr
, "nc", 
nc
, (nc)) == 0 ||

6775 
	`mg_h‰p_·r£_h—d”
(
hdr
, "nÚû", 
nÚû
, (nonce)) == 0 ||

6776 
	`mg_check_nÚû
(
nÚû
) == 0) {

6785 
	`fg‘s
(
buf
, (buf), 
å
è!ğ
NULL
) {

6786 ià(
	`ssÿnf
(
buf
, "%[^:]:%[^:]:%s", 
f_u£r
, 
f_domaš
, 
f_ha1
) == 3 &&

6787 
	`¡rcmp
(
u£r
, 
f_u£r
) == 0 &&

6789 
	`¡rcmp
(
auth_domaš
, 
f_domaš
) == 0) {

6791 
	`mg_mkmd5»¥
(

6792 
hm
->
m‘hod
.
p
, hm->m‘hod.
Ën
, hm->
uri
.p,

6793 
hm
->
uri
.
Ën
 + (hm->
qu”y_¡ršg
.len ? hm->query_string.len + 1 : 0),

6794 
f_ha1
, 
	`¡¾’
(f_ha1), 
nÚû
, sŒËnÒÚû), 
nc
, sŒËnÒc), 
úÚû
,

6795 
	`¡¾’
(
úÚû
), 
qİ
, sŒËn(qİ), 
ex³ùed_»¥Ú£
);

6796  
	`mg_ÿ£cmp
(
»¥Ú£
, 
ex³ùed_»¥Ú£
) == 0;

6802 
	}
}

6804 
	$mg_is_authÜized
(
h‰p_mes§ge
 *
hm
, cÚ¡ *
·th
,

6805 
is_dœeùÜy
, cÚ¡ *
domaš
,

6806 cÚ¡ *
·sswÜds_fe
,

6807 
is_glob®_·ss_fe
) {

6808 
buf
[
MG_MAX_PATH
];

6809 cÚ¡ *
p
;

6810 
FILE
 *
å
;

6811 
authÜized
 = 1;

6813 ià(
domaš
 !ğ
NULL
 && 
·sswÜds_fe
 != NULL) {

6814 ià(
is_glob®_·ss_fe
) {

6815 
å
 = 
	`mg_fİ’
(
·sswÜds_fe
, "r");

6816 } ià(
is_dœeùÜy
) {

6817 
	`¢´štf
(
buf
, (buf), "%s%c%s", 
·th
, 
DIRSEP
, 
·sswÜds_fe
);

6818 
å
 = 
	`mg_fİ’
(
buf
, "r");

6820 
p
 = 
	`¡¼chr
(
·th
, 
DIRSEP
);

6821 ià(
p
 =ğ
NULL
è°ğ
·th
;

6822 
	`¢´štf
(
buf
, (buf), "%.*s%c%s", (è(
p
 - 
·th
),…©h, 
DIRSEP
,

6823 
·sswÜds_fe
);

6824 
å
 = 
	`mg_fİ’
(
buf
, "r");

6827 ià(
å
 !ğ
NULL
) {

6828 
authÜized
 = 
	`mg_h‰p_check_dige¡_auth
(
hm
, 
domaš
, 
å
);

6829 
	`fşo£
(
å
);

6833 
	`LOG
(
LL_DEBUG
, ("% '%s' %d %d", 
·th
, 
·sswÜds_fe
 ?…asswords_file : "",

6834 
is_glob®_·ss_fe
, 
authÜized
));

6835  
authÜized
;

6836 
	}
}

6838 
	$mg_is_authÜized
(
h‰p_mes§ge
 *
hm
, cÚ¡ *
·th
,

6839 
is_dœeùÜy
, cÚ¡ *
domaš
,

6840 cÚ¡ *
·sswÜds_fe
,

6841 
is_glob®_·ss_fe
) {

6842 (è
hm
;

6843 (è
·th
;

6844 (è
is_dœeùÜy
;

6845 (è
domaš
;

6846 (è
·sswÜds_fe
;

6847 (è
is_glob®_·ss_fe
;

6849 
	}
}

6852 #ià
MG_ENABLE_DIRECTORY_LISTING


6853 
size_t
 
	$mg_u¾_’code
(cÚ¡ *
¤c
, 
size_t
 
s_Ën
, *
d¡
,

6854 
size_t
 
d¡_Ën
) {

6855 cÚ¡ *
dÚt_esÿ³
 = "._-$,;~()/";

6856 cÚ¡ *
hex
 = "0123456789abcdef";

6857 
size_t
 
i
 = 0, 
j
 = 0;

6859 
i
 = 
j
 = 0; 
d¡_Ën
 > 0 && i < 
s_Ën
 && j + 2 < dst_len - 1; i++, j++) {

6860 ià(
	`i§Êum
(*(cÚ¡ *è(
¤c
 + 
i
)) ||

6861 
	`¡rchr
(
dÚt_esÿ³
, *(cÚ¡ *è(
¤c
 + 
i
)è!ğ
NULL
) {

6862 
d¡
[
j
] = 
¤c
[
i
];

6863 } ià(
j
 + 3 < 
d¡_Ën
) {

6864 
d¡
[
j
] = '%';

6865 
d¡
[
j
 + 1] = 
hex
[(*(cÚ¡ *è(
¤c
 + 
i
)) >> 4];

6866 
d¡
[
j
 + 2] = 
hex
[(*(cÚ¡ *è(
¤c
 + 
i
)) & 0xf];

6867 
j
 += 2;

6871 
d¡
[
j
] = '\0';

6872  
j
;

6873 
	}
}

6875 
	$mg_esÿ³
(cÚ¡ *
¤c
, *
d¡
, 
size_t
 
d¡_Ën
) {

6876 
size_t
 
n
 = 0;

6877 *
¤c
 !ğ'\0' && 
n
 + 5 < 
d¡_Ën
) {

6878 
ch
 = *(*è
¤c
++;

6879 ià(
ch
 == '<') {

6880 
n
 +ğ
	`¢´štf
(
d¡
 +‚, 
d¡_Ën
 -‚, "%s", "&lt;");

6882 
d¡
[
n
++] = 
ch
;

6885 
d¡
[
n
] = '\0';

6886 
	}
}

6888 
	$mg_´št_dœ_’Œy
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
fe_Çme
,

6889 
cs_¡©_t
 *
¡p
) {

6890 
size
[64], 
mod
[64], 
h»f
[
MAX_PATH_SIZE
 * 3], 
·th
[MAX_PATH_SIZE];

6891 
št64_t
 
fsize
 = 
¡p
->
¡_size
;

6892 
is_dœ
 = 
	`S_ISDIR
(
¡p
->
¡_mode
);

6893 cÚ¡ *
¦ash
 = 
is_dœ
 ? "/" : "";

6895 ià(
is_dœ
) {

6896 
	`¢´štf
(
size
, (size), "%s", "[DIRECTORY]");

6902 ià(
fsize
 < 1024) {

6903 
	`¢´štf
(
size
, (size), "%d", (è
fsize
);

6904 } ià(
fsize
 < 0x100000) {

6905 
	`¢´štf
(
size
, (size), "%.1fk", (è
fsize
 / 1024.0);

6906 } ià(
fsize
 < 0x40000000) {

6907 
	`¢´štf
(
size
, (size), "%.1fM", (è
fsize
 / 1048576);

6909 
	`¢´štf
(
size
, (size), "%.1fG", (è
fsize
 / 1073741824);

6912 
	`¡ráime
(
mod
, (mod), "%d-%b-%Y %H:%M", 
	`loÿÉime
(&
¡p
->
¡_mtime
));

6913 
	`mg_esÿ³
(
fe_Çme
, 
·th
, (path));

6914 
	`mg_u¾_’code
(
fe_Çme
, 
	`¡¾’
(fe_Çme), 
h»f
, (href));

6915 
	`mg_´štf_h‰p_chunk
(
nc
,

6917 "<td>%s</td><td‚ame=%" 
INT64_FMT
 ">%s</td></tr>\n",

6918 
h»f
, 
¦ash
, 
·th
, sÏsh, 
mod
, 
is_dœ
 ? -1 : 
fsize
,

6919 
size
);

6920 
	}
}

6922 
mg_sÿn_dœeùÜy
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
dœ
,

6923 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
,

6924 (*
func
)(
mg_cÚÃùiÚ
 *, const *,

6925 
cs_¡©_t
 *)) {

6926 
·th
[
MAX_PATH_SIZE
];

6927 
cs_¡©_t
 
¡
;

6928 
dœ’t
 *
dp
;

6929 
DIR
 *
dœp
;

6931 
	`LOG
(
LL_DEBUG
, ("%°[%s]", 
nc
, 
dœ
));

6932 ià((
dœp
 = (
	`İ’dœ
(
dœ
))è!ğ
NULL
) {

6933 (
dp
 = 
	`»addœ
(
dœp
)è!ğ
NULL
) {

6935 ià(
	`mg_is_fe_hidd’
((cÚ¡ *è
dp
->
d_Çme
, 
İts
, 1)) {

6938 
	`¢´štf
(
·th
, Õ©h), "%s/%s", 
dœ
, 
dp
->
d_Çme
);

6939 ià(
	`mg_¡©
(
·th
, &
¡
) == 0) {

6940 
	`func
(
nc
, (cÚ¡ *è
dp
->
d_Çme
, &
¡
);

6943 
	`şo£dœ
(
dœp
);

6945 
	`LOG
(
LL_DEBUG
, ("%°İ’dœ(%sè-> %d", 
nc
, 
dœ
, 
	`mg_g‘_”ºo
()));

6947 
	}
}

6949 
	$mg_£nd_dœeùÜy_li¡šg
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
dœ
,

6950 
h‰p_mes§ge
 *
hm
,

6951 
mg_£rve_h‰p_İts
 *
İts
) {

6952 cÚ¡ *
sÜt_js_code
 =

6962 cÚ¡ *
sÜt_js_code2
 =

6976 
	`mg_£nd_»¥Ú£_lše
(
nc
, 200, 
İts
->
exŒa_h—d”s
);

6977 
	`mg_´štf
(
nc
, "%s: %s\r\n%s: %s\r\n\r\n", "Transfer-Encoding", "chunked",

6980 
	`mg_´štf_h‰p_chunk
(

6981 
nc
,

6992 (è
hm
->
uri
.
Ën
, hm->uri.
p
, 
sÜt_js_code
, 
sÜt_js_code2
,

6993 (è
hm
->
uri
.
Ën
, hm->uri.
p
);

6994 
	`mg_sÿn_dœeùÜy
(
nc
, 
dœ
, 
İts
, 
mg_´št_dœ_’Œy
);

6995 
	`mg_´štf_h‰p_chunk
(
nc
,

7000 
mg_v”siÚ_h—d”
);

7001 
	`mg_£nd_h‰p_chunk
(
nc
, "", 0);

7003 
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

7004 
	}
}

7014 
MG_INTERNAL
 
	$mg_fšd_šdex_fe
(cÚ¡ *
·th
, cÚ¡ *
li¡
,

7015 **
šdex_fe
, 
cs_¡©_t
 *
¡p
) {

7016 
mg_¡r
 
vec
;

7017 
size_t
 
·th_Ën
 = 
	`¡¾’
(
·th
);

7018 
found
 = 0;

7019 *
šdex_fe
 = 
NULL
;

7023 (
li¡
 = 
	`mg_Ãxt_comma_li¡_’Œy
Öi¡, &
vec
, 
NULL
)) != NULL) {

7024 
cs_¡©_t
 
¡
;

7025 
size_t
 
Ën
 = 
·th_Ën
 + 1 + 
vec
.len + 1;

7026 *
šdex_fe
 = (*è
	`MG_REALLOC
(*šdex_fe, 
Ën
);

7027 ià(*
šdex_fe
 =ğ
NULL
) ;

7028 
	`¢´štf
(*
šdex_fe
, 
Ën
, "%s%c%.*s", 
·th
, 
DIRSEP
, (è
vec
.Ën, vec.
p
);

7031 ià(
	`mg_¡©
(*
šdex_fe
, &
¡
è=ğ0 && 
	`S_ISREG
(¡.
¡_mode
)) {

7033 *
¡p
 = 
¡
;

7034 
found
 = 1;

7038 ià(!
found
) {

7039 
	`MG_FREE
(*
šdex_fe
);

7040 *
šdex_fe
 = 
NULL
;

7042 
	`LOG
(
LL_DEBUG
, ("[%s] [%s]", 
·th
, (*
šdex_fe
 ? *index_file : "")));

7043 
	}
}

7045 #ià
MG_ENABLE_HTTP_URL_REWRITES


7046 
	$mg_h‰p_£nd_pÜt_ba£d_»dœeù
(

7047 
mg_cÚÃùiÚ
 *
c
, 
h‰p_mes§ge
 *
hm
,

7048 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
) {

7049 cÚ¡ *
»wr™es
 = 
İts
->
u¾_»wr™es
;

7050 
mg_¡r
 
a
, 
b
;

7051 
loÿl_pÜt
[20] = {'%'};

7053 
	`mg_cÚn_addr_to_¡r
(
c
, 
loÿl_pÜt
 + 1, (local_port) - 1,

7054 
MG_SOCK_STRINGIFY_PORT
);

7056 (
»wr™es
 = 
	`mg_Ãxt_comma_li¡_’Œy
Ôewr™es, &
a
, &
b
)è!ğ
NULL
) {

7057 ià(
	`mg_vcmp
(&
a
, 
loÿl_pÜt
) == 0) {

7058 
	`mg_£nd_»¥Ú£_lše
(
c
, 301, 
NULL
);

7059 
	`mg_´štf
(
c
, "Content-Length: 0\r\nLocation: %.*s%.*s\r\n\r\n",

7060 (è
b
.
Ën
, b.
p
, (è(
hm
->
´Ùo
.°- hm->
uri
.p - 1),

7061 
hm
->
uri
.
p
);

7067 
	}
}

7069 
	$mg_»v”£_´oxy_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
,

7070 *
ev_d©a
) {

7071 
h‰p_mes§ge
 *
hm
 = (h‰p_mes§g*è
ev_d©a
;

7072 
mg_h‰p_´Ùo_d©a
 *
pd
 = 
	`mg_h‰p_g‘_´Ùo_d©a
(
nc
);

7074 ià(
pd
 =ğ
NULL
 ||…d->
»v”£_´oxy_d©a
.
lšked_cÚn
 == NULL) {

7075 
	`DBG
(("%p: up¡»am clo£d", 
nc
));

7079 
ev
) {

7080 
MG_EV_CONNECT
:

7081 ià(*(*è
ev_d©a
 != 0) {

7082 
	`mg_h‰p_£nd_”rÜ
(
pd
->
»v”£_´oxy_d©a
.
lšked_cÚn
, 502, 
NULL
);

7086 
MG_EV_HTTP_REPLY
:

7087 
	`mg_£nd
(
pd
->
»v”£_´oxy_d©a
.
lšked_cÚn
, 
hm
->
mes§ge
.
p
,

7088 
hm
->
mes§ge
.
Ën
);

7089 
pd
->
»v”£_´oxy_d©a
.
lšked_cÚn
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

7090 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

7092 
MG_EV_CLOSE
:

7093 
pd
->
»v”£_´oxy_d©a
.
lšked_cÚn
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

7096 
	}
}

7098 
	$mg_h‰p_»v”£_´oxy
(
mg_cÚÃùiÚ
 *
nc
,

7099 cÚ¡ 
h‰p_mes§ge
 *
hm
, 
mg_¡r
 
mouÁ
,

7100 
mg_¡r
 
up¡»am
) {

7101 
mg_cÚÃùiÚ
 *
be
;

7102 
bu¾
[256], *
pu¾
 = burl;

7103 *
addr
 = 
NULL
;

7104 cÚ¡ *
·th
 = 
NULL
;

7105 
i
;

7106 cÚ¡ *
”rÜ
;

7107 
mg_cÚÃù_İts
 
İts
;

7108 
	`mem£t
(&
İts
, 0, (opts));

7109 
İts
.
”rÜ_¡ršg
 = &
”rÜ
;

7111 
	`mg_a¥rštf
(&
pu¾
, (
bu¾
), "%.*s%.*s", (è
up¡»am
.
Ën
, up¡»am.
p
,

7112 (è(
hm
->
uri
.
Ën
 - 
mouÁ
.Ën), hm->uri.
p
 + mount.len);

7114 
be
 = 
	`mg_cÚÃù_h‰p_ba£
(
nc
->
mgr
, 
mg_»v”£_´oxy_hªdËr
, 
İts
, "http://",

7115 "h‰ps://", 
pu¾
, &
·th
, 
NULL
 ,

7116 
NULL
 , &
addr
);

7117 
	`LOG
(
LL_DEBUG
, ("Proxyšg %.* tØ% ÔuË: %.*s)", (è
hm
->
uri
.
Ën
,

7118 
hm
->
uri
.
p
, 
pu¾
, (è
mouÁ
.
Ën
, mount.p));

7120 ià(
be
 =ğ
NULL
) {

7121 
	`LOG
(
LL_ERROR
, ("E¼Ü cÚÃùšgØ%s: %s", 
pu¾
, 
”rÜ
));

7122 
	`mg_h‰p_£nd_”rÜ
(
nc
, 502, 
NULL
);

7123 
ş—nup
;

7127 
	`mg_h‰p_g‘_´Ùo_d©a
(
be
)->
»v”£_´oxy_d©a
.
lšked_cÚn
 = 
nc
;

7128 
	`mg_h‰p_g‘_´Ùo_d©a
(
nc
)->
»v”£_´oxy_d©a
.
lšked_cÚn
 = 
be
;

7131 
	`mg_´štf
(
be
, "%.* % HTTP/1.1\r\n", (è
hm
->
m‘hod
.
Ën
, hm->m‘hod.
p
,

7132 
·th
);

7134 
	`mg_´štf
(
be
, "Ho¡: %s\r\n", 
addr
);

7135 
i
 = 0; i < 
MG_MAX_HTTP_HEADERS
 && 
hm
->
h—d”_Çmes
[i].
Ën
 > 0; i++) {

7136 
mg_¡r
 
hn
 = 
hm
->
h—d”_Çmes
[
i
];

7137 
mg_¡r
 
hv
 = 
hm
->
h—d”_v®ues
[
i
];

7140 ià(
	`mg_vÿ£cmp
(&
hn
, "Host") == 0) ;

7145 ià(
	`mg_vÿ£cmp
(&
hn
, "Transfer-encoding") == 0 &&

7146 
	`mg_vÿ£cmp
(&
hv
, "chunked") == 0) {

7147 
	`mg_´štf
(
be
, "CÚ‹Á-L’gth: %" 
SIZE_T_FMT
 "\r\n", 
hm
->
body
.
Ën
);

7151 ià(
	`mg_vÿ£cmp
(&
hn
, "Expect") == 0 &&

7152 
	`mg_vÿ£cmp
(&
hv
, "100-continue") == 0) {

7156 
	`mg_´štf
(
be
, "%.*s: %.*s\r\n", (è
hn
.
Ën
, hn.
p
, (è
hv
.len, hv.p);

7159 
	`mg_£nd
(
be
, "\r\n", 2);

7160 
	`mg_£nd
(
be
, 
hm
->
body
.
p
, hm->body.
Ën
);

7162 
ş—nup
:

7163 ià(
pu¾
 !ğ
bu¾
è
	`MG_FREE
(purl);

7164 
	}
}

7166 
	$mg_h‰p_hªdË_fÜw¬dšg
(
mg_cÚÃùiÚ
 *
nc
,

7167 
h‰p_mes§ge
 *
hm
,

7168 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
) {

7169 cÚ¡ *
»wr™es
 = 
İts
->
u¾_»wr™es
;

7170 
mg_¡r
 
a
, 
b
;

7171 
mg_¡r
 
p1
 = 
	`MG_MK_STR
("h‰p://"), 
p2
 = MG_MK_STR("https://");

7173 (
»wr™es
 = 
	`mg_Ãxt_comma_li¡_’Œy
Ôewr™es, &
a
, &
b
)è!ğ
NULL
) {

7174 ià(
	`mg_¡ºcmp
(
a
, 
hm
->
uri
,‡.
Ën
) == 0) {

7175 ià(
	`mg_¡ºcmp
(
b
, 
p1
,…1.
Ën
è=ğ0 || mg_¡ºcmp(b, 
p2
,…2.len) == 0) {

7176 
	`mg_h‰p_»v”£_´oxy
(
nc
, 
hm
, 
a
, 
b
);

7183 
	}
}

7186 
MG_INTERNAL
 
	$mg_uri_to_loÿl_·th
(
h‰p_mes§ge
 *
hm
,

7187 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
,

7188 **
loÿl_·th
,

7189 
mg_¡r
 *
»mašd”
) {

7190 
ok
 = 1;

7191 cÚ¡ *
ı
 = 
hm
->
uri
.
p
, *
ı_’d
 = hm->uri.°+ hm->uri.
Ën
;

7192 
mg_¡r
 
roÙ
 = {
NULL
, 0};

7193 cÚ¡ *
fe_uri_¡¬t
 = 
ı
;

7194 *
loÿl_·th
 = 
NULL
;

7195 
»mašd”
->
p
 = 
NULL
;

7196 
»mašd”
->
Ën
 = 0;

7200 #ià
MG_ENABLE_HTTP_URL_REWRITES


7201 cÚ¡ *
»wr™es
 = 
İts
->
u¾_»wr™es
;

7203 cÚ¡ *
»wr™es
 = "";

7205 
mg_¡r
 *
hh
 = 
	`mg_g‘_h‰p_h—d”
(
hm
, "Host");

7206 
mg_¡r
 
a
, 
b
;

7208 (
»wr™es
 = 
	`mg_Ãxt_comma_li¡_’Œy
Ôewr™es, &
a
, &
b
)è!ğ
NULL
) {

7209 ià(
a
.
Ën
 > 1 &&‡.
p
[0] == '@') {

7211 ià(
hh
 !ğ
NULL
 && hh->
Ën
 =ğ
a
.len - 1 &&

7212 
	`mg_nÿ£cmp
(
a
.
p
 + 1, 
hh
->p,‡.
Ën
 - 1) == 0) {

7213 
roÙ
 = 
b
;

7218 
m©ch_Ën
 = 
	`mg_m©ch_´efix_n
(
a
, 
hm
->
uri
);

7219 ià(
m©ch_Ën
 > 0) {

7220 
fe_uri_¡¬t
 = 
hm
->
uri
.
p
 + 
m©ch_Ën
;

7221 ià(*
fe_uri_¡¬t
 =ğ'/' || fe_uri_¡¬ˆ=ğ
ı_’d
) {

7223 } ià(*(
fe_uri_¡¬t
 - 1) == '/') {

7225 
fe_uri_¡¬t
--;

7230 
roÙ
 = 
b
;

7236 ià(
roÙ
.
p
 =ğ
NULL
) {

7237 #ià
MG_ENABLE_HTTP_WEBDAV


7238 ià(
İts
->
dav_docum’t_roÙ
 !ğ
NULL
 && 
	`mg_is_dav_»que¡
(&
hm
->
m‘hod
)) {

7239 
roÙ
.
p
 = 
İts
->
dav_docum’t_roÙ
;

7240 
roÙ
.
Ën
 = 
	`¡¾’
(
İts
->
dav_docum’t_roÙ
);

7244 
roÙ
.
p
 = 
İts
->
docum’t_roÙ
;

7245 
roÙ
.
Ën
 = 
	`¡¾’
(
İts
->
docum’t_roÙ
);

7248 
	`as£¹
(
roÙ
.
p
 !ğ
NULL
 &&„oÙ.
Ën
 > 0);

7252 cÚ¡ *
u
 = 
fe_uri_¡¬t
 + 1;

7253 *
Í
 = (*è
	`MG_MALLOC
(
roÙ
.
Ën
 + 
hm
->
uri
.len + 1);

7254 *
Í_’d
 = 
Í
 + 
roÙ
.
Ën
 + 
hm
->
uri
.len + 1;

7255 *
p
 = 
Í
, *
ps
;

7256 
exi¡s
 = 1;

7257 ià(
Í
 =ğ
NULL
) {

7258 
ok
 = 0;

7259 
out
;

7261 
	`memıy
(
p
, 
roÙ
.p,„oÙ.
Ën
);

7262 
p
 +ğ
roÙ
.
Ën
;

7263 ià(*(
p
 - 1è=ğ
DIRSEP
)…--;

7264 *
p
 = '\0';

7265 
ps
 = 
p
;

7268 
u
 <ğ
ı_’d
) {

7269 cÚ¡ *
Ãxt
 = 
u
;

7270 
mg_¡r
 
compÚ’t
;

7271 ià(
exi¡s
) {

7272 
cs_¡©_t
 
¡
;

7273 
exi¡s
 = (
	`mg_¡©
(
Í
, &
¡
) == 0);

7274 ià(
exi¡s
 && 
	`S_ISREG
(
¡
.
¡_mode
)) {

7277 ià(*(
u
 - 1) == '/') u--;

7281 ià(
u
 >ğ
ı_’d
) ;

7282 
	`·r£_uri_compÚ’t
((cÚ¡ **è&
Ãxt
, 
ı_’d
, '/', &
compÚ’t
);

7283 ià(
compÚ’t
.
Ën
 > 0) {

7284 
Ën
;

7285 
	`memmove
(
p
 + 1, 
compÚ’t
.p, compÚ’t.
Ën
);

7286 
Ën
 = 
	`mg_u¾_decode
(
p
 + 1, 
compÚ’t
.Ën,… + 1, 
Í_’d
 -… - 1, 0);

7287 ià(
Ën
 <= 0) {

7288 
ok
 = 0;

7291 
compÚ’t
.
p
 =… + 1;

7292 
compÚ’t
.
Ën
 =†en;

7293 ià(
	`mg_vcmp
(&
compÚ’t
, ".") == 0) {

7295 } ià(
	`mg_vcmp
(&
compÚ’t
, "..") == 0) {

7296 
p
 > 
ps
 && *°!ğ
DIRSEP
)…--;

7297 *
p
 = '\0';

7299 
size_t
 
i
;

7300 #ifdeà
_WIN32


7302 
wch¬_t
 
buf
[
MG_MAX_PATH
 * 2];

7303 ià(
	`to_wch¬
(
compÚ’t
.
p
, 
buf
, 
MG_MAX_PATH
) == 0) {

7304 
	`DBG
(("[%.*s] sm–l fuÂy", (è
compÚ’t
.
Ën
, compÚ’t.
p
));

7305 
ok
 = 0;

7309 *
p
++ = 
DIRSEP
;

7311 
i
 = 0; i < 
compÚ’t
.
Ën
; i++, 
p
++) {

7312 ià(*
p
 =ğ'\0' || *°=ğ
DIRSEP


7313 #ifdeà
_WIN32


7316 *
p
 == '/'

7319 
ok
 = 0;

7325 
u
 = 
Ãxt
;

7327 ià(
ok
) {

7328 *
loÿl_·th
 = 
Í
;

7329 ià(
u
 > 
ı_’d
) u = cp_end;

7330 
»mašd”
->
p
 = 
u
;

7331 
»mašd”
->
Ën
 = 
ı_’d
 - 
u
;

7333 
	`MG_FREE
(
Í
);

7337 
out
:

7338 
	`LOG
(
LL_DEBUG
,

7339 ("'%.*s' -> '%s' + '%.*s'", (è
hm
->
uri
.
Ën
, hm->uri.
p
,

7340 *
loÿl_·th
 ? *loÿl_·th : "", (è
»mašd”
->
Ën
,„emašd”->
p
));

7341  
ok
;

7342 
	}
}

7344 
	$mg_g‘_mÚth_šdex
(cÚ¡ *
s
) {

7345 cÚ¡ *
mÚth_Çmes
[] = {"Jan", "Feb", "Mar", "Apr", "May", "Jun",

7347 
size_t
 
i
;

7349 
i
 = 0; i < 
	`ARRAY_SIZE
(
mÚth_Çmes
); i++)

7350 ià(!
	`¡rcmp
(
s
, 
mÚth_Çmes
[
i
]))  () i;

7353 
	}
}

7355 
	$mg_num_Ë­_y—rs
(
y—r
) {

7356  
y—r
 / 4 - year / 100 + year / 400;

7357 
	}
}

7360 
MG_INTERNAL
 
time_t
 
	$mg_·r£_d©e_¡ršg
(cÚ¡ *
d©‘ime
) {

7361 cÚ¡ 
days_befÜe_mÚth
[] = {

7363 
mÚth_¡r
[32];

7364 
£cÚd
, 
mšu‹
, 
hour
, 
day
, 
mÚth
, 
y—r
, 
Ë­_days
, 
days
;

7365 
time_t
 
»suÉ
 = (time_t) 0;

7367 ià(((
	`ssÿnf
(
d©‘ime
, "%d/%3s/%d %d:%d:%d", &
day
, 
mÚth_¡r
, &
y—r
, &
hour
,

7368 &
mšu‹
, &
£cÚd
) == 6) ||

7369 (
	`ssÿnf
(
d©‘ime
, "%d %3 %d %d:%d:%d", &
day
, 
mÚth_¡r
, &
y—r
, &
hour
,

7370 &
mšu‹
, &
£cÚd
) == 6) ||

7371 (
	`ssÿnf
(
d©‘ime
, "%*3s, %d %3 %d %d:%d:%d", &
day
, 
mÚth_¡r
, &
y—r
,

7372 &
hour
, &
mšu‹
, &
£cÚd
) == 6) ||

7373 (
	`ssÿnf
(
d©‘ime
, "%d-%3s-%d %d:%d:%d", &
day
, 
mÚth_¡r
, &
y—r
, &
hour
,

7374 &
mšu‹
, &
£cÚd
) == 6)) &&

7375 
y—r
 > 1970 && (
mÚth
 = 
	`mg_g‘_mÚth_šdex
(
mÚth_¡r
)) != -1) {

7376 
Ë­_days
 = 
	`mg_num_Ë­_y—rs
(
y—r
) - mg_num_leap_years(1970);

7377 
y—r
 -= 1970;

7378 
days
 = 
y—r
 * 365 + 
days_befÜe_mÚth
[
mÚth
] + (
day
 - 1è+ 
Ë­_days
;

7379 
»suÉ
 = 
days
 * 24 * 3600 + 
hour
 * 3600 + 
mšu‹
 * 60 + 
£cÚd
;

7382  
»suÉ
;

7383 
	}
}

7385 
MG_INTERNAL
 
	$mg_is_nÙ_modif›d
(
h‰p_mes§ge
 *
hm
, 
cs_¡©_t
 *
¡
) {

7386 
mg_¡r
 *
hdr
;

7387 ià((
hdr
 = 
	`mg_g‘_h‰p_h—d”
(
hm
, "If-NÚe-M©ch")è!ğ
NULL
) {

7388 
‘ag
[64];

7389 
	`mg_h‰p_cÚ¡ruù_‘ag
(
‘ag
, Óg), 
¡
);

7390  
	`mg_vÿ£cmp
(
hdr
, 
‘ag
) == 0;

7391 } ià((
hdr
 = 
	`mg_g‘_h‰p_h—d”
(
hm
, "If-Modif›d-Sšû")è!ğ
NULL
) {

7392  
¡
->
¡_mtime
 <ğ
	`mg_·r£_d©e_¡ršg
(
hdr
->
p
);

7396 
	}
}

7398 
	$mg_h‰p_£nd_dige¡_auth_»que¡
(
mg_cÚÃùiÚ
 *
c
,

7399 cÚ¡ *
domaš
) {

7400 
	`mg_´štf
(
c
,

7405 
domaš
, (è
	`mg_time
());

7406 
	}
}

7408 
	$mg_h‰p_£nd_İtiÚs
(
mg_cÚÃùiÚ
 *
nc
) {

7409 
	`mg_´štf
(
nc
, "%s",

7411 #ià
MG_ENABLE_HTTP_WEBDAV


7415 
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

7416 
	}
}

7418 
	$mg_is_ü—tiÚ_»que¡
(cÚ¡ 
h‰p_mes§ge
 *
hm
) {

7419  
	`mg_vcmp
(&
hm
->
m‘hod
, "MKCOL") == 0 || mg_vcmp(&hm->method, "PUT") == 0;

7420 
	}
}

7422 
MG_INTERNAL
 
	$mg_£nd_h‰p_fe
(
mg_cÚÃùiÚ
 *
nc
, *
·th
,

7423 cÚ¡ 
mg_¡r
 *
·th_šfo
,

7424 
h‰p_mes§ge
 *
hm
,

7425 
mg_£rve_h‰p_İts
 *
İts
) {

7426 
exi¡s
, 
is_dœeùÜy
, 
is_cgi
;

7427 #ià
MG_ENABLE_HTTP_WEBDAV


7428 
is_dav
 = 
	`mg_is_dav_»que¡
(&
hm
->
m‘hod
);

7430 
is_dav
 = 0;

7432 *
šdex_fe
 = 
NULL
;

7433 
cs_¡©_t
 
¡
;

7435 
exi¡s
 = (
	`mg_¡©
(
·th
, &
¡
) == 0);

7436 
is_dœeùÜy
 = 
exi¡s
 && 
	`S_ISDIR
(
¡
.
¡_mode
);

7438 ià(
is_dœeùÜy
)

7439 
	`mg_fšd_šdex_fe
(
·th
, 
İts
->
šdex_fes
, &
šdex_fe
, &
¡
);

7441 
is_cgi
 =

7442 (
	`mg_m©ch_´efix
(
İts
->
cgi_fe_·‰”n
, 
	`¡¾’
(opts->cgi_file_pattern),

7443 
šdex_fe
 ? index_f: 
·th
) > 0);

7445 
	`LOG
(
LL_DEBUG
,

7446 ("%°%.* [%s]ƒxi¡s=%d is_dœ=%d is_dav=%d is_cgi=%d index=%s", 
nc
,

7447 (è
hm
->
m‘hod
.
Ën
, hm->m‘hod.
p
, 
·th
, 
exi¡s
, 
is_dœeùÜy
, 
is_dav
,

7448 
is_cgi
, 
šdex_fe
 ? index_file : ""));

7450 ià(
is_dœeùÜy
 && 
hm
->
uri
.
p
[hm->uri.
Ën
 - 1] !ğ'/' && !
is_dav
) {

7451 
	`mg_´štf
(
nc
,

7454 (è
hm
->
uri
.
Ën
, hm->uri.
p
);

7455 
	`MG_FREE
(
šdex_fe
);

7460 ià(
·th_šfo
->
Ën
 > 0 && !
is_cgi
) {

7461 
	`mg_h‰p_£nd_”rÜ
(
nc
, 501, 
NULL
);

7462 
	`MG_FREE
(
šdex_fe
);

7466 ià(
is_dav
 && 
İts
->
dav_docum’t_roÙ
 =ğ
NULL
) {

7467 
	`mg_h‰p_£nd_”rÜ
(
nc
, 501, 
NULL
);

7468 } ià(!
	`mg_is_authÜized
(
hm
, 
·th
, 
is_dœeùÜy
, 
İts
->
auth_domaš
,

7469 
İts
->
glob®_auth_fe
, 1) ||

7470 !
	`mg_is_authÜized
(
hm
, 
·th
, 
is_dœeùÜy
, 
İts
->
auth_domaš
,

7471 
İts
->
³r_dœeùÜy_auth_fe
, 0)) {

7472 
	`mg_h‰p_£nd_dige¡_auth_»que¡
(
nc
, 
İts
->
auth_domaš
);

7473 } ià(
is_cgi
) {

7474 #ià
MG_ENABLE_HTTP_CGI


7475 
	`mg_hªdË_cgi
(
nc
, 
šdex_fe
 ? index_f: 
·th
, 
·th_šfo
, 
hm
, 
İts
);

7477 
	`mg_h‰p_£nd_”rÜ
(
nc
, 501, 
NULL
);

7479 } ià((!
exi¡s
 ||

7480 
	`mg_is_fe_hidd’
(
·th
, 
İts
, 0 )) &&

7481 !
	`mg_is_ü—tiÚ_»que¡
(
hm
)) {

7482 
	`mg_h‰p_£nd_”rÜ
(
nc
, 404, 
NULL
);

7483 #ià
MG_ENABLE_HTTP_WEBDAV


7484 } ià(!
	`mg_vcmp
(&
hm
->
m‘hod
, "PROPFIND")) {

7485 
	`mg_hªdË_´İfšd
(
nc
, 
·th
, &
¡
, 
hm
, 
İts
);

7486 #ià!
MG_DISABLE_DAV_AUTH


7487 } ià(
is_dav
 &&

7488 (
İts
->
dav_auth_fe
 =ğ
NULL
 ||

7489 (
	`¡rcmp
(
İts
->
dav_auth_fe
, "-") != 0 &&

7490 !
	`mg_is_authÜized
(
hm
, 
·th
, 
is_dœeùÜy
, 
İts
->
auth_domaš
,

7491 
İts
->
dav_auth_fe
, 1)))) {

7492 
	`mg_h‰p_£nd_dige¡_auth_»que¡
(
nc
, 
İts
->
auth_domaš
);

7494 } ià(!
	`mg_vcmp
(&
hm
->
m‘hod
, "MKCOL")) {

7495 
	`mg_hªdË_mkcŞ
(
nc
, 
·th
, 
hm
);

7496 } ià(!
	`mg_vcmp
(&
hm
->
m‘hod
, "DELETE")) {

7497 
	`mg_hªdË_d–‘e
(
nc
, 
İts
, 
·th
);

7498 } ià(!
	`mg_vcmp
(&
hm
->
m‘hod
, "PUT")) {

7499 
	`mg_hªdË_put
(
nc
, 
·th
, 
hm
);

7500 } ià(!
	`mg_vcmp
(&
hm
->
m‘hod
, "MOVE")) {

7501 
	`mg_hªdË_move
(
nc
, 
İts
, 
·th
, 
hm
);

7502 #ià
MG_ENABLE_FAKE_DAVLOCK


7503 } ià(!
	`mg_vcmp
(&
hm
->
m‘hod
, "LOCK")) {

7504 
	`mg_hªdË_lock
(
nc
, 
·th
);

7507 } ià(!
	`mg_vcmp
(&
hm
->
m‘hod
, "OPTIONS")) {

7508 
	`mg_h‰p_£nd_İtiÚs
(
nc
);

7509 } ià(
is_dœeùÜy
 && 
šdex_fe
 =ğ
NULL
) {

7510 #ià
MG_ENABLE_DIRECTORY_LISTING


7511 ià(
	`¡rcmp
(
İts
->
’abË_dœeùÜy_li¡šg
, "yes") == 0) {

7512 
	`mg_£nd_dœeùÜy_li¡šg
(
nc
, 
·th
, 
hm
, 
İts
);

7514 
	`mg_h‰p_£nd_”rÜ
(
nc
, 403, 
NULL
);

7517 
	`mg_h‰p_£nd_”rÜ
(
nc
, 501, 
NULL
);

7519 } ià(
	`mg_is_nÙ_modif›d
(
hm
, &
¡
)) {

7520 
	`mg_h‰p_£nd_”rÜ
(
nc
, 304, "Not Modified");

7522 
	`mg_h‰p_£rve_fe2
(
nc
, 
šdex_fe
 ? index_f: 
·th
, 
hm
, 
İts
);

7524 
	`MG_FREE
(
šdex_fe
);

7525 
	}
}

7527 
	$mg_£rve_h‰p
(
mg_cÚÃùiÚ
 *
nc
, 
h‰p_mes§ge
 *
hm
,

7528 
mg_£rve_h‰p_İts
 
İts
) {

7529 *
·th
 = 
NULL
;

7530 
mg_¡r
 *
hdr
, 
·th_šfo
;

7531 
ušt32_t
 
»mÙe_
 = 
	`Áohl
(*(ušt32_ˆ*è&
nc
->
§
.
sš
.
sš_addr
);

7533 ià(
	`mg_check__aş
(
İts
.
_aş
, 
»mÙe_
) != 1) {

7535 
	`mg_h‰p_£nd_”rÜ
(
nc
, 403, 
NULL
);

7536 
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

7540 #ià
MG_ENABLE_HTTP_URL_REWRITES


7541 ià(
	`mg_h‰p_hªdË_fÜw¬dšg
(
nc
, 
hm
, &
İts
)) {

7545 ià(
	`mg_h‰p_£nd_pÜt_ba£d_»dœeù
(
nc
, 
hm
, &
İts
)) {

7550 ià(
İts
.
docum’t_roÙ
 =ğ
NULL
) {

7551 
İts
.
docum’t_roÙ
 = ".";

7553 ià(
İts
.
³r_dœeùÜy_auth_fe
 =ğ
NULL
) {

7554 
İts
.
³r_dœeùÜy_auth_fe
 = ".htpasswd";

7556 ià(
İts
.
’abË_dœeùÜy_li¡šg
 =ğ
NULL
) {

7557 
İts
.
’abË_dœeùÜy_li¡šg
 = "yes";

7559 ià(
İts
.
cgi_fe_·‰”n
 =ğ
NULL
) {

7560 
İts
.
cgi_fe_·‰”n
 = "**.cgi$|**.php$";

7562 ià(
İts
.
ssi_·‰”n
 =ğ
NULL
) {

7563 
İts
.
ssi_·‰”n
 = "**.shtml$|**.shtm$";

7565 ià(
İts
.
šdex_fes
 =ğ
NULL
) {

7566 
İts
.
šdex_fes
 = "index.html,index.htm,index.shtml,index.cgi,index.php";

7569 ià(!
	`mg_nÜm®ize_uri_·th
(&
hm
->
uri
, &hm->uri)) {

7570 
	`mg_h‰p_£nd_”rÜ
(
nc
, 400, 
NULL
);

7573 ià(
	`mg_uri_to_loÿl_·th
(
hm
, &
İts
, &
·th
, &
·th_šfo
) == 0) {

7574 
	`mg_h‰p_£nd_”rÜ
(
nc
, 404, 
NULL
);

7577 
	`mg_£nd_h‰p_fe
(
nc
, 
·th
, &
·th_šfo
, 
hm
, &
İts
);

7579 
	`MG_FREE
(
·th
);

7580 
·th
 = 
NULL
;

7583 ià(
	`mg_vcmp
(&
hm
->
´Ùo
, "HTTP/1.1") != 0 ||

7584 ((
hdr
 = 
	`mg_g‘_h‰p_h—d”
(
hm
, "CÚÃùiÚ")è!ğ
NULL
 &&

7585 
	`mg_vcmp
(
hdr
, "keep-alive") != 0)) {

7587 
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

7590 
	}
}

7592 #ià
MG_ENABLE_HTTP_STREAMING_MULTIPART


7593 
	$mg_fe_u¶ßd_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
, *
ev_d©a
,

7594 
mg_fu_âame_â
 
loÿl_Çme_â
) {

7595 
ev
) {

7596 
MG_EV_HTTP_PART_BEGIN
: {

7597 
mg_h‰p_muÉ¬t_·¹
 *
mp
 =

7598 (
mg_h‰p_muÉ¬t_·¹
 *è
ev_d©a
;

7599 
fe_u¶ßd_¡©e
 *
fus
 =

7600 (
fe_u¶ßd_¡©e
 *è
	`ÿÎoc
(1, (*
fus
));

7601 
mg_¡r
 
lâ
 = 
	`loÿl_Çme_â
(
nc
, 
	`mg_mk_¡r
(
mp
->
fe_Çme
));

7602 
mp
->
u£r_d©a
 = 
NULL
;

7603 ià(
lâ
.
p
 =ğ
NULL
 ||†â.
Ën
 == 0) {

7604 
	`LOG
(
LL_ERROR
, ("%°NÙ‡ÎowedØu¶ßd %s", 
nc
, 
mp
->
fe_Çme
));

7605 
	`mg_´štf
(
nc
,

7610 
mp
->
fe_Çme
);

7611 
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

7614 
fus
->
lâ
 = (*è
	`m®loc
Öâ.
Ën
 + 1);

7615 
	`memıy
(
fus
->
lâ
,†â.
p
,†â.
Ën
);

7616 
fus
->
lâ
[lâ.
Ën
] = '\0';

7617 ià(
lâ
.
p
 !ğ
mp
->
fe_Çme
è
	`ä“
((*)†fn.p);

7618 
	`LOG
(
LL_DEBUG
,

7619 ("%°Reûivšg f% -> %s", 
nc
, 
mp
->
fe_Çme
, 
fus
->
lâ
));

7620 
fus
->
å
 = 
	`mg_fİ’
(fus->
lâ
, "w");

7621 ià(
fus
->
å
 =ğ
NULL
) {

7622 
	`mg_´štf
(
nc
,

7626 
	`LOG
(
LL_ERROR
, ("FaedØİ’ %s: %d\n", 
fus
->
lâ
, 
	`mg_g‘_”ºo
()));

7627 
	`mg_´štf
(
nc
, "FaedØİ’ %s: %d\n", 
fus
->
lâ
, 
	`mg_g‘_”ºo
());

7632 
mp
->
u£r_d©a
 = (*è
fus
;

7635 
MG_EV_HTTP_PART_DATA
: {

7636 
mg_h‰p_muÉ¬t_·¹
 *
mp
 =

7637 (
mg_h‰p_muÉ¬t_·¹
 *è
ev_d©a
;

7638 
fe_u¶ßd_¡©e
 *
fus
 =

7639 (
fe_u¶ßd_¡©e
 *è
mp
->
u£r_d©a
;

7640 ià(
fus
 =ğ
NULL
 || fus->
å
 == NULL) ;

7641 ià(
	`fwr™e
(
mp
->
d©a
.
p
, 1, mp->d©a.
Ën
, 
fus
->
å
) != mp->data.len) {

7642 
	`LOG
(
LL_ERROR
, ("FaedØwr™tØ%s: %d, wrÙ%d", 
fus
->
lâ
,

7643 
	`mg_g‘_”ºo
(), (è
fus
->
num_»cd
));

7644 ià(
	`mg_g‘_”ºo
(è=ğ
ENOSPC


7645 #ifdeà
SPIFFS_ERR_FULL


7646 || 
	`mg_g‘_”ºo
(è=ğ
SPIFFS_ERR_FULL


7649 
	`mg_´štf
(
nc
,

7653 
	`mg_´štf
(
nc
, "Failedo writeo %s:‚o space†eft; wrote %d\r\n",

7654 
fus
->
lâ
, (èfus->
num_»cd
);

7656 
	`mg_´štf
(
nc
,

7660 
	`mg_´štf
(
nc
, "FaedØwr™tØ%s: %d, wrÙ%d", 
mp
->
fe_Çme
,

7661 
	`mg_g‘_”ºo
(), (è
fus
->
num_»cd
);

7663 
	`fşo£
(
fus
->
å
);

7664 
	`»move
(
fus
->
lâ
);

7665 
fus
->
å
 = 
NULL
;

7671 
fus
->
num_»cd
 +ğ
mp
->
d©a
.
Ën
;

7672 
	`LOG
(
LL_DEBUG
, ("%°»c'd %d by‹s, %dÙ®", 
nc
, (è
mp
->
d©a
.
Ën
,

7673 (è
fus
->
num_»cd
));

7676 
MG_EV_HTTP_PART_END
: {

7677 
mg_h‰p_muÉ¬t_·¹
 *
mp
 =

7678 (
mg_h‰p_muÉ¬t_·¹
 *è
ev_d©a
;

7679 
fe_u¶ßd_¡©e
 *
fus
 =

7680 (
fe_u¶ßd_¡©e
 *è
mp
->
u£r_d©a
;

7681 ià(
fus
 =ğ
NULL
) ;

7682 ià(
mp
->
¡©us
 >ğ0 && 
fus
->
å
 !ğ
NULL
) {

7683 
	`LOG
(
LL_DEBUG
, ("%°U¶ßded % (%s), %d by‹s", 
nc
, 
mp
->
fe_Çme
,

7684 
fus
->
lâ
, (èfus->
num_»cd
));

7685 
	`mg_´štf
(
nc
,

7690 
mp
->
fe_Çme
, (è
fus
->
num_»cd
);

7692 
	`LOG
(
LL_ERROR
, ("FaedØ¡Ü% (%s)", 
mp
->
fe_Çme
, 
fus
->
lâ
));

7698 ià(
fus
->
å
 !ğ
NULL
è
	`fşo£
(fus->fp);

7699 
	`ä“
(
fus
->
lâ
);

7700 
	`ä“
(
fus
);

7701 
mp
->
u£r_d©a
 = 
NULL
;

7702 
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

7706 
	}
}

7712 
MG_INTERNAL
 
	$mg_h‰p_commÚ_u¾_·r£
(cÚ¡ *
u¾
, cÚ¡ *
schema
,

7713 cÚ¡ *
schema_s
, *
u£_s¦
,

7714 **
u£r
, **
·ss
, **
addr
,

7715 *
pÜt_i
, cÚ¡ **
·th
) {

7716 
addr_Ën
 = 0;

7717 
auth_£p_pos
 = -1;

7718 
u£r_£p_pos
 = -1;

7719 
pÜt_pos
 = -1;

7720 (è
u£r
;

7721 (è
·ss
;

7723 ià(
	`¡ºcmp
(
u¾
, 
schema
, 
	`¡¾’
(schema)) == 0) {

7724 
u¾
 +ğ
	`¡¾’
(
schema
);

7725 } ià(
	`¡ºcmp
(
u¾
, 
schema_s
, 
	`¡¾’
(schema_tls)) == 0) {

7726 
u¾
 +ğ
	`¡¾’
(
schema_s
);

7727 *
u£_s¦
 = 1;

7728 #ià!
MG_ENABLE_SSL


7733 *
u¾
 != '\0') {

7734 *
addr
 = (*è
	`MG_REALLOC
(*addr, 
addr_Ën
 + 6 );

7735 ià(*
addr
 =ğ
NULL
) {

7736 
	`DBG
(("OOM"));

7739 ià(*
u¾
 == '/') {

7742 ià(*
u¾
 == '@') {

7743 
auth_£p_pos
 = 
addr_Ën
;

7744 
u£r_£p_pos
 = 
pÜt_pos
;

7745 
pÜt_pos
 = -1;

7747 ià(*
u¾
 =ğ':'è
pÜt_pos
 = 
addr_Ën
;

7748 (*
addr
)[
addr_Ën
++] = *
u¾
;

7749 (*
addr
)[
addr_Ën
] = '\0';

7750 
u¾
++;

7753 ià(
addr_Ën
 =ğ0è
ş—nup
;

7754 ià(
pÜt_pos
 < 0) {

7755 *
pÜt_i
 = 
addr_Ën
;

7756 
addr_Ën
 +ğ
	`¥rštf
(*
addr
 +‡ddr_Ën, ":%d", *
u£_s¦
 ? 443 : 80);

7758 *
pÜt_i
 = -1;

7761 ià(*
·th
 =ğ
NULL
è*·th = 
u¾
;

7763 ià(**
·th
 == '\0') *path = "/";

7765 ià(
u£r
 !ğ
NULL
 && 
·ss
 != NULL) {

7766 ià(
auth_£p_pos
 == -1) {

7767 *
u£r
 = 
NULL
;

7768 *
·ss
 = 
NULL
;

7771 *
u£r
 = (*è
	`MG_MALLOC
(
u£r_£p_pos
 + 1);

7772 
	`memıy
(*
u£r
, *
addr
, 
u£r_£p_pos
);

7773 (*
u£r
)[
u£r_£p_pos
] = '\0';

7775 *
·ss
 = (*è
	`MG_MALLOC
(
auth_£p_pos
 - 
u£r_£p_pos
 - 1 + 1);

7776 
	`memıy
(*
·ss
, *
addr
 + 
u£r_£p_pos
 + 1, 
auth_£p_pos
 - user_sep_pos - 1);

7777 (*
·ss
)[
auth_£p_pos
 - 
u£r_£p_pos
 - 1] = '\0';

7780 
	`memmove
(*
addr
, *add¸+ 
auth_£p_pos
 + 1, 
addr_Ën
 -‡uth_sep_pos);

7784 
	`DBG
(("% %s", *
addr
, *
·th
));

7788 
ş—nup
:

7789 
	`MG_FREE
(*
addr
);

7791 
	}
}

7793 
mg_cÚÃùiÚ
 *
	$mg_cÚÃù_h‰p_ba£
(

7794 
mg_mgr
 *
mgr
, 
mg_ev’t_hªdËr_t
 
ev_hªdËr
,

7795 
mg_cÚÃù_İts
 
İts
, cÚ¡ *
schema
, cÚ¡ *
schema_s¦
,

7796 cÚ¡ *
u¾
, cÚ¡ **
·th
, **
u£r
, **
·ss
, **
addr
) {

7797 
mg_cÚÃùiÚ
 *
nc
 = 
NULL
;

7798 
pÜt_i
 = -1;

7799 
u£_s¦
 = 0;

7801 ià(
	`mg_h‰p_commÚ_u¾_·r£
(
u¾
, 
schema
, 
schema_s¦
, &
u£_s¦
, 
u£r
, 
·ss
,

7802 
addr
, &
pÜt_i
, 
·th
) < 0) {

7803 
	`MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, "cannot…arse url");

7804  
NULL
;

7807 
	`LOG
(
LL_DEBUG
, ("% u£_s¦? %d", 
u¾
, 
u£_s¦
));

7808 ià(
u£_s¦
) {

7809 #ià
MG_ENABLE_SSL


7815 ià(
İts
.
s¦_ÿ_û¹
 =ğ
NULL
) {

7816 
İts
.
s¦_ÿ_û¹
 = "*";

7819 
	`MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, "ssl is disabled");

7820 ià(
u£r
 !ğ
NULL
è
	`MG_FREE
(*user);

7821 ià(
·ss
 !ğ
NULL
è
	`MG_FREE
(*pass);

7822 
	`MG_FREE
(*
addr
);

7823  
NULL
;

7827 ià((
nc
 = 
	`mg_cÚÃù_İt
(
mgr
, *
addr
, 
ev_hªdËr
, 
İts
)è!ğ
NULL
) {

7828 
	`mg_£t_´ÙocŞ_h‰p_websock‘
(
nc
);

7830 ià(
pÜt_i
 >ğ0è(*
addr
)[port_i] = '\0';

7833  
nc
;

7834 
	}
}

7836 
mg_cÚÃùiÚ
 *
	$mg_cÚÃù_h‰p_İt
(
mg_mgr
 *
mgr
,

7837 
mg_ev’t_hªdËr_t
 
ev_hªdËr
,

7838 
mg_cÚÃù_İts
 
İts
,

7839 cÚ¡ *
u¾
,

7840 cÚ¡ *
exŒa_h—d”s
,

7841 cÚ¡ *
po¡_d©a
) {

7842 *
u£r
 = 
NULL
, *
·ss
 = NULL, *
addr
 = NULL;

7843 cÚ¡ *
·th
 = 
NULL
;

7844 
mbuf
 
auth
;

7845 
mg_cÚÃùiÚ
 *
nc
 =

7846 
	`mg_cÚÃù_h‰p_ba£
(
mgr
, 
ev_hªdËr
, 
İts
, "h‰p://", "h‰ps://", 
u¾
,

7847 &
·th
, &
u£r
, &
·ss
, &
addr
);

7849 ià(
nc
 =ğ
NULL
) {

7850  
NULL
;

7853 
	`mbuf_š™
(&
auth
, 0);

7854 ià(
u£r
 !ğ
NULL
) {

7855 
	`mg_basic_auth_h—d”
(
u£r
, 
·ss
, &
auth
);

7858 
	`mg_´štf
(
nc
, "% % HTTP/1.1\r\nHo¡: %s\r\nCÚ‹Á-L’gth: %" 
SIZE_T_FMT


7860 
po¡_d©a
 =ğ
NULL
 ? "GET" : "POST", 
·th
, 
addr
,

7861 
po¡_d©a
 =ğ
NULL
 ? 0 : 
	`¡¾’
Õo¡_d©a), (è
auth
.
Ën
,

7862 (
auth
.
buf
 =ğ
NULL
 ? "" :‡uth.buf),

7863 
exŒa_h—d”s
 =ğ
NULL
 ? "" :ƒxtra_headers,

7864 
po¡_d©a
 =ğ
NULL
 ? "" :…ost_data);

7866 
	`mbuf_ä“
(&
auth
);

7867 
	`MG_FREE
(
u£r
);

7868 
	`MG_FREE
(
·ss
);

7869 
	`MG_FREE
(
addr
);

7870  
nc
;

7871 
	}
}

7873 
mg_cÚÃùiÚ
 *
	$mg_cÚÃù_h‰p
(
mg_mgr
 *
mgr
,

7874 
mg_ev’t_hªdËr_t
 
ev_hªdËr
,

7875 cÚ¡ *
u¾
,

7876 cÚ¡ *
exŒa_h—d”s
,

7877 cÚ¡ *
po¡_d©a
) {

7878 
mg_cÚÃù_İts
 
İts
;

7879 
	`mem£t
(&
İts
, 0, (opts));

7880  
	`mg_cÚÃù_h‰p_İt
(
mgr
, 
ev_hªdËr
, 
İts
, 
u¾
, 
exŒa_h—d”s
,

7881 
po¡_d©a
);

7882 
	}
}

7884 
size_t
 
	$mg_·r£_muÉ¬t
(cÚ¡ *
buf
, 
size_t
 
buf_Ën
, *
v¬_Çme
,

7885 
size_t
 
v¬_Çme_Ën
, *
fe_Çme
,

7886 
size_t
 
fe_Çme_Ën
, cÚ¡ **
d©a
,

7887 
size_t
 *
d©a_Ën
) {

7888 cÚ¡ 
cd
[] = "Content-Disposition: ";

7889 
size_t
 
hl
, 
bl
, 
n
, 
Î
, 
pos
, 
cdl
 = (
cd
) - 1;

7891 ià(
buf
 =ğ
NULL
 || 
buf_Ën
 <= 0)  0;

7892 ià((
hl
 = 
	`mg_h‰p_g‘_»que¡_Ën
(
buf
, 
buf_Ën
)) <= 0)  0;

7893 ià(
buf
[0] != '-' || buf[1] != '-' || buf[2] == '\n')  0;

7896 
bl
 = 
	`mg_g‘_lše_Ën
(
buf
, 
buf_Ën
);

7899 
v¬_Çme
[0] = 
fe_Çme
[0] = '\0';

7900 
n
 = 
bl
; (
Î
 = 
	`mg_g‘_lše_Ën
(
buf
 +‚, 
hl
 -‚)) > 0;‚ +=†l) {

7901 ià(
	`mg_nÿ£cmp
(
cd
, 
buf
 + 
n
, 
cdl
) == 0) {

7902 
mg_¡r
 
h—d”
;

7903 
h—d”
.
p
 = 
buf
 + 
n
 + 
cdl
;

7904 
h—d”
.
Ën
 = 
Î
 - (
cdl
 + 2);

7905 
	`mg_h‰p_·r£_h—d”
(&
h—d”
, "Çme", 
v¬_Çme
, 
v¬_Çme_Ën
);

7906 
	`mg_h‰p_·r£_h—d”
(&
h—d”
, "f’ame", 
fe_Çme
, 
fe_Çme_Ën
);

7911 
pos
 = 
hl
;…o + (
bl
 - 2è< 
buf_Ën
;…os++) {

7912 ià(
buf
[
pos
] =ğ'-' && !
	`¡ºcmp
(buf, &buf[pos], 
bl
 - 2)) {

7913 ià(
d©a_Ën
 !ğ
NULL
è*d©a_ËÀğ(
pos
 - 2è- 
hl
;

7914 ià(
d©a
 !ğ
NULL
è*d©¨ğ
buf
 + 
hl
;

7915  
pos
;

7920 
	}
}

7922 
	$mg_»gi¡”_h‰p_’dpošt
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
uri_·th
,

7923 
mg_ev’t_hªdËr_t
 
hªdËr
) {

7924 
mg_h‰p_´Ùo_d©a
 *
pd
 = 
NULL
;

7925 
mg_h‰p_’dpošt
 *
Ãw_•
 = 
NULL
;

7927 ià(
nc
 =ğ
NULL
) ;

7928 
Ãw_•
 = (
mg_h‰p_’dpošt
 *è
	`ÿÎoc
(1, (*new_ep));

7929 ià(
Ãw_•
 =ğ
NULL
) ;

7931 
pd
 = 
	`mg_h‰p_g‘_´Ùo_d©a
(
nc
);

7932 
Ãw_•
->
Çme
 = 
	`¡rdup
(
uri_·th
);

7933 
Ãw_•
->
Çme_Ën
 = 
	`¡¾’
Òew_•->
Çme
);

7934 
Ãw_•
->
hªdËr
 = handler;

7935 
Ãw_•
->
Ãxt
 = 
pd
->
’dpošts
;

7936 
pd
->
’dpošts
 = 
Ãw_•
;

7937 
	}
}

7940 #ifdeà
MG_MODULE_LINES


7948 #ià
MG_ENABLE_HTTP
 && 
MG_ENABLE_HTTP_CGI


7950 #iâdeà
MG_MAX_CGI_ENVIR_VARS


7951 
	#MG_MAX_CGI_ENVIR_VARS
 64

	)

7954 #iâdeà
MG_ENV_EXPORT_TO_CGI


7955 
	#MG_ENV_EXPORT_TO_CGI
 "MONGOOSE_CGI"

	)

7968 
	smg_cgi_’v_block
 {

7969 
mg_cÚÃùiÚ
 *
	mnc
;

7970 
	mbuf
[
MG_CGI_ENVIRONMENT_SIZE
];

7971 cÚ¡ *
	mv¬s
[
MG_MAX_CGI_ENVIR_VARS
];

7972 
	mËn
;

7973 
	mnv¬s
;

7976 #ifdeà
_WIN32


7977 
	smg_th»ad·¿m
 {

7978 
sock_t
 
	ms
;

7979 
HANDLE
 
	mhPe
;

7982 
	$mg_wa™_uÁ_»ady
(
sock_t
 
sock
, 
fÜ_»ad
) {

7983 
fd_£t
 
£t
;

7984 
	`FD_ZERO
(&
£t
);

7985 
	`FD_SET
(
sock
, &
£t
);

7986  
	`£Ëù
(
sock
 + 1, 
fÜ_»ad
 ? &
£t
 : 0, for_read ? 0 : &set, 0, 0) == 1;

7987 
	}
}

7989 *
	$mg_push_to_¡dš
(*
¬g
) {

7990 
mg_th»ad·¿m
 *

 = (mg_th»ad·¿m *è
¬g
;

7991 
n
, 
£Á
, 
¡İ
 = 0;

7992 
DWORD
 
k
;

7993 
buf
[
BUFSIZ
];

7995 !
¡İ
 && 
	`mg_wa™_uÁ_»ady
(

->
s
, 1) &&

7996 (
n
 = 
	`»cv
(

->
s
, 
buf
, (buf), 0)) > 0) {

7997 ià(
n
 =ğ-1 && 
	`G‘La¡E¼Ü
(è=ğ
WSAEWOULDBLOCK
) ;

7998 
£Á
 = 0; !
¡İ
 && s’ˆ< 
n
; s’ˆ+ğ
k
) {

7999 ià(!
	`Wr™eFe
(

->
hPe
, 
buf
 + 
£Á
, 
n
 - s’t, &
k
, 0)è
¡İ
 = 1;

8002 
	`DBG
(("%s", "FORWARED EVERYTHING TO CGI"));

8003 
	`Clo£HªdË
(

->
hPe
);

8004 
	`MG_FREE
(

);

8005  
NULL
;

8006 
	}
}

8008 *
	$mg_puÎ_äom_¡dout
(*
¬g
) {

8009 
mg_th»ad·¿m
 *

 = (mg_th»ad·¿m *è
¬g
;

8010 
k
 = 0, 
¡İ
 = 0;

8011 
DWORD
 
n
, 
£Á
;

8012 
buf
[
BUFSIZ
];

8014 !
¡İ
 && 
	`R—dFe
(

->
hPe
, 
buf
, (buf), &
n
, 
NULL
)) {

8015 
£Á
 = 0; !
¡İ
 && s’ˆ< 
n
; s’ˆ+ğ
k
) {

8016 ià(
	`mg_wa™_uÁ_»ady
(

->
s
, 0) &&

8017 (
k
 = 
	`£nd
(

->
s
, 
buf
 + 
£Á
, 
n
 - sent, 0)) <= 0)

8018 
¡İ
 = 1;

8021 
	`DBG
(("%s", "EOF FROM CGI"));

8022 
	`Clo£HªdË
(

->
hPe
);

8023 
	`shutdown
(

->
s
, 2);

8024 
	`şo£sock‘
(

->
s
);

8025 
	`MG_FREE
(

);

8026  
NULL
;

8027 
	}
}

8029 
mg_¥awn_¡dio_th»ad
(
sock_t
 
sock
, 
HANDLE
 
hPe
,

8030 *(*
func
)(*)) {

8031 
mg_th»ad·¿m
 *
	g
 = (mg_th»ad·¿m *è
MG_MALLOC
((*

));

8032 ià(
	g
 !ğ
NULL
) {

8033 

->
s
 = 
sock
;

8034 
	g
->
	ghPe
 = 
hPe
;

8035 
mg_¡¬t_th»ad
(
func
, 

);

8039 
	$mg_abs_·th
(cÚ¡ *
utf8_·th
, *
abs_·th
, 
size_t
 
Ën
) {

8040 
wch¬_t
 
buf
[
MAX_PATH_SIZE
], 
buf2
[MAX_PATH_SIZE];

8041 
	`to_wch¬
(
utf8_·th
, 
buf
, 
	`ARRAY_SIZE
(buf));

8042 
	`G‘FuÎP©hNameW
(
buf
, 
	`ARRAY_SIZE
(
buf2
), buf2, 
NULL
);

8043 
	`WideCh¬ToMuÉiBy‹
(
CP_UTF8
, 0, 
buf2
, 
	`wc¦’
(buf2è+ 1, 
abs_·th
, 
Ën
, 0, 0);

8044 
	}
}

8046 
	$mg_¡¬t_´oûss
(cÚ¡ *
š‹½
, cÚ¡ *
cmd
,

8047 cÚ¡ *
’v
, cÚ¡ *
’vp
[],

8048 cÚ¡ *
dœ
, 
sock_t
 
sock
) {

8049 
STARTUPINFOW
 
si
;

8050 
PROCESS_INFORMATION
 
pi
;

8051 
HANDLE
 
a
[2], 
b
[2], 
me
 = 
	`G‘Cu¼’tProûss
();

8052 
wch¬_t
 
wcmd
[
MAX_PATH_SIZE
], 
fuÎ_dœ
[MAX_PATH_SIZE];

8053 
buf
[
MAX_PATH_SIZE
], 
buf2
[MAX_PATH_SIZE], 
buf5
[MAX_PATH_SIZE],

8054 
buf4
[
MAX_PATH_SIZE
], 
cmdlše
[MAX_PATH_SIZE];

8055 
DWORD
 
æags
 = 
DUPLICATE_CLOSE_SOURCE
 | 
DUPLICATE_SAME_ACCESS
;

8056 
FILE
 *
å
;

8058 
	`mem£t
(&
si
, 0, (si));

8059 
	`mem£t
(&
pi
, 0, (pi));

8061 
si
.
cb
 = (si);

8062 
si
.
dwFÏgs
 = 
STARTF_USESTDHANDLES
 | 
STARTF_USESHOWWINDOW
;

8063 
si
.
wShowWšdow
 = 
SW_HIDE
;

8064 
si
.
hStdE¼Ü
 = 
	`G‘StdHªdË
(
STD_ERROR_HANDLE
);

8066 
	`C»©ePe
(&
a
[0], &a[1], 
NULL
, 0);

8067 
	`C»©ePe
(&
b
[0], &b[1], 
NULL
, 0);

8068 
	`Du¶iÿ‹HªdË
(
me
, 
a
[0], me, &
si
.
hStdIÅut
, 0, 
TRUE
, 
æags
);

8069 
	`Du¶iÿ‹HªdË
(
me
, 
b
[1], me, &
si
.
hStdOuut
, 0, 
TRUE
, 
æags
);

8071 ià(
š‹½
 =ğ
NULL
 && (
å
 = 
	`mg_fİ’
(
cmd
, "r")) != NULL) {

8072 
buf
[0] = buf[1] = '\0';

8073 
	`fg‘s
(
buf
, (buf), 
å
);

8074 
buf
[(buf) - 1] = '\0';

8075 ià(
buf
[0] == '#' && buf[1] == '!') {

8076 
š‹½
 = 
buf
 + 2;

8078 *
š‹½
 !ğ'\0' && 
	`is¥aû
(*(*) interp)) {

8079 
š‹½
++;

8082 
	`fşo£
(
å
);

8085 
	`¢´štf
(
buf
, (buf), "%s/%s", 
dœ
, 
cmd
);

8086 
	`mg_abs_·th
(
buf
, 
buf2
, 
	`ARRAY_SIZE
(buf2));

8088 
	`mg_abs_·th
(
dœ
, 
buf5
, 
	`ARRAY_SIZE
(buf5));

8089 
	`to_wch¬
(
dœ
, 
fuÎ_dœ
, 
	`ARRAY_SIZE
(full_dir));

8091 ià(
š‹½
 !ğ
NULL
) {

8092 
	`mg_abs_·th
(
š‹½
, 
buf4
, 
	`ARRAY_SIZE
(buf4));

8093 
	`¢´štf
(
cmdlše
, (cmdlše), "% \"%s\"", 
buf4
, 
buf2
);

8095 
	`¢´štf
(
cmdlše
, (cmdlše), "\"%s\"", 
buf2
);

8097 
	`to_wch¬
(
cmdlše
, 
wcmd
, 
	`ARRAY_SIZE
(wcmd));

8099 ià(
	`C»©eProûssW
(
NULL
, 
wcmd
, NULL, NULL, 
TRUE
, 
CREATE_NEW_PROCESS_GROUP
,

8100 (*è
’v
, 
fuÎ_dœ
, &
si
, &
pi
) != 0) {

8101 
	`mg_¥awn_¡dio_th»ad
(
sock
, 
a
[1], 
mg_push_to_¡dš
);

8102 
	`mg_¥awn_¡dio_th»ad
(
sock
, 
b
[0], 
mg_puÎ_äom_¡dout
);

8104 
	`Clo£HªdË
(
si
.
hStdOuut
);

8105 
	`Clo£HªdË
(
si
.
hStdIÅut
);

8107 
	`Clo£HªdË
(
pi
.
hTh»ad
);

8108 
	`Clo£HªdË
(
pi
.
hProûss
);

8110 
	`Clo£HªdË
(
a
[1]);

8111 
	`Clo£HªdË
(
b
[0]);

8112 
	`şo£sock‘
(
sock
);

8114 
	`DBG
(("CGI commªd: [%ls] -> %p", 
wcmd
, 
pi
.
hProûss
));

8117 (è
’vp
;

8118  (
pi
.
hProûss
 !ğ
NULL
);

8119 
	}
}

8121 
	$mg_¡¬t_´oûss
(cÚ¡ *
š‹½
, cÚ¡ *
cmd
,

8122 cÚ¡ *
’v
, cÚ¡ *
’vp
[],

8123 cÚ¡ *
dœ
, 
sock_t
 
sock
) {

8124 
buf
[500];

8125 
pid_t
 
pid
 = 
	`fÜk
();

8126 (è
’v
;

8128 ià(
pid
 == 0) {

8133 
tmp
 = 
	`chdœ
(
dœ
);

8134 (è
tmp
;

8135 (è
	`dup2
(
sock
, 0);

8136 (è
	`dup2
(
sock
, 1);

8137 
	`şo£sock‘
(
sock
);

8145 
	`sigÇl
(
SIGCHLD
, 
SIG_DFL
);

8147 ià(
š‹½
 =ğ
NULL
) {

8148 
	`exeşe
(
cmd
, cmd, (*è0, 
’vp
);

8150 
	`exeşe
(
š‹½
, iÁ”p, 
cmd
, (*è0, 
’vp
);

8152 
	`¢´štf
(
buf
, (buf),

8155 
š‹½
 =ğ
NULL
 ? "" : iÁ”p, iÁ”°=ğNULL ? "" : " ", 
cmd
,

8156 
	`¡»¼Ü
(
”ºo
));

8157 
	`£nd
(1, 
buf
, 
	`¡¾’
(buf), 0);

8158 
	`_ex™
(
EXIT_FAILURE
);

8161  (
pid
 != 0);

8162 
	}
}

8169 *
	$mg_add’v
(
mg_cgi_’v_block
 *
block
, cÚ¡ *
fmt
, ...) {

8170 
n
, 
¥aû
;

8171 *
added
 = 
block
->
buf
 + block->
Ën
;

8172 
va_li¡
 
­
;

8175 
¥aû
 = (
block
->
buf
è- (block->
Ën
 + 2);

8176 ià(
¥aû
 > 0) {

8178 
	`va_¡¬t
(
­
, 
fmt
);

8179 
n
 = 
	`v¢´štf
(
added
, (
size_t
è
¥aû
, 
fmt
, 
­
);

8180 
	`va_’d
(
­
);

8183 ià(
n
 > 0 &&‚ + 1 < 
¥aû
 &&

8184 
block
->
nv¬s
 < (è
	`ARRAY_SIZE
(block->
v¬s
) - 2) {

8186 
block
->
v¬s
[block->
nv¬s
++] = 
added
;

8188 
block
->
Ën
 +ğ
n
 + 1;

8192  
added
;

8193 
	}
}

8195 
	$mg_add’v2
(
mg_cgi_’v_block
 *
blk
, cÚ¡ *
Çme
) {

8196 cÚ¡ *
s
;

8197 ià((
s
 = 
	`g‘’v
(
Çme
)è!ğ
NULL
è
	`mg_add’v
(
blk
, "%s=%s",‚ame, s);

8198 
	}
}

8200 
	$mg_´•¬e_cgi_’vœÚm’t
(
mg_cÚÃùiÚ
 *
nc
,

8201 cÚ¡ *
´og
,

8202 cÚ¡ 
mg_¡r
 *
·th_šfo
,

8203 cÚ¡ 
h‰p_mes§ge
 *
hm
,

8204 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
,

8205 
mg_cgi_’v_block
 *
blk
) {

8206 cÚ¡ *
s
;

8207 
mg_¡r
 *
h
;

8208 *
p
;

8209 
size_t
 
i
;

8210 
buf
[100];

8212 
blk
->
Ën
 = blk->
nv¬s
 = 0;

8213 
blk
->
nc
 =‚c;

8215 ià((
s
 = 
	`g‘’v
("SERVER_NAME")è!ğ
NULL
) {

8216 
	`mg_add’v
(
blk
, "SERVER_NAME=%s", 
s
);

8218 
	`mg_sock_to_¡r
(
nc
->
sock
, 
buf
, (buf), 3);

8219 
	`mg_add’v
(
blk
, "SERVER_NAME=%s", 
buf
);

8221 
	`mg_add’v
(
blk
, "SERVER_ROOT=%s", 
İts
->
docum’t_roÙ
);

8222 
	`mg_add’v
(
blk
, "DOCUMENT_ROOT=%s", 
İts
->
docum’t_roÙ
);

8223 
	`mg_add’v
(
blk
, "SERVER_SOFTWARE=%s/%s", "MÚgoo£", 
MG_VERSION
);

8226 
	`mg_add’v
(
blk
, "%s", "GATEWAY_INTERFACE=CGI/1.1");

8227 
	`mg_add’v
(
blk
, "%s", "SERVER_PROTOCOL=HTTP/1.1");

8228 
	`mg_add’v
(
blk
, "%s", "REDIRECT_STATUS=200");

8230 
	`mg_add’v
(
blk
, "REQUEST_METHOD=%.*s", (è
hm
->
m‘hod
.
Ën
, hm->m‘hod.
p
);

8232 
	`mg_add’v
(
blk
, "REQUEST_URI=%.*s%s%.*s", (è
hm
->
uri
.
Ën
, hm->uri.
p
,

8233 
hm
->
qu”y_¡ršg
.
Ën
 == 0 ? "" : "?", () hm->query_string.len,

8234 
hm
->
qu”y_¡ršg
.
p
);

8236 
	`mg_cÚn_addr_to_¡r
(
nc
, 
buf
, (buf),

8237 
MG_SOCK_STRINGIFY_REMOTE
 | 
MG_SOCK_STRINGIFY_IP
);

8238 
	`mg_add’v
(
blk
, "REMOTE_ADDR=%s", 
buf
);

8239 
	`mg_cÚn_addr_to_¡r
(
nc
, 
buf
, (buf), 
MG_SOCK_STRINGIFY_PORT
);

8240 
	`mg_add’v
(
blk
, "SERVER_PORT=%s", 
buf
);

8242 
s
 = 
hm
->
uri
.
p
 + hm->uri.
Ën
 - 
·th_šfo
->len - 1;

8243 ià(*
s
 == '/') {

8244 cÚ¡ *
ba£_Çme
 = 
	`¡¼chr
(
´og
, 
DIRSEP
);

8245 
	`mg_add’v
(
blk
, "SCRIPT_NAME=%.*s/%s", (è(
s
 - 
hm
->
uri
.
p
), hm->uri.p,

8246 (
ba£_Çme
 !ğ
NULL
 ? ba£_Çm+ 1 : 
´og
));

8248 
	`mg_add’v
(
blk
, "SCRIPT_NAME=%.*s", (è(
s
 - 
hm
->
uri
.
p
 + 1), hm->uri.p);

8250 
	`mg_add’v
(
blk
, "SCRIPT_FILENAME=%s", 
´og
);

8252 ià(
·th_šfo
 !ğ
NULL
 &&…©h_šfo->
Ën
 > 0) {

8253 
	`mg_add’v
(
blk
, "PATH_INFO=%.*s", (è
·th_šfo
->
Ën
,…©h_šfo->
p
);

8255 
	`mg_add’v
(
blk
, "PATH_TRANSLATED=%.*s", (è
·th_šfo
->
Ën
,…©h_šfo->
p
);

8258 #ià
MG_ENABLE_SSL


8259 
	`mg_add’v
(
blk
, "HTTPS=%s", (
nc
->
æags
 & 
MG_F_SSL
 ? "on" : "off"));

8261 
	`mg_add’v
(
blk
, "HTTPS=off");

8264 ià((
h
 = 
	`mg_g‘_h‰p_h—d”
((
h‰p_mes§ge
 *è
hm
, "Content-Type")) !=

8265 
NULL
) {

8266 
	`mg_add’v
(
blk
, "CONTENT_TYPE=%.*s", (è
h
->
Ën
, h->
p
);

8269 ià(
hm
->
qu”y_¡ršg
.
Ën
 > 0) {

8270 
	`mg_add’v
(
blk
, "QUERY_STRING=%.*s", (è
hm
->
qu”y_¡ršg
.
Ën
,

8271 
hm
->
qu”y_¡ršg
.
p
);

8274 ià((
h
 = 
	`mg_g‘_h‰p_h—d”
((
h‰p_mes§ge
 *è
hm
, "Content-Length")) !=

8275 
NULL
) {

8276 
	`mg_add’v
(
blk
, "CONTENT_LENGTH=%.*s", (è
h
->
Ën
, h->
p
);

8279 
	`mg_add’v2
(
blk
, "PATH");

8280 
	`mg_add’v2
(
blk
, "TMP");

8281 
	`mg_add’v2
(
blk
, "TEMP");

8282 
	`mg_add’v2
(
blk
, "TMPDIR");

8283 
	`mg_add’v2
(
blk
, "PERLLIB");

8284 
	`mg_add’v2
(
blk
, 
MG_ENV_EXPORT_TO_CGI
);

8286 #ifdeà
_WIN32


8287 
	`mg_add’v2
(
blk
, "COMSPEC");

8288 
	`mg_add’v2
(
blk
, "SYSTEMROOT");

8289 
	`mg_add’v2
(
blk
, "SystemDrive");

8290 
	`mg_add’v2
(
blk
, "ProgramFiles");

8291 
	`mg_add’v2
(
blk
, "ProgramFiles(x86)");

8292 
	`mg_add’v2
(
blk
, "CommonProgramFiles(x86)");

8294 
	`mg_add’v2
(
blk
, "LD_LIBRARY_PATH");

8298 
i
 = 0; 
hm
->
h—d”_Çmes
[i].
Ën
 > 0; i++) {

8299 
p
 = 
	`mg_add’v
(
blk
, "HTTP_%.*s=%.*s", (è
hm
->
h—d”_Çmes
[
i
].
Ën
,

8300 
hm
->
h—d”_Çmes
[
i
].
p
, (èhm->
h—d”_v®ues
[i].
Ën
,

8301 
hm
->
h—d”_v®ues
[
i
].
p
);

8304 ; *
p
 != '=' && *p != '\0';…++) {

8305 ià(*
p
 == '-') *p = '_';

8306 *
p
 = (è
	`touµ”
(*(*)…);

8310 
blk
->
v¬s
[blk->
nv¬s
++] = 
NULL
;

8311 
blk
->
buf
[blk->
Ën
++] = '\0';

8312 
	}
}

8314 
	$mg_cgi_ev_hªdËr
(
mg_cÚÃùiÚ
 *
cgi_nc
, 
ev
,

8315 *
ev_d©a
) {

8316 
mg_cÚÃùiÚ
 *
nc
 = (mg_cÚÃùiÚ *è
cgi_nc
->
u£r_d©a
;

8317 (è
ev_d©a
;

8319 ià(
nc
 =ğ
NULL
) {

8320 
cgi_nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

8324 
ev
) {

8325 
MG_EV_RECV
:

8339 ià(
nc
->
æags
 & 
MG_F_USER_1
) {

8340 
mbuf
 *
io
 = &
cgi_nc
->
»cv_mbuf
;

8341 
Ën
 = 
	`mg_h‰p_g‘_»que¡_Ën
(
io
->
buf
, io->len);

8343 ià(
Ën
 == 0) ;

8344 ià(
Ën
 < 0 || 
io
->ËÀ> 
MG_MAX_HTTP_REQUEST_SIZE
) {

8345 
cgi_nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

8346 
	`mg_h‰p_£nd_”rÜ
(
nc
, 500, "Bad headers");

8348 
h‰p_mes§ge
 
hm
;

8349 
mg_¡r
 *
h
;

8350 
	`mg_h‰p_·r£_h—d”s
(
io
->
buf
, io->buà+ io->
Ën
, io->Ën, &
hm
);

8351 ià(
	`mg_g‘_h‰p_h—d”
(&
hm
, "LoÿtiÚ"è!ğ
NULL
) {

8352 
	`mg_´štf
(
nc
, "%s", "HTTP/1.1 302 Moved\r\n");

8353 } ià((
h
 = 
	`mg_g‘_h‰p_h—d”
(&
hm
, "Stus")è!ğ
NULL
) {

8354 
	`mg_´štf
(
nc
, "HTTP/1.1 %.*s\r\n", (è
h
->
Ën
, h->
p
);

8356 
	`mg_´štf
(
nc
, "%s", "HTTP/1.1 200 OK\r\n");

8359 
nc
->
æags
 &ğ~
MG_F_USER_1
;

8361 ià(!(
nc
->
æags
 & 
MG_F_USER_1
)) {

8362 
	`mg_fÜw¬d
(
cgi_nc
, 
nc
);

8365 
MG_EV_CLOSE
:

8366 
	`mg_h‰p_ä“_´Ùo_d©a_cgi
(&
	`mg_h‰p_g‘_´Ùo_d©a
(
nc
)->
cgi
);

8367 
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

8370 
	}
}

8372 
MG_INTERNAL
 
	$mg_hªdË_cgi
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
´og
,

8373 cÚ¡ 
mg_¡r
 *
·th_šfo
,

8374 cÚ¡ 
h‰p_mes§ge
 *
hm
,

8375 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
) {

8376 
mg_cgi_’v_block
 
blk
;

8377 
dœ
[
MAX_PATH_SIZE
];

8378 cÚ¡ *
p
;

8379 
sock_t
 
fds
[2];

8381 
	`DBG
(("%°[%s]", 
nc
, 
´og
));

8382 
	`mg_´•¬e_cgi_’vœÚm’t
(
nc
, 
´og
, 
·th_šfo
, 
hm
, 
İts
, &
blk
);

8388 ià((
p
 = 
	`¡¼chr
(
´og
, 
DIRSEP
)è=ğ
NULL
) {

8389 
	`¢´štf
(
dœ
, (dir), "%s", ".");

8391 
	`¢´štf
(
dœ
, (dœ), "%.*s", (è(
p
 - 
´og
),…rog);

8392 
´og
 = 
p
 + 1;

8401 
	`mg_sock‘·œ
(
fds
, 
SOCK_STREAM
);

8402 } 
fds
[0] =ğ
INVALID_SOCKET
);

8404 ià(
	`mg_¡¬t_´oûss
(
İts
->
cgi_š‹½»‹r
, 
´og
, 
blk
.
buf
, blk.
v¬s
, 
dœ
,

8405 
fds
[1]) != 0) {

8406 
size_t
 
n
 = 
nc
->
»cv_mbuf
.
Ën
 - (
hm
->
mes§ge
.ËÀ- hm->
body
.len);

8407 
mg_cÚÃùiÚ
 *
cgi_nc
 =

8408 
	`mg_add_sock
(
nc
->
mgr
, 
fds
[0], 
mg_cgi_ev_hªdËr
);

8409 
mg_h‰p_´Ùo_d©a
 *
cgi_pd
 = 
	`mg_h‰p_g‘_´Ùo_d©a
(
nc
);

8410 
cgi_pd
->
cgi
.
cgi_nc
 = cgi_nc;

8411 
cgi_pd
->
cgi
.
cgi_nc
->
u£r_d©a
 = 
nc
;

8412 
nc
->
æags
 |ğ
MG_F_USER_1
;

8414 ià(
n
 > 0 &&‚ < 
nc
->
»cv_mbuf
.
Ën
) {

8415 
	`mg_£nd
(
cgi_pd
->
cgi
.
cgi_nc
, 
hm
->
body
.
p
, 
n
);

8417 
	`mbuf_»move
(&
nc
->
»cv_mbuf
,‚c->»cv_mbuf.
Ën
);

8419 
	`şo£sock‘
(
fds
[0]);

8420 
	`mg_h‰p_£nd_”rÜ
(
nc
, 500, "CGI failure");

8423 #iâdeà
_WIN32


8424 
	`şo£sock‘
(
fds
[1]);

8426 
	}
}

8428 
MG_INTERNAL
 
	$mg_h‰p_ä“_´Ùo_d©a_cgi
(
mg_h‰p_´Ùo_d©a_cgi
 *
d
) {

8429 ià(
d
 !ğ
NULL
) {

8430 ià(
d
->
cgi_nc
 !ğ
NULL
èd->cgi_nc->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

8431 
	`mem£t
(
d
, 0, (
mg_h‰p_´Ùo_d©a_cgi
));

8433 
	}
}

8436 #ifdeà
MG_MODULE_LINES


8444 #ià
MG_ENABLE_HTTP
 && 
MG_ENABLE_HTTP_SSI
 && 
MG_ENABLE_FILESYSTEM


8446 
mg_£nd_ssi_fe
(
mg_cÚÃùiÚ
 *
nc
, 
h‰p_mes§ge
 *
hm
,

8447 cÚ¡ *
·th
, 
FILE
 *
å
, 
šşude_Ëv–
,

8448 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
);

8450 
	$mg_£nd_fe_d©a
(
mg_cÚÃùiÚ
 *
nc
, 
FILE
 *
å
) {

8451 
buf
[
BUFSIZ
];

8452 
size_t
 
n
;

8454 (
n
 = 
	`ä—d
(
buf
, 1, (buf), 
å
)) > 0) {

8455 
	`mg_£nd
(
nc
, 
buf
, 
n
);

8457 
	}
}

8459 
	$mg_do_ssi_šşude
(
mg_cÚÃùiÚ
 *
nc
, 
h‰p_mes§ge
 *
hm
,

8460 cÚ¡ *
ssi
, *
g
, 
šşude_Ëv–
,

8461 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
) {

8462 
fe_Çme
[
BUFSIZ
], 
·th
[
MAX_PATH_SIZE
], *
p
;

8463 
FILE
 *
å
;

8469 ià(
	`ssÿnf
(
g
, " vœtu®=\"%[^\"]\"", 
fe_Çme
) == 1) {

8471 
	`¢´štf
(
·th
, Õ©h), "%s/%s", 
İts
->
docum’t_roÙ
, 
fe_Çme
);

8472 } ià(
	`ssÿnf
(
g
, "‡b¥©h=\"%[^\"]\"", 
fe_Çme
) == 1) {

8477 
	`¢´štf
(
·th
, Õ©h), "%s", 
fe_Çme
);

8478 } ià(
	`ssÿnf
(
g
, " fe=\"%[^\"]\"", 
fe_Çme
) == 1 ||

8479 
	`ssÿnf
(
g
, " \"%[^\"]\"", 
fe_Çme
) == 1) {

8481 
	`¢´štf
(
·th
, Õ©h), "%s", 
ssi
);

8482 ià((
p
 = 
	`¡¼chr
(
·th
, 
DIRSEP
)è!ğ
NULL
) {

8483 
p
[1] = '\0';

8485 
	`¢´štf
(
·th
 + 
	`¡¾’
Õ©h), Õ©hè- sŒËnÕ©h), "%s", 
fe_Çme
);

8487 
	`mg_´štf
(
nc
, "Bad SSI #šşude: [%s]", 
g
);

8491 ià((
å
 = 
	`mg_fİ’
(
·th
, "rb")è=ğ
NULL
) {

8492 
	`mg_´štf
(
nc
, "SSI inşud”rÜ: mg_fİ’(%s): %s", 
·th
,

8493 
	`¡»¼Ü
(
	`mg_g‘_”ºo
()));

8495 
	`mg_£t_şo£_Ú_exec
((
sock_t
è
	`f’o
(
å
));

8496 ià(
	`mg_m©ch_´efix
(
İts
->
ssi_·‰”n
, 
	`¡¾’
(İts->ssi_·‰”n), 
·th
) >

8498 
	`mg_£nd_ssi_fe
(
nc
, 
hm
, 
·th
, 
å
, 
šşude_Ëv–
 + 1, 
İts
);

8500 
	`mg_£nd_fe_d©a
(
nc
, 
å
);

8502 
	`fşo£
(
å
);

8504 
	}
}

8506 #ià
MG_ENABLE_HTTP_SSI_EXEC


8507 
	$do_ssi_exec
(
mg_cÚÃùiÚ
 *
nc
, *
g
) {

8508 
cmd
[
BUFSIZ
];

8509 
FILE
 *
å
;

8511 ià(
	`ssÿnf
(
g
, " \"%[^\"]\"", 
cmd
) != 1) {

8512 
	`mg_´štf
(
nc
, "Bad SSI #exec: [%s]", 
g
);

8513 } ià((
å
 = 
	`pİ’
(
cmd
, "r")è=ğ
NULL
) {

8514 
	`mg_´štf
(
nc
, "CªnÙ SSI #exec: [%s]: %s", 
cmd
, 
	`¡»¼Ü
(
	`mg_g‘_”ºo
()));

8516 
	`mg_£nd_fe_d©a
(
nc
, 
å
);

8517 
	`pşo£
(
å
);

8519 
	}
}

8526 
	$mg_£nd_ssi_fe
(
mg_cÚÃùiÚ
 *
nc
, 
h‰p_mes§ge
 *
hm
,

8527 cÚ¡ *
·th
, 
FILE
 *
å
, 
šşude_Ëv–
,

8528 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
) {

8529 cÚ¡ 
mg_¡r
 
bg
 = 
	`MG_MK_STR
("<!--#");

8530 cÚ¡ 
mg_¡r
 
d_šşude
 = 
	`MG_MK_STR
("include");

8531 cÚ¡ 
mg_¡r
 
d_ÿÎ
 = 
	`MG_MK_STR
("call");

8532 #ià
MG_ENABLE_HTTP_SSI_EXEC


8533 cÚ¡ 
mg_¡r
 
d_exec
 = 
	`MG_MK_STR
("exec");

8535 
buf
[
BUFSIZ
], *
p
 = buà+ 
bg
.
Ën
;

8536 
ch
, 
Ën
, 
š_ssi_g
;

8538 ià(
šşude_Ëv–
 > 10) {

8539 
	`mg_´štf
(
nc
, "SSI #šşudËv– i toØd“°(%s)", 
·th
);

8543 
š_ssi_g
 = 
Ën
 = 0;

8544 (
ch
 = 
	`fg‘c
(
å
)è!ğ
EOF
) {

8545 ià(
š_ssi_g
 && 
ch
 =ğ'>' && 
buf
[
Ën
 - 1] == '-' && buf[len - 2] == '-') {

8546 
size_t
 
i
 = 
Ën
 - 2;

8547 
š_ssi_g
 = 0;

8550 
buf
[
i
--] = '\0';

8551 
i
 > 0 && 
buf
[i] == ' ') {

8552 
buf
[
i
--] = '\0';

8556 ià(
	`¡ºcmp
(
p
, 
d_šşude
.p, d_šşude.
Ën
) == 0) {

8557 
	`mg_do_ssi_šşude
(
nc
, 
hm
, 
·th
, 
p
 + 
d_šşude
.
Ën
 + 1, 
šşude_Ëv–
,

8558 
İts
);

8559 } ià(
	`¡ºcmp
(
p
, 
d_ÿÎ
.p, d_ÿÎ.
Ën
) == 0) {

8560 
mg_ssi_ÿÎ_ùx
 
cùx
;

8561 
	`mem£t
(&
cùx
, 0, (cctx));

8562 
cùx
.
»q
 = 
hm
;

8563 
cùx
.
fe
 = 
	`mg_mk_¡r
(
·th
);

8564 
cùx
.
¬g
 = 
	`mg_mk_¡r
(
p
 + 
d_ÿÎ
.
Ën
 + 1);

8565 
	`mg_ÿÎ
(
nc
, 
NULL
, 
MG_EV_SSI_CALL
,

8566 (*è
cùx
.
¬g
.
p
);

8567 
	`mg_ÿÎ
(
nc
, 
NULL
, 
MG_EV_SSI_CALL_CTX
, &
cùx
);

8568 #ià
MG_ENABLE_HTTP_SSI_EXEC


8569 } ià(
	`¡ºcmp
(
p
, 
d_exec
.p, d_exec.
Ën
) == 0) {

8570 
	`do_ssi_exec
(
nc
, 
p
 + 
d_exec
.
Ën
 + 1);

8575 
Ën
 = 0;

8576 } ià(
ch
 == '<') {

8577 
š_ssi_g
 = 1;

8578 ià(
Ën
 > 0) {

8579 
	`mg_£nd
(
nc
, 
buf
, (
size_t
è
Ën
);

8581 
Ën
 = 0;

8582 
buf
[
Ën
++] = 
ch
 & 0xff;

8583 } ià(
š_ssi_g
) {

8584 ià(
Ën
 =ğ(è
bg
.ËÀ&& 
	`¡ºcmp
(
buf
, bg.
p
, btag.len) != 0) {

8586 
š_ssi_g
 = 0;

8587 } ià(
Ën
 =ğ(è(
buf
) - 2) {

8588 
	`mg_´štf
(
nc
, "%s: SSIag i toØÏrge", 
·th
);

8589 
Ën
 = 0;

8591 
buf
[
Ën
++] = 
ch
 & 0xff;

8593 
buf
[
Ën
++] = 
ch
 & 0xff;

8594 ià(
Ën
 =ğ(è(
buf
)) {

8595 
	`mg_£nd
(
nc
, 
buf
, (
size_t
è
Ën
);

8596 
Ën
 = 0;

8602 ià(
Ën
 > 0) {

8603 
	`mg_£nd
(
nc
, 
buf
, (
size_t
è
Ën
);

8605 
	}
}

8607 
MG_INTERNAL
 
	$mg_hªdË_ssi_»que¡
(
mg_cÚÃùiÚ
 *
nc
,

8608 
h‰p_mes§ge
 *
hm
,

8609 cÚ¡ *
·th
,

8610 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
) {

8611 
FILE
 *
å
;

8612 
mg_¡r
 
mime_ty³
;

8613 
	`DBG
(("%°%s", 
nc
, 
·th
));

8615 ià((
å
 = 
	`mg_fİ’
(
·th
, "rb")è=ğ
NULL
) {

8616 
	`mg_h‰p_£nd_”rÜ
(
nc
, 404, 
NULL
);

8618 
	`mg_£t_şo£_Ú_exec
((
sock_t
è
	`f’o
(
å
));

8620 
mime_ty³
 = 
	`mg_g‘_mime_ty³
(
·th
, "‹xt/¶aš", 
İts
);

8621 
	`mg_£nd_»¥Ú£_lše
(
nc
, 200, 
İts
->
exŒa_h—d”s
);

8622 
	`mg_´štf
(
nc
,

8625 (è
mime_ty³
.
Ën
, mime_ty³.
p
);

8626 
	`mg_£nd_ssi_fe
(
nc
, 
hm
, 
·th
, 
å
, 0, 
İts
);

8627 
	`fşo£
(
å
);

8628 
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

8630 
	}
}

8633 #ifdeà
MG_MODULE_LINES


8641 #ià
MG_ENABLE_HTTP
 && 
MG_ENABLE_HTTP_WEBDAV


8643 
MG_INTERNAL
 
	$mg_is_dav_»que¡
(cÚ¡ 
mg_¡r
 *
s
) {

8644 cÚ¡ *
m‘hods
[] = {

8650 #ià
MG_ENABLE_FAKE_DAVLOCK


8656 
size_t
 
i
;

8658 
i
 = 0; i < 
	`ARRAY_SIZE
(
m‘hods
); i++) {

8659 ià(
	`mg_vcmp
(
s
, 
m‘hods
[
i
]) == 0) {

8665 
	}
}

8667 
	$mg_mkdœ
(cÚ¡ *
·th
, 
ušt32_t
 
mode
) {

8668 #iâdeà
_WIN32


8669  
	`mkdœ
(
·th
, 
mode
);

8671 (è
mode
;

8672  
	`_mkdœ
(
·th
);

8674 
	}
}

8676 
	$mg_´št_´İs
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
Çme
,

8677 
cs_¡©_t
 *
¡p
) {

8678 
mtime
[64], 
buf
[
MAX_PATH_SIZE
 * 3];

8679 
time_t
 
t
 = 
¡p
->
¡_mtime
;

8680 
	`mg_gmt_time_¡ršg
(
mtime
, (mtime), &
t
);

8681 
	`mg_u¾_’code
(
Çme
, 
	`¡¾’
Òame), 
buf
, (buf));

8682 
	`mg_´štf
(
nc
,

8688 "<d:g‘cÚ‹ÁËngth>%" 
INT64_FMT


8695 
buf
, 
	`S_ISDIR
(
¡p
->
¡_mode
) ? "<d:collection/>" : "",

8696 (
št64_t
è
¡p
->
¡_size
, 
mtime
);

8697 
	}
}

8699 
MG_INTERNAL
 
	$mg_hªdË_´İfšd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

8700 
cs_¡©_t
 *
¡p
, 
h‰p_mes§ge
 *
hm
,

8701 
mg_£rve_h‰p_İts
 *
İts
) {

8702 cÚ¡ 
h—d”
[] =

8708 cÚ¡ 
foÙ”
[] = "</d:multistatus>\n";

8709 cÚ¡ 
mg_¡r
 *
d•th
 = 
	`mg_g‘_h‰p_h—d”
(
hm
, "Depth");

8712 ià(
	`S_ISDIR
(
¡p
->
¡_mode
) &&

8713 
	`¡rcmp
(
İts
->
’abË_dœeùÜy_li¡šg
, "yes") != 0) {

8714 
	`mg_´štf
(
nc
, "%s", "HTTP/1.1 403 Directory Listing Denied\r\n\r\n");

8716 
uri
[
MAX_PATH_SIZE
];

8717 
	`mg_£nd
(
nc
, 
h—d”
, (header) - 1);

8718 
	`¢´štf
(
uri
, (uri), "%.*s", (è
hm
->uri.
Ën
, hm->uri.
p
);

8719 
	`mg_´št_´İs
(
nc
, 
uri
, 
¡p
);

8720 ià(
	`S_ISDIR
(
¡p
->
¡_mode
è&& (
d•th
 =ğ
NULL
 || 
	`mg_vcmp
(depth, "0") != 0)) {

8721 
	`mg_sÿn_dœeùÜy
(
nc
, 
·th
, 
İts
, 
mg_´št_´İs
);

8723 
	`mg_£nd
(
nc
, 
foÙ”
, (footer) - 1);

8724 
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

8726 
	}
}

8728 #ià
MG_ENABLE_FAKE_DAVLOCK


8740 
MG_INTERNAL
 
	$mg_hªdË_lock
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
) {

8741 cÚ¡ *
»¶y
 =

8757 
	`mg_´štf
(
nc
, 
»¶y
, 
·th
, (è
	`mg_time
());

8758 
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

8759 
	}
}

8762 
MG_INTERNAL
 
	$mg_hªdË_mkcŞ
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

8763 
h‰p_mes§ge
 *
hm
) {

8764 
¡©us_code
 = 500;

8765 ià(
hm
->
body
.
Ën
 !ğ(
size_t
) ~0 && hm->body.len > 0) {

8766 
¡©us_code
 = 415;

8767 } ià(!
	`mg_mkdœ
(
·th
, 0755)) {

8768 
¡©us_code
 = 201;

8769 } ià(
”ºo
 =ğ
EEXIST
) {

8770 
¡©us_code
 = 405;

8771 } ià(
”ºo
 =ğ
EACCES
) {

8772 
¡©us_code
 = 403;

8773 } ià(
”ºo
 =ğ
ENOENT
) {

8774 
¡©us_code
 = 409;

8776 
¡©us_code
 = 500;

8778 
	`mg_h‰p_£nd_”rÜ
(
nc
, 
¡©us_code
, 
NULL
);

8779 
	}
}

8781 
	$mg_»move_dœeùÜy
(cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
,

8782 cÚ¡ *
dœ
) {

8783 
·th
[
MAX_PATH_SIZE
];

8784 
dœ’t
 *
dp
;

8785 
cs_¡©_t
 
¡
;

8786 
DIR
 *
dœp
;

8788 ià((
dœp
 = 
	`İ’dœ
(
dœ
)è=ğ
NULL
)  0;

8790 (
dp
 = 
	`»addœ
(
dœp
)è!ğ
NULL
) {

8791 ià(
	`mg_is_fe_hidd’
((cÚ¡ *è
dp
->
d_Çme
, 
İts
, 1)) {

8794 
	`¢´štf
(
·th
, Õ©h), "%s%c%s", 
dœ
, '/', 
dp
->
d_Çme
);

8795 
	`mg_¡©
(
·th
, &
¡
);

8796 ià(
	`S_ISDIR
(
¡
.
¡_mode
)) {

8797 
	`mg_»move_dœeùÜy
(
İts
, 
·th
);

8799 
	`»move
(
·th
);

8802 
	`şo£dœ
(
dœp
);

8803 
	`rmdœ
(
dœ
);

8806 
	}
}

8808 
MG_INTERNAL
 
	$mg_hªdË_move
(
mg_cÚÃùiÚ
 *
c
,

8809 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
,

8810 cÚ¡ *
·th
, 
h‰p_mes§ge
 *
hm
) {

8811 cÚ¡ 
mg_¡r
 *
de¡
 = 
	`mg_g‘_h‰p_h—d”
(
hm
, "Destination");

8812 ià(
de¡
 =ğ
NULL
) {

8813 
	`mg_h‰p_£nd_”rÜ
(
c
, 411, 
NULL
);

8815 cÚ¡ *
p
 = (*è
	`memchr
(
de¡
->p, '/', de¡->
Ën
);

8816 ià(
p
 !ğ
NULL
 &&…[1] == '/' &&

8817 (
p
 = (*è
	`memchr
Õ + 2, '/', 
de¡
->°+ de¡->
Ën
 -…)è!ğ
NULL
) {

8818 
buf
[
MAX_PATH_SIZE
];

8819 
	`¢´štf
(
buf
, (buf), "%s%.*s", 
İts
->
dav_docum’t_roÙ
,

8820 (è(
de¡
->
p
 + de¡->
Ën
 -…),…);

8821 ià(
	`»Çme
(
·th
, 
buf
) == 0) {

8822 
	`mg_h‰p_£nd_”rÜ
(
c
, 200, 
NULL
);

8824 
	`mg_h‰p_£nd_”rÜ
(
c
, 418, 
NULL
);

8827 
	`mg_h‰p_£nd_”rÜ
(
c
, 500, 
NULL
);

8830 
	}
}

8832 
MG_INTERNAL
 
	$mg_hªdË_d–‘e
(
mg_cÚÃùiÚ
 *
nc
,

8833 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
,

8834 cÚ¡ *
·th
) {

8835 
cs_¡©_t
 
¡
;

8836 ià(
	`mg_¡©
(
·th
, &
¡
) != 0) {

8837 
	`mg_h‰p_£nd_”rÜ
(
nc
, 404, 
NULL
);

8838 } ià(
	`S_ISDIR
(
¡
.
¡_mode
)) {

8839 
	`mg_»move_dœeùÜy
(
İts
, 
·th
);

8840 
	`mg_h‰p_£nd_”rÜ
(
nc
, 204, 
NULL
);

8841 } ià(
	`»move
(
·th
) == 0) {

8842 
	`mg_h‰p_£nd_”rÜ
(
nc
, 204, 
NULL
);

8844 
	`mg_h‰p_£nd_”rÜ
(
nc
, 423, 
NULL
);

8846 
	}
}

8849 
	$mg_ü—‹_™”medŸ‹_dœeùÜ›s
(cÚ¡ *
·th
) {

8850 cÚ¡ *
s
;

8853 
s
 = 
·th
 + 1; *s != '\0'; s++) {

8854 ià(*
s
 == '/') {

8855 
buf
[
MAX_PATH_SIZE
];

8856 
cs_¡©_t
 
¡
;

8857 
	`¢´štf
(
buf
, (buf), "%.*s", (è(
s
 - 
·th
),…ath);

8858 
buf
[(buf) - 1] = '\0';

8859 ià(
	`mg_¡©
(
buf
, &
¡
è!ğ0 && 
	`mg_mkdœ
(buf, 0755) != 0) {

8866 
	}
}

8868 
MG_INTERNAL
 
	$mg_hªdË_put
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

8869 
h‰p_mes§ge
 *
hm
) {

8870 
mg_h‰p_´Ùo_d©a
 *
pd
 = 
	`mg_h‰p_g‘_´Ùo_d©a
(
nc
);

8871 
cs_¡©_t
 
¡
;

8872 cÚ¡ 
mg_¡r
 *
ş_hdr
 = 
	`mg_g‘_h‰p_h—d”
(
hm
, "Content-Length");

8873 
rc
, 
¡©us_code
 = 
	`mg_¡©
(
·th
, &
¡
) == 0 ? 200 : 201;

8875 
	`mg_h‰p_ä“_´Ùo_d©a_fe
(&
pd
->
fe
);

8876 ià((
rc
 = 
	`mg_ü—‹_™”medŸ‹_dœeùÜ›s
(
·th
)) == 0) {

8877 
	`mg_´štf
(
nc
, "HTTP/1.1 %d OK\r\nCÚ‹Á-L’gth: 0\r\n\r\n", 
¡©us_code
);

8878 } ià(
rc
 == -1) {

8879 
	`mg_h‰p_£nd_”rÜ
(
nc
, 500, 
NULL
);

8880 } ià(
ş_hdr
 =ğ
NULL
) {

8881 
	`mg_h‰p_£nd_”rÜ
(
nc
, 411, 
NULL
);

8882 } ià((
pd
->
fe
.
å
 = 
	`mg_fİ’
(
·th
, "w+b")è=ğ
NULL
) {

8883 
	`mg_h‰p_£nd_”rÜ
(
nc
, 500, 
NULL
);

8885 cÚ¡ 
mg_¡r
 *
¿nge_hdr
 = 
	`mg_g‘_h‰p_h—d”
(
hm
, "Content-Range");

8886 
št64_t
 
r1
 = 0, 
r2
 = 0;

8887 
pd
->
fe
.
ty³
 = 
DATA_PUT
;

8888 
	`mg_£t_şo£_Ú_exec
((
sock_t
è
	`f’o
(
pd
->
fe
.
å
));

8889 
pd
->
fe
.
ş
 = 
	`to64
(
ş_hdr
->
p
);

8890 ià(
¿nge_hdr
 !ğ
NULL
 &&

8891 
	`mg_h‰p_·r£_¿nge_h—d”
(
¿nge_hdr
, &
r1
, &
r2
) > 0) {

8892 
¡©us_code
 = 206;

8893 
	`f£eko
(
pd
->
fe
.
å
, 
r1
, 
SEEK_SET
);

8894 
pd
->
fe
.
ş
 = 
r2
 > 
r1
 ?„2 -„1 + 1 :…d->file.cl -„1;

8896 
	`mg_´štf
(
nc
, "HTTP/1.1 %d OK\r\nCÚ‹Á-L’gth: 0\r\n\r\n", 
¡©us_code
);

8898 
	`mbuf_»move
(&
nc
->
»cv_mbuf
, 
hm
->
mes§ge
.
Ën
 - hm->
body
.len);

8899 
	`mg_h‰p_Œªsãr_fe_d©a
(
nc
);

8901 
	}
}

8904 #ifdeà
MG_MODULE_LINES


8912 #ià
MG_ENABLE_HTTP
 && 
MG_ENABLE_HTTP_WEBSOCKET


8914 #iâdeà
MG_WEBSOCKET_PING_INTERVAL_SECONDS


8915 
	#MG_WEBSOCKET_PING_INTERVAL_SECONDS
 5

	)

8918 
	#MG_WS_NO_HOST_HEADER_MAGIC
 ((*è0x1)

	)

8920 
	$mg_is_ws_äagm’t
(
æags
) {

8921  (
æags
 & 0x80) == 0 || (flags & 0x0f) == 0;

8922 
	}
}

8924 
	$mg_is_ws_fœ¡_äagm’t
(
æags
) {

8925  (
æags
 & 0x80) == 0 && (flags & 0x0f) != 0;

8926 
	}
}

8928 
	$mg_hªdË_šcomšg_websock‘_äame
(
mg_cÚÃùiÚ
 *
nc
,

8929 
websock‘_mes§ge
 *
wsm
) {

8930 ià(
wsm
->
æags
 & 0x8) {

8931 
	`mg_ÿÎ
(
nc
,‚c->
hªdËr
, 
MG_EV_WEBSOCKET_CONTROL_FRAME
, 
wsm
);

8933 
	`mg_ÿÎ
(
nc
,‚c->
hªdËr
, 
MG_EV_WEBSOCKET_FRAME
, 
wsm
);

8935 
	}
}

8937 
	$mg_d–iv”_websock‘_d©a
(
mg_cÚÃùiÚ
 *
nc
) {

8939 
ušt64_t
 
i
, 
d©a_Ën
 = 0, 
äame_Ën
 = 0, 
buf_Ën
 = 
nc
->
»cv_mbuf
.
Ën
,†en,

8940 
mask_Ën
 = 0, 
h—d”_Ën
 = 0;

8941 *
p
 = (*è
nc
->
»cv_mbuf
.
buf
, *buf =…,

8942 *
e
 = 
p
 + 
buf_Ën
;

8943 *
siz•
 = (*è&
p
[1];

8944 
ok
, 
»ass
 = 
buf_Ën
 > 0 && 
	`mg_is_ws_äagm’t
(
p
[0]) &&

8945 !(
nc
->
æags
 & 
MG_F_WEBSOCKET_NO_DEFRAG
);

8948 ià(
»ass
 && !
	`mg_is_ws_fœ¡_äagm’t
(
p
[0]) &&

8949 
buf_Ën
 >ğ1 + (*
siz•
) && buf_len >= 1 + (*sizep) + *sizep) {

8950 
buf
 +ğ1 + (*
siz•
) + *sizep;

8951 
buf_Ën
 -ğ1 + (*
siz•
) + *sizep;

8954 ià(
buf_Ën
 >= 2) {

8955 
Ën
 = 
buf
[1] & 127;

8956 
mask_Ën
 = 
buf
[1] & 128 ? 4 : 0;

8957 ià(
Ën
 < 126 && 
buf_Ën
 >ğ
mask_Ën
) {

8958 
d©a_Ën
 = 
Ën
;

8959 
h—d”_Ën
 = 2 + 
mask_Ën
;

8960 } ià(
Ën
 =ğ126 && 
buf_Ën
 >ğ4 + 
mask_Ën
) {

8961 
h—d”_Ën
 = 4 + 
mask_Ën
;

8962 
d©a_Ën
 = 
	`Áohs
(*(
ušt16_t
 *è&
buf
[2]);

8963 } ià(
buf_Ën
 >ğ10 + 
mask_Ën
) {

8964 
h—d”_Ën
 = 10 + 
mask_Ën
;

8965 
d©a_Ën
 = (((
ušt64_t
è
	`Áohl
(*(
ušt32_t
 *è&
buf
[2])) << 32) +

8966 
	`Áohl
(*(
ušt32_t
 *è&
buf
[6]);

8970 
äame_Ën
 = 
h—d”_Ën
 + 
d©a_Ën
;

8971 
ok
 = 
äame_Ën
 > 0 && f¿me_ËÀ<ğ
buf_Ën
;

8973 ià(
ok
) {

8974 
websock‘_mes§ge
 
wsm
;

8976 
wsm
.
size
 = (
size_t
è
d©a_Ën
;

8977 
wsm
.
d©a
 = 
buf
 + 
h—d”_Ën
;

8978 
wsm
.
æags
 = 
buf
[0];

8981 ià(
mask_Ën
 > 0) {

8982 
i
 = 0; i < 
d©a_Ën
; i++) {

8983 
buf
[
i
 + 
h—d”_Ën
] ^ğ(buà+ h—d”_ËÀ- 
mask_Ën
)[i % 4];

8987 ià(
»ass
) {

8989 ià(
	`mg_is_ws_fœ¡_äagm’t
(
wsm
.
æags
)) {

8990 
	`mbuf_»size
(&
nc
->
»cv_mbuf
,‚c->»cv_mbuf.
size
 + (*
siz•
));

8991 
p
[0] &= ~0x0f;

8992 
buf
 = 
p
 + 1 + (*
siz•
);

8993 *
siz•
 = 0;

8997 
	`memmove
(
buf
, 
wsm
.
d©a
, 
e
 - wsm.data);

8998 (*
siz•
è+ğ
wsm
.
size
;

8999 
nc
->
»cv_mbuf
.
Ën
 -ğ
wsm
.
d©a
 - 
buf
;

9002 ià(
wsm
.
æags
 & 0x80) {

9003 
wsm
.
d©a
 = 
p
 + 1 + (*
siz•
);

9004 
wsm
.
size
 = *
siz•
;

9005 
	`mg_hªdË_šcomšg_websock‘_äame
(
nc
, &
wsm
);

9006 
	`mbuf_»move
(&
nc
->
»cv_mbuf
, 1 + (*
siz•
) + *sizep);

9010 
	`mg_hªdË_šcomšg_websock‘_äame
(
nc
, &
wsm
);

9011 
	`mbuf_»move
(&
nc
->
»cv_mbuf
, (
size_t
è
äame_Ën
);

9015 ià((
buf
[0] & 0x0fè=ğ
WEBSOCKET_OP_CLOSE
) {

9016 
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

9020  
ok
;

9021 
	}
}

9023 
	sws_mask_ùx
 {

9024 
size_t
 
	mpos
;

9025 
ušt32_t
 
	mmask
;

9028 
ušt32_t
 
	$mg_ws_¿ndom_mask
() {

9029 
ušt32_t
 
mask
;

9044 #ià
MG_DISABLE_WS_RANDOM_MASK


9045 
mask
 = 0xefbeadde;

9048 
mask
 = (
ušt32_t
è
	`¿nd
();

9050 
mask
 = (
ušt32_t
è
	`¿nd
() << 16 | (uint32_t)„and();

9053  
mask
;

9054 
	}
}

9056 
	$mg_£nd_ws_h—d”
(
mg_cÚÃùiÚ
 *
nc
, 
İ
, 
size_t
 
Ën
,

9057 
ws_mask_ùx
 *
ùx
) {

9058 
h—d”_Ën
;

9059 
h—d”
[10];

9061 
h—d”
[0] = (
İ
 & 
WEBSOCKET_DONT_FIN
 ? 0x0 : 0x80) + (op & 0x0f);

9062 ià(
Ën
 < 126) {

9063 
h—d”
[1] = (è
Ën
;

9064 
h—d”_Ën
 = 2;

9065 } ià(
Ën
 < 65535) {

9066 
ušt16_t
 
tmp
 = 
	`htÚs
((ušt16_tè
Ën
);

9067 
h—d”
[1] = 126;

9068 
	`memıy
(&
h—d”
[2], &
tmp
, (tmp));

9069 
h—d”_Ën
 = 4;

9071 
ušt32_t
 
tmp
;

9072 
h—d”
[1] = 127;

9073 
tmp
 = 
	`htÚl
((
ušt32_t
)((
ušt64_t
è
Ën
 >> 32));

9074 
	`memıy
(&
h—d”
[2], &
tmp
, (tmp));

9075 
tmp
 = 
	`htÚl
((
ušt32_t
)(
Ën
 & 0xffffffff));

9076 
	`memıy
(&
h—d”
[6], &
tmp
, (tmp));

9077 
h—d”_Ën
 = 10;

9081 ià(
nc
->
li¡’”
 =ğ
NULL
) {

9082 
h—d”
[1] |= 1 << 7;

9083 
	`mg_£nd
(
nc
, 
h—d”
, 
h—d”_Ën
);

9084 
ùx
->
mask
 = 
	`mg_ws_¿ndom_mask
();

9085 
	`mg_£nd
(
nc
, &
ùx
->
mask
, (ctx->mask));

9086 
ùx
->
pos
 = 
nc
->
£nd_mbuf
.
Ën
;

9088 
	`mg_£nd
(
nc
, 
h—d”
, 
h—d”_Ën
);

9089 
ùx
->
pos
 = 0;

9091 
	}
}

9093 
	$mg_ws_mask_äame
(
mbuf
 *mbuf, 
ws_mask_ùx
 *
ùx
) {

9094 
size_t
 
i
;

9095 ià(
ùx
->
pos
 == 0) ;

9096 
i
 = 0; i < (
mbuf
->
Ën
 - 
ùx
->
pos
); i++) {

9097 
mbuf
->
buf
[
ùx
->
pos
 + 
i
] ^ğ((*è&ùx->
mask
)[i % 4];

9099 
	}
}

9101 
	$mg_£nd_websock‘_äame
(
mg_cÚÃùiÚ
 *
nc
, 
İ
, cÚ¡ *
d©a
,

9102 
size_t
 
Ën
) {

9103 
ws_mask_ùx
 
ùx
;

9104 
	`DBG
(("%°%d %d", 
nc
, 
İ
, (è
Ën
));

9105 
	`mg_£nd_ws_h—d”
(
nc
, 
İ
, 
Ën
, &
ùx
);

9106 
	`mg_£nd
(
nc
, 
d©a
, 
Ën
);

9108 
	`mg_ws_mask_äame
(&
nc
->
£nd_mbuf
, &
ùx
);

9110 ià(
İ
 =ğ
WEBSOCKET_OP_CLOSE
) {

9111 
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

9113 
	}
}

9115 
	$mg_£nd_websock‘_äamev
(
mg_cÚÃùiÚ
 *
nc
, 
İ
,

9116 cÚ¡ 
mg_¡r
 *
¡rv
, 
¡rvút
) {

9117 
ws_mask_ùx
 
ùx
;

9118 
i
;

9119 
Ën
 = 0;

9120 
i
 = 0; i < 
¡rvút
; i++) {

9121 
Ën
 +ğ
¡rv
[
i
].len;

9124 
	`mg_£nd_ws_h—d”
(
nc
, 
İ
, 
Ën
, &
ùx
);

9126 
i
 = 0; i < 
¡rvút
; i++) {

9127 
	`mg_£nd
(
nc
, 
¡rv
[
i
].
p
, sŒv[i].
Ën
);

9130 
	`mg_ws_mask_äame
(&
nc
->
£nd_mbuf
, &
ùx
);

9132 ià(
İ
 =ğ
WEBSOCKET_OP_CLOSE
) {

9133 
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

9135 
	}
}

9137 
	$mg_´štf_websock‘_äame
(
mg_cÚÃùiÚ
 *
nc
, 
İ
,

9138 cÚ¡ *
fmt
, ...) {

9139 
mem
[
MG_VPRINTF_BUFFER_SIZE
], *
buf
 = mem;

9140 
va_li¡
 
­
;

9141 
Ën
;

9143 
	`va_¡¬t
(
­
, 
fmt
);

9144 ià((
Ën
 = 
	`mg_av´štf
(&
buf
, (
mem
), 
fmt
, 
­
)) > 0) {

9145 
	`mg_£nd_websock‘_äame
(
nc
, 
İ
, 
buf
, 
Ën
);

9147 
	`va_’d
(
­
);

9149 ià(
buf
 !ğ
mem
 && buà!ğ
NULL
) {

9150 
	`MG_FREE
(
buf
);

9152 
	}
}

9154 
MG_INTERNAL
 
	$mg_ws_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
,

9155 *
ev_d©a
) {

9156 
	`mg_ÿÎ
(
nc
,‚c->
hªdËr
, 
ev
, 
ev_d©a
);

9158 
ev
) {

9159 
MG_EV_RECV
:

9161 } 
	`mg_d–iv”_websock‘_d©a
(
nc
));

9163 
MG_EV_POLL
:

9166 
time_t
 
now
 = *Ñime_ˆ*è
ev_d©a
;

9167 ià(
nc
->
æags
 & 
MG_F_IS_WEBSOCKET
 &&

9168 
now
 > 
nc
->
Ï¡_io_time
 + 
MG_WEBSOCKET_PING_INTERVAL_SECONDS
) {

9169 
	`mg_£nd_websock‘_äame
(
nc
, 
WEBSOCKET_OP_PING
, "", 0);

9176 
	}
}

9178 #iâdeà
MG_EXT_SHA1


9179 
	$mg_hash_sha1_v
(
size_t
 
num_msgs
, cÚ¡ 
ušt8_t
 *
msgs
[],

9180 cÚ¡ 
size_t
 *
msg_Ëns
, 
ušt8_t
 *
dige¡
) {

9181 
size_t
 
i
;

9182 
cs_sha1_ùx
 
sha_ùx
;

9183 
	`cs_sha1_š™
(&
sha_ùx
);

9184 
i
 = 0; i < 
num_msgs
; i++) {

9185 
	`cs_sha1_upd©e
(&
sha_ùx
, 
msgs
[
i
], 
msg_Ëns
[i]);

9187 
	`cs_sha1_fš®
(
dige¡
, &
sha_ùx
);

9188 
	}
}

9190 
mg_hash_sha1_v
(
size_t
 
num_msgs
, cÚ¡ 
ušt8_t
 *
msgs
[],

9191 cÚ¡ 
size_t
 *
msg_Ëns
, 
ušt8_t
 *
dige¡
);

9194 
MG_INTERNAL
 
	$mg_ws_hªdshake
(
mg_cÚÃùiÚ
 *
nc
,

9195 cÚ¡ 
mg_¡r
 *
key
) {

9196 cÚ¡ *
magic
 = "258EAFA5-E914-47DA-95CA-C5AB0DC85B11";

9197 cÚ¡ 
ušt8_t
 *
msgs
[2] = {(cÚ¡ ušt8_ˆ*è
key
->
p
, (cÚ¡ ušt8_ˆ*è
magic
};

9198 cÚ¡ 
size_t
 
msg_Ëns
[2] = {
key
->
Ën
, 36};

9199 
sha
[20];

9200 
b64_sha
[30];

9202 
	`mg_hash_sha1_v
(2, 
msgs
, 
msg_Ëns
, 
sha
);

9203 
	`mg_ba£64_’code
(
sha
, (sha), 
b64_sha
);

9204 
	`mg_´štf
(
nc
, "%s%s%s",

9209 
b64_sha
, "\r\n\r\n");

9210 
	`DBG
(("%°%.* %s", 
nc
, (è
key
->
Ën
, key->
p
, 
b64_sha
));

9211 
	}
}

9213 
	$mg_£nd_websock‘_hªdshake2
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

9214 cÚ¡ *
ho¡
, cÚ¡ *
´ÙocŞ
,

9215 cÚ¡ *
exŒa_h—d”s
) {

9216 
	`mg_£nd_websock‘_hªdshake3
(
nc
, 
·th
, 
ho¡
, 
´ÙocŞ
, 
exŒa_h—d”s
, 
NULL
,

9217 
NULL
);

9218 
	}
}

9220 
	$mg_£nd_websock‘_hªdshake3
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

9221 cÚ¡ *
ho¡
, cÚ¡ *
´ÙocŞ
,

9222 cÚ¡ *
exŒa_h—d”s
, cÚ¡ *
u£r
,

9223 cÚ¡ *
·ss
) {

9224 
mbuf
 
auth
;

9225 
key
[25];

9226 
ušt32_t
 
nÚû
[4];

9227 
nÚû
[0] = 
	`mg_ws_¿ndom_mask
();

9228 
nÚû
[1] = 
	`mg_ws_¿ndom_mask
();

9229 
nÚû
[2] = 
	`mg_ws_¿ndom_mask
();

9230 
nÚû
[3] = 
	`mg_ws_¿ndom_mask
();

9231 
	`mg_ba£64_’code
((*è&
nÚû
, ÒÚû), 
key
);

9233 
	`mbuf_š™
(&
auth
, 0);

9234 ià(
u£r
 !ğ
NULL
) {

9235 
	`mg_basic_auth_h—d”
(
u£r
, 
·ss
, &
auth
);

9244 
	`mg_´štf
(
nc
,

9251 
·th
, (è
auth
.
Ën
, (auth.
buf
 =ğ
NULL
 ? "" :‡uth.buf), 
key
);

9254 ià(
ho¡
 !ğ
MG_WS_NO_HOST_HEADER_MAGIC
) {

9255 
	`mg_´štf
(
nc
, "Ho¡: %s\r\n", 
ho¡
);

9257 ià(
´ÙocŞ
 !ğ
NULL
) {

9258 
	`mg_´štf
(
nc
, "Sec-WebSock‘-PrÙocŞ: %s\r\n", 
´ÙocŞ
);

9260 ià(
exŒa_h—d”s
 !ğ
NULL
) {

9261 
	`mg_´štf
(
nc
, "%s", 
exŒa_h—d”s
);

9263 
	`mg_´štf
(
nc
, "\r\n");

9265 
	`mbuf_ä“
(&
auth
);

9266 
	}
}

9268 
	$mg_£nd_websock‘_hªdshake
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

9269 cÚ¡ *
exŒa_h—d”s
) {

9270 
	`mg_£nd_websock‘_hªdshake2
(
nc
, 
·th
, 
MG_WS_NO_HOST_HEADER_MAGIC
, 
NULL
,

9271 
exŒa_h—d”s
);

9272 
	}
}

9274 
mg_cÚÃùiÚ
 *
	$mg_cÚÃù_ws_İt
(
mg_mgr
 *
mgr
,

9275 
mg_ev’t_hªdËr_t
 
ev_hªdËr
,

9276 
mg_cÚÃù_İts
 
İts
,

9277 cÚ¡ *
u¾
, cÚ¡ *
´ÙocŞ
,

9278 cÚ¡ *
exŒa_h—d”s
) {

9279 *
u£r
 = 
NULL
, *
·ss
 = NULL, *
addr
 = NULL;

9280 cÚ¡ *
·th
 = 
NULL
;

9281 
mg_cÚÃùiÚ
 *
nc
 =

9282 
	`mg_cÚÃù_h‰p_ba£
(
mgr
, 
ev_hªdËr
, 
İts
, "ws://", "wss://", 
u¾
, &
·th
,

9283 &
u£r
, &
·ss
, &
addr
);

9285 ià(
nc
 !ğ
NULL
) {

9286 
	`mg_£nd_websock‘_hªdshake3
(
nc
, 
·th
, 
addr
, 
´ÙocŞ
, 
exŒa_h—d”s
, 
u£r
,

9287 
·ss
);

9290 
	`MG_FREE
(
addr
);

9291 
	`MG_FREE
(
u£r
);

9292 
	`MG_FREE
(
·ss
);

9293  
nc
;

9294 
	}
}

9296 
mg_cÚÃùiÚ
 *
	$mg_cÚÃù_ws
(
mg_mgr
 *
mgr
,

9297 
mg_ev’t_hªdËr_t
 
ev_hªdËr
,

9298 cÚ¡ *
u¾
, cÚ¡ *
´ÙocŞ
,

9299 cÚ¡ *
exŒa_h—d”s
) {

9300 
mg_cÚÃù_İts
 
İts
;

9301 
	`mem£t
(&
İts
, 0, (opts));

9302  
	`mg_cÚÃù_ws_İt
(
mgr
, 
ev_hªdËr
, 
İts
, 
u¾
, 
´ÙocŞ
, 
exŒa_h—d”s
);

9303 
	}
}

9305 #ifdeà
MG_MODULE_LINES


9318 #iâdeà
MAX


9319 
	#MAX
(
a
, 
b
è(×è> (bè? (aè: (b))

	)

9322 cÚ¡ *
	$mg_sk
(cÚ¡ *
s
, cÚ¡ *
’d
, cÚ¡ *
d–ims
,

9323 
mg_¡r
 *
v
) {

9324 
v
->
p
 = 
s
;

9325 
s
 < 
’d
 && 
	`¡rchr
(
d–ims
, *(*èsè=ğ
NULL
) s++;

9326 
v
->
Ën
 = 
s
 - v->
p
;

9327 
s
 < 
’d
 && 
	`¡rchr
(
d–ims
, *(*èsè!ğ
NULL
) s++;

9328  
s
;

9329 
	}
}

9331 
	$low”ÿ£
(cÚ¡ *
s
) {

9332  
	`tŞow”
(*(cÚ¡ *è
s
);

9333 
	}
}

9335 #ià
MG_ENABLE_FILESYSTEM


9336 
	$mg_¡©
(cÚ¡ *
·th
, 
cs_¡©_t
 *
¡
) {

9337 #ifdeà
_WIN32


9338 
wch¬_t
 
w·th
[
MAX_PATH_SIZE
];

9339 
	`to_wch¬
(
·th
, 
w·th
, 
	`ARRAY_SIZE
(wpath));

9340 
	`DBG
(("[%ls] -> %d", 
w·th
, 
	`_w¡©i64
(w·th, 
¡
)));

9341  
	`_w¡©i64
(
w·th
, 
¡
);

9343  
	`¡©
(
·th
, 
¡
);

9345 
	}
}

9347 
FILE
 *
	$mg_fİ’
(cÚ¡ *
·th
, cÚ¡ *
mode
) {

9348 #ifdeà
_WIN32


9354  
	`fİ’
(
·th
, 
mode
);

9356  
	`fİ’
(
·th
, 
mode
);

9358 
	}
}

9360 
	$mg_İ’
(cÚ¡ *
·th
, 
æag
, 
mode
) {

9361 #ià
	`defšed
(
_WIN32
è&& !defšed(
WINCE
)

9362 
wch¬_t
 
w·th
[
MAX_PATH_SIZE
];

9363 
	`to_wch¬
(
·th
, 
w·th
, 
	`ARRAY_SIZE
(wpath));

9364  
	`_wİ’
(
w·th
, 
æag
, 
mode
);

9366  
	`İ’
(
·th
, 
æag
, 
mode
);

9368 
	}
}

9371 
	$mg_ba£64_’code
(cÚ¡ *
¤c
, 
¤c_Ën
, *
d¡
) {

9372 
	`cs_ba£64_’code
(
¤c
, 
¤c_Ën
, 
d¡
);

9373 
	}
}

9375 
	$mg_ba£64_decode
(cÚ¡ *
s
, 
Ën
, *
d¡
) {

9376  
	`cs_ba£64_decode
(
s
, 
Ën
, 
d¡
, 
NULL
);

9377 
	}
}

9379 #ià
MG_ENABLE_THREADS


9380 *
mg_¡¬t_th»ad
(*(*
f
)(*), *
p
) {

9381 #ifdeà
WINCE


9382  (*è
C»©eTh»ad
(
NULL
, 0, (
LPTHREAD_START_ROUTINE
è
f
, 
p
, 0, NULL);

9383 #–ià
defšed
(
_WIN32
)

9384  (*è
_begšth»ad
(((
__cdeş
 *è(*èè
f
, 0, 
p
);

9386 
±h»ad_t
 
	gth»ad_id
 = (pthread_t) 0;

9387 
±h»ad_©Œ_t
 
	g©Œ
;

9389 (è
±h»ad_©Œ_š™
(&
©Œ
);

9390 (è
±h»ad_©Œ_£td‘ach¡©e
(&
©Œ
, 
PTHREAD_CREATE_DETACHED
);

9392 #ià
defšed
(
MG_STACK_SIZE
) && MG_STACK_SIZE > 1

9393 (è
±h»ad_©Œ_£t¡acksize
(&
©Œ
, 
MG_STACK_SIZE
);

9396 
±h»ad_ü—‹
(&
th»ad_id
, &
©Œ
, 
f
, 
p
);

9397 
±h»ad_©Œ_de¡roy
(&
©Œ
);

9399  (*è
	gth»ad_id
;

9405 
	$mg_£t_şo£_Ú_exec
(
sock_t
 
sock
) {

9406 #ià
	`defšed
(
_WIN32
è&& !defšed(
WINCE
)

9407 (è
	`S‘HªdËInfÜm©iÚ
((
HANDLE
è
sock
, 
HANDLE_FLAG_INHERIT
, 0);

9408 #–ià
	`defšed
(
__unix__
)

9409 
	`fú
(
sock
, 
F_SETFD
, 
FD_CLOEXEC
);

9411 (è
sock
;

9413 
	}
}

9415 
	$mg_sock_addr_to_¡r
(cÚ¡ 
sock‘_add»ss
 *
§
, *
buf
, 
size_t
 
Ën
,

9416 
æags
) {

9417 
is_v6
;

9418 ià(
buf
 =ğ
NULL
 || 
Ën
 <= 0) ;

9419 
	`mem£t
(
buf
, 0, 
Ën
);

9420 #ià
MG_ENABLE_IPV6


9421 
is_v6
 = 
§
->§.
§_çmy
 =ğ
AF_INET6
;

9423 
is_v6
 = 0;

9425 ià(
æags
 & 
MG_SOCK_STRINGIFY_IP
) {

9426 #ià
MG_ENABLE_IPV6


9427 cÚ¡ *
addr
 = 
NULL
;

9428 *
¡¬t
 = 
buf
;

9429 
sockËn_t
 
ÿ·c™y
 = 
Ën
;

9430 ià(!
is_v6
) {

9431 
addr
 = &
§
->
sš
.
sš_addr
;

9433 
addr
 = (*è&
§
->
sš6
.
sš6_addr
;

9434 ià(
æags
 & 
MG_SOCK_STRINGIFY_PORT
) {

9435 *
buf
 = '[';

9436 
¡¬t
++;

9437 
ÿ·c™y
--;

9440 ià(
	`š‘_Áİ
(
§
->§.
§_çmy
, 
addr
, 
¡¬t
, 
ÿ·c™y
è=ğ
NULL
) {

9441 
ş—nup
;

9443 #–ià
	`defšed
(
_WIN32
è|| 
MG_LWIP
 || (
MG_NET_IF
 =ğ
MG_NET_IF_PIC32
)

9445 *
addr_¡r
 = 
	`š‘_Áß
(
§
->
sš
.
sš_addr
);

9446 ià(
addr_¡r
 !ğ
NULL
) {

9447 
	`¡ºıy
(
buf
, 
	`š‘_Áß
(
§
->
sš
.
sš_addr
), 
Ën
 - 1);

9449 
ş—nup
;

9452 ià(
	`š‘_Áİ
(
AF_INET
, (*è&
§
->
sš
.
sš_addr
, 
buf
, 
Ën
 - 1è=ğ
NULL
) {

9453 
ş—nup
;

9457 ià(
æags
 & 
MG_SOCK_STRINGIFY_PORT
) {

9458 
pÜt
 = 
	`Áohs
(
§
->
sš
.
sš_pÜt
);

9459 ià(
æags
 & 
MG_SOCK_STRINGIFY_IP
) {

9460 
buf_Ën
 = 
	`¡¾’
(
buf
);

9461 
	`¢´štf
(
buf
 + 
buf_Ën
, 
Ën
 - (buf_ËÀ+ 1), "%s:%d", (
is_v6
 ? "]" : ""),

9462 
pÜt
);

9464 
	`¢´štf
(
buf
, 
Ën
, "%d", 
pÜt
);

9470 
ş—nup
:

9471 *
buf
 = '\0';

9472 
	}
}

9474 
	$mg_cÚn_addr_to_¡r
(
mg_cÚÃùiÚ
 *
nc
, *
buf
, 
size_t
 
Ën
,

9475 
æags
) {

9476 
sock‘_add»ss
 
§
;

9477 
	`mem£t
(&
§
, 0, (sa));

9478 
	`mg_if_g‘_cÚn_addr
(
nc
, 
æags
 & 
MG_SOCK_STRINGIFY_REMOTE
, &
§
);

9479 
	`mg_sock_addr_to_¡r
(&
§
, 
buf
, 
Ën
, 
æags
);

9480 
	}
}

9482 #ià
MG_ENABLE_HEXDUMP


9483 
	$mg_hexdump_n
(cÚ¡ *
buf
, 
Ën
, *
d¡
, 
d¡_Ën
,

9484 
off£t
) {

9485 cÚ¡ *
p
 = (cÚ¡ *è
buf
;

9486 
ascii
[17] = "";

9487 
i
, 
idx
, 
n
 = 0;

9489 
i
 = 0; i < 
Ën
; i++) {

9490 
idx
 = 
i
 % 16;

9491 ià(
idx
 == 0) {

9492 ià(
i
 > 0è
n
 +ğ
	`¢´štf
(
d¡
 +‚, 
	`MAX
(
d¡_Ën
 -‚, 0), " %s\n", 
ascii
);

9493 
n
 +ğ
	`¢´štf
(
d¡
 +‚, 
	`MAX
(
d¡_Ën
 -‚, 0), "%04x ", 
i
 + 
off£t
);

9495 ià(
d¡_Ën
 - 
n
 < 0) {

9496  
n
;

9498 
n
 +ğ
	`¢´štf
(
d¡
 +‚, 
	`MAX
(
d¡_Ën
 -‚, 0), " %02x", 
p
[
i
]);

9499 
ascii
[
idx
] = 
p
[
i
] < 0x20 ||…[i] > 0x7e ? '.' :…[i];

9500 
ascii
[
idx
 + 1] = '\0';

9503 
i
++ % 16è
n
 +ğ
	`¢´štf
(
d¡
 +‚, 
	`MAX
(
d¡_Ën
 -‚, 0), "%s", " ");

9504 
n
 +ğ
	`¢´štf
(
d¡
 +‚, 
	`MAX
(
d¡_Ën
 -‚, 0), " %s\n", 
ascii
);

9506  
n
;

9507 
	}
}

9509 
	$mg_hexdump
(cÚ¡ *
buf
, 
Ën
, *
d¡
, 
d¡_Ën
) {

9510  
	`mg_hexdump_n
(
buf
, 
Ën
, 
d¡
, 
d¡_Ën
, 0);

9511 
	}
}

9513 
	$mg_hexdumpf
(
FILE
 *
å
, cÚ¡ *
buf
, 
Ën
) {

9514 
tmp
[80];

9515 
off£t
 = 0, 
n
;

9516 
Ën
 > 0) {

9517 
n
 = (
Ën
 < 16 ?†en : 16);

9518 
	`mg_hexdump_n
(((cÚ¡ *è
buf
è+ 
off£t
, 
n
, 
tmp
, (tmp), offset);

9519 
	`åuts
(
tmp
, 
å
);

9520 
off£t
 +ğ
n
;

9521 
Ën
 -ğ
n
;

9523 
	}
}

9525 
	$mg_hexdump_cÚÃùiÚ
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

9526 cÚ¡ *
buf
, 
num_by‹s
, 
ev
) {

9527 
FILE
 *
å
 = 
NULL
;

9528 *
hexbuf
, 
¤c
[60], 
d¡
[60];

9529 
buf_size
 = 
num_by‹s
 * 5 + 100;

9531 ià(
	`¡rcmp
(
·th
, "-") == 0) {

9532 
å
 = 
¡dout
;

9533 } ià(
	`¡rcmp
(
·th
, "--") == 0) {

9534 
å
 = 
¡d”r
;

9535 #ià
MG_ENABLE_FILESYSTEM


9537 
å
 = 
	`mg_fİ’
(
·th
, "a");

9540 ià(
å
 =ğ
NULL
) ;

9542 
	`mg_cÚn_addr_to_¡r
(
nc
, 
¤c
, (src),

9543 
MG_SOCK_STRINGIFY_IP
 | 
MG_SOCK_STRINGIFY_PORT
);

9544 
	`mg_cÚn_addr_to_¡r
(
nc
, 
d¡
, (d¡), 
MG_SOCK_STRINGIFY_IP
 |

9545 
MG_SOCK_STRINGIFY_PORT
 |

9546 
MG_SOCK_STRINGIFY_REMOTE
);

9547 
	`årštf
(

9548 
å
, "%lu %°% % % %d\n", (è
	`mg_time
(), (*è
nc
, 
¤c
,

9549 
ev
 =ğ
MG_EV_RECV
 ? "<-" :ƒv =ğ
MG_EV_SEND


9551 : 
ev
 =ğ
MG_EV_ACCEPT


9553 : 
ev
 =ğ
MG_EV_CONNECT
 ? "C>" : "XX",

9554 
d¡
, 
num_by‹s
);

9555 ià(
num_by‹s
 > 0 && (
hexbuf
 = (*è
	`MG_MALLOC
(
buf_size
)è!ğ
NULL
) {

9556 
	`mg_hexdump
(
buf
, 
num_by‹s
, 
hexbuf
, 
buf_size
);

9557 
	`årštf
(
å
, "%s", 
hexbuf
);

9558 
	`MG_FREE
(
hexbuf
);

9560 ià(
å
 !ğ
¡dš
 && f°!ğ
¡dout
è
	`fşo£
(fp);

9561 
	}
}

9564 
	$mg_is_big_’dŸn
() {

9565 cÚ¡ 
n
 = 1;

9567  ((*è&
n
)[0] == 0;

9568 
	}
}

9570 cÚ¡ *
	$mg_Ãxt_comma_li¡_’Œy
(cÚ¡ *
li¡
, 
mg_¡r
 *
v®
,

9571 
mg_¡r
 *
eq_v®
) {

9572 ià(
li¡
 =ğ
NULL
 || *list == '\0') {

9574 
li¡
 = 
NULL
;

9576 
v®
->
p
 = 
li¡
;

9577 ià((
li¡
 = 
	`¡rchr
(
v®
->
p
, ',')è!ğ
NULL
) {

9579 
v®
->
Ën
 = 
li¡
 - v®->
p
;

9580 
li¡
++;

9583 
li¡
 = 
v®
->
p
 + 
	`¡¾’
(val->p);

9584 
v®
->
Ën
 = 
li¡
 - v®->
p
;

9587 ià(
eq_v®
 !ğ
NULL
) {

9590 
eq_v®
->
Ën
 = 0;

9591 
eq_v®
->
p
 = (cÚ¡ *è
	`memchr
(
v®
->p, '=', v®->
Ën
);

9592 ià(
eq_v®
->
p
 !ğ
NULL
) {

9593 
eq_v®
->
p
++;

9594 
eq_v®
->
Ën
 = 
v®
->
p
 + val->len -ƒq_val->p;

9595 
v®
->
Ën
 = (
eq_v®
->
p
 - val->p) - 1;

9600  
li¡
;

9601 
	}
}

9603 
	$mg_m©ch_´efix_n
(cÚ¡ 
mg_¡r
 
·‰”n
, cÚ¡ mg_¡¸
¡r
) {

9604 cÚ¡ *
Ü_¡r
;

9605 
size_t
 
Ën
, 
i
 = 0, 
j
 = 0;

9606 
»s
;

9608 ià((
Ü_¡r
 = (cÚ¡ *è
	`memchr
(
·‰”n
.
p
, '|',…©‹º.
Ën
)è!ğ
NULL
) {

9609 
mg_¡r
 
p¡r
 = {
·‰”n
.
p
, (
size_t
)(
Ü_¡r
 -…attern.p)};

9610 
»s
 = 
	`mg_m©ch_´efix_n
(
p¡r
, 
¡r
);

9611 ià(
»s
 > 0) „es;

9612 
p¡r
.
p
 = 
Ü_¡r
 + 1;

9613 
p¡r
.
Ën
 = (
·‰”n
.
p
 +…©‹º.Ënè- (
Ü_¡r
 + 1);

9614  
	`mg_m©ch_´efix_n
(
p¡r
, 
¡r
);

9617 ; 
i
 < 
·‰”n
.
Ën
; i++, 
j
++) {

9618 ià(
·‰”n
.
p
[
i
] =ğ'?' && 
j
 !ğ
¡r
.
Ën
) {

9620 } ià(
·‰”n
.
p
[
i
] == '$') {

9621  
j
 =ğ
¡r
.
Ën
 ? () j : -1;

9622 } ià(
·‰”n
.
p
[
i
] == '*') {

9623 
i
++;

9624 ià(
·‰”n
.
p
[
i
] == '*') {

9625 
i
++;

9626 
Ën
 = 
¡r
.ËÀ- 
j
;

9628 
Ën
 = 0;

9629 
j
 + 
Ën
 !ğ
¡r
.ËÀ&& sŒ.
p
[j +†en] != '/') {

9630 
Ën
++;

9633 ià(
i
 =ğ
·‰”n
.
Ën
) {

9634  
j
 + 
Ën
;

9637 cÚ¡ 
mg_¡r
 
p¡r
 = {
·‰”n
.
p
 + 
i
,…©‹º.
Ën
 - i};

9638 cÚ¡ 
mg_¡r
 
s¡r
 = {
¡r
.
p
 + 
j
 + 
Ën
, str.len - j -†en};

9639 
»s
 = 
	`mg_m©ch_´efix_n
(
p¡r
, 
s¡r
);

9640 } 
»s
 =ğ-1 && 
Ën
-- > 0);

9641  
»s
 =ğ-1 ? -1 : (è(
j
 +„e + 
Ën
);

9642 } ià(
	`low”ÿ£
(&
·‰”n
.
p
[
i
]è!ğlow”ÿ£(&
¡r
.p[
j
])) {

9646  
j
;

9647 
	}
}

9649 
	$mg_m©ch_´efix
(cÚ¡ *
·‰”n
, 
·‰”n_Ën
, cÚ¡ *
¡r
) {

9650 cÚ¡ 
mg_¡r
 
p¡r
 = {
·‰”n
, (
size_t
è
·‰”n_Ën
};

9651  
	`mg_m©ch_´efix_n
(
p¡r
, 
	`mg_mk_¡r
(
¡r
));

9652 
	}
}

9654 
DO_NOT_WARN_UNUSED
 
MG_INTERNAL
 
	$mg_g‘_”ºo
() {

9655 #iâdeà
WINCE


9656  
”ºo
;

9659  
	`G‘La¡E¼Ü
();

9661 
	}
}

9663 
	$mg_mbuf_­³nd_ba£64_putc
(
ch
, *
u£r_d©a
) {

9664 
mbuf
 *mbuàğ(mbuà*è
u£r_d©a
;

9665 
	`mbuf_­³nd
(
mbuf
, &
ch
, (ch));

9666 
	}
}

9668 
	$mg_mbuf_­³nd_ba£64
(
mbuf
 *mbuf, cÚ¡ *
d©a
, 
size_t
 
Ën
) {

9669 
cs_ba£64_ùx
 
ùx
;

9670 
	`cs_ba£64_š™
(&
ùx
, 
mg_mbuf_­³nd_ba£64_putc
, 
mbuf
);

9671 
	`cs_ba£64_upd©e
(&
ùx
, (cÚ¡ *è
d©a
, 
Ën
);

9672 
	`cs_ba£64_fšish
(&
ùx
);

9673 
	}
}

9675 
	$mg_basic_auth_h—d”
(cÚ¡ *
u£r
, cÚ¡ *
·ss
,

9676 
mbuf
 *
buf
) {

9677 cÚ¡ *
h—d”_´efix
 = "Authorization: Basic ";

9678 cÚ¡ *
h—d”_suffix
 = "\r\n";

9680 
cs_ba£64_ùx
 
ùx
;

9681 
	`cs_ba£64_š™
(&
ùx
, 
mg_mbuf_­³nd_ba£64_putc
, 
buf
);

9683 
	`mbuf_­³nd
(
buf
, 
h—d”_´efix
, 
	`¡¾’
(header_prefix));

9685 
	`cs_ba£64_upd©e
(&
ùx
, 
u£r
, 
	`¡¾’
(user));

9686 ià(
·ss
 !ğ
NULL
) {

9687 
	`cs_ba£64_upd©e
(&
ùx
, ":", 1);

9688 
	`cs_ba£64_upd©e
(&
ùx
, 
·ss
, 
	`¡¾’
(pass));

9690 
	`cs_ba£64_fšish
(&
ùx
);

9691 
	`mbuf_­³nd
(
buf
, 
h—d”_suffix
, 
	`¡¾’
(header_suffix));

9692 
	}
}

9693 #ifdeà
MG_MODULE_LINES


9701 #ià
MG_ENABLE_MQTT


9703 
	~<¡ršg.h
>

9708 
ušt16_t
 
	$g‘u16
(cÚ¡ *
p
) {

9709 cÚ¡ 
ušt8_t
 *
up
 = (cÚ¡ ušt8_ˆ*è
p
;

9710  (
up
[0] << 8) + up[1];

9711 
	}
}

9713 cÚ¡ *
	$sÿÁo
(cÚ¡ *
p
, 
mg_¡r
 *
s
) {

9714 
s
->
Ën
 = 
	`g‘u16
(
p
);

9715 
s
->
p
 =… + 2;

9716  
s
->
p
 + s->
Ën
;

9717 
	}
}

9719 
MG_INTERNAL
 
	$·r£_mq‰
(
mbuf
 *
io
, 
mg_mq‰_mes§ge
 *
mm
) {

9720 
ušt8_t
 
h—d”
;

9721 
size_t
 
Ën
 = 0;

9722 
cmd
;

9723 cÚ¡ *
p
 = &
io
->
buf
[1], *
’d
;

9725 ià(
io
->
Ën
 < 2)  -1;

9726 
h—d”
 = 
io
->
buf
[0];

9727 
cmd
 = 
h—d”
 >> 4;

9731 
Ën
 +ğ(*
p
 & 127è<< 7 * (°- &
io
->
buf
[1]);

9732 } (*
p
++ & 128è!ğ0 && ((
size_t
)Õ - 
io
->
buf
è<ğio->
Ën
));

9734 
’d
 = 
p
 + 
Ën
;

9735 ià(
’d
 > 
io
->
buf
 + io->
Ën
 + 1) {

9739 
mm
->
cmd
 = cmd;

9740 
mm
->
qos
 = 
	`MG_MQTT_GET_QOS
(
h—d”
);

9742 
cmd
) {

9743 
MG_MQTT_CMD_CONNECT
: {

9744 
p
 = 
	`sÿÁo
Õ, &
mm
->
´ÙocŞ_Çme
);

9745 
mm
->
´ÙocŞ_v”siÚ
 = *(
ušt8_t
 *è
p
++;

9746 
mm
->
cÚÃù_æags
 = *(
ušt8_t
 *è
p
++;

9747 
mm
->
k“p_®ive_tim”
 = 
	`g‘u16
(
p
);

9748 
p
 += 2;

9749 ià(
p
 < 
’d
è°ğ
	`sÿÁo
Õ, &
mm
->
ş›Á_id
);

9750 ià(
p
 < 
’d
 && (
mm
->
cÚÃù_æags
 & 
MG_MQTT_HAS_WILL
))

9751 
p
 = 
	`sÿÁo
Õ, &
mm
->
wl_tİic
);

9752 ià(
p
 < 
’d
 && (
mm
->
cÚÃù_æags
 & 
MG_MQTT_HAS_WILL
))

9753 
p
 = 
	`sÿÁo
Õ, &
mm
->
wl_mes§ge
);

9754 ià(
p
 < 
’d
 && (
mm
->
cÚÃù_æags
 & 
MG_MQTT_HAS_USER_NAME
))

9755 
p
 = 
	`sÿÁo
Õ, &
mm
->
u£r_Çme
);

9756 ià(
p
 < 
’d
 && (
mm
->
cÚÃù_æags
 & 
MG_MQTT_HAS_PASSWORD
))

9757 
p
 = 
	`sÿÁo
Õ, &
mm
->
·sswÜd
);

9759 
	`LOG
(
LL_DEBUG
,

9762 
Ën
, (è
mm
->
cÚÃù_æags
, (èmm->
k“p_®ive_tim”
,

9763 (è
mm
->
´ÙocŞ_Çme
.
Ën
, mm->´ÙocŞ_Çme.
p
,

9764 (è
mm
->
ş›Á_id
.
Ën
, mm->ş›Á_id.
p
, (èmm->
wl_tİic
.len,

9765 
mm
->
wl_tİic
.
p
, (èmm->
wl_mes§ge
.
Ën
, mm->will_message.p,

9766 (è
mm
->
u£r_Çme
.
Ën
, mm->u£r_Çme.
p
, (èmm->
·sswÜd
.len,

9767 
mm
->
·sswÜd
.
p
));

9770 
MG_MQTT_CMD_CONNACK
:

9771 
mm
->
cÚÇck_»t_code
 = 
p
[1];

9773 
MG_MQTT_CMD_PUBACK
:

9774 
MG_MQTT_CMD_PUBREC
:

9775 
MG_MQTT_CMD_PUBREL
:

9776 
MG_MQTT_CMD_PUBCOMP
:

9777 
MG_MQTT_CMD_SUBACK
:

9778 
mm
->
mes§ge_id
 = 
	`g‘u16
(
p
);

9780 
MG_MQTT_CMD_PUBLISH
: {

9781 ià(
	`MG_MQTT_GET_QOS
(
h—d”
) > 0) {

9782 
mm
->
mes§ge_id
 = 
	`g‘u16
(
p
);

9783 
p
 += 2;

9785 
p
 = 
	`sÿÁo
Õ, &
mm
->
tİic
);

9787 
mm
->
·ylßd
.
p
 =…;

9788 
mm
->
·ylßd
.
Ën
 = 
’d
 - 
p
;

9791 
MG_MQTT_CMD_SUBSCRIBE
:

9792 
mm
->
mes§ge_id
 = 
	`g‘u16
(
p
);

9793 
p
 += 2;

9798 
mm
->
·ylßd
.
p
 =…;

9799 
mm
->
·ylßd
.
Ën
 = 
’d
 - 
p
;

9806  
’d
 - 
io
->
buf
;

9807 
	}
}

9809 
	$mq‰_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
, *
ev_d©a
) {

9810 
Ën
;

9811 
mbuf
 *
io
 = &
nc
->
»cv_mbuf
;

9812 
mg_mq‰_mes§ge
 
mm
;

9813 
	`mem£t
(&
mm
, 0, (mm));

9815 
nc
->
	`hªdËr
Òc, 
ev
, 
ev_d©a
);

9817 
ev
) {

9818 
MG_EV_RECV
:

9819 
Ën
 = 
	`·r£_mq‰
(
io
, &
mm
);

9820 ià(
Ën
 == -1) ;

9821 
nc
->
	`hªdËr
Òc, 
MG_MQTT_EVENT_BASE
 + 
mm
.
cmd
, &mm);

9822 
	`mbuf_»move
(
io
, 
Ën
);

9825 
	}
}

9827 
	$mg_mq‰_´Ùo_d©a_de¡ruùÜ
(*
´Ùo_d©a
) {

9828 
	`MG_FREE
(
´Ùo_d©a
);

9829 
	}
}

9831 
	$mg_£t_´ÙocŞ_mq‰
(
mg_cÚÃùiÚ
 *
nc
) {

9832 
nc
->
´Ùo_hªdËr
 = 
mq‰_hªdËr
;

9833 
nc
->
´Ùo_d©a
 = 
	`MG_CALLOC
(1, (
mg_mq‰_´Ùo_d©a
));

9834 
nc
->
´Ùo_d©a_de¡ruùÜ
 = 
mg_mq‰_´Ùo_d©a_de¡ruùÜ
;

9835 
	}
}

9837 
	$mg_£nd_mq‰_hªdshake
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
ş›Á_id
) {

9838 
mg_£nd_mq‰_hªdshake_İts
 
İts
;

9839 
	`mg_£nd_mq‰_hªdshake_İt
(
nc
, 
ş›Á_id
, 
İts
);

9840 
	}
}

9842 
	$mg_£nd_mq‰_hªdshake_İt
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
ş›Á_id
,

9843 
mg_£nd_mq‰_hªdshake_İts
 
İts
) {

9844 
ušt8_t
 
h—d”
 = 
MG_MQTT_CMD_CONNECT
 << 4;

9845 
ušt8_t
 
»m_Ën
;

9846 
ušt16_t
 
k“p_®ive
;

9847 
ušt16_t
 
Ën
;

9848 
mg_mq‰_´Ùo_d©a
 *
pd
 = (mg_mq‰_´Ùo_d©¨*è
nc
->
´Ùo_d©a
;

9855 
»m_Ën
 = 9 + 1 + 2 + 2 + (
ušt8_t
è
	`¡¾’
(
ş›Á_id
);

9857 ià(
İts
.
u£r_Çme
 !ğ
NULL
) {

9858 
İts
.
æags
 |ğ
MG_MQTT_HAS_USER_NAME
;

9859 
»m_Ën
 +ğ(
ušt8_t
è
	`¡¾’
(
İts
.
u£r_Çme
) + 2;

9861 ià(
İts
.
·sswÜd
 !ğ
NULL
) {

9862 
İts
.
æags
 |ğ
MG_MQTT_HAS_PASSWORD
;

9863 
»m_Ën
 +ğ(
ušt8_t
è
	`¡¾’
(
İts
.
·sswÜd
) + 2;

9865 ià(
İts
.
wl_tİic
 !ğ
NULL
 && o±s.
wl_mes§ge
 != NULL) {

9866 
İts
.
æags
 |ğ
MG_MQTT_HAS_WILL
;

9867 
»m_Ën
 +ğ(
ušt8_t
è
	`¡¾’
(
İts
.
wl_tİic
) + 2;

9868 
»m_Ën
 +ğ(
ušt8_t
è
	`¡¾’
(
İts
.
wl_mes§ge
) + 2;

9871 
	`mg_£nd
(
nc
, &
h—d”
, 1);

9872 
	`mg_£nd
(
nc
, &
»m_Ën
, 1);

9873 
	`mg_£nd
(
nc
, "\00\06MQIsdp\03", 9);

9874 
	`mg_£nd
(
nc
, &
İts
.
æags
, 1);

9876 ià(
İts
.
k“p_®ive
 == 0) {

9877 
İts
.
k“p_®ive
 = 60;

9880 
k“p_®ive
 = 
	`htÚs
(
İts
.keep_alive);

9881 
	`mg_£nd
(
nc
, &
k“p_®ive
, 2);

9883 
Ën
 = 
	`htÚs
((
ušt16_t
è
	`¡¾’
(
ş›Á_id
));

9884 
	`mg_£nd
(
nc
, &
Ën
, 2);

9885 
	`mg_£nd
(
nc
, 
ş›Á_id
, 
	`¡¾’
(client_id));

9887 ià(
İts
.
æags
 & 
MG_MQTT_HAS_WILL
) {

9888 
Ën
 = 
	`htÚs
((
ušt16_t
è
	`¡¾’
(
İts
.
wl_tİic
));

9889 
	`mg_£nd
(
nc
, &
Ën
, 2);

9890 
	`mg_£nd
(
nc
, 
İts
.
wl_tİic
, 
	`¡¾’
(opts.will_topic));

9892 
Ën
 = 
	`htÚs
((
ušt16_t
è
	`¡¾’
(
İts
.
wl_mes§ge
));

9893 
	`mg_£nd
(
nc
, &
Ën
, 2);

9894 
	`mg_£nd
(
nc
, 
İts
.
wl_mes§ge
, 
	`¡¾’
(opts.will_message));

9897 ià(
İts
.
æags
 & 
MG_MQTT_HAS_USER_NAME
) {

9898 
Ën
 = 
	`htÚs
((
ušt16_t
è
	`¡¾’
(
İts
.
u£r_Çme
));

9899 
	`mg_£nd
(
nc
, &
Ën
, 2);

9900 
	`mg_£nd
(
nc
, 
İts
.
u£r_Çme
, 
	`¡¾’
(opts.user_name));

9902 ià(
İts
.
æags
 & 
MG_MQTT_HAS_PASSWORD
) {

9903 
Ën
 = 
	`htÚs
((
ušt16_t
è
	`¡¾’
(
İts
.
·sswÜd
));

9904 
	`mg_£nd
(
nc
, &
Ën
, 2);

9905 
	`mg_£nd
(
nc
, 
İts
.
·sswÜd
, 
	`¡¾’
(opts.password));

9908 ià(
pd
 !ğ
NULL
) {

9909 
pd
->
k“p_®ive
 = 
İts
.keep_alive;

9911 
	}
}

9913 
	$mg_mq‰_´•’d_h—d”
(
mg_cÚÃùiÚ
 *
nc
, 
ušt8_t
 
cmd
,

9914 
ušt8_t
 
æags
, 
size_t
 
Ën
) {

9915 
size_t
 
off
 = 
nc
->
£nd_mbuf
.
Ën
 -†en;

9916 
ušt8_t
 
h—d”
 = 
cmd
 << 4 | (ušt8_tè
æags
;

9918 
ušt8_t
 
buf
[1 + (
size_t
)];

9919 
ušt8_t
 *
vËn
 = &
buf
[1];

9921 
	`as£¹
(
nc
->
£nd_mbuf
.
Ën
 >=†en);

9923 
buf
[0] = 
h—d”
;

9927 *
vËn
 = 
Ën
 % 0x80;

9928 
Ën
 /= 0x80;

9929 ià(
Ën
 > 0è*
vËn
 |= 0x80;

9930 
vËn
++;

9931 } 
Ën
 > 0);

9933 
	`mbuf_š£¹
(&
nc
->
£nd_mbuf
, 
off
, 
buf
, 
vËn
 - buf);

9934 
	}
}

9936 
	$mg_mq‰_publish
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
tİic
,

9937 
ušt16_t
 
mes§ge_id
, 
æags
, cÚ¡ *
d©a
,

9938 
size_t
 
Ën
) {

9939 
size_t
 
Şd_Ën
 = 
nc
->
£nd_mbuf
.
Ën
;

9941 
ušt16_t
 
tİic_Ën
 = 
	`htÚs
((ušt16_tè
	`¡¾’
(
tİic
));

9942 
ušt16_t
 
mes§ge_id_Ãt
 = 
	`htÚs
(
mes§ge_id
);

9944 
	`mg_£nd
(
nc
, &
tİic_Ën
, 2);

9945 
	`mg_£nd
(
nc
, 
tİic
, 
	`¡¾’
(topic));

9946 ià(
	`MG_MQTT_GET_QOS
(
æags
) > 0) {

9947 
	`mg_£nd
(
nc
, &
mes§ge_id_Ãt
, 2);

9949 
	`mg_£nd
(
nc
, 
d©a
, 
Ën
);

9951 
	`mg_mq‰_´•’d_h—d”
(
nc
, 
MG_MQTT_CMD_PUBLISH
, 
æags
,

9952 
nc
->
£nd_mbuf
.
Ën
 - 
Şd_Ën
);

9953 
	}
}

9955 
	$mg_mq‰_subsüibe
(
mg_cÚÃùiÚ
 *
nc
,

9956 cÚ¡ 
mg_mq‰_tİic_ex´essiÚ
 *
tİics
,

9957 
size_t
 
tİics_Ën
, 
ušt16_t
 
mes§ge_id
) {

9958 
size_t
 
Şd_Ën
 = 
nc
->
£nd_mbuf
.
Ën
;

9960 
ušt16_t
 
mes§ge_id_n
 = 
	`htÚs
(
mes§ge_id
);

9961 
size_t
 
i
;

9963 
	`mg_£nd
(
nc
, (*è&
mes§ge_id_n
, 2);

9964 
i
 = 0; i < 
tİics_Ën
; i++) {

9965 
ušt16_t
 
tİic_Ën_n
 = 
	`htÚs
((ušt16_tè
	`¡¾’
(
tİics
[
i
].
tİic
));

9966 
	`mg_£nd
(
nc
, &
tİic_Ën_n
, 2);

9967 
	`mg_£nd
(
nc
, 
tİics
[
i
].
tİic
, 
	`¡¾’
(topics[i].topic));

9968 
	`mg_£nd
(
nc
, &
tİics
[
i
].
qos
, 1);

9971 
	`mg_mq‰_´•’d_h—d”
(
nc
, 
MG_MQTT_CMD_SUBSCRIBE
, 
	`MG_MQTT_QOS
(1),

9972 
nc
->
£nd_mbuf
.
Ën
 - 
Şd_Ën
);

9973 
	}
}

9975 
	$mg_mq‰_Ãxt_subsüibe_tİic
(
mg_mq‰_mes§ge
 *
msg
,

9976 
mg_¡r
 *
tİic
, 
ušt8_t
 *
qos
, 
pos
) {

9977 *
buf
 = (*è
msg
->
·ylßd
.
p
 + 
pos
;

9979 ià((
size_t
è
pos
 >ğ
msg
->
·ylßd
.
Ën
) {

9983 
tİic
->
Ën
 = 
buf
[0] << 8 | buf[1];

9984 
tİic
->
p
 = (*è
buf
 + 2;

9985 *
qos
 = 
buf
[2 + 
tİic
->
Ën
];

9986  
pos
 + 2 + 
tİic
->
Ën
 + 1;

9987 
	}
}

9989 
	$mg_mq‰_unsubsüibe
(
mg_cÚÃùiÚ
 *
nc
, **
tİics
,

9990 
size_t
 
tİics_Ën
, 
ušt16_t
 
mes§ge_id
) {

9991 
size_t
 
Şd_Ën
 = 
nc
->
£nd_mbuf
.
Ën
;

9993 
ušt16_t
 
mes§ge_id_n
 = 
	`htÚs
(
mes§ge_id
);

9994 
size_t
 
i
;

9996 
	`mg_£nd
(
nc
, (*è&
mes§ge_id_n
, 2);

9997 
i
 = 0; i < 
tİics_Ën
; i++) {

9998 
ušt16_t
 
tİic_Ën_n
 = 
	`htÚs
((ušt16_tè
	`¡¾’
(
tİics
[
i
]));

9999 
	`mg_£nd
(
nc
, &
tİic_Ën_n
, 2);

10000 
	`mg_£nd
(
nc
, 
tİics
[
i
], 
	`¡¾’
(topics[i]));

10003 
	`mg_mq‰_´•’d_h—d”
(
nc
, 
MG_MQTT_CMD_UNSUBSCRIBE
, 
	`MG_MQTT_QOS
(1),

10004 
nc
->
£nd_mbuf
.
Ën
 - 
Şd_Ën
);

10005 
	}
}

10007 
	$mg_mq‰_cÚÇck
(
mg_cÚÃùiÚ
 *
nc
, 
ušt8_t
 
»tuº_code
) {

10008 
ušt8_t
 
unu£d
 = 0;

10009 
	`mg_£nd
(
nc
, &
unu£d
, 1);

10010 
	`mg_£nd
(
nc
, &
»tuº_code
, 1);

10011 
	`mg_mq‰_´•’d_h—d”
(
nc
, 
MG_MQTT_CMD_CONNACK
, 0, 2);

10012 
	}
}

10019 
	$mg_£nd_mq‰_shÜt_commªd
(
mg_cÚÃùiÚ
 *
nc
, 
ušt8_t
 
cmd
,

10020 
ušt16_t
 
mes§ge_id
) {

10021 
ušt16_t
 
mes§ge_id_Ãt
 = 
	`htÚs
(
mes§ge_id
);

10022 
	`mg_£nd
(
nc
, &
mes§ge_id_Ãt
, 2);

10023 
	`mg_mq‰_´•’d_h—d”
(
nc
, 
cmd
, 
	`MG_MQTT_QOS
(1), 2);

10024 
	}
}

10026 
	$mg_mq‰_puback
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
mes§ge_id
) {

10027 
	`mg_£nd_mq‰_shÜt_commªd
(
nc
, 
MG_MQTT_CMD_PUBACK
, 
mes§ge_id
);

10028 
	}
}

10030 
	$mg_mq‰_pub»c
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
mes§ge_id
) {

10031 
	`mg_£nd_mq‰_shÜt_commªd
(
nc
, 
MG_MQTT_CMD_PUBREC
, 
mes§ge_id
);

10032 
	}
}

10034 
	$mg_mq‰_pub»l
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
mes§ge_id
) {

10035 
	`mg_£nd_mq‰_shÜt_commªd
(
nc
, 
MG_MQTT_CMD_PUBREL
, 
mes§ge_id
);

10036 
	}
}

10038 
	$mg_mq‰_pubcomp
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
mes§ge_id
) {

10039 
	`mg_£nd_mq‰_shÜt_commªd
(
nc
, 
MG_MQTT_CMD_PUBCOMP
, 
mes§ge_id
);

10040 
	}
}

10042 
	$mg_mq‰_suback
(
mg_cÚÃùiÚ
 *
nc
, 
ušt8_t
 *
qoss
, 
size_t
 
qoss_Ën
,

10043 
ušt16_t
 
mes§ge_id
) {

10044 
size_t
 
i
;

10045 
ušt16_t
 
mes§ge_id_Ãt
 = 
	`htÚs
(
mes§ge_id
);

10046 
	`mg_£nd
(
nc
, &
mes§ge_id_Ãt
, 2);

10047 
i
 = 0; i < 
qoss_Ën
; i++) {

10048 
	`mg_£nd
(
nc
, &
qoss
[
i
], 1);

10050 
	`mg_mq‰_´•’d_h—d”
(
nc
, 
MG_MQTT_CMD_SUBACK
, 
	`MG_MQTT_QOS
(1), 2 + 
qoss_Ën
);

10051 
	}
}

10053 
	$mg_mq‰_unsuback
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
mes§ge_id
) {

10054 
	`mg_£nd_mq‰_shÜt_commªd
(
nc
, 
MG_MQTT_CMD_UNSUBACK
, 
mes§ge_id
);

10055 
	}
}

10057 
	$mg_mq‰_pšg
(
mg_cÚÃùiÚ
 *
nc
) {

10058 
	`mg_mq‰_´•’d_h—d”
(
nc
, 
MG_MQTT_CMD_PINGREQ
, 0, 0);

10059 
	}
}

10061 
	$mg_mq‰_pÚg
(
mg_cÚÃùiÚ
 *
nc
) {

10062 
	`mg_mq‰_´•’d_h—d”
(
nc
, 
MG_MQTT_CMD_PINGRESP
, 0, 0);

10063 
	}
}

10065 
	$mg_mq‰_discÚÃù
(
mg_cÚÃùiÚ
 *
nc
) {

10066 
	`mg_mq‰_´•’d_h—d”
(
nc
, 
MG_MQTT_CMD_DISCONNECT
, 0, 0);

10067 
	}
}

10070 #ifdeà
MG_MODULE_LINES


10081 #ià
MG_ENABLE_MQTT_BROKER


10083 
	$mg_mq‰_£ssiÚ_š™
(
mg_mq‰_brok”
 *
brk
,

10084 
mg_mq‰_£ssiÚ
 *
s
,

10085 
mg_cÚÃùiÚ
 *
nc
) {

10086 
s
->
brk
 = brk;

10087 
s
->
subsütiÚs
 = 
NULL
;

10088 
s
->
num_subsütiÚs
 = 0;

10089 
s
->
nc
 =‚c;

10090 
	}
}

10092 
	$mg_mq‰_add_£ssiÚ
(
mg_mq‰_£ssiÚ
 *
s
) {

10093 
	`LIST_INSERT_HEAD
(&
s
->
brk
->
£ssiÚs
, s, 
lšk
);

10094 
	}
}

10096 
	$mg_mq‰_»move_£ssiÚ
(
mg_mq‰_£ssiÚ
 *
s
) {

10097 
	`LIST_REMOVE
(
s
, 
lšk
);

10098 
	}
}

10100 
	$mg_mq‰_de¡roy_£ssiÚ
(
mg_mq‰_£ssiÚ
 *
s
) {

10101 
size_t
 
i
;

10102 
i
 = 0; i < 
s
->
num_subsütiÚs
; i++) {

10103 
	`MG_FREE
((*è
s
->
subsütiÚs
[
i
].
tİic
);

10105 
	`MG_FREE
(
s
->
subsütiÚs
);

10106 
	`MG_FREE
(
s
);

10107 
	}
}

10109 
	$mg_mq‰_şo£_£ssiÚ
(
mg_mq‰_£ssiÚ
 *
s
) {

10110 
	`mg_mq‰_»move_£ssiÚ
(
s
);

10111 
	`mg_mq‰_de¡roy_£ssiÚ
(
s
);

10112 
	}
}

10114 
	$mg_mq‰_brok”_š™
(
mg_mq‰_brok”
 *
brk
, *
u£r_d©a
) {

10115 
	`LIST_INIT
(&
brk
->
£ssiÚs
);

10116 
brk
->
u£r_d©a
 = user_data;

10117 
	}
}

10119 
	$mg_mq‰_brok”_hªdË_cÚÃù
(
mg_mq‰_brok”
 *
brk
,

10120 
mg_cÚÃùiÚ
 *
nc
) {

10121 
mg_mq‰_£ssiÚ
 *
s
 = (mg_mq‰_£ssiÚ *è
	`ÿÎoc
(1,  *s);

10122 ià(
s
 =ğ
NULL
) {

10124 
	`mg_mq‰_cÚÇck
(
nc
, 
MG_EV_MQTT_CONNACK_SERVER_UNAVAILABLE
);

10131 
	`mg_mq‰_£ssiÚ_š™
(
brk
, 
s
, 
nc
);

10132 
s
->
u£r_d©a
 = 
nc
->user_data;

10133 
nc
->
u£r_d©a
 = 
s
;

10134 
	`mg_mq‰_add_£ssiÚ
(
s
);

10136 
	`mg_mq‰_cÚÇck
(
nc
, 
MG_EV_MQTT_CONNACK_ACCEPTED
);

10137 
	}
}

10139 
	$mg_mq‰_brok”_hªdË_subsüibe
(
mg_cÚÃùiÚ
 *
nc
,

10140 
mg_mq‰_mes§ge
 *
msg
) {

10141 
mg_mq‰_£ssiÚ
 *
ss
 = (mg_mq‰_£ssiÚ *è
nc
->
u£r_d©a
;

10142 
ušt8_t
 
qoss
[512];

10143 
size_t
 
qoss_Ën
 = 0;

10144 
mg_¡r
 
tİic
;

10145 
ušt8_t
 
qos
;

10146 
pos
;

10147 
mg_mq‰_tİic_ex´essiÚ
 *
‹
;

10149 
pos
 = 0;

10150 (
pos
 = 
	`mg_mq‰_Ãxt_subsüibe_tİic
(
msg
, &
tİic
, &
qos
,…os)) != -1;) {

10151 
qoss
[
qoss_Ën
++] = 
qos
;

10154 
ss
->
subsütiÚs
 = (
mg_mq‰_tİic_ex´essiÚ
 *è
	`»®loc
(

10155 
ss
->
subsütiÚs
, (*ss->subsütiÚsè* 
qoss_Ën
);

10156 
pos
 = 0;

10157 (
pos
 = 
	`mg_mq‰_Ãxt_subsüibe_tİic
(
msg
, &
tİic
, &
qos
,…os)) != -1;

10158 
ss
->
num_subsütiÚs
++) {

10159 
‹
 = &
ss
->
subsütiÚs
[ss->
num_subsütiÚs
];

10160 
‹
->
tİic
 = (*è
	`m®loc
Ñİic.
Ën
 + 1);

10161 
‹
->
qos
 = qos;

10162 
	`¡ºıy
((*è
‹
->
tİic
,İic.
p
,İic.
Ën
 + 1);

10165 
	`mg_mq‰_suback
(
nc
, 
qoss
, 
qoss_Ën
, 
msg
->
mes§ge_id
);

10166 
	}
}

10175 
	$mg_mq‰_m©ch_tİic_ex´essiÚ
(cÚ¡ *
exp
,

10176 cÚ¡ 
mg_¡r
 *
tİic
) {

10178 
size_t
 
Ën
 = 
	`¡¾’
(
exp
);

10179 ià(
	`¡rchr
(
exp
, '#')) {

10180 
Ën
 -= 2;

10181 ià(
tİic
->
Ën
 <†en) {

10182 
Ën
 = 
tİic
->len;

10185  
	`¡ºcmp
(
tİic
->
p
, 
exp
, 
Ën
) == 0;

10186 
	}
}

10188 
	$mg_mq‰_brok”_hªdË_publish
(
mg_mq‰_brok”
 *
brk
,

10189 
mg_mq‰_mes§ge
 *
msg
) {

10190 
mg_mq‰_£ssiÚ
 *
s
;

10191 
size_t
 
i
;

10193 
s
 = 
	`mg_mq‰_Ãxt
(
brk
, 
NULL
); s != NULL; s = mg_mqtt_next(brk, s)) {

10194 
i
 = 0; i < 
s
->
num_subsütiÚs
; i++) {

10195 ià(
	`mg_mq‰_m©ch_tİic_ex´essiÚ
(
s
->
subsütiÚs
[
i
].
tİic
,

10196 &
msg
->
tİic
)) {

10197 
buf
[100], *
p
 = buf;

10198 
	`mg_a¥rštf
(&
p
, (
buf
), "%.*s", (è
msg
->
tİic
.
Ën
,

10199 
msg
->
tİic
.
p
);

10200 ià(
p
 =ğ
NULL
) {

10203 
	`mg_mq‰_publish
(
s
->
nc
, 
p
, 0, 0, 
msg
->
·ylßd
.p, msg->·ylßd.
Ën
);

10204 ià(
p
 !ğ
buf
) {

10205 
	`MG_FREE
(
p
);

10211 
	}
}

10213 
	$mg_mq‰_brok”
(
mg_cÚÃùiÚ
 *
nc
, 
ev
, *
d©a
) {

10214 
mg_mq‰_mes§ge
 *
msg
 = (mg_mq‰_mes§g*è
d©a
;

10215 
mg_mq‰_brok”
 *
brk
;

10217 ià(
nc
->
li¡’”
) {

10218 
brk
 = (
mg_mq‰_brok”
 *è
nc
->
li¡’”
->
u£r_d©a
;

10220 
brk
 = (
mg_mq‰_brok”
 *è
nc
->
u£r_d©a
;

10223 
ev
) {

10224 
MG_EV_ACCEPT
:

10225 
	`mg_£t_´ÙocŞ_mq‰
(
nc
);

10226 
nc
->
u£r_d©a
 = 
NULL
;

10228 
MG_EV_MQTT_CONNECT
:

10229 
	`mg_mq‰_brok”_hªdË_cÚÃù
(
brk
, 
nc
);

10231 
MG_EV_MQTT_SUBSCRIBE
:

10232 
	`mg_mq‰_brok”_hªdË_subsüibe
(
nc
, 
msg
);

10234 
MG_EV_MQTT_PUBLISH
:

10235 
	`mg_mq‰_brok”_hªdË_publish
(
brk
, 
msg
);

10237 
MG_EV_CLOSE
:

10238 ià(
nc
->
li¡’”
 &&‚c->
u£r_d©a
 !ğ
NULL
) {

10239 
	`mg_mq‰_şo£_£ssiÚ
((
mg_mq‰_£ssiÚ
 *è
nc
->
u£r_d©a
);

10243 
	}
}

10245 
mg_mq‰_£ssiÚ
 *
	$mg_mq‰_Ãxt
(
mg_mq‰_brok”
 *
brk
,

10246 
mg_mq‰_£ssiÚ
 *
s
) {

10247  
s
 =ğ
NULL
 ? 
	`LIST_FIRST
(&
brk
->
£ssiÚs
è: 
	`LIST_NEXT
(s, 
lšk
);

10248 
	}
}

10251 #ifdeà
MG_MODULE_LINES


10259 #ià
MG_ENABLE_DNS


10264 
	gmg_dns_tid
 = 0xa0;

10266 
	smg_dns_h—d”
 {

10267 
ušt16_t
 
	mŒª§ùiÚ_id
;

10268 
ušt16_t
 
	mæags
;

10269 
ušt16_t
 
	mnum_que¡iÚs
;

10270 
ušt16_t
 
	mnum_ªsw”s
;

10271 
ušt16_t
 
	mnum_authÜ™y_´s
;

10272 
ušt16_t
 
	mnum_Ùh”_´s
;

10275 
mg_dns_»sourû_»cÜd
 *
	$mg_dns_Ãxt_»cÜd
(

10276 
mg_dns_mes§ge
 *
msg
, 
qu”y
,

10277 
mg_dns_»sourû_»cÜd
 *
´ev
) {

10278 
mg_dns_»sourû_»cÜd
 *
¼
;

10280 
¼
 = (
´ev
 =ğ
NULL
 ? 
msg
->
ªsw”s
 :…rev + 1);

10281 
¼
 - 
msg
->
ªsw”s
 < msg->
num_ªsw”s
;„r++) {

10282 ià(
¼
->
¹y³
 =ğ
qu”y
) {

10283  
¼
;

10286  
NULL
;

10287 
	}
}

10289 
	$mg_dns_·r£_»cÜd_d©a
(
mg_dns_mes§ge
 *
msg
,

10290 
mg_dns_»sourû_»cÜd
 *
¼
, *
d©a
,

10291 
size_t
 
d©a_Ën
) {

10292 
¼
->
¹y³
) {

10293 
MG_DNS_A_RECORD
:

10294 ià(
d©a_Ën
 < (
š_addr
)) {

10297 ià(
¼
->
rd©a
.
p
 + 
d©a_Ën
 > 
msg
->
pkt
.°+ msg->pkt.
Ën
) {

10300 
	`memıy
(
d©a
, 
¼
->
rd©a
.
p
, 
d©a_Ën
);

10302 #ià
MG_ENABLE_IPV6


10303 
MG_DNS_AAAA_RECORD
:

10304 ià(
d©a_Ën
 < (
š6_addr
)) {

10307 
	`memıy
(
d©a
, 
¼
->
rd©a
.
p
, 
d©a_Ën
);

10310 
MG_DNS_CNAME_RECORD
:

10311 
	`mg_dns_uncom´ess_Çme
(
msg
, &
¼
->
rd©a
, (*è
d©a
, 
d©a_Ën
);

10316 
	}
}

10318 
	$mg_dns_š£¹_h—d”
(
mbuf
 *
io
, 
size_t
 
pos
,

10319 
mg_dns_mes§ge
 *
msg
) {

10320 
mg_dns_h—d”
 
h—d”
;

10322 
	`mem£t
(&
h—d”
, 0, (header));

10323 
h—d”
.
Œª§ùiÚ_id
 = 
msg
->transaction_id;

10324 
h—d”
.
æags
 = 
	`htÚs
(
msg
->flags);

10325 
h—d”
.
num_que¡iÚs
 = 
	`htÚs
(
msg
->num_questions);

10326 
h—d”
.
num_ªsw”s
 = 
	`htÚs
(
msg
->num_answers);

10328  
	`mbuf_š£¹
(
io
, 
pos
, &
h—d”
, (header));

10329 
	}
}

10331 
	$mg_dns_cİy_que¡iÚs
(
mbuf
 *
io
, 
mg_dns_mes§ge
 *
msg
) {

10332 *
begš
, *
’d
;

10333 
mg_dns_»sourû_»cÜd
 *
Ï¡_q
;

10334 ià(
msg
->
num_que¡iÚs
 <= 0)  0;

10335 
begš
 = (*è
msg
->
pkt
.
p
 + (
mg_dns_h—d”
);

10336 
Ï¡_q
 = &
msg
->
que¡iÚs
[msg->
num_que¡iÚs
 - 1];

10337 
’d
 = (*è
Ï¡_q
->
Çme
.
p
 +†a¡_q->Çme.
Ën
 + 4;

10338  
	`mbuf_­³nd
(
io
, 
begš
, 
’d
 - begin);

10339 
	}
}

10341 
	$mg_dns_’code_Çme
(
mbuf
 *
io
, cÚ¡ *
Çme
, 
size_t
 
Ën
) {

10342 cÚ¡ *
s
;

10343 
n
;

10344 
size_t
 
pos
 = 
io
->
Ën
;

10347 ià((
s
 = 
	`¡rchr
(
Çme
, '.')è=ğ
NULL
) {

10348 
s
 = 
Çme
 + 
Ën
;

10351 ià(
s
 - 
Çme
 > 127) {

10354 
n
 = 
s
 - 
Çme
;

10355 
	`mbuf_­³nd
(
io
, &
n
, 1);

10356 
	`mbuf_­³nd
(
io
, 
Çme
, 
n
);

10358 ià(*
s
 == '.') {

10359 
n
++;

10362 
Çme
 +ğ
n
;

10363 
Ën
 -ğ
n
;

10364 } *
s
 != '\0');

10365 
	`mbuf_­³nd
(
io
, "\0", 1);

10367  
io
->
Ën
 - 
pos
;

10368 
	}
}

10370 
	$mg_dns_’code_»cÜd
(
mbuf
 *
io
, 
mg_dns_»sourû_»cÜd
 *
¼
,

10371 cÚ¡ *
Çme
, 
size_t
 
Æ’
, cÚ¡ *
rd©a
,

10372 
size_t
 
¾’
) {

10373 
size_t
 
pos
 = 
io
->
Ën
;

10374 
ušt16_t
 
u16
;

10375 
ušt32_t
 
u32
;

10377 ià(
¼
->
kšd
 =ğ
MG_DNS_INVALID_RECORD
) {

10381 ià(
	`mg_dns_’code_Çme
(
io
, 
Çme
, 
Æ’
) == -1) {

10385 
u16
 = 
	`htÚs
(
¼
->
¹y³
);

10386 
	`mbuf_­³nd
(
io
, &
u16
, 2);

10387 
u16
 = 
	`htÚs
(
¼
->
rşass
);

10388 
	`mbuf_­³nd
(
io
, &
u16
, 2);

10390 ià(
¼
->
kšd
 =ğ
MG_DNS_ANSWER
) {

10391 
u32
 = 
	`htÚl
(
¼
->
‰l
);

10392 
	`mbuf_­³nd
(
io
, &
u32
, 4);

10394 ià(
¼
->
¹y³
 =ğ
MG_DNS_CNAME_RECORD
) {

10395 
ş’
;

10397 
size_t
 
off
 = 
io
->
Ën
;

10398 
	`mbuf_­³nd
(
io
, &
u16
, 2);

10399 ià((
ş’
 = 
	`mg_dns_’code_Çme
(
io
, (cÚ¡ *è
rd©a
, 
¾’
)) == -1) {

10402 
u16
 = 
ş’
;

10403 
io
->
buf
[
off
] = 
u16
 >> 8;

10404 
io
->
buf
[
off
 + 1] = 
u16
 & 0xff;

10406 
u16
 = 
	`htÚs
((
ušt16_t
è
¾’
);

10407 
	`mbuf_­³nd
(
io
, &
u16
, 2);

10408 
	`mbuf_­³nd
(
io
, 
rd©a
, 
¾’
);

10412  
io
->
Ën
 - 
pos
;

10413 
	}
}

10415 
	$mg_£nd_dns_qu”y
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
Çme
,

10416 
qu”y_ty³
) {

10417 
mg_dns_mes§ge
 *
msg
 =

10418 (
mg_dns_mes§ge
 *è
	`MG_CALLOC
(1, (*
msg
));

10419 
mbuf
 
pkt
;

10420 
mg_dns_»sourû_»cÜd
 *
¼
 = &
msg
->
que¡iÚs
[0];

10422 
	`DBG
(("% %d", 
Çme
, 
qu”y_ty³
));

10424 
	`mbuf_š™
(&
pkt
, 64 );

10426 
msg
->
Œª§ùiÚ_id
 = ++
mg_dns_tid
;

10427 
msg
->
æags
 = 0x100;

10428 
msg
->
num_que¡iÚs
 = 1;

10430 
	`mg_dns_š£¹_h—d”
(&
pkt
, 0, 
msg
);

10432 
¼
->
¹y³
 = 
qu”y_ty³
;

10433 
¼
->
rşass
 = 1;

10434 
¼
->
kšd
 = 
MG_DNS_QUESTION
;

10436 ià(
	`mg_dns_’code_»cÜd
(&
pkt
, 
¼
, 
Çme
, 
	`¡¾’
Òame), 
NULL
, 0) == -1) {

10438 
ş—nup
;

10442 ià(!(
nc
->
æags
 & 
MG_F_UDP
)) {

10443 
ušt16_t
 
Ën
 = 
	`htÚs
((ušt16_tè
pkt
.len);

10444 
	`mbuf_š£¹
(&
pkt
, 0, &
Ën
, 2);

10447 
	`mg_£nd
(
nc
, 
pkt
.
buf
,…kt.
Ën
);

10448 
	`mbuf_ä“
(&
pkt
);

10450 
ş—nup
:

10451 
	`MG_FREE
(
msg
);

10452 
	}
}

10454 *
	$mg_·r£_dns_»sourû_»cÜd
(

10455 *
d©a
, *
’d
, 
mg_dns_»sourû_»cÜd
 *
¼
,

10456 
»¶y
) {

10457 *
Çme
 = 
d©a
;

10458 
chunk_Ën
, 
d©a_Ën
;

10460 
d©a
 < 
’d
 && (
chunk_Ën
 = *data)) {

10461 ià(((*è
d©a
)[0] & 0xc0) {

10462 
d©a
 += 1;

10465 
d©a
 +ğ
chunk_Ën
 + 1;

10468 ià(
d©a
 > 
’d
 - 5) {

10469  
NULL
;

10472 
¼
->
Çme
.
p
 = (*)‚ame;

10473 
¼
->
Çme
.
Ën
 = 
d©a
 -‚ame + 1;

10474 
d©a
++;

10476 
¼
->
¹y³
 = 
d©a
[0] << 8 | data[1];

10477 
d©a
 += 2;

10479 
¼
->
rşass
 = 
d©a
[0] << 8 | data[1];

10480 
d©a
 += 2;

10482 
¼
->
kšd
 = 
»¶y
 ? 
MG_DNS_ANSWER
 : 
MG_DNS_QUESTION
;

10483 ià(
»¶y
) {

10484 ià(
d©a
 >ğ
’d
 - 6) {

10485  
NULL
;

10488 
¼
->
‰l
 = (
ušt32_t
è
d©a
[0] << 24 | (uint32_t) data[1] << 16 |

10489 
d©a
[2] << 8 | data[3];

10490 
d©a
 += 4;

10492 
d©a_Ën
 = *
d©a
 << 8 | *(data + 1);

10493 
d©a
 += 2;

10495 
¼
->
rd©a
.
p
 = (*è
d©a
;

10496 
¼
->
rd©a
.
Ën
 = 
d©a_Ën
;

10497 
d©a
 +ğ
d©a_Ën
;

10499  
d©a
;

10500 
	}
}

10502 
	$mg_·r£_dns
(cÚ¡ *
buf
, 
Ën
, 
mg_dns_mes§ge
 *
msg
) {

10503 
mg_dns_h—d”
 *
h—d”
 = (mg_dns_h—d” *è
buf
;

10504 *
d©a
 = (*è
buf
 + (*
h—d”
);

10505 *
’d
 = (*è
buf
 + 
Ën
;

10506 
i
;

10508 
	`mem£t
(
msg
, 0, (*msg));

10509 
msg
->
pkt
.
p
 = 
buf
;

10510 
msg
->
pkt
.
Ën
 =†en;

10512 ià(
Ën
 < (è(*
h—d”
))  -1;

10514 
msg
->
Œª§ùiÚ_id
 = 
h—d”
->transaction_id;

10515 
msg
->
æags
 = 
	`Áohs
(
h—d”
->flags);

10516 
msg
->
num_que¡iÚs
 = 
	`Áohs
(
h—d”
->num_questions);

10517 ià(
msg
->
num_que¡iÚs
 > (è
	`ARRAY_SIZE
(msg->
que¡iÚs
)) {

10518 
msg
->
num_que¡iÚs
 = (è
	`ARRAY_SIZE
(msg->
que¡iÚs
);

10520 
msg
->
num_ªsw”s
 = 
	`Áohs
(
h—d”
->num_answers);

10521 ià(
msg
->
num_ªsw”s
 > (è
	`ARRAY_SIZE
(msg->
ªsw”s
)) {

10522 
msg
->
num_ªsw”s
 = (è
	`ARRAY_SIZE
(msg->
ªsw”s
);

10525 
i
 = 0; i < 
msg
->
num_que¡iÚs
; i++) {

10526 
d©a
 = 
	`mg_·r£_dns_»sourû_»cÜd
(d©a, 
’d
, &
msg
->
que¡iÚs
[
i
], 0);

10527 ià(
d©a
 =ğ
NULL
)  -1;

10530 
i
 = 0; i < 
msg
->
num_ªsw”s
; i++) {

10531 
d©a
 = 
	`mg_·r£_dns_»sourû_»cÜd
(d©a, 
’d
, &
msg
->
ªsw”s
[
i
], 1);

10532 ià(
d©a
 =ğ
NULL
)  -1;

10536 
	}
}

10538 
size_t
 
	$mg_dns_uncom´ess_Çme
(
mg_dns_mes§ge
 *
msg
, 
mg_¡r
 *
Çme
,

10539 *
d¡
, 
d¡_Ën
) {

10540 
chunk_Ën
;

10541 *
Şd_d¡
 = 
d¡
;

10542 cÚ¡ *
d©a
 = (*è
Çme
->
p
;

10543 cÚ¡ *
’d
 = (*è
msg
->
pkt
.
p
 + msg->pkt.
Ën
;

10545 ià(
d©a
 >ğ
’d
) {

10549 (
chunk_Ën
 = *
d©a
++)) {

10550 
Ëeway
 = 
d¡_Ën
 - (
d¡
 - 
Şd_d¡
);

10551 ià(
d©a
 >ğ
’d
) {

10555 ià(
chunk_Ën
 & 0xc0) {

10556 
ušt16_t
 
off
 = (
d©a
[-1] & (~0xc0)) << 8 | data[0];

10557 ià(
off
 >ğ
msg
->
pkt
.
Ën
) {

10560 
d©a
 = (*è
msg
->
pkt
.
p
 + 
off
;

10563 ià(
chunk_Ën
 > 
Ëeway
) {

10564 
chunk_Ën
 = 
Ëeway
;

10567 ià(
d©a
 + 
chunk_Ën
 >ğ
’d
) {

10571 
	`memıy
(
d¡
, 
d©a
, 
chunk_Ën
);

10572 
d©a
 +ğ
chunk_Ën
;

10573 
d¡
 +ğ
chunk_Ën
;

10574 
Ëeway
 -ğ
chunk_Ën
;

10575 ià(
Ëeway
 == 0) {

10576  
d¡
 - 
Şd_d¡
;

10578 *
d¡
++ = '.';

10581 ià(
d¡
 !ğ
Şd_d¡
) {

10582 *--
d¡
 = 0;

10584  
d¡
 - 
Şd_d¡
;

10585 
	}
}

10587 
	$dns_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
, *
ev_d©a
) {

10588 
mbuf
 *
io
 = &
nc
->
»cv_mbuf
;

10589 
mg_dns_mes§ge
 
msg
;

10592 
nc
->
	`hªdËr
Òc, 
ev
, 
ev_d©a
);

10594 
ev
) {

10595 
MG_EV_RECV
:

10596 ià(!(
nc
->
æags
 & 
MG_F_UDP
)) {

10597 
	`mbuf_»move
(&
nc
->
»cv_mbuf
, 2);

10599 ià(
	`mg_·r£_dns
(
nc
->
»cv_mbuf
.
buf
,‚c->»cv_mbuf.
Ën
, &
msg
) == -1) {

10601 
	`mem£t
(&
msg
, 0, (msg));

10602 
msg
.
æags
 = 0x8081;

10603 
	`mg_dns_š£¹_h—d”
(
io
, 0, &
msg
);

10604 ià(!(
nc
->
æags
 & 
MG_F_UDP
)) {

10605 
ušt16_t
 
Ën
 = 
	`htÚs
((ušt16_tè
io
->len);

10606 
	`mbuf_š£¹
(
io
, 0, &
Ën
, 2);

10608 
	`mg_£nd
(
nc
, 
io
->
buf
, io->
Ën
);

10611 
nc
->
	`hªdËr
Òc, 
MG_DNS_MESSAGE
, &
msg
);

10613 
	`mbuf_»move
(
io
, io->
Ën
);

10616 
	}
}

10618 
	$mg_£t_´ÙocŞ_dns
(
mg_cÚÃùiÚ
 *
nc
) {

10619 
nc
->
´Ùo_hªdËr
 = 
dns_hªdËr
;

10620 
	}
}

10623 #ifdeà
MG_MODULE_LINES


10631 #ià
MG_ENABLE_DNS_SERVER


10636 
mg_dns_»¶y
 
	$mg_dns_ü—‹_»¶y
(
mbuf
 *
io
,

10637 
mg_dns_mes§ge
 *
msg
) {

10638 
mg_dns_»¶y
 
»p
;

10639 
»p
.
msg
 = msg;

10640 
»p
.
io
 = io;

10641 
»p
.
¡¬t
 = 
io
->
Ën
;

10644 
msg
->
æags
 |= 0x8080;

10645 
	`mg_dns_cİy_que¡iÚs
(
io
, 
msg
);

10647 
msg
->
num_ªsw”s
 = 0;

10648  
»p
;

10649 
	}
}

10651 
	$mg_dns_£nd_»¶y
(
mg_cÚÃùiÚ
 *
nc
, 
mg_dns_»¶y
 *
r
) {

10652 
size_t
 
£Á
 = 
r
->
io
->
Ën
 -„->
¡¬t
;

10653 
	`mg_dns_š£¹_h—d”
(
r
->
io
,„->
¡¬t
,„->
msg
);

10654 ià(!(
nc
->
æags
 & 
MG_F_UDP
)) {

10655 
ušt16_t
 
Ën
 = 
	`htÚs
((ušt16_tè
£Á
);

10656 
	`mbuf_š£¹
(
r
->
io
,„->
¡¬t
, &
Ën
, 2);

10659 ià(&
nc
->
£nd_mbuf
 !ğ
r
->
io
) {

10660 
	`mg_£nd
(
nc
, 
r
->
io
->
buf
 +„->
¡¬t
,„->io->
Ën
 -„->start);

10661 
r
->
io
->
Ën
 =„->
¡¬t
;

10663 
	}
}

10665 
	$mg_dns_»¶y_»cÜd
(
mg_dns_»¶y
 *
»¶y
,

10666 
mg_dns_»sourû_»cÜd
 *
que¡iÚ
,

10667 cÚ¡ *
Çme
, 
¹y³
, 
‰l
, cÚ¡ *
rd©a
,

10668 
size_t
 
rd©a_Ën
) {

10669 
mg_dns_mes§ge
 *
msg
 = (mg_dns_mes§g*è
»¶y
->msg;

10670 
ºame
[512];

10671 
mg_dns_»sourû_»cÜd
 *
ªs
 = &
msg
->
ªsw”s
[msg->
num_ªsw”s
];

10672 ià(
msg
->
num_ªsw”s
 >ğ
MG_MAX_DNS_ANSWERS
) {

10676 ià(
Çme
 =ğ
NULL
) {

10677 
Çme
 = 
ºame
;

10678 
ºame
[511] = 0;

10679 
	`mg_dns_uncom´ess_Çme
(
msg
, &
que¡iÚ
->
Çme
, 
ºame
, (rname) - 1);

10682 *
ªs
 = *
que¡iÚ
;

10683 
ªs
->
kšd
 = 
MG_DNS_ANSWER
;

10684 
ªs
->
¹y³
 =„type;

10685 
ªs
->
‰l
 =tl;

10687 ià(
	`mg_dns_’code_»cÜd
(
»¶y
->
io
, 
ªs
, 
Çme
, 
	`¡¾’
Òame), 
rd©a
,

10688 
rd©a_Ën
) == -1) {

10692 
msg
->
num_ªsw”s
++;

10694 
	}
}

10697 #ifdeà
MG_MODULE_LINES


10705 #ià
MG_ENABLE_ASYNC_RESOLVER


10710 #iâdeà
MG_DEFAULT_NAMESERVER


10711 
	#MG_DEFAULT_NAMESERVER
 "8.8.8.8"

	)

10714 cÚ¡ *
	gmg_deçuÉ_dns_£rv”
 = "udp://" 
MG_DEFAULT_NAMESERVER
 ":53";

10716 
MG_INTERNAL
 
	gmg_dns_£rv”
[256];

10718 
	smg_»sŞve_async_»que¡
 {

10719 
	mÇme
[1024];

10720 
	mqu”y
;

10721 
mg_»sŞve_ÿÎback_t
 
	mÿÎback
;

10722 *
	md©a
;

10723 
time_t
 
	mtimeout
;

10724 
	mmax_»Œ›s
;

10725 
mg_»sŞve_”r
 
	m”r
;

10728 
time_t
 
	mÏ¡_time
;

10729 
	m»Œ›s
;

10737 
	$mg_g‘__add»ss_of_Çme£rv”
(*
Çme
, 
size_t
 
Çme_Ën
) {

10738 
»t
 = -1;

10740 #ifdeà
_WIN32


10741 
i
;

10742 
LONG
 
”r
;

10743 
HKEY
 
hKey
, 
hSub
;

10744 
wch¬_t
 
subkey
[512], 
v®ue
[128],

10745 *
key
 = 
L
"SYSTEM\\ControlSet001\\Services\\Tcpip\\Parameters\\Interfaces";

10747 ià((
”r
 = 
	`RegO³nKeyExW
(
HKEY_LOCAL_MACHINE
, 
key
, 0, 
KEY_READ
, &
hKey
)) !=

10748 
ERROR_SUCCESS
) {

10749 
	`årštf
(
¡d”r
, "ÿÂÙ o³À»g key %S: %ld\n", 
key
, 
”r
);

10750 
»t
 = -1;

10752 
»t
 = -1, 
i
 = 0; 1; i++) {

10753 
DWORD
 
subkey_size
 = (
subkey
), 
ty³
, 
Ën
 = (
v®ue
);

10754 ià(
	`RegEnumKeyExW
(
hKey
, 
i
, 
subkey
, &
subkey_size
, 
NULL
, NULL, NULL,

10755 
NULL
è!ğ
ERROR_SUCCESS
) {

10758 ià(
	`RegO³nKeyExW
(
hKey
, 
subkey
, 0, 
KEY_READ
, &
hSub
è=ğ
ERROR_SUCCESS
 &&

10759 (
	`RegQu”yV®ueExW
(
hSub
, 
L
"NameS”v”", 0, &
ty³
, (*è
v®ue
,

10760 &
Ën
è=ğ
ERROR_SUCCESS
 ||

10761 
	`RegQu”yV®ueExW
(
hSub
, 
L
"DhıNameS”v”", 0, &
ty³
, (*è
v®ue
,

10762 &
Ën
è=ğ
ERROR_SUCCESS
)) {

10770 
wch¬_t
 *
comma
 = 
	`wcschr
(
v®ue
, ',');

10771 ià(
v®ue
[0] == '\0') {

10774 ià(
comma
 !ğ
NULL
) {

10775 *
comma
 = '\0';

10777 
	`¢´štf
(
Çme
, 
Çme_Ën
, "udp://%S:53", 
v®ue
);

10778 
»t
 = 0;

10779 
	`RegClo£Key
(
hSub
);

10783 
	`RegClo£Key
(
hKey
);

10785 #–ià
MG_ENABLE_FILESYSTEM


10786 
FILE
 *
å
;

10787 
lše
[512];

10789 ià((
å
 = 
	`mg_fİ’
("/‘c/»sŞv.cÚf", "r")è=ğ
NULL
) {

10790 
»t
 = -1;

10793 
»t
 = -1; 
	`fg‘s
(
lše
, Öše), 
å
è!ğ
NULL
;) {

10794 
a
, 
b
, 
c
, 
d
;

10795 ià(
	`ssÿnf
(
lše
, "Çme£rv” %u.%u.%u.%u", &
a
, &
b
, &
c
, &
d
) == 4) {

10796 
	`¢´štf
(
Çme
, 
Çme_Ën
, "udp://%u.%u.%u.%u:53", 
a
, 
b
, 
c
, 
d
);

10797 
»t
 = 0;

10801 (è
	`fşo£
(
å
);

10804 
	`¢´štf
(
Çme
, 
Çme_Ën
, "%s", 
mg_deçuÉ_dns_£rv”
);

10807  
»t
;

10808 
	}
}

10810 
	$mg_»sŞve_äom_ho¡s_fe
(cÚ¡ *
Çme
, 
sock‘_add»ss
 *
u§
) {

10811 #ià
MG_ENABLE_FILESYSTEM


10813 
FILE
 *
å
;

10814 
lše
[1024];

10815 *
p
;

10816 
®Ÿs
[256];

10817 
a
, 
b
, 
c
, 
d
;

10818 
Ën
 = 0;

10820 ià((
å
 = 
	`mg_fİ’
("/‘c/ho¡s", "r")è=ğ
NULL
) {

10824 ; 
	`fg‘s
(
lše
, Öše), 
å
è!ğ
NULL
;) {

10825 ià(
lše
[0] == '#') ;

10827 ià(
	`ssÿnf
(
lše
, "%u.%u.%u.%u%n", &
a
, &
b
, &
c
, &
d
, &
Ën
) == 0) {

10831 
p
 = 
lše
 + 
Ën
; 
	`ssÿnf
Õ, "%s%n", 
®Ÿs
, &len) == 1;… +=†en) {

10832 ià(
	`¡rcmp
(
®Ÿs
, 
Çme
) == 0) {

10833 
u§
->
sš
.
sš_addr
.
s_addr
 = 
	`htÚl
(
a
 << 24 | 
b
 << 16 | 
c
 << 8 | 
d
);

10834 
	`fşo£
(
å
);

10840 
	`fşo£
(
å
);

10842 (è
Çme
;

10843 (è
u§
;

10847 
	}
}

10849 
	$mg_»sŞve_async_eh
(
mg_cÚÃùiÚ
 *
nc
, 
ev
, *
d©a
) {

10850 
time_t
 
now
 = (time_tè
	`mg_time
();

10851 
mg_»sŞve_async_»que¡
 *
»q
;

10852 
mg_dns_mes§ge
 *
msg
;

10853 
fœ¡
 = 0;

10855 ià(
ev
 !ğ
MG_EV_POLL
è
	`DBG
(("ev=%d u£r_d©a=%p",ƒv, 
nc
->
u£r_d©a
));

10857 
»q
 = (
mg_»sŞve_async_»que¡
 *è
nc
->
u£r_d©a
;

10859 ià(
»q
 =ğ
NULL
) {

10863 
ev
) {

10864 
MG_EV_CONNECT
:

10866 
fœ¡
 = 1;

10868 
MG_EV_POLL
:

10869 ià(
»q
->
»Œ›s
 >„eq->
max_»Œ›s
) {

10870 
»q
->
”r
 = 
MG_RESOLVE_EXCEEDED_RETRY_COUNT
;

10871 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

10874 ià(
fœ¡
 || 
now
 - 
»q
->
Ï¡_time
 >ğ»q->
timeout
) {

10875 
	`mg_£nd_dns_qu”y
(
nc
, 
»q
->
Çme
,„eq->
qu”y
);

10876 
»q
->
Ï¡_time
 = 
now
;

10877 
»q
->
»Œ›s
++;

10880 
MG_EV_RECV
:

10881 
msg
 = (
mg_dns_mes§ge
 *è
	`MG_MALLOC
((*msg));

10882 ià(
	`mg_·r£_dns
(
nc
->
»cv_mbuf
.
buf
, *(*è
d©a
, 
msg
) == 0 &&

10883 
msg
->
num_ªsw”s
 > 0) {

10884 
»q
->
	`ÿÎback
(
msg
,„eq->
d©a
, 
MG_RESOLVE_OK
);

10885 
nc
->
u£r_d©a
 = 
NULL
;

10886 
	`MG_FREE
(
»q
);

10888 
»q
->
”r
 = 
MG_RESOLVE_NO_ANSWERS
;

10890 
	`MG_FREE
(
msg
);

10891 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

10893 
MG_EV_SEND
:

10898 
nc
->
æags
 &ğ~
MG_F_CLOSE_IMMEDIATELY
;

10899 
	`mbuf_»move
(&
nc
->
£nd_mbuf
,‚c->£nd_mbuf.
Ën
);

10901 
MG_EV_TIMER
:

10902 
»q
->
”r
 = 
MG_RESOLVE_TIMEOUT
;

10903 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

10905 
MG_EV_CLOSE
:

10907 ià(
»q
 !ğ
NULL
) {

10908 
»q
->
	`ÿÎback
(
NULL
,„eq->
d©a
,„eq->
”r
);

10909 
nc
->
u£r_d©a
 = 
NULL
;

10910 
	`MG_FREE
(
»q
);

10914 
	}
}

10916 
	$mg_»sŞve_async
(
mg_mgr
 *
mgr
, cÚ¡ *
Çme
, 
qu”y
,

10917 
mg_»sŞve_ÿÎback_t
 
cb
, *
d©a
) {

10918 
mg_»sŞve_async_İts
 
İts
;

10919 
	`mem£t
(&
İts
, 0, (opts));

10920  
	`mg_»sŞve_async_İt
(
mgr
, 
Çme
, 
qu”y
, 
cb
, 
d©a
, 
İts
);

10921 
	}
}

10923 
	$mg_»sŞve_async_İt
(
mg_mgr
 *
mgr
, cÚ¡ *
Çme
, 
qu”y
,

10924 
mg_»sŞve_ÿÎback_t
 
cb
, *
d©a
,

10925 
mg_»sŞve_async_İts
 
İts
) {

10926 
mg_»sŞve_async_»que¡
 *
»q
;

10927 
mg_cÚÃùiÚ
 *
dns_nc
;

10928 cÚ¡ *
Çme£rv”
 = 
İts
.
Çme£rv”_u¾
;

10930 
	`DBG
(("% %d %p", 
Çme
, 
qu”y
, 
İts
.
dns_cÚn
));

10933 
»q
 = (
mg_»sŞve_async_»que¡
 *è
	`MG_CALLOC
(1, (*req));

10934 ià(
»q
 =ğ
NULL
) {

10938 
	`¡ºıy
(
»q
->
Çme
,‚ame, (req->name));

10939 
»q
->
qu”y
 = query;

10940 
»q
->
ÿÎback
 = 
cb
;

10941 
»q
->
d©a
 = data;

10943 
»q
->
max_»Œ›s
 = 
İts
.max_retries ? opts.max_retries : 2;

10944 
»q
->
timeout
 = 
İts
.timeout ? opts.timeout : 5;

10947 ià(
Çme£rv”
 =ğ
NULL
 && 
mg_dns_£rv”
[0] == '\0' &&

10948 
	`mg_g‘__add»ss_of_Çme£rv”
(
mg_dns_£rv”
, (mg_dns_server)) ==

10950 
	`¡ºıy
(
mg_dns_£rv”
, 
mg_deçuÉ_dns_£rv”
, (mg_dns_server));

10953 ià(
Çme£rv”
 =ğ
NULL
) {

10954 
Çme£rv”
 = 
mg_dns_£rv”
;

10957 
dns_nc
 = 
	`mg_cÚÃù
(
mgr
, 
Çme£rv”
, 
mg_»sŞve_async_eh
);

10958 ià(
dns_nc
 =ğ
NULL
) {

10959 
	`ä“
(
»q
);

10962 
dns_nc
->
u£r_d©a
 = 
»q
;

10963 ià(
İts
.
dns_cÚn
 !ğ
NULL
) {

10964 *
İts
.
dns_cÚn
 = 
dns_nc
;

10968 
	}
}

10971 #ifdeà
MG_MODULE_LINES


10994 #ià
MG_ENABLE_COAP


10996 
	$mg_cßp_ä“_İtiÚs
(
mg_cßp_mes§ge
 *
cm
) {

10997 
cm
->
İtiÚs
 !ğ
NULL
) {

10998 
mg_cßp_İtiÚ
 *
Ãxt
 = 
cm
->
İtiÚs
->next;

10999 
	`MG_FREE
(
cm
->
İtiÚs
);

11000 
cm
->
İtiÚs
 = 
Ãxt
;

11002 
	}
}

11004 
mg_cßp_İtiÚ
 *
	$mg_cßp_add_İtiÚ
(
mg_cßp_mes§ge
 *
cm
,

11005 
ušt32_t
 
numb”
, *
v®ue
,

11006 
size_t
 
Ën
) {

11007 
mg_cßp_İtiÚ
 *
Ãw_İtiÚ
 =

11008 (
mg_cßp_İtiÚ
 *è
	`MG_CALLOC
(1, (*
Ãw_İtiÚ
));

11010 
Ãw_İtiÚ
->
numb”
 =‚umber;

11011 
Ãw_İtiÚ
->
v®ue
.
p
 = value;

11012 
Ãw_İtiÚ
->
v®ue
.
Ën
 =†en;

11014 ià(
cm
->
İtiÚs
 =ğ
NULL
) {

11015 
cm
->
İtiÚs
 = cm->
İtiomg_
 = 
Ãw_İtiÚ
;

11022 ià(
cm
->
İtiomg_
->
numb”
 <ğ
Ãw_İtiÚ
->number) {

11024 
cm
->
İtiomg_
 = cm->İtiomg_->
Ãxt
 = 
Ãw_İtiÚ
;

11027 
mg_cßp_İtiÚ
 *
cu¼’t_İt
 = 
cm
->
İtiÚs
;

11028 
mg_cßp_İtiÚ
 *
´ev_İt
 = 0;

11030 
cu¼’t_İt
 !ğ
NULL
) {

11031 ià(
cu¼’t_İt
->
numb”
 > 
Ãw_İtiÚ
->number) {

11034 
´ev_İt
 = 
cu¼’t_İt
;

11035 
cu¼’t_İt
 = cu¼’t_İt->
Ãxt
;

11038 ià(
´ev_İt
 !ğ
NULL
) {

11039 
´ev_İt
->
Ãxt
 = 
Ãw_İtiÚ
;

11040 
Ãw_İtiÚ
->
Ãxt
 = 
cu¼’t_İt
;

11043 
Ãw_İtiÚ
->
Ãxt
 = 
cm
->
İtiÚs
;

11044 
cm
->
İtiÚs
 = 
Ãw_İtiÚ
;

11049  
Ãw_İtiÚ
;

11050 
	}
}

11057 *
	$cßp_·r£_h—d”
(*
±r
, 
mbuf
 *
io
,

11058 
mg_cßp_mes§ge
 *
cm
) {

11059 ià(
io
->
Ën
 < (
ušt32_t
)) {

11060 
cm
->
æags
 |ğ
MG_COAP_NOT_ENOUGH_DATA
;

11061  
NULL
;

11070 ià(((
ušt8_t
è*
±r
 >> 6) != 1) {

11071 
cm
->
æags
 |ğ
MG_COAP_IGNORE
;

11072  
NULL
;

11080 
cm
->
msg_ty³
 = ((
ušt8_t
è*
±r
 & 0x30) >> 4;

11081 
cm
->
æags
 |ğ
MG_COAP_MSG_TYPE_FIELD
;

11089 
cm
->
tok’
.
Ën
 = *
±r
 & 0x0F;

11090 ià(
cm
->
tok’
.
Ën
 > 8) {

11091 
cm
->
æags
 |ğ
MG_COAP_FORMAT_ERROR
;

11092  
NULL
;

11095 
±r
++;

11101 
cm
->
code_şass
 = (
ušt8_t
è*
±r
 >> 5;

11102 
cm
->
code_d‘a
 = *
±r
 & 0x1F;

11103 
cm
->
æags
 |ğ(
MG_COAP_CODE_CLASS_FIELD
 | 
MG_COAP_CODE_DETAIL_FIELD
);

11105 
±r
++;

11108 
cm
->
msg_id
 = (
ušt8_t
è*
±r
 << 8 | (uint8_t) * (ptr + 1);

11109 
cm
->
æags
 |ğ
MG_COAP_MSG_ID_FIELD
;

11111 
±r
 += 2;

11113  
±r
;

11114 
	}
}

11121 *
	$cßp_g‘_tok’
(*
±r
, 
mbuf
 *
io
,

11122 
mg_cßp_mes§ge
 *
cm
) {

11123 ià(
cm
->
tok’
.
Ën
 != 0) {

11124 ià(
±r
 + 
cm
->
tok’
.
Ën
 > 
io
->
buf
 + io->len) {

11125 
cm
->
æags
 |ğ
MG_COAP_NOT_ENOUGH_DATA
;

11126  
NULL
;

11128 
cm
->
tok’
.
p
 = 
±r
;

11129 
±r
 +ğ
cm
->
tok’
.
Ën
;

11130 
cm
->
æags
 |ğ
MG_COAP_TOKEN_FIELD
;

11134  
±r
;

11135 
	}
}

11142 
	$cßp_g‘_ext_İt
(*
±r
, 
mbuf
 *
io
, 
ušt16_t
 *
İt_šfo
) {

11143 
»t
 = 0;

11145 ià(*
İt_šfo
 == 13) {

11150 ià(
±r
 < 
io
->
buf
 + io->
Ën
) {

11151 *
İt_šfo
 = (
ušt8_t
è*
±r
 + 13;

11152 
»t
 = (
ušt8_t
);

11154 
»t
 = -1;

11156 } ià(*
İt_šfo
 == 14) {

11161 ià(
±r
 + (
ušt8_t
è< 
io
->
buf
 + io->
Ën
) {

11162 *
İt_šfo
 = ((
ušt8_t
è*
±r
 << 8 | (uint8_t) * (ptr + 1)) + 269;

11163 
»t
 = (
ušt16_t
);

11165 
»t
 = -1;

11169  
»t
;

11170 
	}
}

11188 *
	$cßp_g‘_İtiÚs
(*
±r
, 
mbuf
 *
io
,

11189 
mg_cßp_mes§ge
 *
cm
) {

11190 
ušt16_t
 
´ev_İt
 = 0;

11192 ià(
±r
 =ğ
io
->
buf
 + io->
Ën
) {

11194  
NULL
;

11198 
±r
 < 
io
->
buf
 + io->
Ën
 && (
ušt8_t
) *ptr != 0xFF) {

11199 
ušt16_t
 
İtiÚ_d–
, 
İtiÚ_Ënght
;

11200 
İtšfo_Ën
;

11203 
İtiÚ_d–
 = ((
ušt8_t
è*
±r
 & 0xF0) >> 4;

11205 
İtiÚ_Ënght
 = *
±r
 & 0x0F;

11207 ià(
İtiÚ_d–
 =ğ15 || 
İtiÚ_Ënght
 == 15) {

11212 
cm
->
æags
 |ğ
MG_COAP_FORMAT_ERROR
;

11216 
±r
++;

11219 
İtšfo_Ën
 = 
	`cßp_g‘_ext_İt
(
±r
, 
io
, &
İtiÚ_d–
);

11220 ià(
İtšfo_Ën
 == -1) {

11221 
cm
->
æags
 |ğ
MG_COAP_NOT_ENOUGH_DATA
;

11225 
±r
 +ğ
İtšfo_Ën
;

11228 
İtšfo_Ën
 = 
	`cßp_g‘_ext_İt
(
±r
, 
io
, &
İtiÚ_Ënght
);

11229 ià(
İtšfo_Ën
 == -1) {

11230 
cm
->
æags
 |ğ
MG_COAP_NOT_ENOUGH_DATA
;

11234 
±r
 +ğ
İtšfo_Ën
;

11241 
İtiÚ_d–
 +ğ
´ev_İt
;

11243 
	`mg_cßp_add_İtiÚ
(
cm
, 
İtiÚ_d–
, 
±r
, 
İtiÚ_Ënght
);

11245 
´ev_İt
 = 
İtiÚ_d–
;

11247 ià(
±r
 + 
İtiÚ_Ënght
 > 
io
->
buf
 + io->
Ën
) {

11248 
cm
->
æags
 |ğ
MG_COAP_NOT_ENOUGH_DATA
;

11252 
±r
 +ğ
İtiÚ_Ënght
;

11255 ià((
cm
->
æags
 & 
MG_COAP_ERROR
) != 0) {

11256 
	`mg_cßp_ä“_İtiÚs
(
cm
);

11257  
NULL
;

11260 
cm
->
æags
 |ğ
MG_COAP_OPTIOMG_FIELD
;

11262 ià(
±r
 =ğ
io
->
buf
 + io->
Ën
) {

11264  
NULL
;

11267 
±r
++;

11269  
±r
;

11270 
	}
}

11272 
ušt32_t
 
	$mg_cßp_·r£
(
mbuf
 *
io
, 
mg_cßp_mes§ge
 *
cm
) {

11273 *
±r
;

11275 
	`mem£t
(
cm
, 0, (*cm));

11277 ià((
±r
 = 
	`cßp_·r£_h—d”
(
io
->
buf
, io, 
cm
)è=ğ
NULL
) {

11278  
cm
->
æags
;

11281 ià((
±r
 = 
	`cßp_g‘_tok’
ÕŒ, 
io
, 
cm
)è=ğ
NULL
) {

11282  
cm
->
æags
;

11285 ià((
±r
 = 
	`cßp_g‘_İtiÚs
ÕŒ, 
io
, 
cm
)è=ğ
NULL
) {

11286  
cm
->
æags
;

11290 
cm
->
·ylßd
.
Ën
 = 
io
->ËÀ- (
±r
 - io->
buf
);

11291 ià(
cm
->
·ylßd
.
Ën
 != 0) {

11292 
cm
->
·ylßd
.
p
 = 
±r
;

11293 
cm
->
æags
 |ğ
MG_COAP_PAYLOAD_FIELD
;

11296  
cm
->
æags
;

11297 
	}
}

11304 
size_t
 
	$cßp_g‘_ext_İt_size
(
ušt32_t
 
v®ue
) {

11305 
»t
 = 0;

11307 ià(
v®ue
 >= 13 && value <= 0xFF + 13) {

11308 
»t
 = (
ušt8_t
);

11309 } ià(
v®ue
 > 0xFF + 13 && value <= 0xFFFF + 269) {

11310 
»t
 = (
ušt16_t
);

11313  
»t
;

11314 
	}
}

11321 
	$cßp_¥l™_İt
(
ušt32_t
 
v®ue
, 
ušt8_t
 *
ba£
, 
ušt16_t
 *
ext
) {

11322 
»t
 = 0;

11324 ià(
v®ue
 < 13) {

11325 *
ba£
 = 
v®ue
;

11326 } ià(
v®ue
 >= 13 && value <= 0xFF + 13) {

11327 *
ba£
 = 13;

11328 *
ext
 = 
v®ue
 - 13;

11329 
»t
 = (
ušt8_t
);

11330 } ià(
v®ue
 > 0xFF + 13 && value <= 0xFFFF + 269) {

11331 *
ba£
 = 14;

11332 *
ext
 = 
v®ue
 - 269;

11333 
»t
 = (
ušt16_t
);

11336  
»t
;

11337 
	}
}

11344 *
	$cßp_add_ušt16
(*
±r
, 
ušt16_t
 
v®
) {

11345 *
±r
 = 
v®
 >> 8;

11346 
±r
++;

11347 *
±r
 = 
v®
 & 0x00FF;

11348 
±r
++;

11349  
±r
;

11350 
	}
}

11357 *
	$cßp_add_İt_šfo
(*
±r
, 
ušt16_t
 
v®
, 
size_t
 
Ën
) {

11358 ià(
Ën
 =ğ(
ušt8_t
)) {

11359 *
±r
 = (è
v®
;

11360 
±r
++;

11361 } ià(
Ën
 =ğ(
ušt16_t
)) {

11362 
±r
 = 
	`cßp_add_ušt16
ÕŒ, 
v®
);

11365  
±r
;

11366 
	}
}

11373 
ušt32_t
 
	$cßp_ÿlcuÏ‹_·ck‘_size
(
mg_cßp_mes§ge
 *
cm
,

11374 
size_t
 *
Ën
) {

11375 
mg_cßp_İtiÚ
 *
İt
;

11376 
ušt32_t
 
´ev_İt_numb”
;

11378 *
Ën
 = 4;

11379 ià(
cm
->
msg_ty³
 > 
MG_COAP_MSG_MAX
) {

11380  
MG_COAP_ERROR
 | 
MG_COAP_MSG_TYPE_FIELD
;

11382 ià(
cm
->
tok’
.
Ën
 > 8) {

11383  
MG_COAP_ERROR
 | 
MG_COAP_TOKEN_FIELD
;

11385 ià(
cm
->
code_şass
 > 7) {

11386  
MG_COAP_ERROR
 | 
MG_COAP_CODE_CLASS_FIELD
;

11388 ià(
cm
->
code_d‘a
 > 31) {

11389  
MG_COAP_ERROR
 | 
MG_COAP_CODE_DETAIL_FIELD
;

11392 *
Ën
 +ğ
cm
->
tok’
.len;

11393 ià(
cm
->
·ylßd
.
Ën
 != 0) {

11394 *
Ën
 +ğ
cm
->
·ylßd
.len + 1;

11397 
İt
 = 
cm
->
İtiÚs
;

11398 
´ev_İt_numb”
 = 0;

11399 
İt
 !ğ
NULL
) {

11400 *
Ën
 += 1;

11401 *
Ën
 +ğ
	`cßp_g‘_ext_İt_size
(
İt
->
numb”
 - 
´ev_İt_numb”
);

11402 *
Ën
 +ğ
	`cßp_g‘_ext_İt_size
((
ušt32_t
è
İt
->
v®ue
.len);

11409 ià((
İt
->
Ãxt
 !ğ
NULL
 && o±->
numb”
 > opt->next->number) ||

11410 
İt
->
v®ue
.
Ën
 > 0xFFFF + 269 ||

11411 
İt
->
numb”
 - 
´ev_İt_numb”
 > 0xFFFF + 269) {

11412  
MG_COAP_ERROR
 | 
MG_COAP_OPTIOMG_FIELD
;

11414 *
Ën
 +ğ
İt
->
v®ue
.len;

11415 
´ev_İt_numb”
 = 
İt
->
numb”
;

11416 
İt
 = o±->
Ãxt
;

11420 
	}
}

11422 
ušt32_t
 
	$mg_cßp_compo£
(
mg_cßp_mes§ge
 *
cm
, 
mbuf
 *
io
) {

11423 
mg_cßp_İtiÚ
 *
İt
;

11424 
ušt32_t
 
»s
, 
´ev_İt_numb”
;

11425 
size_t
 
´ev_io_Ën
, 
·ck‘_size
;

11426 *
±r
;

11428 
»s
 = 
	`cßp_ÿlcuÏ‹_·ck‘_size
(
cm
, &
·ck‘_size
);

11429 ià(
»s
 != 0) {

11430  
»s
;

11434 
´ev_io_Ën
 = 
io
->
Ën
;

11435 
	`mbuf_­³nd
(
io
, 
NULL
, 
·ck‘_size
);

11436 
±r
 = 
io
->
buf
 + 
´ev_io_Ën
;

11444 *
±r
 = (1 << 6è| (
cm
->
msg_ty³
 << 4è| (
ušt8_t
)(cm->
tok’
.
Ën
);

11445 
±r
++;

11448 *
±r
 = (
cm
->
code_şass
 << 5è| (cm->
code_d‘a
);

11449 
±r
++;

11451 
±r
 = 
	`cßp_add_ušt16
ÕŒ, 
cm
->
msg_id
);

11453 ià(
cm
->
tok’
.
Ën
 != 0) {

11454 
	`memıy
(
±r
, 
cm
->
tok’
.
p
, cm->tok’.
Ën
);

11455 
±r
 +ğ
cm
->
tok’
.
Ën
;

11458 
İt
 = 
cm
->
İtiÚs
;

11459 
´ev_İt_numb”
 = 0;

11460 
İt
 !ğ
NULL
) {

11461 
ušt8_t
 
d–_ba£
 = 0, 
Ëngth_ba£
 = 0;

11462 
ušt16_t
 
d–_ext
 = 0, 
Ëngth_ext
 = 0;

11464 
size_t
 
İt_d–_Ën
 =

11465 
	`cßp_¥l™_İt
(
İt
->
numb”
 - 
´ev_İt_numb”
, &
d–_ba£
, &
d–_ext
);

11466 
size_t
 
İt_Ënght_Ën
 =

11467 
	`cßp_¥l™_İt
((
ušt32_t
è
İt
->
v®ue
.
Ën
, &
Ëngth_ba£
, &
Ëngth_ext
);

11469 *
±r
 = (
d–_ba£
 << 4è| 
Ëngth_ba£
;

11470 
±r
++;

11472 
±r
 = 
	`cßp_add_İt_šfo
ÕŒ, 
d–_ext
, 
İt_d–_Ën
);

11473 
±r
 = 
	`cßp_add_İt_šfo
ÕŒ, 
Ëngth_ext
, 
İt_Ënght_Ën
);

11475 ià(
İt
->
v®ue
.
Ën
 != 0) {

11476 
	`memıy
(
±r
, 
İt
->
v®ue
.
p
, o±->v®ue.
Ën
);

11477 
±r
 +ğ
İt
->
v®ue
.
Ën
;

11480 
´ev_İt_numb”
 = 
İt
->
numb”
;

11481 
İt
 = o±->
Ãxt
;

11484 ià(
cm
->
·ylßd
.
Ën
 != 0) {

11485 *
±r
 = () -1;

11486 
±r
++;

11487 
	`memıy
(
±r
, 
cm
->
·ylßd
.
p
, cm->·ylßd.
Ën
);

11491 
	}
}

11493 
ušt32_t
 
	$mg_cßp_£nd_mes§ge
(
mg_cÚÃùiÚ
 *
nc
,

11494 
mg_cßp_mes§ge
 *
cm
) {

11495 
mbuf
 
·ck‘_out
;

11496 
ušt32_t
 
compo£_»s
;

11498 
	`mbuf_š™
(&
·ck‘_out
, 0);

11499 
compo£_»s
 = 
	`mg_cßp_compo£
(
cm
, &
·ck‘_out
);

11500 ià(
compo£_»s
 != 0) {

11501  
compo£_»s
;

11504 
	`mg_£nd
(
nc
, 
·ck‘_out
.
buf
, (è·ck‘_out.
Ën
);

11505 
	`mbuf_ä“
(&
·ck‘_out
);

11508 
	}
}

11510 
ušt32_t
 
	$mg_cßp_£nd_ack
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
msg_id
) {

11511 
mg_cßp_mes§ge
 
cm
;

11512 
	`mem£t
(&
cm
, 0, (cm));

11513 
cm
.
msg_ty³
 = 
MG_COAP_MSG_ACK
;

11514 
cm
.
msg_id
 = msg_id;

11516  
	`mg_cßp_£nd_mes§ge
(
nc
, &
cm
);

11517 
	}
}

11519 
	$cßp_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
, *
ev_d©a
) {

11520 
mbuf
 *
io
 = &
nc
->
»cv_mbuf
;

11521 
mg_cßp_mes§ge
 
cm
;

11522 
ušt32_t
 
·r£_»s
;

11524 
	`mem£t
(&
cm
, 0, (cm));

11526 
nc
->
	`hªdËr
Òc, 
ev
, 
ev_d©a
);

11528 
ev
) {

11529 
MG_EV_RECV
:

11530 
·r£_»s
 = 
	`mg_cßp_·r£
(
io
, &
cm
);

11531 ià((
·r£_»s
 & 
MG_COAP_IGNORE
) == 0) {

11532 ià((
cm
.
æags
 & 
MG_COAP_NOT_ENOUGH_DATA
) != 0) {

11537 
cm
.
æags
 |ğ
MG_COAP_FORMAT_ERROR
;

11539 
nc
->
	`hªdËr
Òc, 
MG_COAP_EVENT_BASE
 + 
cm
.
msg_ty³
, &cm);

11542 
	`mg_cßp_ä“_İtiÚs
(&
cm
);

11543 
	`mbuf_»move
(
io
, io->
Ën
);

11546 
	}
}

11557 
	$mg_£t_´ÙocŞ_cßp
(
mg_cÚÃùiÚ
 *
nc
) {

11559 ià((
nc
->
æags
 & 
MG_F_UDP
) == 0) {

11563 
nc
->
´Ùo_hªdËr
 = 
cßp_hªdËr
;

11566 
	}
}

11569 #ifdeà
MG_MODULE_LINES


11577 #ià
MG_ENABLE_TUN


11587 
mg_tun_»cÚÃù
(
mg_tun_ş›Á
 *
ş›Á
, 
timeout
);

11589 
	$mg_tun_š™_ş›Á
(
mg_tun_ş›Á
 *
ş›Á
, 
mg_mgr
 *
mgr
,

11590 
mg_içû
 *
içû
, cÚ¡ *
di¥©ch”
,

11591 
mg_tun_s¦_İts
 
s¦
) {

11592 
ş›Á
->
mgr
 = mgr;

11593 
ş›Á
->
içû
 = iface;

11594 
ş›Á
->
di¥_u¾
 = 
di¥©ch”
;

11595 
ş›Á
->
Ï¡_¡»am_id
 = 0;

11596 
ş›Á
->
s¦
 = ssl;

11598 
ş›Á
->
di¥
 = 
NULL
;

11599 
ş›Á
->
li¡’”
 = 
NULL
;

11600 
ş›Á
->
»cÚÃù
 = 
NULL
;

11601 
	}
}

11603 
	$mg_tun_log_äame
(
mg_tun_äame
 *
äame
) {

11604 
	`LOG
(
LL_DEBUG
, ("Got TUN frame:ype=0x%x, flags=0x%x stream_id=0x%lx, "

11606 
äame
->
ty³
, f¿me->
æags
, f¿me->
¡»am_id
, f¿me->
body
.
Ën
));

11607 #ià
MG_ENABLE_HEXDUMP


11609 
hex
[512];

11610 
	`mg_hexdump
(
äame
->
body
.
p
, f¿me->body.
Ën
, 
hex
, (hex) - 1);

11611 
hex
[(hex) - 1] = '\0';

11612 
	`LOG
(
LL_DEBUG
, ("body:\n%s", 
hex
));

11615 
	`LOG
(
LL_DEBUG
, ("body: '%.*s'", (è
äame
->
body
.
Ën
, f¿me->body.
p
));

11617 
	}
}

11619 
	$mg_tun_şo£_®l
(
mg_tun_ş›Á
 *
ş›Á
) {

11620 
mg_cÚÃùiÚ
 *
nc
;

11621 
nc
 = 
ş›Á
->
mgr
->
aùive_cÚÃùiÚs
;‚ø!ğ
NULL
;‚øğnc->
Ãxt
) {

11622 ià(
nc
->
içû
 =ğ
ş›Á
->içû && !Òc->
æags
 & 
MG_F_LISTENING
)) {

11623 
	`LOG
(
LL_DEBUG
, ("ClosšguÂ–ed cÚÃùiÚ %p", 
nc
));

11624 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

11628 
	}
}

11630 
	$mg_tun_ş›Á_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
,

11631 *
ev_d©a
) {

11632 
mg_tun_ş›Á
 *
ş›Á
 = (mg_tun_ş›Á *è
nc
->
u£r_d©a
;

11634 
ev
) {

11635 
MG_EV_CONNECT
: {

11636 
”r
 = *(*è
ev_d©a
;

11638 ià(
”r
) {

11639 
	`LOG
(
LL_ERROR
, ("CªnÙ cÚÃùØthtuÂ– di¥©ch”: %d", 
”r
));

11641 
	`LOG
(
LL_INFO
, ("Connectedoheunnel dispatcher"));

11645 
MG_EV_HTTP_REPLY
: {

11646 
h‰p_mes§ge
 *
hm
 = (h‰p_mes§g*è
ev_d©a
;

11648 ià(
hm
->
»¥_code
 != 200) {

11649 
	`LOG
(
LL_ERROR
,

11650 ("TuÂ– di¥©ch”„•ly‚Ú-OK stu cod%d", 
hm
->
»¥_code
));

11654 
MG_EV_WEBSOCKET_HANDSHAKE_DONE
: {

11655 
	`LOG
(
LL_INFO
, ("Tunnel dispatcher handshake done"));

11658 
MG_EV_WEBSOCKET_FRAME
: {

11659 
websock‘_mes§ge
 *
wm
 = (websock‘_mes§g*è
ev_d©a
;

11660 
mg_cÚÃùiÚ
 *
tc
;

11661 
mg_tun_äame
 
äame
;

11663 ià(
	`mg_tun_·r£_äame
(
wm
->
d©a
, wm->
size
, &
äame
) == -1) {

11664 
	`LOG
(
LL_ERROR
, ("GÙ inv®iduÀäamdrİpšg", 
wm
->
size
));

11668 
	`mg_tun_log_äame
(&
äame
);

11670 
tc
 = 
	`mg_tun_if_fšd_cÚn
(
ş›Á
, 
äame
.
¡»am_id
);

11671 ià(
tc
 =ğ
NULL
) {

11672 ià(
äame
.
body
.
Ën
 > 0) {

11673 
	`LOG
(
LL_DEBUG
, ("Got frame‡fter„eceivingƒnd has been closed"));

11677 ià(
äame
.
body
.
Ën
 > 0) {

11678 
	`mg_if_»cv_tı_cb
(
tc
, (*è
äame
.
body
.
p
, f¿me.body.
Ën
,

11681 ià(
äame
.
æags
 & 
MG_TUN_F_END_STREAM
) {

11682 
	`LOG
(
LL_DEBUG
, ("Closingunneled connection because gotƒnd of stream "

11684 
tc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

11685 
	`mg_şo£_cÚn
(
tc
);

11689 
MG_EV_CLOSE
: {

11690 
	`LOG
(
LL_DEBUG
, ("Closing‡llunneled connections"));

11695 ià(
ş›Á
 !ğ
NULL
) {

11696 
	`mg_tun_şo£_®l
(
ş›Á
);

11697 
ş›Á
->
di¥
 = 
NULL
;

11698 
	`LOG
(
LL_INFO
, ("Dispatcher connection is‚o more,„econnecting"));

11700 
	`mg_tun_»cÚÃù
(
ş›Á
, 
MG_TUN_RECONNECT_INTERVAL
);

11707 
	}
}

11709 
	$mg_tun_do_»cÚÃù
(
mg_tun_ş›Á
 *
ş›Á
) {

11710 
mg_cÚÃùiÚ
 *
dc
;

11711 
mg_cÚÃù_İts
 
İts
;

11712 
	`mem£t
(&
İts
, 0, (opts));

11713 #ià
MG_ENABLE_SSL


11714 
İts
.
s¦_û¹
 = 
ş›Á
->
s¦
.ssl_cert;

11715 
İts
.
s¦_key
 = 
ş›Á
->
s¦
.ssl_key;

11716 
İts
.
s¦_ÿ_û¹
 = 
ş›Á
->
s¦
.ssl_ca_cert;

11719 ià((
dc
 = 
	`mg_cÚÃù_ws_İt
(
ş›Á
->
mgr
, 
mg_tun_ş›Á_hªdËr
, 
İts
,

11720 
ş›Á
->
di¥_u¾
, 
MG_TUN_PROTO_NAME
, 
NULL
)) ==

11721 
NULL
) {

11722 
	`LOG
(
LL_ERROR
,

11723 ("CªnÙ cÚÃùØWS s”v” oÀadd¸[%s]\n", 
ş›Á
->
di¥_u¾
));

11727 
ş›Á
->
di¥
 = 
dc
;

11728 
dc
->
u£r_d©a
 = 
ş›Á
;

11729 
	}
}

11731 
	$mg_tun_»cÚÃù_ev_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
,

11732 *
ev_d©a
) {

11733 
mg_tun_ş›Á
 *
ş›Á
 = (mg_tun_ş›Á *è
nc
->
u£r_d©a
;

11734 (è
ev_d©a
;

11736 
ev
) {

11737 
MG_EV_TIMER
:

11738 ià(!(
ş›Á
->
li¡’”
->
æags
 & 
MG_F_TUN_DO_NOT_RECONNECT
)) {

11739 
	`mg_tun_do_»cÚÃù
(
ş›Á
);

11742 
	`mg_tun_»cÚÃù
(
ş›Á
, 0);

11746 
	}
}

11748 
	$mg_tun_»cÚÃù
(
mg_tun_ş›Á
 *
ş›Á
, 
timeout
) {

11749 ià(
ş›Á
->
»cÚÃù
 =ğ
NULL
) {

11750 
ş›Á
->
»cÚÃù
 =

11751 
	`mg_add_sock
(
ş›Á
->
mgr
, 
INVALID_SOCKET
, 
mg_tun_»cÚÃù_ev_hªdËr
);

11752 
ş›Á
->
»cÚÃù
->
u£r_d©a
 = client;

11754 
ş›Á
->
»cÚÃù
->
ev_tim”_time
 = 
	`mg_time
(è+ 
timeout
;

11755 
	}
}

11757 
mg_tun_ş›Á
 *
	$mg_tun_ü—‹_ş›Á
(
mg_mgr
 *
mgr
,

11758 cÚ¡ *
di¥©ch”
,

11759 
mg_tun_s¦_İts
 
s¦
) {

11760 
mg_tun_ş›Á
 *
ş›Á
 = 
NULL
;

11761 
mg_içû
 *
içû
 = 
	`mg_fšd_içû
(
mgr
, &
mg_tun_içû_vbË
, 
NULL
);

11762 ià(
içû
 =ğ
NULL
) {

11763 
	`LOG
(
LL_ERROR
, ("Theun feature„equireshe managero have‡un "

11765  
NULL
;

11768 
ş›Á
 = (
mg_tun_ş›Á
 *è
	`MG_MALLOC
((*client));

11769 
	`mg_tun_š™_ş›Á
(
ş›Á
, 
mgr
, 
içû
, 
di¥©ch”
, 
s¦
);

11770 
içû
->
d©a
 = 
ş›Á
;

11777 
	`mg_tun_»cÚÃù
(
ş›Á
, 0);

11778  
ş›Á
;

11779 
	}
}

11781 
	$mg_tun_de¡roy_ş›Á
(
mg_tun_ş›Á
 *
ş›Á
) {

11789 ià(
ş›Á
 !ğ
NULL
 && cl›Á->
di¥
 != NULL) {

11791 
ş›Á
->
di¥
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

11793 
ş›Á
->
di¥
->
u£r_d©a
 = 
NULL
;

11796 ià(
ş›Á
 !ğ
NULL
 && cl›Á->
»cÚÃù
 != NULL) {

11797 
ş›Á
->
»cÚÃù
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

11800 ià(
ş›Á
 !ğ
NULL
 && cl›Á->
içû
 != NULL) {

11801 
ş›Á
->
içû
->
d©a
 = 
NULL
;

11804 
	`MG_FREE
(
ş›Á
);

11805 
	}
}

11807 
mg_cÚÃùiÚ
 *
	$mg_tun_do_bšd
(
mg_tun_ş›Á
 *
ş›Á
,

11808 
mg_ev’t_hªdËr_t
 
hªdËr
,

11809 
mg_bšd_İts
 
İts
) {

11810 
mg_cÚÃùiÚ
 *
lc
;

11811 
İts
.
içû
 = 
ş›Á
->iface;

11812 
lc
 = 
	`mg_bšd_İt
(
ş›Á
->
mgr
, ":1234" , 
hªdËr
, 
İts
);

11813 
ş›Á
->
li¡’”
 = 
lc
;

11814  
lc
;

11815 
	}
}

11817 
mg_cÚÃùiÚ
 *
	$mg_tun_bšd_İt
(
mg_mgr
 *
mgr
,

11818 cÚ¡ *
di¥©ch”
,

11819 
mg_ev’t_hªdËr_t
 
hªdËr
,

11820 
mg_bšd_İts
 
İts
) {

11821 #ià
MG_ENABLE_SSL


11822 
mg_tun_s¦_İts
 
s¦
 = {
İts
.
s¦_û¹
, o±s.
s¦_key
, o±s.
s¦_ÿ_û¹
};

11824 
mg_tun_s¦_İts
 
s¦
 = {0};

11826 
mg_tun_ş›Á
 *
ş›Á
 = 
	`mg_tun_ü—‹_ş›Á
(
mgr
, 
di¥©ch”
, 
s¦
);

11827 ià(
ş›Á
 =ğ
NULL
) {

11828  
NULL
;

11830 #ià
MG_ENABLE_SSL


11832 
İts
.
s¦_û¹
 = 
NULL
;

11833 
İts
.
s¦_key
 = 
NULL
;

11834 
İts
.
s¦_ÿ_û¹
 = 
NULL
;

11836  
	`mg_tun_do_bšd
(
ş›Á
, 
hªdËr
, 
İts
);

11837 
	}
}

11839 
	$mg_tun_·r£_äame
(*
d©a
, 
size_t
 
Ën
, 
mg_tun_äame
 *
äame
) {

11840 cÚ¡ 
size_t
 
h—d”_size
 = (
ušt32_t
è+ (
ušt8_t
) * 2;

11841 ià(
Ën
 < 
h—d”_size
) {

11845 
äame
->
ty³
 = *(
ušt8_t
 *è(
d©a
);

11846 
äame
->
æags
 = *(
ušt8_t
 *è((*è
d©a
 + 1);

11847 
	`memıy
(&
äame
->
¡»am_id
, (*è
d©a
 + 2, (
ušt32_t
));

11848 
äame
->
¡»am_id
 = 
	`Áohl
(frame->stream_id);

11849 
äame
->
body
.
p
 = (*è
d©a
 + 
h—d”_size
;

11850 
äame
->
body
.
Ën
 =†’ - 
h—d”_size
;

11852 
	}
}

11854 
	$mg_tun_£nd_äame
(
mg_cÚÃùiÚ
 *
ws
, 
ušt32_t
 
¡»am_id
,

11855 
ušt8_t
 
ty³
, ušt8_ˆ
æags
, 
mg_¡r
 
msg
) {

11856 
¡»am_id
 = 
	`htÚl
(stream_id);

11858 
mg_¡r
 
·¹s
[] = {

11859 {(*è&
ty³
, (type)},

11860 {(*è&
æags
, (flags)},

11861 {(*è&
¡»am_id
, (stream_id)},

11862 {
msg
.
p
, msg.
Ën
} };

11863 
	`mg_£nd_websock‘_äamev
(
ws
, 
WEBSOCKET_OP_BINARY
, 
·¹s
,

11864 (
·¹s
) / (parts[0]));

11866 
	}
}

11869 #ifdeà
MG_MODULE_LINES


11881 #ià
MG_ENABLE_SNTP


11883 
	#SNTP_TIME_OFFSET
 2208988800

	)

11885 #iâdeà
SNTP_TIMEOUT


11886 
	#SNTP_TIMEOUT
 10

	)

11889 #iâdeà
SNTP_ATTEMPTS


11890 
	#SNTP_ATTEMPTS
 3

	)

11893 
ušt64_t
 
	$mg_g‘_£c
(
ušt64_t
 
v®
) {

11894  (
v®
 & 0xFFFFFFFF00000000) >> 32;

11895 
	}
}

11897 
ušt64_t
 
	$mg_g‘_u£c
(
ušt64_t
 
v®
) {

11898 
ušt64_t
 
tmp
 = (
v®
 & 0x00000000FFFFFFFF);

11899 
tmp
 *= 1000000;

11900 
tmp
 >>= 32;

11901  
tmp
;

11902 
	}
}

11904 
	$mg_Áp_to_tv
(
ušt64_t
 
v®
, 
timev®
 *
tv
) {

11905 
ušt64_t
 
tmp
;

11906 
tmp
 = 
	`mg_g‘_£c
(
v®
);

11907 
tmp
 -ğ
SNTP_TIME_OFFSET
;

11908 
tv
->
tv_£c
 = 
tmp
;

11909 
tv
->
tv_u£c
 = 
	`mg_g‘_u£c
(
v®
);

11910 
	}
}

11912 
	$mg_g‘_Áp_ts
(cÚ¡ *
Áp
, 
ušt64_t
 *
v®
) {

11913 
ušt32_t
 
tmp
;

11914 
	`memıy
(&
tmp
, 
Áp
, (tmp));

11915 
tmp
 = 
	`Áohl
(tmp);

11916 *
v®
 = (
ušt64_t
è
tmp
 << 32;

11917 
	`memıy
(&
tmp
, 
Áp
 + 4, (tmp));

11918 
tmp
 = 
	`Áohl
(tmp);

11919 *
v®
 |ğ
tmp
;

11920 
	}
}

11922 
	$mg_¢_£nd_»que¡
(
mg_cÚÃùiÚ
 *
c
) {

11923 
buf
[48] = {0};

11929 
buf
[0] = (3 << 6) | (4 << 3) | 3;

11951 #iâdeà
MG_SNMP_NO_DELAY_CORRECTION


11952 
ušt32_t
 
£c
;

11953 
£c
 = 
	`htÚl
(
	`mg_time
(è+ 
SNTP_TIME_OFFSET
);

11954 
	`memıy
(&
buf
[40], &
£c
, (sec));

11957 
	`mg_£nd
(
c
, 
buf
, (buf));

11958 
	}
}

11960 #iâdeà
MG_SNMP_NO_DELAY_CORRECTION


11961 
ušt64_t
 
	$mg_ÿlcuÏ‹_d–ay
(
ušt64_t
 
t1
, ušt64_ˆ
t2
, ušt64_ˆ
t3
) {

11963 
ušt64_t
 
d1
 = ((
	`mg_time
(è+ 
SNTP_TIME_OFFSET
) * 1000000) -

11964 (
	`mg_g‘_£c
(
t1
è* 1000000 + 
	`mg_g‘_u£c
(t1));

11965 
ušt64_t
 
d2
 = (
	`mg_g‘_£c
(
t3
è* 1000000 + 
	`mg_g‘_u£c
(t3)) -

11966 (
	`mg_g‘_£c
(
t2
è* 1000000 + 
	`mg_g‘_u£c
(t2));

11968  (
d1
 > 
d2
) ? d1 - d2 : 0;

11969 
	}
}

11972 
MG_INTERNAL
 
	$mg_¢_·r£_»¶y
(cÚ¡ *
buf
, 
Ën
,

11973 
mg_¢_mes§ge
 *
msg
) {

11974 
ušt8_t
 
hdr
;

11975 
ušt64_t
 
Üig_ts_T1
, 
»cv_ts_T2
, 
Œsm_ts_T3
, 
d–ay
 = 0;

11976 
mode
;

11977 
timev®
 
tv
;

11979 (è
Üig_ts_T1
;

11980 (è
»cv_ts_T2
;

11981 ià(
Ën
 < 48) {

11985 
hdr
 = 
buf
[0];

11987 ià((
hdr
 & 0x38) >> 3 != 4) {

11992 
mode
 = 
hdr
 & 0x7;

11993 ià(
mode
 != 4 && mode != 5) {

11998 
	`mem£t
(
msg
, 0, (*msg));

12000 
msg
->
kiss_of_d—th
 = (
buf
[1] == 0);

12002 
	`mg_g‘_Áp_ts
(&
buf
[40], &
Œsm_ts_T3
);

12004 #iâdeà
MG_SNMP_NO_DELAY_CORRECTION


12005 
	`mg_g‘_Áp_ts
(&
buf
[24], &
Üig_ts_T1
);

12006 
	`mg_g‘_Áp_ts
(&
buf
[32], &
»cv_ts_T2
);

12007 
d–ay
 = 
	`mg_ÿlcuÏ‹_d–ay
(
Üig_ts_T1
, 
»cv_ts_T2
, 
Œsm_ts_T3
);

12010 
	`mg_Áp_to_tv
(
Œsm_ts_T3
, &
tv
);

12012 
msg
->
time
 = (è
tv
.
tv_£c
 + (((ètv.
tv_u£c
 + 
d–ay
) / 1000000.0);

12015 
	}
}

12017 
	$mg_¢_hªdËr
(
mg_cÚÃùiÚ
 *
c
, 
ev
, *
ev_d©a
) {

12018 
mbuf
 *
io
 = &
c
->
»cv_mbuf
;

12019 
mg_¢_mes§ge
 
msg
;

12021 
c
->
	`hªdËr
(c, 
ev
, 
ev_d©a
);

12023 
ev
) {

12024 
MG_EV_RECV
: {

12025 ià(
	`mg_¢_·r£_»¶y
(
io
->
buf
, io->
Ën
, &
msg
) < 0) {

12026 
	`DBG
(("Inv®id SNTP…ack‘„eûived (%d)", (è
io
->
Ën
));

12027 
c
->
	`hªdËr
(c, 
MG_SNTP_MALFORMED_REPLY
, 
NULL
);

12029 
c
->
	`hªdËr
(c, 
MG_SNTP_REPLY
, (*è&
msg
);

12032 
	`mbuf_»move
(
io
, io->
Ën
);

12036 
	}
}

12038 
	$mg_£t_´ÙocŞ_¢
(
mg_cÚÃùiÚ
 *
c
) {

12039 ià((
c
->
æags
 & 
MG_F_UDP
) == 0) {

12043 
c
->
´Ùo_hªdËr
 = 
mg_¢_hªdËr
;

12046 
	}
}

12048 
mg_cÚÃùiÚ
 *
	$mg_¢_cÚÃù
(
mg_mgr
 *
mgr
,

12049 
mg_ev’t_hªdËr_t
 
ev’t_hªdËr
,

12050 cÚ¡ *
¢_£rv”_Çme
) {

12051 
mg_cÚÃùiÚ
 *
c
 = 
NULL
;

12052 
u¾
[100], *
p_u¾
 = url;

12053 cÚ¡ *
´Ùo
 = "", *
pÜt
 = "", *
tmp
;

12056 
tmp
 = 
	`¡rchr
(
¢_£rv”_Çme
, ':');

12057 ià(
tmp
 !ğ
NULL
 && *(tmp + 1) == '/') {

12058 
tmp
 = 
	`¡rchr
(tmp + 1, ':');

12061 ià(
tmp
 =ğ
NULL
) {

12062 
pÜt
 = ":123";

12066 ià(
	`¡ºcmp
(
¢_£rv”_Çme
, "udp://", 6) != 0) {

12067 
´Ùo
 = "udp://";

12070 
	`mg_a¥rštf
(&
p_u¾
, (
u¾
), "%s%s%s", 
´Ùo
, 
¢_£rv”_Çme
, 
pÜt
);

12072 
c
 = 
	`mg_cÚÃù
(
mgr
, 
p_u¾
, 
ev’t_hªdËr
);

12074 ià(
c
 =ğ
NULL
) {

12075 
ş—nup
;

12078 
	`mg_£t_´ÙocŞ_¢
(
c
);

12080 
ş—nup
:

12081 ià(
p_u¾
 !ğ
u¾
) {

12082 
	`MG_FREE
(
p_u¾
);

12085  
c
;

12086 
	}
}

12088 
	s¢_d©a
 {

12089 
mg_ev’t_hªdËr_t
 
	mhªd”
;

12090 
	mcouÁ
;

12093 
	$mg_¢_ut_ev_hªdËr
(
mg_cÚÃùiÚ
 *
c
, 
ev
,

12094 *
ev_d©a
) {

12095 
¢_d©a
 *
sd
 = (¢_d©¨*è
c
->
u£r_d©a
;

12097 
ev
) {

12098 
MG_EV_CONNECT
:

12099 ià(*(*è
ev_d©a
 != 0) {

12100 
	`mg_ÿÎ
(
c
, 
sd
->
hªd”
, 
MG_SNTP_FAILED
, 
NULL
);

12104 
MG_EV_TIMER
:

12105 ià(
sd
->
couÁ
 <ğ
SNTP_ATTEMPTS
) {

12106 
	`mg_¢_£nd_»que¡
(
c
);

12107 
	`mg_£t_tim”
(
c
, 
	`mg_time
() + 10);

12108 
sd
->
couÁ
++;

12110 
	`mg_ÿÎ
(
c
, 
sd
->
hªd”
, 
MG_SNTP_FAILED
, 
NULL
);

12111 
c
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

12114 
MG_SNTP_MALFORMED_REPLY
:

12115 
	`mg_ÿÎ
(
c
, 
sd
->
hªd”
, 
MG_SNTP_FAILED
, 
NULL
);

12116 
c
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

12118 
MG_SNTP_REPLY
:

12119 
	`mg_ÿÎ
(
c
, 
sd
->
hªd”
, 
MG_SNTP_REPLY
, 
ev_d©a
);

12120 
c
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

12122 
MG_EV_CLOSE
:

12123 
	`MG_FREE
(
c
->
u£r_d©a
);

12124 
c
->
u£r_d©a
 = 
NULL
;

12127 
	}
}

12129 
mg_cÚÃùiÚ
 *
	$mg_¢_g‘_time
(
mg_mgr
 *
mgr
,

12130 
mg_ev’t_hªdËr_t
 
ev’t_hªdËr
,

12131 cÚ¡ *
¢_£rv”_Çme
) {

12132 
mg_cÚÃùiÚ
 *
c
;

12133 
¢_d©a
 *
sd
 = (¢_d©¨*è
	`MG_CALLOC
(1, (*sd));

12134 ià(
sd
 =ğ
NULL
) {

12135  
NULL
;

12138 
c
 = 
	`mg_¢_cÚÃù
(
mgr
, 
mg_¢_ut_ev_hªdËr
, 
¢_£rv”_Çme
);

12139 ià(
c
 =ğ
NULL
) {

12140 
	`MG_FREE
(
sd
);

12141  
NULL
;

12144 
sd
->
hªd”
 = 
ev’t_hªdËr
;

12145 
c
->
u£r_d©a
 = 
sd
;

12147  
c
;

12148 
	}
}

12151 #ifdeà
MG_MODULE_LINES


12159 #ià
CS_PLATFORM
 =ğ
CS_P_CC3200


12161 
	~<¡dio.h
>

12162 
	~<¡ršg.h
>

12164 #iâdeà
__TI_COMPILER_VERSION__


12165 
	~<»’t.h
>

12166 
	~<sys/¡©.h
>

12167 
	~<sys/time.h
>

12168 
	~<uni¡d.h
>

12171 
	~<šc/hw_ty³s.h
>

12172 
	~<šc/hw_memm­.h
>

12173 
	~<driv”lib/´cm.h
>

12174 
	~<driv”lib/rom.h
>

12175 
	~<driv”lib/rom_m­.h
>

12176 
	~<driv”lib/u¬t.h
>

12177 
	~<driv”lib/uts.h
>

12179 
	#CONSOLE_UART
 
UARTA0_BASE


	)

12181 #ifdeà
__TI_COMPILER_VERSION__


12182 
	$a¥rštf
(**
¡½
, cÚ¡ *
fmt
, ...) {

12183 
va_li¡
 
­
;

12184 
Ën
;

12186 *
¡½
 = 
	`m®loc
(
BUFSIZ
);

12187 ià(*
¡½
 =ğ
NULL
)  -1;

12189 
	`va_¡¬t
(
­
, 
fmt
);

12190 
Ën
 = 
	`v¢´štf
(*
¡½
, 
BUFSIZ
, 
fmt
, 
­
);

12191 
	`va_’d
(
­
);

12193 ià(
Ën
 > 0) {

12194 *
¡½
 = 
	`»®loc
(*¡½, 
Ën
 + 1);

12195 ià(*
¡½
 =ğ
NULL
)  -1;

12198 ià(
Ën
 >ğ
BUFSIZ
) {

12199 
	`va_¡¬t
(
­
, 
fmt
);

12200 
Ën
 = 
	`v¢´štf
(*
¡½
,†’ + 1, 
fmt
, 
­
);

12201 
	`va_’d
(
­
);

12204  
Ën
;

12205 
	}
}

12207 #ià
MG_TI_NO_HOST_INTERFACE


12208 
time_t
 
	$HOSTtime
() {

12209 
timev®
 

;

12210 
	`g‘timeofday
(&

, 
NULL
);

12211  

.
tv_£c
;

12212 
	}
}

12217 #iâdeà
__TI_COMPILER_VERSION__


12218 
	$_g‘timeofday_r
(
_»’t
 *
r
, 
timev®
 *

, *
tzp
) {

12220 
	$g‘timeofday
(
timev®
 *

, *
tzp
) {

12222 
r1
 = 0, 
r2
;

12225 
r2
 = 
r1
;

12226 
r1
 = 
	`PRCMSlowClkCŒFa¡G‘
();

12227 } 
r1
 !ğ
r2
);

12229 

->
tv_£c
 = (
r1
 >> 15);

12232 

->
tv_u£c
 = (
r1
 & 0x7FFF) * 30;

12234 
	}
}

12236 
	$åršt_¡r
(
FILE
 *
å
, cÚ¡ *
¡r
) {

12237 *
¡r
 != '\0') {

12238 ià(*
¡r
 =ğ'\n'è
	`MAP_UARTCh¬Put
(
CONSOLE_UART
, '\r');

12239 
	`MAP_UARTCh¬Put
(
CONSOLE_UART
, *
¡r
++);

12241 
	}
}

12243 
	$_ex™
(
¡©us
) {

12244 
	`åršt_¡r
(
¡d”r
, "_exit\n");

12246 *(*è1 = 
¡©us
;

12249 
	}
}

12251 
	$_nÙ_im¶em’‹d
(cÚ¡ *
wh©
) {

12252 
	`åršt_¡r
(
¡d”r
, 
wh©
);

12253 
	`åršt_¡r
(
¡d”r
, " is‚ot implemented\n");

12254 
	`_ex™
(42);

12255 
	}
}

12257 
	$_kl
(
pid
, 
sig
) {

12258 (è
pid
;

12259 (è
sig
;

12260 
	`_nÙ_im¶em’‹d
("_kill");

12262 
	}
}

12264 
	$_g‘pid
() {

12265 
	`åršt_¡r
(
¡d”r
, "_getpid is‚ot implemented\n");

12267 
	}
}

12269 
	$_i§‰y
(
fd
) {

12271  
fd
 < 2;

12272 
	}
}

12275 #ifdeà
MG_MODULE_LINES


12283 #ià
CS_PLATFORM
 =ğ
CS_P_MSP432


12285 
	~<ti/sysbios/BIOS.h
>

12286 
	~<ti/sysbios/kÆ/Clock.h
>

12288 
	$g‘timeofday
(
timev®
 *

, *
tzp
) {

12289 
ušt32_t
 
ticks
 = 
	`Clock_g‘Ticks
();

12290 

->
tv_£c
 = 
ticks
 / 1000;

12291 

->
tv_u£c
 = (
ticks
 % 1000) * 1000;

12293 
	}
}

12296 #ifdeà
MG_MODULE_LINES


12304 #ià(
CS_PLATFORM
 =ğ
CS_P_NRF51
 || CS_PLATFORM =ğ
CS_P_NRF52
) && \

12305 
	$defšed
(
__ARMCC_VERSION
)

12306 
	$g‘timeofday
(
timev®
 *

, *
tzp
) {

12308 

->
tv_£c
 = 0;

12309 

->
tv_u£c
 = 0;

12311 
	}
}

12313 #ifdeà
MG_MODULE_LINES


12321 #iâdeà
CS_COMMON_PLATFORMS_SIMPLELINK_SL_FS_SLFS_H_


12322 
	#CS_COMMON_PLATFORMS_SIMPLELINK_SL_FS_SLFS_H_


	)

12324 #ià
defšed
(
MG_FS_SLFS
)

12326 
	~<¡dio.h
>

12327 #iâdeà
__TI_COMPILER_VERSION__


12328 
	~<uni¡d.h
>

12329 
	~<sys/¡©.h
>

12332 
	#MAX_OPEN_SLFS_FILES
 8

	)

12335 
fs_¦fs_İ’
(cÚ¡ *
·thÇme
, 
æags
, 
mode_t
 
mode
);

12336 
fs_¦fs_şo£
(
fd
);

12337 
ssize_t
 
fs_¦fs_»ad
(
fd
, *
buf
, 
size_t
 
couÁ
);

12338 
ssize_t
 
fs_¦fs_wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

12339 
fs_¦fs_¡©
(cÚ¡ *
·thÇme
, 
¡©
 *
s
);

12340 
fs_¦fs_f¡©
(
fd
, 
¡©
 *
s
);

12341 
off_t
 
fs_¦fs_l£ek
(
fd
, off_ˆ
off£t
, 
wh’û
);

12342 
fs_¦fs_uÆšk
(cÚ¡ *
f’ame
);

12343 
fs_¦fs_»Çme
(cÚ¡ *
äom
, cÚ¡ *
to
);

12345 
fs_¦fs_£t_Ãw_fe_size
(cÚ¡ *
Çme
, 
size_t
 
size
);

12350 #ifdeà
MG_MODULE_LINES


12360 #ià
defšed
(
MG_FS_SLFS
è|| defšed(
CC3200_FS_SLFS
)

12364 
	~<”ºo.h
>

12366 #ià
CS_PLATFORM
 =ğ
CS_P_CC3200


12367 
	~<šc/hw_ty³s.h
>

12369 
	~<sim¶–šk/šşude/sim¶–šk.h
>

12370 
	~<sim¶–šk/šşude/fs.h
>

12375 
£t_”ºo
(
e
);

12376 cÚ¡ *
drİ_dœ
(cÚ¡ *
âame
, 
boŞ
 *
is_¦fs
);

12382 #iâdeà
FS_SLFS_MAX_FILE_SIZE


12383 
	#FS_SLFS_MAX_FILE_SIZE
 (64 * 1024)

	)

12386 
	s¦_fe_size_hšt
 {

12387 *
	mÇme
;

12388 
size_t
 
	msize
;

12391 
	s¦_fd_šfo
 {

12392 
_i32
 
	mfh
;

12393 
_off_t
 
	mpos
;

12394 
size_t
 
	msize
;

12397 
¦_fd_šfo
 
	gs_¦_fds
[
MAX_OPEN_SLFS_FILES
];

12398 
¦_fe_size_hšt
 
	gs_¦_fe_size_hšts
[
MAX_OPEN_SLFS_FILES
];

12400 
	$¦_fs_to_”ºo
(
_i32
 
r
) {

12401 
	`DBG
(("SLƒ¼Ü: %d", (è
r
));

12402 
r
) {

12403 
SL_FS_OK
:

12405 
SL_FS_FILE_NAME_EXIST
:

12406  
EEXIST
;

12407 
SL_FS_WRONG_FILE_NAME
:

12408  
EINVAL
;

12409 
SL_FS_ERR_NO_AVAILABLE_NV_INDEX
:

12410 
SL_FS_ERR_NO_AVAILABLE_BLOCKS
:

12411  
ENOSPC
;

12412 
SL_FS_ERR_FAILED_TO_ALLOCATE_MEM
:

12413  
ENOMEM
;

12414 
SL_FS_ERR_FILE_NOT_EXISTS
:

12415  
ENOENT
;

12416 
SL_FS_ERR_NOT_SUPPORTED
:

12417  
ENOTSUP
;

12419  
ENXIO
;

12420 
	}
}

12422 
	$fs_¦fs_İ’
(cÚ¡ *
·thÇme
, 
æags
, 
mode_t
 
mode
) {

12423 
fd
;

12424 
fd
 = 0; fd < 
MAX_OPEN_SLFS_FILES
; fd++) {

12425 ià(
s_¦_fds
[
fd
].
fh
 <= 0) ;

12427 ià(
fd
 >ğ
MAX_OPEN_SLFS_FILES
è 
	`£t_”ºo
(
ENOMEM
);

12428 
¦_fd_šfo
 *
fi
 = &
s_¦_fds
[
fd
];

12434 
·thÇme
 = 
	`drİ_dœ
Õ©hÇme, 
NULL
);

12436 
_u32
 
am
 = 0;

12437 
fi
->
size
 = (
size_t
) -1;

12438 
rw
 = (
æags
 & 3);

12439 ià(
rw
 =ğ
O_RDONLY
) {

12440 
SlFsFeInfo_t
 
¦_fi
;

12441 
_i32
 
r
 = 
	`¦_FsG‘Info
((cÚ¡ 
_u8
 *è
·thÇme
, 0, &
¦_fi
);

12442 ià(
r
 =ğ
SL_FS_OK
) {

12443 
fi
->
size
 = 
¦_fi
.
FeL’
;

12445 
am
 = 
FS_MODE_OPEN_READ
;

12447 ià(!(
æags
 & 
O_TRUNC
è|| (æag & 
O_APPEND
)) {

12450  
	`£t_”ºo
(
ENOTSUP
);

12452 ià(
æags
 & 
O_CREAT
) {

12453 
size_t
 
i
, 
size
 = 
FS_SLFS_MAX_FILE_SIZE
;

12454 
i
 = 0; i < 
MAX_OPEN_SLFS_FILES
; i++) {

12455 ià(
s_¦_fe_size_hšts
[
i
].
Çme
 !ğ
NULL
 &&

12456 
	`¡rcmp
(
s_¦_fe_size_hšts
[
i
].
Çme
, 
·thÇme
) == 0) {

12457 
size
 = 
s_¦_fe_size_hšts
[
i
].size;

12458 
	`ä“
(
s_¦_fe_size_hšts
[
i
].
Çme
);

12459 
s_¦_fe_size_hšts
[
i
].
Çme
 = 
NULL
;

12463 
	`DBG
(("ü—tšg % w™h max siz%d", 
·thÇme
, (è
size
));

12464 
am
 = 
	`FS_MODE_OPEN_CREATE
(
size
, 0);

12466 
am
 = 
FS_MODE_OPEN_WRITE
;

12469 
_i32
 
r
 = 
	`¦_FsO³n
((
_u8
 *è
·thÇme
, 
am
, 
NULL
, &
fi
->
fh
);

12470 
	`DBG
(("¦_FsO³n(%s, 0x%xèğ%d, %d", 
·thÇme
, (è
am
, (è
r
,

12471 (è
fi
->
fh
));

12472 ià(
r
 =ğ
SL_FS_OK
) {

12473 
fi
->
pos
 = 0;

12474 
r
 = 
fd
;

12476 
fi
->
fh
 = -1;

12477 
r
 = 
	`£t_”ºo
(
	`¦_fs_to_”ºo
(r));

12479  
r
;

12480 
	}
}

12482 
	$fs_¦fs_şo£
(
fd
) {

12483 
¦_fd_šfo
 *
fi
 = &
s_¦_fds
[
fd
];

12484 ià(
fi
->
fh
 <ğ0è 
	`£t_”ºo
(
EBADF
);

12485 
_i32
 
r
 = 
	`¦_FsClo£
(
fi
->
fh
, 
NULL
, NULL, 0);

12486 
	`DBG
(("¦_FsClo£(%dèğ%d", (è
fi
->
fh
, (è
r
));

12487 
s_¦_fds
[
fd
].
fh
 = -1;

12488  
	`£t_”ºo
(
	`¦_fs_to_”ºo
(
r
));

12489 
	}
}

12491 
ssize_t
 
	$fs_¦fs_»ad
(
fd
, *
buf
, 
size_t
 
couÁ
) {

12492 
¦_fd_šfo
 *
fi
 = &
s_¦_fds
[
fd
];

12493 ià(
fi
->
fh
 <ğ0è 
	`£t_”ºo
(
EBADF
);

12496 ià(
fi
->
pos
 =ğfi->
size
)  0;

12497 
_i32
 
r
 = 
	`¦_FsR—d
(
fi
->
fh
, fi->
pos
, 
buf
, 
couÁ
);

12498 
	`DBG
(("¦_FsR—d(%d, %d, %dèğ%d", (è
fi
->
fh
, (èfi->
pos
, (è
couÁ
,

12499 (è
r
));

12500 ià(
r
 >= 0) {

12501 
fi
->
pos
 +ğ
r
;

12502  
r
;

12504  
	`£t_”ºo
(
	`¦_fs_to_”ºo
(
r
));

12505 
	}
}

12507 
ssize_t
 
	$fs_¦fs_wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
) {

12508 
¦_fd_šfo
 *
fi
 = &
s_¦_fds
[
fd
];

12509 ià(
fi
->
fh
 <ğ0è 
	`£t_”ºo
(
EBADF
);

12510 
_i32
 
r
 = 
	`¦_FsWr™e
(
fi
->
fh
, fi->
pos
, (
_u8
 *è
buf
, 
couÁ
);

12511 
	`DBG
(("¦_FsWr™e(%d, %d, %dèğ%d", (è
fi
->
fh
, (èfi->
pos
, (è
couÁ
,

12512 (è
r
));

12513 ià(
r
 >= 0) {

12514 
fi
->
pos
 +ğ
r
;

12515  
r
;

12517  
	`£t_”ºo
(
	`¦_fs_to_”ºo
(
r
));

12518 
	}
}

12520 
	$fs_¦fs_¡©
(cÚ¡ *
·thÇme
, 
¡©
 *
s
) {

12521 
SlFsFeInfo_t
 
¦_fi
;

12526 
·thÇme
 = 
	`drİ_dœ
Õ©hÇme, 
NULL
);

12527 
_i32
 
r
 = 
	`¦_FsG‘Info
((cÚ¡ 
_u8
 *è
·thÇme
, 0, &
¦_fi
);

12528 ià(
r
 =ğ
SL_FS_OK
) {

12529 
s
->
¡_mode
 = 
S_IFREG
 | 0666;

12530 
s
->
¡_Æšk
 = 1;

12531 
s
->
¡_size
 = 
¦_fi
.
FeL’
;

12534  
	`£t_”ºo
(
	`¦_fs_to_”ºo
(
r
));

12535 
	}
}

12537 
	$fs_¦fs_f¡©
(
fd
, 
¡©
 *
s
) {

12538 
¦_fd_šfo
 *
fi
 = &
s_¦_fds
[
fd
];

12539 ià(
fi
->
fh
 <ğ0è 
	`£t_”ºo
(
EBADF
);

12540 
s
->
¡_mode
 = 0666;

12541 
s
->
¡_mode
 = 
S_IFREG
 | 0666;

12542 
s
->
¡_Æšk
 = 1;

12543 
s
->
¡_size
 = 
fi
->
size
;

12545 
	}
}

12547 
off_t
 
	$fs_¦fs_l£ek
(
fd
, 
off_t
 
off£t
, 
wh’û
) {

12548 ià(
s_¦_fds
[
fd
].
fh
 <ğ0è 
	`£t_”ºo
(
EBADF
);

12549 
wh’û
) {

12550 
SEEK_SET
:

12551 
s_¦_fds
[
fd
].
pos
 = 
off£t
;

12553 
SEEK_CUR
:

12554 
s_¦_fds
[
fd
].
pos
 +ğ
off£t
;

12556 
SEEK_END
:

12557  
	`£t_”ºo
(
ENOTSUP
);

12560 
	}
}

12562 
	$fs_¦fs_uÆšk
(cÚ¡ *
·thÇme
) {

12567 
·thÇme
 = 
	`drİ_dœ
Õ©hÇme, 
NULL
);

12568  
	`£t_”ºo
(
	`¦_fs_to_”ºo
(
	`¦_FsD–
((cÚ¡ 
_u8
 *è
·thÇme
, 0)));

12569 
	}
}

12571 
	$fs_¦fs_»Çme
(cÚ¡ *
äom
, cÚ¡ *
to
) {

12572  
	`£t_”ºo
(
ENOTSUP
);

12573 
	}
}

12575 
	$fs_¦fs_£t_Ãw_fe_size
(cÚ¡ *
Çme
, 
size_t
 
size
) {

12576 
i
;

12577 
i
 = 0; i < 
MAX_OPEN_SLFS_FILES
; i++) {

12578 ià(
s_¦_fe_size_hšts
[
i
].
Çme
 =ğ
NULL
) {

12579 
	`DBG
(("Fsizhšt: % %d", 
Çme
, (è
size
));

12580 
s_¦_fe_size_hšts
[
i
].
Çme
 = 
	`¡rdup
(name);

12581 
s_¦_fe_size_hšts
[
i
].
size
 = size;

12585 
	}
}

12588 #ifdeà
MG_MODULE_LINES


12596 #ià
MG_NET_IF
 =ğ
MG_NET_IF_SIMPLELINK
 && \

12597 (
defšed
(
MG_FS_SLFS
è|| 
	$defšed
(
MG_FS_SPIFFS
))

12599 
	~<”ºo.h
>

12600 
	~<¡dboŞ.h
>

12601 
	~<¡dio.h
>

12602 
	~<¡dlib.h
>

12603 
	~<¡ršg.h
>

12604 #ifdeà
__TI_COMPILER_VERSION__


12605 
	~<fe.h
>

12611 #ifdeà
CC3200_FS_SPIFFS


12615 #ifdeà
MG_FS_SLFS


12619 
	#NUM_SYS_FDS
 3

	)

12620 
	#SPIFFS_FD_BASE
 10

	)

12621 
	#SLFS_FD_BASE
 100

	)

12623 #iâdeà
MG_UART_CHAR_PUT


12624 #ià
CS_PLATFORM
 =ğ
CS_P_CC3200


12625 
	~<šc/hw_ty³s.h
>

12626 
	~<šc/hw_memm­.h
>

12627 
	~<driv”lib/rom.h
>

12628 
	~<driv”lib/rom_m­.h
>

12629 
	~<driv”lib/u¬t.h
>

12630 
	#MG_UART_CHAR_PUT
(
fd
, 
c
è
	`MAP_UARTCh¬Put
(
UARTA0_BASE
, c);

	)

12632 
	#MG_UART_CHAR_PUT
(
fd
, 
c
)

	)

12636 
	$£t_”ºo
(
e
) {

12637 
”ºo
 = 
e
;

12638  (
e
 == 0 ? 0 : -1);

12639 
	}
}

12641 cÚ¡ *
	$drİ_dœ
(cÚ¡ *
âame
, 
boŞ
 *
is_¦fs
) {

12642 ià(
is_¦fs
 !ğ
NULL
) {

12643 *
is_¦fs
 = (
	`¡ºcmp
(
âame
, "SL:", 3) == 0);

12644 ià(*
is_¦fs
è
âame
 += 3;

12647 ià(
âame
[0] == '.' && fname[1] == '/') {

12648 
âame
 += 2;

12654 ià(
âame
[0] =ğ'/' && 
	`¡rchr
(âam+ 1, '/'è=ğ
NULL
) {

12655 
âame
++;

12657  
âame
;

12658 
	}
}

12660 
	efd_ty³
 {

12661 
	mFD_INVALID
,

12662 
	mFD_SYS
,

12663 #ifdeà
CC3200_FS_SPIFFS


12664 
	mFD_SPIFFS
,

12666 #ifdeà
MG_FS_SLFS


12667 
	mFD_SLFS


12670 
	$fd_ty³
(
fd
) {

12671 ià(
fd
 >ğ0 && fd < 
NUM_SYS_FDS
è 
FD_SYS
;

12672 #ifdeà
CC3200_FS_SPIFFS


12673 ià(
fd
 >ğ
SPIFFS_FD_BASE
 && fd < SPIFFS_FD_BASE + 
MAX_OPEN_SPIFFS_FILES
) {

12674  
FD_SPIFFS
;

12677 #ifdeà
MG_FS_SLFS


12678 ià(
fd
 >ğ
SLFS_FD_BASE
 && fd < SLFS_FD_BASE + 
MAX_OPEN_SLFS_FILES
) {

12679  
FD_SLFS
;

12682  
FD_INVALID
;

12683 
	}
}

12685 #ià
MG_TI_NO_HOST_INTERFACE


12686 
	$İ’
(cÚ¡ *
·thÇme
, 
æags
, 
mode
) {

12688 
	$_İ’
(cÚ¡ *
·thÇme
, 
æags
, 
mode_t
 
mode
) {

12690 
fd
 = -1;

12691 
boŞ
 
is_¦
;

12692 cÚ¡ *
âame
 = 
	`drİ_dœ
(
·thÇme
, &
is_¦
);

12693 ià(
is_¦
) {

12694 #ifdeà
MG_FS_SLFS


12695 
fd
 = 
	`fs_¦fs_İ’
(
âame
, 
æags
, 
mode
);

12696 ià(
fd
 >ğ0èfd +ğ
SLFS_FD_BASE
;

12699 #ifdeà
CC3200_FS_SPIFFS


12700 
fd
 = 
	`fs_¥iffs_İ’
(
âame
, 
æags
, 
mode
);

12701 ià(
fd
 >ğ0èfd +ğ
SPIFFS_FD_BASE
;

12704 
	`LOG
(
LL_DEBUG
,

12705 ("İ’(%s, 0x%xèğ%d, fÇmğ%s", 
·thÇme
, 
æags
, 
fd
, 
âame
));

12706  
fd
;

12707 
	}
}

12709 
	$_¡©
(cÚ¡ *
·thÇme
, 
¡©
 *
¡
) {

12710 
»s
 = -1;

12711 
boŞ
 
is_¦
;

12712 cÚ¡ *
âame
 = 
	`drİ_dœ
(
·thÇme
, &
is_¦
);

12713 
	`mem£t
(
¡
, 0, (*st));

12715 ià(
âame
[0] =ğ'\0' || 
	`¡rcmp
(fname, ".") == 0) {

12716 
¡
->
¡_šo
 = 0;

12717 
¡
->
¡_mode
 = 
S_IFDIR
 | 0777;

12718 
¡
->
¡_Æšk
 = 1;

12719 
¡
->
¡_size
 = 0;

12722 ià(
is_¦
) {

12723 #ifdeà
MG_FS_SLFS


12724 
»s
 = 
	`fs_¦fs_¡©
(
âame
, 
¡
);

12727 #ifdeà
CC3200_FS_SPIFFS


12728 
»s
 = 
	`fs_¥iffs_¡©
(
âame
, 
¡
);

12731 
	`LOG
(
LL_DEBUG
, ("¡©(%sèğ%d; fÇmğ%s", 
·thÇme
, 
»s
, 
âame
));

12732  
»s
;

12733 
	}
}

12735 #ià
MG_TI_NO_HOST_INTERFACE


12736 
	$şo£
(
fd
) {

12738 
	$_şo£
(
fd
) {

12740 
r
 = -1;

12741 
	`fd_ty³
(
fd
)) {

12742 
FD_INVALID
:

12743 
r
 = 
	`£t_”ºo
(
EBADF
);

12745 
FD_SYS
:

12746 
r
 = 
	`£t_”ºo
(
EACCES
);

12748 #ifdeà
CC3200_FS_SPIFFS


12749 
FD_SPIFFS
:

12750 
r
 = 
	`fs_¥iffs_şo£
(
fd
 - 
SPIFFS_FD_BASE
);

12753 #ifdeà
MG_FS_SLFS


12754 
FD_SLFS
:

12755 
r
 = 
	`fs_¦fs_şo£
(
fd
 - 
SLFS_FD_BASE
);

12759 
	`DBG
(("şo£(%dèğ%d", 
fd
, 
r
));

12760  
r
;

12761 
	}
}

12763 #ià
MG_TI_NO_HOST_INTERFACE


12764 
off_t
 
	$l£ek
(
fd
, 
off_t
 
off£t
, 
wh’û
) {

12766 
off_t
 
	$_l£ek
(
fd
, 
off_t
 
off£t
, 
wh’û
) {

12768 
r
 = -1;

12769 
	`fd_ty³
(
fd
)) {

12770 
FD_INVALID
:

12771 
r
 = 
	`£t_”ºo
(
EBADF
);

12773 
FD_SYS
:

12774 
r
 = 
	`£t_”ºo
(
ESPIPE
);

12776 #ifdeà
CC3200_FS_SPIFFS


12777 
FD_SPIFFS
:

12778 
r
 = 
	`fs_¥iffs_l£ek
(
fd
 - 
SPIFFS_FD_BASE
, 
off£t
, 
wh’û
);

12781 #ifdeà
MG_FS_SLFS


12782 
FD_SLFS
:

12783 
r
 = 
	`fs_¦fs_l£ek
(
fd
 - 
SLFS_FD_BASE
, 
off£t
, 
wh’û
);

12787 
	`DBG
(("l£ek(%d, %d, %dèğ%d", 
fd
, (è
off£t
, 
wh’û
, 
r
));

12788  
r
;

12789 
	}
}

12791 
	$_f¡©
(
fd
, 
¡©
 *
s
) {

12792 
r
 = -1;

12793 
	`mem£t
(
s
, 0, (*s));

12794 
	`fd_ty³
(
fd
)) {

12795 
FD_INVALID
:

12796 
r
 = 
	`£t_”ºo
(
EBADF
);

12798 
FD_SYS
: {

12800 
	`mem£t
(
s
, 0, (*s));

12801 
s
->
¡_šo
 = 
fd
;

12802 
s
->
¡_mode
 = 
S_IFCHR
 | 0666;

12803 
r
 = 0;

12806 #ifdeà
CC3200_FS_SPIFFS


12807 
FD_SPIFFS
:

12808 
r
 = 
	`fs_¥iffs_f¡©
(
fd
 - 
SPIFFS_FD_BASE
, 
s
);

12811 #ifdeà
MG_FS_SLFS


12812 
FD_SLFS
:

12813 
r
 = 
	`fs_¦fs_f¡©
(
fd
 - 
SLFS_FD_BASE
, 
s
);

12817 
	`DBG
(("f¡©(%dèğ%d", 
fd
, 
r
));

12818  
r
;

12819 
	}
}

12821 #ià
MG_TI_NO_HOST_INTERFACE


12822 
	$»ad
(
fd
, *
buf
, 
couÁ
) {

12824 
ssize_t
 
	$_»ad
(
fd
, *
buf
, 
size_t
 
couÁ
) {

12826 
r
 = -1;

12827 
	`fd_ty³
(
fd
)) {

12828 
FD_INVALID
:

12829 
r
 = 
	`£t_”ºo
(
EBADF
);

12831 
FD_SYS
: {

12832 ià(
fd
 != 0) {

12833 
r
 = 
	`£t_”ºo
(
EACCES
);

12837 
r
 = 
	`£t_”ºo
(
ENOTSUP
);

12840 #ifdeà
CC3200_FS_SPIFFS


12841 
FD_SPIFFS
:

12842 
r
 = 
	`fs_¥iffs_»ad
(
fd
 - 
SPIFFS_FD_BASE
, 
buf
, 
couÁ
);

12845 #ifdeà
MG_FS_SLFS


12846 
FD_SLFS
:

12847 
r
 = 
	`fs_¦fs_»ad
(
fd
 - 
SLFS_FD_BASE
, 
buf
, 
couÁ
);

12851 
	`DBG
(("»ad(%d, %uèğ%d", 
fd
, 
couÁ
, 
r
));

12852  
r
;

12853 
	}
}

12855 #ià
MG_TI_NO_HOST_INTERFACE


12856 
	$wr™e
(
fd
, cÚ¡ *
buf
, 
couÁ
) {

12858 
ssize_t
 
	$_wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
) {

12860 
r
 = -1;

12861 
size_t
 
i
 = 0;

12862 
	`fd_ty³
(
fd
)) {

12863 
FD_INVALID
:

12864 
r
 = 
	`£t_”ºo
(
EBADF
);

12866 
FD_SYS
: {

12867 ià(
fd
 == 0) {

12868 
r
 = 
	`£t_”ºo
(
EACCES
);

12871 
i
 = 0; i < 
couÁ
; i++) {

12872 cÚ¡ 
c
 = ((cÚ¡ *è
buf
)[
i
];

12873 ià(
c
 =ğ'\n'è
	`MG_UART_CHAR_PUT
(
fd
, '\r');

12874 
	`MG_UART_CHAR_PUT
(
fd
, 
c
);

12876 
r
 = 
couÁ
;

12879 #ifdeà
CC3200_FS_SPIFFS


12880 
FD_SPIFFS
:

12881 
r
 = 
	`fs_¥iffs_wr™e
(
fd
 - 
SPIFFS_FD_BASE
, 
buf
, 
couÁ
);

12884 #ifdeà
MG_FS_SLFS


12885 
FD_SLFS
:

12886 
r
 = 
	`fs_¦fs_wr™e
(
fd
 - 
SLFS_FD_BASE
, 
buf
, 
couÁ
);

12890  
r
;

12891 
	}
}

12897 #ià
MG_TI_NO_HOST_INTERFACE
 || 
defšed
(
_NEWLIB_VERSION
)

12898 
	$»Çme
(cÚ¡ *
äom·th
, cÚ¡ *
tİ©h
) {

12899 
r
 = -1;

12900 
boŞ
 
is_¦_äom
, 
is_¦_to
;

12901 cÚ¡ *
äom
 = 
	`drİ_dœ
(
äom·th
, &
is_¦_äom
);

12902 cÚ¡ *
to
 = 
	`drİ_dœ
(
tİ©h
, &
is_¦_to
);

12903 ià(
is_¦_äom
 || 
is_¦_to
) {

12904 
	`£t_”ºo
(
ENOTSUP
);

12906 #ifdeà
CC3200_FS_SPIFFS


12907 
r
 = 
	`fs_¥iffs_»Çme
(
äom
, 
to
);

12910 
	`DBG
(("»Çme(%s, %sèğ%d", 
äom
, 
to
, 
r
));

12911  
r
;

12912 
	}
}

12915 #ià
MG_TI_NO_HOST_INTERFACE


12916 
	$uÆšk
(cÚ¡ *
·thÇme
) {

12918 
	$_uÆšk
(cÚ¡ *
·thÇme
) {

12920 
r
 = -1;

12921 
boŞ
 
is_¦
;

12922 cÚ¡ *
âame
 = 
	`drİ_dœ
(
·thÇme
, &
is_¦
);

12923 ià(
is_¦
) {

12924 #ifdeà
MG_FS_SLFS


12925 
r
 = 
	`fs_¦fs_uÆšk
(
âame
);

12928 #ifdeà
CC3200_FS_SPIFFS


12929 
r
 = 
	`fs_¥iffs_uÆšk
(
âame
);

12932 
	`DBG
(("uÆšk(%sèğ%d, fÇmğ%s", 
·thÇme
, 
r
, 
âame
));

12933  
r
;

12934 
	}
}

12936 #ifdeà
CC3200_FS_SPIFFS


12937 
DIR
 *
	$İ’dœ
(cÚ¡ *
dœ_Çme
) {

12938 
DIR
 *
r
 = 
NULL
;

12939 
boŞ
 
is_¦
;

12940 
	`drİ_dœ
(
dœ_Çme
, &
is_¦
);

12941 ià(
is_¦
) {

12942 
r
 = 
NULL
;

12943 
	`£t_”ºo
(
ENOTSUP
);

12945 
r
 = 
	`fs_¥iffs_İ’dœ
(
dœ_Çme
);

12947 
	`DBG
(("İ’dœ(%sèğ%p", 
dœ_Çme
, 
r
));

12948  
r
;

12949 
	}
}

12951 
dœ’t
 *
	$»addœ
(
DIR
 *
dœ
) {

12952 
dœ’t
 *
»s
 = 
	`fs_¥iffs_»addœ
(
dœ
);

12953 
	`DBG
(("»addœ(%pèğ%p", 
dœ
, 
»s
));

12954  
»s
;

12955 
	}
}

12957 
	$şo£dœ
(
DIR
 *
dœ
) {

12958 
»s
 = 
	`fs_¥iffs_şo£dœ
(
dœ
);

12959 
	`DBG
(("şo£dœ(%pèğ%d", 
dœ
, 
»s
));

12960  
»s
;

12961 
	}
}

12963 
	$rmdœ
(cÚ¡ *
·th
) {

12964  
	`fs_¥iffs_rmdœ
(
·th
);

12965 
	}
}

12967 
	$mkdœ
(cÚ¡ *
·th
, 
mode_t
 
mode
) {

12968 (è
·th
;

12969 (è
mode
;

12971  (
	`¡¾’
(
·th
è=ğ1 && *·th =ğ'.'è? 0 : 
ENOTDIR
;

12972 
	}
}

12975 
	$¦_fs_š™
() {

12976 
»t
 = 1;

12977 #ifdeà
__TI_COMPILER_VERSION__


12978 #ifdeà
MG_FS_SLFS


12979 #´agm¨
dŸg_push


12980 #´agm¨
dŸg_suµ»ss
 169

12982 
»t
 = (
	`add_deviû
("SL", 
_MSA
, 
fs_¦fs_İ’
, 
fs_¦fs_şo£
, 
fs_¦fs_»ad
,

12983 
fs_¦fs_wr™e
, 
fs_¦fs_l£ek
, 
fs_¦fs_uÆšk
,

12984 
fs_¦fs_»Çme
) == 0);

12985 #´agm¨
dŸg_pİ


12988  
»t
;

12989 
	}
}

12992 
defšed
(
MG_FS_SPIFFS
)) */

12993 #ifdeà
MG_MODULE_LINES


13001 #ià
MG_NET_IF
 =ğ
MG_NET_IF_SIMPLELINK


13003 
	~<”ºo.h
>

13004 
	~<¡dio.h
>

13008 cÚ¡ *
	$š‘_Áİ
(
af
, cÚ¡ *
¤c
, *
d¡
, 
sockËn_t
 
size
) {

13009 
»s
;

13010 
š_addr
 *
š
 = (š_add¸*è
¤c
;

13011 ià(
af
 !ğ
AF_INET
) {

13012 
”ºo
 = 
EAFNOSUPPORT
;

13013  
NULL
;

13015 
»s
 = 
	`¢´štf
(
d¡
, 
size
, "%lu.%lu.%lu.%lu", 
	`SL_IPV4_BYTE
(
š
->
s_addr
, 0),

13016 
	`SL_IPV4_BYTE
(
š
->
s_addr
, 1), SL_IPV4_BYTE(in->s_addr, 2),

13017 
	`SL_IPV4_BYTE
(
š
->
s_addr
, 3));

13018  
»s
 > 0 ? 
d¡
 : 
NULL
;

13019 
	}
}

13021 *
	$š‘_Áß
(
š_addr
 
n
) {

13022 
a
[16];

13023  (*è
	`š‘_Áİ
(
AF_INET
, &
n
, 
a
, (a));

13024 
	}
}

13026 
	$š‘_±Ú
(
af
, cÚ¡ *
¤c
, *
d¡
) {

13027 
ušt32_t
 
a0
, 
a1
, 
a2
, 
a3
;

13028 
ušt8_t
 *
db
 = (ušt8_ˆ*è
d¡
;

13029 ià(
af
 !ğ
AF_INET
) {

13030 
”ºo
 = 
EAFNOSUPPORT
;

13033 ià(
	`ssÿnf
(
¤c
, "%lu.%lu.%lu.%lu", &
a0
, &
a1
, &
a2
, &
a3
) != 4) {

13036 *
db
 = 
a3
;

13037 *(
db
 + 1èğ
a2
;

13038 *(
db
 + 2èğ
a1
;

13039 *(
db
 + 3èğ
a0
;

13041 
	}
}

13044 #ifdeà
MG_MODULE_LINES


13047 #ià
MG_NET_IF
 =ğ
MG_NET_IF_SIMPLELINK
 && !
defšed
(
MG_SIMPLELINK_NO_OSI
)

13051 
	~<o¦ib/osi.h
>

13053 
	emg_q_msg_ty³
 {

13054 
	mMG_Q_MSG_CB
,

13056 
	smg_q_msg
 {

13057 
mg_q_msg_ty³
 
	mty³
;

13058 (*
	mcb
)(
mg_mgr
 *
	mmgr
, *
	m¬g
);

13059 *
	m¬g
;

13061 
OsiMsgQ_t
 
	gs_mg_q
;

13062 
mg_sk
(*
¬g
);

13064 
boŞ
 
	$mg_¡¬t_sk
(
´iÜ™y
, 
¡ack_size
, 
mg_š™_cb
 
mg_š™
) {

13065 ià(
	`osi_MsgQC»©e
(&
s_mg_q
, "MG", (
mg_q_msg
), 16è!ğ
OSI_OK
) {

13066  
çl£
;

13068 ià(
	`osi_TaskC»©e
(
mg_sk
, (cÚ¡ sigÃd *è"MG", 
¡ack_size
,

13069 (*è
mg_š™
, 
´iÜ™y
, 
NULL
è!ğ
OSI_OK
) {

13070  
çl£
;

13072  
Œue
;

13073 
	}
}

13075 
	$mg_sk
(*
¬g
) {

13076 
mg_mgr
 
mgr
;

13077 
mg_š™_cb
 
mg_š™
 = (mg_š™_cbè
¬g
;

13078 
	`mg_mgr_š™
(&
mgr
, 
NULL
);

13079 
	`mg_š™
(&
mgr
);

13081 
mg_q_msg
 
msg
;

13082 
	`mg_mgr_pŞl
(&
mgr
, 1);

13083 ià(
	`osi_MsgQR—d
(&
s_mg_q
, &
msg
, 1è!ğ
OSI_OK
) ;

13084 
msg
.
ty³
) {

13085 
MG_Q_MSG_CB
: {

13086 
msg
.
	`cb
(&
mgr
, msg.
¬g
);

13090 
	}
}

13092 
mg_run_š_sk
((*
cb
)(
mg_mgr
 *
mgr
, *
¬g
), *
cb_¬g
) {

13093 
mg_q_msg
 
msg
 = {
MG_Q_MSG_CB
, 
cb
, 
cb_¬g
};

13094 
	`osi_MsgQWr™e
(&
s_mg_q
, &
msg
, 
OSI_NO_WAIT
);

13095 
	}
}

13099 #ifdeà
MG_MODULE_LINES


13107 #iâdeà
CS_COMMON_PLATFORMS_SIMPLELINK_SL_NET_IF_H_


13108 
	#CS_COMMON_PLATFORMS_SIMPLELINK_SL_NET_IF_H_


	)

13112 #ifdeà
__ılu¥lus


13116 #iâdeà
MG_ENABLE_NET_IF_SIMPLELINK


13117 
	#MG_ENABLE_NET_IF_SIMPLELINK
 
MG_NET_IF
 =ğ
MG_NET_IF_SIMPLELINK


	)

13120 
mg_içû_vbË
 
mg_sim¶–šk_içû_vbË
;

13122 #ifdeà
__ılu¥lus


13127 #ifdeà
MG_MODULE_LINES


13137 #ià
MG_ENABLE_NET_IF_SIMPLELINK


13142 
	#MG_TCP_RECV_BUFFER_SIZE
 1024

	)

13143 
	#MG_UDP_RECV_BUFFER_SIZE
 1500

	)

13145 
sock_t
 
mg_İ’_li¡’šg_sock‘
(
sock‘_add»ss
 *
§
, 
ty³
,

13146 
´Ùo
);

13148 
¦_£t_s¦_İts
(
mg_cÚÃùiÚ
 *
nc
);

13150 
	$mg_£t_nÚ_blockšg_mode
(
sock_t
 
sock
) {

13151 
SlSockNÚblockšg_t
 
İt
;

13152 
İt
.
NÚblockšgEÇbËd
 = 1;

13153 
	`¦_S‘SockO±
(
sock
, 
SL_SOL_SOCKET
, 
SL_SO_NONBLOCKING
, &
İt
, (opt));

13154 
	}
}

13156 
	$mg_is_”rÜ
(
n
) {

13157  (
n
 < 0 &&‚ !ğ
SL_EALREADY
 &&‚ !ğ
SL_EAGAIN
);

13158 
	}
}

13160 
	$mg_¦_if_cÚÃù_tı
(
mg_cÚÃùiÚ
 *
nc
,

13161 cÚ¡ 
sock‘_add»ss
 *
§
) {

13162 
´Ùo
 = 0;

13163 ià(
nc
->
æags
 & 
MG_F_SSL
è
´Ùo
 = 
SL_SEC_SOCKET
;

13164 
sock_t
 
sock
 = 
	`¦_Sock‘
(
AF_INET
, 
SOCK_STREAM
, 
´Ùo
);

13165 ià(
sock
 < 0) {

13166 
nc
->
”r
 = 
sock
;

13167 
out
;

13169 
	`mg_sock_£t
(
nc
, 
sock
);

13170 #ià
MG_ENABLE_SSL


13171 
nc
->
”r
 = 
	`¦_£t_s¦_İts
(nc);

13172 ià(
nc
->
”r
 !ğ0è
out
;

13174 
nc
->
”r
 = 
	`¦_CÚÃù
(
sock
, &
§
->§, (§->
sš
));

13175 
out
:

13176 
	`DBG
(("%°tØ%s:%d sock %d %dƒ¼ %d", 
nc
, 
	`š‘_Áß
(
§
->
sš
.
sš_addr
),

13177 
	`Áohs
(
§
->
sš
.
sš_pÜt
), 
nc
->
sock
, 
´Ùo
,‚c->
”r
));

13178 
	}
}

13180 
	$mg_¦_if_cÚÃù_udp
(
mg_cÚÃùiÚ
 *
nc
) {

13181 
sock_t
 
sock
 = 
	`¦_Sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

13182 ià(
sock
 < 0) {

13183 
nc
->
”r
 = 
sock
;

13186 
	`mg_sock_£t
(
nc
, 
sock
);

13187 
nc
->
”r
 = 0;

13188 
	}
}

13190 
	$mg_¦_if_li¡’_tı
(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
) {

13191 
´Ùo
 = 0;

13192 ià(
nc
->
æags
 & 
MG_F_SSL
è
´Ùo
 = 
SL_SEC_SOCKET
;

13193 
sock_t
 
sock
 = 
	`mg_İ’_li¡’šg_sock‘
(
§
, 
SOCK_STREAM
, 
´Ùo
);

13194 ià(
sock
 < 0)  sock;

13195 
	`mg_sock_£t
(
nc
, 
sock
);

13196 #ià
MG_ENABLE_SSL


13197  
	`¦_£t_s¦_İts
(
nc
);

13201 
	}
}

13203 
	$mg_¦_if_li¡’_udp
(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
) {

13204 
sock_t
 
sock
 = 
	`mg_İ’_li¡’šg_sock‘
(
§
, 
SOCK_DGRAM
, 0);

13205 ià(
sock
 =ğ
INVALID_SOCKET
è (
”ºo
 ?ƒrrno : 1);

13206 
	`mg_sock_£t
(
nc
, 
sock
);

13208 
	}
}

13210 
	$mg_¦_if_tı_£nd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

13211 
	`mbuf_­³nd
(&
nc
->
£nd_mbuf
, 
buf
, 
Ën
);

13212 
	}
}

13214 
	$mg_¦_if_udp_£nd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

13215 
	`mbuf_­³nd
(&
nc
->
£nd_mbuf
, 
buf
, 
Ën
);

13216 
	}
}

13218 
	$mg_¦_if_»cved
(
mg_cÚÃùiÚ
 *
nc
, 
size_t
 
Ën
) {

13219 (è
nc
;

13220 (è
Ën
;

13221 
	}
}

13223 
	$mg_¦_if_ü—‹_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

13224 (è
nc
;

13226 
	}
}

13228 
	$mg_¦_if_de¡roy_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

13229 ià(
nc
->
sock
 =ğ
INVALID_SOCKET
) ;

13231 ià(!(
nc
->
æags
 & 
MG_F_UDP
è||‚c->
li¡’”
 =ğ
NULL
) {

13232 
	`¦_Clo£
(
nc
->
sock
);

13234 
nc
->
sock
 = 
INVALID_SOCKET
;

13235 
	}
}

13237 
	$mg_acû±_cÚn
(
mg_cÚÃùiÚ
 *
lc
) {

13238 
mg_cÚÃùiÚ
 *
nc
;

13239 
sock‘_add»ss
 
§
;

13240 
sockËn_t
 
§_Ën
 = (
§
);

13241 
sock_t
 
sock
 = 
	`¦_Acû±
(
lc
->sock, &
§
.§, &
§_Ën
);

13242 ià(
sock
 < 0) {

13243 
	`DBG
(("%p: faedØacû±: %d", 
lc
, 
sock
));

13246 
nc
 = 
	`mg_if_acû±_Ãw_cÚn
(
lc
);

13247 ià(
nc
 =ğ
NULL
) {

13248 
	`¦_Clo£
(
sock
);

13251 
	`DBG
(("%°cÚÀäom %s:%d", 
nc
, 
	`š‘_Áß
(
§
.
sš
.
sš_addr
),

13252 
	`Áohs
(
§
.
sš
.
sš_pÜt
)));

13253 
	`mg_sock_£t
(
nc
, 
sock
);

13254 ià(
nc
->
æags
 & 
MG_F_SSL
ènc->æag |ğ
MG_F_SSL_HANDSHAKE_DONE
;

13255 
	`mg_if_acû±_tı_cb
(
nc
, &
§
, 
§_Ën
);

13257 
	}
}

13260 
sock_t
 
	$mg_İ’_li¡’šg_sock‘
(
sock‘_add»ss
 *
§
, 
ty³
,

13261 
´Ùo
) {

13262 
r
;

13263 
sockËn_t
 
§_Ën
 =

13264 (
§
->§.
§_çmy
 =ğ
AF_INET
è? (§->
sš
è: (§->
sš6
);

13265 
sock_t
 
sock
 = 
	`¦_Sock‘
(
§
->§.
§_çmy
, 
ty³
, 
´Ùo
);

13266 ià(
sock
 < 0)  sock;

13267 ià((
r
 = 
	`¦_Bšd
(
sock
, &
§
->§, 
§_Ën
)) < 0) {

13268 
	`¦_Clo£
(
sock
);

13269  
r
;

13271 ià(
ty³
 !ğ
SOCK_DGRAM
 && (
r
 = 
	`¦_Li¡’
(
sock
, 
SOMAXCONN
)) < 0) {

13272 
	`¦_Clo£
(
sock
);

13273  
r
;

13275 
	`mg_£t_nÚ_blockšg_mode
(
sock
);

13276  
sock
;

13277 
	}
}

13279 
	$mg_wr™e_to_sock‘
(
mg_cÚÃùiÚ
 *
nc
) {

13280 
mbuf
 *
io
 = &
nc
->
£nd_mbuf
;

13281 
n
 = 0;

13283 ià(
nc
->
æags
 & 
MG_F_UDP
) {

13284 
n
 = 
	`¦_S’dTo
(
nc
->
sock
, 
io
->
buf
, io->
Ën
, 0, &nc->
§
.sa,

13285 (
nc
->
§
.
sš
));

13286 
	`DBG
(("%°%d %d %d %s:%hu", 
nc
,‚c->
sock
, 
n
, 
”ºo
,

13287 
	`š‘_Áß
(
nc
->
§
.
sš
.
sš_addr
), 
	`Áohs
Òc->§.sš.
sš_pÜt
)));

13289 
n
 = (è
	`¦_S’d
(
nc
->
sock
, 
io
->
buf
, io->
Ën
, 0);

13290 
	`DBG
(("%°%d by‹ -> %d", 
nc
, 
n
,‚c->
sock
));

13293 ià(
n
 > 0) {

13294 
	`mbuf_»move
(
io
, 
n
);

13295 
	`mg_if_£Á_cb
(
nc
, 
n
);

13296 } ià(
n
 < 0 && 
	`mg_is_”rÜ
(n)) {

13298 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

13300 
	}
}

13302 
MG_INTERNAL
 
size_t
 
	$»cv_ava_size
(
mg_cÚÃùiÚ
 *
cÚn
, 
size_t
 
max
) {

13303 
size_t
 
ava
;

13304 ià(
cÚn
->
»cv_mbuf_lim™
 < cÚn->
»cv_mbuf
.
Ën
)  0;

13305 
ava
 = 
cÚn
->
»cv_mbuf_lim™
 - cÚn->
»cv_mbuf
.
Ën
;

13306  
ava
 > 
max
 ? max :‡vail;

13307 
	}
}

13309 
	$mg_hªdË_tı_»ad
(
mg_cÚÃùiÚ
 *
cÚn
) {

13310 
n
 = 0;

13311 *
buf
 = (*è
	`MG_MALLOC
(
MG_TCP_RECV_BUFFER_SIZE
);

13313 ià(
buf
 =ğ
NULL
) {

13314 
	`DBG
(("OOM"));

13318 
n
 = (è
	`¦_Recv
(
cÚn
->
sock
, 
buf
,

13319 
	`»cv_ava_size
(
cÚn
, 
MG_TCP_RECV_BUFFER_SIZE
), 0);

13320 
	`DBG
(("%°%d by‹ <- %d", 
cÚn
, 
n
, cÚn->
sock
));

13321 ià(
n
 > 0) {

13322 
	`mg_if_»cv_tı_cb
(
cÚn
, 
buf
, 
n
, 1 );

13324 
	`MG_FREE
(
buf
);

13326 ià(
n
 == 0) {

13328 
cÚn
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

13329 } ià(
	`mg_is_”rÜ
(
n
)) {

13330 
cÚn
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

13332 
	}
}

13334 
	$mg_hªdË_udp_»ad
(
mg_cÚÃùiÚ
 *
nc
) {

13335 *
buf
 = (*è
	`MG_MALLOC
(
MG_UDP_RECV_BUFFER_SIZE
);

13336 ià(
buf
 =ğ
NULL
) ;

13337 
sock‘_add»ss
 
§
;

13338 
sockËn_t
 
§_Ën
 = (
§
);

13339 
n
 = 
	`¦_RecvFrom
(
nc
->
sock
, 
buf
, 
MG_UDP_RECV_BUFFER_SIZE
, 0,

13340 (
SlSockAddr_t
 *è&
§
, &
§_Ën
);

13341 
	`DBG
(("%°%d by‹ äom %s:%d", 
nc
, 
n
, 
	`š‘_Áß
Òc->
§
.
sš
.
sš_addr
),

13342 
	`Áohs
(
nc
->
§
.
sš
.
sš_pÜt
)));

13343 ià(
n
 > 0) {

13344 
	`mg_if_»cv_udp_cb
(
nc
, 
buf
, 
n
, &
§
, 
§_Ën
);

13346 
	`MG_FREE
(
buf
);

13348 
	}
}

13350 
	#_MG_F_FD_CAN_READ
 1

	)

13351 
	#_MG_F_FD_CAN_WRITE
 1 << 1

	)

13352 
	#_MG_F_FD_ERROR
 1 << 2

	)

13354 
	$mg_mgr_hªdË_cÚn
(
mg_cÚÃùiÚ
 *
nc
, 
fd_æags
, 
now
) {

13355 
	`DBG
(("%°fd=%d fd_æags=%d‚c_æags=%lu„mbl=%d smbl=%d", 
nc
,‚c->
sock
,

13356 
fd_æags
, 
nc
->
æags
, (ènc->
»cv_mbuf
.
Ën
, (ènc->
£nd_mbuf
.len));

13358 ià(
nc
->
æags
 & 
MG_F_CONNECTING
) {

13359 ià(
nc
->
æags
 & 
MG_F_UDP
 ||‚c->
”r
 !ğ
SL_EALREADY
) {

13360 
	`mg_if_cÚÃù_cb
(
nc
,‚c->
”r
);

13365 ià(
fd_æags
 & 
_MG_F_FD_CAN_WRITE
) {

13366 
nc
->
”r
 = 
	`¦_CÚÃù
Òc->
sock
, &nc->
§
.§, Òc->§.
sš
));

13367 
	`DBG
(("%°cÚÀ»s=%d", 
nc
,‚c->
”r
));

13368 ià(
nc
->
”r
 =ğ
SL_ESECSNOVERIFY
 ||

13370 
nc
->
”r
 =ğ
SL_ESECDATEERROR
) {

13371 
nc
->
”r
 = 0;

13373 ià(
nc
->
æags
 & 
MG_F_SSL
 &&‚c->
”r
 == 0) {

13374 
nc
->
æags
 |ğ
MG_F_SSL_HANDSHAKE_DONE
;

13376 
	`mg_if_cÚÃù_cb
(
nc
,‚c->
”r
);

13380 
fd_æags
 &ğ~(
_MG_F_FD_CAN_READ
 | 
_MG_F_FD_CAN_WRITE
);

13383 ià(
fd_æags
 & 
_MG_F_FD_CAN_READ
) {

13384 ià(
nc
->
æags
 & 
MG_F_UDP
) {

13385 
	`mg_hªdË_udp_»ad
(
nc
);

13387 ià(
nc
->
æags
 & 
MG_F_LISTENING
) {

13388 
	`mg_acû±_cÚn
(
nc
);

13390 
	`mg_hªdË_tı_»ad
(
nc
);

13395 ià(!(
nc
->
æags
 & 
MG_F_CLOSE_IMMEDIATELY
)) {

13396 ià((
fd_æags
 & 
_MG_F_FD_CAN_WRITE
è&& 
nc
->
£nd_mbuf
.
Ën
 > 0) {

13397 
	`mg_wr™e_to_sock‘
(
nc
);

13400 ià(!(
fd_æags
 & (
_MG_F_FD_CAN_READ
 | 
_MG_F_FD_CAN_WRITE
))) {

13401 
	`mg_if_pŞl
(
nc
, 
now
);

13403 
	`mg_if_tim”
(
nc
, 
now
);

13406 
	`DBG
(("%°aá” fd=%d‚c_æags=%lu„mbl=%d smbl=%d", 
nc
,‚c->
sock
,‚c->
æags
,

13407 (è
nc
->
»cv_mbuf
.
Ën
, (ènc->
£nd_mbuf
.len));

13408 
	}
}

13411 
	$mg_¦_if_sock_£t
(
mg_cÚÃùiÚ
 *
nc
, 
sock_t
 
sock
) {

13412 
	`mg_£t_nÚ_blockšg_mode
(
sock
);

13413 
nc
->
sock
 = sock;

13414 
	`DBG
(("%°%d", 
nc
, 
sock
));

13415 
	}
}

13417 
	$mg_¦_if_š™
(
mg_içû
 *
içû
) {

13418 (è
içû
;

13419 
	`DBG
(("%°usšg sl_S–eù()", 
içû
->
mgr
));

13420 
	}
}

13422 
	$mg_¦_if_ä“
(
mg_içû
 *
içû
) {

13423 (è
içû
;

13424 
	}
}

13426 
	$mg_¦_if_add_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

13427 (è
nc
;

13428 
	}
}

13430 
	$mg_¦_if_»move_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

13431 (è
nc
;

13432 
	}
}

13434 
time_t
 
	$mg_¦_if_pŞl
(
mg_içû
 *
içû
, 
timeout_ms
) {

13435 
mg_mgr
 *
mgr
 = 
içû
->mgr;

13436 
now
 = 
	`mg_time
();

13437 
mš_tim”
;

13438 
mg_cÚÃùiÚ
 *
nc
, *
tmp
;

13439 
SlTimev®_t
 
tv
;

13440 
SlFdS‘_t
 
»ad_£t
, 
wr™e_£t
, 
”r_£t
;

13441 
sock_t
 
max_fd
 = 
INVALID_SOCKET
;

13442 
num_fds
, 
num_ev
 = 0, 
num_tim”s
 = 0;

13444 
	`SL_FD_ZERO
(&
»ad_£t
);

13445 
	`SL_FD_ZERO
(&
wr™e_£t
);

13446 
	`SL_FD_ZERO
(&
”r_£t
);

13452 
mš_tim”
 = 0;

13453 
nc
 = 
mgr
->
aùive_cÚÃùiÚs
, 
num_fds
 = 0;‚ø!ğ
NULL
;‚øğ
tmp
) {

13454 
tmp
 = 
nc
->
Ãxt
;

13456 ià(
nc
->
sock
 !ğ
INVALID_SOCKET
) {

13457 
num_fds
++;

13459 ià(!(
nc
->
æags
 & 
MG_F_WANT_WRITE
) &&

13460 
nc
->
»cv_mbuf
.
Ën
 <‚c->
»cv_mbuf_lim™
 &&

13461 (!(
nc
->
æags
 & 
MG_F_UDP
è||‚c->
li¡’”
 =ğ
NULL
)) {

13462 
	`SL_FD_SET
(
nc
->
sock
, &
»ad_£t
);

13463 ià(
max_fd
 =ğ
INVALID_SOCKET
 || 
nc
->
sock
 > max_fd) max_fd =‚c->sock;

13466 ià(((
nc
->
æags
 & 
MG_F_CONNECTING
è&& !Òc->æag & 
MG_F_WANT_READ
)) ||

13467 (
nc
->
£nd_mbuf
.
Ën
 > 0 && !Òc->
æags
 & 
MG_F_CONNECTING
))) {

13468 
	`SL_FD_SET
(
nc
->
sock
, &
wr™e_£t
);

13469 
	`SL_FD_SET
(
nc
->
sock
, &
”r_£t
);

13470 ià(
max_fd
 =ğ
INVALID_SOCKET
 || 
nc
->
sock
 > max_fd) max_fd =‚c->sock;

13474 ià(
nc
->
ev_tim”_time
 > 0) {

13475 ià(
num_tim”s
 =ğ0 || 
nc
->
ev_tim”_time
 < 
mš_tim”
) {

13476 
mš_tim”
 = 
nc
->
ev_tim”_time
;

13478 
num_tim”s
++;

13486 ià(
num_tim”s
 > 0) {

13487 
tim”_timeout_ms
 = (
mš_tim”
 - 
	`mg_time
()) * 1000 + 1 ;

13488 ià(
tim”_timeout_ms
 < 
timeout_ms
) {

13489 
timeout_ms
 = 
tim”_timeout_ms
;

13492 ià(
timeout_ms
 < 0)imeout_ms = 0;

13494 
tv
.
tv_£c
 = 
timeout_ms
 / 1000;

13495 
tv
.
tv_u£c
 = (
timeout_ms
 % 1000) * 1000;

13497 ià(
num_fds
 > 0) {

13498 
num_ev
 = 
	`¦_S–eù
((è
max_fd
 + 1, &
»ad_£t
, &
wr™e_£t
, &
”r_£t
, &
tv
);

13501 
now
 = 
	`mg_time
();

13502 
	`DBG
(("¦_S–eù @ %ld‚um_ev=%d oà%d,imeout=%d", (è
now
, 
num_ev
,

13503 
num_fds
, 
timeout_ms
));

13505 
nc
 = 
mgr
->
aùive_cÚÃùiÚs
;‚ø!ğ
NULL
;‚øğ
tmp
) {

13506 
fd_æags
 = 0;

13507 ià(
nc
->
sock
 !ğ
INVALID_SOCKET
) {

13508 ià(
num_ev
 > 0) {

13509 
fd_æags
 =

13510 (
	`SL_FD_ISSET
(
nc
->
sock
, &
»ad_£t
) &&

13511 (!(
nc
->
æags
 & 
MG_F_UDP
è||‚c->
li¡’”
 =ğ
NULL
)

13512 ? 
_MG_F_FD_CAN_READ


13514 (
	`SL_FD_ISSET
(
nc
->
sock
, &
wr™e_£t
è? 
_MG_F_FD_CAN_WRITE
 : 0) |

13515 (
	`SL_FD_ISSET
(
nc
->
sock
, &
”r_£t
è? 
_MG_F_FD_ERROR
 : 0);

13518 ià(
nc
->
æags
 & 
MG_F_UDP
 &&‚c->
£nd_mbuf
.
Ën
 > 0) {

13519 
fd_æags
 |ğ
_MG_F_FD_CAN_WRITE
;

13522 
tmp
 = 
nc
->
Ãxt
;

13523 
	`mg_mgr_hªdË_cÚn
(
nc
, 
fd_æags
, 
now
);

13526 
nc
 = 
mgr
->
aùive_cÚÃùiÚs
;‚ø!ğ
NULL
;‚øğ
tmp
) {

13527 
tmp
 = 
nc
->
Ãxt
;

13528 ià((
nc
->
æags
 & 
MG_F_CLOSE_IMMEDIATELY
) ||

13529 (
nc
->
£nd_mbuf
.
Ën
 =ğ0 && (nc->
æags
 & 
MG_F_SEND_AND_CLOSE
))) {

13530 
	`mg_şo£_cÚn
(
nc
);

13534  
now
;

13535 
	}
}

13537 
	$mg_¦_if_g‘_cÚn_addr
(
mg_cÚÃùiÚ
 *
nc
, 
»mÙe
,

13538 
sock‘_add»ss
 *
§
) {

13542 ià(
»mÙe
è
	`memıy
(
§
, &
nc
->sa, (*sa));

13543 
	}
}

13545 
	$¦_»¡¬t_cb
(
mg_mgr
 *
mgr
) {

13551 
mg_cÚÃùiÚ
 *
nc
;

13552 
nc
 = 
	`mg_Ãxt
(
mgr
, 
NULL
);‚c != NULL;‚c = mg_next(mgr,‚c)) {

13553 ià(
nc
->
sock
 =ğ
INVALID_SOCKET
) ;

13554 ià(
nc
->
æags
 & 
MG_F_LISTENING
) {

13555 
	`DBG
(("»¡¬tšg %°%s:%d", 
nc
, 
	`š‘_Áß
Òc->
§
.
sš
.
sš_addr
),

13556 
	`Áohs
(
nc
->
§
.
sš
.
sš_pÜt
)));

13557 
»s
 = (
nc
->
æags
 & 
MG_F_UDP
 ? 
	`mg_¦_if_li¡’_udp
Òc, &nc->
§
)

13558 : 
	`mg_¦_if_li¡’_tı
(
nc
, &nc->
§
));

13559 ià(
»s
 == 0) ;

13562 
nc
->
sock
 = 
INVALID_SOCKET
;

13563 
	`DBG
(("‹rmš©šg %°%s:%d", 
nc
, 
	`š‘_Áß
Òc->
§
.
sš
.
sš_addr
),

13564 
	`Áohs
(
nc
->
§
.
sš
.
sš_pÜt
)));

13566 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

13568 
	}
}

13571 
	#MG_SL_IFACE_VTABLE
 \

13573 
mg_¦_if_š™
, \

13574 
mg_¦_if_ä“
, \

13575 
mg_¦_if_add_cÚn
, \

13576 
mg_¦_if_»move_cÚn
, \

13577 
mg_¦_if_pŞl
, \

13578 
mg_¦_if_li¡’_tı
, \

13579 
mg_¦_if_li¡’_udp
, \

13580 
mg_¦_if_cÚÃù_tı
, \

13581 
mg_¦_if_cÚÃù_udp
, \

13582 
mg_¦_if_tı_£nd
, \

13583 
mg_¦_if_udp_£nd
, \

13584 
mg_¦_if_»cved
, \

13585 
mg_¦_if_ü—‹_cÚn
, \

13586 
mg_¦_if_de¡roy_cÚn
, \

13587 
mg_¦_if_sock_£t
, \

13588 
mg_¦_if_g‘_cÚn_addr
, \

13589 }

	)

13592 
mg_içû_vbË
 
	gmg_sim¶–šk_içû_vbË
 = 
MG_SL_IFACE_VTABLE
;

13593 #ià
MG_NET_IF
 =ğ
MG_NET_IF_SIMPLELINK


13594 
mg_içû_vbË
 
	gmg_deçuÉ_içû_vbË
 = 
MG_SL_IFACE_VTABLE
;

13598 #ifdeà
MG_MODULE_LINES


13606 #ià
MG_ENABLE_SSL
 && 
MG_SSL_IF
 =ğ
MG_SSL_IF_SIMPLELINK


13608 
	smg_s¦_if_ùx
 {

13609 *
	ms¦_û¹
;

13610 *
	ms¦_key
;

13611 *
	ms¦_ÿ_û¹
;

13612 *
	ms¦_£rv”_Çme
;

13615 
	$mg_s¦_if_š™
() {

13616 
	}
}

13618 
mg_s¦_if_»suÉ
 
	$mg_s¦_if_cÚn_š™
(

13619 
mg_cÚÃùiÚ
 *
nc
, cÚ¡ 
mg_s¦_if_cÚn_·¿ms
 *
·¿ms
,

13620 cÚ¡ **
”r_msg
) {

13621 
mg_s¦_if_ùx
 *
ùx
 =

13622 (
mg_s¦_if_ùx
 *è
	`MG_CALLOC
(1, (*
ùx
));

13623 ià(
ùx
 =ğ
NULL
) {

13624 
	`MG_SET_PTRPTR
(
”r_msg
, "Out of memory");

13625  
MG_SSL_ERROR
;

13627 
nc
->
s¦_if_d©a
 = 
ùx
;

13629 ià(
·¿ms
->
û¹
 !ğ
NULL
 ||…¬ams->
key
 != NULL) {

13630 ià(
·¿ms
->
û¹
 !ğ
NULL
 &&…¬ams->
key
 != NULL) {

13631 
ùx
->
s¦_û¹
 = 
	`¡rdup
(
·¿ms
->
û¹
);

13632 
ùx
->
s¦_key
 = 
	`¡rdup
(
·¿ms
->
key
);

13634 
	`MG_SET_PTRPTR
(
”r_msg
, "Both cert‡nd key‡re„equired.");

13635  
MG_SSL_ERROR
;

13638 ià(
·¿ms
->
ÿ_û¹
 !ğ
NULL
 && 
	`¡rcmp
(params->ca_cert, "*") != 0) {

13639 
ùx
->
s¦_ÿ_û¹
 = 
	`¡rdup
(
·¿ms
->
ÿ_û¹
);

13642 ià(
·¿ms
->
£rv”_Çme
 !ğ
NULL
) {

13643 
ùx
->
s¦_£rv”_Çme
 = 
	`¡rdup
(
·¿ms
->
£rv”_Çme
);

13645  
MG_SSL_OK
;

13646 
	}
}

13648 
	$mg_s¦_if_cÚn_ä“
(
mg_cÚÃùiÚ
 *
nc
) {

13649 
mg_s¦_if_ùx
 *
ùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

13650 ià(
ùx
 =ğ
NULL
) ;

13651 
nc
->
s¦_if_d©a
 = 
NULL
;

13652 
	`MG_FREE
(
ùx
->
s¦_û¹
);

13653 
	`MG_FREE
(
ùx
->
s¦_key
);

13654 
	`MG_FREE
(
ùx
->
s¦_ÿ_û¹
);

13655 
	`MG_FREE
(
ùx
->
s¦_£rv”_Çme
);

13656 
	`mem£t
(
ùx
, 0, (*ctx));

13657 
	`MG_FREE
(
ùx
);

13658 
	}
}

13660 
boŞ
 
	$³m_to_d”
(cÚ¡ *
³m_fe
, cÚ¡ *
d”_fe
) {

13661 
boŞ
 
»t
 = 
çl£
;

13662 
FILE
 *
pf
 = 
NULL
, *
df
 = NULL;

13663 
boŞ
 
wr™šg
 = 
çl£
;

13664 
pf
 = 
	`fİ’
(
³m_fe
, "r");

13665 ià(
pf
 =ğ
NULL
è
ş—n
;

13666 
	`»move
(
d”_fe
);

13667 
	`fs_¦fs_£t_Ãw_fe_size
(
d”_fe
 + 3, 2048);

13668 
df
 = 
	`fİ’
(
d”_fe
, "w");

13669 ià(
df
 =ğ
NULL
è
ş—n
;

13671 
³m_buf
[70];

13672 
d”_buf
[48];

13673 ià(!
	`fg‘s
(
³m_buf
, Õem_buf), 
pf
)) ;

13674 ià(
wr™šg
) {

13675 ià(
	`¡r¡r
(
³m_buf
, "-----END "è!ğ
NULL
) {

13676 
»t
 = 
Œue
;

13679 
l
 = 0;

13680 !
	`is¥aû
((è
³m_buf
[
l
]))†++;

13681 
d”_Ën
 = 0;

13682 
	`cs_ba£64_decode
((cÚ¡ *è
³m_buf
, (pem_buf),

13683 
d”_buf
, &
d”_Ën
);

13684 ià(
d”_Ën
 <= 0) ;

13685 ià(
	`fwr™e
(
d”_buf
, 1, 
d”_Ën
, 
df
) != der_len) ;

13686 } ià(
	`¡r¡r
(
³m_buf
, "-----BEGIN "è!ğ
NULL
) {

13687 
wr™šg
 = 
Œue
;

13691 
ş—n
:

13692 ià(
pf
 !ğ
NULL
è
	`fşo£
(pf);

13693 ià(
df
 !ğ
NULL
) {

13694 
	`fşo£
(
df
);

13695 ià(!
»t
è
	`»move
(
d”_fe
);

13697  
»t
;

13698 
	}
}

13700 #ià
MG_ENABLE_FILESYSTEM
 && 
defšed
(
MG_FS_SLFS
)

13702 *
	$¦_³m2d”
(cÚ¡ *
³m_fe
) {

13703 cÚ¡ *
³m_ext
 = 
	`¡r¡r
(
³m_fe
, ".pem");

13704 ià(
³m_ext
 =ğ
NULL
 || *(pem_ext + 4) != '\0') {

13705  
	`¡rdup
(
³m_fe
);

13707 *
d”_fe
 = 
NULL
;

13709 
l
 = 
	`mg_a¥rštf
(&
d”_fe
, 0, "SL:%.*s.d”", (è(
³m_ext
 - 
³m_fe
),

13710 
³m_fe
);

13711 ià(
d”_fe
 =ğ
NULL
)  NULL;

13712 
boŞ
 
»suÉ
 = 
çl£
;

13713 
cs_¡©_t
 
¡
;

13714 ià(
	`mg_¡©
(
d”_fe
, &
¡
) != 0) {

13715 
»suÉ
 = 
	`³m_to_d”
(
³m_fe
, 
d”_fe
);

13716 
	`LOG
(
LL_DEBUG
, ("% -> % ğ%d", 
³m_fe
, 
d”_fe
, 
»suÉ
));

13719 
»suÉ
 = 
Œue
;

13721 ià(
»suÉ
) {

13723 
	`memmove
(
d”_fe
, d”_f+ 3, 
l
 - 2 );

13725 
	`ä“
(
d”_fe
);

13726 
d”_fe
 = 
NULL
;

13728  
d”_fe
;

13729 
	}
}

13731 *
	$¦_³m2d”
(cÚ¡ *
³m_fe
) {

13732  
	`¡rdup
(
³m_fe
);

13733 
	}
}

13736 
	$¦_£t_s¦_İts
(
mg_cÚÃùiÚ
 *
nc
) {

13737 
”r
;

13738 
mg_s¦_if_ùx
 *
ùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

13739 
	`DBG
(("%°s¦ ctx: %p", 
nc
, 
ùx
));

13741 ià(
ùx
 !ğ
NULL
) {

13742 
	`DBG
(("%°%s,%s,%s,%s", 
nc
, (
ùx
->
s¦_û¹
 ? ctx->ssl_cert : "-"),

13743 (
ùx
->
s¦_key
 ? ctx->
s¦_û¹
 : "-"),

13744 (
ùx
->
s¦_ÿ_û¹
 ? ctx->ssl_ca_cert : "-"),

13745 (
ùx
->
s¦_£rv”_Çme
 ? ctx->ssl_server_name : "-")));

13746 ià(
ùx
->
s¦_û¹
 !ğ
NULL
 && ctx->
s¦_key
 != NULL) {

13747 *
s¦_û¹
 = 
	`¦_³m2d”
(
ùx
->ssl_cert);

13748 *
s¦_key
 = 
	`¦_³m2d”
(
ùx
->ssl_key);

13749 ià(
s¦_û¹
 !ğ
NULL
 && 
s¦_key
 != NULL) {

13750 
”r
 = 
	`¦_S‘SockO±
(
nc
->
sock
, 
SL_SOL_SOCKET
,

13751 
SL_SO_SECURE_FILES_CERTIFICATE_FILE_NAME
, 
s¦_û¹
,

13752 
	`¡¾’
(
s¦_û¹
));

13753 
	`LOG
(
LL_INFO
, ("CERTIFICATE_FILE_NAME % -> %d", 
s¦_û¹
, 
”r
));

13754 
”r
 = 
	`¦_S‘SockO±
(
nc
->
sock
, 
SL_SOL_SOCKET
,

13755 
SL_SO_SECURE_FILES_PRIVATE_KEY_FILE_NAME
, 
s¦_key
,

13756 
	`¡¾’
(
s¦_key
));

13757 
	`LOG
(
LL_INFO
, ("PRIVATE_KEY_FILE_NAME % -> %d", 
s¦_key
, 
”r
));

13759 
”r
 = -1;

13761 
	`ä“
(
s¦_û¹
);

13762 
	`ä“
(
s¦_key
);

13763 ià(
”r
 != 0) ƒrr;

13765 ià(
ùx
->
s¦_ÿ_û¹
 !ğ
NULL
) {

13766 ià(
ùx
->
s¦_ÿ_û¹
[0] != '\0') {

13767 *
s¦_ÿ_û¹
 = 
	`¦_³m2d”
(
ùx
->ssl_ca_cert);

13768 ià(
s¦_ÿ_û¹
 !ğ
NULL
) {

13769 
”r
 = 
	`¦_S‘SockO±
(
nc
->
sock
, 
SL_SOL_SOCKET
,

13770 
SL_SO_SECURE_FILES_CA_FILE_NAME
, 
s¦_ÿ_û¹
,

13771 
	`¡¾’
(
s¦_ÿ_û¹
));

13772 
	`LOG
(
LL_INFO
, ("CA_FILE_NAME % -> %d", 
s¦_ÿ_û¹
, 
”r
));

13774 
”r
 = -1;

13776 
	`ä“
(
s¦_ÿ_û¹
);

13777 ià(
”r
 != 0) ƒrr;

13780 ià(
ùx
->
s¦_£rv”_Çme
 !ğ
NULL
) {

13781 
”r
 = 
	`¦_S‘SockO±
(
nc
->
sock
, 
SL_SOL_SOCKET
,

13782 
SO_SECURE_DOMAIN_NAME_VERIFICATION
,

13783 
ùx
->
s¦_£rv”_Çme
, 
	`¡¾’
(ctx->ssl_server_name));

13784 
	`DBG
(("DOMAIN_NAME_VERIFICATION % -> %d", 
ùx
->
s¦_£rv”_Çme
, 
”r
));

13788 ià(
”r
 !ğ0 &&ƒ¼ !ğ
SL_ENOPROTOOPT
) ƒrr;

13792 
	}
}

13795 #ifdeà
MG_MODULE_LINES


13803 #iâdeà
CS_COMMON_PLATFORMS_LWIP_MG_NET_IF_LWIP_H_


13804 
	#CS_COMMON_PLATFORMS_LWIP_MG_NET_IF_LWIP_H_


	)

13806 #iâdeà
MG_ENABLE_NET_IF_LWIP_LOW_LEVEL


13807 
	#MG_ENABLE_NET_IF_LWIP_LOW_LEVEL
 
MG_NET_IF
 =ğ
MG_NET_IF_LWIP_LOW_LEVEL


	)

13810 #ià
MG_ENABLE_NET_IF_LWIP_LOW_LEVEL


13812 
	~<¡dšt.h
>

13814 
mg_içû_vbË
 
mg_lw_içû_vbË
;

13816 
	smg_lw_cÚn_¡©e
 {

13817 
mg_cÚÃùiÚ
 *
	mnc
;

13818 
mg_cÚÃùiÚ
 *
	mlc
;

13820 
tı_pcb
 *
	mtı
;

13821 
udp_pcb
 *
	mudp
;

13822 } 
	mpcb
;

13823 
”r_t
 
	m”r
;

13824 
size_t
 
	mnum_£Á
;

13825 
pbuf
 *
	mrx_chaš
;

13826 
size_t
 
	mrx_off£t
;

13828 
	mÏ¡_s¦_wr™e_size
;

13830 
	m»cv_³ndšg
;

13833 
	emg_sig_ty³
 {

13834 
	mMG_SIG_CONNECT_RESULT
 = 1,

13835 
	mMG_SIG_RECV
 = 2,

13836 
	mMG_SIG_SENT_CB
 = 3,

13837 
	mMG_SIG_CLOSE_CONN
 = 4,

13838 
	mMG_SIG_TOMBSTONE
 = 5,

13839 
	mMG_SIG_ACCEPT
 = 6,

13842 
mg_lw_po¡_sigÇl
(
mg_sig_ty³
 
sig
, 
mg_cÚÃùiÚ
 *
nc
);

13845 
mg_lw_mgr_scheduË_pŞl
(
mg_mgr
 *
mgr
);

13850 #ifdeà
MG_MODULE_LINES


13858 #ià
MG_ENABLE_NET_IF_LWIP_LOW_LEVEL


13860 
	~<lw/pbuf.h
>

13861 
	~<lw/tı.h
>

13862 #ià
CS_PLATFORM
 !ğ
CS_P_STM32


13863 
	~<lw/tı_im¶.h
>

13865 
	~<lw/udp.h
>

13873 #ià
MG_ENABLE_IPV6


13874 
	#TCP_NEW
 
tı_Ãw_6


	)

13875 
	#TCP_BIND
 
tı_bšd_6


	)

13876 
	#UDP_BIND
 
udp_bšd_6


	)

13877 
	#IPADDR_NTOA
(
x
è
	`6addr_Áß
((cÚ¡ 
6_addr_t
 *)(x))

	)

13878 
	#SET_ADDR
(
d¡
, 
¤c
) \

13879 
	`memıy
((
d¡
)->
sš6
.
sš6_addr
.
s6_addr
, (
¤c
)->
6
.
addr
, \

13880 ((
d¡
)->
sš6
.
sš6_addr
.
s6_addr
))

	)

13882 
	#TCP_NEW
 
tı_Ãw


	)

13883 
	#TCP_BIND
 
tı_bšd


	)

13884 
	#UDP_BIND
 
udp_bšd


	)

13885 
	#IPADDR_NTOA
 
addr_Áß


	)

13886 
	#SET_ADDR
(
d¡
, 
¤c
è(d¡)->
sš
.
sš_addr
.
s_addr
 = 
	`GET_IPV4
(¤c)

	)

13892 #ià!
defšed
(
LWIP_IPV6
) || !LWIP_IPV6

13893 
	#GET_IPV4
(
X_addr
è((X_addr)->
addr
)

	)

13895 
	#GET_IPV4
(
X_addr
è((X_addr)->
4
.
addr
)

	)

13898 
mg_lw_s¦_do_hs
(
mg_cÚÃùiÚ
 *
nc
);

13899 
mg_lw_s¦_£nd
(
mg_cÚÃùiÚ
 *
nc
);

13900 
mg_lw_s¦_»cv
(
mg_cÚÃùiÚ
 *
nc
);

13902 
mg_lw_if_š™
(
mg_içû
 *
içû
);

13903 
mg_lw_if_ä“
(
mg_içû
 *
içû
);

13904 
mg_lw_if_add_cÚn
(
mg_cÚÃùiÚ
 *
nc
);

13905 
mg_lw_if_»move_cÚn
(
mg_cÚÃùiÚ
 *
nc
);

13906 
time_t
 
mg_lw_if_pŞl
(
mg_içû
 *
içû
, 
timeout_ms
);

13908 #ifdeà
RTOS_SDK


13909 
mgos_lock
();

13910 
mgos_uÆock
();

13912 
	#mgos_lock
()

	)

13913 
	#mgos_uÆock
()

	)

13916 
mg_lw_»cv_commÚ
(
mg_cÚÃùiÚ
 *
nc
, 
pbuf
 *
p
);

13918 #ià
LWIP_TCP_KEEPALIVE


13919 
	$mg_lw_£t_k“·live_·¿ms
(
mg_cÚÃùiÚ
 *
nc
, 
idË
,

13920 
š‹rv®
, 
couÁ
) {

13921 ià(
nc
->
sock
 =ğ
INVALID_SOCKET
 ||‚c->
æags
 & 
MG_F_UDP
) {

13924 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

13925 
tı_pcb
 *
cb
 = 
cs
->
pcb
.
tı
;

13926 ià(
idË
 > 0 && 
š‹rv®
 > 0 && 
couÁ
 > 0) {

13927 
cb
->
k“p_idË
 = 
idË
 * 1000;

13928 
cb
->
k“p_štvl
 = 
š‹rv®
 * 1000;

13929 
cb
->
k“p_út
 = 
couÁ
;

13930 
cb
->
so_İtiÚs
 |ğ
SOF_KEEPALIVE
;

13932 
cb
->
so_İtiÚs
 &ğ~
SOF_KEEPALIVE
;

13934 
	}
}

13935 #–ià!
defšed
(
MG_NO_LWIP_TCP_KEEPALIVE
)

13936 #w¬nšg 
LWIP
 
TCP
 
k“·live
 
is
 
di§bËd
. 
PËa£
 
cÚsid”
 
’ablšg
 
™
.

13939 
”r_t
 
	$mg_lw_tı_cÚn_cb
(*
¬g
, 
tı_pcb
 *
cb
, 
”r_t
 
”r
) {

13940 
mg_cÚÃùiÚ
 *
nc
 = (mg_cÚÃùiÚ *è
¬g
;

13941 
	`DBG
(("%°cÚÃùØ%s:%u = %d", 
nc
, 
	`IPADDR_NTOA
(
	`X_2_
(&
cb
->
»mÙe_
)),

13942 
cb
->
»mÙe_pÜt
, 
”r
));

13943 ià(
nc
 =ğ
NULL
) {

13944 
	`tı_abÜt
(
cb
);

13945  
ERR_ARG
;

13947 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

13948 
cs
->
”r
 =ƒrr;

13949 #ià
LWIP_TCP_KEEPALIVE


13950 ià(
”r
 =ğ0è
	`mg_lw_£t_k“·live_·¿ms
(
nc
, 60, 10, 6);

13952 
	`mg_lw_po¡_sigÇl
(
MG_SIG_CONNECT_RESULT
, 
nc
);

13953  
ERR_OK
;

13954 
	}
}

13956 
	$mg_lw_tı_”rÜ_cb
(*
¬g
, 
”r_t
 
”r
) {

13957 
mg_cÚÃùiÚ
 *
nc
 = (mg_cÚÃùiÚ *è
¬g
;

13958 
	`DBG
(("%°cÚÀ”rÜ %d", 
nc
, 
”r
));

13959 ià(
nc
 =ğ
NULL
) ;

13960 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

13961 
cs
->
pcb
.
tı
 = 
NULL
;

13962 ià(
nc
->
æags
 & 
MG_F_CONNECTING
) {

13963 
cs
->
”r
 =ƒrr;

13964 
	`mg_lw_po¡_sigÇl
(
MG_SIG_CONNECT_RESULT
, 
nc
);

13966 
	`mg_lw_po¡_sigÇl
(
MG_SIG_CLOSE_CONN
, 
nc
);

13968 
	}
}

13970 
”r_t
 
	$mg_lw_tı_»cv_cb
(*
¬g
, 
tı_pcb
 *
cb
,

13971 
pbuf
 *
p
, 
”r_t
 
”r
) {

13972 
mg_cÚÃùiÚ
 *
nc
 = (mg_cÚÃùiÚ *è
¬g
;

13973 
	`DBG
(("%°%°%u %d", 
nc
, 
cb
, (
p
 !ğ
NULL
 ?…->
tÙ_Ën
 : 0), 
”r
));

13974 ià(
p
 =ğ
NULL
) {

13975 ià(
nc
 !ğ
NULL
) {

13976 
	`mg_lw_po¡_sigÇl
(
MG_SIG_CLOSE_CONN
, 
nc
);

13980  
ERR_OK
;

13981 } ià(
nc
 =ğ
NULL
) {

13982 
	`tı_abÜt
(
cb
);

13983  
ERR_ARG
;

13985 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

13990 ià(
p
->
Ãxt
 !ğ
NULL
) {

13991 
pbuf
 *
q
 = 
p
->
Ãxt
;

13992 ; 
q
 !ğ
NULL
; q = q->
Ãxt
è
	`pbuf_»f
(q);

13994 ià(
cs
->
rx_chaš
 =ğ
NULL
) {

13995 
cs
->
rx_off£t
 = 0;

13996 } ià(
	`pbuf_ş’
(
cs
->
rx_chaš
) >= 4) {

14000 
pbuf
 *
Å
 = 
	`pbuf_®loc
(
PBUF_RAW
, 
p
->
tÙ_Ën
, 
PBUF_RAM
);

14001 ià(
Å
 !ğ
NULL
) {

14002 
	`pbuf_cİy
(
Å
, 
p
);

14003 
	`pbuf_ä“
(
p
);

14004 
p
 = 
Å
;

14007 
	`mg_lw_»cv_commÚ
(
nc
, 
p
);

14008  
ERR_OK
;

14009 
	}
}

14011 
	$mg_lw_hªdË_»cv_tı
(
mg_cÚÃùiÚ
 *
nc
) {

14012 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14014 #ià
MG_ENABLE_SSL


14015 ià(
nc
->
æags
 & 
MG_F_SSL
) {

14016 ià(
nc
->
æags
 & 
MG_F_SSL_HANDSHAKE_DONE
) {

14017 
	`mg_lw_s¦_»cv
(
nc
);

14019 
	`mg_lw_s¦_do_hs
(
nc
);

14025 
	`mgos_lock
();

14026 
cs
->
rx_chaš
 !ğ
NULL
) {

14027 
pbuf
 *
£g
 = 
cs
->
rx_chaš
;

14028 
size_t
 
Ën
 = (
£g
->ËÀ- 
cs
->
rx_off£t
);

14029 *
d©a
 = (*è
	`m®loc
(
Ën
);

14030 ià(
d©a
 =ğ
NULL
) {

14031 
	`mgos_uÆock
();

14032 
	`DBG
(("OOM"));

14035 
	`pbuf_cİy_·¹Ÿl
(
£g
, 
d©a
, 
Ën
, 
cs
->
rx_off£t
);

14036 
	`mgos_uÆock
();

14037 
	`mg_if_»cv_tı_cb
(
nc
, 
d©a
, 
Ën
, 1 );

14038 
	`mgos_lock
();

14039 
cs
->
rx_off£t
 +ğ
Ën
;

14040 ià(
cs
->
rx_off£t
 =ğcs->
rx_chaš
->
Ën
) {

14041 
cs
->
rx_chaš
 = 
	`pbuf_dechaš
(cs->rx_chain);

14042 
	`pbuf_ä“
(
£g
);

14043 
cs
->
rx_off£t
 = 0;

14046 
	`mgos_uÆock
();

14048 ià(
nc
->
£nd_mbuf
.
Ën
 > 0) {

14049 
	`mg_lw_mgr_scheduË_pŞl
(
nc
->
mgr
);

14051 
	}
}

14053 
”r_t
 
	$mg_lw_tı_£Á_cb
(*
¬g
, 
tı_pcb
 *
cb
,

14054 
u16_t
 
num_£Á
) {

14055 
mg_cÚÃùiÚ
 *
nc
 = (mg_cÚÃùiÚ *è
¬g
;

14056 
	`DBG
(("%°%°%u", 
nc
, 
cb
, 
num_£Á
));

14057 ià(
nc
 =ğ
NULL
) {

14058 
	`tı_abÜt
(
cb
);

14059  
ERR_ABRT
;

14061 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14062 
cs
->
num_£Á
 +=‚um_sent;

14064 
	`mg_lw_po¡_sigÇl
(
MG_SIG_SENT_CB
, 
nc
);

14065  
ERR_OK
;

14066 
	}
}

14068 
	$mg_lw_if_cÚÃù_tı
(
mg_cÚÃùiÚ
 *
nc
,

14069 cÚ¡ 
sock‘_add»ss
 *
§
) {

14070 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14071 
tı_pcb
 *
cb
 = 
	`TCP_NEW
();

14072 
cs
->
pcb
.
tı
 = 
cb
;

14073 
_addr_t
 *

 = (_addr_ˆ*è&
§
->
sš
.
sš_addr
.
s_addr
;

14074 
u16_t
 
pÜt
 = 
	`Áohs
(
§
->
sš
.
sš_pÜt
);

14075 
	`tı_¬g
(
cb
, 
nc
);

14076 
	`tı_”r
(
cb
, 
mg_lw_tı_”rÜ_cb
);

14077 
	`tı_£Á
(
cb
, 
mg_lw_tı_£Á_cb
);

14078 
	`tı_»cv
(
cb
, 
mg_lw_tı_»cv_cb
);

14079 
cs
->
”r
 = 
	`TCP_BIND
(
cb
, 
IP_ADDR_ANY
, 0 );

14080 
	`DBG
(("%°tı_bšd = %d", 
nc
, 
cs
->
”r
));

14081 ià(
cs
->
”r
 !ğ
ERR_OK
) {

14082 
	`mg_lw_po¡_sigÇl
(
MG_SIG_CONNECT_RESULT
, 
nc
);

14085 
cs
->
”r
 = 
	`tı_cÚÃù
(
cb
, 

, 
pÜt
, 
mg_lw_tı_cÚn_cb
);

14086 
	`DBG
(("%°tı_cÚÃù %°ğ%d", 
nc
, 
cb
, 
cs
->
”r
));

14087 ià(
cs
->
”r
 !ğ
ERR_OK
) {

14088 
	`mg_lw_po¡_sigÇl
(
MG_SIG_CONNECT_RESULT
, 
nc
);

14091 
	}
}

14097 #ià
CS_PLATFORM
 =ğ
CS_P_NRF51
 || CS_PLATFORM =ğ
CS_P_NRF52
 || \

14098 
	gCS_PLATFORM
 =ğ
CS_P_STM32


14099 
	$mg_lw_udp_»cv_cb
(*
¬g
, 
udp_pcb
 *
pcb
, 
pbuf
 *
p
,

14100 cÚ¡ 
_addr_t
 *
addr
, 
u16_t
 
pÜt
)

14102 
	$mg_lw_udp_»cv_cb
(*
¬g
, 
udp_pcb
 *
pcb
, 
pbuf
 *
p
,

14103 
_addr_t
 *
addr
, 
u16_t
 
pÜt
)

14106 
mg_cÚÃùiÚ
 *
nc
 = (mg_cÚÃùiÚ *è
¬g
;

14107 
	`DBG
(("%°%s:%u %°%u %u", 
nc
, 
	`IPADDR_NTOA
(
addr
), 
pÜt
, 
p
,…->
»f
,…->
Ën
));

14109 
pbuf
 *
§p
 =

14110 
	`pbuf_®loc
(
PBUF_RAW
, (
sock‘_add»ss
), 
PBUF_RAM
);

14111 ià(
§p
 =ğ
NULL
) {

14112 
	`pbuf_ä“
(
p
);

14115 
sock‘_add»ss
 *
§
 = (sock‘_add»s *è
§p
->
·ylßd
;

14116 
§
->
sš
.
sš_addr
.
s_addr
 = 
addr
->addr;

14117 
§
->
sš
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

14119 
p
 = 
	`pbuf_cßËsû
Õ, 
PBUF_RAW
);

14120 
	`pbuf_chaš
(
§p
, 
p
);

14121 
	`mg_lw_»cv_commÚ
(
nc
, 
§p
);

14122 (è
pcb
;

14123 
	}
}

14125 
	$mg_lw_»cv_commÚ
(
mg_cÚÃùiÚ
 *
nc
, 
pbuf
 *
p
) {

14126 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14127 
	`mgos_lock
();

14128 ià(
cs
->
rx_chaš
 =ğ
NULL
) {

14129 
cs
->
rx_chaš
 = 
p
;

14131 
	`pbuf_chaš
(
cs
->
rx_chaš
, 
p
);

14133 ià(!
cs
->
»cv_³ndšg
) {

14134 
cs
->
»cv_³ndšg
 = 1;

14135 
	`mg_lw_po¡_sigÇl
(
MG_SIG_RECV
, 
nc
);

14137 
	`mgos_uÆock
();

14138 
	}
}

14140 
	$mg_lw_hªdË_»cv_udp
(
mg_cÚÃùiÚ
 *
nc
) {

14141 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14146 
cs
->
rx_chaš
 !ğ
NULL
) {

14147 
pbuf
 *
§p
 = 
cs
->
rx_chaš
;

14148 
pbuf
 *
p
 = 
§p
->
Ãxt
;

14149 
cs
->
rx_chaš
 = 
	`pbuf_dechaš
(
p
);

14150 
size_t
 
d©a_Ën
 = 
p
->
Ën
;

14151 *
d©a
 = (*è
	`m®loc
(
d©a_Ën
);

14152 ià(
d©a
 !ğ
NULL
) {

14153 
	`pbuf_cİy_·¹Ÿl
(
p
, 
d©a
, 
d©a_Ën
, 0);

14154 
	`pbuf_ä“
(
p
);

14155 
	`mg_if_»cv_udp_cb
(
nc
, 
d©a
, 
d©a_Ën
,

14156 (
sock‘_add»ss
 *è
§p
->
·ylßd
, s­->
Ën
);

14157 
	`pbuf_ä“
(
§p
);

14159 
	`pbuf_ä“
(
p
);

14160 
	`pbuf_ä“
(
§p
);

14163 
	}
}

14165 
	$mg_lw_if_cÚÃù_udp
(
mg_cÚÃùiÚ
 *
nc
) {

14166 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14167 
udp_pcb
 *
upcb
 = 
	`udp_Ãw
();

14168 
cs
->
”r
 = 
	`UDP_BIND
(
upcb
, 
IP_ADDR_ANY
, 0 );

14169 
	`DBG
(("%°udp_bšd %°ğ%d", 
nc
, 
upcb
, 
cs
->
”r
));

14170 ià(
cs
->
”r
 =ğ
ERR_OK
) {

14171 
	`udp_»cv
(
upcb
, 
mg_lw_udp_»cv_cb
, 
nc
);

14172 
cs
->
pcb
.
udp
 = 
upcb
;

14174 
	`udp_»move
(
upcb
);

14176 
	`mg_lw_po¡_sigÇl
(
MG_SIG_CONNECT_RESULT
, 
nc
);

14177 
	}
}

14179 
	$mg_lw_acû±_cÚn
(
mg_cÚÃùiÚ
 *
nc
, 
tı_pcb
 *
cb
) {

14180 
sock‘_add»ss
 
§
;

14181 
	`SET_ADDR
(&
§
, &
cb
->
»mÙe_
);

14182 
§
.
sš
.
sš_pÜt
 = 
	`htÚs
(
cb
->
»mÙe_pÜt
);

14183 
	`mg_if_acû±_tı_cb
(
nc
, &
§
, (§.
sš
));

14184 
	}
}

14186 
	$mg_lw_hªdË_acû±
(
mg_cÚÃùiÚ
 *
nc
) {

14187 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14188 #ià
MG_ENABLE_SSL


14189 ià(
cs
->
lc
->
æags
 & 
MG_F_SSL
) {

14190 ià(
	`mg_s¦_if_cÚn_acû±
(
nc
, 
cs
->
lc
è!ğ
MG_SSL_OK
) {

14191 
	`LOG
(
LL_ERROR
, ("SSLƒrror"));

14192 
	`tı_şo£
(
cs
->
pcb
.
tı
);

14197 
	`mg_lw_acû±_cÚn
(
nc
, 
cs
->
pcb
.
tı
);

14199 
	}
}

14201 
”r_t
 
	$mg_lw_acû±_cb
(*
¬g
, 
tı_pcb
 *
Ãwcb
, 
”r_t
 
”r
) {

14202 
mg_cÚÃùiÚ
 *
lc
 = (mg_cÚÃùiÚ *è
¬g
;

14203 
	`DBG
(("%°cÚÀ%°äom %s:%u", 
lc
, 
Ãwcb
,

14204 
	`IPADDR_NTOA
(
	`X_2_
(&
Ãwcb
->
»mÙe_
)),‚ewcb->
»mÙe_pÜt
));

14205 
mg_cÚÃùiÚ
 *
nc
 = 
	`mg_if_acû±_Ãw_cÚn
(
lc
);

14206 ià(
nc
 =ğ
NULL
) {

14207 
	`tı_abÜt
(
Ãwcb
);

14208  
ERR_ABRT
;

14210 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14211 
cs
->
lc
 =†c;

14212 
cs
->
pcb
.
tı
 = 
Ãwcb
;

14215 
	`tı_¬g
(
Ãwcb
, 
nc
);

14216 
	`tı_”r
(
Ãwcb
, 
mg_lw_tı_”rÜ_cb
);

14217 
	`tı_£Á
(
Ãwcb
, 
mg_lw_tı_£Á_cb
);

14218 
	`tı_»cv
(
Ãwcb
, 
mg_lw_tı_»cv_cb
);

14219 #ià
LWIP_TCP_KEEPALIVE


14220 
	`mg_lw_£t_k“·live_·¿ms
(
nc
, 60, 10, 6);

14222 
	`mg_lw_po¡_sigÇl
(
MG_SIG_ACCEPT
, 
nc
);

14223 (è
”r
;

14224  
ERR_OK
;

14225 
	}
}

14227 
	$mg_lw_if_li¡’_tı
(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
) {

14228 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14229 
tı_pcb
 *
cb
 = 
	`TCP_NEW
();

14230 
_addr_t
 *

 = (_addr_ˆ*è&
§
->
sš
.
sš_addr
.
s_addr
;

14231 
u16_t
 
pÜt
 = 
	`Áohs
(
§
->
sš
.
sš_pÜt
);

14232 
cs
->
”r
 = 
	`TCP_BIND
(
cb
, 

, 
pÜt
);

14233 
	`DBG
(("%°tı_bšd(%s:%uèğ%d", 
nc
, 
	`IPADDR_NTOA
(

), 
pÜt
, 
cs
->
”r
));

14234 ià(
cs
->
”r
 !ğ
ERR_OK
) {

14235 
	`tı_şo£
(
cb
);

14238 
	`tı_¬g
(
cb
, 
nc
);

14239 
cb
 = 
	`tı_li¡’
(tpcb);

14240 
cs
->
pcb
.
tı
 = 
cb
;

14241 
	`tı_acû±
(
cb
, 
mg_lw_acû±_cb
);

14243 
	}
}

14245 
	$mg_lw_if_li¡’_udp
(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
) {

14246 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14247 
udp_pcb
 *
upcb
 = 
	`udp_Ãw
();

14248 
_addr_t
 *

 = (_addr_ˆ*è&
§
->
sš
.
sš_addr
.
s_addr
;

14249 
u16_t
 
pÜt
 = 
	`Áohs
(
§
->
sš
.
sš_pÜt
);

14250 
cs
->
”r
 = 
	`UDP_BIND
(
upcb
, 

, 
pÜt
);

14251 
	`DBG
(("%°udb_bšd(%s:%uèğ%d", 
nc
, 
	`IPADDR_NTOA
(

), 
pÜt
, 
cs
->
”r
));

14252 ià(
cs
->
”r
 !ğ
ERR_OK
) {

14253 
	`udp_»move
(
upcb
);

14256 
	`udp_»cv
(
upcb
, 
mg_lw_udp_»cv_cb
, 
nc
);

14257 
cs
->
pcb
.
udp
 = 
upcb
;

14259 
	}
}

14261 
	$mg_lw_tı_wr™e
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
d©a
,

14262 
ušt16_t
 
Ën
) {

14263 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14264 
tı_pcb
 *
cb
 = 
cs
->
pcb
.
tı
;

14265 
Ën
 = 
	`MIN
(
cb
->
mss
, MINÖ’,pcb->
¢d_buf
));

14266 ià(
Ën
 == 0) {

14267 
	`DBG
(("%°nØbuàava %u %u %u %°%p", 
cb
,pcb->
acked
,pcb->
¢d_buf
,

14268 
cb
->
¢d_queu–’
,pcb->
un£Á
,pcb->
uÇcked
));

14269 
	`tı_ouut
(
cb
);

14278 #ià
CS_PLATFORM
 =ğ
CS_P_ESP8266


14279 ià(
cb
->
uÇcked
 !ğ
NULL
) {

14282 ià(
cb
->
un£Á
 !ğ
NULL
) {

14283 
Ën
 = 
	`MIN
Ö’, (
TCP_MSS
 - 
cb
->
un£Á
->len));

14286 
”r_t
 
”r
 = 
	`tı_wr™e
(
cb
, 
d©a
, 
Ën
, 
TCP_WRITE_FLAG_COPY
);

14287 
	`DBG
(("%°tı_wr™%u = %d", 
cb
, 
Ën
, 
”r
));

14288 ià(
”r
 !ğ
ERR_OK
) {

14293  (
”r
 =ğ
ERR_MEM
 ? 0 : -1);

14295  
Ën
;

14296 
	}
}

14298 
	$mg_lw_£nd_mÜe
(
mg_cÚÃùiÚ
 *
nc
) {

14299 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14300 ià(
nc
->
sock
 =ğ
INVALID_SOCKET
 || 
cs
->
pcb
.
tı
 =ğ
NULL
) {

14301 
	`DBG
(("%°šv®id sock‘", 
nc
));

14304 
num_wr™‹n
 = 
	`mg_lw_tı_wr™e
(
nc
,‚c->
£nd_mbuf
.
buf
,‚c->£nd_mbuf.
Ën
);

14305 
	`DBG
(("%°mg_lw_tı_wr™%u = %d", 
nc
,‚c->
£nd_mbuf
.
Ën
, 
num_wr™‹n
));

14306 ià(
num_wr™‹n
 == 0) ;

14307 ià(
num_wr™‹n
 < 0) {

14308 
	`mg_lw_po¡_sigÇl
(
MG_SIG_CLOSE_CONN
, 
nc
);

14310 
	`mbuf_»move
(&
nc
->
£nd_mbuf
, 
num_wr™‹n
);

14311 
	`mbuf_Œim
(&
nc
->
£nd_mbuf
);

14312 
	}
}

14314 
	$mg_lw_if_tı_£nd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
,

14315 
size_t
 
Ën
) {

14316 
	`mbuf_­³nd
(&
nc
->
£nd_mbuf
, 
buf
, 
Ën
);

14317 
	`mg_lw_mgr_scheduË_pŞl
(
nc
->
mgr
);

14318 
	}
}

14320 
	$mg_lw_if_udp_£nd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
,

14321 
size_t
 
Ën
) {

14322 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14323 ià(
nc
->
sock
 =ğ
INVALID_SOCKET
 || 
cs
->
pcb
.
udp
 =ğ
NULL
) {

14329 
	`DBG
(("%°sock‘ i nÙ cÚÃùed", 
nc
));

14332 
udp_pcb
 *
upcb
 = 
cs
->
pcb
.
udp
;

14333 
pbuf
 *
p
 = 
	`pbuf_®loc
(
PBUF_TRANSPORT
, 
Ën
, 
PBUF_RAM
);

14334 
_addr_t
 *

 = (_addr_ˆ*è&
nc
->
§
.
sš
.
sš_addr
.
s_addr
;

14335 
u16_t
 
pÜt
 = 
	`Áohs
(
nc
->
§
.
sš
.
sš_pÜt
);

14336 ià(
p
 =ğ
NULL
) {

14337 
	`DBG
(("OOM"));

14340 
	`memıy
(
p
->
·ylßd
, 
buf
, 
Ën
);

14341 
cs
->
”r
 = 
	`udp_£ndto
(
upcb
, 
p
, (
_addr_t
 *è

, 
pÜt
);

14342 
	`DBG
(("%°udp_£ndtØğ%d", 
nc
, 
cs
->
”r
));

14343 
	`pbuf_ä“
(
p
);

14344 ià(
cs
->
”r
 !ğ
ERR_OK
) {

14345 
	`mg_lw_po¡_sigÇl
(
MG_SIG_CLOSE_CONN
, 
nc
);

14347 
cs
->
num_£Á
 +ğ
Ën
;

14348 
	`mg_lw_po¡_sigÇl
(
MG_SIG_SENT_CB
, 
nc
);

14350 
	}
}

14352 
	$mg_lw_if_»cved
(
mg_cÚÃùiÚ
 *
nc
, 
size_t
 
Ën
) {

14353 ià(
nc
->
æags
 & 
MG_F_UDP
) ;

14354 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14355 ià(
nc
->
sock
 =ğ
INVALID_SOCKET
 || 
cs
->
pcb
.
tı
 =ğ
NULL
) {

14356 
	`DBG
(("%°šv®id sock‘", 
nc
));

14359 
	`DBG
(("%°%°%u", 
nc
, 
cs
->
pcb
.
tı
, 
Ën
));

14362 #ià
MG_ENABLE_SSL


14363 ià(!(
nc
->
æags
 & 
MG_F_SSL
)) {

14364 
	`tı_»cved
(
cs
->
pcb
.
tı
, 
Ën
);

14367 
	`tı_»cved
(
cs
->
pcb
.
tı
, 
Ën
);

14369 
	`mbuf_Œim
(&
nc
->
»cv_mbuf
);

14370 
	}
}

14372 
	$mg_lw_if_ü—‹_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

14373 
mg_lw_cÚn_¡©e
 *
cs
 =

14374 (
mg_lw_cÚn_¡©e
 *è
	`ÿÎoc
(1, (*
cs
));

14375 ià(
cs
 =ğ
NULL
)  0;

14376 
cs
->
nc
 =‚c;

14377 
nc
->
sock
 = (
šŒ_t
è
cs
;

14379 
	}
}

14381 
	$mg_lw_if_de¡roy_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

14382 ià(
nc
->
sock
 =ğ
INVALID_SOCKET
) ;

14383 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14384 ià(!(
nc
->
æags
 & 
MG_F_UDP
)) {

14385 
tı_pcb
 *
cb
 = 
cs
->
pcb
.
tı
;

14386 ià(
cb
 !ğ
NULL
) {

14387 
	`tı_¬g
(
cb
, 
NULL
);

14388 
	`DBG
(("%°tı_şo£ %p", 
nc
, 
cb
));

14389 
	`tı_¬g
(
cb
, 
NULL
);

14390 
	`tı_şo£
(
cb
);

14392 
cs
->
rx_chaš
 !ğ
NULL
) {

14393 
pbuf
 *
£g
 = 
cs
->
rx_chaš
;

14394 
cs
->
rx_chaš
 = 
	`pbuf_dechaš
(cs->rx_chain);

14395 
	`pbuf_ä“
(
£g
);

14397 
	`mem£t
(
cs
, 0, (*cs));

14398 
	`ä“
(
cs
);

14399 } ià(
nc
->
li¡’”
 =ğ
NULL
) {

14401 
udp_pcb
 *
upcb
 = 
cs
->
pcb
.
udp
;

14402 ià(
upcb
 !ğ
NULL
) {

14403 
	`DBG
(("%°udp_»mov%p", 
nc
, 
upcb
));

14404 
	`udp_»move
(
upcb
);

14406 
	`mem£t
(
cs
, 0, (*cs));

14407 
	`ä“
(
cs
);

14409 
nc
->
sock
 = 
INVALID_SOCKET
;

14410 
	}
}

14412 
	$mg_lw_if_g‘_cÚn_addr
(
mg_cÚÃùiÚ
 *
nc
, 
»mÙe
,

14413 
sock‘_add»ss
 *
§
) {

14414 
	`mem£t
(
§
, 0, (*sa));

14415 ià(
nc
->
sock
 =ğ
INVALID_SOCKET
) ;

14416 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14417 ià(
nc
->
æags
 & 
MG_F_UDP
) {

14418 
udp_pcb
 *
upcb
 = 
cs
->
pcb
.
udp
;

14419 ià(
»mÙe
) {

14420 
	`memıy
(
§
, &
nc
->sa, (*sa));

14422 
§
->
sš
.
sš_pÜt
 = 
	`htÚs
(
upcb
->
loÿl_pÜt
);

14423 
	`SET_ADDR
(
§
, &
upcb
->
loÿl_
);

14426 
tı_pcb
 *
cb
 = 
cs
->
pcb
.
tı
;

14427 ià(
»mÙe
) {

14428 
§
->
sš
.
sš_pÜt
 = 
	`htÚs
(
cb
->
»mÙe_pÜt
);

14429 
	`SET_ADDR
(
§
, &
cb
->
»mÙe_
);

14431 
§
->
sš
.
sš_pÜt
 = 
	`htÚs
(
cb
->
loÿl_pÜt
);

14432 
	`SET_ADDR
(
§
, &
cb
->
loÿl_
);

14435 
	}
}

14437 
	$mg_lw_if_sock_£t
(
mg_cÚÃùiÚ
 *
nc
, 
sock_t
 
sock
) {

14438 
nc
->
sock
 = sock;

14439 
	}
}

14442 
	#MG_LWIP_IFACE_VTABLE
 \

14444 
mg_lw_if_š™
, \

14445 
mg_lw_if_ä“
, \

14446 
mg_lw_if_add_cÚn
, \

14447 
mg_lw_if_»move_cÚn
, \

14448 
mg_lw_if_pŞl
, \

14449 
mg_lw_if_li¡’_tı
, \

14450 
mg_lw_if_li¡’_udp
, \

14451 
mg_lw_if_cÚÃù_tı
, \

14452 
mg_lw_if_cÚÃù_udp
, \

14453 
mg_lw_if_tı_£nd
, \

14454 
mg_lw_if_udp_£nd
, \

14455 
mg_lw_if_»cved
, \

14456 
mg_lw_if_ü—‹_cÚn
, \

14457 
mg_lw_if_de¡roy_cÚn
, \

14458 
mg_lw_if_sock_£t
, \

14459 
mg_lw_if_g‘_cÚn_addr
, \

14460 }

	)

14463 
mg_içû_vbË
 
	gmg_lw_içû_vbË
 = 
MG_LWIP_IFACE_VTABLE
;

14464 #ià
MG_NET_IF
 =ğ
MG_NET_IF_LWIP_LOW_LEVEL


14465 
mg_içû_vbË
 
	gmg_deçuÉ_içû_vbË
 = 
MG_LWIP_IFACE_VTABLE
;

14469 #ifdeà
MG_MODULE_LINES


14477 #ià
MG_NET_IF
 =ğ
MG_NET_IF_LWIP_LOW_LEVEL


14479 #iâdeà
MG_SIG_QUEUE_LEN


14480 
	#MG_SIG_QUEUE_LEN
 32

	)

14483 
	smg_ev_mgr_lw_sigÇl
 {

14484 
	msig
;

14485 
mg_cÚÃùiÚ
 *
	mnc
;

14488 
	smg_ev_mgr_lw_d©a
 {

14489 
mg_ev_mgr_lw_sigÇl
 
	msig_queue
[
MG_SIG_QUEUE_LEN
];

14490 
	msig_queue_Ën
;

14491 
	m¡¬t_šdex
;

14494 
	$mg_lw_po¡_sigÇl
(
mg_sig_ty³
 
sig
, 
mg_cÚÃùiÚ
 *
nc
) {

14495 
mg_ev_mgr_lw_d©a
 *
md
 =

14496 (
mg_ev_mgr_lw_d©a
 *è
nc
->
içû
->
d©a
;

14497 
	`mgos_lock
();

14498 ià(
md
->
sig_queue_Ën
 >ğ
MG_SIG_QUEUE_LEN
) {

14499 
	`mgos_uÆock
();

14502 
’d_šdex
 = (
md
->
¡¬t_šdex
 + md->
sig_queue_Ën
è% 
MG_SIG_QUEUE_LEN
;

14503 
md
->
sig_queue
[
’d_šdex
].
sig
 = sig;

14504 
md
->
sig_queue
[
’d_šdex
].
nc
 =‚c;

14505 
md
->
sig_queue_Ën
++;

14506 
	`mg_lw_mgr_scheduË_pŞl
(
nc
->
mgr
);

14507 
	`mgos_uÆock
();

14508 
	}
}

14510 
	$mg_ev_mgr_lw_´oûss_sigÇls
(
mg_mgr
 *
mgr
) {

14511 
mg_ev_mgr_lw_d©a
 *
md
 =

14512 (
mg_ev_mgr_lw_d©a
 *è
mgr
->
içûs
[
MG_MAIN_IFACE
]->
d©a
;

14513 
md
->
sig_queue_Ën
 > 0) {

14514 
	`mgos_lock
();

14515 
sig
 = 
md
->
sig_queue
[md->
¡¬t_šdex
].sig;

14516 
mg_cÚÃùiÚ
 *
nc
 = 
md
->
sig_queue
[md->
¡¬t_šdex
].nc;

14517 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14518 
md
->
¡¬t_šdex
 = (md->¡¬t_šdex + 1è% 
MG_SIG_QUEUE_LEN
;

14519 
md
->
sig_queue_Ën
--;

14520 
	`mgos_uÆock
();

14521 ià(
nc
->
içû
 =ğ
NULL
 ||‚c->
mgr
 == NULL) ;

14522 
sig
) {

14523 
MG_SIG_CONNECT_RESULT
: {

14524 #ià
MG_ENABLE_SSL


14525 ià(
cs
->
”r
 =ğ0 && (
nc
->
æags
 & 
MG_F_SSL
) &&

14526 !(
nc
->
æags
 & 
MG_F_SSL_HANDSHAKE_DONE
)) {

14527 
	`mg_lw_s¦_do_hs
(
nc
);

14531 
	`mg_if_cÚÃù_cb
(
nc
, 
cs
->
”r
);

14535 
MG_SIG_CLOSE_CONN
: {

14536 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

14537 
	`mg_şo£_cÚn
(
nc
);

14540 
MG_SIG_RECV
: {

14541 
cs
->
»cv_³ndšg
 = 0;

14542 ià(
nc
->
æags
 & 
MG_F_UDP
) {

14543 
	`mg_lw_hªdË_»cv_udp
(
nc
);

14545 
	`mg_lw_hªdË_»cv_tı
(
nc
);

14549 
MG_SIG_SENT_CB
: {

14550 ià(
cs
->
num_£Á
 > 0è
	`mg_if_£Á_cb
(
nc
, cs->num_sent);

14551 
cs
->
num_£Á
 = 0;

14553 ià(
nc
->
£nd_mbuf
.
Ën
 =ğ0 && (nc->
æags
 & 
MG_F_SEND_AND_CLOSE
) &&

14554 !(
nc
->
æags
 & 
MG_F_WANT_WRITE
)) {

14555 
	`mg_şo£_cÚn
(
nc
);

14560 
MG_SIG_TOMBSTONE
: {

14563 
MG_SIG_ACCEPT
: {

14564 
	`mg_lw_hªdË_acû±
(
nc
);

14569 
	}
}

14571 
	$mg_lw_if_š™
(
mg_içû
 *
içû
) {

14572 
	`LOG
(
LL_INFO
, ("%p Mongoose init"));

14573 
içû
->
d©a
 = 
	`MG_CALLOC
(1, (
mg_ev_mgr_lw_d©a
));

14574 
	}
}

14576 
	$mg_lw_if_ä“
(
mg_içû
 *
içû
) {

14577 
	`MG_FREE
(
içû
->
d©a
);

14578 
içû
->
d©a
 = 
NULL
;

14579 
	}
}

14581 
	$mg_lw_if_add_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

14582 (è
nc
;

14583 
	}
}

14585 
	$mg_lw_if_»move_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

14586 
mg_ev_mgr_lw_d©a
 *
md
 =

14587 (
mg_ev_mgr_lw_d©a
 *è
nc
->
içû
->
d©a
;

14589 
i
 = 0; i < 
MG_SIG_QUEUE_LEN
; i++) {

14590 ià(
md
->
sig_queue
[
i
].
nc
 ==‚c) {

14591 
md
->
sig_queue
[
i
].
sig
 = 
MG_SIG_TOMBSTONE
;

14594 
	}
}

14596 
time_t
 
	$mg_lw_if_pŞl
(
mg_içû
 *
içû
, 
timeout_ms
) {

14597 
mg_mgr
 *
mgr
 = 
içû
->mgr;

14598 
n
 = 0;

14599 
now
 = 
	`mg_time
();

14600 
mg_cÚÃùiÚ
 *
nc
, *
tmp
;

14601 
mš_tim”
 = 0;

14602 
num_tim”s
 = 0;

14604 
	`DBG
(("begš…ŞÈ@%u", (è(
now
 * 1000)));

14606 
	`mg_ev_mgr_lw_´oûss_sigÇls
(
mgr
);

14607 
nc
 = 
mgr
->
aùive_cÚÃùiÚs
;‚ø!ğ
NULL
;‚øğ
tmp
) {

14608 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14609 
tmp
 = 
nc
->
Ãxt
;

14610 
n
++;

14611 ià((
nc
->
æags
 & 
MG_F_CLOSE_IMMEDIATELY
) ||

14612 ((
nc
->
æags
 & 
MG_F_SEND_AND_CLOSE
è&& (nc->æag & 
MG_F_UDP
) &&

14613 (
nc
->
£nd_mbuf
.
Ën
 == 0))) {

14614 
	`mg_şo£_cÚn
(
nc
);

14617 
	`mg_if_pŞl
(
nc
, 
now
);

14618 
	`mg_if_tim”
(
nc
, 
now
);

14619 #ià
MG_ENABLE_SSL


14620 ià((
nc
->
æags
 & 
MG_F_SSL
è&& 
cs
 !ğ
NULL
 && cs->
pcb
.
tı
 != NULL &&

14621 
cs
->
pcb
.
tı
->
¡©e
 =ğ
ESTABLISHED
) {

14622 ià(((
nc
->
æags
 & 
MG_F_WANT_WRITE
) ||

14623 ((
nc
->
£nd_mbuf
.
Ën
 > 0) &&

14624 (
nc
->
æags
 & 
MG_F_SSL_HANDSHAKE_DONE
))) &&

14625 
cs
->
pcb
.
tı
->
¢d_buf
 > 0) {

14627 ià(
nc
->
æags
 & 
MG_F_SSL_HANDSHAKE_DONE
) {

14628 ià(!(
nc
->
æags
 & 
MG_F_CONNECTING
)è
	`mg_lw_s¦_£nd
(nc);

14630 
	`mg_lw_s¦_do_hs
(
nc
);

14633 ià(
cs
->
rx_chaš
 !ğ
NULL
 || (
nc
->
æags
 & 
MG_F_WANT_READ
)) {

14634 ià(
nc
->
æags
 & 
MG_F_SSL_HANDSHAKE_DONE
) {

14635 ià(!(
nc
->
æags
 & 
MG_F_CONNECTING
)è
	`mg_lw_s¦_»cv
(nc);

14637 
	`mg_lw_s¦_do_hs
(
nc
);

14643 ià(!(
nc
->
æags
 & (
MG_F_CONNECTING
 | 
MG_F_UDP
))) {

14644 ià(
nc
->
£nd_mbuf
.
Ën
 > 0è
	`mg_lw_£nd_mÜe
(nc);

14647 ià(
nc
->
sock
 !ğ
INVALID_SOCKET
 &&

14648 !(
nc
->
æags
 & (
MG_F_UDP
 | 
MG_F_LISTENING
)è&& 
cs
->
pcb
.
tı
 !ğ
NULL
 &&

14649 
cs
->
pcb
.
tı
->
un£Á
 !ğ
NULL
) {

14650 
	`tı_ouut
(
cs
->
pcb
.
tı
);

14652 ià(
nc
->
ev_tim”_time
 > 0) {

14653 ià(
num_tim”s
 =ğ0 || 
nc
->
ev_tim”_time
 < 
mš_tim”
) {

14654 
mš_tim”
 = 
nc
->
ev_tim”_time
;

14656 
num_tim”s
++;

14660 
	`DBG
(("end…oll @%u, %d conns, %dimers (min %u),‚ext in %d ms",

14661 (è(
now
 * 1000), 
n
, 
num_tim”s
,

14662 (è(
mš_tim”
 * 1000), 
timeout_ms
));

14664 (è
timeout_ms
;

14665  
now
;

14666 
	}
}

14668 
ušt32_t
 
	$mg_lw_g‘_pŞl_d–ay_ms
(
mg_mgr
 *
mgr
) {

14669 
mg_cÚÃùiÚ
 *
nc
;

14670 
now
 = 
	`mg_time
();

14671 
mš_tim”
 = 0;

14672 
num_tim”s
 = 0;

14673 
	`mg_ev_mgr_lw_´oûss_sigÇls
(
mgr
);

14674 
nc
 = 
	`mg_Ãxt
(
mgr
, 
NULL
);‚c != NULL;‚c = mg_next(mgr,‚c)) {

14675 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14676 ià(
nc
->
ev_tim”_time
 > 0) {

14677 ià(
num_tim”s
 =ğ0 || 
nc
->
ev_tim”_time
 < 
mš_tim”
) {

14678 
mš_tim”
 = 
nc
->
ev_tim”_time
;

14680 
num_tim”s
++;

14682 ià(
nc
->
£nd_mbuf
.
Ën
 > 0) {

14683 
ÿn_£nd
 = 0;

14685 ià(
nc
->
æags
 & 
MG_F_UDP
) {

14687 
ÿn_£nd
 = (
cs
->
pcb
.
udp
 !ğ
NULL
);

14689 
ÿn_£nd
 = (
cs
->
pcb
.
tı
 !ğ
NULL
 && cs->pcb.tı->
¢d_buf
 > 0);

14692 ià(
ÿn_£nd
)  0;

14695 
ušt32_t
 
timeout_ms
 = ~0;

14696 ià(
num_tim”s
 > 0) {

14697 
tim”_timeout_ms
 = (
mš_tim”
 - 
now
) * 1000 + 1 ;

14698 ià(
tim”_timeout_ms
 < 
timeout_ms
) {

14699 
timeout_ms
 = 
tim”_timeout_ms
;

14702  
timeout_ms
;

14703 
	}
}

14706 #ifdeà
MG_MODULE_LINES


14714 #ià
MG_ENABLE_SSL
 && 
MG_NET_IF
 =ğ
MG_NET_IF_LWIP_LOW_LEVEL


14718 
	~<lw/pbuf.h
>

14719 
	~<lw/tı.h
>

14721 #iâdeà
MG_LWIP_SSL_IO_SIZE


14722 
	#MG_LWIP_SSL_IO_SIZE
 1024

	)

14729 #iâdeà
MG_LWIP_SSL_RECV_MBUF_LIMIT


14730 
	#MG_LWIP_SSL_RECV_MBUF_LIMIT
 3072

	)

14733 #iâdeà
MIN


14734 
	#MIN
(
a
, 
b
è(×è< (bè? (aè: (b))

	)

14737 
	$mg_lw_s¦_do_hs
(
mg_cÚÃùiÚ
 *
nc
) {

14738 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14739 
£rv”_side
 = (
nc
->
li¡’”
 !ğ
NULL
);

14740 
mg_s¦_if_»suÉ
 
»s
;

14741 ià(
nc
->
æags
 & 
MG_F_CLOSE_IMMEDIATELY
) ;

14742 
»s
 = 
	`mg_s¦_if_hªdshake
(
nc
);

14743 
	`DBG
(("%°%d %d %d", 
nc
,‚c->
æags
, 
£rv”_side
, 
»s
));

14744 ià(
»s
 !ğ
MG_SSL_OK
) {

14745 ià(
»s
 =ğ
MG_SSL_WANT_WRITE
) {

14746 
nc
->
æags
 |ğ
MG_F_WANT_WRITE
;

14747 
cs
->
”r
 = 0;

14748 } ià(
»s
 =ğ
MG_SSL_WANT_READ
) {

14753 
nc
->
æags
 &ğ~
MG_F_WANT_READ
;

14754 
cs
->
”r
 = 0;

14756 
cs
->
”r
 = 
»s
;

14757 ià(
£rv”_side
) {

14758 
	`mg_lw_po¡_sigÇl
(
MG_SIG_CLOSE_CONN
, 
nc
);

14760 
	`mg_lw_po¡_sigÇl
(
MG_SIG_CONNECT_RESULT
, 
nc
);

14764 
cs
->
”r
 = 0;

14765 
nc
->
æags
 &ğ~
MG_F_WANT_WRITE
;

14770 
nc
->
æags
 |ğ(
MG_F_SSL_HANDSHAKE_DONE
 | 
MG_F_WANT_READ
);

14771 ià(
£rv”_side
) {

14772 
	`mg_lw_acû±_cÚn
(
nc
, 
cs
->
pcb
.
tı
);

14774 
	`mg_lw_po¡_sigÇl
(
MG_SIG_CONNECT_RESULT
, 
nc
);

14777 
	}
}

14779 
	$mg_lw_s¦_£nd
(
mg_cÚÃùiÚ
 *
nc
) {

14780 ià(
nc
->
sock
 =ğ
INVALID_SOCKET
) {

14781 
	`DBG
(("%°šv®id sock‘", 
nc
));

14784 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14786 
Ën
 = 
cs
->
Ï¡_s¦_wr™e_size
;

14787 ià(
Ën
 == 0) {

14788 
Ën
 = 
	`MIN
(
MG_LWIP_SSL_IO_SIZE
, 
nc
->
£nd_mbuf
.len);

14790 
»t
 = 
	`mg_s¦_if_wr™e
(
nc
,‚c->
£nd_mbuf
.
buf
, 
Ën
);

14791 
	`DBG
(("%°SSL_wr™%u = %d, %d", 
nc
, 
Ën
, 
»t
));

14792 ià(
»t
 > 0) {

14793 
	`mbuf_»move
(&
nc
->
£nd_mbuf
, 
»t
);

14794 
	`mbuf_Œim
(&
nc
->
£nd_mbuf
);

14795 
cs
->
Ï¡_s¦_wr™e_size
 = 0;

14796 } ià(
»t
 < 0) {

14799 
cs
->
Ï¡_s¦_wr™e_size
 = 
Ën
;

14801 ià(
»t
 =ğ
Ën
) {

14802 
nc
->
æags
 &ğ~
MG_F_WANT_WRITE
;

14803 } ià(
»t
 =ğ
MG_SSL_WANT_WRITE
) {

14804 
nc
->
æags
 |ğ
MG_F_WANT_WRITE
;

14806 
	`mg_lw_po¡_sigÇl
(
MG_SIG_CLOSE_CONN
, 
nc
);

14808 
	}
}

14810 
	$mg_lw_s¦_»cv
(
mg_cÚÃùiÚ
 *
nc
) {

14811 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14813 ià(
nc
->
æags
 & 
MG_F_CONNECTING
) ;

14814 
nc
->
»cv_mbuf
.
Ën
 < 
MG_LWIP_SSL_RECV_MBUF_LIMIT
) {

14815 *
buf
 = (*è
	`m®loc
(
MG_LWIP_SSL_IO_SIZE
);

14816 ià(
buf
 =ğ
NULL
) ;

14817 
»t
 = 
	`mg_s¦_if_»ad
(
nc
, 
buf
, 
MG_LWIP_SSL_IO_SIZE
);

14818 
	`DBG
(("%°%°SSL_»ad %u = %d", 
nc
, 
cs
->
rx_chaš
, 
MG_LWIP_SSL_IO_SIZE
, 
»t
));

14819 ià(
»t
 <= 0) {

14820 
	`ä“
(
buf
);

14821 ià(
»t
 =ğ
MG_SSL_WANT_WRITE
) {

14822 
nc
->
æags
 |ğ
MG_F_WANT_WRITE
;

14824 } ià(
»t
 =ğ
MG_SSL_WANT_READ
) {

14829 
nc
->
æags
 &ğ~
MG_F_WANT_READ
;

14830 
cs
->
”r
 = 0;

14833 
	`mg_lw_po¡_sigÇl
(
MG_SIG_CLOSE_CONN
, 
nc
);

14837 
	`mg_if_»cv_tı_cb
(
nc
, 
buf
, 
»t
, 1 );

14840 
	}
}

14842 #ifdeà
KR_VERSION


14844 
ssize_t
 
	$kr_£nd
(
fd
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

14845 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
fd
;

14846 
»t
 = 
	`mg_lw_tı_wr™e
(
cs
->
nc
, 
buf
, 
Ën
);

14847 
	`DBG
(("%°mg_lw_tı_wr™%u = %d", 
cs
->
nc
, 
Ën
, 
»t
));

14848 ià(
»t
 =ğ0è»ˆğ
KR_IO_WOULDBLOCK
;

14849  
»t
;

14850 
	}
}

14852 
ssize_t
 
	$kr_»cv
(
fd
, *
buf
, 
size_t
 
Ën
) {

14853 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
fd
;

14854 
pbuf
 *
£g
 = 
cs
->
rx_chaš
;

14855 ià(
£g
 =ğ
NULL
) {

14856 
	`DBG
(("%u -‚ÙhšgØ»ad", 
Ën
));

14857  
KR_IO_WOULDBLOCK
;

14859 
size_t
 
£g_Ën
 = (
£g
->
Ën
 - 
cs
->
rx_off£t
);

14860 
	`DBG
(("%u %u %u %u", 
Ën
, 
cs
->
rx_chaš
->Ën, 
£g_Ën
, cs->rx_chaš->
tÙ_Ën
));

14861 
Ën
 = 
	`MIN
Ö’, 
£g_Ën
);

14862 
	`pbuf_cİy_·¹Ÿl
(
£g
, 
buf
, 
Ën
, 
cs
->
rx_off£t
);

14863 
cs
->
rx_off£t
 +ğ
Ën
;

14864 
	`tı_»cved
(
cs
->
pcb
.
tı
, 
Ën
);

14865 ià(
cs
->
rx_off£t
 =ğcs->
rx_chaš
->
Ën
) {

14866 
cs
->
rx_chaš
 = 
	`pbuf_dechaš
(cs->rx_chain);

14867 
	`pbuf_ä“
(
£g
);

14868 
cs
->
rx_off£t
 = 0;

14870  
Ën
;

14871 
	}
}

14873 #–ià
MG_SSL_IF
 =ğ
MG_SSL_IF_MBEDTLS


14875 
	$s¦_sock‘_£nd
(*
ùx
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

14876 
mg_cÚÃùiÚ
 *
nc
 = (mg_cÚÃùiÚ *è
ùx
;

14877 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14878 
»t
 = 
	`mg_lw_tı_wr™e
(
cs
->
nc
, 
buf
, 
Ën
);

14879 
	`LOG
(
LL_DEBUG
, ("%°%d -> %d", 
nc
, 
Ën
, 
»t
));

14880 ià(
»t
 =ğ0è»ˆğ
MBEDTLS_ERR_SSL_WANT_WRITE
;

14881  
»t
;

14882 
	}
}

14884 
	$s¦_sock‘_»cv
(*
ùx
, *
buf
, 
size_t
 
Ën
) {

14885 
mg_cÚÃùiÚ
 *
nc
 = (mg_cÚÃùiÚ *è
ùx
;

14886 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14887 
pbuf
 *
£g
 = 
cs
->
rx_chaš
;

14888 ià(
£g
 =ğ
NULL
) {

14889 
	`DBG
(("%u -‚ÙhšgØ»ad", 
Ën
));

14890  
MBEDTLS_ERR_SSL_WANT_READ
;

14892 
size_t
 
£g_Ën
 = (
£g
->
Ën
 - 
cs
->
rx_off£t
);

14893 
	`DBG
(("%u %u %u %u", 
Ën
, 
cs
->
rx_chaš
->Ën, 
£g_Ën
, cs->rx_chaš->
tÙ_Ën
));

14894 
Ën
 = 
	`MIN
Ö’, 
£g_Ën
);

14895 
	`pbuf_cİy_·¹Ÿl
(
£g
, 
buf
, 
Ën
, 
cs
->
rx_off£t
);

14896 
cs
->
rx_off£t
 +ğ
Ën
;

14899 ià(
cs
->
pcb
.
tı
 !ğ
NULL
è
	`tı_»cved
(cs->pcb.tı, 
Ën
);

14900 ià(
cs
->
rx_off£t
 =ğcs->
rx_chaš
->
Ën
) {

14901 
cs
->
rx_chaš
 = 
	`pbuf_dechaš
(cs->rx_chain);

14902 
	`pbuf_ä“
(
£g
);

14903 
cs
->
rx_off£t
 = 0;

14905 
	`LOG
(
LL_DEBUG
, ("%°<- %d", 
nc
, (è
Ën
));

14906  
Ën
;

14907 
	}
}

14912 #ifdeà
MG_MODULE_LINES


14920 #ifdeà
WINCE


14922 cÚ¡ *
	$¡»¼Ü
(
”r
) {

14927 
buf
[10];

14928 
	`¢´štf
(
buf
, (buf), "%d", 
”r
);

14929  
buf
;

14930 
	}
}

14932 
	$İ’
(cÚ¡ *
f’ame
, 
oæag
, 
pmode
) {

14938 
	`DebugB»ak
();

14940 
	}
}

14942 
	$_w¡©i64
(cÚ¡ 
wch¬_t
 *
·th
, 
cs_¡©_t
 *
¡
) {

14943 
DWORD
 
ç
 = 
	`G‘FeA‰ribu‹sW
(
·th
);

14944 ià(
ç
 =ğ
INVALID_FILE_ATTRIBUTES
) {

14947 
	`mem£t
(
¡
, 0, (*st));

14948 ià((
ç
 & 
FILE_ATTRIBUTE_DIRECTORY
) == 0) {

14949 
HANDLE
 
h
;

14950 
FILETIME
 
áime
;

14951 
¡
->
¡_mode
 |ğ
_S_IFREG
;

14952 
h
 = 
	`C»©eFeW
(
·th
, 
GENERIC_READ
, 0, 
NULL
, 
OPEN_EXISTING
,

14953 
FILE_ATTRIBUTE_NORMAL
, 
NULL
);

14954 ià(
h
 =ğ
INVALID_HANDLE_VALUE
) {

14957 
¡
->
¡_size
 = 
	`G‘FeSize
(
h
, 
NULL
);

14958 
	`G‘FeTime
(
h
, 
NULL
, NULL, &
áime
);

14959 
¡
->
¡_mtime
 = (
ušt32_t
)((((
ušt64_t
è
áime
.
dwLowD©eTime
 +

14960 ((
ušt64_t
è
áime
.
dwHighD©eTime
 << 32)) /

14963 
	`Clo£HªdË
(
h
);

14965 
¡
->
¡_mode
 |ğ
_S_IFDIR
;

14968 
	}
}

14971 
	$mg_gmt_time_¡ršg
(*
buf
, 
size_t
 
buf_Ën
, 
time_t
 *
t
) {

14972 
FILETIME
 
á
;

14973 
SYSTEMTIME
 
sy¡ime
;

14974 ià(
t
 !ğ
NULL
) {

14975 
ušt64_t
 
f‘ime
 = (*
t
 + 11644473600) * 10000000;

14976 
á
.
dwLowD©eTime
 = 
f‘ime
 & 0xFFFFFFFF;

14977 
á
.
dwHighD©eTime
 = (
f‘ime
 & 0xFFFFFFFF00000000) >> 32;

14978 
	`FeTimeToSy¡emTime
(&
á
, &
sy¡ime
);

14980 
	`G‘Sy¡emTime
(&
sy¡ime
);

14983 
	`¢´štf
(
buf
, 
buf_Ën
, "%d.%d.%d %d:%d:%d GMT", (è
sy¡ime
.
wY—r
,

14984 (è
sy¡ime
.
wMÚth
, (èsy¡ime.
wDay
, (èsy¡ime.
wHour
,

14985 (è
sy¡ime
.
wMšu‹
, (èsy¡ime.
wSecÚd
);

14986 
	}
}

14989 #ifdeà
MG_MODULE_LINES


14997 #iâdeà
CS_COMMON_PLATFORMS_PIC32_NET_IF_H_


14998 
	#CS_COMMON_PLATFORMS_PIC32_NET_IF_H_


	)

15002 #ifdeà
__ılu¥lus


15006 #iâdeà
MG_ENABLE_NET_IF_PIC32


15007 
	#MG_ENABLE_NET_IF_PIC32
 
MG_NET_IF
 =ğ
MG_NET_IF_PIC32


	)

15010 
mg_içû_vbË
 
mg_pic32_içû_vbË
;

15012 #ifdeà
__ılu¥lus


15017 #ifdeà
MG_MODULE_LINES


15025 #ià
MG_ENABLE_NET_IF_PIC32


15027 
	$mg_pic32_if_ü—‹_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

15028 (è
nc
;

15030 
	}
}

15032 
	$mg_pic32_if_»cved
(
mg_cÚÃùiÚ
 *
nc
, 
size_t
 
Ën
) {

15033 (è
nc
;

15034 (è
Ën
;

15035 
	}
}

15037 
	$mg_pic32_if_add_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

15038 (è
nc
;

15039 
	}
}

15041 
	$mg_pic32_if_š™
(
mg_içû
 *
içû
) {

15042 (è
içû
;

15043 (è
	`mg_g‘_”ºo
();

15044 
	}
}

15046 
	$mg_pic32_if_ä“
(
mg_içû
 *
içû
) {

15047 (è
içû
;

15048 
	}
}

15050 
	$mg_pic32_if_»move_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

15051 (è
nc
;

15052 
	}
}

15054 
	$mg_pic32_if_de¡roy_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

15055 ià(
nc
->
sock
 =ğ
INVALID_SOCKET
) ;

15057 ià(!(
nc
->
æags
 & 
MG_F_UDP
)) {

15059 
	`TCPIP_TCP_Clo£
((
TCP_SOCKET
è
nc
->
sock
);

15060 } ià(
nc
->
li¡’”
 =ğ
NULL
) {

15062 
	`TCPIP_UDP_Clo£
((
UDP_SOCKET
è
nc
->
sock
);

15065 
nc
->
sock
 = 
INVALID_SOCKET
;

15066 
	}
}

15068 
	$mg_pic32_if_li¡’_udp
(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
) {

15069 
nc
->
sock
 = 
	`TCPIP_UDP_S”v”O³n
(

15070 
§
->
sš
.
sš_çmy
 =ğ
AF_INET
 ? 
IP_ADDRESS_TYPE_IPV4


15071 : 
IP_ADDRESS_TYPE_IPV6
,

15072 
	`Áohs
(
§
->
sš
.
sš_pÜt
),

15073 
§
->
sš
.
sš_addr
.
s_addr
 =ğ0 ? 0 : (
IP_MULTI_ADDRESS
 *) &sa->sin);

15074 ià(
nc
->
sock
 =ğ
INVALID_SOCKET
) {

15078 
	}
}

15080 
	$mg_pic32_if_udp_£nd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
,

15081 
size_t
 
Ën
) {

15082 
	`mbuf_­³nd
(&
nc
->
£nd_mbuf
, 
buf
, 
Ën
);

15083 
	}
}

15085 
	$mg_pic32_if_tı_£nd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
,

15086 
size_t
 
Ën
) {

15087 
	`mbuf_­³nd
(&
nc
->
£nd_mbuf
, 
buf
, 
Ën
);

15088 
	}
}

15090 
	$mg_pic32_if_li¡’_tı
(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
) {

15091 
nc
->
sock
 = 
	`TCPIP_TCP_S”v”O³n
(

15092 
§
->
sš
.
sš_çmy
 =ğ
AF_INET
 ? 
IP_ADDRESS_TYPE_IPV4


15093 : 
IP_ADDRESS_TYPE_IPV6
,

15094 
	`Áohs
(
§
->
sš
.
sš_pÜt
),

15095 
§
->
sš
.
sš_addr
.
s_addr
 =ğ0 ? 0 : (
IP_MULTI_ADDRESS
 *) &sa->sin);

15096 
	`memıy
(&
nc
->
§
, sa, (*sa));

15097 ià(
nc
->
sock
 =ğ
INVALID_SOCKET
) {

15101 
	}
}

15103 
	$mg_acû±_cÚn
(
mg_cÚÃùiÚ
 *
lc
) {

15104 
mg_cÚÃùiÚ
 *
nc
;

15105 
TCP_SOCKET_INFO
 
si
;

15106 
sock‘_add»ss
 
§
;

15108 
nc
 = 
	`mg_if_acû±_Ãw_cÚn
(
lc
);

15110 ià(
nc
 =ğ
NULL
) {

15114 
nc
->
sock
 = 
lc
->sock;

15115 
nc
->
æags
 &ğ~
MG_F_LISTENING
;

15117 ià(!
	`TCPIP_TCP_Sock‘InfoG‘
((
TCP_SOCKET
è
nc
->
sock
, &
si
)) {

15121 ià(
si
.
add»ssTy³
 =ğ
IP_ADDRESS_TYPE_IPV4
) {

15122 
§
.
sš
.
sš_çmy
 = 
AF_INET
;

15123 
§
.
sš
.
sš_pÜt
 = 
	`htÚs
(
si
.
»mÙePÜt
);

15124 
§
.
sš
.
sš_addr
.
s_addr
 = 
si
.
»mÙeIPadd»ss
.
v4Add
.
V®
;

15127 
	`mem£t
(&
§
, 0, (sa));

15130 
	`mg_if_acû±_tı_cb
(
nc
, (
sock‘_add»ss
 *è&
§
, (sa));

15132  
	`mg_pic32_if_li¡’_tı
(
lc
, &lc->
§
) >= 0;

15133 
	}
}

15135 *
	$š‘_Áß
(
š_addr
 
š
) {

15136 
addr
[17];

15137 
	`¢´štf
(
addr
, ×ddr), "%d.%d.%d.%d", (è
š
.
S_un
.
S_un_b
.
s_b1
,

15138 (è
š
.
S_un
.
S_un_b
.
s_b2
, (èš.S_un.S_un_b.
s_b3
,

15139 (è
š
.
S_un
.
S_un_b
.
s_b4
);

15140  
addr
;

15141 
	}
}

15143 
	$mg_hªdË_£nd
(
mg_cÚÃùiÚ
 *
nc
) {

15144 
ušt16_t
 
by‹s_wr™‹n
 = 0;

15145 ià(
nc
->
æags
 & 
MG_F_UDP
) {

15146 ià(!
	`TCPIP_UDP_RemÙeBšd
(

15147 (
UDP_SOCKET
è
nc
->
sock
,

15148 
nc
->
§
.
sš
.
sš_çmy
 =ğ
AF_INET
 ? 
IP_ADDRESS_TYPE_IPV4


15149 : 
IP_ADDRESS_TYPE_IPV6
,

15150 
	`Áohs
(
nc
->
§
.
sš
.
sš_pÜt
), (
IP_MULTI_ADDRESS
 *) &nc->sa.sin)) {

15151 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

15154 
by‹s_wr™‹n
 = 
	`TCPIP_UDP_TxPutIsR—dy
((
UDP_SOCKET
è
nc
->
sock
, 0);

15155 ià(
by‹s_wr™‹n
 >ğ
nc
->
£nd_mbuf
.
Ën
) {

15156 ià(
	`TCPIP_UDP_A¼ayPut
((
UDP_SOCKET
è
nc
->
sock
,

15157 (
ušt8_t
 *è
nc
->
£nd_mbuf
.
buf
,

15158 
nc
->
£nd_mbuf
.
Ën
) !=‚c->send_mbuf.len) {

15159 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

15160 
by‹s_wr™‹n
 = 0;

15164 
by‹s_wr™‹n
 = 
	`TCPIP_TCP_FifoTxF»eG‘
((
TCP_SOCKET
è
nc
->
sock
);

15165 ià(
by‹s_wr™‹n
 != 0) {

15166 ià(
by‹s_wr™‹n
 > 
nc
->
£nd_mbuf
.
Ën
) {

15167 
by‹s_wr™‹n
 = 
nc
->
£nd_mbuf
.
Ën
;

15169 ià(
	`TCPIP_TCP_A¼ayPut
((
TCP_SOCKET
è
nc
->
sock
,

15170 (
ušt8_t
 *è
nc
->
£nd_mbuf
.
buf
,

15171 
by‹s_wr™‹n
) != bytes_written) {

15172 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

15173 
by‹s_wr™‹n
 = 0;

15178 ià(
by‹s_wr™‹n
 != 0) {

15179 
	`mbuf_»move
(&
nc
->
£nd_mbuf
, 
by‹s_wr™‹n
);

15180 
	`mg_if_£Á_cb
(
nc
, 
by‹s_wr™‹n
);

15182 
	}
}

15184 
	$mg_hªdË_»cv
(
mg_cÚÃùiÚ
 *
nc
) {

15185 
ušt16_t
 
by‹s_»ad
 = 0;

15186 
ušt8_t
 *
buf
 = 
NULL
;

15187 ià(
nc
->
æags
 & 
MG_F_UDP
) {

15188 
by‹s_»ad
 = 
	`TCPIP_UDP_G‘IsR—dy
((
UDP_SOCKET
è
nc
->
sock
);

15189 ià(
by‹s_»ad
 != 0 &&

15190 (
nc
->
»cv_mbuf_lim™
 == -1 ||

15191 
nc
->
»cv_mbuf
.
Ën
 + 
by‹s_»ad
 <‚c->
»cv_mbuf_lim™
)) {

15192 
buf
 = (
ušt8_t
 *è
	`MG_MALLOC
(
by‹s_»ad
);

15193 ià(
	`TCPIP_UDP_A¼ayG‘
((
UDP_SOCKET
è
nc
->
sock
, 
buf
, 
by‹s_»ad
) !=

15194 
by‹s_»ad
) {

15195 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

15196 
by‹s_»ad
 = 0;

15197 
	`MG_FREE
(
buf
);

15201 
by‹s_»ad
 = 
	`TCPIP_TCP_G‘IsR—dy
((
TCP_SOCKET
è
nc
->
sock
);

15202 ià(
by‹s_»ad
 != 0) {

15203 ià(
nc
->
»cv_mbuf_lim™
 != -1 &&

15204 
nc
->
»cv_mbuf_lim™
 -‚c->
»cv_mbuf
.
Ën
 > 
by‹s_»ad
) {

15205 
by‹s_»ad
 = 
nc
->
»cv_mbuf_lim™
 -‚c->
»cv_mbuf
.
Ën
;

15207 
buf
 = (
ušt8_t
 *è
	`MG_MALLOC
(
by‹s_»ad
);

15208 ià(
	`TCPIP_TCP_A¼ayG‘
((
TCP_SOCKET
è
nc
->
sock
, 
buf
, 
by‹s_»ad
) !=

15209 
by‹s_»ad
) {

15210 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

15211 
	`MG_FREE
(
buf
);

15212 
by‹s_»ad
 = 0;

15217 ià(
by‹s_»ad
 != 0) {

15218 
	`mg_if_»cv_tı_cb
(
nc
, 
buf
, 
by‹s_»ad
, 1 );

15220 
	}
}

15222 
time_t
 
	$mg_pic32_if_pŞl
(
mg_içû
 *
içû
, 
timeout_ms
) {

15223 
mg_mgr
 *
mgr
 = 
içû
->mgr;

15224 
now
 = 
	`mg_time
();

15225 
mg_cÚÃùiÚ
 *
nc
, *
tmp
;

15227 
nc
 = 
mgr
->
aùive_cÚÃùiÚs
;‚ø!ğ
NULL
;‚øğ
tmp
) {

15228 
tmp
 = 
nc
->
Ãxt
;

15230 ià(
nc
->
æags
 & 
MG_F_CONNECTING
) {

15232 ià(
nc
->
æags
 & 
MG_F_UDP
 ||

15233 
	`TCPIP_TCP_IsCÚÃùed
((
TCP_SOCKET
è
nc
->
sock
)) {

15234 
	`mg_if_cÚÃù_cb
(
nc
, 0);

15236 } ià(
nc
->
æags
 & 
MG_F_LISTENING
) {

15237 ià(
	`TCPIP_TCP_IsCÚÃùed
((
TCP_SOCKET
è
nc
->
sock
)) {

15239 
	`mg_acû±_cÚn
(
nc
);

15242 ià(
nc
->
£nd_mbuf
.
Ën
 != 0) {

15243 
	`mg_hªdË_£nd
(
nc
);

15246 ià(
nc
->
»cv_mbuf_lim™
 == -1 ||

15247 
nc
->
»cv_mbuf
.
Ën
 <‚c->
»cv_mbuf_lim™
) {

15248 
	`mg_hªdË_»cv
(
nc
);

15253 
nc
 = 
mgr
->
aùive_cÚÃùiÚs
;‚ø!ğ
NULL
;‚øğ
tmp
) {

15254 
tmp
 = 
nc
->
Ãxt
;

15255 ià((
nc
->
æags
 & 
MG_F_CLOSE_IMMEDIATELY
) ||

15256 (
nc
->
£nd_mbuf
.
Ën
 =ğ0 && (nc->
æags
 & 
MG_F_SEND_AND_CLOSE
))) {

15257 
	`mg_şo£_cÚn
(
nc
);

15261  
now
;

15262 
	}
}

15264 
	$mg_pic32_if_sock_£t
(
mg_cÚÃùiÚ
 *
nc
, 
sock_t
 
sock
) {

15265 
nc
->
sock
 = sock;

15266 
	}
}

15268 
	$mg_pic32_if_g‘_cÚn_addr
(
mg_cÚÃùiÚ
 *
nc
, 
»mÙe
,

15269 
sock‘_add»ss
 *
§
) {

15271 
	}
}

15273 
	$mg_pic32_if_cÚÃù_tı
(
mg_cÚÃùiÚ
 *
nc
,

15274 cÚ¡ 
sock‘_add»ss
 *
§
) {

15275 
nc
->
sock
 = 
	`TCPIP_TCP_Cl›ÁO³n
(

15276 
§
->
sš
.
sš_çmy
 =ğ
AF_INET
 ? 
IP_ADDRESS_TYPE_IPV4


15277 : 
IP_ADDRESS_TYPE_IPV6
,

15278 
	`Áohs
(
§
->
sš
.
sš_pÜt
), (
IP_MULTI_ADDRESS
 *) &sa->sin);

15279 
nc
->
”r
 = (nc->
sock
 =ğ
INVALID_SOCKET
) ? -1 : 0;

15280 
	}
}

15282 
	$mg_pic32_if_cÚÃù_udp
(
mg_cÚÃùiÚ
 *
nc
) {

15283 
nc
->
sock
 = 
	`TCPIP_UDP_Cl›ÁO³n
(
IP_ADDRESS_TYPE_ANY
, 0, 
NULL
);

15284 
nc
->
”r
 = (nc->
sock
 =ğ
INVALID_SOCKET
) ? -1 : 0;

15285 
	}
}

15288 
	#MG_PIC32_IFACE_VTABLE
 \

15290 
mg_pic32_if_š™
, \

15291 
mg_pic32_if_ä“
, \

15292 
mg_pic32_if_add_cÚn
, \

15293 
mg_pic32_if_»move_cÚn
, \

15294 
mg_pic32_if_pŞl
, \

15295 
mg_pic32_if_li¡’_tı
, \

15296 
mg_pic32_if_li¡’_udp
, \

15297 
mg_pic32_if_cÚÃù_tı
, \

15298 
mg_pic32_if_cÚÃù_udp
, \

15299 
mg_pic32_if_tı_£nd
, \

15300 
mg_pic32_if_udp_£nd
, \

15301 
mg_pic32_if_»cved
, \

15302 
mg_pic32_if_ü—‹_cÚn
, \

15303 
mg_pic32_if_de¡roy_cÚn
, \

15304 
mg_pic32_if_sock_£t
, \

15305 
mg_pic32_if_g‘_cÚn_addr
, \

15306 }

	)

15309 
mg_içû_vbË
 
	gmg_pic32_içû_vbË
 = 
MG_PIC32_IFACE_VTABLE
;

15310 #ià
MG_NET_IF
 =ğ
MG_NET_IF_PIC32


15311 
mg_içû_vbË
 
	gmg_deçuÉ_içû_vbË
 = 
MG_PIC32_IFACE_VTABLE
;

	@Enclave/mongoose.h

1 #ifdeà
MG_MODULE_LINES


5 
	#m®loc
 
mym®loc


	)

6 
	#ÿÎoc
 
myÿÎoc


	)

7 
	#»®loc
 
my»®loc


	)

8 
	#ä“
 
myä“


	)

11 
	#ä—d
 
ä—d__w¿µ”


	)

12 
	#fİ’
 
fİ’__w¿µ”


	)

13 
	#ä—d_´iv©e
 
ä—d_´iv©e__w¿µ”


	)

14 
	#fşo£
 
fşo£__w¿µ”


	)

35 #iâdeà
CS_MONGOOSE_SRC_COMMON_H_


36 
	#CS_MONGOOSE_SRC_COMMON_H_


	)

38 
	#MG_VERSION
 "6.7"

	)

41 #ifdeà
MG_LOCALS


42 
	~<mg_loÿls.h
>

46 #ifdeà
MG_MODULE_LINES


49 #iâdeà
CS_COMMON_PLATFORM_H_


50 
	#CS_COMMON_PLATFORM_H_


	)

56 
	#CS_P_CUSTOM
 0

	)

57 
	#CS_P_UNIX
 1

	)

58 
	#CS_P_WINDOWS
 2

	)

59 
	#CS_P_ESP32
 15

	)

60 
	#CS_P_ESP8266
 3

	)

61 
	#CS_P_CC3200
 4

	)

62 
	#CS_P_MSP432
 5

	)

63 
	#CS_P_CC3100
 6

	)

64 
	#CS_P_TM4C129
 14

	)

65 
	#CS_P_MBED
 7

	)

66 
	#CS_P_WINCE
 8

	)

67 
	#CS_P_NXP_LPC
 13

	)

68 
	#CS_P_NXP_KINETIS
 9

	)

69 
	#CS_P_NRF51
 12

	)

70 
	#CS_P_NRF52
 10

	)

71 
	#CS_P_PIC32
 11

	)

72 
	#CS_P_STM32
 16

	)

76 #iâdeà
CS_PLATFORM


78 #ià
defšed
(
TARGET_IS_MSP432P4XX
è|| defšed(
__MSP432P401R__
)

79 
	#CS_PLATFORM
 
CS_P_MSP432


	)

80 #–ià
defšed
(
cc3200
)

81 
	#CS_PLATFORM
 
CS_P_CC3200


	)

82 #–ià
defšed
(
__unix__
è|| defšed(
__APPLE__
)

83 
	#CS_PLATFORM
 
CS_P_UNIX


	)

84 #–ià
defšed
(
WINCE
)

85 
	#CS_PLATFORM
 
CS_P_WINCE


	)

86 #–ià
defšed
(
_WIN32
)

87 
	#CS_PLATFORM
 
CS_P_WINDOWS


	)

88 #–ià
defšed
(
__MBED__
)

89 
	#CS_PLATFORM
 
CS_P_MBED


	)

90 #–ià
defšed
(
__USE_LPCOPEN
)

91 
	#CS_PLATFORM
 
CS_P_NXP_LPC


	)

92 #–ià
defšed
(
FRDM_K64F
è|| defšed(
FREEDOM
)

93 
	#CS_PLATFORM
 
CS_P_NXP_KINETIS


	)

94 #–ià
defšed
(
PIC32
)

95 
	#CS_PLATFORM
 
CS_P_PIC32


	)

96 #–ià
defšed
(
ESP_PLATFORM
)

97 
	#CS_PLATFORM
 
CS_P_ESP32


	)

98 #–ià
defšed
(
ICACHE_FLASH
)

99 
	#CS_PLATFORM
 
CS_P_ESP8266


	)

100 #–ià
defšed
(
TARGET_IS_TM4C129_RA0
è|| defšed(
TARGET_IS_TM4C129_RA1
) || \

101 
	$defšed
(
TARGET_IS_TM4C129_RA2
)

102 
	#CS_PLATFORM
 
CS_P_TM4C129


	)

103 #–ià
	`defšed
(
STM32
)

104 
	#CS_PLATFORM
 
CS_P_STM32


	)

107 #iâdeà
CS_PLATFORM


113 
	#MG_NET_IF_SOCKET
 1

	)

114 
	#MG_NET_IF_SIMPLELINK
 2

	)

115 
	#MG_NET_IF_LWIP_LOW_LEVEL
 3

	)

116 
	#MG_NET_IF_PIC32
 4

	)

118 
	#MG_SSL_IF_OPENSSL
 1

	)

119 
	#MG_SSL_IF_MBEDTLS
 2

	)

120 
	#MG_SSL_IF_SIMPLELINK
 3

	)

139 #ià!
	`defšed
(
WEAK
)

140 #ià(
	`defšed
(
__GNUC__
è|| defšed(
__TI_COMPILER_VERSION__
)è&& !defšed(
_WIN32
)

141 
	#WEAK
 
	`__©Œibu‹__
((
w—k
))

	)

143 
	#WEAK


	)

147 #ifdeà
__GNUC__


148 
	#NORETURN
 
	`__©Œibu‹__
((
nÜ‘uº
))

	)

149 
	#NOINLINE
 
	`__©Œibu‹__
((
nošlše
))

	)

150 
	#WARN_UNUSED_RESULT
 
	`__©Œibu‹__
((
w¬n_unu£d_»suÉ
))

	)

151 
	#NOINSTR
 
	`__©Œibu‹__
((
no_š¡rum’t_funùiÚ
))

	)

152 
	#DO_NOT_WARN_UNUSED
 
	`__©Œibu‹__
((
unu£d
))

	)

154 
	#NORETURN


	)

155 
	#NOINLINE


	)

156 
	#WARN_UNUSED_RESULT


	)

157 
	#NOINSTR


	)

158 
	#DO_NOT_WARN_UNUSED


	)

161 #iâdeà
ARRAY_SIZE


162 
	#ARRAY_SIZE
(
¬¿y
è(×¼ayè/ ×¼ay[0]))

	)

166 #ifdeà
MG_MODULE_LINES


169 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_WINDOWS_H_


170 
	#CS_COMMON_PLATFORMS_PLATFORM_WINDOWS_H_


	)

171 #ià
CS_PLATFORM
 =ğ
CS_P_WINDOWS


185 #ifdeà
_MSC_VER


186 #´agm¨
	`w¬nšg
(
di§bË
 : 4127)

187 #´agm¨
	`w¬nšg
(
di§bË
 : 4204)

190 #iâdeà
_WINSOCK_DEPRECATED_NO_WARNINGS


191 
	#_WINSOCK_DEPRECATED_NO_WARNINGS
 1

	)

194 #iâdeà
_CRT_SECURE_NO_WARNINGS


195 
	#_CRT_SECURE_NO_WARNINGS


	)

198 
	~<as£¹.h
>

199 
	~<dœeù.h
>

200 
	~<”ºo.h
>

201 
	~<fú.h
>

202 
	~<io.h
>

203 
	~<lim™s.h
>

204 
	~<sigÇl.h
>

205 
	~<¡ddef.h
>

206 
	~<¡dio.h
>

207 
	~<¡dlib.h
>

208 
	~<sys/¡©.h
>

209 
	~<time.h
>

211 #ifdeà
_MSC_VER


212 #´agm¨
	`comm’t
(
lib
, "ws2_32.lib")

215 
	~<wšsock2.h
>

216 
	~<ws2tı.h
>

217 
	~<wšdows.h
>

218 
	~<´oûss.h
>

220 #ià
	`defšed
(
_MSC_VER
) && _MSC_VER >= 1800

221 
	#¡rdup
 
_¡rdup


	)

224 #iâdeà
EINPROGRESS


225 
	#EINPROGRESS
 
WSAEINPROGRESS


	)

227 #iâdeà
EWOULDBLOCK


228 
	#EWOULDBLOCK
 
WSAEWOULDBLOCK


	)

230 #iâdeà
__func__


231 
	#STRX
(
x
è#x

	)

232 
	#STR
(
x
è
	`STRX
(x)

	)

233 
	#__func__
 
__FILE__
 ":" 
	`STR
(
__LINE__
)

	)

235 
	#¢´štf
 
_¢´štf


	)

236 
	#f’o
 
_f’o


	)

237 
	#v¢´štf
 
_v¢´štf


	)

238 
	#¦“p
(
x
è
	`SË•
((xè*1000)

	)

239 
	#to64
(
x
è
	`_©oi64
(x)

	)

240 #ià!
	`defšed
(
__MINGW32__
è&& !defšed(
__MINGW64__
)

241 
	#pİ’
(
x
, 
y
è
	`_pİ’
((x), (y))

	)

242 
	#pşo£
(
x
è
	`_pşo£
(x)

	)

244 
	#rmdœ
 
_rmdœ


	)

245 #ià
	`defšed
(
_MSC_VER
) && _MSC_VER >= 1400

246 
	#f£eko
(
x
, 
y
, 
z
è
	`_f£eki64
((x), (y), (z))

	)

248 
	#f£eko
(
x
, 
y
, 
z
è
	`f£ek
((x), (y), (z))

	)

250 #ià
	`defšed
(
_MSC_VER
) && _MSC_VER <= 1200

251 
	tušŒ_t
;

252 
	tšŒ_t
;

254 
	tsockËn_t
;

255 #ià
_MSC_VER
 >= 1700

256 
	~<¡dšt.h
>

258 sigÃd 
	tšt8_t
;

259 
	tušt8_t
;

260 
	tšt32_t
;

261 
	tušt32_t
;

262 
	tšt16_t
;

263 
	tušt16_t
;

264 
__št64
 
	tšt64_t
;

265 
	t__št64
 
	tušt64_t
;

267 
SOCKET
 
	tsock_t
;

268 
ušt32_t
 
	tš_addr_t
;

269 #iâdeà
UINT16_MAX


270 
	#UINT16_MAX
 65535

	)

272 #iâdeà
UINT32_MAX


273 
	#UINT32_MAX
 4294967295

	)

275 #iâdeà
pid_t


276 
	#pid_t
 
HANDLE


	)

278 
	#INT64_FMT
 "I64d"

	)

279 
	#INT64_X_FMT
 "I64x"

	)

280 
	#SIZE_T_FMT
 "Iu"

	)

281 
_¡©i64
 
	tcs_¡©_t
;

282 #iâdeà
S_ISDIR


283 
	#S_ISDIR
(
x
è(((xè&
_S_IFMT
è=ğ
_S_IFDIR
)

	)

285 #iâdeà
S_ISREG


286 
	#S_ISREG
(
x
è(((xè&
_S_IFMT
è=ğ
_S_IFREG
)

	)

288 
	#DIRSEP
 '\\'

	)

289 
	#CS_DEFINE_DIRENT


	)

291 #iâdeà
va_cİy


292 #ifdeà
__va_cİy


293 
	#va_cİy
 
__va_cİy


	)

295 
	#va_cİy
(
x
, 
y
è(xèğ(y)

	)

299 #iâdeà
MG_MAX_HTTP_REQUEST_SIZE


300 
	#MG_MAX_HTTP_REQUEST_SIZE
 8192

	)

303 #iâdeà
MG_MAX_HTTP_SEND_MBUF


304 
	#MG_MAX_HTTP_SEND_MBUF
 4096

	)

307 #iâdeà
MG_MAX_HTTP_HEADERS


308 
	#MG_MAX_HTTP_HEADERS
 40

	)

311 #iâdeà
CS_ENABLE_STDIO


312 
	#CS_ENABLE_STDIO
 1

	)

315 #iâdeà
MG_ENABLE_BROADCAST


316 
	#MG_ENABLE_BROADCAST
 1

	)

319 #iâdeà
MG_ENABLE_DIRECTORY_LISTING


320 
	#MG_ENABLE_DIRECTORY_LISTING
 1

	)

323 #iâdeà
MG_ENABLE_FILESYSTEM


324 
	#MG_ENABLE_FILESYSTEM
 1

	)

327 #iâdeà
MG_ENABLE_HTTP_CGI


331 #iâdeà
MG_NET_IF


332 
	#MG_NET_IF
 
MG_NET_IF_SOCKET


	)

337 #ifdeà
MG_MODULE_LINES


340 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_UNIX_H_


341 
	#CS_COMMON_PLATFORMS_PLATFORM_UNIX_H_


	)

342 #ià
CS_PLATFORM
 =ğ
CS_P_UNIX


344 #iâdeà
_XOPEN_SOURCE


345 
	#_XOPEN_SOURCE
 600

	)

349 #iâdeà
__STDC_FORMAT_MACROS


350 
	#__STDC_FORMAT_MACROS


	)

354 #iâdeà
__STDC_LIMIT_MACROS


355 
	#__STDC_LIMIT_MACROS


	)

359 #iâdeà
_LARGEFILE_SOURCE


360 
	#_LARGEFILE_SOURCE


	)

364 #iâdeà
_FILE_OFFSET_BITS


365 
	#_FILE_OFFSET_BITS
 64

	)

368 
	~<¬·/š‘.h
>

369 
	~<as£¹.h
>

370 
	~<ùy³.h
>

371 
	~<dœ’t.h
>

372 
	~<”ºo.h
>

373 
	~<fú.h
>

374 
	~<š‰y³s.h
>

375 
	~<¡dšt.h
>

376 
	~<lim™s.h
>

377 
	~<m©h.h
>

378 
	~<Ãtdb.h
>

379 
	~<Ãtš‘/š.h
>

380 
	~<±h»ad.h
>

381 
	~<sigÇl.h
>

382 
	~<¡d¬g.h
>

383 
	~<¡dio.h
>

384 
	~<¡dlib.h
>

385 
	~<¡ršg.h
>

386 
	~<sys/·¿m.h
>

387 
	~<sys/sock‘.h
>

388 
	~<sys/£Ëù.h
>

389 
	~<sys/¡©.h
>

390 
	~<sys/time.h
>

391 
	~<sys/ty³s.h
>

392 
	~<uni¡d.h
>

394 #ifdeà
__APPLE__


395 
	~<machše/’dŸn.h
>

396 #iâdeà
BYTE_ORDER


397 
	#LITTLE_ENDIAN
 
__DARWIN_LITTLE_ENDIAN


	)

398 
	#BIG_ENDIAN
 
__DARWIN_BIG_ENDIAN


	)

399 
	#PDP_ENDIAN
 
__DARWIN_PDP_ENDIAN


	)

400 
	#BYTE_ORDER
 
__DARWIN_BYTE_ORDER


	)

410 #ià!(
	`defšed
(
__ılu¥lus
) && __cplusplus >= 201103L) && \

411 !(
	`defšed
(
__DARWIN_C_LEVEL
) && __DARWIN_C_LEVEL >= 200809L)

412 
	`¡¹Şl
(const *, **, );

415 
	tsock_t
;

416 
	#INVALID_SOCKET
 (-1)

	)

417 
	#SIZE_T_FMT
 "zu"

	)

418 
¡©
 
	tcs_¡©_t
;

419 
	#DIRSEP
 '/'

	)

420 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

421 
	#INT64_FMT
 
PRId64


	)

422 
	#INT64_X_FMT
 
PRIx64


	)

424 #iâdeà
__cdeş


425 
	#__cdeş


	)

428 #iâdeà
va_cİy


429 #ifdeà
__va_cİy


430 
	#va_cİy
 
__va_cİy


	)

432 
	#va_cİy
(
x
, 
y
è(xèğ(y)

	)

436 
	#şo£sock‘
(
x
è
	`şo£
(x)

	)

438 #iâdeà
MG_MAX_HTTP_REQUEST_SIZE


439 
	#MG_MAX_HTTP_REQUEST_SIZE
 8192

	)

442 #iâdeà
MG_MAX_HTTP_SEND_MBUF


443 
	#MG_MAX_HTTP_SEND_MBUF
 4096

	)

446 #iâdeà
MG_MAX_HTTP_HEADERS


447 
	#MG_MAX_HTTP_HEADERS
 40

	)

450 #iâdeà
CS_ENABLE_STDIO


451 
	#CS_ENABLE_STDIO
 1

	)

454 #iâdeà
MG_ENABLE_BROADCAST


455 
	#MG_ENABLE_BROADCAST
 1

	)

458 #iâdeà
MG_ENABLE_DIRECTORY_LISTING


459 
	#MG_ENABLE_DIRECTORY_LISTING
 1

	)

462 #iâdeà
MG_ENABLE_FILESYSTEM


463 
	#MG_ENABLE_FILESYSTEM
 1

	)

466 #iâdeà
MG_ENABLE_HTTP_CGI


467 
	#MG_ENABLE_HTTP_CGI
 
MG_ENABLE_FILESYSTEM


	)

470 #iâdeà
MG_NET_IF


471 
	#MG_NET_IF
 
MG_NET_IF_SOCKET


	)

476 #ifdeà
MG_MODULE_LINES


484 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_ESP32_H_


485 
	#CS_COMMON_PLATFORMS_PLATFORM_ESP32_H_


	)

486 #ià
CS_PLATFORM
 =ğ
CS_P_ESP32


488 
	~<as£¹.h
>

489 
	~<ùy³.h
>

490 
	~<dœ’t.h
>

491 
	~<fú.h
>

492 
	~<š‰y³s.h
>

493 
	~<machše/’dŸn.h
>

494 
	~<¡dšt.h
>

495 
	~<¡ršg.h
>

496 
	~<sys/¡©.h
>

497 
	~<sys/time.h
>

499 
	#SIZE_T_FMT
 "u"

	)

500 
¡©
 
	tcs_¡©_t
;

501 
	#DIRSEP
 '/'

	)

502 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

503 
	#INT64_FMT
 
PRId64


	)

504 
	#INT64_X_FMT
 
PRIx64


	)

505 
	#__cdeş


	)

506 
	#_FILE_OFFSET_BITS
 32

	)

508 
	#MG_LWIP
 1

	)

510 #iâdeà
MG_NET_IF


511 
	#MG_NET_IF
 
MG_NET_IF_SOCKET


	)

514 #iâdeà
CS_ENABLE_STDIO


515 
	#CS_ENABLE_STDIO
 1

	)

520 #ifdeà
MG_MODULE_LINES


528 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_ESP8266_H_


529 
	#CS_COMMON_PLATFORMS_PLATFORM_ESP8266_H_


	)

530 #ià
CS_PLATFORM
 =ğ
CS_P_ESP8266


532 
	~<as£¹.h
>

533 
	~<ùy³.h
>

534 
	~<fú.h
>

535 
	~<š‰y³s.h
>

536 
	~<machše/’dŸn.h
>

537 
	~<¡ršg.h
>

538 
	~<sys/¡©.h
>

539 
	~<sys/time.h
>

541 
	#SIZE_T_FMT
 "u"

	)

542 
¡©
 
	tcs_¡©_t
;

543 
	#DIRSEP
 '/'

	)

544 
	#CS_DEFINE_DIRENT


	)

546 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

547 
	#INT64_FMT
 
PRId64


	)

548 
	#INT64_X_FMT
 
PRIx64


	)

549 
	#__cdeş


	)

550 
	#_FILE_OFFSET_BITS
 32

	)

552 #iâdeà
RTOS_SDK


553 
	#f’o
(
x
è-1

	)

556 
	#MG_LWIP
 1

	)

559 
	#LWIP_TIMEVAL_PRIVATE
 0

	)

561 #iâdeà
MG_NET_IF


562 
	~<lw/İt.h
>

563 #ià
LWIP_SOCKET


564 
	#MG_NET_IF
 
MG_NET_IF_SOCKET


	)

566 
	#MG_NET_IF
 
MG_NET_IF_LWIP_LOW_LEVEL


	)

570 #iâdeà
CS_ENABLE_STDIO


571 
	#CS_ENABLE_STDIO
 1

	)

576 #ifdeà
MG_MODULE_LINES


584 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_CC3100_H_


585 
	#CS_COMMON_PLATFORMS_PLATFORM_CC3100_H_


	)

586 #ià
CS_PLATFORM
 =ğ
CS_P_CC3100


588 
	~<as£¹.h
>

589 
	~<ùy³.h
>

590 
	~<”ºo.h
>

591 
	~<š‰y³s.h
>

592 
	~<¡dšt.h
>

593 
	~<¡ršg.h
>

594 
	~<time.h
>

596 
	#MG_NET_IF
 
MG_NET_IF_SIMPLELINK


	)

597 
	#MG_SSL_IF
 
MG_SSL_IF_SIMPLELINK


	)

605 
	~<sim¶–šk.h
>

606 
	~<Ãµ.h
>

607 #undeà
timev®


609 
	tsock_t
;

610 
	#INVALID_SOCKET
 (-1)

	)

612 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

613 
	#INT64_FMT
 
PRId64


	)

614 
	#INT64_X_FMT
 
PRIx64


	)

615 
	#SIZE_T_FMT
 "u"

	)

617 
	#SOMAXCONN
 8

	)

619 cÚ¡ *
	`š‘_Áİ
(
af
, cÚ¡ *
¤c
, *
d¡
, 
sockËn_t
 
size
);

620 *
	`š‘_Áß
(
š_addr
 
š
);

621 
	`š‘_±Ú
(
af
, cÚ¡ *
¤c
, *
d¡
);

625 #ifdeà
MG_MODULE_LINES


633 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_CC3200_H_


634 
	#CS_COMMON_PLATFORMS_PLATFORM_CC3200_H_


	)

635 #ià
CS_PLATFORM
 =ğ
CS_P_CC3200


637 
	~<as£¹.h
>

638 
	~<ùy³.h
>

639 
	~<”ºo.h
>

640 
	~<š‰y³s.h
>

641 
	~<¡dšt.h
>

642 
	~<¡ršg.h
>

643 
	~<time.h
>

645 #iâdeà
__TI_COMPILER_VERSION__


646 
	~<fú.h
>

647 
	~<sys/time.h
>

650 
	#MG_NET_IF
 
MG_NET_IF_SIMPLELINK


	)

651 
	#MG_SSL_IF
 
MG_SSL_IF_SIMPLELINK


	)

654 #ià
	`defšed
(
CC3200_FS_SPIFFS
è&& !defšed(
MG_ENABLE_DIRECTORY_LISTING
)

655 
	#MG_ENABLE_DIRECTORY_LISTING
 1

	)

660 
	tsock_t
;

661 
	#INVALID_SOCKET
 (-1)

	)

662 
	#SIZE_T_FMT
 "u"

	)

663 
¡©
 
	tcs_¡©_t
;

664 
	#DIRSEP
 '/'

	)

665 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

666 
	#INT64_FMT
 
PRId64


	)

667 
	#INT64_X_FMT
 
PRIx64


	)

668 
	#__cdeş


	)

670 
	#f’o
(
x
è-1

	)

674 #ifdeà
__ılu¥lus


678 #ifdeà
__TI_COMPILER_VERSION__


679 
SlTimev®_t
;

680 
	#timev®
 
SlTimev®_t


	)

681 
	`g‘timeofday
(
timev®
 *
t
, *
tz
);

683 
	`a¥rštf
(**
¡½
, cÚ¡ *
fmt
, ...);

688 #ifdeà
__TI_COMPILER_VERSION__


690 
	~<fe.h
>

692 
	tmode_t
;

693 
size_t
 
	t_off_t
;

694 
	tssize_t
;

696 
	s¡©
 {

697 
¡_šo
;

698 
mode_t
 
¡_mode
;

699 
¡_Æšk
;

700 
time_t
 
¡_mtime
;

701 
off_t
 
¡_size
;

704 
	`_¡©
(cÚ¡ *
·thÇme
, 
¡©
 *
¡
);

705 
	#¡©
(
a
, 
b
è
	`_¡©
×, b)

	)

707 
	#__S_IFMT
 0170000

	)

709 
	#__S_IFDIR
 0040000

	)

710 
	#__S_IFCHR
 0020000

	)

711 
	#__S_IFREG
 0100000

	)

713 
	#__S_ISTYPE
(
mode
, 
mask
è(((modeè&
__S_IFMT
è=ğ(mask))

	)

715 
	#S_IFDIR
 
__S_IFDIR


	)

716 
	#S_IFCHR
 
__S_IFCHR


	)

717 
	#S_IFREG
 
__S_IFREG


	)

718 
	#S_ISDIR
(
mode
è
	`__S_ISTYPE
((mode), 
__S_IFDIR
)

	)

719 
	#S_ISREG
(
mode
è
	`__S_ISTYPE
((mode), 
__S_IFREG
)

	)

722 
	#va_cİy
(
­c
, 
­
è(×pcèğ×p))

	)

726 #ifdeà
CC3200_FS_SLFS


727 
	#MG_FS_SLFS


	)

730 #ià(
	`defšed
(
CC3200_FS_SPIFFS
è|| defšed(
CC3200_FS_SLFS
)) && \

731 !
	$defšed
(
MG_ENABLE_FILESYSTEM
)

732 
	#MG_ENABLE_FILESYSTEM
 1

	)

733 
	#CS_DEFINE_DIRENT


	)

736 #iâdeà
CS_ENABLE_STDIO


737 
	#CS_ENABLE_STDIO
 1

	)

740 #ifdeà
__ılu¥lus


741 
	}
}

746 #ifdeà
MG_MODULE_LINES


754 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_MSP432_H_


755 
	#CS_COMMON_PLATFORMS_PLATFORM_MSP432_H_


	)

756 #ià
CS_PLATFORM
 =ğ
CS_P_MSP432


758 
	~<as£¹.h
>

759 
	~<ùy³.h
>

760 
	~<”ºo.h
>

761 
	~<š‰y³s.h
>

762 
	~<¡dšt.h
>

763 
	~<¡ršg.h
>

764 
	~<time.h
>

766 #iâdeà
__TI_COMPILER_VERSION__


767 
	~<fú.h
>

768 
	~<sys/time.h
>

771 
	#MG_NET_IF
 
MG_NET_IF_SIMPLELINK


	)

772 
	#MG_SSL_IF
 
MG_SSL_IF_SIMPLELINK


	)

776 
	tsock_t
;

777 
	#INVALID_SOCKET
 (-1)

	)

778 
	#SIZE_T_FMT
 "u"

	)

779 
¡©
 
	tcs_¡©_t
;

780 
	#DIRSEP
 '/'

	)

781 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

782 
	#INT64_FMT
 
PRId64


	)

783 
	#INT64_X_FMT
 
PRIx64


	)

784 
	#__cdeş


	)

786 
	#f’o
(
x
è-1

	)

790 #ifdeà
__ılu¥lus


794 #ifdeà
__TI_COMPILER_VERSION__


795 
SlTimev®_t
;

796 
	#timev®
 
SlTimev®_t


	)

797 
g‘timeofday
(
timev®
 *
t
, *
tz
);

801 #ifdeà
__TI_COMPILER_VERSION__


803 
	~<fe.h
>

805 
	tmode_t
;

806 
size_t
 
	t_off_t
;

807 
	tssize_t
;

809 
	s¡©
 {

810 
	m¡_šo
;

811 
mode_t
 
	m¡_mode
;

812 
	m¡_Æšk
;

813 
time_t
 
	m¡_mtime
;

814 
off_t
 
	m¡_size
;

817 
_¡©
(cÚ¡ *
·thÇme
, 
¡©
 *
¡
);

818 
	#¡©
(
a
, 
b
è
	`_¡©
×, b)

	)

820 
	#__S_IFMT
 0170000

	)

822 
	#__S_IFDIR
 0040000

	)

823 
	#__S_IFCHR
 0020000

	)

824 
	#__S_IFREG
 0100000

	)

826 
	#__S_ISTYPE
(
mode
, 
mask
è(((modeè&
__S_IFMT
è=ğ(mask))

	)

828 
	#S_IFDIR
 
__S_IFDIR


	)

829 
	#S_IFCHR
 
__S_IFCHR


	)

830 
	#S_IFREG
 
__S_IFREG


	)

831 
	#S_ISDIR
(
mode
è
	`__S_ISTYPE
((mode), 
__S_IFDIR
)

	)

832 
	#S_ISREG
(
mode
è
	`__S_ISTYPE
((mode), 
__S_IFREG
)

	)

835 
	#va_cİy
(
­c
, 
­
è(×pcèğ×p))

	)

839 #iâdeà
CS_ENABLE_STDIO


840 
	#CS_ENABLE_STDIO
 1

	)

843 #ià(
defšed
(
CC3200_FS_SPIFFS
è|| defšed(
CC3200_FS_SLFS
)è&& !defšed(
MG_ENABLE_FILESYSTEM
)

844 
	#MG_ENABLE_FILESYSTEM
 1

	)

847 #ifdeà
__ılu¥lus


853 #ifdeà
MG_MODULE_LINES


861 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_TM4C129_H_


862 
	#CS_COMMON_PLATFORMS_PLATFORM_TM4C129_H_


	)

863 #ià
CS_PLATFORM
 =ğ
CS_P_TM4C129


865 
	~<as£¹.h
>

866 
	~<ùy³.h
>

867 
	~<”ºo.h
>

868 
	~<š‰y³s.h
>

869 
	~<¡dšt.h
>

870 
	~<¡ršg.h
>

871 
	~<time.h
>

873 #iâdeà
__TI_COMPILER_VERSION__


874 
	~<fú.h
>

875 
	~<sys/time.h
>

878 
	#SIZE_T_FMT
 "u"

	)

879 
¡©
 
	tcs_¡©_t
;

880 
	#DIRSEP
 '/'

	)

881 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

882 
	#INT64_FMT
 
PRId64


	)

883 
	#INT64_X_FMT
 
PRIx64


	)

884 
	#__cdeş


	)

886 #iâdeà
MG_NET_IF


887 
	~<lw/İt.h
>

888 #ià
LWIP_SOCKET


889 
	#MG_NET_IF
 
MG_NET_IF_SOCKET


	)

891 
	#MG_NET_IF
 
MG_NET_IF_LWIP_LOW_LEVEL


	)

893 
	#MG_LWIP
 1

	)

894 #–ià
MG_NET_IF
 =ğ
MG_NET_IF_SIMPLELINK


895 
	~"commÚ/¶©fÜms/sim¶–šk/cs_sim¶–šk.h
"

898 #iâdeà
CS_ENABLE_STDIO


899 
	#CS_ENABLE_STDIO
 1

	)

902 #ifdeà
__TI_COMPILER_VERSION__


904 
	#va_cİy
(
­c
, 
­
è(×pcèğ×p))

	)

907 #ifdeà
__ılu¥lus


913 #ifdeà
MG_MODULE_LINES


921 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_MBED_H_


922 
	#CS_COMMON_PLATFORMS_PLATFORM_MBED_H_


	)

923 #ià
CS_PLATFORM
 =ğ
CS_P_MBED


929 #ifdeà
__ılu¥lus


933 
	~<as£¹.h
>

934 
	~<ùy³.h
>

935 
	~<”ºo.h
>

936 
	~<š‰y³s.h
>

937 
	~<¡dšt.h
>

938 
	~<¡ršg.h
>

939 
	~<time.h
>

940 
	~<sys/¡©.h
>

941 
	~<sys/ty³s.h
>

942 
	~<fú.h
>

943 
	~<¡dio.h
>

945 
¡©
 
	tcs_¡©_t
;

946 
	#DIRSEP
 '/'

	)

948 #iâdeà
CS_ENABLE_STDIO


949 
	#CS_ENABLE_STDIO
 1

	)

958 #ià
defšed
(
__ARMCC_VERSION
è|| defšed(
__ICCARM__
)

959 
	#_TIMEVAL_DEFINED


	)

960 
	#g‘timeofday
 
_g‘timeofday


	)

963 
	tsu£cÚds_t
;

964 
	stimev®
 {

965 
time_t
 
	mtv_£c
;

966 
su£cÚds_t
 
	mtv_u£c
;

971 #ià
MG_NET_IF
 =ğ
MG_NET_IF_SIMPLELINK


973 
	#MG_SIMPLELINK_NO_OSI
 1

	)

975 
	~<sim¶–šk.h
>

977 
	tsock_t
;

978 
	#INVALID_SOCKET
 (-1)

	)

980 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

981 
	#INT64_FMT
 
PRId64


	)

982 
	#INT64_X_FMT
 
PRIx64


	)

983 
	#SIZE_T_FMT
 "u"

	)

985 
	#SOMAXCONN
 8

	)

987 cÚ¡ *
š‘_Áİ
(
af
, cÚ¡ *
¤c
, *
d¡
, 
sockËn_t
 
size
);

988 *
š‘_Áß
(
š_addr
 
š
);

989 
š‘_±Ú
(
af
, cÚ¡ *
¤c
, *
d¡
);

990 
š‘_©Ú
(cÚ¡ *
ı
, 
š_addr
 *
šp
);

991 
š_addr_t
 
š‘_addr
(cÚ¡ *
ı
);

997 #ifdeà
MG_MODULE_LINES


1004 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_NRF51_H_


1005 
	#CS_COMMON_PLATFORMS_PLATFORM_NRF51_H_


	)

1006 #ià
CS_PLATFORM
 =ğ
CS_P_NRF51


1008 
	~<as£¹.h
>

1009 
	~<ùy³.h
>

1010 
	~<š‰y³s.h
>

1011 
	~<¡dšt.h
>

1012 
	~<¡ršg.h
>

1013 
	~<time.h
>

1015 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

1017 
	#MG_NET_IF
 
MG_NET_IF_LWIP_LOW_LEVEL


	)

1018 
	#MG_LWIP
 1

	)

1019 
	#MG_ENABLE_IPV6
 1

	)

1025 #ià!
defšed
(
__ARMCC_VERSION
)

1026 
	#LWIP_TIMEVAL_PRIVATE
 0

	)

1028 
	gtimev®
;

1029 
g‘timeofday
(
timev®
 *

, *
tzp
);

1032 
	#INT64_FMT
 
PRId64


	)

1033 
	#SIZE_T_FMT
 "u"

	)

1038 
	#CS_ENABLE_STRDUP
 
	`defšed
(
__ARMCC_VERSION
)

	)

1042 #ifdeà
MG_MODULE_LINES


1049 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_NRF52_H_


1050 
	#CS_COMMON_PLATFORMS_PLATFORM_NRF52_H_


	)

1051 #ià
CS_PLATFORM
 =ğ
CS_P_NRF52


1053 
	~<as£¹.h
>

1054 
	~<ùy³.h
>

1055 
	~<”ºo.h
>

1056 
	~<š‰y³s.h
>

1057 
	~<¡dšt.h
>

1058 
	~<¡ršg.h
>

1059 
	~<time.h
>

1061 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

1063 
	#MG_NET_IF
 
MG_NET_IF_LWIP_LOW_LEVEL


	)

1064 
	#MG_LWIP
 1

	)

1065 
	#MG_ENABLE_IPV6
 1

	)

1067 #ià!
defšed
(
ENOSPC
)

1068 
	#ENOSPC
 28

	)

1075 #ià!
defšed
(
__ARMCC_VERSION
)

1076 
	#LWIP_TIMEVAL_PRIVATE
 0

	)

1079 
	#INT64_FMT
 
PRId64


	)

1080 
	#SIZE_T_FMT
 "u"

	)

1085 
	#CS_ENABLE_STRDUP
 
	`defšed
(
__ARMCC_VERSION
)

	)

1089 #ifdeà
MG_MODULE_LINES


1097 #iâdeà
CS_COMMON_PLATFORMS_SIMPLELINK_CS_SIMPLELINK_H_


1098 
	#CS_COMMON_PLATFORMS_SIMPLELINK_CS_SIMPLELINK_H_


	)

1101 #ià
defšed
(
MG_NET_IF
è&& MG_NET_IF =ğ
MG_NET_IF_SIMPLELINK
 && \

1102 !
defšed
(
__SIMPLELINK_H__
)

1104 
	~<¡dboŞ.h
>

1106 #iâdeà
__TI_COMPILER_VERSION__


1107 #undeà
__CONCAT


1108 #undeà
FD_CLR


1109 #undeà
FD_ISSET


1110 #undeà
FD_SET


1111 #undeà
FD_SETSIZE


1112 #undeà
FD_ZERO


1113 #undeà
fd_£t


1118 
	#PROVISIONING_API_H_


	)

1119 
	~<sim¶–šk/u£r.h
>

1120 #undeà
PROVISIONING_API_H_


1121 #undeà
SL_INC_STD_BSD_API_NAMING


1123 
	~<sim¶–šk/šşude/sim¶–šk.h
>

1124 
	~<sim¶–šk/šşude/Ãµ.h
>

1128 
	#AF_INET
 
SL_AF_INET


	)

1130 
	#sockËn_t
 
SlSockËn_t


	)

1131 
	#sockaddr
 
SlSockAddr_t


	)

1132 
	#sockaddr_š
 
SlSockAddrIn_t


	)

1133 
	#š_addr
 
SlInAddr_t


	)

1135 
	#SOCK_STREAM
 
SL_SOCK_STREAM


	)

1136 
	#SOCK_DGRAM
 
SL_SOCK_DGRAM


	)

1138 
	#htÚl
 
¦_HtÚl


	)

1139 
	#Áohl
 
¦_Ntohl


	)

1140 
	#htÚs
 
¦_HtÚs


	)

1141 
	#Áohs
 
¦_Ntohs


	)

1143 #iâdeà
EACCES


1144 
	#EACCES
 
SL_EACCES


	)

1146 #iâdeà
EAFNOSUPPORT


1147 
	#EAFNOSUPPORT
 
SL_EAFNOSUPPORT


	)

1149 #iâdeà
EAGAIN


1150 
	#EAGAIN
 
SL_EAGAIN


	)

1152 #iâdeà
EBADF


1153 
	#EBADF
 
SL_EBADF


	)

1155 #iâdeà
EINVAL


1156 
	#EINVAL
 
SL_EINVAL


	)

1158 #iâdeà
ENOMEM


1159 
	#ENOMEM
 
SL_ENOMEM


	)

1161 #iâdeà
EWOULDBLOCK


1162 
	#EWOULDBLOCK
 
SL_EWOULDBLOCK


	)

1165 
	#SOMAXCONN
 8

	)

1167 #ifdeà
__ılu¥lus


1171 cÚ¡ *
š‘_Áİ
(
af
, cÚ¡ *
¤c
, *
d¡
, 
sockËn_t
 
size
);

1172 *
š‘_Áß
(
š_addr
 
š
);

1173 
š‘_±Ú
(
af
, cÚ¡ *
¤c
, *
d¡
);

1175 
mg_mgr
;

1176 
mg_cÚÃùiÚ
;

1178 (*
mg_š™_cb
)(
	tmg_mgr
 *
	tmgr
);

1179 
boŞ
 
mg_¡¬t_sk
(
´iÜ™y
, 
¡ack_size
, 
mg_š™_cb
 
mg_š™
);

1181 
mg_run_š_sk
((*
cb
)(
mg_mgr
 *
mgr
, *
¬g
), *
cb_¬g
);

1183 
¦_fs_š™
();

1185 
¦_»¡¬t_cb
(
mg_mgr
 *
mgr
);

1187 
¦_£t_s¦_İts
(
mg_cÚÃùiÚ
 *
nc
);

1189 #ifdeà
__ılu¥lus


1196 #ifdeà
MG_MODULE_LINES


1199 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_WINCE_H_


1200 
	#CS_COMMON_PLATFORMS_PLATFORM_WINCE_H_


	)

1202 #ià
CS_PLATFORM
 =ğ
CS_P_WINCE


1216 #´agm¨
w¬nšg
(
di§bË
 : 4127)

1217 #´agm¨
w¬nšg
(
di§bË
 : 4204)

1219 #iâdeà
_WINSOCK_DEPRECATED_NO_WARNINGS


1220 
	#_WINSOCK_DEPRECATED_NO_WARNINGS
 1

	)

1223 #iâdeà
_CRT_SECURE_NO_WARNINGS


1224 
	#_CRT_SECURE_NO_WARNINGS


	)

1227 
	~<as£¹.h
>

1228 
	~<lim™s.h
>

1229 
	~<¡ddef.h
>

1230 
	~<¡dio.h
>

1231 
	~<¡dlib.h
>

1232 
	~<time.h
>

1234 #´agm¨
comm’t
(
lib
, "ws2.lib")

1236 
	~<wšsock2.h
>

1237 
	~<ws2tı.h
>

1238 
	~<wšdows.h
>

1240 
	#¡rdup
 
_¡rdup


	)

1242 #iâdeà
EINPROGRESS


1243 
	#EINPROGRESS
 
WSAEINPROGRESS


	)

1246 #iâdeà
EWOULDBLOCK


1247 
	#EWOULDBLOCK
 
WSAEWOULDBLOCK


	)

1250 #iâdeà
__func__


1251 
	#STRX
(
x
è#x

	)

1252 
	#STR
(
x
è
	`STRX
(x)

	)

1253 
	#__func__
 
__FILE__
 ":" 
	`STR
(
__LINE__
)

	)

1256 
	#¢´štf
 
_¢´štf


	)

1257 
	#f’o
 
_f’o


	)

1258 
	#v¢´štf
 
_v¢´štf


	)

1259 
	#¦“p
(
x
è
	`SË•
((xè*1000)

	)

1260 
	#to64
(
x
è
	`_©oi64
(x)

	)

1261 
	#rmdœ
 
_rmdœ


	)

1263 #ià
defšed
(
_MSC_VER
) && _MSC_VER >= 1400

1264 
	#f£eko
(
x
, 
y
, 
z
è
	`_f£eki64
((x), (y), (z))

	)

1266 
	#f£eko
(
x
, 
y
, 
z
è
	`f£ek
((x), (y), (z))

	)

1269 
	tsockËn_t
;

1271 #ià
_MSC_VER
 >= 1700

1272 
	~<¡dšt.h
>

1274 sigÃd 
	tšt8_t
;

1275 
	tušt8_t
;

1276 
	tšt32_t
;

1277 
	tušt32_t
;

1278 
	tšt16_t
;

1279 
	tušt16_t
;

1280 
__št64
 
	tšt64_t
;

1281 
	t__št64
 
	tušt64_t
;

1284 
SOCKET
 
	tsock_t
;

1285 
ušt32_t
 
	tš_addr_t
;

1287 #iâdeà
UINT16_MAX


1288 
	#UINT16_MAX
 65535

	)

1291 #iâdeà
UINT32_MAX


1292 
	#UINT32_MAX
 4294967295

	)

1295 #iâdeà
pid_t


1296 
	#pid_t
 
HANDLE


	)

1299 
	#INT64_FMT
 "I64d"

	)

1300 
	#INT64_X_FMT
 "I64x"

	)

1302 
	#SIZE_T_FMT
 "u"

	)

1304 
	#DIRSEP
 '\\'

	)

1305 
	#CS_DEFINE_DIRENT


	)

1307 #iâdeà
va_cİy


1308 #ifdeà
__va_cİy


1309 
	#va_cİy
 
__va_cİy


	)

1311 
	#va_cİy
(
x
, 
y
è(xèğ(y)

	)

1315 #iâdeà
MG_MAX_HTTP_REQUEST_SIZE


1316 
	#MG_MAX_HTTP_REQUEST_SIZE
 8192

	)

1319 #iâdeà
MG_MAX_HTTP_SEND_MBUF


1320 
	#MG_MAX_HTTP_SEND_MBUF
 4096

	)

1323 #iâdeà
MG_MAX_HTTP_HEADERS


1324 
	#MG_MAX_HTTP_HEADERS
 40

	)

1327 #iâdeà
CS_ENABLE_STDIO


1328 
	#CS_ENABLE_STDIO
 1

	)

1331 
	#abÜt
(è
	`DebugB»ak
();

	)

1333 #iâdeà
BUFSIZ


1334 
	#BUFSIZ
 4096

	)

1340 #iâdeà
MG_ENABLE_THREADS


1341 
	#MG_ENABLE_THREADS
 0

	)

1344 #iâdeà
MG_ENABLE_FILESYSTEM


1345 
	#MG_ENABLE_FILESYSTEM
 1

	)

1348 #iâdeà
MG_NET_IF


1349 
	#MG_NET_IF
 
MG_NET_IF_SOCKET


	)

1352 
	s_¡©i64
 {

1353 
ušt32_t
 
	g¡_mtime
;

1354 
ušt32_t
 
	g¡_size
;

1355 
ušt32_t
 
	g¡_mode
;

1356 } 
	tcs_¡©_t
;

1363 #iâdeà
ENOENT


1364 
	#ENOENT
 
ERROR_PATH_NOT_FOUND


	)

1367 #iâdeà
EACCES


1368 
	#EACCES
 
ERROR_ACCESS_DENIED


	)

1371 #iâdeà
ENOMEM


1372 
	#ENOMEM
 
ERROR_NOT_ENOUGH_MEMORY


	)

1375 #iâdeà
_UINTPTR_T_DEFINED


1376 * 
	tušŒ_t
;

1379 
	#_S_IFREG
 2

	)

1380 
	#_S_IFDIR
 4

	)

1382 #iâdeà
S_ISDIR


1383 
	#S_ISDIR
(
x
è(((xè& 
_S_IFDIR
è!ğ0)

	)

1386 #iâdeà
S_ISREG


1387 
	#S_ISREG
(
x
è(((xè& 
_S_IFREG
è!ğ0)

	)

1390 
İ’
(cÚ¡ *
f’ame
, 
oæag
, 
pmode
);

1391 
_w¡©i64
(cÚ¡ 
wch¬_t
 *
·th
, 
cs_¡©_t
 *
¡
);

1392 cÚ¡ *
¡»¼Ü
();

1396 #ifdeà
MG_MODULE_LINES


1404 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_NXP_LPC_H_


1405 
	#CS_COMMON_PLATFORMS_PLATFORM_NXP_LPC_H_


	)

1407 #ià
CS_PLATFORM
 =ğ
CS_P_NXP_LPC


1409 
	~<ùy³.h
>

1410 
	~<¡dšt.h
>

1411 
	~<¡ršg.h
>

1413 
	#SIZE_T_FMT
 "u"

	)

1414 
¡©
 
	tcs_¡©_t
;

1415 
	#INT64_FMT
 "Îd"

	)

1416 
	#INT64_X_FMT
 "Îx"

	)

1417 
	#__cdeş


	)

1419 
	#MG_LWIP
 1

	)

1421 
	#MG_NET_IF
 
MG_NET_IF_LWIP_LOW_LEVEL


	)

1429 #ifdeà
__REDLIB_INTERFACE_VERSION__


1432 
	#LWIP_TIMEVAL_PRIVATE
 1

	)

1434 
	#va_cİy
(
d
, 
s
è
	`__butš_va_cİy
(d, s)

	)

1436 
	#CS_ENABLE_TO64
 1

	)

1437 
	#to64
(
x
è
	`cs_to64
(x)

	)

1439 
	#CS_ENABLE_STRDUP
 1

	)

1443 
	~<sys/time.h
>

1444 
	#LWIP_TIMEVAL_PRIVATE
 0

	)

1445 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

1451 #ifdeà
MG_MODULE_LINES


1459 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_NXP_KINETIS_H_


1460 
	#CS_COMMON_PLATFORMS_PLATFORM_NXP_KINETIS_H_


	)

1462 #ià
CS_PLATFORM
 =ğ
CS_P_NXP_KINETIS


1464 
	~<ùy³.h
>

1465 
	~<š‰y³s.h
>

1466 
	~<¡ršg.h
>

1467 
	~<sys/time.h
>

1469 
	#SIZE_T_FMT
 "u"

	)

1470 
¡©
 
	tcs_¡©_t
;

1471 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

1472 
	#INT64_FMT
 "Îd"

	)

1473 
	#INT64_X_FMT
 "Îx"

	)

1474 
	#__cdeş


	)

1476 
	#MG_LWIP
 1

	)

1478 
	#MG_NET_IF
 
MG_NET_IF_LWIP_LOW_LEVEL


	)

1481 
	#LWIP_TIMEVAL_PRIVATE
 0

	)

1485 #ifdeà
MG_MODULE_LINES


1493 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_PIC32_H_


1494 
	#CS_COMMON_PLATFORMS_PLATFORM_PIC32_H_


	)

1496 #ià
CS_PLATFORM
 =ğ
CS_P_PIC32


1498 
	#MG_NET_IF
 
MG_NET_IF_PIC32


	)

1500 
	~<¡dšt.h
>

1501 
	~<time.h
>

1502 
	~<ùy³.h
>

1503 
	~<¡dlib.h
>

1505 
	~<sy¡em_cÚfig.h
>

1506 
	~<sy¡em_defš™iÚs.h
>

1508 
	~<sys/ty³s.h
>

1510 
TCP_SOCKET
 
	tsock_t
;

1511 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

1513 
	#SIZE_T_FMT
 "lu"

	)

1514 
	#INT64_FMT
 "Îd"

	)

1516 #iâdeà
CS_ENABLE_STDIO


1517 
	#CS_ENABLE_STDIO
 1

	)

1520 * 
š‘_Áß
(
š_addr
 
š
);

1525 #ifdeà
MG_MODULE_LINES


1533 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_STM32_H_


1534 
	#CS_COMMON_PLATFORMS_PLATFORM_STM32_H_


	)

1535 #ià
CS_PLATFORM
 =ğ
CS_P_STM32


1537 
	~<sys/ty³s.h
>

1538 
	~<sys/¡©.h
>

1539 
	~<¡dšt.h
>

1540 
	~<š‰y³s.h
>

1541 
	~<¡dio.h
>

1542 
	~<ùy³.h
>

1543 
	~<”ºo.h
>

1544 
	~<memÜy.h
>

1545 
	~<fú.h
>

1546 
	~<¡m32_sdk_h®.h
>

1548 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

1549 
	#INT64_FMT
 
PRId64


	)

1550 
	#SIZE_T_FMT
 "u"

	)

1551 
¡©
 
	tcs_¡©_t
;

1552 
	#DIRSEP
 '/'

	)

1554 #iâdeà
CS_ENABLE_STDIO


1555 
	#CS_ENABLE_STDIO
 1

	)

1558 #iâdeà
MG_ENABLE_FILESYSTEM


1559 
	#MG_ENABLE_FILESYSTEM
 1

	)

1562 
	#CS_DEFINE_DIRENT


	)

1566 #ifdeà
MG_MODULE_LINES


1574 #iâdeà
CS_COMMON_PLATFORMS_LWIP_MG_LWIP_H_


1575 
	#CS_COMMON_PLATFORMS_LWIP_MG_LWIP_H_


	)

1577 #iâdeà
MG_LWIP


1578 
	#MG_LWIP
 0

	)

1581 #ià
MG_LWIP


1592 #ià
CS_PLATFORM
 =ğ
CS_P_NRF51
 || CS_PLATFORM =ğ
CS_P_NRF52


1593 #undeà
BYTE_ORDER


1596 
	~<lw/İt.h
>

1597 
	~<lw/”r.h
>

1598 
	~<lw/_addr.h
>

1599 
	~<lw/š‘.h
>

1600 
	~<lw/Ãtdb.h
>

1601 
	~<lw/dns.h
>

1603 #iâdeà
LWIP_PROVIDE_ERRNO


1604 
	~<”ºo.h
>

1607 #ià
LWIP_SOCKET


1608 
	~<lw/sock‘s.h
>

1611 #undeà
LWIP_SOCKET


1612 
	#LWIP_SOCKET
 1

	)

1613 
	~<lw/sock‘s.h
>

1614 #undeà
LWIP_SOCKET


1615 
	#LWIP_SOCKET
 0

	)

1618 
	#INVALID_SOCKET
 (-1)

	)

1619 
	#SOMAXCONN
 10

	)

1620 
	tsock_t
;

1622 #ià
MG_NET_IF
 =ğ
MG_NET_IF_LWIP_LOW_LEVEL


1623 
	gmg_mgr
;

1624 
	gmg_cÚÃùiÚ
;

1625 
ušt32_t
 
mg_lw_g‘_pŞl_d–ay_ms
(
mg_mgr
 *
mgr
);

1626 
mg_lw_£t_k“·live_·¿ms
(
mg_cÚÃùiÚ
 *
nc
, 
idË
,

1627 
š‹rv®
, 
couÁ
);

1631 #iâdeà
X_2_


1632 
	#X_2_
(
x
è(x)

	)

1638 #ifdeà
MG_MODULE_LINES


1646 #iâdeà
CS_COMMON_CS_TIME_H_


1647 
	#CS_COMMON_CS_TIME_H_


	)

1651 #ifdeà
__ılu¥lus


1656 
cs_time
();

1658 #ifdeà
__ılu¥lus


1663 #ifdeà
MG_MODULE_LINES


1671 #iâdeà
CS_COMMON_MG_STR_H_


1672 
	#CS_COMMON_MG_STR_H_


	)

1674 
	~<¡ddef.h
>

1678 #ifdeà
__ılu¥lus


1683 
	smg_¡r
 {

1684 cÚ¡ *
p
;

1685 
size_t
 
Ën
;

1692 
mg_¡r
 
mg_mk_¡r
(cÚ¡ *
s
);

1693 
mg_¡r
 
mg_mk_¡r_n
(cÚ¡ *
s
, 
size_t
 
Ën
);

1696 
	#MG_MK_STR
(
¡r_l™”®
) \

1697 { 
¡r_l™”®
, (¡r_l™”®è- 1 }

	)

1703 
mg_vcmp
(cÚ¡ 
mg_¡r
 *
¡r2
, cÚ¡ *
¡r1
);

1709 
mg_vÿ£cmp
(cÚ¡ 
mg_¡r
 *
¡r2
, cÚ¡ *
¡r1
);

1711 
mg_¡r
 
mg_¡rdup
(cÚ¡ mg_¡¸
s
);

1712 
mg_¡rcmp
(cÚ¡ 
mg_¡r
 
¡r1
, cÚ¡ mg_¡¸
¡r2
);

1713 
mg_¡ºcmp
(cÚ¡ 
mg_¡r
 
¡r1
, cÚ¡ mg_¡¸
¡r2
, 
size_t
 
n
);

1715 #ifdeà
__ılu¥lus


1720 #ifdeà
MG_MODULE_LINES


1737 #iâdeà
CS_COMMON_MBUF_H_


1738 
	#CS_COMMON_MBUF_H_


	)

1740 
	~<¡dlib.h
>

1743 #ià
defšed
(
__ılu¥lus
)

1747 #iâdeà
MBUF_SIZE_MULTIPLIER


1748 
	#MBUF_SIZE_MULTIPLIER
 1.5

	)

1752 
	smbuf
 {

1753 *
buf
;

1754 
size_t
 
Ën
;

1755 
size_t
 
size
;

1762 
mbuf_š™
(
mbuf
 *, 
size_t
 
š™Ÿl_ÿ·c™y
);

1765 
mbuf_ä“
(
mbuf
 *);

1772 
size_t
 
mbuf_­³nd
(
mbuf
 *, cÚ¡ *
d©a
, size_ˆ
d©a_size
);

1781 
size_t
 
mbuf_š£¹
(
mbuf
 *, size_t, const *, size_t);

1784 
mbuf_»move
(
mbuf
 *, 
size_t
 
d©a_size
);

1792 
mbuf_»size
(
mbuf
 *, 
size_t
 
Ãw_size
);

1795 
mbuf_Œim
(
mbuf
 *);

1797 #ià
defšed
(
__ılu¥lus
)

1802 #ifdeà
MG_MODULE_LINES


1810 #iâdeà
CS_COMMON_SHA1_H_


1811 
	#CS_COMMON_SHA1_H_


	)

1813 #iâdeà
DISABLE_SHA1


1814 
	#DISABLE_SHA1
 0

	)

1817 #ià!
DISABLE_SHA1


1821 #ifdeà
__ılu¥lus


1826 
ušt32_t
 
¡©e
[5];

1827 
ušt32_t
 
couÁ
[2];

1828 
bufãr
[64];

1829 } 
	tcs_sha1_ùx
;

1831 
cs_sha1_š™
(
cs_sha1_ùx
 *);

1832 
cs_sha1_upd©e
(
cs_sha1_ùx
 *, cÚ¡ *
d©a
, 
ušt32_t
 
Ën
);

1833 
cs_sha1_fš®
(
dige¡
[20], 
cs_sha1_ùx
 *);

1834 
cs_hmac_sha1
(cÚ¡ *
key
, 
size_t
 
key_Ën
,

1835 cÚ¡ *
‹xt
, 
size_t
 
‹xt_Ën
,

1836 
out
[20]);

1837 #ifdeà
__ılu¥lus


1844 #ifdeà
MG_MODULE_LINES


1852 #iâdeà
CS_COMMON_MD5_H_


1853 
	#CS_COMMON_MD5_H_


	)

1857 #iâdeà
DISABLE_MD5


1858 
	#DISABLE_MD5
 0

	)

1861 #ifdeà
__ılu¥lus


1865 
	sMD5CÚ‹xt
 {

1866 
ušt32_t
 
buf
[4];

1867 
ušt32_t
 
b™s
[2];

1868 
š
[64];

1869 } 
	tMD5_CTX
;

1871 
MD5_In™
(
MD5_CTX
 *
c
);

1872 
MD5_Upd©e
(
MD5_CTX
 *
c
, cÚ¡ *
d©a
, 
size_t
 
Ën
);

1873 
MD5_Fš®
(*
md
, 
MD5_CTX
 *
c
);

1883 *
cs_md5
(
buf
[33], ...);

1885 #ifdeà
__ılu¥lus


1890 #ifdeà
MG_MODULE_LINES


1898 #iâdeà
CS_COMMON_BASE64_H_


1899 
	#CS_COMMON_BASE64_H_


	)

1901 #iâdeà
DISABLE_BASE64


1902 
	#DISABLE_BASE64
 0

	)

1905 #ià!
DISABLE_BASE64


1907 
	~<¡dio.h
>

1909 #ifdeà
__ılu¥lus


1913 (*
cs_ba£64_putc_t
)(, *);

1915 
	scs_ba£64_ùx
 {

1917 
cs_ba£64_putc_t
 
b64_putc
;

1918 
chunk
[3];

1919 
chunk_size
;

1920 *
u£r_d©a
;

1923 
cs_ba£64_š™
(
cs_ba£64_ùx
 *
ùx
, 
cs_ba£64_putc_t
 
putc
,

1924 *
u£r_d©a
);

1925 
cs_ba£64_upd©e
(
cs_ba£64_ùx
 *
ùx
, cÚ¡ *
¡r
, 
size_t
 
Ën
);

1926 
cs_ba£64_fšish
(
cs_ba£64_ùx
 *
ùx
);

1928 
cs_ba£64_’code
(cÚ¡ *
¤c
, 
¤c_Ën
, *
d¡
);

1929 
cs_åršt_ba£64
(
FILE
 *
f
, cÚ¡ *
¤c
, 
¤c_Ën
);

1930 
cs_ba£64_decode
(cÚ¡ *
s
, 
Ën
, *
d¡
, *
dec_Ën
);

1932 #ifdeà
__ılu¥lus


1939 #ifdeà
MG_MODULE_LINES


1947 #iâdeà
CS_COMMON_STR_UTIL_H_


1948 
	#CS_COMMON_STR_UTIL_H_


	)

1950 
	~<¡d¬g.h
>

1951 
	~<¡dlib.h
>

1955 #iâdeà
CS_ENABLE_STRDUP


1956 
	#CS_ENABLE_STRDUP
 0

	)

1959 #iâdeà
CS_ENABLE_TO64


1960 
	#CS_ENABLE_TO64
 0

	)

1967 
	#CS_STRINGIFY_LIT
(
x
è#x

	)

1978 
	#CS_STRINGIFY_MACRO
(
x
è
	`CS_STRINGIFY_LIT
(x)

	)

1980 #ifdeà
__ılu¥lus


1984 
size_t
 
c_¡ºËn
(cÚ¡ *
s
, size_ˆ
maxËn
);

1985 
c_¢´štf
(*
buf
, 
size_t
 
buf_size
, cÚ¡ *
fÜm©
, ...);

1986 
c_v¢´štf
(*
buf
, 
size_t
 
buf_size
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
);

1991 cÚ¡ *
c_¡º¡r
(cÚ¡ *
s
, cÚ¡ *
fšd
, 
size_t
 
¦’
);

1998 
cs_to_hex
(*
to
, cÚ¡ *
p
, 
size_t
 
Ën
);

2004 
cs_äom_hex
(*
to
, cÚ¡ *
p
, 
size_t
 
Ën
);

2006 #ià
CS_ENABLE_STRDUP


2007 *
¡rdup
(cÚ¡ *
¤c
);

2010 #ià
CS_ENABLE_TO64


2011 
	~<¡dšt.h
>

2015 
št64_t
 
cs_to64
(cÚ¡ *
s
);

2021 
mg_nÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
, 
size_t
 
Ën
);

2026 
mg_ÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
);

2043 
mg_a¥rštf
(**
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, ...);

2046 
mg_av´štf
(**
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, 
va_li¡
 
­
);

2048 #ifdeà
__ılu¥lus


2053 #ifdeà
MG_MODULE_LINES


2089 #iâdeà
_SYS_QUEUE_H_


2090 
	#_SYS_QUEUE_H_


	)

2165 #ifdeà
QUEUE_MACRO_DEBUG


2167 
	sqm_Œaû
 {

2168 
Ï¡lše
;

2169 
´evlše
;

2170 cÚ¡ *
Ï¡fe
;

2171 cÚ¡ *
´evfe
;

2174 
	#TRACEBUF
 
qm_Œaû
 
Œaû
;

	)

2175 
	#TRACEBUF_INITIALIZER
 { 
__LINE__
, 0, 
__FILE__
, 
NULL
 } ,

	)

2176 
	#TRASHIT
(
x
èdØ{(xèğ(*)-1;} 0)

	)

2177 
	#QMD_SAVELINK
(
Çme
, 
lšk
è**Çmğ(*)&Öšk)

	)

2179 
	#QMD_TRACE_HEAD
(
h—d
) do { \

2180 (
h—d
)->
Œaû
.
´evlše
 = (h—d)->Œaû.
Ï¡lše
; \

2181 (
h—d
)->
Œaû
.
´evfe
 = (h—d)->Œaû.
Ï¡fe
; \

2182 (
h—d
)->
Œaû
.
Ï¡lše
 = 
__LINE__
; \

2183 (
h—d
)->
Œaû
.
Ï¡fe
 = 
__FILE__
; \

2184 } 0)

	)

2186 
	#QMD_TRACE_ELEM
(
–em
) do { \

2187 (
–em
)->
Œaû
.
´evlše
 = (–em)->Œaû.
Ï¡lše
; \

2188 (
–em
)->
Œaû
.
´evfe
 = (–em)->Œaû.
Ï¡fe
; \

2189 (
–em
)->
Œaû
.
Ï¡lše
 = 
__LINE__
; \

2190 (
–em
)->
Œaû
.
Ï¡fe
 = 
__FILE__
; \

2191 } 0)

	)

2194 
	#QMD_TRACE_ELEM
(
–em
)

	)

2195 
	#QMD_TRACE_HEAD
(
h—d
)

	)

2196 
	#QMD_SAVELINK
(
Çme
, 
lšk
)

	)

2197 
	#TRACEBUF


	)

2198 
	#TRACEBUF_INITIALIZER


	)

2199 
	#TRASHIT
(
x
)

	)

2202 #ifdeà
__ılu¥lus


2206 
	#QUEUE_TYPEOF
(
ty³
è
	)
type

2208 
	#QUEUE_TYPEOF
(
ty³
è
	)
type

2214 
	#SLIST_HEAD
(
Çme
, 
ty³
) \

2215 
	sÇme
 { \

2216 
ty³
 *
¦h_fœ¡
; \

2217 }

	)

2219 
	#SLIST_CLASS_HEAD
(
Çme
, 
ty³
) \

2220 
	sÇme
 { \

2221 
şass
 
ty³
 *
¦h_fœ¡
; \

2222 }

	)

2224 
	#SLIST_HEAD_INITIALIZER
(
h—d
) \

2225 { 
NULL
 }

	)

2227 
	#SLIST_ENTRY
(
ty³
) \

2229 
ty³
 *
¦e_Ãxt
; \

2230 }

	)

2232 
	#SLIST_CLASS_ENTRY
(
ty³
) \

2234 
şass
 
ty³
 *
¦e_Ãxt
; \

2235 }

	)

2240 
	#SLIST_EMPTY
(
h—d
è((h—d)->
¦h_fœ¡
 =ğ
NULL
)

	)

2242 
	#SLIST_FIRST
(
h—d
è((h—d)->
¦h_fœ¡
)

	)

2244 
	#SLIST_FOREACH
(
v¬
, 
h—d
, 
f›ld
) \

2245 (
v¬
èğ
	`SLIST_FIRST
((
h—d
)); \

2246 (
v¬
); \

2247 (
v¬
èğ
	`SLIST_NEXT
((v¬), 
f›ld
))

	)

2249 
	#SLIST_FOREACH_FROM
(
v¬
, 
h—d
, 
f›ld
) \

2250 (
v¬
èğ((v¬è? (v¬è: 
	`SLIST_FIRST
((
h—d
))); \

2251 (
v¬
); \

2252 (
v¬
èğ
	`SLIST_NEXT
((v¬), 
f›ld
))

	)

2254 
	#SLIST_FOREACH_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

2255 (
v¬
èğ
	`SLIST_FIRST
((
h—d
)); \

2256 (
v¬
è&& ((
tv¬
èğ
	`SLIST_NEXT
((v¬), 
f›ld
), 1); \

2257 (
v¬
èğ(
tv¬
))

	)

2259 
	#SLIST_FOREACH_FROM_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

2260 (
v¬
èğ((v¬è? (v¬è: 
	`SLIST_FIRST
((
h—d
))); \

2261 (
v¬
è&& ((
tv¬
èğ
	`SLIST_NEXT
((v¬), 
f›ld
), 1); \

2262 (
v¬
èğ(
tv¬
))

	)

2264 
	#SLIST_FOREACH_PREVPTR
(
v¬
, 
v¬p
, 
h—d
, 
f›ld
) \

2265 (
v¬p
èğ&
	`SLIST_FIRST
((
h—d
)); \

2266 ((
v¬
èğ*(
v¬p
)è!ğ
NULL
; \

2267 (
v¬p
èğ&
	`SLIST_NEXT
((
v¬
), 
f›ld
))

	)

2269 
	#SLIST_INIT
(
h—d
) do { \

2270 
	`SLIST_FIRST
((
h—d
)èğ
NULL
; \

2271 } 0)

	)

2273 
	#SLIST_INSERT_AFTER
(
¦i¡–m
, 
–m
, 
f›ld
) do { \

2274 
	`SLIST_NEXT
((
–m
), 
f›ld
èğSLIST_NEXT((
¦i¡–m
), field); \

2275 
	`SLIST_NEXT
((
¦i¡–m
), 
f›ld
èğ(
–m
); \

2276 } 0)

	)

2278 
	#SLIST_INSERT_HEAD
(
h—d
, 
–m
, 
f›ld
) do { \

2279 
	`SLIST_NEXT
((
–m
), 
f›ld
èğ
	`SLIST_FIRST
((
h—d
)); \

2280 
	`SLIST_FIRST
((
h—d
)èğ(
–m
); \

2281 } 0)

	)

2283 
	#SLIST_NEXT
(
–m
, 
f›ld
è(Ólm)->f›ld.
¦e_Ãxt
)

	)

2285 
	#SLIST_REMOVE
(
h—d
, 
–m
, 
ty³
, 
f›ld
) do { \

2286 
	`QMD_SAVELINK
(
ŞdÃxt
, (
–m
)->
f›ld
.
¦e_Ãxt
); \

2287 ià(
	`SLIST_FIRST
((
h—d
)è=ğ(
–m
)) { \

2288 
	`SLIST_REMOVE_HEAD
((
h—d
), 
f›ld
); \

2291 
	`QUEUE_TYPEOF
(
ty³
è*
cu»lm
 = 
	`SLIST_FIRST
(
h—d
); \

2292 
	`SLIST_NEXT
(
cu»lm
, 
f›ld
è!ğ(
–m
)) \

2293 
cu»lm
 = 
	`SLIST_NEXT
(cu»lm, 
f›ld
); \

2294 
	`SLIST_REMOVE_AFTER
(
cu»lm
, 
f›ld
); \

2296 
	`TRASHIT
(*
ŞdÃxt
); \

2297 } 0)

	)

2299 
	#SLIST_REMOVE_AFTER
(
–m
, 
f›ld
) do { \

2300 
	`SLIST_NEXT
(
–m
, 
f›ld
) = \

2301 
	`SLIST_NEXT
(SLIST_NEXT(
–m
, 
f›ld
), field); \

2302 } 0)

	)

2304 
	#SLIST_REMOVE_HEAD
(
h—d
, 
f›ld
) do { \

2305 
	`SLIST_FIRST
((
h—d
)èğ
	`SLIST_NEXT
(SLIST_FIRST((h—d)), 
f›ld
); \

2306 } 0)

	)

2308 
	#SLIST_SWAP
(
h—d1
, 
h—d2
, 
ty³
) do { \

2309 
	`QUEUE_TYPEOF
(
ty³
è*
sw­_fœ¡
 = 
	`SLIST_FIRST
(
h—d1
); \

2310 
	`SLIST_FIRST
(
h—d1
èğSLIST_FIRST(
h—d2
); \

2311 
	`SLIST_FIRST
(
h—d2
èğ
sw­_fœ¡
; \

2312 } 0)

	)

2317 
	#STAILQ_HEAD
(
Çme
, 
ty³
) \

2318 
	sÇme
 { \

2319 
ty³
 *
¡qh_fœ¡
; \

2320 
ty³
 **
¡qh_Ï¡
; \

2321 }

	)

2323 
	#STAILQ_CLASS_HEAD
(
Çme
, 
ty³
) \

2324 
	sÇme
 { \

2325 
şass
 
ty³
 *
¡qh_fœ¡
; \

2326 
şass
 
ty³
 **
¡qh_Ï¡
; \

2327 }

	)

2329 
	#STAILQ_HEAD_INITIALIZER
(
h—d
) \

2330 { 
NULL
, &(
h—d
).
¡qh_fœ¡
 }

	)

2332 
	#STAILQ_ENTRY
(
ty³
) \

2334 
ty³
 *
¡qe_Ãxt
; \

2335 }

	)

2337 
	#STAILQ_CLASS_ENTRY
(
ty³
) \

2339 
şass
 
ty³
 *
¡qe_Ãxt
; \

2340 }

	)

2345 
	#STAILQ_CONCAT
(
h—d1
, 
h—d2
) do { \

2346 ià(!
	`STAILQ_EMPTY
((
h—d2
))) { \

2347 *(
h—d1
)->
¡qh_Ï¡
 = (
h—d2
)->
¡qh_fœ¡
; \

2348 (
h—d1
)->
¡qh_Ï¡
 = (
h—d2
)->stqh_last; \

2349 
	`STAILQ_INIT
((
h—d2
)); \

2351 } 0)

	)

2353 
	#STAILQ_EMPTY
(
h—d
è((h—d)->
¡qh_fœ¡
 =ğ
NULL
)

	)

2355 
	#STAILQ_FIRST
(
h—d
è((h—d)->
¡qh_fœ¡
)

	)

2357 
	#STAILQ_FOREACH
(
v¬
, 
h—d
, 
f›ld
) \

2358 (
v¬
èğ
	`STAILQ_FIRST
((
h—d
)); \

2359 (
v¬
); \

2360 (
v¬
èğ
	`STAILQ_NEXT
((v¬), 
f›ld
))

	)

2362 
	#STAILQ_FOREACH_FROM
(
v¬
, 
h—d
, 
f›ld
) \

2363 (
v¬
èğ((v¬è? (v¬è: 
	`STAILQ_FIRST
((
h—d
))); \

2364 (
v¬
); \

2365 (
v¬
èğ
	`STAILQ_NEXT
((v¬), 
f›ld
))

	)

2367 
	#STAILQ_FOREACH_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

2368 (
v¬
èğ
	`STAILQ_FIRST
((
h—d
)); \

2369 (
v¬
è&& ((
tv¬
èğ
	`STAILQ_NEXT
((v¬), 
f›ld
), 1); \

2370 (
v¬
èğ(
tv¬
))

	)

2372 
	#STAILQ_FOREACH_FROM_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

2373 (
v¬
èğ((v¬è? (v¬è: 
	`STAILQ_FIRST
((
h—d
))); \

2374 (
v¬
è&& ((
tv¬
èğ
	`STAILQ_NEXT
((v¬), 
f›ld
), 1); \

2375 (
v¬
èğ(
tv¬
))

	)

2377 
	#STAILQ_INIT
(
h—d
) do { \

2378 
	`STAILQ_FIRST
((
h—d
)èğ
NULL
; \

2379 (
h—d
)->
¡qh_Ï¡
 = &
	`STAILQ_FIRST
((head)); \

2380 } 0)

	)

2382 
	#STAILQ_INSERT_AFTER
(
h—d
, 
tq–m
, 
–m
, 
f›ld
) do { \

2383 ià((
	`STAILQ_NEXT
((
–m
), 
f›ld
èğSTAILQ_NEXT((
tq–m
), f›ld)è=ğ
NULL
)\

2384 (
h—d
)->
¡qh_Ï¡
 = &
	`STAILQ_NEXT
((
–m
), 
f›ld
); \

2385 
	`STAILQ_NEXT
((
tq–m
), 
f›ld
èğ(
–m
); \

2386 } 0)

	)

2388 
	#STAILQ_INSERT_HEAD
(
h—d
, 
–m
, 
f›ld
) do { \

2389 ià((
	`STAILQ_NEXT
((
–m
), 
f›ld
èğ
	`STAILQ_FIRST
((
h—d
))è=ğ
NULL
) \

2390 (
h—d
)->
¡qh_Ï¡
 = &
	`STAILQ_NEXT
((
–m
), 
f›ld
); \

2391 
	`STAILQ_FIRST
((
h—d
)èğ(
–m
); \

2392 } 0)

	)

2394 
	#STAILQ_INSERT_TAIL
(
h—d
, 
–m
, 
f›ld
) do { \

2395 
	`STAILQ_NEXT
((
–m
), 
f›ld
èğ
NULL
; \

2396 *(
h—d
)->
¡qh_Ï¡
 = (
–m
); \

2397 (
h—d
)->
¡qh_Ï¡
 = &
	`STAILQ_NEXT
((
–m
), 
f›ld
); \

2398 } 0)

	)

2400 
	#STAILQ_LAST
(
h—d
, 
ty³
, 
f›ld
) \

2401 (
	`STAILQ_EMPTY
((
h—d
)è? 
NULL
 : \

2402 
	`__cÚš”of
((
h—d
)->
¡qh_Ï¡
, \

2403 
	`QUEUE_TYPEOF
(
ty³
), 
f›ld
.
¡qe_Ãxt
))

	)

2405 
	#STAILQ_NEXT
(
–m
, 
f›ld
è(Ólm)->f›ld.
¡qe_Ãxt
)

	)

2407 
	#STAILQ_REMOVE
(
h—d
, 
–m
, 
ty³
, 
f›ld
) do { \

2408 
	`QMD_SAVELINK
(
ŞdÃxt
, (
–m
)->
f›ld
.
¡qe_Ãxt
); \

2409 ià(
	`STAILQ_FIRST
((
h—d
)è=ğ(
–m
)) { \

2410 
	`STAILQ_REMOVE_HEAD
((
h—d
), 
f›ld
); \

2413 
	`QUEUE_TYPEOF
(
ty³
è*
cu»lm
 = 
	`STAILQ_FIRST
(
h—d
); \

2414 
	`STAILQ_NEXT
(
cu»lm
, 
f›ld
è!ğ(
–m
)) \

2415 
cu»lm
 = 
	`STAILQ_NEXT
(cu»lm, 
f›ld
); \

2416 
	`STAILQ_REMOVE_AFTER
(
h—d
, 
cu»lm
, 
f›ld
); \

2418 
	`TRASHIT
(*
ŞdÃxt
); \

2419 } 0)

	)

2421 
	#STAILQ_REMOVE_AFTER
(
h—d
, 
–m
, 
f›ld
) do { \

2422 ià((
	`STAILQ_NEXT
(
–m
, 
f›ld
) = \

2423 
	`STAILQ_NEXT
(STAILQ_NEXT(
–m
, 
f›ld
), f›ld)è=ğ
NULL
) \

2424 (
h—d
)->
¡qh_Ï¡
 = &
	`STAILQ_NEXT
((
–m
), 
f›ld
); \

2425 } 0)

	)

2427 
	#STAILQ_REMOVE_HEAD
(
h—d
, 
f›ld
) do { \

2428 ià((
	`STAILQ_FIRST
((
h—d
)) = \

2429 
	`STAILQ_NEXT
(
	`STAILQ_FIRST
((
h—d
)), 
f›ld
)è=ğ
NULL
) \

2430 (
h—d
)->
¡qh_Ï¡
 = &
	`STAILQ_FIRST
((head)); \

2431 } 0)

	)

2433 
	#STAILQ_SWAP
(
h—d1
, 
h—d2
, 
ty³
) do { \

2434 
	`QUEUE_TYPEOF
(
ty³
è*
sw­_fœ¡
 = 
	`STAILQ_FIRST
(
h—d1
); \

2435 
	`QUEUE_TYPEOF
(
ty³
è**
sw­_Ï¡
 = (
h—d1
)->
¡qh_Ï¡
; \

2436 
	`STAILQ_FIRST
(
h—d1
èğSTAILQ_FIRST(
h—d2
); \

2437 (
h—d1
)->
¡qh_Ï¡
 = (
h—d2
)->stqh_last; \

2438 
	`STAILQ_FIRST
(
h—d2
èğ
sw­_fœ¡
; \

2439 (
h—d2
)->
¡qh_Ï¡
 = 
sw­_Ï¡
; \

2440 ià(
	`STAILQ_EMPTY
(
h—d1
)) \

2441 (
h—d1
)->
¡qh_Ï¡
 = &
	`STAILQ_FIRST
(head1); \

2442 ià(
	`STAILQ_EMPTY
(
h—d2
)) \

2443 (
h—d2
)->
¡qh_Ï¡
 = &
	`STAILQ_FIRST
(head2); \

2444 } 0)

	)

2450 
	#LIST_HEAD
(
Çme
, 
ty³
) \

2451 
	sÇme
 { \

2452 
ty³
 *
lh_fœ¡
; \

2453 }

	)

2455 
	#LIST_CLASS_HEAD
(
Çme
, 
ty³
) \

2456 
	sÇme
 { \

2457 
şass
 
ty³
 *
lh_fœ¡
; \

2458 }

	)

2460 
	#LIST_HEAD_INITIALIZER
(
h—d
) \

2461 { 
NULL
 }

	)

2463 
	#LIST_ENTRY
(
ty³
) \

2465 
ty³
 *
Ë_Ãxt
; \

2466 
ty³
 **
Ë_´ev
; \

2467 }

	)

2469 
	#LIST_CLASS_ENTRY
(
ty³
) \

2471 
şass
 
ty³
 *
Ë_Ãxt
; \

2472 
şass
 
ty³
 **
Ë_´ev
; \

2473 }

	)

2479 #ià(
defšed
(
_KERNEL
è&& defšed(
INVARIANTS
))

2480 
	#QMD_LIST_CHECK_HEAD
(
h—d
, 
f›ld
) do { \

2481 ià(
	`LIST_FIRST
((
h—d
)è!ğ
NULL
 && \

2482 
	`LIST_FIRST
((
h—d
))->
f›ld
.
Ë_´ev
 != \

2483 &
	`LIST_FIRST
((
h—d
))) \

2484 
	`·nic
("Bad†i¡ h—d %°fœ¡->´ev !ğh—d", (
h—d
)); \

2485 } 0)

	)

2487 
	#QMD_LIST_CHECK_NEXT
(
–m
, 
f›ld
) do { \

2488 ià(
	`LIST_NEXT
((
–m
), 
f›ld
è!ğ
NULL
 && \

2489 
	`LIST_NEXT
((
–m
), 
f›ld
)->f›ld.
Ë_´ev
 != \

2490 &((
–m
)->
f›ld
.
Ë_Ãxt
)) \

2491 
	`·nic
("Bad†škƒlm %°Ãxt->´ev !ğ–m", (
–m
)); \

2492 } 0)

	)

2494 
	#QMD_LIST_CHECK_PREV
(
–m
, 
f›ld
) do { \

2495 ià(*(
–m
)->
f›ld
.
Ë_´ev
 != (elm)) \

2496 
	`·nic
("Bad†škƒlm %°´ev->Ãxˆ!ğ–m", (
–m
)); \

2497 } 0)

	)

2499 
	#QMD_LIST_CHECK_HEAD
(
h—d
, 
f›ld
)

	)

2500 
	#QMD_LIST_CHECK_NEXT
(
–m
, 
f›ld
)

	)

2501 
	#QMD_LIST_CHECK_PREV
(
–m
, 
f›ld
)

	)

2504 
	#LIST_EMPTY
(
h—d
è((h—d)->
lh_fœ¡
 =ğ
NULL
)

	)

2506 
	#LIST_FIRST
(
h—d
è((h—d)->
lh_fœ¡
)

	)

2508 
	#LIST_FOREACH
(
v¬
, 
h—d
, 
f›ld
) \

2509 (
v¬
èğ
	`LIST_FIRST
((
h—d
)); \

2510 (
v¬
); \

2511 (
v¬
èğ
	`LIST_NEXT
((v¬), 
f›ld
))

	)

2513 
	#LIST_FOREACH_FROM
(
v¬
, 
h—d
, 
f›ld
) \

2514 (
v¬
èğ((v¬è? (v¬è: 
	`LIST_FIRST
((
h—d
))); \

2515 (
v¬
); \

2516 (
v¬
èğ
	`LIST_NEXT
((v¬), 
f›ld
))

	)

2518 
	#LIST_FOREACH_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

2519 (
v¬
èğ
	`LIST_FIRST
((
h—d
)); \

2520 (
v¬
è&& ((
tv¬
èğ
	`LIST_NEXT
((v¬), 
f›ld
), 1); \

2521 (
v¬
èğ(
tv¬
))

	)

2523 
	#LIST_FOREACH_FROM_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

2524 (
v¬
èğ((v¬è? (v¬è: 
	`LIST_FIRST
((
h—d
))); \

2525 (
v¬
è&& ((
tv¬
èğ
	`LIST_NEXT
((v¬), 
f›ld
), 1); \

2526 (
v¬
èğ(
tv¬
))

	)

2528 
	#LIST_INIT
(
h—d
) do { \

2529 
	`LIST_FIRST
((
h—d
)èğ
NULL
; \

2530 } 0)

	)

2532 
	#LIST_INSERT_AFTER
(
li¡–m
, 
–m
, 
f›ld
) do { \

2533 
	`QMD_LIST_CHECK_NEXT
(
li¡–m
, 
f›ld
); \

2534 ià((
	`LIST_NEXT
((
–m
), 
f›ld
èğLIST_NEXT((
li¡–m
), f›ld)è!ğ
NULL
)\

2535 
	`LIST_NEXT
((
li¡–m
), 
f›ld
)->f›ld.
Ë_´ev
 = \

2536 &
	`LIST_NEXT
((
–m
), 
f›ld
); \

2537 
	`LIST_NEXT
((
li¡–m
), 
f›ld
èğ(
–m
); \

2538 (
–m
)->
f›ld
.
Ë_´ev
 = &
	`LIST_NEXT
((
li¡–m
), field); \

2539 } 0)

	)

2541 
	#LIST_INSERT_BEFORE
(
li¡–m
, 
–m
, 
f›ld
) do { \

2542 
	`QMD_LIST_CHECK_PREV
(
li¡–m
, 
f›ld
); \

2543 (
–m
)->
f›ld
.
Ë_´ev
 = (
li¡–m
)->field.le_prev; \

2544 
	`LIST_NEXT
((
–m
), 
f›ld
èğ(
li¡–m
); \

2545 *(
li¡–m
)->
f›ld
.
Ë_´ev
 = (
–m
); \

2546 (
li¡–m
)->
f›ld
.
Ë_´ev
 = &
	`LIST_NEXT
((
–m
), field); \

2547 } 0)

	)

2549 
	#LIST_INSERT_HEAD
(
h—d
, 
–m
, 
f›ld
) do { \

2550 
	`QMD_LIST_CHECK_HEAD
((
h—d
), 
f›ld
); \

2551 ià((
	`LIST_NEXT
((
–m
), 
f›ld
èğ
	`LIST_FIRST
((
h—d
))è!ğ
NULL
) \

2552 
	`LIST_FIRST
((
h—d
))->
f›ld
.
Ë_´ev
 = &
	`LIST_NEXT
((
–m
), field);\

2553 
	`LIST_FIRST
((
h—d
)èğ(
–m
); \

2554 (
–m
)->
f›ld
.
Ë_´ev
 = &
	`LIST_FIRST
((
h—d
)); \

2555 } 0)

	)

2557 
	#LIST_NEXT
(
–m
, 
f›ld
è(Ólm)->f›ld.
Ë_Ãxt
)

	)

2559 
	#LIST_PREV
(
–m
, 
h—d
, 
ty³
, 
f›ld
) \

2560 ((
–m
)->
f›ld
.
Ë_´ev
 =ğ&
	`LIST_FIRST
((
h—d
)è? 
NULL
 : \

2561 
	`__cÚš”of
((
–m
)->
f›ld
.
Ë_´ev
, \

2562 
	`QUEUE_TYPEOF
(
ty³
), 
f›ld
.
Ë_Ãxt
))

	)

2564 
	#LIST_REMOVE
(
–m
, 
f›ld
) do { \

2565 
	`QMD_SAVELINK
(
ŞdÃxt
, (
–m
)->
f›ld
.
Ë_Ãxt
); \

2566 
	`QMD_SAVELINK
(
Şd´ev
, (
–m
)->
f›ld
.
Ë_´ev
); \

2567 
	`QMD_LIST_CHECK_NEXT
(
–m
, 
f›ld
); \

2568 
	`QMD_LIST_CHECK_PREV
(
–m
, 
f›ld
); \

2569 ià(
	`LIST_NEXT
((
–m
), 
f›ld
è!ğ
NULL
) \

2570 
	`LIST_NEXT
((
–m
), 
f›ld
)->f›ld.
Ë_´ev
 = \

2571 (
–m
)->
f›ld
.
Ë_´ev
; \

2572 *(
–m
)->
f›ld
.
Ë_´ev
 = 
	`LIST_NEXT
((elm), field); \

2573 
	`TRASHIT
(*
ŞdÃxt
); \

2574 
	`TRASHIT
(*
Şd´ev
); \

2575 } 0)

	)

2577 
	#LIST_SWAP
(
h—d1
, 
h—d2
, 
ty³
, 
f›ld
) do { \

2578 
	`QUEUE_TYPEOF
(
ty³
è*
sw­_tmp
 = 
	`LIST_FIRST
(
h—d1
); \

2579 
	`LIST_FIRST
((
h—d1
)èğLIST_FIRST((
h—d2
)); \

2580 
	`LIST_FIRST
((
h—d2
)èğ
sw­_tmp
; \

2581 ià((
sw­_tmp
 = 
	`LIST_FIRST
((
h—d1
))è!ğ
NULL
) \

2582 
sw­_tmp
->
f›ld
.
Ë_´ev
 = &
	`LIST_FIRST
((
h—d1
)); \

2583 ià((
sw­_tmp
 = 
	`LIST_FIRST
((
h—d2
))è!ğ
NULL
) \

2584 
sw­_tmp
->
f›ld
.
Ë_´ev
 = &
	`LIST_FIRST
((
h—d2
)); \

2585 } 0)

	)

2590 
	#TAILQ_HEAD
(
Çme
, 
ty³
) \

2591 
	sÇme
 { \

2592 
ty³
 *
tqh_fœ¡
; \

2593 
ty³
 **
tqh_Ï¡
; \

2594 
TRACEBUF
 \

2595 }

	)

2597 
	#TAILQ_CLASS_HEAD
(
Çme
, 
ty³
) \

2598 
	sÇme
 { \

2599 
şass
 
ty³
 *
tqh_fœ¡
; \

2600 
şass
 
ty³
 **
tqh_Ï¡
; \

2601 
TRACEBUF
 \

2602 }

	)

2604 
	#TAILQ_HEAD_INITIALIZER
(
h—d
) \

2605 { 
NULL
, &(
h—d
).
tqh_fœ¡
, 
TRACEBUF_INITIALIZER
 }

	)

2607 
	#TAILQ_ENTRY
(
ty³
) \

2609 
ty³
 *
tqe_Ãxt
; \

2610 
ty³
 **
tqe_´ev
; \

2611 
TRACEBUF
 \

2612 }

	)

2614 
	#TAILQ_CLASS_ENTRY
(
ty³
) \

2616 
şass
 
ty³
 *
tqe_Ãxt
; \

2617 
şass
 
ty³
 **
tqe_´ev
; \

2618 
TRACEBUF
 \

2619 }

	)

2624 #ià(
defšed
(
_KERNEL
è&& defšed(
INVARIANTS
))

2625 
	#QMD_TAILQ_CHECK_HEAD
(
h—d
, 
f›ld
) do { \

2626 ià(!
	`TAILQ_EMPTY
(
h—d
) && \

2627 
	`TAILQ_FIRST
((
h—d
))->
f›ld
.
tqe_´ev
 != \

2628 &
	`TAILQ_FIRST
((
h—d
))) \

2629 
	`·nic
("Badaq h—d %°fœ¡->´ev !ğh—d", (
h—d
)); \

2630 } 0)

	)

2632 
	#QMD_TAILQ_CHECK_TAIL
(
h—d
, 
f›ld
) do { \

2633 ià(*(
h—d
)->
tqh_Ï¡
 !ğ
NULL
) \

2634 
	`·nic
("Badaq NEXT(%p->tqh_Ï¡è!ğNULL", (
h—d
)); \

2635 } 0)

	)

2637 
	#QMD_TAILQ_CHECK_NEXT
(
–m
, 
f›ld
) do { \

2638 ià(
	`TAILQ_NEXT
((
–m
), 
f›ld
è!ğ
NULL
 && \

2639 
	`TAILQ_NEXT
((
–m
), 
f›ld
)->f›ld.
tqe_´ev
 != \

2640 &((
–m
)->
f›ld
.
tqe_Ãxt
)) \

2641 
	`·nic
("Bad†škƒlm %°Ãxt->´ev !ğ–m", (
–m
)); \

2642 } 0)

	)

2644 
	#QMD_TAILQ_CHECK_PREV
(
–m
, 
f›ld
) do { \

2645 ià(*(
–m
)->
f›ld
.
tqe_´ev
 != (elm)) \

2646 
	`·nic
("Bad†škƒlm %°´ev->Ãxˆ!ğ–m", (
–m
)); \

2647 } 0)

	)

2649 
	#QMD_TAILQ_CHECK_HEAD
(
h—d
, 
f›ld
)

	)

2650 
	#QMD_TAILQ_CHECK_TAIL
(
h—d
, 
h—dÇme
)

	)

2651 
	#QMD_TAILQ_CHECK_NEXT
(
–m
, 
f›ld
)

	)

2652 
	#QMD_TAILQ_CHECK_PREV
(
–m
, 
f›ld
)

	)

2655 
	#TAILQ_CONCAT
(
h—d1
, 
h—d2
, 
f›ld
) do { \

2656 ià(!
	`TAILQ_EMPTY
(
h—d2
)) { \

2657 *(
h—d1
)->
tqh_Ï¡
 = (
h—d2
)->
tqh_fœ¡
; \

2658 (
h—d2
)->
tqh_fœ¡
->
f›ld
.
tqe_´ev
 = (
h—d1
)->
tqh_Ï¡
; \

2659 (
h—d1
)->
tqh_Ï¡
 = (
h—d2
)->tqh_last; \

2660 
	`TAILQ_INIT
((
h—d2
)); \

2661 
	`QMD_TRACE_HEAD
(
h—d1
); \

2662 
	`QMD_TRACE_HEAD
(
h—d2
); \

2664 } 0)

	)

2666 
	#TAILQ_EMPTY
(
h—d
è((h—d)->
tqh_fœ¡
 =ğ
NULL
)

	)

2668 
	#TAILQ_FIRST
(
h—d
è((h—d)->
tqh_fœ¡
)

	)

2670 
	#TAILQ_FOREACH
(
v¬
, 
h—d
, 
f›ld
) \

2671 (
v¬
èğ
	`TAILQ_FIRST
((
h—d
)); \

2672 (
v¬
); \

2673 (
v¬
èğ
	`TAILQ_NEXT
((v¬), 
f›ld
))

	)

2675 
	#TAILQ_FOREACH_FROM
(
v¬
, 
h—d
, 
f›ld
) \

2676 (
v¬
èğ((v¬è? (v¬è: 
	`TAILQ_FIRST
((
h—d
))); \

2677 (
v¬
); \

2678 (
v¬
èğ
	`TAILQ_NEXT
((v¬), 
f›ld
))

	)

2680 
	#TAILQ_FOREACH_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

2681 (
v¬
èğ
	`TAILQ_FIRST
((
h—d
)); \

2682 (
v¬
è&& ((
tv¬
èğ
	`TAILQ_NEXT
((v¬), 
f›ld
), 1); \

2683 (
v¬
èğ(
tv¬
))

	)

2685 
	#TAILQ_FOREACH_FROM_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

2686 (
v¬
èğ((v¬è? (v¬è: 
	`TAILQ_FIRST
((
h—d
))); \

2687 (
v¬
è&& ((
tv¬
èğ
	`TAILQ_NEXT
((v¬), 
f›ld
), 1); \

2688 (
v¬
èğ(
tv¬
))

	)

2690 
	#TAILQ_FOREACH_REVERSE
(
v¬
, 
h—d
, 
h—dÇme
, 
f›ld
) \

2691 (
v¬
èğ
	`TAILQ_LAST
((
h—d
), 
h—dÇme
); \

2692 (
v¬
); \

2693 (
v¬
èğ
	`TAILQ_PREV
((v¬), 
h—dÇme
, 
f›ld
))

	)

2695 
	#TAILQ_FOREACH_REVERSE_FROM
(
v¬
, 
h—d
, 
h—dÇme
, 
f›ld
) \

2696 (
v¬
èğ((v¬è? (v¬è: 
	`TAILQ_LAST
((
h—d
), 
h—dÇme
)); \

2697 (
v¬
); \

2698 (
v¬
èğ
	`TAILQ_PREV
((v¬), 
h—dÇme
, 
f›ld
))

	)

2700 
	#TAILQ_FOREACH_REVERSE_SAFE
(
v¬
, 
h—d
, 
h—dÇme
, 
f›ld
, 
tv¬
) \

2701 (
v¬
èğ
	`TAILQ_LAST
((
h—d
), 
h—dÇme
); \

2702 (
v¬
è&& ((
tv¬
èğ
	`TAILQ_PREV
((v¬), 
h—dÇme
, 
f›ld
), 1); \

2703 (
v¬
èğ(
tv¬
))

	)

2705 
	#TAILQ_FOREACH_REVERSE_FROM_SAFE
(
v¬
, 
h—d
, 
h—dÇme
, 
f›ld
, 
tv¬
) \

2706 (
v¬
èğ((v¬è? (v¬è: 
	`TAILQ_LAST
((
h—d
), 
h—dÇme
)); \

2707 (
v¬
è&& ((
tv¬
èğ
	`TAILQ_PREV
((v¬), 
h—dÇme
, 
f›ld
), 1); \

2708 (
v¬
èğ(
tv¬
))

	)

2710 
	#TAILQ_INIT
(
h—d
) do { \

2711 
	`TAILQ_FIRST
((
h—d
)èğ
NULL
; \

2712 (
h—d
)->
tqh_Ï¡
 = &
	`TAILQ_FIRST
((head)); \

2713 
	`QMD_TRACE_HEAD
(
h—d
); \

2714 } 0)

	)

2716 
	#TAILQ_INSERT_AFTER
(
h—d
, 
li¡–m
, 
–m
, 
f›ld
) do { \

2717 
	`QMD_TAILQ_CHECK_NEXT
(
li¡–m
, 
f›ld
); \

2718 ià((
	`TAILQ_NEXT
((
–m
), 
f›ld
èğTAILQ_NEXT((
li¡–m
), f›ld)è!ğ
NULL
)\

2719 
	`TAILQ_NEXT
((
–m
), 
f›ld
)->f›ld.
tqe_´ev
 = \

2720 &
	`TAILQ_NEXT
((
–m
), 
f›ld
); \

2722 (
h—d
)->
tqh_Ï¡
 = &
	`TAILQ_NEXT
((
–m
), 
f›ld
); \

2723 
	`QMD_TRACE_HEAD
(
h—d
); \

2725 
	`TAILQ_NEXT
((
li¡–m
), 
f›ld
èğ(
–m
); \

2726 (
–m
)->
f›ld
.
tqe_´ev
 = &
	`TAILQ_NEXT
((
li¡–m
), field); \

2727 
	`QMD_TRACE_ELEM
(&(
–m
)->
f›ld
); \

2728 
	`QMD_TRACE_ELEM
(&(
li¡–m
)->
f›ld
); \

2729 } 0)

	)

2731 
	#TAILQ_INSERT_BEFORE
(
li¡–m
, 
–m
, 
f›ld
) do { \

2732 
	`QMD_TAILQ_CHECK_PREV
(
li¡–m
, 
f›ld
); \

2733 (
–m
)->
f›ld
.
tqe_´ev
 = (
li¡–m
)->field.tqe_prev; \

2734 
	`TAILQ_NEXT
((
–m
), 
f›ld
èğ(
li¡–m
); \

2735 *(
li¡–m
)->
f›ld
.
tqe_´ev
 = (
–m
); \

2736 (
li¡–m
)->
f›ld
.
tqe_´ev
 = &
	`TAILQ_NEXT
((
–m
), field); \

2737 
	`QMD_TRACE_ELEM
(&(
–m
)->
f›ld
); \

2738 
	`QMD_TRACE_ELEM
(&(
li¡–m
)->
f›ld
); \

2739 } 0)

	)

2741 
	#TAILQ_INSERT_HEAD
(
h—d
, 
–m
, 
f›ld
) do { \

2742 
	`QMD_TAILQ_CHECK_HEAD
(
h—d
, 
f›ld
); \

2743 ià((
	`TAILQ_NEXT
((
–m
), 
f›ld
èğ
	`TAILQ_FIRST
((
h—d
))è!ğ
NULL
) \

2744 
	`TAILQ_FIRST
((
h—d
))->
f›ld
.
tqe_´ev
 = \

2745 &
	`TAILQ_NEXT
((
–m
), 
f›ld
); \

2747 (
h—d
)->
tqh_Ï¡
 = &
	`TAILQ_NEXT
((
–m
), 
f›ld
); \

2748 
	`TAILQ_FIRST
((
h—d
)èğ(
–m
); \

2749 (
–m
)->
f›ld
.
tqe_´ev
 = &
	`TAILQ_FIRST
((
h—d
)); \

2750 
	`QMD_TRACE_HEAD
(
h—d
); \

2751 
	`QMD_TRACE_ELEM
(&(
–m
)->
f›ld
); \

2752 } 0)

	)

2754 
	#TAILQ_INSERT_TAIL
(
h—d
, 
–m
, 
f›ld
) do { \

2755 
	`QMD_TAILQ_CHECK_TAIL
(
h—d
, 
f›ld
); \

2756 
	`TAILQ_NEXT
((
–m
), 
f›ld
èğ
NULL
; \

2757 (
–m
)->
f›ld
.
tqe_´ev
 = (
h—d
)->
tqh_Ï¡
; \

2758 *(
h—d
)->
tqh_Ï¡
 = (
–m
); \

2759 (
h—d
)->
tqh_Ï¡
 = &
	`TAILQ_NEXT
((
–m
), 
f›ld
); \

2760 
	`QMD_TRACE_HEAD
(
h—d
); \

2761 
	`QMD_TRACE_ELEM
(&(
–m
)->
f›ld
); \

2762 } 0)

	)

2764 
	#TAILQ_LAST
(
h—d
, 
h—dÇme
) \

2765 (*(((
h—dÇme
 *)((
h—d
)->
tqh_Ï¡
))->tqh_Ï¡))

	)

2767 
	#TAILQ_NEXT
(
–m
, 
f›ld
è(Ólm)->f›ld.
tqe_Ãxt
)

	)

2769 
	#TAILQ_PREV
(
–m
, 
h—dÇme
, 
f›ld
) \

2770 (*(((
h—dÇme
 *)((
–m
)->
f›ld
.
tqe_´ev
))->
tqh_Ï¡
))

	)

2772 
	#TAILQ_REMOVE
(
h—d
, 
–m
, 
f›ld
) do { \

2773 
	`QMD_SAVELINK
(
ŞdÃxt
, (
–m
)->
f›ld
.
tqe_Ãxt
); \

2774 
	`QMD_SAVELINK
(
Şd´ev
, (
–m
)->
f›ld
.
tqe_´ev
); \

2775 
	`QMD_TAILQ_CHECK_NEXT
(
–m
, 
f›ld
); \

2776 
	`QMD_TAILQ_CHECK_PREV
(
–m
, 
f›ld
); \

2777 ià((
	`TAILQ_NEXT
((
–m
), 
f›ld
)è!ğ
NULL
) \

2778 
	`TAILQ_NEXT
((
–m
), 
f›ld
)->f›ld.
tqe_´ev
 = \

2779 (
–m
)->
f›ld
.
tqe_´ev
; \

2781 (
h—d
)->
tqh_Ï¡
 = (
–m
)->
f›ld
.
tqe_´ev
; \

2782 
	`QMD_TRACE_HEAD
(
h—d
); \

2784 *(
–m
)->
f›ld
.
tqe_´ev
 = 
	`TAILQ_NEXT
((elm), field); \

2785 
	`TRASHIT
(*
ŞdÃxt
); \

2786 
	`TRASHIT
(*
Şd´ev
); \

2787 
	`QMD_TRACE_ELEM
(&(
–m
)->
f›ld
); \

2788 } 0)

	)

2790 
	#TAILQ_SWAP
(
h—d1
, 
h—d2
, 
ty³
, 
f›ld
) do { \

2791 
	`QUEUE_TYPEOF
(
ty³
è*
sw­_fœ¡
 = (
h—d1
)->
tqh_fœ¡
; \

2792 
	`QUEUE_TYPEOF
(
ty³
è**
sw­_Ï¡
 = (
h—d1
)->
tqh_Ï¡
; \

2793 (
h—d1
)->
tqh_fœ¡
 = (
h—d2
)->tqh_first; \

2794 (
h—d1
)->
tqh_Ï¡
 = (
h—d2
)->tqh_last; \

2795 (
h—d2
)->
tqh_fœ¡
 = 
sw­_fœ¡
; \

2796 (
h—d2
)->
tqh_Ï¡
 = 
sw­_Ï¡
; \

2797 ià((
sw­_fœ¡
 = (
h—d1
)->
tqh_fœ¡
è!ğ
NULL
) \

2798 
sw­_fœ¡
->
f›ld
.
tqe_´ev
 = &(
h—d1
)->
tqh_fœ¡
; \

2800 (
h—d1
)->
tqh_Ï¡
 = &(h—d1)->
tqh_fœ¡
; \

2801 ià((
sw­_fœ¡
 = (
h—d2
)->
tqh_fœ¡
è!ğ
NULL
) \

2802 
sw­_fœ¡
->
f›ld
.
tqe_´ev
 = &(
h—d2
)->
tqh_fœ¡
; \

2804 (
h—d2
)->
tqh_Ï¡
 = &(h—d2)->
tqh_fœ¡
; \

2805 } 0)

	)

2808 #ifdeà
MG_MODULE_LINES


2816 #iâdeà
CS_MONGOOSE_SRC_FEATURES_H_


2817 
	#CS_MONGOOSE_SRC_FEATURES_H_


	)

2819 #iâdeà
MG_DISABLE_HTTP_DIGEST_AUTH


2820 
	#MG_DISABLE_HTTP_DIGEST_AUTH
 0

	)

2823 #iâdeà
MG_DISABLE_HTTP_KEEP_ALIVE


2824 
	#MG_DISABLE_HTTP_KEEP_ALIVE
 0

	)

2827 #iâdeà
MG_DISABLE_PFS


2828 
	#MG_DISABLE_PFS
 0

	)

2831 #iâdeà
MG_DISABLE_WS_RANDOM_MASK


2832 
	#MG_DISABLE_WS_RANDOM_MASK
 0

	)

2835 #iâdeà
MG_ENABLE_ASYNC_RESOLVER


2836 
	#MG_ENABLE_ASYNC_RESOLVER
 1

	)

2839 #iâdeà
MG_ENABLE_BROADCAST


2840 
	#MG_ENABLE_BROADCAST
 0

	)

2843 #iâdeà
MG_ENABLE_COAP


2844 
	#MG_ENABLE_COAP
 0

	)

2847 #iâdeà
MG_ENABLE_DEBUG


2848 
	#MG_ENABLE_DEBUG
 0

	)

2851 #iâdeà
MG_ENABLE_DIRECTORY_LISTING


2852 
	#MG_ENABLE_DIRECTORY_LISTING
 0

	)

2855 #iâdeà
MG_ENABLE_DNS


2856 
	#MG_ENABLE_DNS
 1

	)

2859 #iâdeà
MG_ENABLE_DNS_SERVER


2860 
	#MG_ENABLE_DNS_SERVER
 0

	)

2863 #iâdeà
MG_ENABLE_FAKE_DAVLOCK


2864 
	#MG_ENABLE_FAKE_DAVLOCK
 0

	)

2867 #iâdeà
MG_ENABLE_FILESYSTEM


2868 
	#MG_ENABLE_FILESYSTEM
 0

	)

2871 #iâdeà
MG_ENABLE_GETADDRINFO


2872 
	#MG_ENABLE_GETADDRINFO
 0

	)

2875 #iâdeà
MG_ENABLE_HEXDUMP


2876 
	#MG_ENABLE_HEXDUMP
 
CS_ENABLE_STDIO


	)

2879 #iâdeà
MG_ENABLE_HTTP


2880 
	#MG_ENABLE_HTTP
 1

	)

2883 #iâdeà
MG_ENABLE_HTTP_CGI


2884 
	#MG_ENABLE_HTTP_CGI
 0

	)

2887 #iâdeà
MG_ENABLE_HTTP_SSI


2888 
	#MG_ENABLE_HTTP_SSI
 
MG_ENABLE_FILESYSTEM


	)

2891 #iâdeà
MG_ENABLE_HTTP_SSI_EXEC


2892 
	#MG_ENABLE_HTTP_SSI_EXEC
 0

	)

2895 #iâdeà
MG_ENABLE_HTTP_STREAMING_MULTIPART


2896 
	#MG_ENABLE_HTTP_STREAMING_MULTIPART
 0

	)

2899 #iâdeà
MG_ENABLE_HTTP_WEBDAV


2900 
	#MG_ENABLE_HTTP_WEBDAV
 0

	)

2903 #iâdeà
MG_ENABLE_HTTP_WEBSOCKET


2904 
	#MG_ENABLE_HTTP_WEBSOCKET
 
MG_ENABLE_HTTP


	)

2907 #iâdeà
MG_ENABLE_IPV6


2908 
	#MG_ENABLE_IPV6
 0

	)

2911 #iâdeà
MG_ENABLE_JAVASCRIPT


2912 
	#MG_ENABLE_JAVASCRIPT
 0

	)

2915 #iâdeà
MG_ENABLE_MQTT


2916 
	#MG_ENABLE_MQTT
 1

	)

2919 #iâdeà
MG_ENABLE_MQTT_BROKER


2920 
	#MG_ENABLE_MQTT_BROKER
 0

	)

2923 #iâdeà
MG_ENABLE_SSL


2924 
	#MG_ENABLE_SSL
 0

	)

2927 #iâdeà
MG_ENABLE_SYNC_RESOLVER


2928 
	#MG_ENABLE_SYNC_RESOLVER
 0

	)

2931 #iâdeà
MG_ENABLE_STDIO


2932 
	#MG_ENABLE_STDIO
 
CS_ENABLE_STDIO


	)

2935 #iâdeà
MG_NET_IF


2936 
	#MG_NET_IF
 
MG_NET_IF_SOCKET


	)

2939 #iâdeà
MG_SSL_IF


2940 
	#MG_SSL_IF
 
MG_SSL_IF_OPENSSL


	)

2943 #iâdeà
MG_ENABLE_THREADS


2944 #ifdeà
_WIN32


2946 
	#MG_ENABLE_THREADS
 0

	)

2948 
	#MG_ENABLE_THREADS
 0

	)

2952 #ià
MG_ENABLE_DEBUG
 && !
defšed
(
CS_ENABLE_DEBUG
)

2953 
	#CS_ENABLE_DEBUG
 1

	)

2957 #ià
MG_ENABLE_MQTT_BROKER
 && !
MG_ENABLE_MQTT


2958 #undeà
MG_ENABLE_MQTT


2959 
	#MG_ENABLE_MQTT
 1

	)

2962 #iâdeà
MG_ENABLE_HTTP_URL_REWRITES


2963 
	#MG_ENABLE_HTTP_URL_REWRITES
 \

2964 (
CS_PLATFORM
 =ğ
CS_P_WINDOWS
 || CS_PLATFORM =ğ
CS_P_UNIX
)

	)

2967 #iâdeà
MG_ENABLE_TUN


2968 
	#MG_ENABLE_TUN
 
MG_ENABLE_HTTP_WEBSOCKET


	)

2971 #iâdeà
MG_ENABLE_SNTP


2972 
	#MG_ENABLE_SNTP
 0

	)

2975 #iâdeà
MG_ENABLE_EXTRA_ERRORS_DESC


2976 
	#MG_ENABLE_EXTRA_ERRORS_DESC
 0

	)

2980 #ifdeà
MG_MODULE_LINES


2988 #iâdeà
CS_MONGOOSE_SRC_NET_IF_H_


2989 
	#CS_MONGOOSE_SRC_NET_IF_H_


	)

3003 #ifdeà
__ılu¥lus


3007 
	#MG_MAIN_IFACE
 0

	)

3009 
mg_mgr
;

3010 
mg_cÚÃùiÚ
;

3011 
sock‘_add»ss
;

3013 
mg_içû_vbË
;

3015 
	smg_içû
 {

3016 
mg_mgr
 *
mgr
;

3017 *
d©a
;

3018 
mg_içû_vbË
 *
vbË
;

3021 
	smg_içû_vbË
 {

3022 (*
š™
)(
mg_içû
 *
içû
);

3023 (*
ä“
)(
mg_içû
 *
içû
);

3024 (*
add_cÚn
)(
mg_cÚÃùiÚ
 *
nc
);

3025 (*
»move_cÚn
)(
mg_cÚÃùiÚ
 *
nc
);

3026 
time_t
 (*
pŞl
)(
mg_içû
 *
içû
, 
timeout_ms
);

3029 (*
li¡’_tı
)(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
);

3031 (*
li¡’_udp
)(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
);

3034 (*
cÚÃù_tı
)(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ 
sock‘_add»ss
 *
§
);

3036 (*
cÚÃù_udp
)(
mg_cÚÃùiÚ
 *
nc
);

3039 (*
tı_£nd
)(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
, 
size_t
 
Ën
);

3040 (*
udp_£nd
)(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
, 
size_t
 
Ën
);

3042 (*
»cved
)(
mg_cÚÃùiÚ
 *
nc
, 
size_t
 
Ën
);

3045 (*
ü—‹_cÚn
)(
mg_cÚÃùiÚ
 *
nc
);

3047 (*
de¡roy_cÚn
)(
mg_cÚÃùiÚ
 *
nc
);

3050 (*
sock_£t
)(
mg_cÚÃùiÚ
 *
nc
, 
sock_t
 
sock
);

3053 (*
g‘_cÚn_addr
)(
mg_cÚÃùiÚ
 *
nc
, 
»mÙe
,

3054 
sock‘_add»ss
 *
§
);

3057 
mg_içû_vbË
 *
mg_içûs
[];

3058 
mg_num_içûs
;

3061 
mg_içû
 *
mg_if_ü—‹_içû
(
mg_içû_vbË
 *
vbË
,

3062 
mg_mgr
 *
mgr
);

3068 
mg_içû
 *
mg_fšd_içû
(
mg_mgr
 *
mgr
,

3069 
mg_içû_vbË
 *
vbË
,

3070 
mg_içû
 *
äom
);

3077 
mg_cÚÃùiÚ
 *
mg_if_acû±_Ãw_cÚn
(mg_cÚÃùiÚ *
lc
);

3078 
mg_if_acû±_tı_cb
(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
,

3079 
size_t
 
§_Ën
);

3082 
mg_if_cÚÃù_cb
(
mg_cÚÃùiÚ
 *
nc
, 
”r
);

3084 
mg_if_£Á_cb
(
mg_cÚÃùiÚ
 *
nc
, 
num_£Á
);

3091 
mg_if_»cv_tı_cb
(
mg_cÚÃùiÚ
 *
nc
, *
buf
, 
Ën
, 
own
);

3097 
mg_if_»cv_udp_cb
(
mg_cÚÃùiÚ
 *
nc
, *
buf
, 
Ën
,

3098 
sock‘_add»ss
 *
§
, 
size_t
 
§_Ën
);

3103 
mg_if_pŞl
(
mg_cÚÃùiÚ
 *
nc
, 
time_t
 
now
);

3106 
mg_if_tim”
(
mg_cÚÃùiÚ
 *
c
, 
now
);

3108 #ifdeà
__ılu¥lus


3113 #ifdeà
MG_MODULE_LINES


3121 #iâdeà
CS_MONGOOSE_SRC_SSL_IF_H_


3122 
	#CS_MONGOOSE_SRC_SSL_IF_H_


	)

3124 #ià
MG_ENABLE_SSL


3126 #ifdeà
__ılu¥lus


3130 
mg_s¦_if_ùx
;

3131 
mg_cÚÃùiÚ
;

3133 
mg_s¦_if_š™
();

3135 
	emg_s¦_if_»suÉ
 {

3136 
MG_SSL_OK
 = 0,

3137 
MG_SSL_WANT_READ
 = -1,

3138 
MG_SSL_WANT_WRITE
 = -2,

3139 
MG_SSL_ERROR
 = -3,

3142 
	smg_s¦_if_cÚn_·¿ms
 {

3143 cÚ¡ *
û¹
;

3144 cÚ¡ *
key
;

3145 cÚ¡ *
ÿ_û¹
;

3146 cÚ¡ *
£rv”_Çme
;

3147 cÚ¡ *
ch”_su™es
;

3148 cÚ¡ *
psk_id’t™y
;

3149 cÚ¡ *
psk_key
;

3152 
mg_s¦_if_»suÉ
 
mg_s¦_if_cÚn_š™
(

3153 
mg_cÚÃùiÚ
 *
nc
, cÚ¡ 
mg_s¦_if_cÚn_·¿ms
 *
·¿ms
,

3154 cÚ¡ **
”r_msg
);

3155 
mg_s¦_if_»suÉ
 
mg_s¦_if_cÚn_acû±
(
mg_cÚÃùiÚ
 *
nc
,

3156 
mg_cÚÃùiÚ
 *
lc
);

3157 
mg_s¦_if_cÚn_ä“
(
mg_cÚÃùiÚ
 *
nc
);

3159 
mg_s¦_if_»suÉ
 
mg_s¦_if_hªdshake
(
mg_cÚÃùiÚ
 *
nc
);

3160 
mg_s¦_if_»ad
(
mg_cÚÃùiÚ
 *
nc
, *
buf
, 
size_t
 
buf_size
);

3161 
mg_s¦_if_wr™e
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
d©a
, 
size_t
 
Ën
);

3163 #ifdeà
__ılu¥lus


3170 #ifdeà
MG_MODULE_LINES


3200 #iâdeà
CS_MONGOOSE_SRC_NET_H_


3201 
	#CS_MONGOOSE_SRC_NET_H_


	)

3203 #ià
MG_ENABLE_JAVASCRIPT


3204 
	#EXCLUDE_COMMON


	)

3205 
	~<v7.h
>

3212 #iâdeà
MG_VPRINTF_BUFFER_SIZE


3213 
	#MG_VPRINTF_BUFFER_SIZE
 100

	)

3216 #ifdeà
MG_USE_READ_WRITE


3217 
	#MG_RECV_FUNC
(
s
, 
b
, 
l
, 
f
è
	`»ad
(s, b,†)

	)

3218 
	#MG_SEND_FUNC
(
s
, 
b
, 
l
, 
f
è
	`wr™e
(s, b,†)

	)

3220 
	#MG_RECV_FUNC
(
s
, 
b
, 
l
, 
f
è
	`»cv
(s, b,†, f)

	)

3221 
	#MG_SEND_FUNC
(
s
, 
b
, 
l
, 
f
è
	`£nd
(s, b,†, f)

	)

3224 #ifdeà
__ılu¥lus


3228 
	usock‘_add»ss
 {

3229 
sockaddr
 
§
;

3230 
sockaddr_š
 
sš
;

3231 #ià
MG_ENABLE_IPV6


3232 
sockaddr_š6
 
sš6
;

3234 
sockaddr
 
sš6
;

3238 
mg_cÚÃùiÚ
;

3244 (*
mg_ev’t_hªdËr_t
)(
	tmg_cÚÃùiÚ
 *
	tnc
, 
	tev
,

3245 *
	tev_d©a
);

3248 
	#MG_EV_POLL
 0

	)

3249 
	#MG_EV_ACCEPT
 1

	)

3250 
	#MG_EV_CONNECT
 2

	)

3251 
	#MG_EV_RECV
 3

	)

3252 
	#MG_EV_SEND
 4

	)

3253 
	#MG_EV_CLOSE
 5

	)

3254 
	#MG_EV_TIMER
 6

	)

3259 
	smg_mgr
 {

3260 
mg_cÚÃùiÚ
 *
aùive_cÚÃùiÚs
;

3261 #ià
MG_ENABLE_HEXDUMP


3262 cÚ¡ *
hexdump_fe
;

3264 #ià
MG_ENABLE_BROADCAST


3265 
sock_t
 
ùl
[2];

3267 *
u£r_d©a
;

3268 
num_içûs
;

3269 
mg_içû
 **
içûs
;

3270 #ià
MG_ENABLE_JAVASCRIPT


3271 
v7
 *v7;

3278 
	smg_cÚÃùiÚ
 {

3279 
mg_cÚÃùiÚ
 *
Ãxt
, *
´ev
;

3280 
mg_cÚÃùiÚ
 *
li¡’”
;

3281 
mg_mgr
 *
mgr
;

3283 
sock_t
 
sock
;

3284 
”r
;

3285 
sock‘_add»ss
 
§
;

3286 
size_t
 
»cv_mbuf_lim™
;

3287 
mbuf
 
»cv_mbuf
;

3288 
mbuf
 
£nd_mbuf
;

3289 
time_t
 
Ï¡_io_time
;

3290 
ev_tim”_time
;

3291 #ià
MG_ENABLE_SSL


3292 *
s¦_if_d©a
;

3294 
mg_ev’t_hªdËr_t
 
´Ùo_hªdËr
;

3295 *
´Ùo_d©a
;

3296 (*
´Ùo_d©a_de¡ruùÜ
)(*
´Ùo_d©a
);

3297 
mg_ev’t_hªdËr_t
 
hªdËr
;

3298 *
u£r_d©a
;

3300 *
v
;

3305 
mg_ev’t_hªdËr_t
 
f
;

3306 } 
´iv_1
;

3307 *
´iv_2
;

3308 *
mgr_d©a
;

3309 
mg_içû
 *
içû
;

3310 
æags
;

3312 
	#MG_F_LISTENING
 (1 << 0è

	)

3313 
	#MG_F_UDP
 (1 << 1è

	)

3314 
	#MG_F_RESOLVING
 (1 << 2è

	)

3315 
	#MG_F_CONNECTING
 (1 << 3è

	)

3316 
	#MG_F_SSL
 (1 << 4è

	)

3317 
	#MG_F_SSL_HANDSHAKE_DONE
 (1 << 5è

	)

3318 
	#MG_F_WANT_READ
 (1 << 6è

	)

3319 
	#MG_F_WANT_WRITE
 (1 << 7è

	)

3320 
	#MG_F_IS_WEBSOCKET
 (1 << 8è

	)

3323 
	#MG_F_SEND_AND_CLOSE
 (1 << 10è

	)

3324 
	#MG_F_CLOSE_IMMEDIATELY
 (1 << 11è

	)

3325 
	#MG_F_WEBSOCKET_NO_DEFRAG
 (1 << 12è

	)

3326 
	#MG_F_DELETE_CHUNK
 (1 << 13è

	)

3327 
	#MG_F_ENABLE_BROADCAST
 (1 << 14è

	)

3328 
	#MG_F_TUN_DO_NOT_RECONNECT
 (1 << 15è

	)

3330 
	#MG_F_USER_1
 (1 << 20è

	)

3331 
	#MG_F_USER_2
 (1 << 21)

	)

3332 
	#MG_F_USER_3
 (1 << 22)

	)

3333 
	#MG_F_USER_4
 (1 << 23)

	)

3334 
	#MG_F_USER_5
 (1 << 24)

	)

3335 
	#MG_F_USER_6
 (1 << 25)

	)

3337 
size_t
 
r1
;

3338 
size_t
 
rş
;

3349 
mg_mgr_š™
(
mg_mgr
 *
mgr
, *
u£r_d©a
);

3366 
	smg_mgr_š™_İts
 {

3367 
mg_içû_vbË
 *
maš_içû
;

3368 
num_içûs
;

3369 
mg_içû_vbË
 **
içûs
;

3378 
mg_mgr_š™_İt
(
mg_mgr
 *
mgr
, *
u£r_d©a
,

3379 
mg_mgr_š™_İts
 
İts
);

3386 
mg_mgr_ä“
(
mg_mgr
 *);

3396 
time_t
 
mg_mgr_pŞl
(
mg_mgr
 *, 
mli
);

3398 #ià
MG_ENABLE_BROADCAST


3411 
mg_brßdÿ¡
(
mg_mgr
 *, 
mg_ev’t_hªdËr_t
 
func
, *, 
size_t
);

3427 
mg_cÚÃùiÚ
 *
mg_Ãxt
(
mg_mgr
 *, mg_connection *);

3435 
	smg_add_sock_İts
 {

3436 *
u£r_d©a
;

3437 
æags
;

3438 cÚ¡ **
”rÜ_¡ršg
;

3439 
mg_içû
 *
içû
;

3448 
mg_cÚÃùiÚ
 *
mg_add_sock
(
mg_mgr
 *, 
sock_t
, 
mg_ev’t_hªdËr_t
);

3456 
mg_cÚÃùiÚ
 *
mg_add_sock_İt
(
mg_mgr
 *, 
sock_t
,

3457 
mg_ev’t_hªdËr_t
,

3458 
mg_add_sock_İts
);

3466 
	smg_bšd_İts
 {

3467 *
u£r_d©a
;

3468 
æags
;

3469 cÚ¡ **
”rÜ_¡ršg
;

3470 
mg_içû
 *
içû
;

3471 #ià
MG_ENABLE_SSL


3478 cÚ¡ *
s¦_û¹
;

3481 cÚ¡ *
s¦_key
;

3483 cÚ¡ *
s¦_ÿ_û¹
;

3495 cÚ¡ *
s¦_ch”_su™es
;

3504 
mg_cÚÃùiÚ
 *
mg_bšd
(
mg_mgr
 *, const *,

3505 
mg_ev’t_hªdËr_t
);

3524 
mg_cÚÃùiÚ
 *
mg_bšd_İt
(
mg_mgr
 *
mgr
, cÚ¡ *
add»ss
,

3525 
mg_ev’t_hªdËr_t
 
hªdËr
,

3526 
mg_bšd_İts
 
İts
);

3529 
	smg_cÚÃù_İts
 {

3530 *
u£r_d©a
;

3531 
æags
;

3532 cÚ¡ **
”rÜ_¡ršg
;

3533 
mg_içû
 *
içû
;

3534 #ià
MG_ENABLE_SSL


3539 cÚ¡ *
s¦_û¹
;

3544 cÚ¡ *
s¦_key
;

3549 cÚ¡ *
s¦_ÿ_û¹
;

3561 cÚ¡ *
s¦_ch”_su™es
;

3569 cÚ¡ *
s¦_£rv”_Çme
;

3577 cÚ¡ *
s¦_psk_id’t™y
;

3578 cÚ¡ *
s¦_psk_key
;

3587 
mg_cÚÃùiÚ
 *
mg_cÚÃù
(
mg_mgr
 *
mgr
, cÚ¡ *
add»ss
,

3588 
mg_ev’t_hªdËr_t
 
hªdËr
);

3638 
mg_cÚÃùiÚ
 *
mg_cÚÃù_İt
(
mg_mgr
 *
mgr
, cÚ¡ *
add»ss
,

3639 
mg_ev’t_hªdËr_t
 
hªdËr
,

3640 
mg_cÚÃù_İts
 
İts
);

3642 #ià
MG_ENABLE_SSL
 && 
MG_NET_IF
 !ğ
MG_NET_IF_SIMPLELINK


3657 cÚ¡ *
mg_£t_s¦
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
û¹
,

3658 cÚ¡ *
ÿ_û¹
);

3668 
mg_£nd
(
mg_cÚÃùiÚ
 *, cÚ¡ *
buf
, 
Ën
);

3671 #ià
defšed
(
__GNUC__
)

3672 
__©Œibu‹__
((
fÜm©
(
´štf
, 2, 3)))

3681 
mg_´štf
(
mg_cÚÃùiÚ
 *, cÚ¡ *
fmt
, ...);

3684 
mg_v´štf
(
mg_cÚÃùiÚ
 *, cÚ¡ *
fmt
, 
va_li¡
 
­
);

3691 
mg_sock‘·œ
(
sock_t
[2], 
sock_ty³
);

3693 #ià
MG_ENABLE_SYNC_RESOLVER


3704 
mg_»sŞve
(cÚ¡ *
domaš_Çme
, *
_addr_buf
, 
size_t
 
buf_Ën
);

3727 
mg_check__aş
(cÚ¡ *
aş
, 
ušt32_t
 
»mÙe_
);

3729 #ià
MG_ENABLE_JAVASCRIPT


3736 
v7_”r
 
mg_’abË_javasüt
(
mg_mgr
 *
m
, 
v7
 *v7,

3737 cÚ¡ *
š™_js_fe_Çme
);

3764 
mg_£t_tim”
(
mg_cÚÃùiÚ
 *
c
, 
time¡amp
);

3769 
mg_time
();

3771 #ifdeà
__ılu¥lus


3776 #ifdeà
MG_MODULE_LINES


3788 #iâdeà
CS_MONGOOSE_SRC_URI_H_


3789 
	#CS_MONGOOSE_SRC_URI_H_


	)

3793 #ifdeà
__ılu¥lus


3820 
mg_·r£_uri
(
mg_¡r
 
uri
, mg_¡¸*
scheme
,

3821 
mg_¡r
 *
u£r_šfo
, mg_¡¸*
ho¡
,

3822 *
pÜt
, 
mg_¡r
 *
·th
, mg_¡¸*
qu”y
,

3823 
mg_¡r
 *
äagm’t
);

3825 
mg_nÜm®ize_uri_·th
(cÚ¡ 
mg_¡r
 *
š
, mg_¡¸*
out
);

3827 #ifdeà
__ılu¥lus


3831 #ifdeà
MG_MODULE_LINES


3843 #iâdeà
CS_MONGOOSE_SRC_UTIL_H_


3844 
	#CS_MONGOOSE_SRC_UTIL_H_


	)

3846 
	~<¡dio.h
>

3851 #ifdeà
__ılu¥lus


3855 #iâdeà
MAX_PATH_SIZE


3856 
	#MAX_PATH_SIZE
 500

	)

3868 cÚ¡ *
mg_sk
(cÚ¡ *
s
, cÚ¡ *
’d_¡ršg
,

3869 cÚ¡ *
d–im™”s
, 
mg_¡r
 *
v
);

3881 
mg_ba£64_decode
(cÚ¡ *
s
, 
Ën
, *
d¡
);

3888 
mg_ba£64_’code
(cÚ¡ *
¤c
, 
¤c_Ën
, *
d¡
);

3890 #ià
MG_ENABLE_FILESYSTEM


3898 
mg_¡©
(cÚ¡ *
·th
, 
cs_¡©_t
 *
¡
);

3907 
FILE
 *
mg_fİ’
(cÚ¡ *
·th
, cÚ¡ *
mode
);

3916 
mg_İ’
(cÚ¡ *
·th
, 
æag
, 
mode
);

3919 #ià
MG_ENABLE_THREADS


3926 *
mg_¡¬t_th»ad
(*(*
th»ad_func
)(*), *
th»ad_func_·¿m
);

3929 
mg_£t_şo£_Ú_exec
(
sock_t
);

3931 
	#MG_SOCK_STRINGIFY_IP
 1

	)

3932 
	#MG_SOCK_STRINGIFY_PORT
 2

	)

3933 
	#MG_SOCK_STRINGIFY_REMOTE
 4

	)

3947 
mg_cÚn_addr_to_¡r
(
mg_cÚÃùiÚ
 *
nc
, *
buf
, 
size_t
 
Ën
,

3948 
æags
);

3949 #ià
MG_NET_IF
 =ğ
MG_NET_IF_SOCKET


3951 
mg_sock_to_¡r
(
sock_t
 
sock
, *
buf
, 
size_t
 
Ën
, 
æags
);

3959 
mg_sock_addr_to_¡r
(cÚ¡ 
sock‘_add»ss
 *
§
, *
buf
, 
size_t
 
Ën
,

3960 
æags
);

3962 #ià
MG_ENABLE_HEXDUMP


3971 
mg_hexdump
(cÚ¡ *
buf
, 
Ën
, *
d¡
, 
d¡_Ën
);

3974 
mg_hexdumpf
(
FILE
 *
å
, cÚ¡ *
buf
, 
Ën
);

3983 
mg_hexdump_cÚÃùiÚ
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

3984 cÚ¡ *
buf
, 
num_by‹s
, 
ev
);

3990 
mg_is_big_’dŸn
();

4005 cÚ¡ *
mg_Ãxt_comma_li¡_’Œy
(cÚ¡ *
li¡
, 
mg_¡r
 *
v®
,

4006 
mg_¡r
 *
eq_v®
);

4015 
mg_m©ch_´efix
(cÚ¡ *
·‰”n
, 
·‰”n_Ën
, cÚ¡ *
¡r
);

4016 
mg_m©ch_´efix_n
(cÚ¡ 
mg_¡r
 
·‰”n
, cÚ¡ mg_¡¸
¡r
);

4021 
mg_mbuf_­³nd_ba£64_putc
(
ch
, *
u£r_d©a
);

4026 
mg_mbuf_­³nd_ba£64
(
mbuf
 *mbuf, cÚ¡ *
d©a
, 
size_t
 
Ën
);

4033 
mg_basic_auth_h—d”
(cÚ¡ *
u£r
, cÚ¡ *
·ss
, 
mbuf
 *
buf
);

4035 #ifdeà
__ılu¥lus


4039 #ifdeà
MG_MODULE_LINES


4051 #iâdeà
CS_MONGOOSE_SRC_HTTP_H_


4052 
	#CS_MONGOOSE_SRC_HTTP_H_


	)

4054 #ià
MG_ENABLE_HTTP


4059 #ifdeà
__ılu¥lus


4063 #iâdeà
MG_MAX_HTTP_HEADERS


4064 
	#MG_MAX_HTTP_HEADERS
 20

	)

4067 #iâdeà
MG_MAX_HTTP_REQUEST_SIZE


4068 
	#MG_MAX_HTTP_REQUEST_SIZE
 1024

	)

4071 #iâdeà
MG_MAX_PATH


4072 #ifdeà
PATH_MAX


4073 
	#MG_MAX_PATH
 
PATH_MAX


	)

4075 
	#MG_MAX_PATH
 256

	)

4079 #iâdeà
MG_MAX_HTTP_SEND_MBUF


4080 
	#MG_MAX_HTTP_SEND_MBUF
 1024

	)

4083 #iâdeà
MG_CGI_ENVIRONMENT_SIZE


4084 
	#MG_CGI_ENVIRONMENT_SIZE
 8192

	)

4088 
	sh‰p_mes§ge
 {

4089 
mg_¡r
 
mes§ge
;

4092 
mg_¡r
 
m‘hod
;

4093 
mg_¡r
 
uri
;

4094 
mg_¡r
 
´Ùo
;

4097 
»¥_code
;

4098 
mg_¡r
 
»¥_¡©us_msg
;

4108 
mg_¡r
 
qu”y_¡ršg
;

4111 
mg_¡r
 
h—d”_Çmes
[
MG_MAX_HTTP_HEADERS
];

4112 
mg_¡r
 
h—d”_v®ues
[
MG_MAX_HTTP_HEADERS
];

4115 
mg_¡r
 
body
;

4118 #ià
MG_ENABLE_HTTP_WEBSOCKET


4120 
	swebsock‘_mes§ge
 {

4121 *
d©a
;

4122 
size_t
 
size
;

4123 
æags
;

4128 
	smg_h‰p_muÉ¬t_·¹
 {

4129 cÚ¡ *
fe_Çme
;

4130 cÚ¡ *
v¬_Çme
;

4131 
mg_¡r
 
d©a
;

4132 
¡©us
;

4133 *
u£r_d©a
;

4137 
	smg_ssi_ÿÎ_ùx
 {

4138 
h‰p_mes§ge
 *
»q
;

4139 
mg_¡r
 
fe
;

4140 
mg_¡r
 
¬g
;

4144 
	#MG_EV_HTTP_REQUEST
 100

	)

4145 
	#MG_EV_HTTP_REPLY
 101

	)

4146 
	#MG_EV_HTTP_CHUNK
 102

	)

4147 
	#MG_EV_SSI_CALL
 105

	)

4148 
	#MG_EV_SSI_CALL_CTX
 106

	)

4150 #ià
MG_ENABLE_HTTP_WEBSOCKET


4151 
	#MG_EV_WEBSOCKET_HANDSHAKE_REQUEST
 111

	)

4152 
	#MG_EV_WEBSOCKET_HANDSHAKE_DONE
 112

	)

4153 
	#MG_EV_WEBSOCKET_FRAME
 113

	)

4154 
	#MG_EV_WEBSOCKET_CONTROL_FRAME
 114

	)

4157 #ià
MG_ENABLE_HTTP_STREAMING_MULTIPART


4158 
	#MG_EV_HTTP_MULTIPART_REQUEST
 121

	)

4159 
	#MG_EV_HTTP_PART_BEGIN
 122

	)

4160 
	#MG_EV_HTTP_PART_DATA
 123

	)

4161 
	#MG_EV_HTTP_PART_END
 124

	)

4163 
	#MG_EV_HTTP_MULTIPART_REQUEST_END
 125

	)

4218 
mg_£t_´ÙocŞ_h‰p_websock‘
(
mg_cÚÃùiÚ
 *
nc
);

4220 #ià
MG_ENABLE_HTTP_WEBSOCKET


4235 
mg_£nd_websock‘_hªdshake
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
uri
,

4236 cÚ¡ *
exŒa_h—d”s
);

4248 
mg_£nd_websock‘_hªdshake2
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

4249 cÚ¡ *
ho¡
, cÚ¡ *
´ÙocŞ
,

4250 cÚ¡ *
exŒa_h—d”s
);

4253 
mg_£nd_websock‘_hªdshake3
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

4254 cÚ¡ *
ho¡
, cÚ¡ *
´ÙocŞ
,

4255 cÚ¡ *
exŒa_h—d”s
, cÚ¡ *
u£r
,

4256 cÚ¡ *
·ss
);

4277 
mg_cÚÃùiÚ
 *
mg_cÚÃù_ws
(
mg_mgr
 *
mgr
,

4278 
mg_ev’t_hªdËr_t
 
ev’t_hªdËr
,

4279 cÚ¡ *
u¾
, cÚ¡ *
´ÙocŞ
,

4280 cÚ¡ *
exŒa_h—d”s
);

4288 
mg_cÚÃùiÚ
 *
mg_cÚÃù_ws_İt
(
mg_mgr
 *
mgr
,

4289 
mg_ev’t_hªdËr_t
 
ev_hªdËr
,

4290 
mg_cÚÃù_İts
 
İts
,

4291 cÚ¡ *
u¾
, cÚ¡ *
´ÙocŞ
,

4292 cÚ¡ *
exŒa_h—d”s
);

4312 
mg_£nd_websock‘_äame
(
mg_cÚÃùiÚ
 *
nc
, 
İ_ªd_æags
,

4313 cÚ¡ *
d©a
, 
size_t
 
d©a_Ën
);

4320 
mg_£nd_websock‘_äamev
(
mg_cÚÃùiÚ
 *
nc
, 
İ_ªd_æags
,

4321 cÚ¡ 
mg_¡r
 *
¡ršgs
, 
num_¡ršgs
);

4329 
mg_´štf_websock‘_äame
(
mg_cÚÃùiÚ
 *
nc
, 
İ_ªd_æags
,

4330 cÚ¡ *
fmt
, ...);

4333 
	#WEBSOCKET_OP_CONTINUE
 0

	)

4334 
	#WEBSOCKET_OP_TEXT
 1

	)

4335 
	#WEBSOCKET_OP_BINARY
 2

	)

4336 
	#WEBSOCKET_OP_CLOSE
 8

	)

4337 
	#WEBSOCKET_OP_PING
 9

	)

4338 
	#WEBSOCKET_OP_PONG
 10

	)

4352 
	#WEBSOCKET_DONT_FIN
 0x100

	)

4366 
mg_u¾_decode
(cÚ¡ *
¤c
, 
¤c_Ën
, *
d¡
, 
d¡_Ën
,

4367 
is_fÜm_u¾_’coded
);

4369 #ifdeà
__ılu¥lus


4376 #ifdeà
MG_MODULE_LINES


4383 #iâdeà
CS_MONGOOSE_SRC_HTTP_SERVER_H_


4384 
	#CS_MONGOOSE_SRC_HTTP_SERVER_H_


	)

4386 #ià
MG_ENABLE_HTTP


4388 #ifdeà
__ılu¥lus


4400 
mg_·r£_h‰p
(cÚ¡ *
s
, 
n
, 
h‰p_mes§ge
 *
hm
, 
is_»q
);

4408 
mg_¡r
 *
mg_g‘_h‰p_h—d”
(
h‰p_mes§ge
 *
hm
, cÚ¡ *
Çme
);

4425 
mg_h‰p_·r£_h—d”
(
mg_¡r
 *
hdr
, cÚ¡ *
v¬_Çme
, *
buf
,

4426 
size_t
 
buf_size
);

4434 
mg_g‘_h‰p_basic_auth
(
h‰p_mes§ge
 *
hm
, *
u£r
, 
size_t
 
u£r_Ën
,

4435 *
·ss
, 
size_t
 
·ss_Ën
);

4442 
mg_·r£_h‰p_basic_auth
(
mg_¡r
 *
hdr
, *
u£r
, 
size_t
 
u£r_Ën
,

4443 *
·ss
, 
size_t
 
·ss_Ën
);

4481 
size_t
 
mg_·r£_muÉ¬t
(cÚ¡ *
buf
, size_ˆ
buf_Ën
, *
v¬_Çme
,

4482 
size_t
 
v¬_Çme_Ën
, *
fe_Çme
,

4483 
size_t
 
fe_Çme_Ën
, cÚ¡ **
chunk
,

4484 
size_t
 *
chunk_Ën
);

4494 
mg_g‘_h‰p_v¬
(cÚ¡ 
mg_¡r
 *
buf
, cÚ¡ *
Çme
, *
d¡
,

4495 
size_t
 
d¡_Ën
);

4497 #ià
MG_ENABLE_FILESYSTEM


4502 
	smg_£rve_h‰p_İts
 {

4504 cÚ¡ *
docum’t_roÙ
;

4507 cÚ¡ *
šdex_fes
;

4518 cÚ¡ *
³r_dœeùÜy_auth_fe
;

4521 cÚ¡ *
auth_domaš
;

4531 cÚ¡ *
glob®_auth_fe
;

4534 cÚ¡ *
’abË_dœeùÜy_li¡šg
;

4594 cÚ¡ *
ssi_·‰”n
;

4597 cÚ¡ *
_aş
;

4599 #ià
MG_ENABLE_HTTP_URL_REWRITES


4624 cÚ¡ *
u¾_»wr™es
;

4628 cÚ¡ *
dav_docum’t_roÙ
;

4634 cÚ¡ *
dav_auth_fe
;

4637 cÚ¡ *
hidd’_fe_·‰”n
;

4640 cÚ¡ *
cgi_fe_·‰”n
;

4643 cÚ¡ *
cgi_š‹½»‹r
;

4649 cÚ¡ *
cu¡om_mime_ty³s
;

4655 cÚ¡ *
exŒa_h—d”s
;

4678 
mg_£rve_h‰p
(
mg_cÚÃùiÚ
 *
nc
, 
h‰p_mes§ge
 *
hm
,

4679 
mg_£rve_h‰p_İts
 
İts
);

4700 
mg_h‰p_£rve_fe
(
mg_cÚÃùiÚ
 *
nc
, 
h‰p_mes§ge
 *
hm
,

4701 cÚ¡ *
·th
, cÚ¡ 
mg_¡r
 
mime_ty³
,

4702 cÚ¡ 
mg_¡r
 
exŒa_h—d”s
);

4704 #ià
MG_ENABLE_HTTP_STREAMING_MULTIPART


4707 
mg_¡r
 (*
	tmg_fu_âame_â
)(
	tmg_cÚÃùiÚ
 *
	tnc
,

4708 
	tmg_¡r
 
	tâame
);

4742 
mg_fe_u¶ßd_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
, *
ev_d©a
,

4743 
mg_fu_âame_â
 
loÿl_Çme_â
);

4774 
mg_»gi¡”_h‰p_’dpošt
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
uri_·th
,

4775 
mg_ev’t_hªdËr_t
 
hªdËr
);

4781 
mg_h‰p_check_dige¡_auth
(
h‰p_mes§ge
 *
hm
, cÚ¡ *
auth_domaš
,

4782 
FILE
 *
å
);

4802 
mg_£nd_h‰p_chunk
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
, 
size_t
 
Ën
);

4808 
mg_´štf_h‰p_chunk
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
fmt
, ...);

4823 
mg_£nd_»¥Ú£_lše
(
mg_cÚÃùiÚ
 *
nc
, 
¡©us_code
,

4824 cÚ¡ *
exŒa_h—d”s
);

4830 
mg_h‰p_£nd_”rÜ
(
mg_cÚÃùiÚ
 *
nc
, 
code
, cÚ¡ *
»asÚ
);

4843 
mg_h‰p_£nd_»dœeù
(
mg_cÚÃùiÚ
 *
nc
, 
¡©us_code
,

4844 cÚ¡ 
mg_¡r
 
loÿtiÚ
,

4845 cÚ¡ 
mg_¡r
 
exŒa_h—d”s
);

4861 
mg_£nd_h—d
(
mg_cÚÃùiÚ
 *
n
, 
¡©us_code
,

4862 
št64_t
 
cÚ‹Á_Ëngth
, cÚ¡ *
exŒa_h—d”s
);

4867 
mg_´štf_html_esÿ³
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
fmt
, ...);

4869 #ià
MG_ENABLE_HTTP_URL_REWRITES


4880 
mg_h‰p_»v”£_´oxy
(
mg_cÚÃùiÚ
 *
nc
,

4881 cÚ¡ 
h‰p_mes§ge
 *
hm
, 
mg_¡r
 
mouÁ
,

4882 
mg_¡r
 
up¡»am
);

4885 #ifdeà
__ılu¥lus


4892 #ifdeà
MG_MODULE_LINES


4899 #iâdeà
CS_MONGOOSE_SRC_HTTP_CLIENT_H_


4900 
	#CS_MONGOOSE_SRC_HTTP_CLIENT_H_


	)

4902 #ifdeà
__ılu¥lus


4930 
mg_cÚÃùiÚ
 *
mg_cÚÃù_h‰p
(
mg_mgr
 *
mgr
,

4931 
mg_ev’t_hªdËr_t
 
ev’t_hªdËr
,

4932 cÚ¡ *
u¾
,

4933 cÚ¡ *
exŒa_h—d”s
,

4934 cÚ¡ *
po¡_d©a
);

4943 
mg_cÚÃùiÚ
 *
mg_cÚÃù_h‰p_İt
(
mg_mgr
 *
mgr
,

4944 
mg_ev’t_hªdËr_t
 
ev_hªdËr
,

4945 
mg_cÚÃù_İts
 
İts
,

4946 cÚ¡ *
u¾
,

4947 cÚ¡ *
exŒa_h—d”s
,

4948 cÚ¡ *
po¡_d©a
);

4951 
mg_h‰p_ü—‹_dige¡_auth_h—d”
(*
buf
, 
size_t
 
buf_Ën
,

4952 cÚ¡ *
m‘hod
, cÚ¡ *
uri
,

4953 cÚ¡ *
auth_domaš
, cÚ¡ *
u£r
,

4954 cÚ¡ *
·sswd
);

4956 #ifdeà
__ılu¥lus


4960 #ifdeà
MG_MODULE_LINES


4984 #iâdeà
CS_MONGOOSE_SRC_MQTT_H_


4985 
	#CS_MONGOOSE_SRC_MQTT_H_


	)

4989 
	smg_mq‰_mes§ge
 {

4990 
cmd
;

4991 
qos
;

4992 
mg_¡r
 
tİic
;

4993 
mg_¡r
 
·ylßd
;

4995 
ušt8_t
 
cÚÇck_»t_code
;

4996 
ušt16_t
 
mes§ge_id
;

4999 
ušt8_t
 
´ÙocŞ_v”siÚ
;

5000 
ušt8_t
 
cÚÃù_æags
;

5001 
ušt16_t
 
k“p_®ive_tim”
;

5002 
mg_¡r
 
´ÙocŞ_Çme
;

5003 
mg_¡r
 
ş›Á_id
;

5004 
mg_¡r
 
wl_tİic
;

5005 
mg_¡r
 
wl_mes§ge
;

5006 
mg_¡r
 
u£r_Çme
;

5007 
mg_¡r
 
·sswÜd
;

5010 
	smg_mq‰_tİic_ex´essiÚ
 {

5011 cÚ¡ *
	gtİic
;

5012 
ušt8_t
 
	gqos
;

5015 
	smg_£nd_mq‰_hªdshake_İts
 {

5016 
	gæags
;

5017 
ušt16_t
 
	gk“p_®ive
;

5018 cÚ¡ *
	gwl_tİic
;

5019 cÚ¡ *
	gwl_mes§ge
;

5020 cÚ¡ *
	gu£r_Çme
;

5021 cÚ¡ *
	g·sswÜd
;

5025 
	smg_mq‰_´Ùo_d©a
 {

5026 
ušt16_t
 
	gk“p_®ive
;

5030 
	#MG_MQTT_CMD_CONNECT
 1

	)

5031 
	#MG_MQTT_CMD_CONNACK
 2

	)

5032 
	#MG_MQTT_CMD_PUBLISH
 3

	)

5033 
	#MG_MQTT_CMD_PUBACK
 4

	)

5034 
	#MG_MQTT_CMD_PUBREC
 5

	)

5035 
	#MG_MQTT_CMD_PUBREL
 6

	)

5036 
	#MG_MQTT_CMD_PUBCOMP
 7

	)

5037 
	#MG_MQTT_CMD_SUBSCRIBE
 8

	)

5038 
	#MG_MQTT_CMD_SUBACK
 9

	)

5039 
	#MG_MQTT_CMD_UNSUBSCRIBE
 10

	)

5040 
	#MG_MQTT_CMD_UNSUBACK
 11

	)

5041 
	#MG_MQTT_CMD_PINGREQ
 12

	)

5042 
	#MG_MQTT_CMD_PINGRESP
 13

	)

5043 
	#MG_MQTT_CMD_DISCONNECT
 14

	)

5046 
	#MG_MQTT_EVENT_BASE
 200

	)

5047 
	#MG_EV_MQTT_CONNECT
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_CONNECT
)

	)

5048 
	#MG_EV_MQTT_CONNACK
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_CONNACK
)

	)

5049 
	#MG_EV_MQTT_PUBLISH
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_PUBLISH
)

	)

5050 
	#MG_EV_MQTT_PUBACK
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_PUBACK
)

	)

5051 
	#MG_EV_MQTT_PUBREC
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_PUBREC
)

	)

5052 
	#MG_EV_MQTT_PUBREL
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_PUBREL
)

	)

5053 
	#MG_EV_MQTT_PUBCOMP
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_PUBCOMP
)

	)

5054 
	#MG_EV_MQTT_SUBSCRIBE
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_SUBSCRIBE
)

	)

5055 
	#MG_EV_MQTT_SUBACK
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_SUBACK
)

	)

5056 
	#MG_EV_MQTT_UNSUBSCRIBE
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_UNSUBSCRIBE
)

	)

5057 
	#MG_EV_MQTT_UNSUBACK
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_UNSUBACK
)

	)

5058 
	#MG_EV_MQTT_PINGREQ
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_PINGREQ
)

	)

5059 
	#MG_EV_MQTT_PINGRESP
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_PINGRESP
)

	)

5060 
	#MG_EV_MQTT_DISCONNECT
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_DISCONNECT
)

	)

5063 
	#MG_MQTT_RETAIN
 0x1

	)

5064 
	#MG_MQTT_DUP
 0x4

	)

5065 
	#MG_MQTT_QOS
(
qos
è((qosè<< 1)

	)

5066 
	#MG_MQTT_GET_QOS
(
æags
è(((æagsè&0x6è>> 1)

	)

5067 
	#MG_MQTT_SET_QOS
(
æags
, 
qos
è(æagsèğ((æagsè& ~0x6è| ((qosè<< 1)

	)

5070 
	#MG_MQTT_CLEAN_SESSION
 0x02

	)

5071 
	#MG_MQTT_HAS_WILL
 0x04

	)

5072 
	#MG_MQTT_WILL_RETAIN
 0x20

	)

5073 
	#MG_MQTT_HAS_PASSWORD
 0x40

	)

5074 
	#MG_MQTT_HAS_USER_NAME
 0x80

	)

5075 
	#MG_MQTT_GET_WILL_QOS
(
æags
è(((æagsè&0x18è>> 3)

	)

5076 
	#MG_MQTT_SET_WILL_QOS
(
æags
, 
qos
) \

5077 (
æags
èğ((æagsè& ~0x18è| ((
qos
è<< 3)

	)

5080 
	#MG_EV_MQTT_CONNACK_ACCEPTED
 0

	)

5081 
	#MG_EV_MQTT_CONNACK_UNACCEPTABLE_VERSION
 1

	)

5082 
	#MG_EV_MQTT_CONNACK_IDENTIFIER_REJECTED
 2

	)

5083 
	#MG_EV_MQTT_CONNACK_SERVER_UNAVAILABLE
 3

	)

5084 
	#MG_EV_MQTT_CONNACK_BAD_AUTH
 4

	)

5085 
	#MG_EV_MQTT_CONNACK_NOT_AUTHORIZED
 5

	)

5087 #ifdeà
__ılu¥lus


5104 
mg_£t_´ÙocŞ_mq‰
(
mg_cÚÃùiÚ
 *
nc
);

5107 
mg_£nd_mq‰_hªdshake
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
ş›Á_id
);

5110 
mg_£nd_mq‰_hªdshake_İt
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
ş›Á_id
,

5111 
mg_£nd_mq‰_hªdshake_İts
);

5114 
mg_mq‰_publish
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
tİic
,

5115 
ušt16_t
 
mes§ge_id
, 
æags
, cÚ¡ *
d©a
,

5116 
size_t
 
Ën
);

5119 
mg_mq‰_subsüibe
(
mg_cÚÃùiÚ
 *
nc
,

5120 cÚ¡ 
mg_mq‰_tİic_ex´essiÚ
 *
tİics
,

5121 
size_t
 
tİics_Ën
, 
ušt16_t
 
mes§ge_id
);

5124 
mg_mq‰_unsubsüibe
(
mg_cÚÃùiÚ
 *
nc
, **
tİics
,

5125 
size_t
 
tİics_Ën
, 
ušt16_t
 
mes§ge_id
);

5128 
mg_mq‰_discÚÃù
(
mg_cÚÃùiÚ
 *
nc
);

5131 
mg_mq‰_cÚÇck
(
mg_cÚÃùiÚ
 *
nc
, 
ušt8_t
 
»tuº_code
);

5134 
mg_mq‰_puback
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
mes§ge_id
);

5137 
mg_mq‰_pub»c
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
mes§ge_id
);

5140 
mg_mq‰_pub»l
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
mes§ge_id
);

5143 
mg_mq‰_pubcomp
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
mes§ge_id
);

5149 
mg_mq‰_suback
(
mg_cÚÃùiÚ
 *
nc
, 
ušt8_t
 *
qoss
, 
size_t
 
qoss_Ën
,

5150 
ušt16_t
 
mes§ge_id
);

5153 
mg_mq‰_unsuback
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
mes§ge_id
);

5156 
mg_mq‰_pšg
(
mg_cÚÃùiÚ
 *
nc
);

5159 
mg_mq‰_pÚg
(
mg_cÚÃùiÚ
 *
nc
);

5168 
mg_mq‰_Ãxt_subsüibe_tİic
(
mg_mq‰_mes§ge
 *
msg
,

5169 
mg_¡r
 *
tİic
, 
ušt8_t
 *
qos
, 
pos
);

5171 #ifdeà
__ılu¥lus


5176 #ifdeà
MG_MODULE_LINES


5200 #iâdeà
CS_MONGOOSE_SRC_MQTT_BROKER_H_


5201 
	#CS_MONGOOSE_SRC_MQTT_BROKER_H_


	)

5203 #ià
MG_ENABLE_MQTT_BROKER


5208 #ifdeà
__ılu¥lus


5212 
	#MG_MQTT_MAX_SESSION_SUBSCRIPTIONS
 512;

	)

5214 
mg_mq‰_brok”
;

5217 
	smg_mq‰_£ssiÚ
 {

5218 
mg_mq‰_brok”
 *
brk
;

5219 
LIST_ENTRY
(
mg_mq‰_£ssiÚ
è
lšk
;

5220 
mg_cÚÃùiÚ
 *
nc
;

5221 
size_t
 
num_subsütiÚs
;

5222 *
u£r_d©a
;

5223 
mg_mq‰_tİic_ex´essiÚ
 *
subsütiÚs
;

5227 
	smg_mq‰_brok”
 {

5228 
LIST_HEAD
(
_mg_£ssh—d
, 
mg_mq‰_£ssiÚ
è
£ssiÚs
;

5229 *
u£r_d©a
;

5233 
mg_mq‰_brok”_š™
(
mg_mq‰_brok”
 *
brk
, *
u£r_d©a
);

5260 
mg_mq‰_brok”
(
mg_cÚÃùiÚ
 *
brk
, 
ev
, *
d©a
);

5272 
mg_mq‰_£ssiÚ
 *
mg_mq‰_Ãxt
(
mg_mq‰_brok”
 *
brk
,

5273 
mg_mq‰_£ssiÚ
 *
s
);

5275 #ifdeà
__ılu¥lus


5281 #ifdeà
MG_MODULE_LINES


5293 #iâdeà
CS_MONGOOSE_SRC_DNS_H_


5294 
	#CS_MONGOOSE_SRC_DNS_H_


	)

5298 #ifdeà
__ılu¥lus


5302 
	#MG_DNS_A_RECORD
 0x01

	)

5303 
	#MG_DNS_CNAME_RECORD
 0x05

	)

5304 
	#MG_DNS_PTR_RECORD
 0x0ø

	)

5305 
	#MG_DNS_TXT_RECORD
 0x10

	)

5306 
	#MG_DNS_AAAA_RECORD
 0x1ø

	)

5307 
	#MG_DNS_SRV_RECORD
 0x21

	)

5308 
	#MG_DNS_MX_RECORD
 0x0à

	)

5310 
	#MG_MAX_DNS_QUESTIONS
 32

	)

5311 
	#MG_MAX_DNS_ANSWERS
 32

	)

5313 
	#MG_DNS_MESSAGE
 100

	)

5315 
	emg_dns_»sourû_»cÜd_kšd
 {

5316 
MG_DNS_INVALID_RECORD
 = 0,

5317 
MG_DNS_QUESTION
,

5318 
MG_DNS_ANSWER


5322 
	smg_dns_»sourû_»cÜd
 {

5323 
mg_¡r
 
Çme
;

5324 
¹y³
;

5325 
rşass
;

5326 
‰l
;

5327 
mg_dns_»sourû_»cÜd_kšd
 
kšd
;

5328 
mg_¡r
 
rd©a
;

5332 
	smg_dns_mes§ge
 {

5333 
mg_¡r
 
pkt
;

5334 
ušt16_t
 
æags
;

5335 
ušt16_t
 
Œª§ùiÚ_id
;

5336 
num_que¡iÚs
;

5337 
num_ªsw”s
;

5338 
mg_dns_»sourû_»cÜd
 
que¡iÚs
[
MG_MAX_DNS_QUESTIONS
];

5339 
mg_dns_»sourû_»cÜd
 
ªsw”s
[
MG_MAX_DNS_ANSWERS
];

5342 
mg_dns_»sourû_»cÜd
 *
mg_dns_Ãxt_»cÜd
(

5343 
mg_dns_mes§ge
 *
msg
, 
qu”y
, 
mg_dns_»sourû_»cÜd
 *
´ev
);

5356 
mg_dns_·r£_»cÜd_d©a
(
mg_dns_mes§ge
 *
msg
,

5357 
mg_dns_»sourû_»cÜd
 *
¼
, *
d©a
,

5358 
size_t
 
d©a_Ën
);

5363 
mg_£nd_dns_qu”y
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
Çme
,

5364 
qu”y_ty³
);

5371 
mg_dns_š£¹_h—d”
(
mbuf
 *
io
, 
size_t
 
pos
,

5372 
mg_dns_mes§ge
 *
msg
);

5382 
mg_dns_cİy_que¡iÚs
(
mbuf
 *
io
, 
mg_dns_mes§ge
 *
msg
);

5400 
mg_dns_’code_»cÜd
(
mbuf
 *
io
, 
mg_dns_»sourû_»cÜd
 *
¼
,

5401 cÚ¡ *
Çme
, 
size_t
 
Æ’
, cÚ¡ *
rd©a
,

5402 
size_t
 
¾’
);

5407 
mg_dns_’code_Çme
(
mbuf
 *
io
, cÚ¡ *
Çme
, 
size_t
 
Ën
);

5410 
mg_·r£_dns
(cÚ¡ *
buf
, 
Ën
, 
mg_dns_mes§ge
 *
msg
);

5425 
size_t
 
mg_dns_uncom´ess_Çme
(
mg_dns_mes§ge
 *
msg
, 
mg_¡r
 *
Çme
,

5426 *
d¡
, 
d¡_Ën
);

5440 
mg_£t_´ÙocŞ_dns
(
mg_cÚÃùiÚ
 *
nc
);

5442 #ifdeà
__ılu¥lus


5446 #ifdeà
MG_MODULE_LINES


5460 #iâdeà
CS_MONGOOSE_SRC_DNS_SERVER_H_


5461 
	#CS_MONGOOSE_SRC_DNS_SERVER_H_


	)

5463 #ià
MG_ENABLE_DNS_SERVER


5467 #ifdeà
__ılu¥lus


5471 
	#MG_DNS_SERVER_DEFAULT_TTL
 3600

	)

5473 
	smg_dns_»¶y
 {

5474 
mg_dns_mes§ge
 *
msg
;

5475 
mbuf
 *
io
;

5476 
size_t
 
¡¬t
;

5507 
mg_dns_»¶y
 
mg_dns_ü—‹_»¶y
(
mbuf
 *
io
,

5508 
mg_dns_mes§ge
 *
msg
);

5518 
mg_dns_»¶y_»cÜd
(
mg_dns_»¶y
 *
»¶y
,

5519 
mg_dns_»sourû_»cÜd
 *
que¡iÚ
,

5520 cÚ¡ *
Çme
, 
¹y³
, 
‰l
, cÚ¡ *
rd©a
,

5521 
size_t
 
rd©a_Ën
);

5535 
mg_dns_£nd_»¶y
(
mg_cÚÃùiÚ
 *
nc
, 
mg_dns_»¶y
 *
r
);

5537 #ifdeà
__ılu¥lus


5543 #ifdeà
MG_MODULE_LINES


5555 #iâdeà
CS_MONGOOSE_SRC_RESOLV_H_


5556 
	#CS_MONGOOSE_SRC_RESOLV_H_


	)

5560 #ifdeà
__ılu¥lus


5564 
	emg_»sŞve_”r
 {

5565 
MG_RESOLVE_OK
 = 0,

5566 
MG_RESOLVE_NO_ANSWERS
 = 1,

5567 
MG_RESOLVE_EXCEEDED_RETRY_COUNT
 = 2,

5568 
MG_RESOLVE_TIMEOUT
 = 3

5571 (*
mg_»sŞve_ÿÎback_t
)(
	tmg_dns_mes§ge
 *
	tdns_mes§ge
,

5572 *
	tu£r_d©a
, 
	tmg_»sŞve_”r
);

5575 
	smg_»sŞve_async_İts
 {

5576 cÚ¡ *
Çme£rv”_u¾
;

5577 
max_»Œ›s
;

5578 
timeout
;

5579 
acû±_l™”®
;

5580 
Úly_l™”®
;

5581 
mg_cÚÃùiÚ
 **
dns_cÚn
;

5585 
mg_»sŞve_async
(
mg_mgr
 *
mgr
, cÚ¡ *
Çme
, 
qu”y
,

5586 
mg_»sŞve_ÿÎback_t
 
cb
, *
d©a
);

5609 
mg_»sŞve_async_İt
(
mg_mgr
 *
mgr
, cÚ¡ *
Çme
, 
qu”y
,

5610 
mg_»sŞve_ÿÎback_t
 
cb
, *
d©a
,

5611 
mg_»sŞve_async_İts
 
İts
);

5618 
mg_»sŞve_äom_ho¡s_fe
(cÚ¡ *
ho¡
, 
sock‘_add»ss
 *
u§
);

5620 #ifdeà
__ılu¥lus


5624 #ifdeà
MG_MODULE_LINES


5658 #iâdeà
CS_MONGOOSE_SRC_COAP_H_


5659 
	#CS_MONGOOSE_SRC_COAP_H_


	)

5661 #ià
MG_ENABLE_COAP


5663 
	#MG_COAP_MSG_TYPE_FIELD
 0x2

	)

5664 
	#MG_COAP_CODE_CLASS_FIELD
 0x4

	)

5665 
	#MG_COAP_CODE_DETAIL_FIELD
 0x8

	)

5666 
	#MG_COAP_MSG_ID_FIELD
 0x10

	)

5667 
	#MG_COAP_TOKEN_FIELD
 0x20

	)

5668 
	#MG_COAP_OPTIOMG_FIELD
 0x40

	)

5669 
	#MG_COAP_PAYLOAD_FIELD
 0x80

	)

5671 
	#MG_COAP_ERROR
 0x10000

	)

5672 
	#MG_COAP_FORMAT_ERROR
 (
MG_COAP_ERROR
 | 0x20000)

	)

5673 
	#MG_COAP_IGNORE
 (
MG_COAP_ERROR
 | 0x40000)

	)

5674 
	#MG_COAP_NOT_ENOUGH_DATA
 (
MG_COAP_ERROR
 | 0x80000)

	)

5675 
	#MG_COAP_NETWORK_ERROR
 (
MG_COAP_ERROR
 | 0x100000)

	)

5677 
	#MG_COAP_MSG_CON
 0

	)

5678 
	#MG_COAP_MSG_NOC
 1

	)

5679 
	#MG_COAP_MSG_ACK
 2

	)

5680 
	#MG_COAP_MSG_RST
 3

	)

5681 
	#MG_COAP_MSG_MAX
 3

	)

5683 
	#MG_COAP_CODECLASS_REQUEST
 0

	)

5684 
	#MG_COAP_CODECLASS_RESP_OK
 2

	)

5685 
	#MG_COAP_CODECLASS_CLIENT_ERR
 4

	)

5686 
	#MG_COAP_CODECLASS_SRV_ERR
 5

	)

5688 
	#MG_COAP_EVENT_BASE
 300

	)

5689 
	#MG_EV_COAP_CON
 (
MG_COAP_EVENT_BASE
 + 
MG_COAP_MSG_CON
)

	)

5690 
	#MG_EV_COAP_NOC
 (
MG_COAP_EVENT_BASE
 + 
MG_COAP_MSG_NOC
)

	)

5691 
	#MG_EV_COAP_ACK
 (
MG_COAP_EVENT_BASE
 + 
MG_COAP_MSG_ACK
)

	)

5692 
	#MG_EV_COAP_RST
 (
MG_COAP_EVENT_BASE
 + 
MG_COAP_MSG_RST
)

	)

5699 
	smg_cßp_İtiÚ
 {

5700 
mg_cßp_İtiÚ
 *
Ãxt
;

5701 
ušt32_t
 
numb”
;

5702 
mg_¡r
 
v®ue
;

5706 
	smg_cßp_mes§ge
 {

5707 
ušt32_t
 
	gæags
;

5708 
ušt8_t
 
	gmsg_ty³
;

5709 
ušt8_t
 
	gcode_şass
;

5710 
ušt8_t
 
	gcode_d‘a
;

5711 
ušt16_t
 
	gmsg_id
;

5712 
mg_¡r
 
	gtok’
;

5713 
mg_cßp_İtiÚ
 *
	gİtiÚs
;

5714 
mg_¡r
 
	g·ylßd
;

5715 
mg_cßp_İtiÚ
 *
	gİtiomg_
;

5718 #ifdeà
__ılu¥lus


5723 
mg_£t_´ÙocŞ_cßp
(
mg_cÚÃùiÚ
 *
nc
);

5730 
mg_cßp_İtiÚ
 *
mg_cßp_add_İtiÚ
(
mg_cßp_mes§ge
 *
cm
,

5731 
ušt32_t
 
numb”
, *
v®ue
,

5732 
size_t
 
Ën
);

5738 
mg_cßp_ä“_İtiÚs
(
mg_cßp_mes§ge
 *
cm
);

5751 
ušt32_t
 
mg_cßp_£nd_mes§ge
(
mg_cÚÃùiÚ
 *
nc
,

5752 
mg_cßp_mes§ge
 *
cm
);

5759 
ušt32_t
 
mg_cßp_£nd_ack
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
msg_id
);

5776 
ušt32_t
 
mg_cßp_·r£
(
mbuf
 *
io
, 
mg_cßp_mes§ge
 *
cm
);

5783 
ušt32_t
 
mg_cßp_compo£
(
mg_cßp_mes§ge
 *
cm
, 
mbuf
 *
io
);

5785 #ifdeà
__ılu¥lus


5792 #ifdeà
MG_MODULE_LINES


5800 #iâdeà
CS_MONGOOSE_SRC_SNTP_H_


5801 
	#CS_MONGOOSE_SRC_SNTP_H_


	)

5803 #ià
MG_ENABLE_SNTP


5805 
	#MG_SNTP_EVENT_BASE
 500

	)

5811 
	#MG_SNTP_REPLY
 (
MG_SNTP_EVENT_BASE
 + 1)

	)

5814 
	#MG_SNTP_MALFORMED_REPLY
 (
MG_SNTP_EVENT_BASE
 + 2)

	)

5817 
	#MG_SNTP_FAILED
 (
MG_SNTP_EVENT_BASE
 + 3)

	)

5819 
	smg_¢_mes§ge
 {

5821 
kiss_of_d—th
;

5823 
time
;

5827 
mg_cÚÃùiÚ
 *
mg_¢_cÚÃù
(
mg_mgr
 *
mgr
,

5828 
mg_ev’t_hªdËr_t
 
ev’t_hªdËr
,

5829 cÚ¡ *
¢_£rv”_Çme
);

5832 
mg_¢_£nd_»que¡
(
mg_cÚÃùiÚ
 *
c
);

5841 
mg_cÚÃùiÚ
 *
mg_¢_g‘_time
(
mg_mgr
 *
mgr
,

5842 
mg_ev’t_hªdËr_t
 
ev’t_hªdËr
,

5843 cÚ¡ *
¢_£rv”_Çme
);

5849 #ifdeà
UNSAFE_COMPILE


5850 
	#sgx_´iv©e


	)

5851 
	#ä—d_´iv©e
 
ä—d


	)

5853 
size_t
 
ä—d_´iv©e
(
sgx_´iv©e
 *
±r
, size_ˆ
size
, size_ˆ
nmemb
, 
FILE
 *
¡»am
);

5857 
g‘_’üy±_Ëngth
(
sgx_´iv©e
 cÚ¡ *
t
, 
size_t
 
n
);

5858 
is_´iv©e_fe
(cÚ¡ * 
·th
);

5859 
’üy±
(* 
de¡
, 
sgx_´iv©e
 cÚ¡ *
¤c
, 
size_t
 
n
 );

	@Enclave/simplest_web_server.c

4 
	~"mÚgoo£.h
"

5 
	~<time.h
>

10 cÚ¡ *
	gs_h‰p_pÜt
 = "8000";

11 
mg_£rve_h‰p_İts
 
	gs_h‰p_£rv”_İts
;

13 
»adrdtsc
();

14 
š™_»adrdtsc
();

15 
miüoF»q
;

18 
¡¬t_couÁ”
;

19 
¡İ_couÁ”
;

22 
	$ev_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
, *
p
) {

23 ià(
ev
 =ğ
MG_EV_HTTP_REQUEST
) {

24 
	`mg_£rve_h‰p
(
nc
, (
h‰p_mes§ge
 *è
p
, 
s_h‰p_£rv”_İts
);

28 
	}
}

31 #ifdeà
UNSAFE_COMPILE


32 
public_h—p_š™
(, );

37 
	$maš
(
¬gc
, * 
¬gv
[]) {

38 #ifdeà
UNSAFE_COMPILE


39 
	`public_h—p_š™
(0x3000000000, 0x100000000-0x1000);

44 
	`´štf
("Entering main\n");

46 
mg_mgr
 
mgr
;

47 
mg_cÚÃùiÚ
 *
nc
;

49 
	`mg_mgr_š™
(&
mgr
, 
NULL
);

50 
	`´štf
("S¹šg web s”v” oÀpÜˆ%s\n", 
s_h‰p_pÜt
);

51 
nc
 = 
	`mg_bšd
(&
mgr
, 
s_h‰p_pÜt
, 
ev_hªdËr
);

52 ià(
nc
 =ğ
NULL
) {

53 
	`´štf
("Failedo create†istener\n");

58 
	`mg_£t_´ÙocŞ_h‰p_websock‘
(
nc
);

59 
s_h‰p_£rv”_İts
.
docum’t_roÙ
 = ".";

60 
s_h‰p_£rv”_İts
.
’abË_dœeùÜy_li¡šg
 = "yes";

63 
	`mg_mgr_pŞl
(&
mgr
, 1000);

67 
	`mg_mgr_ä“
(&
mgr
);

70 
	}
}

71 
	$sgx_maš
(
¬gc
, * 
¬gv
[]) {

72  
	`maš
(
¬gc
, 
¬gv
);

73 
	}
}

	@Include/user_types.h

28 #ifdeà
_MSC_VER


29 
	#memcıy
 
_memcıy


	)

32 
	#LOOPS_PER_THREAD
 500

	)

34 *
	tbufãr_t
;

35 
	t¬¿y_t
[10];

	@support_segment.c

1 
	~<¡dio.h
>

2 
	~<wšdows.h
>

5 
	#COMMIT_AT_ONCE
 1

	)

7 #ifdeà
DEBUG


8 
	~<as£¹.h
>

10 
	#as£¹
(...)

	)

13 
	#EXPORT
 
	`__deş¥ec
(
dÎexpÜt
)

	)

16 #ifdeà
AS_MALLOC


17 
	#public_m®loc
 
m®loc


	)

18 
	#public_ä“
 
ä“


	)

19 
	#public_ÿÎoc
 
ÿÎoc


	)

20 
	#public_»®loc
 
»®loc


	)

24 
HANDLE
 
	gpublic_h—p
;

25 
HANDLE
 
	g´iv©e_h—p
;

28 * (*
	tRC»©eH—p_t
)(, *, 
	tsize_t
, size_t, *, *);

29 * (*
	tRAÎoÿ‹H—p_t
)(*, , 
	tsize_t
);

30 (*
	tRF»eH—p_t
)(*, , *);

31 * (*
	tRReAÎoÿ‹H—p_t
è(*, , *, 
	tsize_t
);

32 
	$size_t
 (*
	tRSizeH—p_t
) (*, , *);

36 
RAÎoÿ‹H—p_t
 
RAÎoÿ‹H—p
;

37 
RF»eH—p_t
 
RF»eH—p
;

38 
RReAÎoÿ‹H—p_t
 
RReAÎoÿ‹H—p
;

39 
RSizeH—p_t
 
RSizeH—p
;

42 * 
bad_add»ss
 = (*)0x304852E08C;

44 
	$is_bad
(* 
±r
, 
size
){

45 ià(
bad_add»ss
 >ğ
±r
 && bad_add»s < (
size
 +…tr))

49 
	}
}

51 
	#GB1
 0x40000000ULL

	)

52 
big_h—p_š™
(* 
ba£
, 
size_t
 
size
);

53 * 
big_h—p_m®loc
(
size_t
 
size
);

54 * 
big_h—p_ÿÎoc
(
size_t
 
n
, size_ˆ
s
);

55 
big_h—p_ä“
(* 
±r
);

56 * 
big_h—p_»®loc
(* 
±r
, 
size_t
 
size
);

57 
size_t
 
big_h—p_size
(* 
±r
);

58 * 
	gbig_h—p_ba£
 = 
NULL
;

59 * 
	gbig_h—p_¡¬t
 = 
NULL
;

60 
size_t
 
	gbig_h—p_num_·ges
 = 0;

61 * 
	gbig_h—p_md_ba£
 = 
NULL
;

63 
EXPORT
 
	$public_h—p_š™
(* 
ba£
, 
size
) {

64 
	`big_h—p_š™
(
ba£
, 2*
GB1
);

65 
ba£
 +ğ2*
GB1
;

66 
size
 -ğ2*
GB1
;

67 
HMODULE
 
hNtdÎ
 = 
NULL
;

68 
hNtdÎ
 = 
	`G‘ModuËHªdË
("ntdll");

69 
RC»©eH—p_t
 
RC»©eH—p
 = (RC»©eH—p_t)
	`G‘ProcAdd»ss
(
hNtdÎ
, "RtlCreateHeap");

71 
RAÎoÿ‹H—p
 = (
RAÎoÿ‹H—p_t
)
	`G‘ProcAdd»ss
(
hNtdÎ
, "RtlAllocateHeap");

72 
RF»eH—p
 = (
RF»eH—p_t
)
	`G‘ProcAdd»ss
(
hNtdÎ
, "RtlFreeHeap");

73 
RReAÎoÿ‹H—p
 = (
RReAÎoÿ‹H—p_t
)
	`G‘ProcAdd»ss
(
hNtdÎ
, "RtlReAllocateHeap");

74 
RSizeH—p
 = (
RSizeH—p_t
)
	`G‘ProcAdd»ss
(
hNtdÎ
, "RtlSizeHeap");

76 
	`Vœtu®AÎoc
(
ba£
, 
size
, 
MEM_RESERVE
, 
PAGE_READWRITE
);

77 
	`´štf
("Publiøh—°»£rved‡ˆ(%p, %p)\n", 
ba£
, ba£ + 
size
);

78 
public_h—p
 = 
	`RC»©eH—p
(0, (*)
ba£
, 
size
, 0, 
NULL
, NULL);

80 if(!
public_h—p
){

81 
	`´štf
("Public heap creation failed\n");

82 
	`ex™
(-1);

84 
	}
}

85 
EXPORT
 
	$´iv©e_h—p_š™
(* 
ba£
, 
size
) {

86 
HMODULE
 
hNtdÎ
 = 
NULL
;

87 
hNtdÎ
 = 
	`G‘ModuËHªdË
("ntdll");

88 
RC»©eH—p_t
 
RC»©eH—p
 = (RC»©eH—p_t)
	`G‘ProcAdd»ss
(
hNtdÎ
, "RtlCreateHeap");

89 
	`Vœtu®AÎoc
(
ba£
, 
size
, 
MEM_RESERVE
, 
PAGE_READWRITE
);

90 
´iv©e_h—p
 = 
	`RC»©eH—p
(0, (*)
ba£
, 
size
, 4096 * 16, 
NULL
, NULL);

91 if(!
´iv©e_h—p
){

92 
	`´štf
("Private heap creation failed\n");

93 
	`ex™
(-1);

95 
	}
}

98 * 
	$´iv©e_m®loc
(
n
){

99  
	`RAÎoÿ‹H—p
(
´iv©e_h—p
, 0, 
n
);

100 
	}
}

101 * 
	$public_m®loc
(
n
){

103 if(
n
 >= 0x7f000){

104  
	`big_h—p_m®loc
(
n
);

106 *
t
 = 
	`RAÎoÿ‹H—p
(
public_h—p
, 0, 
n
);

114  
t
;

115 
	}
}

118 
	$public_ä“
(* 
±r
){

119 if((*)
±r
 >ğ
big_h—p_¡¬t
 && (*íŒ < (big_h—p_¡¬ˆ+ 2*
GB1
)){

120 
	`big_h—p_ä“
(
±r
);

133 
	`RF»eH—p
(
public_h—p
, 0, 
±r
);

135 
	}
}

136 
	$´iv©e_ä“
(* 
±r
){

137 
	`RF»eH—p
(
´iv©e_h—p
, 0, 
±r
);

138 
	}
}

140 * 
	$public_ÿÎoc
(
n
, 
s
){

141 if(
n
 * 
s
 >= 0x7f000){

142  
	`big_h—p_ÿÎoc
(
n
, 
s
);

144 *
t
 = 
	`RAÎoÿ‹H—p
(
public_h—p
, 0x8, 
n
*
s
);

157  
t
;

158 
	}
}

160 * 
	$public_»®loc
(* 
±r
, 
size
){

161 ià(
±r
 =ğ
NULL
)

162  
	`public_m®loc
(
size
);

169 ifĞ(*)
±r
 >ğ(
big_h—p_¡¬t
 + 2*
GB1
è&& 
size
 < 0x7f000){

170 
n
 = 
	`RSizeH—p
(
public_h—p
, 0, 
±r
);

175 * 
t
 = 
	`RReAÎoÿ‹H—p
(
public_h—p
, 0, 
±r
, 
size
);

183  
t
;

187 if(((*)
±r
 >ğ
big_h—p_¡¬t
 && (*íŒ < (big_h—p_¡¬ˆ+ 2*
GB1
)è&& 
size
 >= 0x7f000){

188  
	`big_h—p_»®loc
(
±r
, 
size
);

190 
size_t
 
Şd_size
;

192 ià((*)
±r
 >ğ
big_h—p_¡¬t
 && (*íŒ < (big_h—p_¡¬ˆ+ 2*
GB1
)){

193 
Şd_size
 = 
	`big_h—p_size
(
±r
);

195 
Şd_size
 = 
	`RSizeH—p
(
public_h—p
, 0, 
±r
);

198 *
t
 = 
	`public_m®loc
(
size
);

199 ià(!
t
){

200 
	`´štf
("R—Îoøçed w™h sizğ%Îu\n", 
size
);

201 
	`ex™
(-1);

203 
size_t
 
cİy_size
 = 
Şd_size
<
size
?old_size:size;

204 
	`memıy
(
t
, 
±r
, 
cİy_size
);

205 
	`public_ä“
(
±r
);

206  
t
;

208 
	}
}

218 
	#PAGE_SIZE
 0x1000

	)

220 
size_t
 
	$big_h—p_size
(* 
±r
){

221 
»t
;

222 
i
;

223 
a_šdex
 = (()
±r
 - ()
big_h—p_ba£
)/
PAGE_SIZE
;

224 
	`as£¹
(
a_šdex
 < 
big_h—p_num_·ges
);

225 
»t
 = 
big_h—p_md_ba£
[
a_šdex
];

226 
	`as£¹
(
»t
 && (ret % 4096) == 0);

227 
i
 = 1 ; i < 
»t
/4096; i++)

228 
	`as£¹
(
big_h—p_md_ba£
[
a_šdex
+
i
] == 1);

229  
»t
;

230 
	}
}

233 
	$big_h—p_š™
(* 
ba£
, 
size_t
 
size
) {

234 if(
size
 % 
PAGE_SIZE
 != 0){

235 
	`´štf
("Wrong…arameterso big_heap_init, quiting\n");

236 
	`ex™
(-1);

238 if((è
ba£
 % 
PAGE_SIZE
 != 0){

239 
	`´štf
("Wrong…arameterso big_heap_init, quiting\n");

240 
	`ex™
(-1);

242 #iâdeà
COMMIT_AT_ONCE


243 if(
ba£
!=
	`Vœtu®AÎoc
(ba£, 
size
, 
MEM_RESERVE
, 
PAGE_READWRITE
)){

245 if(
ba£
!=
	`Vœtu®AÎoc
(ba£, 
size
, 
MEM_RESERVE
 | 
MEM_COMMIT
, 
PAGE_READWRITE
)){

247 
	`´štf
("Virtual‡lloc failed in big_heap_init\n");

248 
	`ex™
(-1);

250 
big_h—p_num_·ges
 = 
size
 / 
PAGE_SIZE
;

251 
num_md_·ges
 = (
big_h—p_num_·ges
 * 4 + 
PAGE_SIZE
) / PAGE_SIZE;

252 
big_h—p_num_·ges
 = big_h—p_num_·ge - 
num_md_·ges
;

253 
big_h—p_md_ba£
 = (*)
ba£
;

254 
big_h—p_¡¬t
 = 
ba£
;

255 
big_h—p_ba£
 = 
ba£
 + 
num_md_·ges
 * 
PAGE_SIZE
;

256 #iâdeà
COMMIT_AT_ONCE


257 if(
big_h—p_md_ba£
 !ğ
	`Vœtu®AÎoc
(big_h—p_md_ba£, 
num_md_·ges
 * 
PAGE_SIZE
, 
MEM_COMMIT
, 
PAGE_READWRITE
)){

258 
	`´štf
("Virtual‡lloc 2 failed in big_heap_init\n");

259 
	`ex™
(-1);

262 
	`mem£t
(
big_h—p_md_ba£
, 0, 
num_md_·ges
 * 
PAGE_SIZE
);

263 
	`´štf
("Big h—°š™Ÿlized‡ˆ(%p, %p)\n", 
big_h—p_ba£
, big_h—p_ba£+
size
);

264 
	}
}

267 * 
	$big_h—p_m®loc
(
size_t
 
size
){

270 ià(
size
 == 0)

271  
NULL
;

273 
num_·ges
 = 
size
 / 
PAGE_SIZE
;

274 if(
size
 % 
PAGE_SIZE
 != 0){

275 
num_·ges
 += 1;

279 
i
, 
j
;

280 
¡»ak
 = 0;

281 
i
 = 0; i < 
big_h—p_num_·ges
; i++){

282 
	`as£¹
(
big_h—p_md_ba£
[
i
] == 0 || big_heap_md_base[i] == 1 || (big_heap_md_base[i]%4096) == 0);

283 if(
big_h—p_md_ba£
[
i
] == 0)

284 
¡»ak
++;

286 
¡»ak
 = 0;

287 ià(
¡»ak
 =ğ
num_·ges
){

289 
a_šdex
 = 
i
 - (
¡»ak
 - 1);

290 * 
®loÿtiÚ_add»ss
 = 
big_h—p_ba£
 + (
PAGE_SIZE
 * 
a_šdex
);

291 
big_h—p_md_ba£
[
a_šdex
] = (
num_·ges
 * 
PAGE_SIZE
);

292 
j
 = 1; j < 
num_·ges
; j++)

294 
big_h—p_md_ba£
[
a_šdex
 + 
j
] = 1;

300 #iâdeà
COMMIT_AT_ONCE


301 if(
®loÿtiÚ_add»ss
 !ğ
	`Vœtu®AÎoc
×ÎoÿtiÚ_add»ss, 
num_·ges
 * 
PAGE_SIZE
, 
MEM_COMMIT
, 
PAGE_READWRITE
)){

302 
	`´štf
("Virtual Alloc failed in big_heap_malloc\n");

303 
	`ex™
(-1);

306  
®loÿtiÚ_add»ss
;

309 
	`´štf
("Big‡ÎoÿtÜ faed w™h sizğ%zx(%d), ba£_md = %p\n", 
size
, 
num_·ges
, 
big_h—p_md_ba£
);

310 
	`ex™
(-1);

311  
NULL
;

312 
	}
}

315 * 
	$big_h—p_ÿÎoc
(
size_t
 
n
, size_ˆ
s
){

320 *
t
 = 
	`big_h—p_m®loc
(
n
*
s
);

321 if(
t
 =ğ
NULL
){

322 
	`´štf
("Big callocator failed\n");

323 
	`ex™
(-1);

324  
NULL
;

327 
	`mem£t
(
t
, 0, 
n
*
s
);

328  
t
;

329 
	}
}

331 
	$big_h—p_ä“
(* 
±r
){

333 ià(
±r
 == 0)

335 
a_šdex
 = (()
±r
 - ()
big_h—p_ba£
è/ 
PAGE_SIZE
;

336 
size_t
 
sz
 = 
	`big_h—p_size
(
±r
);

338 #iâdeà
COMMIT_AT_ONCE


339 if(!
	`Vœtu®F»e
(
±r
, 
sz
, 
MEM_DECOMMIT
)){

340 
	`´štf
("VirtualFree failed in big_heap_free\n");

341 
	`ex™
(-1);

344 
	`mem£t
(&
big_h—p_md_ba£
[
a_šdex
], 0, 
sz
/1024);

351 
	}
}

354 * 
	$big_h—p_»®loc
(* 
±r
, 
size_t
 
size
){

356 
size_t
 
Şd_size
 = 
	`big_h—p_size
(
±r
);

357 ià(
size
 < 
Şd_size
)

358 
Şd_size
 = 
size
;

359 *
t
 = 
	`big_h—p_m®loc
(
size
);

360 
	`memıy
(
t
, 
±r
, 
Şd_size
);

361 
	`big_h—p_ä“
(
±r
);

362  
t
;

372 
size_t
 
Şd_size
 = 
	`big_h—p_size
(
±r
);

373 
a_šdex
 = (()
±r
 - ()
big_h—p_ba£
è/ 
PAGE_SIZE
;

375 
num_·ges
 = 
size
 / 
PAGE_SIZE
;

376 if(
size
 % 
PAGE_SIZE
 != 0){

377 
num_·ges
 += 1;

379 
size
 = 
num_·ges
 * 
PAGE_SIZE
;

382 ià(
Şd_size
 =ğ
size
)

383  
±r
;

384 
Şd_num_·ges
 = 
Şd_size
 / 
PAGE_SIZE
;

386 ià(
size
 > 
Şd_size
) {

387 
Ãw_·ges_»q
 = 
num_·ges
 - 
Şd_num_·ges
;

388 
a_šdex
 +ğ
Şd_num_·ges
;

389 
æag
 = 1;

390 
i
 = 0;

391 
i
=0;i<
Ãw_·ges_»q
; i++){

392 ià(
a_šdex
+
i
 >ğ
big_h—p_num_·ges
){

395 
æag
 = 0;

398 if(
big_h—p_md_ba£
[
a_šdex
+
i
] != 0){

399 
	`as£¹
(
big_h—p_md_ba£
[
a_šdex
+
i
] % 4096 == 0);

400 
æag
 = 0;

404 if(
æag
){

405 
i
 = 0; i < 
Ãw_·ges_»q
; i++)

406 
big_h—p_md_ba£
[
a_šdex
+
i
] = 1;

407 
a_šdex
 = (()
±r
 - ()
big_h—p_ba£
è/ 
PAGE_SIZE
;

408 *
exŒa_¡¬t
 = 
±r
 + 
Şd_size
;

409 #iâdeà
COMMIT_AT_ONCE


410 if(
exŒa_¡¬t
 !ğ
	`Vœtu®AÎoc
ÓxŒa_¡¬t, 
Ãw_·ges_»q
 * 
PAGE_SIZE
, 
MEM_COMMIT
, 
PAGE_READWRITE
)){

411 
	`´štf
("Virtual Alloc failed in big_heap_realloc\n");

412 
	`ex™
(-1);

415 
big_h—p_md_ba£
[
a_šdex
] = 
size
;

416  
±r
;

418 *
t
 = 
	`big_h—p_m®loc
(
size
);

419 
	`memıy
(
t
, 
±r
, 
Şd_size
);

420 
	`big_h—p_ä“
(
±r
);

421  
t
;

424 
num_·ges_»move
 = 
Şd_num_·ges
 - 
num_·ges
;

425 *(*)(
big_h—p_md_ba£
 + 
a_šdex
 * 4èğ
size
;

426 
big_h—p_md_ba£
[
a_šdex
] = 
size
;

427 * 
exŒa_¡¬t
 = 
±r
 + 
size
;

428 #iâdeà
COMMIT_AT_ONCE


429 if(!
	`Vœtu®F»e
(
exŒa_¡¬t
, 
num_·ges_»move
*
PAGE_SIZE
, 
MEM_DECOMMIT
)){

430 
	`´štf
("Virtual Free failed in big_heap_realloc\n");

431 
	`ex™
(-1);

434 
	`mem£t
(&
big_h—p_md_ba£
[
a_šdex
 + 
num_·ges
], 0, 
num_·ges_»move
 * 4);

435  
±r
;

437 
	`´štf
("Reached†ast of big_heap_realloc, shouldn't„each\n");

438 
	`ex™
(-1);

441 
	}
}

	@
1
.
0
33
786
App/App.cpp
App/App.h
App/Edger8rSyntax/Arrays.cpp
App/Edger8rSyntax/Functions.cpp
App/Edger8rSyntax/Pointers.cpp
App/Edger8rSyntax/Types.cpp
App/Enclave_u.c
App/Enclave_u.h
App/TrustedLibrary/Libc.cpp
App/TrustedLibrary/Libcxx.cpp
App/TrustedLibrary/Thread.cpp
App/functions.h
App/includes.h
Enclave/Edger8rSyntax/Arrays.cpp
Enclave/Edger8rSyntax/Functions.cpp
Enclave/Edger8rSyntax/Pointers.cpp
Enclave/Edger8rSyntax/Types.cpp
Enclave/Enclave.cpp
Enclave/Enclave.h
Enclave/Enclave_t.c
Enclave/Enclave_t.h
Enclave/TrustedLibrary/Libc.cpp
Enclave/TrustedLibrary/Libcxx.cpp
Enclave/TrustedLibrary/Thread.cpp
Enclave/copy_globals.c
Enclave/hello.c
Enclave/library.c
Enclave/main.c
Enclave/mongoose.c
Enclave/mongoose.h
Enclave/simplest_web_server.c
Include/user_types.h
support_segment.c
