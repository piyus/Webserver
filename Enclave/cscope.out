cscope 15 $HOME\Desktop\INTEL\src\Webserver\Enclave"               0000546819
	@Edger8rSyntax/Arrays.cpp

27 
	~"sgx_Œts.h
"

28 
	~"../Enşave.h
"

29 
	~"Enşave_t.h
"

34 
	$eÿÎ_¬¿y_u£r_check
(
¬r
[4])

36 ià(
	`sgx_is_outside_’şave
(
¬r
, 4 * ()) != 1)

37 
	`abÜt
();

39 
i
 = 0; i < 4; i++) {

40 
	`as£¹
(
¬r
[
i
] == i);

41 
¬r
[
i
] = 3 - i;

43 
	}
}

49 
	$eÿÎ_¬¿y_š
(
¬r
[4])

51 
i
 = 0; i < 4; i++) {

52 
	`as£¹
(
¬r
[
i
] == i);

53 
¬r
[
i
] = (3 - i);

55 
	}
}

61 
	$eÿÎ_¬¿y_out
(
¬r
[4])

63 
i
 = 0; i < 4; i++) {

65 
	`as£¹
(
¬r
[
i
] == 0);

66 
¬r
[
i
] = (3 - i);

68 
	}
}

74 
	$eÿÎ_¬¿y_š_out
(
¬r
[4])

76 
i
 = 0; i < 4; i++) {

77 
	`as£¹
(
¬r
[
i
] == i);

78 
¬r
[
i
] = (3 - i);

80 
	}
}

85 
	$eÿÎ_¬¿y_i§ry
(
¬¿y_t
 
¬r
)

87 ià(
	`sgx_is_outside_’şave
(
¬r
, (
¬¿y_t
)) != 1)

88 
	`abÜt
();

90 
n
 = (
¬¿y_t
)/(
¬r
[0]);

91 
i
 = 0; i < 
n
; i++) {

92 
	`as£¹
(
¬r
[
i
] == i);

93 
¬r
[
i
] = (
n
 - 1 - i);

95 
	}
}

	@Edger8rSyntax/Functions.cpp

28 
	~<¡ršg.h
>

29 
	~<¡dio.h
>

31 
	~"../Enşave.h
"

32 
	~"Enşave_t.h
"

37 
	$eÿÎ_funùiÚ_ÿÎšg_cÚvs
()

39 
sgx_¡©us_t
 
»t
 = 
SGX_ERROR_UNEXPECTED
;

41 
s1
[] = "1234567890";

42 
s2
[] = "0987654321";

44 
buf
[
BUFSIZ
] = {'\0'};

45 
	`memıy
(
buf
, 
s1
, 
	`¡¾’
(s1));

47 
»t
 = 
	`memcıy
(
NULL
, 
s1
, 
s2
, '\0', 
	`¡¾’
(s1));

49 ià(
»t
 !ğ
SGX_SUCCESS
)

50 
	`abÜt
();

51 
	`as£¹
(
	`memcmp
(
s1
, 
s2
, 
	`¡¾’
(s1)) == 0);

54 
	}
}

59 
	$eÿÎ_funùiÚ_public
()

61 
sgx_¡©us_t
 
»t
 = 
SGX_ERROR_UNEXPECTED
;

63 
»t
 = 
	`oÿÎ_funùiÚ_®low
();

64 ià(
»t
 !ğ
SGX_SUCCESS
)

65 
	`abÜt
();

68 
	}
}

73 
	$eÿÎ_funùiÚ_´iv©e
()

76 
	}
}

	@Edger8rSyntax/Pointers.cpp

28 
	~<sys/ty³s.h
>

29 
	~<¡ršg.h
>

31 
	~"sgx_Œts.h
"

32 
	~"../Enşave.h
"

33 
	~"Enşave_t.h
"

38 
št32_t
 
	$checksum_š‹º®
(*
buf
, 
size_t
 
couÁ
)

40 
št32_t
 
sum
 = 0;

41 
št16_t
 *
±r
 = (št16_ˆ*)
buf
;

44 
couÁ
 > 1) {

45 
sum
 = sum + *
±r
++;

46 
couÁ
 = count - 2;

50 ià(
couÁ
 > 0)

51 
sum
 = sum + *((*)
±r
);

53  ~
sum
;

54 
	}
}

59 
size_t
 
	$eÿÎ_poš‹r_u£r_check
(*
v®
, 
size_t
 
sz
)

62 ià(
	`sgx_is_outside_’şave
(
v®
, 
sz
) != 1)

63 
	`abÜt
();

65 
tmp
[100] = {0};

66 
size_t
 
Ën
 = 
sz
>100?100:sz;

70 
	`memıy
(
tmp
, 
v®
, 
Ën
);

72 
št32_t
 
sum
 = 
	`checksum_š‹º®
((*)
tmp
, 
Ën
);

73 
	`´štf
("Checksum(0x%p, %zu) = 0x%x\n",

74 
v®
, 
Ën
, 
sum
);

77 
	`memıy
(
v®
, "SGX_SUCCESS", 
Ën
>12?12:len);

79  
Ën
;

80 
	}
}

86 
	$eÿÎ_poš‹r_š
(*
v®
)

88 ià(
	`sgx_is_w™hš_’şave
(
v®
, ()) != 1)

89 
	`abÜt
();

90 *
v®
 = 1234;

91 
	}
}

96 
	$eÿÎ_poš‹r_out
(*
v®
)

98 ià(
	`sgx_is_w™hš_’şave
(
v®
, ()) != 1)

99 
	`abÜt
();

100 
	`as£¹
(*
v®
 == 0);

101 *
v®
 = 1234;

102 
	}
}

107 
	$eÿÎ_poš‹r_š_out
(*
v®
)

109 ià(
	`sgx_is_w™hš_’şave
(
v®
, ()) != 1)

110 
	`abÜt
();

111 *
v®
 = 1234;

112 
	}
}

117 
	$oÿÎ_poš‹r_©Œ
()

119 
sgx_¡©us_t
 
»t
 = 
SGX_ERROR_UNEXPECTED
;

121 
v®
 = 0;

122 
»t
 = 
	`oÿÎ_poš‹r_u£r_check
(&
v®
);

123 ià(
»t
 !ğ
SGX_SUCCESS
)

124 
	`abÜt
();

126 
v®
 = 0;

127 
»t
 = 
	`oÿÎ_poš‹r_š
(&
v®
);

128 ià(
»t
 !ğ
SGX_SUCCESS
)

129 
	`abÜt
();

130 
	`as£¹
(
v®
 == 0);

132 
v®
 = 0;

133 
»t
 = 
	`oÿÎ_poš‹r_out
(&
v®
);

134 ià(
»t
 !ğ
SGX_SUCCESS
)

135 
	`abÜt
();

136 
	`as£¹
(
v®
 == 1234);

138 
v®
 = 0;

139 
»t
 = 
	`oÿÎ_poš‹r_š_out
(&
v®
);

140 ià(
»t
 !ğ
SGX_SUCCESS
)

141 
	`abÜt
();

142 
	`as£¹
(
v®
 == 1234);

145 
	}
}

150 
	$eÿÎ_poš‹r_¡ršg
(*
¡r
)

152 
	`¡ºıy
(
¡r
, "0987654321", 
	`¡¾’
(str));

153 
	}
}

158 
	$eÿÎ_poš‹r_¡ršg_cÚ¡
(cÚ¡ *
¡r
)

160 * 
‹mp
 = 
Ãw
 [
	`¡¾’
(
¡r
)];

161 
	`¡ºıy
(
‹mp
, 
¡r
, 
	`¡¾’
(str));

162 
d–‘e
 []
‹mp
;

163 
	}
}

168 
	$eÿÎ_poš‹r_size
(*
±r
, 
size_t
 
Ën
)

170 
	`¡ºıy
((*)
±r
, "0987654321", 
Ën
);

171 
	}
}

176 
	$eÿÎ_poš‹r_couÁ
(*
¬r
, 
út
)

178 
i
 = (
út
 - 1); i >= 0; i--)

179 
¬r
[
i
] = (
út
 - 1 - i);

180 
	}
}

186 
	$eÿÎ_poš‹r_i¥Œ_»adÚly
(
bufãr_t
 
buf
, 
size_t
 
Ën
)

188 
	`¡ºıy
((*)
buf
, "0987654321", 
Ën
);

189 
	}
}

194 
size_t
 
	$g‘_bufãr_Ën
(cÚ¡ * 
buf
)

196 ()
buf
;

198 
	}
}

203 
	$eÿÎ_poš‹r_sizefunc
(*
buf
)

205 *
tmp
 = (*)
buf
;

206 
i
 = 0; i < 10; i++) {

207 
	`as£¹
(
tmp
[
i
] == 0);

208 
tmp
[
i
] = i;

210 
	}
}

	@Edger8rSyntax/Types.cpp

28 
	~"sgx_Œts.h
"

29 
	~"../Enşave.h
"

30 
	~"Enşave_t.h
"

31 
	~<lim™s
>

32 
	~<cm©h
>

35 
	#UNUSED
(
v®
è()(v®)

	)

37 
	#ULP
 2

	)

40 
boŞ
 
	$®mo¡_equ®
(
x
, 
y
)

44  
¡d
::
	`abs
(
x
-
y
è<ğ¡d::
num”ic_lim™s
<>::
	`•sÚ
(è* std::abs(x+yè* 
ULP
;

45 
	}
}

48 
boŞ
 
	$®mo¡_equ®
(
x
, 
y
)

52  
¡d
::
	`abs
(
x
-
y
è<ğ¡d::
num”ic_lim™s
<>::
	`•sÚ
(è* std::abs(x+yè* 
ULP
;

53 
	}
}

58 
	$eÿÎ_ty³_ch¬
(
v®
)

60 
	`as£¹
(
v®
 == 0x12);

61 #iâdeà
DEBUG


62 
	`UNUSED
(
v®
);

64 
	}
}

69 
	$eÿÎ_ty³_št
(
v®
)

71 
	`as£¹
(
v®
 == 1234);

72 #iâdeà
DEBUG


73 
	`UNUSED
(
v®
);

75 
	}
}

80 
	$eÿÎ_ty³_æßt
(
v®
)

82 
	`as£¹
(
	`®mo¡_equ®
(
v®
, ()1234.0));

83 #iâdeà
DEBUG


84 
	`UNUSED
(
v®
);

86 
	}
}

91 
	$eÿÎ_ty³_doubË
(
v®
)

93 
	`as£¹
(
	`®mo¡_equ®
(
v®
, ()1234.5678));

94 #iâdeà
DEBUG


95 
	`UNUSED
(
v®
);

97 
	}
}

102 
	$eÿÎ_ty³_size_t
(
size_t
 
v®
)

104 
	`as£¹
(
v®
 =ğ(
size_t
)12345678);

105 #iâdeà
DEBUG


106 
	`UNUSED
(
v®
);

108 
	}
}

113 
	$eÿÎ_ty³_wch¬_t
(
wch¬_t
 
v®
)

115 
	`as£¹
(
v®
 =ğ(
wch¬_t
)0x1234);

116 #iâdeà
DEBUG


117 
	`UNUSED
(
v®
);

119 
	}
}

124 
	$eÿÎ_ty³_¡ruù
(
¡ruù_foo_t
 
v®
)

126 
	`as£¹
(
v®
.
¡ruù_foo_0
 == 1234);

127 
	`as£¹
(
v®
.
¡ruù_foo_1
 == 5678);

128 #iâdeà
DEBUG


129 
	`UNUSED
(
v®
);

131 
	}
}

138 
	$eÿÎ_ty³_’um_uniÚ
(
’um_foo_t
 
v®1
, 
uniÚ_foo_t
 *
v®2
)

140 ià(
	`sgx_is_outside_’şave
(
v®2
, (
uniÚ_foo_t
)) != 1)

141 
	`abÜt
();

142 
v®2
->
uniÚ_foo_0
 = 1;

143 
v®2
->
uniÚ_foo_1
 = 2;

144 
	`as£¹
(
v®1
 =ğ
ENUM_FOO_0
);

145 #iâdeà
DEBUG


146 
	`UNUSED
(
v®1
);

148 
	}
}

	@Enclave.cpp

26 
	~<¡d¬g.h
>

27 
	~<¡dio.h
>

29 
	~"Enşave.h
"

30 
	~"Enşave_t.h
"

46 
	$eÿÎ_maš
()

53 
	`oÿÎ_g’”ic
(100);

57 
	}
}

	@Enclave.h

26 #iâdeà
_ENCLAVE_H_


27 
	#_ENCLAVE_H_


	)

29 
	~<¡dlib.h
>

30 
	~<as£¹.h
>

32 #ià
defšed
(
__ılu¥lus
)

36 
´štf
(cÚ¡ *
fmt
, ...);

38 #ià
defšed
(
__ılu¥lus
)

	@Enclave_t.c

1 
	~"Enşave_t.h
"

3 
	~"sgx_Œts.h
"

5 
	~<”ºo.h
>

6 
	~<¡ršg.h
>

7 
	~<¡dlib.h
>

9 
	#CHECK_REF_POINTER
(
±r
, 
siz
) do { \

10 ià(!(
±r
è|| ! 
	`sgx_is_outside_’şave
(ÕŒ), (
siz
))) \

11  
SGX_ERROR_INVALID_PARAMETER
;\

12 } 0)

	)

14 
	#CHECK_UNIQUE_POINTER
(
±r
, 
siz
) do { \

15 ià((
±r
è&& ! 
	`sgx_is_outside_’şave
(ÕŒ), (
siz
))) \

16  
SGX_ERROR_INVALID_PARAMETER
;\

17 } 0)

	)

21 
	sms_eÿÎ_ty³_ch¬_t
 {

22 
	mms_v®
;

23 } 
	tms_eÿÎ_ty³_ch¬_t
;

25 
	sms_eÿÎ_ty³_št_t
 {

26 
	mms_v®
;

27 } 
	tms_eÿÎ_ty³_št_t
;

29 
	sms_eÿÎ_ty³_æßt_t
 {

30 
	mms_v®
;

31 } 
	tms_eÿÎ_ty³_æßt_t
;

33 
	sms_eÿÎ_ty³_doubË_t
 {

34 
	mms_v®
;

35 } 
	tms_eÿÎ_ty³_doubË_t
;

37 
	sms_eÿÎ_ty³_size_t_t
 {

38 
size_t
 
	mms_v®
;

39 } 
	tms_eÿÎ_ty³_size_t_t
;

41 
	sms_eÿÎ_ty³_wch¬_t_t
 {

42 
wch¬_t
 
	mms_v®
;

43 } 
	tms_eÿÎ_ty³_wch¬_t_t
;

45 
	sms_eÿÎ_ty³_¡ruù_t
 {

46 
¡ruù_foo_t
 
	mms_v®
;

47 } 
	tms_eÿÎ_ty³_¡ruù_t
;

49 
	sms_eÿÎ_ty³_’um_uniÚ_t
 {

50 
’um_foo_t
 
	mms_v®1
;

51 
uniÚ_foo_t
* 
	mms_v®2
;

52 } 
	tms_eÿÎ_ty³_’um_uniÚ_t
;

54 
	sms_eÿÎ_poš‹r_u£r_check_t
 {

55 
size_t
 
	mms_»tv®
;

56 * 
	mms_v®
;

57 
size_t
 
	mms_sz
;

58 } 
	tms_eÿÎ_poš‹r_u£r_check_t
;

60 
	sms_eÿÎ_poš‹r_š_t
 {

61 * 
	mms_v®
;

62 } 
	tms_eÿÎ_poš‹r_š_t
;

64 
	sms_eÿÎ_poš‹r_out_t
 {

65 * 
	mms_v®
;

66 } 
	tms_eÿÎ_poš‹r_out_t
;

68 
	sms_eÿÎ_poš‹r_š_out_t
 {

69 * 
	mms_v®
;

70 } 
	tms_eÿÎ_poš‹r_š_out_t
;

72 
	sms_eÿÎ_poš‹r_¡ršg_t
 {

73 * 
	mms_¡r
;

74 } 
	tms_eÿÎ_poš‹r_¡ršg_t
;

76 
	sms_eÿÎ_poš‹r_¡ršg_cÚ¡_t
 {

77 * 
	mms_¡r
;

78 } 
	tms_eÿÎ_poš‹r_¡ršg_cÚ¡_t
;

80 
	sms_eÿÎ_poš‹r_size_t
 {

81 * 
	mms_±r
;

82 
size_t
 
	mms_Ën
;

83 } 
	tms_eÿÎ_poš‹r_size_t
;

85 
	sms_eÿÎ_poš‹r_couÁ_t
 {

86 * 
	mms_¬r
;

87 
	mms_út
;

88 } 
	tms_eÿÎ_poš‹r_couÁ_t
;

90 
	sms_eÿÎ_poš‹r_i¥Œ_»adÚly_t
 {

91 
bufãr_t
 
	mms_buf
;

92 
size_t
 
	mms_Ën
;

93 } 
	tms_eÿÎ_poš‹r_i¥Œ_»adÚly_t
;

95 
	sms_eÿÎ_poš‹r_sizefunc_t
 {

96 * 
	mms_buf
;

97 } 
	tms_eÿÎ_poš‹r_sizefunc_t
;

100 
	sms_eÿÎ_¬¿y_u£r_check_t
 {

101 * 
	mms_¬r
;

102 } 
	tms_eÿÎ_¬¿y_u£r_check_t
;

104 
	sms_eÿÎ_¬¿y_š_t
 {

105 * 
	mms_¬r
;

106 } 
	tms_eÿÎ_¬¿y_š_t
;

108 
	sms_eÿÎ_¬¿y_out_t
 {

109 * 
	mms_¬r
;

110 } 
	tms_eÿÎ_¬¿y_out_t
;

112 
	sms_eÿÎ_¬¿y_š_out_t
 {

113 * 
	mms_¬r
;

114 } 
	tms_eÿÎ_¬¿y_š_out_t
;

116 
	sms_eÿÎ_¬¿y_i§ry_t
 {

117 
¬¿y_t
* 
	mms_¬r
;

118 } 
	tms_eÿÎ_¬¿y_i§ry_t
;

122 
	sms_eÿÎ_funùiÚ_´iv©e_t
 {

123 
	mms_»tv®
;

124 } 
	tms_eÿÎ_funùiÚ_´iv©e_t
;

127 
	sms_eÿÎ_sgx_ıuid_t
 {

128 * 
	mms_ıušfo
;

129 
	mms_Ëaf
;

130 } 
	tms_eÿÎ_sgx_ıuid_t
;

134 
	sms_eÿÎ_šü—£_couÁ”_t
 {

135 
size_t
 
	mms_»tv®
;

136 } 
	tms_eÿÎ_šü—£_couÁ”_t
;

140 
	sms_oÿÎ_´št_¡ršg_t
 {

141 * 
	mms_¡r
;

142 } 
	tms_oÿÎ_´št_¡ršg_t
;

144 
	sms_oÿÎ_g’”ic_t
 {

145 
	mms_»tv®
;

146 
	mms_±r
;

147 } 
	tms_oÿÎ_g’”ic_t
;

149 
	sms_oÿÎ_poš‹r_u£r_check_t
 {

150 * 
	mms_v®
;

151 } 
	tms_oÿÎ_poš‹r_u£r_check_t
;

153 
	sms_oÿÎ_poš‹r_š_t
 {

154 * 
	mms_v®
;

155 } 
	tms_oÿÎ_poš‹r_š_t
;

157 
	sms_oÿÎ_poš‹r_out_t
 {

158 * 
	mms_v®
;

159 } 
	tms_oÿÎ_poš‹r_out_t
;

161 
	sms_oÿÎ_poš‹r_š_out_t
 {

162 * 
	mms_v®
;

163 } 
	tms_oÿÎ_poš‹r_š_out_t
;

165 
	sms_memcıy_t
 {

166 * 
	mms_»tv®
;

167 * 
	mms_de¡
;

168 * 
	mms_¤c
;

169 
	mms_v®
;

170 
size_t
 
	mms_Ën
;

171 } 
	tms_memcıy_t
;

174 
	sms_sgx_oc_ıuidex_t
 {

175 * 
	mms_ıušfo
;

176 
	mms_Ëaf
;

177 
	mms_subËaf
;

178 } 
	tms_sgx_oc_ıuidex_t
;

180 
	sms_sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ_t
 {

181 
	mms_»tv®
;

182 * 
	mms_£lf
;

183 } 
	tms_sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ_t
;

185 
	sms_sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ_t
 {

186 
	mms_»tv®
;

187 * 
	mms_wa™”
;

188 } 
	tms_sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ_t
;

190 
	sms_sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ_t
 {

191 
	mms_»tv®
;

192 * 
	mms_wa™”
;

193 * 
	mms_£lf
;

194 } 
	tms_sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ_t
;

196 
	sms_sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ_t
 {

197 
	mms_»tv®
;

198 ** 
	mms_wa™”s
;

199 
size_t
 
	mms_tÙ®
;

200 } 
	tms_sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ_t
;

202 #ifdeà
_MSC_VER


203 #´agm¨
w¬nšg
(
push
)

204 #´agm¨
w¬nšg
(
di§bË
: 4127)

205 #´agm¨
w¬nšg
(
di§bË
: 4200)

208 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_maš
(* 
pms
)

210 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

211 ià(
pms
 !ğ
NULL
è 
SGX_ERROR_INVALID_PARAMETER
;

212 
	`eÿÎ_maš
();

213  
¡©us
;

214 
	}
}

216 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_ty³_ch¬
(* 
pms
)

218 
ms_eÿÎ_ty³_ch¬_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_ty³_ch¬_t*, 
pms
);

219 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

221 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_ty³_ch¬_t
));

223 
	`eÿÎ_ty³_ch¬
(
ms
->
ms_v®
);

226  
¡©us
;

227 
	}
}

229 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_ty³_št
(* 
pms
)

231 
ms_eÿÎ_ty³_št_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_ty³_št_t*, 
pms
);

232 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

234 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_ty³_št_t
));

236 
	`eÿÎ_ty³_št
(
ms
->
ms_v®
);

239  
¡©us
;

240 
	}
}

242 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_ty³_æßt
(* 
pms
)

244 
ms_eÿÎ_ty³_æßt_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_ty³_æßt_t*, 
pms
);

245 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

247 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_ty³_æßt_t
));

249 
	`eÿÎ_ty³_æßt
(
ms
->
ms_v®
);

252  
¡©us
;

253 
	}
}

255 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_ty³_doubË
(* 
pms
)

257 
ms_eÿÎ_ty³_doubË_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_ty³_doubË_t*, 
pms
);

258 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

260 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_ty³_doubË_t
));

262 
	`eÿÎ_ty³_doubË
(
ms
->
ms_v®
);

265  
¡©us
;

266 
	}
}

268 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_ty³_size_t
(* 
pms
)

270 
ms_eÿÎ_ty³_size_t_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_ty³_size_t_t*, 
pms
);

271 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

273 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_ty³_size_t_t
));

275 
	`eÿÎ_ty³_size_t
(
ms
->
ms_v®
);

278  
¡©us
;

279 
	}
}

281 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_ty³_wch¬_t
(* 
pms
)

283 
ms_eÿÎ_ty³_wch¬_t_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_ty³_wch¬_t_t*, 
pms
);

284 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

286 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_ty³_wch¬_t_t
));

288 
	`eÿÎ_ty³_wch¬_t
(
ms
->
ms_v®
);

291  
¡©us
;

292 
	}
}

294 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_ty³_¡ruù
(* 
pms
)

296 
ms_eÿÎ_ty³_¡ruù_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_ty³_¡ruù_t*, 
pms
);

297 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

299 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_ty³_¡ruù_t
));

301 
	`eÿÎ_ty³_¡ruù
(
ms
->
ms_v®
);

304  
¡©us
;

305 
	}
}

307 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_ty³_’um_uniÚ
(* 
pms
)

309 
ms_eÿÎ_ty³_’um_uniÚ_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_ty³_’um_uniÚ_t*, 
pms
);

310 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

311 
uniÚ_foo_t
* 
_tmp_v®2
 = 
ms
->
ms_v®2
;

313 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_ty³_’um_uniÚ_t
));

315 
	`eÿÎ_ty³_’um_uniÚ
(
ms
->
ms_v®1
, 
_tmp_v®2
);

318  
¡©us
;

319 
	}
}

321 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_poš‹r_u£r_check
(* 
pms
)

323 
ms_eÿÎ_poš‹r_u£r_check_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_poš‹r_u£r_check_t*, 
pms
);

324 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

325 * 
_tmp_v®
 = 
ms
->
ms_v®
;

327 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_poš‹r_u£r_check_t
));

329 
ms
->
ms_»tv®
 = 
	`eÿÎ_poš‹r_u£r_check
(
_tmp_v®
, ms->
ms_sz
);

332  
¡©us
;

333 
	}
}

335 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_poš‹r_š
(* 
pms
)

337 
ms_eÿÎ_poš‹r_š_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_poš‹r_š_t*, 
pms
);

338 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

339 * 
_tmp_v®
 = 
ms
->
ms_v®
;

340 
size_t
 
_Ën_v®
 = (*
_tmp_v®
);

341 * 
_š_v®
 = 
NULL
;

343 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_poš‹r_š_t
));

344 
	`CHECK_UNIQUE_POINTER
(
_tmp_v®
, 
_Ën_v®
);

346 ià(
_tmp_v®
 !ğ
NULL
) {

347 
_š_v®
 = (*)
	`m®loc
(
_Ën_v®
);

348 ià(
_š_v®
 =ğ
NULL
) {

349 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

350 
”r
;

353 
	`memıy
(
_š_v®
, 
_tmp_v®
, 
_Ën_v®
);

355 
	`eÿÎ_poš‹r_š
(
_š_v®
);

356 
”r
:

357 ià(
_š_v®
è
	`ä“
(_in_val);

359  
¡©us
;

360 
	}
}

362 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_poš‹r_out
(* 
pms
)

364 
ms_eÿÎ_poš‹r_out_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_poš‹r_out_t*, 
pms
);

365 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

366 * 
_tmp_v®
 = 
ms
->
ms_v®
;

367 
size_t
 
_Ën_v®
 = (*
_tmp_v®
);

368 * 
_š_v®
 = 
NULL
;

370 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_poš‹r_out_t
));

371 
	`CHECK_UNIQUE_POINTER
(
_tmp_v®
, 
_Ën_v®
);

373 ià(
_tmp_v®
 !ğ
NULL
) {

374 ià((
_š_v®
 = (*)
	`m®loc
(
_Ën_v®
)è=ğ
NULL
) {

375 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

376 
”r
;

379 
	`mem£t
((*)
_š_v®
, 0, 
_Ën_v®
);

381 
	`eÿÎ_poš‹r_out
(
_š_v®
);

382 
”r
:

383 ià(
_š_v®
) {

384 
	`memıy
(
_tmp_v®
, 
_š_v®
, 
_Ën_v®
);

385 
	`ä“
(
_š_v®
);

388  
¡©us
;

389 
	}
}

391 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_poš‹r_š_out
(* 
pms
)

393 
ms_eÿÎ_poš‹r_š_out_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_poš‹r_š_out_t*, 
pms
);

394 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

395 * 
_tmp_v®
 = 
ms
->
ms_v®
;

396 
size_t
 
_Ën_v®
 = (*
_tmp_v®
);

397 * 
_š_v®
 = 
NULL
;

399 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_poš‹r_š_out_t
));

400 
	`CHECK_UNIQUE_POINTER
(
_tmp_v®
, 
_Ën_v®
);

402 ià(
_tmp_v®
 !ğ
NULL
) {

403 
_š_v®
 = (*)
	`m®loc
(
_Ën_v®
);

404 ià(
_š_v®
 =ğ
NULL
) {

405 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

406 
”r
;

409 
	`memıy
(
_š_v®
, 
_tmp_v®
, 
_Ën_v®
);

411 
	`eÿÎ_poš‹r_š_out
(
_š_v®
);

412 
”r
:

413 ià(
_š_v®
) {

414 
	`memıy
(
_tmp_v®
, 
_š_v®
, 
_Ën_v®
);

415 
	`ä“
(
_š_v®
);

418  
¡©us
;

419 
	}
}

421 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_poš‹r_¡ršg
(* 
pms
)

423 
ms_eÿÎ_poš‹r_¡ršg_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_poš‹r_¡ršg_t*, 
pms
);

424 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

425 * 
_tmp_¡r
 = 
ms
->
ms_¡r
;

426 
size_t
 
_Ën_¡r
 = 
_tmp_¡r
 ? 
	`¡¾’
(_tmp_str) + 1 : 0;

427 * 
_š_¡r
 = 
NULL
;

429 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_poš‹r_¡ršg_t
));

430 
	`CHECK_UNIQUE_POINTER
(
_tmp_¡r
, 
_Ën_¡r
);

432 ià(
_tmp_¡r
 !ğ
NULL
) {

433 
_š_¡r
 = (*)
	`m®loc
(
_Ën_¡r
);

434 ià(
_š_¡r
 =ğ
NULL
) {

435 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

436 
”r
;

439 
	`memıy
(
_š_¡r
, 
_tmp_¡r
, 
_Ën_¡r
);

440 
_š_¡r
[
_Ën_¡r
 - 1] = '\0';

442 
	`eÿÎ_poš‹r_¡ršg
(
_š_¡r
);

443 
”r
:

444 ià(
_š_¡r
) {

445 
	`memıy
(
_tmp_¡r
, 
_š_¡r
, 
_Ën_¡r
);

446 
	`ä“
(
_š_¡r
);

449  
¡©us
;

450 
	}
}

452 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_poš‹r_¡ršg_cÚ¡
(* 
pms
)

454 
ms_eÿÎ_poš‹r_¡ršg_cÚ¡_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_poš‹r_¡ršg_cÚ¡_t*, 
pms
);

455 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

456 * 
_tmp_¡r
 = 
ms
->
ms_¡r
;

457 
size_t
 
_Ën_¡r
 = 
_tmp_¡r
 ? 
	`¡¾’
(_tmp_str) + 1 : 0;

458 * 
_š_¡r
 = 
NULL
;

460 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_poš‹r_¡ršg_cÚ¡_t
));

461 
	`CHECK_UNIQUE_POINTER
(
_tmp_¡r
, 
_Ën_¡r
);

463 ià(
_tmp_¡r
 !ğ
NULL
) {

464 
_š_¡r
 = (*)
	`m®loc
(
_Ën_¡r
);

465 ià(
_š_¡r
 =ğ
NULL
) {

466 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

467 
”r
;

470 
	`memıy
((*)
_š_¡r
, 
_tmp_¡r
, 
_Ën_¡r
);

471 
_š_¡r
[
_Ën_¡r
 - 1] = '\0';

473 
	`eÿÎ_poš‹r_¡ršg_cÚ¡
((cÚ¡ *)
_š_¡r
);

474 
”r
:

475 ià(
_š_¡r
è
	`ä“
((*)_in_str);

477  
¡©us
;

478 
	}
}

480 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_poš‹r_size
(* 
pms
)

482 
ms_eÿÎ_poš‹r_size_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_poš‹r_size_t*, 
pms
);

483 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

484 * 
_tmp_±r
 = 
ms
->
ms_±r
;

485 
size_t
 
_tmp_Ën
 = 
ms
->
ms_Ën
;

486 
size_t
 
_Ën_±r
 = 
_tmp_Ën
;

487 * 
_š_±r
 = 
NULL
;

489 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_poš‹r_size_t
));

490 
	`CHECK_UNIQUE_POINTER
(
_tmp_±r
, 
_Ën_±r
);

492 ià(
_tmp_±r
 !ğ
NULL
) {

493 
_š_±r
 = (*)
	`m®loc
(
_Ën_±r
);

494 ià(
_š_±r
 =ğ
NULL
) {

495 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

496 
”r
;

499 
	`memıy
(
_š_±r
, 
_tmp_±r
, 
_Ën_±r
);

501 
	`eÿÎ_poš‹r_size
(
_š_±r
, 
_tmp_Ën
);

502 
”r
:

503 ià(
_š_±r
) {

504 
	`memıy
(
_tmp_±r
, 
_š_±r
, 
_Ën_±r
);

505 
	`ä“
(
_š_±r
);

508  
¡©us
;

509 
	}
}

511 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_poš‹r_couÁ
(* 
pms
)

513 
ms_eÿÎ_poš‹r_couÁ_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_poš‹r_couÁ_t*, 
pms
);

514 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

515 * 
_tmp_¬r
 = 
ms
->
ms_¬r
;

516 
_tmp_út
 = 
ms
->
ms_út
;

517 
size_t
 
_Ën_¬r
 = 
_tmp_út
 * (*
_tmp_¬r
);

518 * 
_š_¬r
 = 
NULL
;

520 ià((
size_t
)
_tmp_út
 > (
SIZE_MAX
 / (*
_tmp_¬r
))) {

521 
¡©us
 = 
SGX_ERROR_INVALID_PARAMETER
;

522 
”r
;

525 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_poš‹r_couÁ_t
));

526 
	`CHECK_UNIQUE_POINTER
(
_tmp_¬r
, 
_Ën_¬r
);

528 ià(
_tmp_¬r
 !ğ
NULL
) {

529 
_š_¬r
 = (*)
	`m®loc
(
_Ën_¬r
);

530 ià(
_š_¬r
 =ğ
NULL
) {

531 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

532 
”r
;

535 
	`memıy
(
_š_¬r
, 
_tmp_¬r
, 
_Ën_¬r
);

537 
	`eÿÎ_poš‹r_couÁ
(
_š_¬r
, 
_tmp_út
);

538 
”r
:

539 ià(
_š_¬r
) {

540 
	`memıy
(
_tmp_¬r
, 
_š_¬r
, 
_Ën_¬r
);

541 
	`ä“
(
_š_¬r
);

544  
¡©us
;

545 
	}
}

547 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_poš‹r_i¥Œ_»adÚly
(* 
pms
)

549 
ms_eÿÎ_poš‹r_i¥Œ_»adÚly_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_poš‹r_i¥Œ_»adÚly_t*, 
pms
);

550 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

551 
bufãr_t
 
_tmp_buf
 = 
ms
->
ms_buf
;

552 
size_t
 
_tmp_Ën
 = 
ms
->
ms_Ën
;

553 
size_t
 
_Ën_buf
 = 
_tmp_Ën
;

554 
bufãr_t
 
_š_buf
 = 
NULL
;

556 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_poš‹r_i¥Œ_»adÚly_t
));

557 
	`CHECK_UNIQUE_POINTER
(
_tmp_buf
, 
_Ën_buf
);

559 ià(
_tmp_buf
 !ğ
NULL
) {

560 
_š_buf
 = (
bufãr_t
)
	`m®loc
(
_Ën_buf
);

561 ià(
_š_buf
 =ğ
NULL
) {

562 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

563 
”r
;

566 
	`memıy
((*)
_š_buf
, 
_tmp_buf
, 
_Ën_buf
);

568 
	`eÿÎ_poš‹r_i¥Œ_»adÚly
(
_š_buf
, 
_tmp_Ën
);

569 
”r
:

570 ià(
_š_buf
è
	`ä“
((*)_in_buf);

572  
¡©us
;

573 
	}
}

575 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_poš‹r_sizefunc
(* 
pms
)

577 
ms_eÿÎ_poš‹r_sizefunc_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_poš‹r_sizefunc_t*, 
pms
);

578 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

579 * 
_tmp_buf
 = 
ms
->
ms_buf
;

580 
size_t
 
_Ën_buf
 = ((
_tmp_buf
è? 
	`g‘_bufãr_Ën
(_tmp_buf) : 0);

581 * 
_š_buf
 = 
NULL
;

583 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_poš‹r_sizefunc_t
));

584 
	`CHECK_UNIQUE_POINTER
(
_tmp_buf
, 
_Ën_buf
);

586 ià(
_tmp_buf
 !ğ
NULL
) {

587 
_š_buf
 = (*)
	`m®loc
(
_Ën_buf
);

588 ià(
_š_buf
 =ğ
NULL
) {

589 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

590 
”r
;

593 
	`memıy
(
_š_buf
, 
_tmp_buf
, 
_Ën_buf
);

596 ià(
	`g‘_bufãr_Ën
(
_š_buf
è!ğ
_Ën_buf
) {

597 
¡©us
 = 
SGX_ERROR_INVALID_PARAMETER
;

598 
”r
;

601 
	`eÿÎ_poš‹r_sizefunc
(
_š_buf
);

602 
”r
:

603 ià(
_š_buf
) {

604 
	`memıy
(
_tmp_buf
, 
_š_buf
, 
_Ën_buf
);

605 
	`ä“
(
_š_buf
);

608  
¡©us
;

609 
	}
}

611 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_oÿÎ_poš‹r_©Œ
(* 
pms
)

613 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

614 ià(
pms
 !ğ
NULL
è 
SGX_ERROR_INVALID_PARAMETER
;

615 
	`oÿÎ_poš‹r_©Œ
();

616  
¡©us
;

617 
	}
}

619 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_¬¿y_u£r_check
(* 
pms
)

621 
ms_eÿÎ_¬¿y_u£r_check_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_¬¿y_u£r_check_t*, 
pms
);

622 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

623 * 
_tmp_¬r
 = 
ms
->
ms_¬r
;

625 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_¬¿y_u£r_check_t
));

627 
	`eÿÎ_¬¿y_u£r_check
(
_tmp_¬r
);

630  
¡©us
;

631 
	}
}

633 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_¬¿y_š
(* 
pms
)

635 
ms_eÿÎ_¬¿y_š_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_¬¿y_š_t*, 
pms
);

636 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

637 * 
_tmp_¬r
 = 
ms
->
ms_¬r
;

638 
size_t
 
_Ën_¬r
 = 4 * (*
_tmp_¬r
);

639 * 
_š_¬r
 = 
NULL
;

641 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_¬¿y_š_t
));

642 
	`CHECK_UNIQUE_POINTER
(
_tmp_¬r
, 
_Ën_¬r
);

644 ià(
_tmp_¬r
 !ğ
NULL
) {

645 
_š_¬r
 = (*)
	`m®loc
(
_Ën_¬r
);

646 ià(
_š_¬r
 =ğ
NULL
) {

647 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

648 
”r
;

651 
	`memıy
(
_š_¬r
, 
_tmp_¬r
, 
_Ën_¬r
);

653 
	`eÿÎ_¬¿y_š
(
_š_¬r
);

654 
”r
:

655 ià(
_š_¬r
è
	`ä“
(_in_arr);

657  
¡©us
;

658 
	}
}

660 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_¬¿y_out
(* 
pms
)

662 
ms_eÿÎ_¬¿y_out_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_¬¿y_out_t*, 
pms
);

663 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

664 * 
_tmp_¬r
 = 
ms
->
ms_¬r
;

665 
size_t
 
_Ën_¬r
 = 4 * (*
_tmp_¬r
);

666 * 
_š_¬r
 = 
NULL
;

668 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_¬¿y_out_t
));

669 
	`CHECK_UNIQUE_POINTER
(
_tmp_¬r
, 
_Ën_¬r
);

671 ià(
_tmp_¬r
 !ğ
NULL
) {

672 ià((
_š_¬r
 = (*)
	`m®loc
(
_Ën_¬r
)è=ğ
NULL
) {

673 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

674 
”r
;

677 
	`mem£t
((*)
_š_¬r
, 0, 
_Ën_¬r
);

679 
	`eÿÎ_¬¿y_out
(
_š_¬r
);

680 
”r
:

681 ià(
_š_¬r
) {

682 
	`memıy
(
_tmp_¬r
, 
_š_¬r
, 
_Ën_¬r
);

683 
	`ä“
(
_š_¬r
);

686  
¡©us
;

687 
	}
}

689 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_¬¿y_š_out
(* 
pms
)

691 
ms_eÿÎ_¬¿y_š_out_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_¬¿y_š_out_t*, 
pms
);

692 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

693 * 
_tmp_¬r
 = 
ms
->
ms_¬r
;

694 
size_t
 
_Ën_¬r
 = 4 * (*
_tmp_¬r
);

695 * 
_š_¬r
 = 
NULL
;

697 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_¬¿y_š_out_t
));

698 
	`CHECK_UNIQUE_POINTER
(
_tmp_¬r
, 
_Ën_¬r
);

700 ià(
_tmp_¬r
 !ğ
NULL
) {

701 
_š_¬r
 = (*)
	`m®loc
(
_Ën_¬r
);

702 ià(
_š_¬r
 =ğ
NULL
) {

703 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

704 
”r
;

707 
	`memıy
(
_š_¬r
, 
_tmp_¬r
, 
_Ën_¬r
);

709 
	`eÿÎ_¬¿y_š_out
(
_š_¬r
);

710 
”r
:

711 ià(
_š_¬r
) {

712 
	`memıy
(
_tmp_¬r
, 
_š_¬r
, 
_Ën_¬r
);

713 
	`ä“
(
_š_¬r
);

716  
¡©us
;

717 
	}
}

719 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_¬¿y_i§ry
(* 
pms
)

721 
ms_eÿÎ_¬¿y_i§ry_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_¬¿y_i§ry_t*, 
pms
);

722 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

724 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_¬¿y_i§ry_t
));

726 
	`eÿÎ_¬¿y_i§ry
((
ms
->
ms_¬r
 !ğ
NULL
) ? (*ms->ms_arr) : NULL);

729  
¡©us
;

730 
	}
}

732 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_funùiÚ_ÿÎšg_cÚvs
(* 
pms
)

734 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

735 ià(
pms
 !ğ
NULL
è 
SGX_ERROR_INVALID_PARAMETER
;

736 
	`eÿÎ_funùiÚ_ÿÎšg_cÚvs
();

737  
¡©us
;

738 
	}
}

740 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_funùiÚ_public
(* 
pms
)

742 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

743 ià(
pms
 !ğ
NULL
è 
SGX_ERROR_INVALID_PARAMETER
;

744 
	`eÿÎ_funùiÚ_public
();

745  
¡©us
;

746 
	}
}

748 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_funùiÚ_´iv©e
(* 
pms
)

750 
ms_eÿÎ_funùiÚ_´iv©e_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_funùiÚ_´iv©e_t*, 
pms
);

751 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

753 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_funùiÚ_´iv©e_t
));

755 
ms
->
ms_»tv®
 = 
	`eÿÎ_funùiÚ_´iv©e
();

758  
¡©us
;

759 
	}
}

761 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_m®loc_ä“
(* 
pms
)

763 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

764 ià(
pms
 !ğ
NULL
è 
SGX_ERROR_INVALID_PARAMETER
;

765 
	`eÿÎ_m®loc_ä“
();

766  
¡©us
;

767 
	}
}

769 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_sgx_ıuid
(* 
pms
)

771 
ms_eÿÎ_sgx_ıuid_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_sgx_ıuid_t*, 
pms
);

772 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

773 * 
_tmp_ıušfo
 = 
ms
->
ms_ıušfo
;

774 
size_t
 
_Ën_ıušfo
 = 4 * (*
_tmp_ıušfo
);

775 * 
_š_ıušfo
 = 
NULL
;

777 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_sgx_ıuid_t
));

778 
	`CHECK_UNIQUE_POINTER
(
_tmp_ıušfo
, 
_Ën_ıušfo
);

780 ià(
_tmp_ıušfo
 !ğ
NULL
) {

781 
_š_ıušfo
 = (*)
	`m®loc
(
_Ën_ıušfo
);

782 ià(
_š_ıušfo
 =ğ
NULL
) {

783 
¡©us
 = 
SGX_ERROR_OUT_OF_MEMORY
;

784 
”r
;

787 
	`memıy
(
_š_ıušfo
, 
_tmp_ıušfo
, 
_Ën_ıušfo
);

789 
	`eÿÎ_sgx_ıuid
(
_š_ıušfo
, 
ms
->
ms_Ëaf
);

790 
”r
:

791 ià(
_š_ıušfo
) {

792 
	`memıy
(
_tmp_ıušfo
, 
_š_ıušfo
, 
_Ën_ıušfo
);

793 
	`ä“
(
_š_ıušfo
);

796  
¡©us
;

797 
	}
}

799 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_exû±iÚ
(* 
pms
)

801 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

802 ià(
pms
 !ğ
NULL
è 
SGX_ERROR_INVALID_PARAMETER
;

803 
	`eÿÎ_exû±iÚ
();

804  
¡©us
;

805 
	}
}

807 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_m­
(* 
pms
)

809 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

810 ià(
pms
 !ğ
NULL
è 
SGX_ERROR_INVALID_PARAMETER
;

811 
	`eÿÎ_m­
();

812  
¡©us
;

813 
	}
}

815 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_šü—£_couÁ”
(* 
pms
)

817 
ms_eÿÎ_šü—£_couÁ”_t
* 
ms
 = 
	`SGX_CAST
(ms_eÿÎ_šü—£_couÁ”_t*, 
pms
);

818 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

820 
	`CHECK_REF_POINTER
(
pms
, (
ms_eÿÎ_šü—£_couÁ”_t
));

822 
ms
->
ms_»tv®
 = 
	`eÿÎ_šü—£_couÁ”
();

825  
¡©us
;

826 
	}
}

828 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_´oduûr
(* 
pms
)

830 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

831 ià(
pms
 !ğ
NULL
è 
SGX_ERROR_INVALID_PARAMETER
;

832 
	`eÿÎ_´oduûr
();

833  
¡©us
;

834 
	}
}

836 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_eÿÎ_cÚsum”
(* 
pms
)

838 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

839 ià(
pms
 !ğ
NULL
è 
SGX_ERROR_INVALID_PARAMETER
;

840 
	`eÿÎ_cÚsum”
();

841  
¡©us
;

842 
	}
}

844 
SGX_EXTERNC
 const struct {

845 
size_t
 
	mÄ_eÿÎ
;

846 ¡ruù {* 
	mÿÎ_addr
; 
ušt8_t
 
	mis_´iv
;} 
	meÿÎ_bË
[35];

847 } 
	gg_eÿÎ_bË
 = {

850 {(*)(
ušŒ_t
)
sgx_eÿÎ_maš
, 0},

851 {(*)(
ušŒ_t
)
sgx_eÿÎ_ty³_ch¬
, 0},

852 {(*)(
ušŒ_t
)
sgx_eÿÎ_ty³_št
, 0},

853 {(*)(
ušŒ_t
)
sgx_eÿÎ_ty³_æßt
, 0},

854 {(*)(
ušŒ_t
)
sgx_eÿÎ_ty³_doubË
, 0},

855 {(*)(
ušŒ_t
)
sgx_eÿÎ_ty³_size_t
, 0},

856 {(*)(
ušŒ_t
)
sgx_eÿÎ_ty³_wch¬_t
, 0},

857 {(*)(
ušŒ_t
)
sgx_eÿÎ_ty³_¡ruù
, 0},

858 {(*)(
ušŒ_t
)
sgx_eÿÎ_ty³_’um_uniÚ
, 0},

859 {(*)(
ušŒ_t
)
sgx_eÿÎ_poš‹r_u£r_check
, 0},

860 {(*)(
ušŒ_t
)
sgx_eÿÎ_poš‹r_š
, 0},

861 {(*)(
ušŒ_t
)
sgx_eÿÎ_poš‹r_out
, 0},

862 {(*)(
ušŒ_t
)
sgx_eÿÎ_poš‹r_š_out
, 0},

863 {(*)(
ušŒ_t
)
sgx_eÿÎ_poš‹r_¡ršg
, 0},

864 {(*)(
ušŒ_t
)
sgx_eÿÎ_poš‹r_¡ršg_cÚ¡
, 0},

865 {(*)(
ušŒ_t
)
sgx_eÿÎ_poš‹r_size
, 0},

866 {(*)(
ušŒ_t
)
sgx_eÿÎ_poš‹r_couÁ
, 0},

867 {(*)(
ušŒ_t
)
sgx_eÿÎ_poš‹r_i¥Œ_»adÚly
, 0},

868 {(*)(
ušŒ_t
)
sgx_eÿÎ_poš‹r_sizefunc
, 0},

869 {(*)(
ušŒ_t
)
sgx_oÿÎ_poš‹r_©Œ
, 0},

870 {(*)(
ušŒ_t
)
sgx_eÿÎ_¬¿y_u£r_check
, 0},

871 {(*)(
ušŒ_t
)
sgx_eÿÎ_¬¿y_š
, 0},

872 {(*)(
ušŒ_t
)
sgx_eÿÎ_¬¿y_out
, 0},

873 {(*)(
ušŒ_t
)
sgx_eÿÎ_¬¿y_š_out
, 0},

874 {(*)(
ušŒ_t
)
sgx_eÿÎ_¬¿y_i§ry
, 0},

875 {(*)(
ušŒ_t
)
sgx_eÿÎ_funùiÚ_ÿÎšg_cÚvs
, 0},

876 {(*)(
ušŒ_t
)
sgx_eÿÎ_funùiÚ_public
, 0},

877 {(*)(
ušŒ_t
)
sgx_eÿÎ_funùiÚ_´iv©e
, 1},

878 {(*)(
ušŒ_t
)
sgx_eÿÎ_m®loc_ä“
, 0},

879 {(*)(
ušŒ_t
)
sgx_eÿÎ_sgx_ıuid
, 0},

880 {(*)(
ušŒ_t
)
sgx_eÿÎ_exû±iÚ
, 0},

881 {(*)(
ušŒ_t
)
sgx_eÿÎ_m­
, 0},

882 {(*)(
ušŒ_t
)
sgx_eÿÎ_šü—£_couÁ”
, 0},

883 {(*)(
ušŒ_t
)
sgx_eÿÎ_´oduûr
, 0},

884 {(*)(
ušŒ_t
)
sgx_eÿÎ_cÚsum”
, 0},

888 
SGX_EXTERNC
 const struct {

889 
size_t
 
	mÄ_oÿÎ
;

890 
ušt8_t
 
	m’Œy_bË
[13][35];

891 } 
	gg_dyn_’Œy_bË
 = {

911 
sgx_¡©us_t
 
SGX_CDECL
 
	$oÿÎ_´št_¡ršg
(cÚ¡ * 
¡r
)

913 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

914 
size_t
 
_Ën_¡r
 = 
¡r
 ? 
	`¡¾’
(str) + 1 : 0;

916 
ms_oÿÎ_´št_¡ršg_t
* 
ms
 = 
NULL
;

917 
size_t
 
oÿÎoc_size
 = (
ms_oÿÎ_´št_¡ršg_t
);

918 *
__tmp
 = 
NULL
;

920 
oÿÎoc_size
 +ğ(
¡r
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(¡r, 
_Ën_¡r
)) ? _len_str : 0;

922 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

923 ià(
__tmp
 =ğ
NULL
) {

924 
	`sgx_ocä“
();

925  
SGX_ERROR_UNEXPECTED
;

927 
ms
 = (
ms_oÿÎ_´št_¡ršg_t
*)
__tmp
;

928 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_oÿÎ_´št_¡ršg_t
));

930 ià(
¡r
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(¡r, 
_Ën_¡r
)) {

931 
ms
->
ms_¡r
 = (*)
__tmp
;

932 
__tmp
 = (*)((
size_t
)__tm°+ 
_Ën_¡r
);

933 
	`memıy
((*)
ms
->
ms_¡r
, 
¡r
, 
_Ën_¡r
);

934 } ià(
¡r
 =ğ
NULL
) {

935 
ms
->
ms_¡r
 = 
NULL
;

937 
	`sgx_ocä“
();

938  
SGX_ERROR_INVALID_PARAMETER
;

941 
¡©us
 = 
	`sgx_oÿÎ
(0, 
ms
);

944 
	`sgx_ocä“
();

945  
¡©us
;

946 
	}
}

948 
sgx_¡©us_t
 
SGX_CDECL
 
	$oÿÎ_g’”ic
(* 
»tv®
, 
±r
)

950 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

952 
ms_oÿÎ_g’”ic_t
* 
ms
 = 
NULL
;

953 
size_t
 
oÿÎoc_size
 = (
ms_oÿÎ_g’”ic_t
);

954 *
__tmp
 = 
NULL
;

957 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

958 ià(
__tmp
 =ğ
NULL
) {

959 
	`sgx_ocä“
();

960  
SGX_ERROR_UNEXPECTED
;

962 
ms
 = (
ms_oÿÎ_g’”ic_t
*)
__tmp
;

963 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_oÿÎ_g’”ic_t
));

965 
ms
->
ms_±r
 = 
±r
;

966 
¡©us
 = 
	`sgx_oÿÎ
(1, 
ms
);

968 ià(
»tv®
è*»tv® = 
ms
->
ms_»tv®
;

970 
	`sgx_ocä“
();

971  
¡©us
;

972 
	}
}

974 
sgx_¡©us_t
 
SGX_CDECL
 
	$oÿÎ_poš‹r_u£r_check
(* 
v®
)

976 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

978 
ms_oÿÎ_poš‹r_u£r_check_t
* 
ms
 = 
NULL
;

979 
size_t
 
oÿÎoc_size
 = (
ms_oÿÎ_poš‹r_u£r_check_t
);

980 *
__tmp
 = 
NULL
;

983 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

984 ià(
__tmp
 =ğ
NULL
) {

985 
	`sgx_ocä“
();

986  
SGX_ERROR_UNEXPECTED
;

988 
ms
 = (
ms_oÿÎ_poš‹r_u£r_check_t
*)
__tmp
;

989 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_oÿÎ_poš‹r_u£r_check_t
));

991 
ms
->
ms_v®
 = 
	`SGX_CAST
(*, 
v®
);

992 
¡©us
 = 
	`sgx_oÿÎ
(2, 
ms
);

995 
	`sgx_ocä“
();

996  
¡©us
;

997 
	}
}

999 
sgx_¡©us_t
 
SGX_CDECL
 
	$oÿÎ_poš‹r_š
(* 
v®
)

1001 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

1002 
size_t
 
_Ën_v®
 = (*
v®
);

1004 
ms_oÿÎ_poš‹r_š_t
* 
ms
 = 
NULL
;

1005 
size_t
 
oÿÎoc_size
 = (
ms_oÿÎ_poš‹r_š_t
);

1006 *
__tmp
 = 
NULL
;

1008 
oÿÎoc_size
 +ğ(
v®
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(v®, 
_Ën_v®
)) ? _len_val : 0;

1010 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

1011 ià(
__tmp
 =ğ
NULL
) {

1012 
	`sgx_ocä“
();

1013  
SGX_ERROR_UNEXPECTED
;

1015 
ms
 = (
ms_oÿÎ_poš‹r_š_t
*)
__tmp
;

1016 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_oÿÎ_poš‹r_š_t
));

1018 ià(
v®
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(v®, 
_Ën_v®
)) {

1019 
ms
->
ms_v®
 = (*)
__tmp
;

1020 
__tmp
 = (*)((
size_t
)__tm°+ 
_Ën_v®
);

1021 
	`memıy
(
ms
->
ms_v®
, 
v®
, 
_Ën_v®
);

1022 } ià(
v®
 =ğ
NULL
) {

1023 
ms
->
ms_v®
 = 
NULL
;

1025 
	`sgx_ocä“
();

1026  
SGX_ERROR_INVALID_PARAMETER
;

1029 
¡©us
 = 
	`sgx_oÿÎ
(3, 
ms
);

1032 
	`sgx_ocä“
();

1033  
¡©us
;

1034 
	}
}

1036 
sgx_¡©us_t
 
SGX_CDECL
 
	$oÿÎ_poš‹r_out
(* 
v®
)

1038 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

1039 
size_t
 
_Ën_v®
 = (*
v®
);

1041 
ms_oÿÎ_poš‹r_out_t
* 
ms
 = 
NULL
;

1042 
size_t
 
oÿÎoc_size
 = (
ms_oÿÎ_poš‹r_out_t
);

1043 *
__tmp
 = 
NULL
;

1045 
oÿÎoc_size
 +ğ(
v®
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(v®, 
_Ën_v®
)) ? _len_val : 0;

1047 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

1048 ià(
__tmp
 =ğ
NULL
) {

1049 
	`sgx_ocä“
();

1050  
SGX_ERROR_UNEXPECTED
;

1052 
ms
 = (
ms_oÿÎ_poš‹r_out_t
*)
__tmp
;

1053 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_oÿÎ_poš‹r_out_t
));

1055 ià(
v®
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(v®, 
_Ën_v®
)) {

1056 
ms
->
ms_v®
 = (*)
__tmp
;

1057 
__tmp
 = (*)((
size_t
)__tm°+ 
_Ën_v®
);

1058 
	`mem£t
(
ms
->
ms_v®
, 0, 
_Ën_v®
);

1059 } ià(
v®
 =ğ
NULL
) {

1060 
ms
->
ms_v®
 = 
NULL
;

1062 
	`sgx_ocä“
();

1063  
SGX_ERROR_INVALID_PARAMETER
;

1066 
¡©us
 = 
	`sgx_oÿÎ
(4, 
ms
);

1068 ià(
v®
è
	`memıy
((*)v®, 
ms
->
ms_v®
, 
_Ën_v®
);

1070 
	`sgx_ocä“
();

1071  
¡©us
;

1072 
	}
}

1074 
sgx_¡©us_t
 
SGX_CDECL
 
	$oÿÎ_poš‹r_š_out
(* 
v®
)

1076 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

1077 
size_t
 
_Ën_v®
 = (*
v®
);

1079 
ms_oÿÎ_poš‹r_š_out_t
* 
ms
 = 
NULL
;

1080 
size_t
 
oÿÎoc_size
 = (
ms_oÿÎ_poš‹r_š_out_t
);

1081 *
__tmp
 = 
NULL
;

1083 
oÿÎoc_size
 +ğ(
v®
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(v®, 
_Ën_v®
)) ? _len_val : 0;

1085 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

1086 ià(
__tmp
 =ğ
NULL
) {

1087 
	`sgx_ocä“
();

1088  
SGX_ERROR_UNEXPECTED
;

1090 
ms
 = (
ms_oÿÎ_poš‹r_š_out_t
*)
__tmp
;

1091 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_oÿÎ_poš‹r_š_out_t
));

1093 ià(
v®
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(v®, 
_Ën_v®
)) {

1094 
ms
->
ms_v®
 = (*)
__tmp
;

1095 
__tmp
 = (*)((
size_t
)__tm°+ 
_Ën_v®
);

1096 
	`memıy
(
ms
->
ms_v®
, 
v®
, 
_Ën_v®
);

1097 } ià(
v®
 =ğ
NULL
) {

1098 
ms
->
ms_v®
 = 
NULL
;

1100 
	`sgx_ocä“
();

1101  
SGX_ERROR_INVALID_PARAMETER
;

1104 
¡©us
 = 
	`sgx_oÿÎ
(5, 
ms
);

1106 ià(
v®
è
	`memıy
((*)v®, 
ms
->
ms_v®
, 
_Ën_v®
);

1108 
	`sgx_ocä“
();

1109  
¡©us
;

1110 
	}
}

1112 
sgx_¡©us_t
 
SGX_CDECL
 
	$memcıy
(** 
»tv®
, * 
de¡
, cÚ¡ * 
¤c
, 
v®
, 
size_t
 
Ën
)

1114 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

1115 
size_t
 
_Ën_de¡
 = 
Ën
;

1116 
size_t
 
_Ën_¤c
 = 
Ën
;

1118 
ms_memcıy_t
* 
ms
 = 
NULL
;

1119 
size_t
 
oÿÎoc_size
 = (
ms_memcıy_t
);

1120 *
__tmp
 = 
NULL
;

1122 
oÿÎoc_size
 +ğ(
de¡
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(de¡, 
_Ën_de¡
)) ? _len_dest : 0;

1123 
oÿÎoc_size
 +ğ(
¤c
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(¤c, 
_Ën_¤c
)) ? _len_src : 0;

1125 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

1126 ià(
__tmp
 =ğ
NULL
) {

1127 
	`sgx_ocä“
();

1128  
SGX_ERROR_UNEXPECTED
;

1130 
ms
 = (
ms_memcıy_t
*)
__tmp
;

1131 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_memcıy_t
));

1133 ià(
de¡
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(de¡, 
_Ën_de¡
)) {

1134 
ms
->
ms_de¡
 = (*)
__tmp
;

1135 
__tmp
 = (*)((
size_t
)__tm°+ 
_Ën_de¡
);

1136 
	`memıy
(
ms
->
ms_de¡
, 
de¡
, 
_Ën_de¡
);

1137 } ià(
de¡
 =ğ
NULL
) {

1138 
ms
->
ms_de¡
 = 
NULL
;

1140 
	`sgx_ocä“
();

1141  
SGX_ERROR_INVALID_PARAMETER
;

1144 ià(
¤c
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(¤c, 
_Ën_¤c
)) {

1145 
ms
->
ms_¤c
 = (*)
__tmp
;

1146 
__tmp
 = (*)((
size_t
)__tm°+ 
_Ën_¤c
);

1147 
	`memıy
((*)
ms
->
ms_¤c
, 
¤c
, 
_Ën_¤c
);

1148 } ià(
¤c
 =ğ
NULL
) {

1149 
ms
->
ms_¤c
 = 
NULL
;

1151 
	`sgx_ocä“
();

1152  
SGX_ERROR_INVALID_PARAMETER
;

1155 
ms
->
ms_v®
 = 
v®
;

1156 
ms
->
ms_Ën
 = 
Ën
;

1157 
¡©us
 = 
	`sgx_oÿÎ
(6, 
ms
);

1159 ià(
»tv®
è*»tv® = 
ms
->
ms_»tv®
;

1160 ià(
de¡
è
	`memıy
((*)de¡, 
ms
->
ms_de¡
, 
_Ën_de¡
);

1162 
	`sgx_ocä“
();

1163  
¡©us
;

1164 
	}
}

1166 
sgx_¡©us_t
 
SGX_CDECL
 
	$oÿÎ_funùiÚ_®low
()

1168 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

1169 
¡©us
 = 
	`sgx_oÿÎ
(7, 
NULL
);

1171  
¡©us
;

1172 
	}
}

1174 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_oc_ıuidex
(
ıušfo
[4], 
Ëaf
, 
subËaf
)

1176 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

1177 
size_t
 
_Ën_ıušfo
 = 4 * (*
ıušfo
);

1179 
ms_sgx_oc_ıuidex_t
* 
ms
 = 
NULL
;

1180 
size_t
 
oÿÎoc_size
 = (
ms_sgx_oc_ıuidex_t
);

1181 *
__tmp
 = 
NULL
;

1183 
oÿÎoc_size
 +ğ(
ıušfo
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(ıušfo, 
_Ën_ıušfo
)) ? _len_cpuinfo : 0;

1185 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

1186 ià(
__tmp
 =ğ
NULL
) {

1187 
	`sgx_ocä“
();

1188  
SGX_ERROR_UNEXPECTED
;

1190 
ms
 = (
ms_sgx_oc_ıuidex_t
*)
__tmp
;

1191 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_sgx_oc_ıuidex_t
));

1193 ià(
ıušfo
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(ıušfo, 
_Ën_ıušfo
)) {

1194 
ms
->
ms_ıušfo
 = (*)
__tmp
;

1195 
__tmp
 = (*)((
size_t
)__tm°+ 
_Ën_ıušfo
);

1196 
	`memıy
(
ms
->
ms_ıušfo
, 
ıušfo
, 
_Ën_ıušfo
);

1197 } ià(
ıušfo
 =ğ
NULL
) {

1198 
ms
->
ms_ıušfo
 = 
NULL
;

1200 
	`sgx_ocä“
();

1201  
SGX_ERROR_INVALID_PARAMETER
;

1204 
ms
->
ms_Ëaf
 = 
Ëaf
;

1205 
ms
->
ms_subËaf
 = 
subËaf
;

1206 
¡©us
 = 
	`sgx_oÿÎ
(8, 
ms
);

1208 ià(
ıušfo
è
	`memıy
((*)ıušfo, 
ms
->
ms_ıušfo
, 
_Ën_ıušfo
);

1210 
	`sgx_ocä“
();

1211  
¡©us
;

1212 
	}
}

1214 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ
(* 
»tv®
, cÚ¡ * 
£lf
)

1216 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

1218 
ms_sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ_t
* 
ms
 = 
NULL
;

1219 
size_t
 
oÿÎoc_size
 = (
ms_sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ_t
);

1220 *
__tmp
 = 
NULL
;

1223 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

1224 ià(
__tmp
 =ğ
NULL
) {

1225 
	`sgx_ocä“
();

1226  
SGX_ERROR_UNEXPECTED
;

1228 
ms
 = (
ms_sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ_t
*)
__tmp
;

1229 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ_t
));

1231 
ms
->
ms_£lf
 = 
	`SGX_CAST
(*, 
£lf
);

1232 
¡©us
 = 
	`sgx_oÿÎ
(9, 
ms
);

1234 ià(
»tv®
è*»tv® = 
ms
->
ms_»tv®
;

1236 
	`sgx_ocä“
();

1237  
¡©us
;

1238 
	}
}

1240 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ
(* 
»tv®
, cÚ¡ * 
wa™”
)

1242 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

1244 
ms_sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ_t
* 
ms
 = 
NULL
;

1245 
size_t
 
oÿÎoc_size
 = (
ms_sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ_t
);

1246 *
__tmp
 = 
NULL
;

1249 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

1250 ià(
__tmp
 =ğ
NULL
) {

1251 
	`sgx_ocä“
();

1252  
SGX_ERROR_UNEXPECTED
;

1254 
ms
 = (
ms_sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ_t
*)
__tmp
;

1255 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ_t
));

1257 
ms
->
ms_wa™”
 = 
	`SGX_CAST
(*, 
wa™”
);

1258 
¡©us
 = 
	`sgx_oÿÎ
(10, 
ms
);

1260 ià(
»tv®
è*»tv® = 
ms
->
ms_»tv®
;

1262 
	`sgx_ocä“
();

1263  
¡©us
;

1264 
	}
}

1266 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ
(* 
»tv®
, cÚ¡ * 
wa™”
, cÚ¡ * 
£lf
)

1268 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

1270 
ms_sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ_t
* 
ms
 = 
NULL
;

1271 
size_t
 
oÿÎoc_size
 = (
ms_sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ_t
);

1272 *
__tmp
 = 
NULL
;

1275 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

1276 ià(
__tmp
 =ğ
NULL
) {

1277 
	`sgx_ocä“
();

1278  
SGX_ERROR_UNEXPECTED
;

1280 
ms
 = (
ms_sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ_t
*)
__tmp
;

1281 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ_t
));

1283 
ms
->
ms_wa™”
 = 
	`SGX_CAST
(*, 
wa™”
);

1284 
ms
->
ms_£lf
 = 
	`SGX_CAST
(*, 
£lf
);

1285 
¡©us
 = 
	`sgx_oÿÎ
(11, 
ms
);

1287 ià(
»tv®
è*»tv® = 
ms
->
ms_»tv®
;

1289 
	`sgx_ocä“
();

1290  
¡©us
;

1291 
	}
}

1293 
sgx_¡©us_t
 
SGX_CDECL
 
	$sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ
(* 
»tv®
, cÚ¡ ** 
wa™”s
, 
size_t
 
tÙ®
)

1295 
sgx_¡©us_t
 
¡©us
 = 
SGX_SUCCESS
;

1296 
size_t
 
_Ën_wa™”s
 = 
tÙ®
 * (*
wa™”s
);

1298 
ms_sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ_t
* 
ms
 = 
NULL
;

1299 
size_t
 
oÿÎoc_size
 = (
ms_sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ_t
);

1300 *
__tmp
 = 
NULL
;

1302 
oÿÎoc_size
 +ğ(
wa™”s
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(wa™”s, 
_Ën_wa™”s
)) ? _len_waiters : 0;

1304 
__tmp
 = 
	`sgx_oÿÎoc
(
oÿÎoc_size
);

1305 ià(
__tmp
 =ğ
NULL
) {

1306 
	`sgx_ocä“
();

1307  
SGX_ERROR_UNEXPECTED
;

1309 
ms
 = (
ms_sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ_t
*)
__tmp
;

1310 
__tmp
 = (*)((
size_t
)__tm°+ (
ms_sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ_t
));

1312 ià(
wa™”s
 !ğ
NULL
 && 
	`sgx_is_w™hš_’şave
(wa™”s, 
_Ën_wa™”s
)) {

1313 
ms
->
ms_wa™”s
 = (**)
__tmp
;

1314 
__tmp
 = (*)((
size_t
)__tm°+ 
_Ën_wa™”s
);

1315 
	`memıy
((*)
ms
->
ms_wa™”s
, 
wa™”s
, 
_Ën_wa™”s
);

1316 } ià(
wa™”s
 =ğ
NULL
) {

1317 
ms
->
ms_wa™”s
 = 
NULL
;

1319 
	`sgx_ocä“
();

1320  
SGX_ERROR_INVALID_PARAMETER
;

1323 
ms
->
ms_tÙ®
 = 
tÙ®
;

1324 
¡©us
 = 
	`sgx_oÿÎ
(12, 
ms
);

1326 ià(
»tv®
è*»tv® = 
ms
->
ms_»tv®
;

1328 
	`sgx_ocä“
();

1329  
¡©us
;

1330 
	}
}

1332 #ifdeà
_MSC_VER


1333 #´agm¨
w¬nšg
(
pİ
)

	@Enclave_t.h

1 #iâdeà
ENCLAVE_T_H__


2 
	#ENCLAVE_T_H__


	)

4 
	~<¡dšt.h
>

5 
	~<wch¬.h
>

6 
	~<¡ddef.h
>

7 
	~"sgx_edg”8r.h
"

9 
	~"u£r_ty³s.h
"

11 
	#SGX_CAST
(
ty³
, 
™em
è(Ñy³)(™em))

	)

13 #ifdeà
__ılu¥lus


17 
	s¡ruù_foo_t
 {

18 
ušt32_t
 
¡ruù_foo_0
;

19 
ušt64_t
 
¡ruù_foo_1
;

20 } 
	t¡ruù_foo_t
;

22 
	e’um_foo_t
 {

23 
ENUM_FOO_0
 = 0,

24 
ENUM_FOO_1
 = 1,

25 } 
	t’um_foo_t
;

27 
	uuniÚ_foo_t
 {

28 
ušt32_t
 
uniÚ_foo_0
;

29 
ušt32_t
 
uniÚ_foo_1
;

30 
ušt64_t
 
uniÚ_foo_3
;

31 } 
	tuniÚ_foo_t
;

33 
size_t
 
g‘_bufãr_Ën
(cÚ¡ * 
v®
);

35 
eÿÎ_maš
();

36 
eÿÎ_ty³_ch¬
(
v®
);

37 
eÿÎ_ty³_št
(
v®
);

38 
eÿÎ_ty³_æßt
(
v®
);

39 
eÿÎ_ty³_doubË
(
v®
);

40 
eÿÎ_ty³_size_t
(
size_t
 
v®
);

41 
eÿÎ_ty³_wch¬_t
(
wch¬_t
 
v®
);

42 
eÿÎ_ty³_¡ruù
(
¡ruù_foo_t
 
v®
);

43 
eÿÎ_ty³_’um_uniÚ
(
’um_foo_t
 
v®1
, 
uniÚ_foo_t
* 
v®2
);

44 
size_t
 
eÿÎ_poš‹r_u£r_check
(* 
v®
, size_ˆ
sz
);

45 
eÿÎ_poš‹r_š
(* 
v®
);

46 
eÿÎ_poš‹r_out
(* 
v®
);

47 
eÿÎ_poš‹r_š_out
(* 
v®
);

48 
eÿÎ_poš‹r_¡ršg
(* 
¡r
);

49 
eÿÎ_poš‹r_¡ršg_cÚ¡
(cÚ¡ * 
¡r
);

50 
eÿÎ_poš‹r_size
(* 
±r
, 
size_t
 
Ën
);

51 
eÿÎ_poš‹r_couÁ
(* 
¬r
, 
út
);

52 
eÿÎ_poš‹r_i¥Œ_»adÚly
(
bufãr_t
 
buf
, 
size_t
 
Ën
);

53 
eÿÎ_poš‹r_sizefunc
(* 
buf
);

54 
oÿÎ_poš‹r_©Œ
();

55 
eÿÎ_¬¿y_u£r_check
(
¬r
[4]);

56 
eÿÎ_¬¿y_š
(
¬r
[4]);

57 
eÿÎ_¬¿y_out
(
¬r
[4]);

58 
eÿÎ_¬¿y_š_out
(
¬r
[4]);

59 
eÿÎ_¬¿y_i§ry
(
¬¿y_t
 
¬r
);

60 
eÿÎ_funùiÚ_ÿÎšg_cÚvs
();

61 
eÿÎ_funùiÚ_public
();

62 
eÿÎ_funùiÚ_´iv©e
();

63 
eÿÎ_m®loc_ä“
();

64 
eÿÎ_sgx_ıuid
(
ıušfo
[4], 
Ëaf
);

65 
eÿÎ_exû±iÚ
();

66 
eÿÎ_m­
();

67 
size_t
 
eÿÎ_šü—£_couÁ”
();

68 
eÿÎ_´oduûr
();

69 
eÿÎ_cÚsum”
();

71 
sgx_¡©us_t
 
SGX_CDECL
 
oÿÎ_´št_¡ršg
(cÚ¡ * 
¡r
);

72 
sgx_¡©us_t
 
SGX_CDECL
 
oÿÎ_g’”ic
(* 
»tv®
, 
±r
);

73 
sgx_¡©us_t
 
SGX_CDECL
 
oÿÎ_poš‹r_u£r_check
(* 
v®
);

74 
sgx_¡©us_t
 
SGX_CDECL
 
oÿÎ_poš‹r_š
(* 
v®
);

75 
sgx_¡©us_t
 
SGX_CDECL
 
oÿÎ_poš‹r_out
(* 
v®
);

76 
sgx_¡©us_t
 
SGX_CDECL
 
oÿÎ_poš‹r_š_out
(* 
v®
);

77 
sgx_¡©us_t
 
SGX_CDECL
 
memcıy
(** 
»tv®
, * 
de¡
, cÚ¡ * 
¤c
, 
v®
, 
size_t
 
Ën
);

78 
sgx_¡©us_t
 
SGX_CDECL
 
oÿÎ_funùiÚ_®low
();

79 
sgx_¡©us_t
 
SGX_CDECL
 
sgx_oc_ıuidex
(
ıušfo
[4], 
Ëaf
, 
subËaf
);

80 
sgx_¡©us_t
 
SGX_CDECL
 
sgx_th»ad_wa™_uÁru¡ed_ev’t_oÿÎ
(* 
»tv®
, cÚ¡ * 
£lf
);

81 
sgx_¡©us_t
 
SGX_CDECL
 
sgx_th»ad_£t_uÁru¡ed_ev’t_oÿÎ
(* 
»tv®
, cÚ¡ * 
wa™”
);

82 
sgx_¡©us_t
 
SGX_CDECL
 
sgx_th»ad_£twa™_uÁru¡ed_ev’ts_oÿÎ
(* 
»tv®
, cÚ¡ * 
wa™”
, cÚ¡ * 
£lf
);

83 
sgx_¡©us_t
 
SGX_CDECL
 
sgx_th»ad_£t_muÉË_uÁru¡ed_ev’ts_oÿÎ
(* 
»tv®
, cÚ¡ ** 
wa™”s
, 
size_t
 
tÙ®
);

85 #ifdeà
__ılu¥lus


	@TrustedLibrary/Libc.cpp

26 
	~<¡ršg.h
>

27 
	~<sgx_ıuid.h
>

29 
	~"sgx_Œts.h
"

30 
	~"../Enşave.h
"

31 
	~"Enşave_t.h
"

36 
	$eÿÎ_m®loc_ä“
()

38 *
±r
 = 
	`m®loc
(100);

39 
	`as£¹
(
±r
 !ğ
NULL
);

40 
	`mem£t
(
±r
, 0x0, 100);

41 
	`ä“
(
±r
);

42 
	}
}

47 
	$eÿÎ_sgx_ıuid
(
ıušfo
[4], 
Ëaf
)

49 
sgx_¡©us_t
 
»t
 = 
	`sgx_ıuid
(
ıušfo
, 
Ëaf
);

50 ià(
»t
 !ğ
SGX_SUCCESS
)

51 
	`abÜt
();

52 
	}
}

	@TrustedLibrary/Libcxx.cpp

26 
	~<c¡dlib
>

27 
	~<¡ršg
>

29 
	~"../Enşave.h
"

30 
	~"Enşave_t.h
"

37 
	$eÿÎ_exû±iÚ
()

39 
¡d
::
¡ršg
 
foo
 = "foo";

40 
Œy
 {

41 
throw
 
¡d
::
	`ruÁime_”rÜ
(
foo
);

43 
	`ÿtch
 (
¡d
::
ruÁime_”rÜ
 cÚ¡& 
e
) {

44 
	`as£¹
Ğ
foo
 =ğ
e
.
	`wh©
() );

45 
¡d
::
ruÁime_”rÜ
 
	`şÚe
("");

46 
şÚe
 = 
e
;

47 
	`as£¹
(
foo
 =ğ
şÚe
.
	`wh©
() );

49 
	`ÿtch
 (...) {

50 
	`as£¹
Ğ
çl£
 );

52 
	}
}

54 
	~<m­
>

55 
	~<®gÜ™hm
>

57 
usšg
 
Çme¥aû
 
	g¡d
;

63 
	$eÿÎ_m­
()

65 
m­
<, , 
	tËss
<> > 
	tm­_t
;

66 
m­_t
::
	tv®ue_ty³
 
	tm­_v®ue
;

67 
m­_t
 
m
;

69 
m
.
	`š£¹
(
	`m­_v®ue
('a', 1));

70 
m
.
	`š£¹
(
	`m­_v®ue
('b', 2));

71 
m
.
	`š£¹
(
	`m­_v®ue
('c', 3));

72 
m
.
	`š£¹
(
	`m­_v®ue
('d', 4));

74 
	`as£¹
(
m
['a'] == 1);

75 
	`as£¹
(
m
['b'] == 2);

76 
	`as£¹
(
m
['c'] == 3);

77 
	`as£¹
(
m
['d'] == 4);

79 
	`as£¹
(
m
.
	`fšd
('e'è=ğm.
	`’d
());

82 
	}
}

	@TrustedLibrary/Thread.cpp

26 
	~"../Enşave.h
"

27 
	~"Enşave_t.h
"

29 
	~<sgx_th»ad.h
>

31 
size_t
 
	gglob®_couÁ”
 = 0;

32 
sgx_th»ad_mu‹x_t
 
	gglob®_mu‹x
 = 
SGX_THREAD_MUTEX_INITIALIZER
;

34 
	#BUFFER_SIZE
 50

	)

37 
	mbuf
[
BUFFER_SIZE
];

38 
	moccup›d
;

39 
	mÃxtš
;

40 
	mÃxtout
;

41 
sgx_th»ad_mu‹x_t
 
	mmu‹x
;

42 
sgx_th»ad_cÚd_t
 
	mmÜe
;

43 
sgx_th»ad_cÚd_t
 
	mËss
;

44 } 
	tcÚd_bufãr_t
;

46 
cÚd_bufãr_t
 
	gbufãr
 = {{0, 0, 0, 0, 0, 0}, 0, 0, 0,

47 
SGX_THREAD_MUTEX_INITIALIZER
, 
SGX_THREAD_COND_INITIALIZER
, SGX_THREAD_COND_INITIALIZER};

53 
size_t
 
	$eÿÎ_šü—£_couÁ”
()

55 
size_t
 
»t
 = 0;

56 
i
 = 0; i < 
LOOPS_PER_THREAD
; i++) {

57 
	`sgx_th»ad_mu‹x_lock
(&
glob®_mu‹x
);

59 
size_t
 
tmp
 = 
glob®_couÁ”
;

60 
glob®_couÁ”
 = ++
tmp
;

61 ià(4*
LOOPS_PER_THREAD
 =ğ
glob®_couÁ”
)

62 
»t
 = 
glob®_couÁ”
;

63 
	`sgx_th»ad_mu‹x_uÆock
(&
glob®_mu‹x
);

65  
»t
;

66 
	}
}

68 
	$eÿÎ_´oduûr
()

70 
i
 = 0; i < 4*
LOOPS_PER_THREAD
; i++) {

71 
cÚd_bufãr_t
 *
b
 = &
bufãr
;

72 
	`sgx_th»ad_mu‹x_lock
(&
b
->
mu‹x
);

73 
b
->
occup›d
 >ğ
BUFFER_SIZE
)

74 
	`sgx_th»ad_cÚd_wa™
(&
b
->
Ëss
, &b->
mu‹x
);

75 
b
->
buf
[b->
Ãxtš
] = b->nextin;

76 
b
->
Ãxtš
++;

77 
b
->
Ãxtš
 %ğ
BUFFER_SIZE
;

78 
b
->
occup›d
++;

79 
	`sgx_th»ad_cÚd_sigÇl
(&
b
->
mÜe
);

80 
	`sgx_th»ad_mu‹x_uÆock
(&
b
->
mu‹x
);

82 
	}
}

84 
	$eÿÎ_cÚsum”
()

86 
i
 = 0; i < 
LOOPS_PER_THREAD
; i++) {

87 
cÚd_bufãr_t
 *
b
 = &
bufãr
;

88 
	`sgx_th»ad_mu‹x_lock
(&
b
->
mu‹x
);

89 
b
->
occup›d
 <= 0)

90 
	`sgx_th»ad_cÚd_wa™
(&
b
->
mÜe
, &b->
mu‹x
);

91 
b
->
buf
[b->
Ãxtout
++] = 0;

92 
b
->
Ãxtout
 %ğ
BUFFER_SIZE
;

93 
b
->
occup›d
--;

94 
	`sgx_th»ad_cÚd_sigÇl
(&
b
->
Ëss
);

95 
	`sgx_th»ad_mu‹x_uÆock
(&
b
->
mu‹x
);

97 
	}
}

	@main.c

	@mongoose.c

1 
	~"mÚgoo£.h
"

2 #ifdeà
MG_MODULE_LINES


10 #iâdeà
CS_MONGOOSE_SRC_INTERNAL_H_


11 
	#CS_MONGOOSE_SRC_INTERNAL_H_


	)

15 #iâdeà
MBUF_REALLOC


16 
	#MBUF_REALLOC
 
MG_REALLOC


	)

19 #iâdeà
MBUF_FREE


20 
	#MBUF_FREE
 
MG_FREE


	)

23 
	#MG_SET_PTRPTR
(
_±r
, 
_v
) \

25 ià(
_±r
è*(_±rèğ
_v
; \

26 } 0)

	)

28 #iâdeà
MG_INTERNAL


29 
	#MG_INTERNAL
 

	)

32 #ifdeà
PICOTCP


33 
	#NO_LIBC


	)

34 
	#MG_DISABLE_PFS


	)

41 
	#MG_CTL_MSG_MESSAGE_SIZE
 8192

	)

44 
MG_INTERNAL
 
mg_cÚÃùiÚ
 *
mg_do_cÚÃù
(mg_cÚÃùiÚ *
nc
,

45 
´Ùo
,

46 
sock‘_add»ss
 *
§
);

48 
MG_INTERNAL
 
mg_·r£_add»ss
(cÚ¡ *
¡r
, 
sock‘_add»ss
 *
§
,

49 *
´Ùo
, *
ho¡
, 
size_t
 
ho¡_Ën
);

50 
MG_INTERNAL
 
mg_ÿÎ
(
mg_cÚÃùiÚ
 *
nc
,

51 
mg_ev’t_hªdËr_t
 
ev_hªdËr
, *
u£r_d©a
, 
ev
,

52 *
ev_d©a
);

53 
mg_fÜw¬d
(
mg_cÚÃùiÚ
 *
äom
, mg_cÚÃùiÚ *
to
);

54 
MG_INTERNAL
 
mg_add_cÚn
(
mg_mgr
 *
mgr
, 
mg_cÚÃùiÚ
 *
c
);

55 
MG_INTERNAL
 
mg_»move_cÚn
(
mg_cÚÃùiÚ
 *
c
);

56 
MG_INTERNAL
 
mg_cÚÃùiÚ
 *
mg_ü—‹_cÚÃùiÚ
(

57 
mg_mgr
 *
mgr
, 
mg_ev’t_hªdËr_t
 
ÿÎback
,

58 
mg_add_sock_İts
 
İts
);

59 #ifdeà
_WIN32


61 
to_wch¬
(cÚ¡ *
·th
, 
wch¬_t
 *
wbuf
, 
size_t
 
wbuf_Ën
);

64 
	sùl_msg
 {

65 
mg_ev’t_hªdËr_t
 
	mÿÎback
;

66 
	mmes§ge
[
MG_CTL_MSG_MESSAGE_SIZE
];

69 #ià
MG_ENABLE_MQTT


70 
	gmg_mq‰_mes§ge
;

71 
MG_INTERNAL
 
·r£_mq‰
(
mbuf
 *
io
, 
mg_mq‰_mes§ge
 *
mm
);

75 *(*
‹¡_m®loc
)(
size_t
 
size
);

76 *(*
‹¡_ÿÎoc
)(
size_t
 
couÁ
, size_ˆ
size
);

78 #iâdeà
MIN


79 
	#MIN
(
a
, 
b
è(×è< (bè? (aè: (b))

	)

82 #ià
MG_ENABLE_HTTP


83 
	gmg_£rve_h‰p_İts
;

96 
MG_INTERNAL
 
size_t
 
mg_hªdË_chunked
(
mg_cÚÃùiÚ
 *
nc
,

97 
h‰p_mes§ge
 *
hm
, *
buf
,

98 
size_t
 
bËn
);

100 #ià
MG_ENABLE_FILESYSTEM


101 
MG_INTERNAL
 
mg_uri_to_loÿl_·th
(
h‰p_mes§ge
 *
hm
,

102 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
,

103 **
loÿl_·th
,

104 
mg_¡r
 *
»mašd”
);

105 
MG_INTERNAL
 
time_t
 
mg_·r£_d©e_¡ršg
(cÚ¡ *
d©‘ime
);

106 
MG_INTERNAL
 
mg_is_nÙ_modif›d
(
h‰p_mes§ge
 *
hm
, 
cs_¡©_t
 *
¡
);

108 #ià
MG_ENABLE_HTTP_CGI


109 
MG_INTERNAL
 
mg_hªdË_cgi
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
´og
,

110 cÚ¡ 
mg_¡r
 *
·th_šfo
,

111 cÚ¡ 
h‰p_mes§ge
 *
hm
,

112 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
);

113 
	gmg_h‰p_´Ùo_d©a_cgi
;

114 
MG_INTERNAL
 
mg_h‰p_ä“_´Ùo_d©a_cgi
(
mg_h‰p_´Ùo_d©a_cgi
 *
d
);

116 #ià
MG_ENABLE_HTTP_SSI


117 
MG_INTERNAL
 
mg_hªdË_ssi_»que¡
(
mg_cÚÃùiÚ
 *
nc
,

118 
h‰p_mes§ge
 *
hm
,

119 cÚ¡ *
·th
,

120 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
);

122 #ià
MG_ENABLE_HTTP_WEBDAV


123 
MG_INTERNAL
 
mg_is_dav_»que¡
(cÚ¡ 
mg_¡r
 *
s
);

124 
MG_INTERNAL
 
mg_hªdË_´İfšd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

125 
cs_¡©_t
 *
¡p
, 
h‰p_mes§ge
 *
hm
,

126 
mg_£rve_h‰p_İts
 *
İts
);

127 
MG_INTERNAL
 
mg_hªdË_lock
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
);

128 
MG_INTERNAL
 
mg_hªdË_mkcŞ
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

129 
h‰p_mes§ge
 *
hm
);

130 
MG_INTERNAL
 
mg_hªdË_move
(
mg_cÚÃùiÚ
 *
c
,

131 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
,

132 cÚ¡ *
·th
, 
h‰p_mes§ge
 *
hm
);

133 
MG_INTERNAL
 
mg_hªdË_d–‘e
(
mg_cÚÃùiÚ
 *
nc
,

134 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
,

135 cÚ¡ *
·th
);

136 
MG_INTERNAL
 
mg_hªdË_put
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

137 
h‰p_mes§ge
 *
hm
);

139 #ià
MG_ENABLE_HTTP_WEBSOCKET


140 
MG_INTERNAL
 
mg_ws_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
,

141 *
ev_d©a
 
MG_UD_ARG
(*
u£r_d©a
));

142 
MG_INTERNAL
 
mg_ws_hªdshake
(
mg_cÚÃùiÚ
 *
nc
,

143 cÚ¡ 
mg_¡r
 *
key
,

144 
h‰p_mes§ge
 *);

148 
MG_INTERNAL
 
mg_g‘_”ºo
();

150 
MG_INTERNAL
 
mg_şo£_cÚn
(
mg_cÚÃùiÚ
 *
cÚn
);

152 #ià
MG_ENABLE_SNTP


153 
MG_INTERNAL
 
mg_¢_·r£_»¶y
(cÚ¡ *
buf
, 
Ën
,

154 
mg_¢_mes§ge
 *
msg
);

158 #ifdeà
MG_MODULE_LINES


166 #iâdeà
CS_COMMON_MG_MEM_H_


167 
	#CS_COMMON_MG_MEM_H_


	)

169 #ifdeà
__ılu¥lus


173 #iâdeà
MG_MALLOC


174 
	#MG_MALLOC
 
m®loc


	)

177 #iâdeà
MG_CALLOC


178 
	#MG_CALLOC
 
ÿÎoc


	)

181 #iâdeà
MG_REALLOC


182 
	#MG_REALLOC
 
»®loc


	)

185 #iâdeà
MG_FREE


186 
	#MG_FREE
 
ä“


	)

189 #ifdeà
__ılu¥lus


194 #ifdeà
MG_MODULE_LINES


202 #iâdeà
CS_COMMON_CS_DBG_H_


203 
	#CS_COMMON_CS_DBG_H_


	)

207 #ià
CS_ENABLE_STDIO


208 
	~<¡dio.h
>

211 #iâdeà
CS_ENABLE_DEBUG


212 
	#CS_ENABLE_DEBUG
 0

	)

215 #iâdeà
CS_LOG_ENABLE_TS_DIFF


216 
	#CS_LOG_ENABLE_TS_DIFF
 0

	)

219 #ifdeà
__ılu¥lus


223 
	ecs_log_Ëv–
 {

224 
LL_NONE
 = -1,

225 
LL_ERROR
 = 0,

226 
LL_WARN
 = 1,

227 
LL_INFO
 = 2,

228 
LL_DEBUG
 = 3,

229 
LL_VERBOSE_DEBUG
 = 4,

231 
_LL_MIN
 = -2,

232 
_LL_MAX
 = 5,

236 
cs_log_£t_Ëv–
(
cs_log_Ëv–
 
Ëv–
);

239 
cs_log_£t_f‹r
(cÚ¡ *
sourû_fe_Çme
);

241 
cs_log_´št_´efix
(
cs_log_Ëv–
 
Ëv–
, cÚ¡ *
func
,

242 cÚ¡ *
f’ame
);

244 
cs_log_Ëv–
 
cs_log_th»shŞd
;

246 #ià
CS_ENABLE_STDIO


248 
cs_log_£t_fe
(
FILE
 *
fe
);

249 
cs_log_´štf
(cÚ¡ *
fmt
, ...)

250 #ifdeà
__GNUC__


251 
__©Œibu‹__
((
fÜm©
(
´štf
, 1, 2)))

255 
	#LOG
(
l
, 
x
) \

257 ià(
	`cs_log_´št_´efix
(
l
, 
__func__
, 
__FILE__
)è
cs_log_´štf
 
x
; \

258 } 0)

	)

260 #iâdeà
CS_NDEBUG


262 
	#DBG
(
x
è
	`LOG
(
LL_VERBOSE_DEBUG
, x)

	)

266 
	#DBG
(
x
)

	)

272 
	#LOG
(
l
, 
x
)

	)

273 
	#DBG
(
x
)

	)

277 #ifdeà
__ılu¥lus


282 #ifdeà
MG_MODULE_LINES


292 
	~<¡d¬g.h
>

293 
	~<¡dio.h
>

294 
	~<¡ršg.h
>

299 
cs_log_Ëv–
 
cs_log_th»shŞd
 
	gWEAK
 =

300 #ià
CS_ENABLE_DEBUG


301 
LL_VERBOSE_DEBUG
;

303 
	gLL_ERROR
;

306 *
	gs_f‹r_·‰”n
 = 
NULL
;

307 
size_t
 
	gs_f‹r_·‰”n_Ën
;

309 #ià
CS_ENABLE_STDIO


311 
FILE
 *
cs_log_fe
 
	gWEAK
 = 
NULL
;

313 #ià
CS_LOG_ENABLE_TS_DIFF


314 
cs_log_ts
 
	gWEAK
;

317 
cs_log_Ëv–
 
cs_log_cur_msg_Ëv–
 
	gWEAK
 = 
LL_NONE
;

319 
cs_log_£t_f‹r
(cÚ¡ *
¡r
è
	gWEAK
;

320 
cs_log_£t_f‹r
(cÚ¡ *
¡r
) {

321 
ä“
(
s_f‹r_·‰”n
);

322 ià(
	g¡r
 !ğ
NULL
) {

323 
s_f‹r_·‰”n
 = 
¡rdup
(
¡r
);

324 
	gs_f‹r_·‰”n_Ën
 = 
¡¾’
(
¡r
);

326 
	gs_f‹r_·‰”n
 = 
NULL
;

327 
	gs_f‹r_·‰”n_Ën
 = 0;

331 
cs_log_´št_´efix
(
cs_log_Ëv–
, cÚ¡ *, cÚ¡ *è
	gWEAK
;

332 
cs_log_´št_´efix
(
cs_log_Ëv–
 
Ëv–
, cÚ¡ *
func
,

333 cÚ¡ *
f’ame
) {

334 
	g´efix
[21];

336 ià(
	gËv–
 > 
	gcs_log_th»shŞd
)  0;

337 ià(
	gs_f‹r_·‰”n
 !ğ
NULL
 &&

338 
mg_m©ch_´efix
(
s_f‹r_·‰”n
, 
s_f‹r_·‰”n_Ën
, 
func
) < 0 &&

339 
mg_m©ch_´efix
(
s_f‹r_·‰”n
, 
s_f‹r_·‰”n_Ën
, 
f’ame
) < 0) {

343 
¡ºıy
(
´efix
, 
func
, 20);

344 
	g´efix
[20] = '\0';

345 ià(
	gcs_log_fe
 =ğ
NULL
è
cs_log_fe
 = 
¡d”r
;

346 
	gcs_log_cur_msg_Ëv–
 = 
Ëv–
;

347 
årštf
(
cs_log_fe
, "%-20 ", 
´efix
);

348 #ià
CS_LOG_ENABLE_TS_DIFF


350 
	gnow
 = 
cs_time
();

351 
årštf
(
cs_log_fe
, "%7u ", (è((
now
 - 
cs_log_ts
) * 1000000));

352 
	gcs_log_ts
 = 
now
;

358 
cs_log_´štf
(cÚ¡ *
fmt
, ...è
	gWEAK
;

359 
cs_log_´štf
(cÚ¡ *
fmt
, ...) {

360 
va_li¡
 
	g­
;

361 
va_¡¬t
(
­
, 
fmt
);

362 
vårštf
(
cs_log_fe
, 
fmt
, 
­
);

363 
va_’d
(
­
);

364 
åutc
('\n', 
cs_log_fe
);

365 
fæush
(
cs_log_fe
);

366 
	gcs_log_cur_msg_Ëv–
 = 
LL_NONE
;

369 
cs_log_£t_fe
(
FILE
 *
fe
è
	gWEAK
;

370 
cs_log_£t_fe
(
FILE
 *
fe
) {

371 
	gcs_log_fe
 = 
fe
;

376 
cs_log_£t_Ëv–
(
cs_log_Ëv–
 
Ëv–
è
	gWEAK
;

377 
cs_log_£t_Ëv–
(
cs_log_Ëv–
 
Ëv–
) {

378 
	gcs_log_th»shŞd
 = 
Ëv–
;

379 #ià
CS_LOG_ENABLE_TS_DIFF
 && 
CS_ENABLE_STDIO


380 
	gcs_log_ts
 = 
cs_time
();

383 #ifdeà
MG_MODULE_LINES


391 #iâdeà
EXCLUDE_COMMON


395 
	~<¡ršg.h
>

401 
	#NUM_UPPERCASES
 ('Z' - 'A' + 1)

	)

402 
	#NUM_LETTERS
 (
NUM_UPPERCASES
 * 2)

	)

403 
	#NUM_DIGITS
 ('9' - '0' + 1)

	)

410 
cs_ba£64_em™_code
(
cs_ba£64_ùx
 *
ùx
, 
v
) {

411 ià(
	gv
 < 
	gNUM_UPPERCASES
) {

412 
	gùx
->
b64_putc
(
v
 + 'A', 
ùx
->
u£r_d©a
);

413 } ià(
	gv
 < (
	gNUM_LETTERS
)) {

414 
	gùx
->
b64_putc
(
v
 - 
NUM_UPPERCASES
 + 'a', 
ùx
->
u£r_d©a
);

415 } ià(
	gv
 < (
	gNUM_LETTERS
 + 
	gNUM_DIGITS
)) {

416 
	gùx
->
b64_putc
(
v
 - 
NUM_LETTERS
 + '0', 
ùx
->
u£r_d©a
);

418 
	gùx
->
b64_putc
(
v
 - 
NUM_LETTERS
 - 
NUM_DIGITS
 == 0 ? '+' : '/',

419 
ùx
->
u£r_d©a
);

423 
cs_ba£64_em™_chunk
(
cs_ba£64_ùx
 *
ùx
) {

424 
	ga
, 
	gb
, 
	gc
;

426 
	ga
 = 
ùx
->
chunk
[0];

427 
	gb
 = 
ùx
->
chunk
[1];

428 
	gc
 = 
ùx
->
chunk
[2];

430 
cs_ba£64_em™_code
(
ùx
, 
a
 >> 2);

431 
cs_ba£64_em™_code
(
ùx
, ((
a
 & 3è<< 4è| (
b
 >> 4));

432 ià(
	gùx
->
	gchunk_size
 > 1) {

433 
cs_ba£64_em™_code
(
ùx
, (
b
 & 15è<< 2 | (
c
 >> 6));

435 ià(
	gùx
->
	gchunk_size
 > 2) {

436 
cs_ba£64_em™_code
(
ùx
, 
c
 & 63);

440 
cs_ba£64_š™
(
cs_ba£64_ùx
 *
ùx
, 
cs_ba£64_putc_t
 
b64_putc
,

441 *
u£r_d©a
) {

442 
	gùx
->
	gchunk_size
 = 0;

443 
	gùx
->
	gb64_putc
 = 
b64_putc
;

444 
	gùx
->
	gu£r_d©a
 = 
u£r_d©a
;

447 
cs_ba£64_upd©e
(
cs_ba£64_ùx
 *
ùx
, cÚ¡ *
¡r
, 
size_t
 
Ën
) {

448 cÚ¡ *
	g¤c
 = (cÚ¡ *è
¡r
;

449 
size_t
 
	gi
;

450 
	gi
 = 0; i < 
	gËn
; i++) {

451 
	gùx
->
	gchunk
[
ùx
->
chunk_size
++] = 
¤c
[
i
];

452 ià(
	gùx
->
	gchunk_size
 == 3) {

453 
cs_ba£64_em™_chunk
(
ùx
);

454 
	gùx
->
	gchunk_size
 = 0;

459 
cs_ba£64_fšish
(
cs_ba£64_ùx
 *
ùx
) {

460 ià(
	gùx
->
	gchunk_size
 > 0) {

461 
	gi
;

462 
mem£t
(&
ùx
->
chunk
[ùx->
chunk_size
], 0, 3 - ctx->chunk_size);

463 
cs_ba£64_em™_chunk
(
ùx
);

464 
	gi
 = 0; i < (3 - 
	gùx
->
	gchunk_size
); i++) {

465 
	gùx
->
b64_putc
('=', 
ùx
->
u£r_d©a
);

470 
	#BASE64_ENCODE_BODY
 \

471 cÚ¡ *
b64
 = \

473 
i
, 
j
, 
a
, 
b
, 
c
; \

475 
i
 = 
j
 = 0; i < 
¤c_Ën
; i += 3) { \

476 
a
 = 
¤c
[
i
]; \

477 
b
 = 
i
 + 1 >ğ
¤c_Ën
 ? 0 : 
¤c
[i + 1]; \

478 
c
 = 
i
 + 2 >ğ
¤c_Ën
 ? 0 : 
¤c
[i + 2]; \

480 
	`BASE64_OUT
(
b64
[
a
 >> 2]); \

481 
	`BASE64_OUT
(
b64
[((
a
 & 3è<< 4è| (
b
 >> 4)]); \

482 ià(
i
 + 1 < 
¤c_Ën
) { \

483 
	`BASE64_OUT
(
b64
[(
b
 & 15è<< 2 | (
c
 >> 6)]); \

485 ià(
i
 + 2 < 
¤c_Ën
) { \

486 
	`BASE64_OUT
(
b64
[
c
 & 63]); \

490 
j
 % 4 != 0) { \

491 
	`BASE64_OUT
('='); \

493 
	`BASE64_FLUSH
()

	)

495 
	#BASE64_OUT
(
ch
) \

497 
d¡
[
j
++] = (
ch
); \

498 } 0)

	)

500 
	#BASE64_FLUSH
() \

502 
d¡
[
j
++] = '\0'; \

503 } 0)

	)

505 
cs_ba£64_’code
(cÚ¡ *
¤c
, 
¤c_Ën
, *
d¡
) {

506 
	gBASE64_ENCODE_BODY
;

509 #undeà
BASE64_OUT


510 #undeà
BASE64_FLUSH


512 #ià
CS_ENABLE_STDIO


513 
	#BASE64_OUT
(
ch
) \

515 
	`årštf
(
f
, "%c", (
ch
)); \

516 
j
++; \

517 } 0)

	)

519 
	#BASE64_FLUSH
()

	)

521 
cs_åršt_ba£64
(
FILE
 *
f
, cÚ¡ *
¤c
, 
¤c_Ën
) {

522 
	gBASE64_ENCODE_BODY
;

525 #undeà
BASE64_OUT


526 #undeà
BASE64_FLUSH


530 
äom_b64
(
ch
) {

532 cÚ¡ 
	gb
[128] = {

566  
	gb
[
ch
 & 127];

569 
cs_ba£64_decode
(cÚ¡ *
s
, 
Ën
, *
d¡
, *
dec_Ën
) {

570 
	ga
, 
	gb
, 
	gc
, 
	gd
;

571 
	gÜig_Ën
 = 
Ën
;

572 *
	gÜig_d¡
 = 
d¡
;

573 
	gËn
 >ğ4 && (
a
 = 
äom_b64
(
s
[0])) != 255 &&

574 (
b
 = 
äom_b64
(
s
[1])è!ğ255 && (
c
 = from_b64(s[2])) != 255 &&

575 (
d
 = 
äom_b64
(
s
[3])) != 255) {

576 
s
 += 4;

577 
	gËn
 -= 4;

578 ià(
	ga
 =ğ200 || 
b
 == 200) ;

579 *
	gd¡
++ = 
a
 << 2 | 
b
 >> 4;

580 ià(
	gc
 == 200) ;

581 *
	gd¡
++ = 
b
 << 4 | 
c
 >> 2;

582 ià(
	gd
 == 200) ;

583 *
	gd¡
++ = 
c
 << 6 | 
d
;

585 *
	gd¡
 = 0;

586 ià(
	gdec_Ën
 !ğ
NULL
è*
dec_Ën
 = (
d¡
 - 
Üig_d¡
);

587  
	gÜig_Ën
 - 
	gËn
;

591 #ifdeà
MG_MODULE_LINES


599 #iâdeà
CS_COMMON_CS_DIRENT_H_


600 
	#CS_COMMON_CS_DIRENT_H_


	)

602 
	~<lim™s.h
>

606 #ifdeà
__ılu¥lus


610 #ifdeà
CS_DEFINE_DIRENT


611 ¡ruù { 
dummy
; } 
	tDIR
;

613 
	sdœ’t
 {

614 
	gd_šo
;

615 #ifdeà
_WIN32


616 
	gd_Çme
[
MAX_PATH
];

619 
	gd_Çme
[256];

623 
DIR
 *
İ’dœ
(cÚ¡ *
dœ_Çme
);

624 
şo£dœ
(
DIR
 *
dœ
);

625 
dœ’t
 *
»addœ
(
DIR
 *
dœ
);

628 #ifdeà
__ılu¥lus


633 #ifdeà
MG_MODULE_LINES


641 #iâdeà
EXCLUDE_COMMON


651 #ifdeà
_WIN32


652 
	swš32_dœ
 {

653 
DIR
 
	gd
;

654 
HANDLE
 
	ghªdË
;

655 
WIN32_FIND_DATAW
 
	gšfo
;

656 
dœ’t
 
	g»suÉ
;

659 
DIR
 *
İ’dœ
(cÚ¡ *
Çme
) {

660 
wš32_dœ
 *
	gdœ
 = 
NULL
;

661 
wch¬_t
 
	gw·th
[
MAX_PATH
];

662 
DWORD
 
	g©Œs
;

664 ià(
	gÇme
 =ğ
NULL
) {

665 
S‘La¡E¼Ü
(
ERROR_BAD_ARGUMENTS
);

666 } ià((
	gdœ
 = (
wš32_dœ
 *è
MG_MALLOC
((*
dœ
))è=ğ
NULL
) {

667 
S‘La¡E¼Ü
(
ERROR_NOT_ENOUGH_MEMORY
);

669 
to_wch¬
(
Çme
, 
w·th
, 
ARRAY_SIZE
(wpath));

670 
	g©Œs
 = 
G‘FeA‰ribu‹sW
(
w·th
);

671 ià(
	g©Œs
 !ğ0xFFFFFFFF && (
©Œs
 & 
FILE_ATTRIBUTE_DIRECTORY
)) {

672 (è
wcsÿt
(
w·th
, 
L
"\\*");

673 
	gdœ
->
	ghªdË
 = 
FšdFœ¡FeW
(
w·th
, &
dœ
->
šfo
);

674 
	gdœ
->
	g»suÉ
.
	gd_Çme
[0] = '\0';

676 
MG_FREE
(
dœ
);

677 
	gdœ
 = 
NULL
;

681  (
	gDIR
 *è
	gdœ
;

684 
şo£dœ
(
DIR
 *
d
) {

685 
wš32_dœ
 *
	gdœ
 = (wš32_dœ *è
d
;

686 
	g»suÉ
 = 0;

688 ià(
	gdœ
 !ğ
NULL
) {

689 ià(
dœ
->
hªdË
 !ğ
INVALID_HANDLE_VALUE
)

690 
»suÉ
 = 
FšdClo£
(
dœ
->
hªdË
) ? 0 : -1;

691 
MG_FREE
(
dœ
);

693 
	g»suÉ
 = -1;

694 
S‘La¡E¼Ü
(
ERROR_BAD_ARGUMENTS
);

697  
	g»suÉ
;

700 
dœ’t
 *
»addœ
(
DIR
 *
d
) {

701 
wš32_dœ
 *
	gdœ
 = (wš32_dœ *è
d
;

702 
dœ’t
 *
	g»suÉ
 = 
NULL
;

704 ià(
	gdœ
) {

705 
mem£t
(&
dœ
->
»suÉ
, 0, (dir->result));

706 ià(
	gdœ
->
	ghªdË
 !ğ
INVALID_HANDLE_VALUE
) {

707 
»suÉ
 = &
dœ
->result;

708 (è
WideCh¬ToMuÉiBy‹
(
CP_UTF8
, 0, 
dœ
->
šfo
.
cFeName
, -1,

709 
»suÉ
->
d_Çme
, ÔesuÉ->d_Çme), 
NULL
,

710 
NULL
);

712 ià(!
FšdNextFeW
(
dœ
->
hªdË
, &dœ->
šfo
)) {

713 (è
FšdClo£
(
dœ
->
hªdË
);

714 
	gdœ
->
	ghªdË
 = 
INVALID_HANDLE_VALUE
;

718 
S‘La¡E¼Ü
(
ERROR_FILE_NOT_FOUND
);

721 
S‘La¡E¼Ü
(
ERROR_BAD_ARGUMENTS
);

724  
	g»suÉ
;

731 
	tcs_dœ’t_dummy
;

732 #ifdeà
MG_MODULE_LINES


742 #iâdeà
_WIN32


743 
	~<¡ddef.h
>

747 #ià!(
defšed
(
__ARMCC_VERSION
è|| defšed(
__ICCARM__
)) && \

748 !
defšed
(
__TI_COMPILER_VERSION__
) && \

749 (!
defšed
(
CS_PLATFORM
è|| 
	gCS_PLATFORM
 !ğ
CS_P_NXP_LPC
)

750 
	~<sys/time.h
>

753 
	~<wšdows.h
>

756 
cs_time
(è
WEAK
;

757 
cs_time
() {

758 
	gnow
;

759 #iâdeà
_WIN32


760 
timev®
 
	gtv
;

761 ià(
g‘timeofday
(&
tv
, 
NULL
 ) != 0)  0;

762 
	gnow
 = (è
tv
.
tv_£c
 + (((ètv.
tv_u£c
) / 1000000.0);

764 
SYSTEMTIME
 
	gsy¢ow
;

765 
FILETIME
 
	gáime
;

766 
G‘LoÿlTime
(&
sy¢ow
);

767 
Sy¡emTimeToFeTime
(&
sy¢ow
, &
áime
);

776 
	gnow
 = (è(((
št64_t
è
áime
.
dwLowD©eTime
 +

777 ((
št64_t
è
áime
.
dwHighD©eTime
 << 32)) /

781  
	gnow
;

784 
cs_timegm
(cÚ¡ 
tm
 *tm) {

786 cÚ¡ 
	gmÚth_day
[12] = {0, 31, 59, 90, 120, 151,

790 
	gmÚth
 = 
tm
->
tm_mÚ
 % 12;

791 
	gy—r
 = 
tm
->
tm_y—r
 +m->
tm_mÚ
 / 12;

792 
	gy—r_fÜ_Ë­
;

793 
št64_t
 
	g¹
;

795 ià(
	gmÚth
 < 0) {

796 
	gmÚth
 += 12;

797 --
	gy—r
;

801 
	gy—r_fÜ_Ë­
 = (
mÚth
 > 1è? 
y—r
 + 1 : year;

803 
	g¹
 =

804 
tm
->
tm_£c


807 (
tm
->
tm_mš


809 60 * (
tm
->
tm_hour


811 24 * (
mÚth_day
[
mÚth
] + 
tm
->
tm_mday
 - 1

812 + 365 * (
y—r
 - 70)

813 + (
y—r_fÜ_Ë­
 - 69) / 4

814 - (
y—r_fÜ_Ë­
 - 1) / 100

815 + (
y—r_fÜ_Ë­
 + 299) / 400)));

816  
	g¹
 < 0 ? -1 : (è
¹
;

818 #ifdeà
MG_MODULE_LINES


826 #iâdeà
CS_COMMON_CS_ENDIAN_H_


827 
	#CS_COMMON_CS_ENDIAN_H_


	)

829 #ifdeà
__ılu¥lus


838 #ià!
defšed
(
BYTE_ORDER
è&& defšed(
__BYTE_ORDER
)

839 
	#BYTE_ORDER
 
__BYTE_ORDER


	)

840 #iâdeà
LITTLE_ENDIAN


841 
	#LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

843 #iâdeà
BIG_ENDIAN


844 
	#BIG_ENDIAN
 
__LITTLE_ENDIAN


	)

848 #ifdeà
__ılu¥lus


853 #ifdeà
MG_MODULE_LINES


876 #ià!
defšed
(
EXCLUDE_COMMON
)

877 #ià!
CS_DISABLE_MD5


881 
by‹Rev”£
(*
buf
, 
lÚgs
) {

883 #ià
BYTE_ORDER
 =ğ
BIG_ENDIAN


885 
ušt32_t
 
t
 = (ušt32_t)((è
buf
[3] << 8 | buf[2]) << 16 |

886 ((è
buf
[1] << 8 | buf[0]);

887 *(
ušt32_t
 *è
buf
 = 
t
;

888 
buf
 += 4;

889 } --
lÚgs
);

891 (è
buf
;

892 (è
lÚgs
;

896 
	#F1
(
x
, 
y
, 
z
è(z ^ (x & (y ^ z)))

	)

897 
	#F2
(
x
, 
y
, 
z
è
	`F1
(z, x, y)

	)

898 
	#F3
(
x
, 
y
, 
z
è(x ^ y ^ z)

	)

899 
	#F4
(
x
, 
y
, 
z
è(y ^ (x | ~z))

	)

901 
	#MD5STEP
(
f
, 
w
, 
x
, 
y
, 
z
, 
d©a
, 
s
) \

902 (
w
 +ğ
	`f
(
x
, 
y
, 
z
è+ 
d©a
, w = w << 
s
 | w >> (32 - s), w +ğx)

	)

908 
cs_md5_š™
(
cs_md5_ùx
 *
ùx
) {

909 
ùx
->
buf
[0] = 0x67452301;

910 
ùx
->
buf
[1] = 0xefcdab89;

911 
ùx
->
buf
[2] = 0x98badcfe;

912 
ùx
->
buf
[3] = 0x10325476;

914 
ùx
->
b™s
[0] = 0;

915 
ùx
->
b™s
[1] = 0;

918 
cs_md5_ŒªsfÜm
(
ušt32_t
 
buf
[4], ušt32_ˆcÚ¡ 
š
[16]) {

919 
ušt32_t
 
a
, 
b
, 
c
, 
d
;

921 
a
 = 
buf
[0];

922 
b
 = 
buf
[1];

923 
c
 = 
buf
[2];

924 
d
 = 
buf
[3];

926 
MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
š
[0] + 0xd76aa478, 7);

927 
MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
š
[1] + 0xe8c7b756, 12);

928 
MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
š
[2] + 0x242070db, 17);

929 
MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
š
[3] + 0xc1bdceee, 22);

930 
MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
š
[4] + 0xf57c0faf, 7);

931 
MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
š
[5] + 0x4787c62a, 12);

932 
MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
š
[6] + 0xa8304613, 17);

933 
MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
š
[7] + 0xfd469501, 22);

934 
MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
š
[8] + 0x698098d8, 7);

935 
MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
š
[9] + 0x8b44f7af, 12);

936 
MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
š
[10] + 0xffff5bb1, 17);

937 
MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
š
[11] + 0x895cd7be, 22);

938 
MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
š
[12] + 0x6b901122, 7);

939 
MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
š
[13] + 0xfd987193, 12);

940 
MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
š
[14] + 0xa679438e, 17);

941 
MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
š
[15] + 0x49b40821, 22);

943 
MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
š
[1] + 0xf61e2562, 5);

944 
MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
š
[6] + 0xc040b340, 9);

945 
MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
š
[11] + 0x265e5a51, 14);

946 
MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
š
[0] + 0xe9b6c7aa, 20);

947 
MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
š
[5] + 0xd62f105d, 5);

948 
MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
š
[10] + 0x02441453, 9);

949 
MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
š
[15] + 0xd8a1e681, 14);

950 
MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
š
[4] + 0xe7d3fbc8, 20);

951 
MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
š
[9] + 0x21e1cde6, 5);

952 
MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
š
[14] + 0xc33707d6, 9);

953 
MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
š
[3] + 0xf4d50d87, 14);

954 
MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
š
[8] + 0x455a14ed, 20);

955 
MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
š
[13] + 0xa9e3e905, 5);

956 
MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
š
[2] + 0xfcefa3f8, 9);

957 
MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
š
[7] + 0x676f02d9, 14);

958 
MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
š
[12] + 0x8d2a4c8a, 20);

960 
MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
š
[5] + 0xfffa3942, 4);

961 
MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
š
[8] + 0x8771f681, 11);

962 
MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
š
[11] + 0x6d9d6122, 16);

963 
MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
š
[14] + 0xfde5380c, 23);

964 
MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
š
[1] + 0xa4beea44, 4);

965 
MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
š
[4] + 0x4bdecfa9, 11);

966 
MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
š
[7] + 0xf6bb4b60, 16);

967 
MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
š
[10] + 0xbebfbc70, 23);

968 
MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
š
[13] + 0x289b7ec6, 4);

969 
MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
š
[0] + 0xeaa127fa, 11);

970 
MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
š
[3] + 0xd4ef3085, 16);

971 
MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
š
[6] + 0x04881d05, 23);

972 
MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
š
[9] + 0xd9d4d039, 4);

973 
MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
š
[12] + 0xe6db99e5, 11);

974 
MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
š
[15] + 0x1fa27cf8, 16);

975 
MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
š
[2] + 0xc4ac5665, 23);

977 
MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
š
[0] + 0xf4292244, 6);

978 
MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
š
[7] + 0x432aff97, 10);

979 
MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
š
[14] + 0xab9423a7, 15);

980 
MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
š
[5] + 0xfc93a039, 21);

981 
MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
š
[12] + 0x655b59c3, 6);

982 
MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
š
[3] + 0x8f0ccc92, 10);

983 
MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
š
[10] + 0xffeff47d, 15);

984 
MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
š
[1] + 0x85845dd1, 21);

985 
MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
š
[8] + 0x6fa87e4f, 6);

986 
MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
š
[15] + 0xfe2ce6e0, 10);

987 
MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
š
[6] + 0xa3014314, 15);

988 
MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
š
[13] + 0x4e0811a1, 21);

989 
MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
š
[4] + 0xf7537e82, 6);

990 
MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
š
[11] + 0xbd3af235, 10);

991 
MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
š
[2] + 0x2ad7d2bb, 15);

992 
MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
š
[9] + 0xeb86d391, 21);

994 
buf
[0] +ğ
a
;

995 
buf
[1] +ğ
b
;

996 
buf
[2] +ğ
c
;

997 
buf
[3] +ğ
d
;

1000 
cs_md5_upd©e
(
cs_md5_ùx
 *
ùx
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

1001 
ušt32_t
 
t
;

1003 
t
 = 
ùx
->
b™s
[0];

1004 ià((
ùx
->
b™s
[0] = 
t
 + ((
ušt32_t
è
Ën
 << 3)) <) ctx->bits[1]++;

1005 
ùx
->
b™s
[1] +ğ(
ušt32_t
è
Ën
 >> 29;

1007 
t
 = (t >> 3) & 0x3f;

1009 ià(
t
) {

1010 *
p
 = (*è
ùx
->
š
 + 
t
;

1012 
t
 = 64 -;

1013 ià(
Ën
 < 
t
) {

1014 
memıy
(
p
, 
buf
, 
Ën
);

1017 
memıy
(
p
, 
buf
, 
t
);

1018 
by‹Rev”£
(
ùx
->
š
, 16);

1019 
cs_md5_ŒªsfÜm
(
ùx
->
buf
, (
ušt32_t
 *èùx->
š
);

1020 
buf
 +ğ
t
;

1021 
Ën
 -ğ
t
;

1024 
Ën
 >= 64) {

1025 
memıy
(
ùx
->
š
, 
buf
, 64);

1026 
by‹Rev”£
(
ùx
->
š
, 16);

1027 
cs_md5_ŒªsfÜm
(
ùx
->
buf
, (
ušt32_t
 *èùx->
š
);

1028 
buf
 += 64;

1029 
Ën
 -= 64;

1032 
memıy
(
ùx
->
š
, 
buf
, 
Ën
);

1035 
cs_md5_fš®
(
dige¡
[16], 
cs_md5_ùx
 *
ùx
) {

1036 
couÁ
;

1037 *
p
;

1038 
ušt32_t
 *
a
;

1040 
couÁ
 = (
ùx
->
b™s
[0] >> 3) & 0x3F;

1042 
p
 = 
ùx
->
š
 + 
couÁ
;

1043 *
p
++ = 0x80;

1044 
couÁ
 = 64 - 1 - count;

1045 ià(
couÁ
 < 8) {

1046 
mem£t
(
p
, 0, 
couÁ
);

1047 
by‹Rev”£
(
ùx
->
š
, 16);

1048 
cs_md5_ŒªsfÜm
(
ùx
->
buf
, (
ušt32_t
 *èùx->
š
);

1049 
mem£t
(
ùx
->
š
, 0, 56);

1051 
mem£t
(
p
, 0, 
couÁ
 - 8);

1053 
by‹Rev”£
(
ùx
->
š
, 14);

1055 
a
 = (
ušt32_t
 *è
ùx
->
š
;

1056 
a
[14] = 
ùx
->
b™s
[0];

1057 
a
[15] = 
ùx
->
b™s
[1];

1059 
cs_md5_ŒªsfÜm
(
ùx
->
buf
, (
ušt32_t
 *èùx->
š
);

1060 
by‹Rev”£
((*è
ùx
->
buf
, 4);

1061 
memıy
(
dige¡
, 
ùx
->
buf
, 16);

1062 
mem£t
((*è
ùx
, 0, (*ctx));

1067 #ifdeà
MG_MODULE_LINES


1075 #ià!
CS_DISABLE_SHA1
 && !
defšed
(
EXCLUDE_COMMON
)

1079 
	#SHA1HANDSOFF


	)

1080 #ià
defšed
(
__sun
)

1084 
	uch¬64lÚg16
 {

1085 
c
[64];

1086 
ušt32_t
 
l
[16];

1089 
	#rŞ
(
v®ue
, 
b™s
è(((v®ueè<< (b™s)è| ((v®ueè>> (32 - (b™s))))

	)

1091 
ušt32_t
 
blk0
(
ch¬64lÚg16
 *
block
, 
i
) {

1093 #ià
BYTE_ORDER
 =ğ
LITTLE_ENDIAN


1094 
block
->
l
[
i
] =

1095 (
rŞ
(
block
->
l
[
i
], 24) & 0xFF00FF00) | (rol(block->l[i], 8) & 0x00FF00FF);

1097  
block
->
l
[
i
];

1101 #undeà
blk


1102 #undeà
R0


1103 #undeà
R1


1104 #undeà
R2


1105 #undeà
R3


1106 #undeà
R4


1108 
	#blk
(
i
) \

1109 (
block
->
l
[
i
 & 15] = 
	`rŞ
(block->l[(i + 13) & 15] ^ block->l[(i + 8) & 15] ^ \

1110 
block
->
l
[(
i
 + 2) & 15] ^ block->l[i & 15], \

1111 1))

	)

1112 
	#R0
(
v
, 
w
, 
x
, 
y
, 
z
, 
i
) \

1113 
z
 +ğ((
w
 & (
x
 ^ 
y
)è^ yè+ 
	`blk0
(
block
, 
i
è+ 0x5A827999 + 
	`rŞ
(
v
, 5); \

1114 
w
 = 
	`rŞ
(w, 30);

	)

1115 
	#R1
(
v
, 
w
, 
x
, 
y
, 
z
, 
i
) \

1116 
z
 +ğ((
w
 & (
x
 ^ 
y
)è^ yè+ 
	`blk
(
i
è+ 0x5A827999 + 
	`rŞ
(
v
, 5); \

1117 
w
 = 
	`rŞ
(w, 30);

	)

1118 
	#R2
(
v
, 
w
, 
x
, 
y
, 
z
, 
i
) \

1119 
z
 +ğ(
w
 ^ 
x
 ^ 
y
è+ 
	`blk
(
i
è+ 0x6ED9EBA1 + 
	`rŞ
(
v
, 5); \

1120 
w
 = 
	`rŞ
(w, 30);

	)

1121 
	#R3
(
v
, 
w
, 
x
, 
y
, 
z
, 
i
) \

1122 
z
 +ğ(((
w
 | 
x
è& 
y
è| (w & x)è+ 
	`blk
(
i
è+ 0x8F1BBCDC + 
	`rŞ
(
v
, 5); \

1123 
w
 = 
	`rŞ
(w, 30);

	)

1124 
	#R4
(
v
, 
w
, 
x
, 
y
, 
z
, 
i
) \

1125 
z
 +ğ(
w
 ^ 
x
 ^ 
y
è+ 
	`blk
(
i
è+ 0xCA62C1D6 + 
	`rŞ
(
v
, 5); \

1126 
w
 = 
	`rŞ
(w, 30);

	)

1128 
cs_sha1_ŒªsfÜm
(
ušt32_t
 
¡©e
[5], cÚ¡ 
bufãr
[64]) {

1129 
ušt32_t
 
a
, 
b
, 
c
, 
d
, 
e
;

1130 
ch¬64lÚg16
 
block
[1];

1132 
memıy
(
block
, 
bufãr
, 64);

1133 
a
 = 
¡©e
[0];

1134 
b
 = 
¡©e
[1];

1135 
c
 = 
¡©e
[2];

1136 
d
 = 
¡©e
[3];

1137 
e
 = 
¡©e
[4];

1138 
R0
(
a
, 
b
, 
c
, 
d
, 
e
, 0);

1139 
R0
(
e
, 
a
, 
b
, 
c
, 
d
, 1);

1140 
R0
(
d
, 
e
, 
a
, 
b
, 
c
, 2);

1141 
R0
(
c
, 
d
, 
e
, 
a
, 
b
, 3);

1142 
R0
(
b
, 
c
, 
d
, 
e
, 
a
, 4);

1143 
R0
(
a
, 
b
, 
c
, 
d
, 
e
, 5);

1144 
R0
(
e
, 
a
, 
b
, 
c
, 
d
, 6);

1145 
R0
(
d
, 
e
, 
a
, 
b
, 
c
, 7);

1146 
R0
(
c
, 
d
, 
e
, 
a
, 
b
, 8);

1147 
R0
(
b
, 
c
, 
d
, 
e
, 
a
, 9);

1148 
R0
(
a
, 
b
, 
c
, 
d
, 
e
, 10);

1149 
R0
(
e
, 
a
, 
b
, 
c
, 
d
, 11);

1150 
R0
(
d
, 
e
, 
a
, 
b
, 
c
, 12);

1151 
R0
(
c
, 
d
, 
e
, 
a
, 
b
, 13);

1152 
R0
(
b
, 
c
, 
d
, 
e
, 
a
, 14);

1153 
R0
(
a
, 
b
, 
c
, 
d
, 
e
, 15);

1154 
R1
(
e
, 
a
, 
b
, 
c
, 
d
, 16);

1155 
R1
(
d
, 
e
, 
a
, 
b
, 
c
, 17);

1156 
R1
(
c
, 
d
, 
e
, 
a
, 
b
, 18);

1157 
R1
(
b
, 
c
, 
d
, 
e
, 
a
, 19);

1158 
R2
(
a
, 
b
, 
c
, 
d
, 
e
, 20);

1159 
R2
(
e
, 
a
, 
b
, 
c
, 
d
, 21);

1160 
R2
(
d
, 
e
, 
a
, 
b
, 
c
, 22);

1161 
R2
(
c
, 
d
, 
e
, 
a
, 
b
, 23);

1162 
R2
(
b
, 
c
, 
d
, 
e
, 
a
, 24);

1163 
R2
(
a
, 
b
, 
c
, 
d
, 
e
, 25);

1164 
R2
(
e
, 
a
, 
b
, 
c
, 
d
, 26);

1165 
R2
(
d
, 
e
, 
a
, 
b
, 
c
, 27);

1166 
R2
(
c
, 
d
, 
e
, 
a
, 
b
, 28);

1167 
R2
(
b
, 
c
, 
d
, 
e
, 
a
, 29);

1168 
R2
(
a
, 
b
, 
c
, 
d
, 
e
, 30);

1169 
R2
(
e
, 
a
, 
b
, 
c
, 
d
, 31);

1170 
R2
(
d
, 
e
, 
a
, 
b
, 
c
, 32);

1171 
R2
(
c
, 
d
, 
e
, 
a
, 
b
, 33);

1172 
R2
(
b
, 
c
, 
d
, 
e
, 
a
, 34);

1173 
R2
(
a
, 
b
, 
c
, 
d
, 
e
, 35);

1174 
R2
(
e
, 
a
, 
b
, 
c
, 
d
, 36);

1175 
R2
(
d
, 
e
, 
a
, 
b
, 
c
, 37);

1176 
R2
(
c
, 
d
, 
e
, 
a
, 
b
, 38);

1177 
R2
(
b
, 
c
, 
d
, 
e
, 
a
, 39);

1178 
R3
(
a
, 
b
, 
c
, 
d
, 
e
, 40);

1179 
R3
(
e
, 
a
, 
b
, 
c
, 
d
, 41);

1180 
R3
(
d
, 
e
, 
a
, 
b
, 
c
, 42);

1181 
R3
(
c
, 
d
, 
e
, 
a
, 
b
, 43);

1182 
R3
(
b
, 
c
, 
d
, 
e
, 
a
, 44);

1183 
R3
(
a
, 
b
, 
c
, 
d
, 
e
, 45);

1184 
R3
(
e
, 
a
, 
b
, 
c
, 
d
, 46);

1185 
R3
(
d
, 
e
, 
a
, 
b
, 
c
, 47);

1186 
R3
(
c
, 
d
, 
e
, 
a
, 
b
, 48);

1187 
R3
(
b
, 
c
, 
d
, 
e
, 
a
, 49);

1188 
R3
(
a
, 
b
, 
c
, 
d
, 
e
, 50);

1189 
R3
(
e
, 
a
, 
b
, 
c
, 
d
, 51);

1190 
R3
(
d
, 
e
, 
a
, 
b
, 
c
, 52);

1191 
R3
(
c
, 
d
, 
e
, 
a
, 
b
, 53);

1192 
R3
(
b
, 
c
, 
d
, 
e
, 
a
, 54);

1193 
R3
(
a
, 
b
, 
c
, 
d
, 
e
, 55);

1194 
R3
(
e
, 
a
, 
b
, 
c
, 
d
, 56);

1195 
R3
(
d
, 
e
, 
a
, 
b
, 
c
, 57);

1196 
R3
(
c
, 
d
, 
e
, 
a
, 
b
, 58);

1197 
R3
(
b
, 
c
, 
d
, 
e
, 
a
, 59);

1198 
R4
(
a
, 
b
, 
c
, 
d
, 
e
, 60);

1199 
R4
(
e
, 
a
, 
b
, 
c
, 
d
, 61);

1200 
R4
(
d
, 
e
, 
a
, 
b
, 
c
, 62);

1201 
R4
(
c
, 
d
, 
e
, 
a
, 
b
, 63);

1202 
R4
(
b
, 
c
, 
d
, 
e
, 
a
, 64);

1203 
R4
(
a
, 
b
, 
c
, 
d
, 
e
, 65);

1204 
R4
(
e
, 
a
, 
b
, 
c
, 
d
, 66);

1205 
R4
(
d
, 
e
, 
a
, 
b
, 
c
, 67);

1206 
R4
(
c
, 
d
, 
e
, 
a
, 
b
, 68);

1207 
R4
(
b
, 
c
, 
d
, 
e
, 
a
, 69);

1208 
R4
(
a
, 
b
, 
c
, 
d
, 
e
, 70);

1209 
R4
(
e
, 
a
, 
b
, 
c
, 
d
, 71);

1210 
R4
(
d
, 
e
, 
a
, 
b
, 
c
, 72);

1211 
R4
(
c
, 
d
, 
e
, 
a
, 
b
, 73);

1212 
R4
(
b
, 
c
, 
d
, 
e
, 
a
, 74);

1213 
R4
(
a
, 
b
, 
c
, 
d
, 
e
, 75);

1214 
R4
(
e
, 
a
, 
b
, 
c
, 
d
, 76);

1215 
R4
(
d
, 
e
, 
a
, 
b
, 
c
, 77);

1216 
R4
(
c
, 
d
, 
e
, 
a
, 
b
, 78);

1217 
R4
(
b
, 
c
, 
d
, 
e
, 
a
, 79);

1218 
¡©e
[0] +ğ
a
;

1219 
¡©e
[1] +ğ
b
;

1220 
¡©e
[2] +ğ
c
;

1221 
¡©e
[3] +ğ
d
;

1222 
¡©e
[4] +ğ
e
;

1225 
mem£t
(
block
, 0, (block));

1226 
a
 = 
b
 = 
c
 = 
d
 = 
e
 = 0;

1227 (è
a
;

1228 (è
b
;

1229 (è
c
;

1230 (è
d
;

1231 (è
e
;

1234 
cs_sha1_š™
(
cs_sha1_ùx
 *
cÚ‹xt
) {

1235 
cÚ‹xt
->
¡©e
[0] = 0x67452301;

1236 
cÚ‹xt
->
¡©e
[1] = 0xEFCDAB89;

1237 
cÚ‹xt
->
¡©e
[2] = 0x98BADCFE;

1238 
cÚ‹xt
->
¡©e
[3] = 0x10325476;

1239 
cÚ‹xt
->
¡©e
[4] = 0xC3D2E1F0;

1240 
cÚ‹xt
->
couÁ
[0] = context->count[1] = 0;

1243 
cs_sha1_upd©e
(
cs_sha1_ùx
 *
cÚ‹xt
, cÚ¡ *
d©a
,

1244 
ušt32_t
 
Ën
) {

1245 
ušt32_t
 
i
, 
j
;

1247 
j
 = 
cÚ‹xt
->
couÁ
[0];

1248 ià((
cÚ‹xt
->
couÁ
[0] +ğ
Ën
 << 3è< 
j
) context->count[1]++;

1249 
cÚ‹xt
->
couÁ
[1] +ğ(
Ën
 >> 29);

1250 
j
 = (j >> 3) & 63;

1251 ià((
j
 + 
Ën
) > 63) {

1252 
memıy
(&
cÚ‹xt
->
bufãr
[
j
], 
d©a
, (
i
 = 64 - j));

1253 
cs_sha1_ŒªsfÜm
(
cÚ‹xt
->
¡©e
, cÚ‹xt->
bufãr
);

1254 ; 
i
 + 63 < 
Ën
; i += 64) {

1255 
cs_sha1_ŒªsfÜm
(
cÚ‹xt
->
¡©e
, &
d©a
[
i
]);

1257 
j
 = 0;

1259 
i
 = 0;

1260 
memıy
(&
cÚ‹xt
->
bufãr
[
j
], &
d©a
[
i
], 
Ën
 - i);

1263 
cs_sha1_fš®
(
dige¡
[20], 
cs_sha1_ùx
 *
cÚ‹xt
) {

1264 
i
;

1265 
fš®couÁ
[8], 
c
;

1267 
i
 = 0; i < 8; i++) {

1268 
fš®couÁ
[
i
] = (è((
cÚ‹xt
->
couÁ
[(i >= 4 ? 0 : 1)] >>

1269 ((3 - (
i
 & 3)) * 8)) &

1272 
c
 = 0200;

1273 
cs_sha1_upd©e
(
cÚ‹xt
, &
c
, 1);

1274 (
cÚ‹xt
->
couÁ
[0] & 504) != 448) {

1275 
c
 = 0000;

1276 
cs_sha1_upd©e
(
cÚ‹xt
, &
c
, 1);

1278 
cs_sha1_upd©e
(
cÚ‹xt
, 
fš®couÁ
, 8);

1279 
i
 = 0; i < 20; i++) {

1280 
dige¡
[
i
] =

1281 (è((
cÚ‹xt
->
¡©e
[
i
 >> 2] >> ((3 - (i & 3)) * 8)) & 255);

1283 
mem£t
(
cÚ‹xt
, '\0', (*context));

1284 
mem£t
(&
fš®couÁ
, '\0', (finalcount));

1287 
cs_hmac_sha1
(cÚ¡ *
key
, 
size_t
 
keyËn
,

1288 cÚ¡ *
d©a
, 
size_t
 
d©®’
,

1289 
out
[20]) {

1290 
cs_sha1_ùx
 
ùx
;

1291 
buf1
[64], 
buf2
[64], 
tmp_key
[20], 
i
;

1293 ià(
keyËn
 > (
buf1
)) {

1294 
cs_sha1_š™
(&
ùx
);

1295 
cs_sha1_upd©e
(&
ùx
, 
key
, 
keyËn
);

1296 
cs_sha1_fš®
(
tmp_key
, &
ùx
);

1297 
key
 = 
tmp_key
;

1298 
keyËn
 = (
tmp_key
);

1301 
mem£t
(
buf1
, 0, (buf1));

1302 
mem£t
(
buf2
, 0, (buf2));

1303 
memıy
(
buf1
, 
key
, 
keyËn
);

1304 
memıy
(
buf2
, 
key
, 
keyËn
);

1306 
i
 = 0; i < (
buf1
); i++) {

1307 
buf1
[
i
] ^= 0x36;

1308 
buf2
[
i
] ^= 0x5c;

1311 
cs_sha1_š™
(&
ùx
);

1312 
cs_sha1_upd©e
(&
ùx
, 
buf1
, (buf1));

1313 
cs_sha1_upd©e
(&
ùx
, 
d©a
, 
d©®’
);

1314 
cs_sha1_fš®
(
out
, &
ùx
);

1316 
cs_sha1_š™
(&
ùx
);

1317 
cs_sha1_upd©e
(&
ùx
, 
buf2
, (buf2));

1318 
cs_sha1_upd©e
(&
ùx
, 
out
, 20);

1319 
cs_sha1_fš®
(
out
, &
ùx
);

1323 #ifdeà
MG_MODULE_LINES


1331 #iâdeà
EXCLUDE_COMMON


1333 
	~<as£¹.h
>

1334 
	~<¡ršg.h
>

1337 #iâdeà
MBUF_REALLOC


1338 
	#MBUF_REALLOC
 
»®loc


	)

1341 #iâdeà
MBUF_FREE


1342 
	#MBUF_FREE
 
ä“


	)

1345 
mbuf_š™
(
mbuf
 *mbuf, 
size_t
 
š™Ÿl_size
è
WEAK
;

1346 
mbuf_š™
(
mbuf
 *mbuf, 
size_t
 
š™Ÿl_size
) {

1347 
mbuf
->
Ën
 = mbuf->
size
 = 0;

1348 
mbuf
->
buf
 = 
NULL
;

1349 
mbuf_»size
(
mbuf
, 
š™Ÿl_size
);

1352 
mbuf_ä“
(
mbuf
 *mbufè
WEAK
;

1353 
mbuf_ä“
(
mbuf
 *mbuf) {

1354 ià(
mbuf
->
buf
 !ğ
NULL
) {

1355 
MBUF_FREE
(
mbuf
->
buf
);

1356 
mbuf_š™
(
mbuf
, 0);

1360 
mbuf_»size
(
mbuf
 *
a
, 
size_t
 
Ãw_size
è
WEAK
;

1361 
mbuf_»size
(
mbuf
 *
a
, 
size_t
 
Ãw_size
) {

1362 ià(
Ãw_size
 > 
a
->
size
 || (Ãw_siz<‡->siz&&‚ew_siz>ğa->
Ën
)) {

1363 *
buf
 = (*è
MBUF_REALLOC
(
a
->buf, 
Ãw_size
);

1369 ià(
buf
 =ğ
NULL
 && 
Ãw_size
 != 0) ;

1370 
a
->
buf
 = buf;

1371 
a
->
size
 = 
Ãw_size
;

1375 
mbuf_Œim
(
mbuf
 *mbufè
WEAK
;

1376 
mbuf_Œim
(
mbuf
 *mbuf) {

1377 
mbuf_»size
(
mbuf
, mbuf->
Ën
);

1380 
size_t
 
mbuf_š£¹
(
mbuf
 *
a
, size_ˆ
off
, cÚ¡ *
buf
, size_tè
WEAK
;

1381 
size_t
 
mbuf_š£¹
(
mbuf
 *
a
, size_ˆ
off
, cÚ¡ *
buf
, size_ˆ
Ën
) {

1382 *
p
 = 
NULL
;

1384 
as£¹
(
a
 !ğ
NULL
);

1385 
as£¹
(
a
->
Ën
 <ğa->
size
);

1386 
as£¹
(
off
 <ğ
a
->
Ën
);

1389 ià(~(
size_t
è0 - (size_tè
a
->
buf
 < 
Ën
)  0;

1391 ià(
a
->
Ën
 +†’ <ğa->
size
) {

1392 
memmove
(
a
->
buf
 + 
off
 + 
Ën
,‡->buf + off,‡->len - off);

1393 ià(
buf
 !ğ
NULL
) {

1394 
memıy
(
a
->
buf
 + 
off
, buf, 
Ën
);

1396 
a
->
Ën
 +=†en;

1398 
size_t
 
Ãw_size
 = (size_t)((
a
->
Ën
 +†’è* 
MBUF_SIZE_MULTIPLIER
);

1399 ià((
p
 = (*è
MBUF_REALLOC
(
a
->
buf
, 
Ãw_size
)è!ğ
NULL
) {

1400 
a
->
buf
 = 
p
;

1401 
memmove
(
a
->
buf
 + 
off
 + 
Ën
,‡->buf + off,‡->len - off);

1402 ià(
buf
 !ğ
NULL
è
memıy
(
a
->buà+ 
off
, buf, 
Ën
);

1403 
a
->
Ën
 +=†en;

1404 
a
->
size
 = 
Ãw_size
;

1406 
Ën
 = 0;

1410  
Ën
;

1413 
size_t
 
mbuf_­³nd
(
mbuf
 *
a
, cÚ¡ *
buf
, size_ˆ
Ën
è
WEAK
;

1414 
size_t
 
mbuf_­³nd
(
mbuf
 *
a
, cÚ¡ *
buf
, size_ˆ
Ën
) {

1415  
mbuf_š£¹
(
a
,‡->
Ën
, 
buf
,†en);

1418 
mbuf_»move
(
mbuf
 *
mb
, 
size_t
 
n
è
WEAK
;

1419 
mbuf_»move
(
mbuf
 *
mb
, 
size_t
 
n
) {

1420 ià(
n
 > 0 &&‚ <ğ
mb
->
Ën
) {

1421 
memmove
(
mb
->
buf
, mb->buà+ 
n
, mb->
Ën
 -‚);

1422 
mb
->
Ën
 -ğ
n
;

1427 #ifdeà
MG_MODULE_LINES


1438 
	~<¡dlib.h
>

1439 
	~<¡ršg.h
>

1441 
mg_nÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
, 
size_t
 
Ën
è
WEAK
;

1443 
mg_¡r
 
mg_mk_¡r
(cÚ¡ *
s
è
WEAK
;

1444 
mg_¡r
 
mg_mk_¡r
(cÚ¡ *
s
) {

1445 
mg_¡r
 
»t
 = {
s
, 0};

1446 ià(
s
 !ğ
NULL
è
»t
.
Ën
 = 
¡¾’
(s);

1447  
»t
;

1450 
mg_¡r
 
mg_mk_¡r_n
(cÚ¡ *
s
, 
size_t
 
Ën
è
WEAK
;

1451 
mg_¡r
 
mg_mk_¡r_n
(cÚ¡ *
s
, 
size_t
 
Ën
) {

1452 
mg_¡r
 
»t
 = {
s
, 
Ën
};

1453  
»t
;

1456 
mg_vcmp
(cÚ¡ 
mg_¡r
 *
¡r1
, cÚ¡ *
¡r2
è
WEAK
;

1457 
mg_vcmp
(cÚ¡ 
mg_¡r
 *
¡r1
, cÚ¡ *
¡r2
) {

1458 
size_t
 
n2
 = 
¡¾’
(
¡r2
), 
n1
 = 
¡r1
->
Ën
;

1459 
r
 = 
¡ºcmp
(
¡r1
->
p
, 
¡r2
, (
n1
 < 
n2
) ?‚1 :‚2);

1460 ià(
r
 == 0) {

1461  
n1
 - 
n2
;

1463  
r
;

1466 
mg_vÿ£cmp
(cÚ¡ 
mg_¡r
 *
¡r1
, cÚ¡ *
¡r2
è
WEAK
;

1467 
mg_vÿ£cmp
(cÚ¡ 
mg_¡r
 *
¡r1
, cÚ¡ *
¡r2
) {

1468 
size_t
 
n2
 = 
¡¾’
(
¡r2
), 
n1
 = 
¡r1
->
Ën
;

1469 
r
 = 
mg_nÿ£cmp
(
¡r1
->
p
, 
¡r2
, (
n1
 < 
n2
) ?‚1 :‚2);

1470 ià(
r
 == 0) {

1471  
n1
 - 
n2
;

1473  
r
;

1476 
mg_¡r
 
mg_¡rdup_commÚ
(cÚ¡ mg_¡¸
s
,

1477 
nul_‹rmš©e
) {

1478 
mg_¡r
 
r
 = {
NULL
, 0};

1479 ià(
s
.
Ën
 > 0 && s.
p
 !ğ
NULL
) {

1480 *
sc
 = (*è
MG_MALLOC
(
s
.
Ën
 + (
nul_‹rmš©e
 ? 1 : 0));

1481 ià(
sc
 !ğ
NULL
) {

1482 
memıy
(
sc
, 
s
.
p
, s.
Ën
);

1483 ià(
nul_‹rmš©e
è
sc
[
s
.
Ën
] = '\0';

1484 
r
.
p
 = 
sc
;

1485 
r
.
Ën
 = 
s
.len;

1488  
r
;

1491 
mg_¡r
 
mg_¡rdup
(cÚ¡ mg_¡¸
s
è
WEAK
;

1492 
mg_¡r
 
mg_¡rdup
(cÚ¡ mg_¡¸
s
) {

1493  
mg_¡rdup_commÚ
(
s
, 0 );

1496 
mg_¡r
 
mg_¡rdup_nul
(cÚ¡ mg_¡¸
s
è
WEAK
;

1497 
mg_¡r
 
mg_¡rdup_nul
(cÚ¡ mg_¡¸
s
) {

1498  
mg_¡rdup_commÚ
(
s
, 1 );

1501 cÚ¡ *
mg_¡rchr
(cÚ¡ 
mg_¡r
 
s
, 
c
è
WEAK
;

1502 cÚ¡ *
mg_¡rchr
(cÚ¡ 
mg_¡r
 
s
, 
c
) {

1503 
size_t
 
i
;

1504 
i
 = 0; i < 
s
.
Ën
; i++) {

1505 ià(
s
.
p
[
i
] =ğ
c
)  &s.p[i];

1507  
NULL
;

1510 
mg_¡rcmp
(cÚ¡ 
mg_¡r
 
¡r1
, cÚ¡ mg_¡¸
¡r2
è
WEAK
;

1511 
mg_¡rcmp
(cÚ¡ 
mg_¡r
 
¡r1
, cÚ¡ mg_¡¸
¡r2
) {

1512 
size_t
 
i
 = 0;

1513 
i
 < 
¡r1
.
Ën
 && i < 
¡r2
.len) {

1514 ià(
¡r1
.
p
[
i
] < 
¡r2
.p[i])  -1;

1515 ià(
¡r1
.
p
[
i
] > 
¡r2
.p[i])  1;

1516 
i
++;

1518 ià(
i
 < 
¡r1
.
Ën
)  1;

1519 ià(
i
 < 
¡r2
.
Ën
)  -1;

1523 
mg_¡ºcmp
(cÚ¡ 
mg_¡r
, cÚ¡ mg_¡r, 
size_t
 
n
è
WEAK
;

1524 
mg_¡ºcmp
(cÚ¡ 
mg_¡r
 
¡r1
, cÚ¡ mg_¡¸
¡r2
, 
size_t
 
n
) {

1525 
mg_¡r
 
s1
 = 
¡r1
;

1526 
mg_¡r
 
s2
 = 
¡r2
;

1528 ià(
s1
.
Ën
 > 
n
) {

1529 
s1
.
Ën
 = 
n
;

1531 ià(
s2
.
Ën
 > 
n
) {

1532 
s2
.
Ën
 = 
n
;

1534  
mg_¡rcmp
(
s1
, 
s2
);

1537 cÚ¡ *
mg_¡r¡r
(cÚ¡ 
mg_¡r
 
hay¡ack
,

1538 cÚ¡ 
mg_¡r
 
ÃedË
è
WEAK
;

1539 cÚ¡ *
mg_¡r¡r
(cÚ¡ 
mg_¡r
 
hay¡ack
,

1540 cÚ¡ 
mg_¡r
 
ÃedË
) {

1541 
size_t
 
i
;

1542 ià(
ÃedË
.
Ën
 > 
hay¡ack
.Ënè 
NULL
;

1543 
i
 = 0; i <ğ
hay¡ack
.
Ën
 - 
ÃedË
.len; i++) {

1544 ià(
memcmp
(
hay¡ack
.
p
 + 
i
, 
ÃedË
.p,‚“dË.
Ën
) == 0) {

1545  
hay¡ack
.
p
 + 
i
;

1548  
NULL
;

1550 #ifdeà
MG_MODULE_LINES


1558 #iâdeà
EXCLUDE_COMMON


1564 #iâdeà
C_DISABLE_BUILTIN_SNPRINTF


1565 
	#C_DISABLE_BUILTIN_SNPRINTF
 0

	)

1570 
size_t
 
c_¡ºËn
(cÚ¡ *
s
, size_ˆ
maxËn
è
WEAK
;

1571 
size_t
 
c_¡ºËn
(cÚ¡ *
s
, size_ˆ
maxËn
) {

1572 
size_t
 
l
 = 0;

1573 ; 
l
 < 
maxËn
 && 
s
[l] != '\0';†++) {

1575  
l
;

1578 
	#C_SNPRINTF_APPEND_CHAR
(
ch
) \

1580 ià(
i
 < (è
buf_size
è
buf
[i] = 
ch
; \

1581 
i
++; \

1582 } 0)

	)

1584 
	#C_SNPRINTF_FLAG_ZERO
 1

	)

1586 #ià
C_DISABLE_BUILTIN_SNPRINTF


1587 
c_v¢´štf
(*
buf
, 
size_t
 
buf_size
, cÚ¡ *
fmt
, 
va_li¡
 
­
è
WEAK
;

1588 
c_v¢´štf
(*
buf
, 
size_t
 
buf_size
, cÚ¡ *
fmt
, 
va_li¡
 
­
) {

1589  
v¢´štf
(
buf
, 
buf_size
, 
fmt
, 
­
);

1592 
c_™ß
(*
buf
, 
size_t
 
buf_size
, 
št64_t
 
num
, 
ba£
, 
æags
,

1593 
f›ld_width
) {

1594 
tmp
[40];

1595 
i
 = 0, 
k
 = 0, 
Ãg
 = 0;

1597 ià(
num
 < 0) {

1598 
Ãg
++;

1599 
num
 = -num;

1604 
»m
 = 
num
 % 
ba£
;

1605 ià(
»m
 < 10) {

1606 
tmp
[
k
++] = '0' + 
»m
;

1608 
tmp
[
k
++] = 'a' + (
»m
 - 10);

1610 
num
 /ğ
ba£
;

1611 } 
num
 > 0);

1614 ià(
æags
 && 
C_SNPRINTF_FLAG_ZERO
) {

1615 
k
 < 
f›ld_width
 && k < (è(
tmp
) - 1) {

1616 
tmp
[
k
++] = '0';

1621 ià(
Ãg
) {

1622 
tmp
[
k
++] = '-';

1626 --
k
 >= 0) {

1627 
C_SNPRINTF_APPEND_CHAR
(
tmp
[
k
]);

1630  
i
;

1633 
c_v¢´štf
(*
buf
, 
size_t
 
buf_size
, cÚ¡ *
fmt
, 
va_li¡
 
­
è
WEAK
;

1634 
c_v¢´štf
(*
buf
, 
size_t
 
buf_size
, cÚ¡ *
fmt
, 
va_li¡
 
­
) {

1635 
ch
, 
i
 = 0, 
Ën_mod
, 
æags
, 
´ecisiÚ
, 
f›ld_width
;

1637 (
ch
 = *
fmt
++) != '\0') {

1638 ià(
ch
 != '%') {

1639 
C_SNPRINTF_APPEND_CHAR
(
ch
);

1649 
æags
 = 
f›ld_width
 = 
´ecisiÚ
 = 
Ën_mod
 = 0;

1652 ià(*
fmt
 == '0') {

1653 
æags
 |ğ
C_SNPRINTF_FLAG_ZERO
;

1657 *
fmt
 >= '0' && *fmt <= '9') {

1658 
f›ld_width
 *= 10;

1659 
f›ld_width
 +ğ*
fmt
++ - '0';

1662 ià(*
fmt
 == '*') {

1663 
f›ld_width
 = 
va_¬g
(
­
, );

1664 
fmt
++;

1668 ià(*
fmt
 == '.') {

1669 
fmt
++;

1670 ià(*
fmt
 == '*') {

1671 
´ecisiÚ
 = 
va_¬g
(
­
, );

1672 
fmt
++;

1674 *
fmt
 >= '0' && *fmt <= '9') {

1675 
´ecisiÚ
 *= 10;

1676 
´ecisiÚ
 +ğ*
fmt
++ - '0';

1682 *
fmt
) {

1691 
Ën_mod
 = *
fmt
++;

1692 ià(*
fmt
 == 'h') {

1693 
Ën_mod
 = 'H';

1694 
fmt
++;

1696 ià(*
fmt
 == 'l') {

1697 
Ën_mod
 = 'q';

1698 
fmt
++;

1703 
ch
 = *
fmt
++;

1704 ià(
ch
 == 's') {

1705 cÚ¡ *
s
 = 
va_¬g
(
­
, const *);

1706 
j
;

1707 
·d
 = 
f›ld_width
 - (
´ecisiÚ
 >ğ0 ? 
c_¡ºËn
(
s
,…recision) : 0);

1708 
j
 = 0; j < 
·d
; j++) {

1709 
C_SNPRINTF_APPEND_CHAR
(' ');

1713 ià(
s
 !ğ
NULL
) {

1715 
j
 = 0; (
´ecisiÚ
 <ğ0 || j <…»cisiÚè&& 
s
[j] != '\0'; j++) {

1716 
C_SNPRINTF_APPEND_CHAR
(
s
[
j
]);

1719 } ià(
ch
 == 'c') {

1720 
ch
 = 
va_¬g
(
­
, );

1721 
C_SNPRINTF_APPEND_CHAR
(
ch
);

1722 } ià(
ch
 =ğ'd' && 
Ën_mod
 == 0) {

1723 
i
 +ğ
c_™ß
(
buf
 + i, 
buf_size
 - i, 
va_¬g
(
­
, ), 10, 
æags
,

1724 
f›ld_width
);

1725 } ià(
ch
 =ğ'd' && 
Ën_mod
 == 'l') {

1726 
i
 +ğ
c_™ß
(
buf
 + i, 
buf_size
 - i, 
va_¬g
(
­
, ), 10, 
æags
,

1727 
f›ld_width
);

1728 #ifdeà
SSIZE_MAX


1729 } ià(
ch
 =ğ'd' && 
Ën_mod
 == 'z') {

1730 
i
 +ğ
c_™ß
(
buf
 + i, 
buf_size
 - i, 
va_¬g
(
­
, 
ssize_t
), 10, 
æags
,

1731 
f›ld_width
);

1733 } ià(
ch
 =ğ'd' && 
Ën_mod
 == 'q') {

1734 
i
 +ğ
c_™ß
(
buf
 + i, 
buf_size
 - i, 
va_¬g
(
­
, 
št64_t
), 10, 
æags
,

1735 
f›ld_width
);

1736 } ià((
ch
 =ğ'x' || ch =ğ'u'è&& 
Ën_mod
 == 0) {

1737 
i
 +ğ
c_™ß
(
buf
 + i, 
buf_size
 - i, 
va_¬g
(
­
, ),

1738 
ch
 =ğ'x' ? 16 : 10, 
æags
, 
f›ld_width
);

1739 } ià((
ch
 =ğ'x' || ch =ğ'u'è&& 
Ën_mod
 == 'l') {

1740 
i
 +ğ
c_™ß
(
buf
 + i, 
buf_size
 - i, 
va_¬g
(
­
, ),

1741 
ch
 =ğ'x' ? 16 : 10, 
æags
, 
f›ld_width
);

1742 } ià((
ch
 =ğ'x' || ch =ğ'u'è&& 
Ën_mod
 == 'z') {

1743 
i
 +ğ
c_™ß
(
buf
 + i, 
buf_size
 - i, 
va_¬g
(
­
, 
size_t
),

1744 
ch
 =ğ'x' ? 16 : 10, 
æags
, 
f›ld_width
);

1745 } ià(
ch
 == 'p') {

1746 
num
 = (è(
ušŒ_t
è
va_¬g
(
­
, *);

1747 
C_SNPRINTF_APPEND_CHAR
('0');

1748 
C_SNPRINTF_APPEND_CHAR
('x');

1749 
i
 +ğ
c_™ß
(
buf
 + i, 
buf_size
 - i, 
num
, 16, 
æags
, 0);

1751 #iâdeà
NO_LIBC


1756 
abÜt
();

1763 ià(
buf_size
 > 0) {

1764 
buf
[
i
 < (è
buf_size
 ? i : () buf_size - 1] = '\0';

1767  
i
;

1771 
c_¢´štf
(*
buf
, 
size_t
 
buf_size
, cÚ¡ *
fmt
, ...è
WEAK
;

1772 
c_¢´štf
(*
buf
, 
size_t
 
buf_size
, cÚ¡ *
fmt
, ...) {

1773 
»suÉ
;

1774 
va_li¡
 
­
;

1775 
va_¡¬t
(
­
, 
fmt
);

1776 
»suÉ
 = 
c_v¢´štf
(
buf
, 
buf_size
, 
fmt
, 
­
);

1777 
va_’d
(
­
);

1778  
»suÉ
;

1781 #ifdeà
_WIN32


1782 
to_wch¬
(cÚ¡ *
·th
, 
wch¬_t
 *
wbuf
, 
size_t
 
wbuf_Ën
) {

1783 
»t
;

1784 
buf
[
MAX_PATH
 * 2], 
buf2
[MAX_PATH * 2], *
p
;

1786 
¡ºıy
(
buf
, 
·th
, (buf));

1787 
buf
[(buf) - 1] = '\0';

1790 
p
 = 
buf
 + 
¡¾’
(buf) - 1;

1791 
p
 > 
buf
 &&…[-1] != ':' && (p[0] == '\\' ||…[0] == '/')) *p-- = '\0';

1793 
mem£t
(
wbuf
, 0, 
wbuf_Ën
 * (
wch¬_t
));

1794 
»t
 = 
MuÉiBy‹ToWideCh¬
(
CP_UTF8
, 0, 
buf
, -1, 
wbuf
, (è
wbuf_Ën
);

1800 
WideCh¬ToMuÉiBy‹
(
CP_UTF8
, 0, 
wbuf
, (è
wbuf_Ën
, 
buf2
, (buf2),

1801 
NULL
, NULL);

1802 ià(
¡rcmp
(
buf
, 
buf2
) != 0) {

1803 
wbuf
[0] = 
L
'\0';

1804 
»t
 = 0;

1807  
»t
;

1812 cÚ¡ *
c_¡º¡r
(cÚ¡ *
s
, cÚ¡ *
fšd
, 
size_t
 
¦’
è
WEAK
;

1813 cÚ¡ *
c_¡º¡r
(cÚ¡ *
s
, cÚ¡ *
fšd
, 
size_t
 
¦’
) {

1814 
size_t
 
fšd_Ëngth
 = 
¡¾’
(
fšd
);

1815 
size_t
 
i
;

1817 
i
 = 0; i < 
¦’
; i++) {

1818 ià(
i
 + 
fšd_Ëngth
 > 
¦’
) {

1819  
NULL
;

1822 ià(
¡ºcmp
(&
s
[
i
], 
fšd
, 
fšd_Ëngth
) == 0) {

1823  &
s
[
i
];

1827  
NULL
;

1830 #ià
CS_ENABLE_STRDUP


1831 *
¡rdup
(cÚ¡ *
¤c
è
WEAK
;

1832 *
¡rdup
(cÚ¡ *
¤c
) {

1833 
size_t
 
Ën
 = 
¡¾’
(
¤c
) + 1;

1834 *
»t
 = 
MG_MALLOC
(
Ën
);

1835 ià(
»t
 !ğ
NULL
) {

1836 
¡rıy
(
»t
, 
¤c
);

1838  
»t
;

1842 
cs_to_hex
(*
to
, cÚ¡ *
p
, 
size_t
 
Ën
è
WEAK
;

1843 
cs_to_hex
(*
to
, cÚ¡ *
p
, 
size_t
 
Ën
) {

1844 cÚ¡ *
hex
 = "0123456789abcdef";

1846 ; 
Ën
--; 
p
++) {

1847 *
to
++ = 
hex
[
p
[0] >> 4];

1848 *
to
++ = 
hex
[
p
[0] & 0x0f];

1850 *
to
 = '\0';

1853 
fourb™
(
ch
) {

1854 ià(
ch
 >= '0' && ch <= '9') {

1855  
ch
 - '0';

1856 } ià(
ch
 >= 'a' && ch <= 'f') {

1857  
ch
 - 'a' + 10;

1858 } ià(
ch
 >= 'A' && ch <= 'F') {

1859  
ch
 - 'A' + 10;

1864 
cs_äom_hex
(*
to
, cÚ¡ *
p
, 
size_t
 
Ën
è
WEAK
;

1865 
cs_äom_hex
(*
to
, cÚ¡ *
p
, 
size_t
 
Ën
) {

1866 
size_t
 
i
;

1868 
i
 = 0; i < 
Ën
; i += 2) {

1869 *
to
++ = (
fourb™
(
p
[
i
]) << 4) + fourbit(p[i + 1]);

1871 *
to
 = '\0';

1874 #ià
CS_ENABLE_TO64


1875 
št64_t
 
cs_to64
(cÚ¡ *
s
è
WEAK
;

1876 
št64_t
 
cs_to64
(cÚ¡ *
s
) {

1877 
št64_t
 
»suÉ
 = 0;

1878 
št64_t
 
Ãg
 = 1;

1879 *
s
 && 
is¥aû
(() *s)) s++;

1880 ià(*
s
 == '-') {

1881 
Ãg
 = -1;

1882 
s
++;

1884 
isdig™
((è*
s
)) {

1885 
»suÉ
 *= 10;

1886 
»suÉ
 +ğ(*
s
 - '0');

1887 
s
++;

1889  
»suÉ
 * 
Ãg
;

1893 
¡r_ut_low”ÿ£
(cÚ¡ *
s
) {

1894  
tŞow”
(*(cÚ¡ *è
s
);

1897 
mg_nÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
, 
size_t
 
Ën
è
WEAK
;

1898 
mg_nÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
, 
size_t
 
Ën
) {

1899 
diff
 = 0;

1901 ià(
Ën
 > 0) do {

1902 
diff
 = 
¡r_ut_low”ÿ£
(
s1
++è- sŒ_ut_low”ÿ£(
s2
++);

1903 } 
diff
 =ğ0 && 
s1
[-1] !ğ'\0' && --
Ën
 > 0);

1905  
diff
;

1908 
mg_ÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
è
WEAK
;

1909 
mg_ÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

1910  
mg_nÿ£cmp
(
s1
, 
s2
, (
size_t
) ~0);

1913 
mg_a¥rštf
(**
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, ...è
WEAK
;

1914 
mg_a¥rštf
(**
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, ...) {

1915 
»t
;

1916 
va_li¡
 
­
;

1917 
va_¡¬t
(
­
, 
fmt
);

1918 
»t
 = 
mg_av´štf
(
buf
, 
size
, 
fmt
, 
­
);

1919 
va_’d
(
­
);

1920  
»t
;

1923 
mg_av´štf
(**
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, 
va_li¡
 
­
è
WEAK
;

1924 
mg_av´štf
(**
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, 
va_li¡
 
­
) {

1925 
va_li¡
 
­_cİy
;

1926 
Ën
;

1928 
va_cİy
(
­_cİy
, 
­
);

1929 
Ën
 = 
v¢´štf
(*
buf
, 
size
, 
fmt
, 
­_cİy
);

1930 
va_’d
(
­_cİy
);

1932 ià(
Ën
 < 0) {

1936 *
buf
 = 
NULL
;

1937 
Ën
 < 0) {

1938 
MG_FREE
(*
buf
);

1939 ià(
size
 == 0) {

1940 
size
 = 5;

1942 
size
 *= 2;

1943 ià((*
buf
 = (*è
MG_MALLOC
(
size
)è=ğ
NULL
) {

1944 
Ën
 = -1;

1947 
va_cİy
(
­_cİy
, 
­
);

1948 
Ën
 = 
v¢´štf
(*
buf
, 
size
 - 1, 
fmt
, 
­_cİy
);

1949 
va_’d
(
­_cİy
);

1956 (*
buf
)[
Ën
] = 0;

1958 } ià(
Ën
 >ğ(è
size
) {

1960 ià((*
buf
 = (*è
MG_MALLOC
(
Ën
 + 1)è=ğ
NULL
) {

1961 
Ën
 = -1;

1963 
va_cİy
(
­_cİy
, 
­
);

1964 
Ën
 = 
v¢´štf
(*
buf
,†’ + 1, 
fmt
, 
­_cİy
);

1965 
va_’d
(
­_cİy
);

1969  
Ën
;

1972 cÚ¡ *
mg_Ãxt_comma_li¡_’Œy
(cÚ¡ *, 
mg_¡r
 *,

1973 
mg_¡r
 *è
WEAK
;

1974 cÚ¡ *
mg_Ãxt_comma_li¡_’Œy
(cÚ¡ *
li¡
, 
mg_¡r
 *
v®
,

1975 
mg_¡r
 *
eq_v®
) {

1976 
mg_¡r
 
»t
 = 
mg_Ãxt_comma_li¡_’Œy_n
(
mg_mk_¡r
(
li¡
), 
v®
, 
eq_v®
);

1977  
»t
.
p
;

1980 
mg_¡r
 
mg_Ãxt_comma_li¡_’Œy_n
(mg_¡¸
li¡
, mg_¡¸*
v®
,

1981 
mg_¡r
 *
eq_v®
è
WEAK
;

1982 
mg_¡r
 
mg_Ãxt_comma_li¡_’Œy_n
(mg_¡¸
li¡
, mg_¡¸*
v®
,

1983 
mg_¡r
 *
eq_v®
) {

1984 ià(
li¡
.
Ën
 == 0) {

1986 
li¡
 = 
mg_mk_¡r
(
NULL
);

1988 cÚ¡ *
chr
 = 
NULL
;

1989 *
v®
 = 
li¡
;

1991 ià((
chr
 = 
mg_¡rchr
(*
v®
, ',')è!ğ
NULL
) {

1993 
v®
->
Ën
 = 
chr
 - v®->
p
;

1994 
chr
++;

1995 
li¡
.
Ën
 -ğ(
chr
 -†i¡.
p
);

1996 
li¡
.
p
 = 
chr
;

1999 
li¡
 = 
mg_mk_¡r_n
Öi¡.
p
 +†i¡.
Ën
, 0);

2002 ià(
eq_v®
 !ğ
NULL
) {

2005 
eq_v®
->
Ën
 = 0;

2006 
eq_v®
->
p
 = (cÚ¡ *è
memchr
(
v®
->p, '=', v®->
Ën
);

2007 ià(
eq_v®
->
p
 !ğ
NULL
) {

2008 
eq_v®
->
p
++;

2009 
eq_v®
->
Ën
 = 
v®
->
p
 + val->len -ƒq_val->p;

2010 
v®
->
Ën
 = (
eq_v®
->
p
 - val->p) - 1;

2015  
li¡
;

2018 
mg_m©ch_´efix_n
(cÚ¡ 
mg_¡r
, cÚ¡ mg_¡rè
WEAK
;

2019 
mg_m©ch_´efix_n
(cÚ¡ 
mg_¡r
 
·‰”n
, cÚ¡ mg_¡¸
¡r
) {

2020 cÚ¡ *
Ü_¡r
;

2021 
size_t
 
Ën
, 
i
 = 0, 
j
 = 0;

2022 
»s
;

2024 ià((
Ü_¡r
 = (cÚ¡ *è
memchr
(
·‰”n
.
p
, '|',…©‹º.
Ën
)è!ğ
NULL
 ||

2025 (
Ü_¡r
 = (cÚ¡ *è
memchr
(
·‰”n
.
p
, ',',…©‹º.
Ën
)è!ğ
NULL
) {

2026 
mg_¡r
 
p¡r
 = {
·‰”n
.
p
, (
size_t
)(
Ü_¡r
 -…attern.p)};

2027 
»s
 = 
mg_m©ch_´efix_n
(
p¡r
, 
¡r
);

2028 ià(
»s
 > 0) „es;

2029 
p¡r
.
p
 = 
Ü_¡r
 + 1;

2030 
p¡r
.
Ën
 = (
·‰”n
.
p
 +…©‹º.Ënè- (
Ü_¡r
 + 1);

2031  
mg_m©ch_´efix_n
(
p¡r
, 
¡r
);

2034 ; 
i
 < 
·‰”n
.
Ën
; i++, 
j
++) {

2035 ià(
·‰”n
.
p
[
i
] =ğ'?' && 
j
 !ğ
¡r
.
Ën
) {

2037 } ià(
·‰”n
.
p
[
i
] == '$') {

2038  
j
 =ğ
¡r
.
Ën
 ? () j : -1;

2039 } ià(
·‰”n
.
p
[
i
] == '*') {

2040 
i
++;

2041 ià(
i
 < 
·‰”n
.
Ën
 &&…©‹º.
p
[i] == '*') {

2042 
i
++;

2043 
Ën
 = 
¡r
.ËÀ- 
j
;

2045 
Ën
 = 0;

2046 
j
 + 
Ën
 !ğ
¡r
.ËÀ&& sŒ.
p
[j +†en] != '/') {

2047 
Ën
++;

2050 ià(
i
 =ğ
·‰”n
.
Ën
) {

2051  
j
 + 
Ën
;

2054 cÚ¡ 
mg_¡r
 
p¡r
 = {
·‰”n
.
p
 + 
i
,…©‹º.
Ën
 - i};

2055 cÚ¡ 
mg_¡r
 
s¡r
 = {
¡r
.
p
 + 
j
 + 
Ën
, str.len - j -†en};

2056 
»s
 = 
mg_m©ch_´efix_n
(
p¡r
, 
s¡r
);

2057 } 
»s
 =ğ-1 && 
Ën
-- > 0);

2058  
»s
 =ğ-1 ? -1 : (è(
j
 +„e + 
Ën
);

2059 } ià(
¡r_ut_low”ÿ£
(&
·‰”n
.
p
[
i
]) !=

2060 
¡r_ut_low”ÿ£
(&
¡r
.
p
[
j
])) {

2064  
j
;

2067 
mg_m©ch_´efix
(cÚ¡ *, , cÚ¡ *è
WEAK
;

2068 
mg_m©ch_´efix
(cÚ¡ *
·‰”n
, 
·‰”n_Ën
, cÚ¡ *
¡r
) {

2069 cÚ¡ 
mg_¡r
 
p¡r
 = {
·‰”n
, (
size_t
è
·‰”n_Ën
};

2070 
mg_¡r
 
s
 = {
¡r
, 0};

2071 ià(
¡r
 !ğ
NULL
è
s
.
Ën
 = 
¡¾’
(str);

2072  
mg_m©ch_´efix_n
(
p¡r
, 
s
);

2076 #ifdeà
MG_MODULE_LINES


2084 #iâdeà
CS_MONGOOSE_SRC_TUN_H_


2085 
	#CS_MONGOOSE_SRC_TUN_H_


	)

2087 #ià
MG_ENABLE_TUN


2092 #iâdeà
MG_TUN_RECONNECT_INTERVAL


2093 
	#MG_TUN_RECONNECT_INTERVAL
 1

	)

2096 
	#MG_TUN_PROTO_NAME
 "mg_tun"

	)

2098 
	#MG_TUN_DATA_FRAME
 0x0

	)

2099 
	#MG_TUN_F_END_STREAM
 0x1

	)

2109 
	smg_tun_äame
 {

2110 
ušt8_t
 
ty³
;

2111 
ušt8_t
 
æags
;

2112 
ušt32_t
 
¡»am_id
;

2113 
mg_¡r
 
body
;

2116 
	smg_tun_s¦_İts
 {

2117 #ià
MG_ENABLE_SSL


2118 cÚ¡ *
s¦_û¹
;

2119 cÚ¡ *
s¦_key
;

2120 cÚ¡ *
s¦_ÿ_û¹
;

2122 
dummy
;

2126 
	smg_tun_ş›Á
 {

2127 
mg_mgr
 *
mgr
;

2128 
mg_içû
 *
içû
;

2129 cÚ¡ *
di¥_u¾
;

2130 
mg_tun_s¦_İts
 
s¦
;

2132 
ušt32_t
 
Ï¡_¡»am_id
;

2134 
mg_cÚÃùiÚ
 *
di¥
;

2135 
mg_cÚÃùiÚ
 *
li¡’”
;

2136 
mg_cÚÃùiÚ
 *
»cÚÃù
;

2139 #ifdeà
__ılu¥lus


2143 
mg_cÚÃùiÚ
 *
mg_tun_bšd_İt
(
mg_mgr
 *
mgr
,

2144 cÚ¡ *
di¥©ch”
,

2145 
MG_CB
(
mg_ev’t_hªdËr_t
 
hªdËr
,

2146 *
u£r_d©a
),

2147 
mg_bšd_İts
 
İts
);

2149 
mg_tun_·r£_äame
(*
d©a
, 
size_t
 
Ën
, 
mg_tun_äame
 *
äame
);

2151 
mg_tun_£nd_äame
(
mg_cÚÃùiÚ
 *
ws
, 
ušt32_t
 
¡»am_id
,

2152 
ušt8_t
 
ty³
, ušt8_ˆ
æags
, 
mg_¡r
 
msg
);

2154 
mg_tun_de¡roy_ş›Á
(
mg_tun_ş›Á
 *
ş›Á
);

2156 #ifdeà
__ılu¥lus


2163 #ifdeà
MG_MODULE_LINES


2191 
	#MG_MAX_HOST_LEN
 200

	)

2193 
	#MG_COPY_COMMON_CONNECTION_OPTIONS
(
d¡
, 
¤c
) \

2194 
	`memıy
(
d¡
, 
¤c
, (*d¡));

	)

2197 
	#_MG_ALLOWED_CONNECT_FLAGS_MASK
 \

2198 (
MG_F_USER_1
 | 
MG_F_USER_2
 | 
MG_F_USER_3
 | 
MG_F_USER_4
 | 
MG_F_USER_5
 | \

2199 
MG_F_USER_6
 | 
MG_F_WEBSOCKET_NO_DEFRAG
 | 
MG_F_ENABLE_BROADCAST
)

	)

2201 
	#_MG_CALLBACK_MODIFIABLE_FLAGS_MASK
 \

2202 (
MG_F_USER_1
 | 
MG_F_USER_2
 | 
MG_F_USER_3
 | 
MG_F_USER_4
 | 
MG_F_USER_5
 | \

2203 
MG_F_USER_6
 | 
MG_F_WEBSOCKET_NO_DEFRAG
 | 
MG_F_SEND_AND_CLOSE
 | \

2204 
MG_F_CLOSE_IMMEDIATELY
 | 
MG_F_IS_WEBSOCKET
 | 
MG_F_DELETE_CHUNK
)

	)

2206 #iâdeà
šŒ_t


2207 
	#šŒ_t
 

	)

2210 
MG_INTERNAL
 
mg_add_cÚn
(
mg_mgr
 *
mgr
, 
mg_cÚÃùiÚ
 *
c
) {

2211 
DBG
(("%°%p", 
mgr
, 
c
));

2212 
	gc
->
	gmgr
 = 
mgr
;

2213 
	gc
->
	gÃxt
 = 
mgr
->
aùive_cÚÃùiÚs
;

2214 
	gmgr
->
	gaùive_cÚÃùiÚs
 = 
c
;

2215 
	gc
->
	g´ev
 = 
NULL
;

2216 ià(
	gc
->
	gÃxt
 !ğ
NULL
è
c
->
Ãxt
->
´ev
 = c;

2217 ià(
	gc
->
	gsock
 !ğ
INVALID_SOCKET
) {

2218 
c
->
içû
->
vbË
->
add_cÚn
(c);

2222 
MG_INTERNAL
 
mg_»move_cÚn
(
mg_cÚÃùiÚ
 *
cÚn
) {

2223 ià(
	gcÚn
->
	g´ev
 =ğ
NULL
è
cÚn
->
mgr
->
aùive_cÚÃùiÚs
 = cÚn->
Ãxt
;

2224 ià(
	gcÚn
->
	g´ev
ècÚn->´ev->
	gÃxt
 = 
cÚn
->
Ãxt
;

2225 ià(
	gcÚn
->
	gÃxt
ècÚn->Ãxt->
	g´ev
 = 
cÚn
->
´ev
;

2226 
	gcÚn
->
	g´ev
 = 
cÚn
->
Ãxt
 = 
NULL
;

2227 
	gcÚn
->
	giçû
->
	gvbË
->
»move_cÚn
(
cÚn
);

2230 
MG_INTERNAL
 
mg_ÿÎ
(
mg_cÚÃùiÚ
 *
nc
,

2231 
mg_ev’t_hªdËr_t
 
ev_hªdËr
, *
u£r_d©a
, 
ev
,

2232 *
ev_d©a
) {

2233 
	gÃ¡šg_Ëv–
 = 0;

2234 
	gÃ¡šg_Ëv–
++;

2235 ià(
	gev_hªdËr
 =ğ
NULL
) {

2240 
ev_hªdËr
 = 
nc
->
´Ùo_hªdËr
 ?‚c->´Ùo_hªdË¸:‚c->
hªdËr
;

2242 ià(
	gev
 !ğ
MG_EV_POLL
) {

2243 
DBG
(("%°% ev=%dƒv_d©a=%°æags=%lu„mbl=%d smbl=%d", 
nc
,

2244 
ev_hªdËr
 =ğ
nc
->
hªdËr
 ? "u£r" : "´Ùo", 
ev
, 
ev_d©a
,‚c->
æags
,

2245 (è
nc
->
»cv_mbuf
.
Ën
, (ènc->
£nd_mbuf
.len));

2248 #ià!
defšed
(
NO_LIBC
è&& 
MG_ENABLE_HEXDUMP


2249 ià(
	gnc
->
	gmgr
->
	ghexdump_fe
 !ğ
NULL
 && 
ev
 !ğ
MG_EV_POLL
 &&ƒv !ğ
MG_EV_RECV
 &&

2250 
ev
 !ğ
MG_EV_SEND
 ) {

2251 
mg_hexdump_cÚÃùiÚ
(
nc
,‚c->
mgr
->
hexdump_fe
, 
NULL
, 0, 
ev
);

2254 ià(
	gev_hªdËr
 !ğ
NULL
) {

2255 
æags_befÜe
 = 
nc
->
æags
;

2256 
size_t
 
	g»cv_mbuf_befÜe
 = 
nc
->
»cv_mbuf
.
Ën
, 
	g»cved
;

2257 
ev_hªdËr
(
nc
, 
ev
, 
ev_d©a
 
MG_UD_ARG
(
u£r_d©a
));

2258 
	g»cved
 = (
»cv_mbuf_befÜe
 - 
nc
->
»cv_mbuf
.
Ën
);

2260 ià(
	gev_hªdËr
 =ğ
nc
->
hªdËr
 &&‚c->
æags
 !ğ
æags_befÜe
) {

2261 
nc
->
æags
 = (
æags_befÜe
 & ~
_MG_CALLBACK_MODIFIABLE_FLAGS_MASK
) |

2262 (
nc
->
æags
 & 
_MG_CALLBACK_MODIFIABLE_FLAGS_MASK
);

2267 ià(
	gÃ¡šg_Ëv–
 =ğ1 && 
»cved
 > 0 && !(
nc
->
æags
 & 
MG_F_UDP
)) {

2268 
nc
->
içû
->
vbË
->
»cved
(nc,„ecved);

2271 ià(
	gev
 !ğ
MG_EV_POLL
) {

2272 
DBG
(("%°aá” % æags=%lu„mbl=%d smbl=%d", 
nc
,

2273 
ev_hªdËr
 =ğ
nc
->
hªdËr
 ? "u£r" : "´Ùo",‚c->
æags
,

2274 (è
nc
->
»cv_mbuf
.
Ën
, (ènc->
£nd_mbuf
.len));

2276 
	gÃ¡šg_Ëv–
--;

2277 #ià!
MG_ENABLE_CALLBACK_USERDATA


2278 (è
	gu£r_d©a
;

2282 
mg_if_tim”
(
mg_cÚÃùiÚ
 *
c
, 
now
) {

2283 ià(
	gc
->
	gev_tim”_time
 > 0 && 
	gnow
 >ğ
c
->
ev_tim”_time
) {

2284 
Şd_v®ue
 = 
c
->
ev_tim”_time
;

2285 
	gc
->
	gev_tim”_time
 = 0;

2286 
mg_ÿÎ
(
c
, 
NULL
, c->
u£r_d©a
, 
MG_EV_TIMER
, &
Şd_v®ue
);

2290 
mg_if_pŞl
(
mg_cÚÃùiÚ
 *
nc
, 
time_t
 
now
) {

2291 ià(!(
	gnc
->
	gæags
 & 
	gMG_F_SSL
è|| (nc->æag & 
	gMG_F_SSL_HANDSHAKE_DONE
)) {

2292 
mg_ÿÎ
(
nc
, 
NULL
,‚c->
u£r_d©a
, 
MG_EV_POLL
, &
now
);

2296 
mg_de¡roy_cÚn
(
mg_cÚÃùiÚ
 *
cÚn
, 
de¡roy_if
) {

2297 ià(
	gde¡roy_if
è
	gcÚn
->
	giçû
->
	gvbË
->
de¡roy_cÚn
(
cÚn
);

2298 ià(
	gcÚn
->
	g´Ùo_d©a
 !ğ
NULL
 && 
cÚn
->
´Ùo_d©a_de¡ruùÜ
 != NULL) {

2299 
cÚn
->
´Ùo_d©a_de¡ruùÜ
(cÚn->
´Ùo_d©a
);

2301 #ià
MG_ENABLE_SSL


2302 
mg_s¦_if_cÚn_ä“
(
cÚn
);

2304 
mbuf_ä“
(&
cÚn
->
»cv_mbuf
);

2305 
mbuf_ä“
(&
cÚn
->
£nd_mbuf
);

2307 
mem£t
(
cÚn
, 0, (*conn));

2308 
MG_FREE
(
cÚn
);

2311 
mg_şo£_cÚn
(
mg_cÚÃùiÚ
 *
cÚn
) {

2312 
DBG
(("%°%lu %d", 
cÚn
, cÚn->
æags
, cÚn->
sock
));

2313 #ià
MG_ENABLE_SSL


2314 ià(
	gcÚn
->
	gæags
 & 
	gMG_F_SSL_HANDSHAKE_DONE
) {

2315 
mg_s¦_if_cÚn_şo£_nÙify
(
cÚn
);

2318 
mg_»move_cÚn
(
cÚn
);

2319 
	gcÚn
->
	giçû
->
	gvbË
->
de¡roy_cÚn
(
cÚn
);

2320 
mg_ÿÎ
(
cÚn
, 
NULL
, cÚn->
u£r_d©a
, 
MG_EV_CLOSE
, NULL);

2321 
mg_de¡roy_cÚn
(
cÚn
, 0 );

2324 
mg_mgr_š™
(
mg_mgr
 *
m
, *
u£r_d©a
) {

2325 
mg_mgr_š™_İts
 
	gİts
;

2326 
mem£t
(&
İts
, 0, (opts));

2327 
mg_mgr_š™_İt
(
m
, 
u£r_d©a
, 
İts
);

2330 
mg_mgr_š™_İt
(
mg_mgr
 *
m
, *
u£r_d©a
,

2331 
mg_mgr_š™_İts
 
İts
) {

2332 
mem£t
(
m
, 0, (*m));

2333 #ià
MG_ENABLE_BROADCAST


2334 
	gm
->
	gùl
[0] = 
m
->
ùl
[1] = 
INVALID_SOCKET
;

2336 
	gm
->
	gu£r_d©a
 = 
u£r_d©a
;

2338 #ifdeà
_WIN32


2340 
WSADATA
 
	gd©a
;

2341 
WSAS¹up
(
MAKEWORD
(2, 2), &
d©a
);

2343 #–ià
defšed
(
__unix__
)

2346 
sigÇl
(
SIGPIPE
, 
SIG_IGN
);

2349 #ià
MG_ENABLE_SSL


2351 
	gš™_dÚe
;

2352 ià(!
	gš™_dÚe
) {

2353 
mg_s¦_if_š™
();

2354 
	gš™_dÚe
++;

2359 
	gi
;

2360 ià(
	gİts
.
	gnum_içûs
 == 0) {

2361 
İts
.
num_içûs
 = 
mg_num_içûs
;

2362 
	gİts
.
	giçûs
 = 
mg_içûs
;

2364 ià(
	gİts
.
	gmaš_içû
 !ğ
NULL
) {

2365 
İts
.
içûs
[
MG_MAIN_IFACE
] = o±s.
maš_içû
;

2367 
	gm
->
	gnum_içûs
 = 
İts
.
num_içûs
;

2368 
	gm
->
	giçûs
 =

2369 (
mg_içû
 **è
MG_MALLOC
((*
m
->
içûs
è* 
İts
.
num_içûs
);

2370 
	gi
 = 0; i < 
	gmg_num_içûs
; i++) {

2371 
	gm
->
	giçûs
[
i
] = 
mg_if_ü—‹_içû
(
İts
.
içûs
[i], 
m
);

2372 
	gm
->
	giçûs
[
i
]->
	gvbË
->
š™
(
m
->
içûs
[i]);

2375 ià(
	gİts
.
	gÇme£rv”
 !ğ
NULL
) {

2376 
m
->
Çme£rv”
 = 
¡rdup
(
İts
.nameserver);

2378 
DBG
(("=================================="));

2379 
DBG
(("š™ mgr=%p", 
m
));

2382 
mg_mgr_ä“
(
mg_mgr
 *
m
) {

2383 
mg_cÚÃùiÚ
 *
	gcÚn
, *
	gtmp_cÚn
;

2385 
DBG
(("%p", 
m
));

2386 ià(
	gm
 =ğ
NULL
) ;

2388 
mg_mgr_pŞl
(
m
, 0);

2390 #ià
MG_ENABLE_BROADCAST


2391 ià(
	gm
->
	gùl
[0] !ğ
INVALID_SOCKET
è
şo£sock‘
(
m
->
ùl
[0]);

2392 ià(
	gm
->
	gùl
[1] !ğ
INVALID_SOCKET
è
şo£sock‘
(
m
->
ùl
[1]);

2393 
	gm
->
	gùl
[0] = 
m
->
ùl
[1] = 
INVALID_SOCKET
;

2396 
	gcÚn
 = 
m
->
aùive_cÚÃùiÚs
; cÚÀ!ğ
NULL
; cÚÀğ
tmp_cÚn
) {

2397 
tmp_cÚn
 = 
cÚn
->
Ãxt
;

2398 
mg_şo£_cÚn
(
cÚn
);

2402 
	gi
;

2403 
	gi
 = 0; i < 
	gm
->
	gnum_içûs
; i++) {

2404 
	gm
->
	giçûs
[
i
]->
	gvbË
->
ä“
(
m
->
içûs
[i]);

2405 
MG_FREE
(
m
->
içûs
[
i
]);

2407 
MG_FREE
(
m
->
içûs
);

2410 
MG_FREE
((*è
m
->
Çme£rv”
);

2413 
time_t
 
mg_mgr_pŞl
(
mg_mgr
 *
m
, 
timeout_ms
) {

2414 
	gi
;

2415 
time_t
 
	gnow
 = 0;

2417 ià(
	gm
->
	gnum_içûs
 == 0) {

2418 
LOG
(
LL_ERROR
, ("cannot…oll:‚o interfaces"));

2422 
	gi
 = 0; i < 
	gm
->
	gnum_içûs
; i++) {

2423 
	gnow
 = 
m
->
içûs
[
i
]->
vbË
->
pŞl
(m->içûs[i], 
timeout_ms
);

2425  
	gnow
;

2428 
mg_v´štf
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
fmt
, 
va_li¡
 
­
) {

2429 
	gmem
[
MG_VPRINTF_BUFFER_SIZE
], *
	gbuf
 = 
mem
;

2430 
	gËn
;

2432 ià((
	gËn
 = 
mg_av´štf
(&
buf
, (
mem
), 
fmt
, 
­
)) > 0) {

2433 
mg_£nd
(
nc
, 
buf
, 
Ën
);

2435 ià(
	gbuf
 !ğ
mem
 && 
buf
 !ğ
NULL
) {

2436 
MG_FREE
(
buf
);

2439  
	gËn
;

2442 
mg_´štf
(
mg_cÚÃùiÚ
 *
cÚn
, cÚ¡ *
fmt
, ...) {

2443 
	gËn
;

2444 
va_li¡
 
	g­
;

2445 
va_¡¬t
(
­
, 
fmt
);

2446 
	gËn
 = 
mg_v´štf
(
cÚn
, 
fmt
, 
­
);

2447 
va_’d
(
­
);

2448  
	gËn
;

2451 #ià
MG_ENABLE_SYNC_RESOLVER


2453 
mg_»sŞve2
(cÚ¡ *
ho¡
, 
š_addr
 *
ša
) {

2454 #ià
MG_ENABLE_GETADDRINFO


2455 
	grv
 = 0;

2456 
addršfo
 
	ghšts
, *
	g£rvšfo
, *
	gp
;

2457 
sockaddr_š
 *
	gh
 = 
NULL
;

2458 
mem£t
(&
hšts
, 0,  hints);

2459 
	ghšts
.
	gai_çmy
 = 
AF_INET
;

2460 
	ghšts
.
	gai_sockty³
 = 
SOCK_STREAM
;

2461 ià((
	grv
 = 
g‘addršfo
(
ho¡
, 
NULL
, NULL, &
£rvšfo
)) != 0) {

2462 
DBG
(("g‘addršfo(%sèçed: %s", 
ho¡
, 
¡»¼Ü
(
mg_g‘_”ºo
())));

2465 
	gp
 = 
£rvšfo
;… !ğ
NULL
;… = 
p
->
ai_Ãxt
) {

2466 
memıy
(&
h
, &
p
->
ai_addr
, (
sockaddr_š
 *));

2467 
memıy
(
ša
, &
h
->
sš_addr
, (ina));

2469 
ä“addršfo
(
£rvšfo
);

2472 
ho¡’t
 *
	ghe
;

2473 ià((
	ghe
 = 
g‘ho¡byÇme
(
ho¡
)è=ğ
NULL
) {

2474 
DBG
(("g‘ho¡byÇme(%sèçed: %s", 
ho¡
, 
¡»¼Ü
(
mg_g‘_”ºo
())));

2476 
memıy
(
ša
, 
he
->
h_addr_li¡
[0], (*ina));

2483 
mg_»sŞve
(cÚ¡ *
ho¡
, *
buf
, 
size_t
 
n
) {

2484 
š_addr
 
	gad
;

2485  
mg_»sŞve2
(
ho¡
, &
ad
è? 
¢´štf
(
buf
, 
n
, "%s", 
š‘_Áß
(ad)) : 0;

2489 
MG_INTERNAL
 
mg_cÚÃùiÚ
 *
mg_ü—‹_cÚÃùiÚ_ba£
(

2490 
mg_mgr
 *
mgr
, 
mg_ev’t_hªdËr_t
 
ÿÎback
,

2491 
mg_add_sock_İts
 
İts
) {

2492 
mg_cÚÃùiÚ
 *
	gcÚn
;

2494 ià((
	gcÚn
 = (
mg_cÚÃùiÚ
 *è
MG_CALLOC
(1, (*
cÚn
))è!ğ
NULL
) {

2495 
cÚn
->
sock
 = 
INVALID_SOCKET
;

2496 
	gcÚn
->
	ghªdËr
 = 
ÿÎback
;

2497 
	gcÚn
->
	gmgr
 = 
mgr
;

2498 
	gcÚn
->
	gÏ¡_io_time
 = (
time_t
è
mg_time
();

2499 
	gcÚn
->
	giçû
 =

2500 (
İts
.
içû
 !ğ
NULL
 ? o±s.içû : 
mgr
->
içûs
[
MG_MAIN_IFACE
]);

2501 
	gcÚn
->
	gæags
 = 
İts
.
æags
 & 
_MG_ALLOWED_CONNECT_FLAGS_MASK
;

2502 
	gcÚn
->
	gu£r_d©a
 = 
İts
.
u£r_d©a
;

2508 
	gcÚn
->
	g»cv_mbuf_lim™
 = ~0;

2510 
MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, "failedo create connection");

2513  
	gcÚn
;

2516 
MG_INTERNAL
 
mg_cÚÃùiÚ
 *
mg_ü—‹_cÚÃùiÚ
(

2517 
mg_mgr
 *
mgr
, 
mg_ev’t_hªdËr_t
 
ÿÎback
,

2518 
mg_add_sock_İts
 
İts
) {

2519 
mg_cÚÃùiÚ
 *
	gcÚn
 = 
mg_ü—‹_cÚÃùiÚ_ba£
(
mgr
, 
ÿÎback
, 
İts
);

2521 ià(
	gcÚn
 !ğ
NULL
 && !
cÚn
->
içû
->
vbË
->
ü—‹_cÚn
(conn)) {

2522 
MG_FREE
(
cÚn
);

2523 
	gcÚn
 = 
NULL
;

2525 ià(
	gcÚn
 =ğ
NULL
) {

2526 
MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, "failedo init connection");

2529  
	gcÚn
;

2545 
MG_INTERNAL
 
mg_·r£_add»ss
(cÚ¡ *
¡r
, 
sock‘_add»ss
 *
§
,

2546 *
´Ùo
, *
ho¡
, 
size_t
 
ho¡_Ën
) {

2547 
	ga
, 
	gb
, 
	gc
, 
	gd
, 
	gpÜt
 = 0;

2548 
	gch
, 
	gËn
 = 0;

2549 #ià
MG_ENABLE_IPV6


2550 
	gbuf
[100];

2558 
mem£t
(
§
, 0, (*sa));

2559 
	g§
->
	gsš
.
	gsš_çmy
 = 
AF_INET
;

2561 *
	g´Ùo
 = 
SOCK_STREAM
;

2563 ià(
¡ºcmp
(
¡r
, "udp://", 6) == 0) {

2564 
¡r
 += 6;

2565 *
	g´Ùo
 = 
SOCK_DGRAM
;

2566 } ià(
¡ºcmp
(
¡r
, "tcp://", 6) == 0) {

2567 
¡r
 += 6;

2570 ià(
ssÿnf
(
¡r
, "%u.%u.%u.%u:%u%n", &
a
, &
b
, &
c
, &
d
, &
pÜt
, &
Ën
) == 5) {

2572 
§
->
sš
.
sš_addr
.
s_addr
 =

2573 
htÚl
(((
ušt32_t
è
a
 << 24è| ((ušt32_tè
b
 << 16è| 
c
 << 8 | 
d
);

2574 
	g§
->
	gsš
.
	gsš_pÜt
 = 
htÚs
((
ušt16_t
è
pÜt
);

2575 #ià
MG_ENABLE_IPV6


2576 } ià(
ssÿnf
(
¡r
, "[%99[^]]]:%u%n", 
buf
, &
pÜt
, &
Ën
) == 2 &&

2577 
š‘_±Ú
(
AF_INET6
, 
buf
, &
§
->
sš6
.
sš6_addr
)) {

2579 
	g§
->
	gsš6
.
	gsš6_çmy
 = 
AF_INET6
;

2580 
	g§
->
	gsš
.
	gsš_pÜt
 = 
htÚs
((
ušt16_t
è
pÜt
);

2582 #ià
MG_ENABLE_ASYNC_RESOLVER


2583 } ià(
¡¾’
(
¡r
è< 
	gho¡_Ën
 &&

2584 
ssÿnf
(
¡r
, "%[^ :]:%u%n", 
ho¡
, &
pÜt
, &
Ën
) == 2) {

2585 
§
->
sš
.
sš_pÜt
 = 
htÚs
((
ušt16_t
è
pÜt
);

2586 ià(
mg_»sŞve_äom_ho¡s_fe
(
ho¡
, 
§
) != 0) {

2593 ià(
mg_nÿ£cmp
(
ho¡
, "localhost", 9) != 0) {

2597 #ià
MG_ENABLE_SYNC_RESOLVER


2598 ià(!
mg_»sŞve2
(
ho¡
, &
§
->
sš
.
sš_addr
)) {

2606 } ià(
ssÿnf
(
¡r
, ":%u%n", &
pÜt
, &
Ën
) == 1 ||

2607 
ssÿnf
(
¡r
, "%u%n", &
pÜt
, &
Ën
) == 1) {

2609 
§
->
sš
.
sš_pÜt
 = 
htÚs
((
ušt16_t
è
pÜt
);

2615 (è
	gho¡
;

2616 (è
	gho¡_Ën
;

2618 
	gch
 = 
¡r
[
Ën
];

2619  
	gpÜt
 < 0xffffUL && (
	gch
 =ğ'\0' || 
ch
 =ğ',' || 
is¥aû
(ch)è? 
Ën
 : -1;

2622 
mg_cÚÃùiÚ
 *
mg_if_acû±_Ãw_cÚn
(mg_cÚÃùiÚ *
lc
) {

2623 
mg_add_sock_İts
 
	gİts
;

2624 
mg_cÚÃùiÚ
 *
	gnc
;

2625 
mem£t
(&
İts
, 0, (opts));

2626 
	gnc
 = 
mg_ü—‹_cÚÃùiÚ
(
lc
->
mgr
,†c->
hªdËr
, 
İts
);

2627 ià(
	gnc
 =ğ
NULL
)  NULL;

2628 
	gnc
->
	gli¡’”
 = 
lc
;

2629 
	gnc
->
	g´Ùo_hªdËr
 = 
lc
->
´Ùo_hªdËr
;

2630 
	gnc
->
	gu£r_d©a
 = 
lc
->
u£r_d©a
;

2631 
	gnc
->
	g»cv_mbuf_lim™
 = 
lc
->
»cv_mbuf_lim™
;

2632 
	gnc
->
	giçû
 = 
lc
->
içû
;

2633 ià(
	glc
->
	gæags
 & 
	gMG_F_SSL
è
	gnc
->æag |ğ
MG_F_SSL
;

2634 
mg_add_cÚn
(
nc
->
mgr
,‚c);

2635 
DBG
(("%°%°%d %d", 
lc
, 
nc
,‚c->
sock
, (ènc->
æags
));

2636  
	gnc
;

2639 
mg_if_acû±_tı_cb
(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
,

2640 
size_t
 
§_Ën
) {

2641 (è
	g§_Ën
;

2642 
	gnc
->
	g§
 = *
§
;

2643 
mg_ÿÎ
(
nc
, 
NULL
,‚c->
u£r_d©a
, 
MG_EV_ACCEPT
, &nc->
§
);

2646 
mg_£nd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
, 
Ën
) {

2647 
	gnc
->
	gÏ¡_io_time
 = (
time_t
è
mg_time
();

2648 ià(
	gnc
->
	gæags
 & 
	gMG_F_UDP
) {

2649 
	gnc
->
	giçû
->
	gvbË
->
udp_£nd
(
nc
, 
buf
, 
Ën
);

2651 
	gnc
->
	giçû
->
	gvbË
->
tı_£nd
(
nc
, 
buf
, 
Ën
);

2655 
mg_if_£Á_cb
(
mg_cÚÃùiÚ
 *
nc
, 
num_£Á
) {

2656 
DBG
(("%°%d", 
nc
, 
num_£Á
));

2657 #ià!
defšed
(
NO_LIBC
è&& 
MG_ENABLE_HEXDUMP


2658 ià(
	gnc
->
	gmgr
 &&‚c->mgr->
	ghexdump_fe
 !ğ
NULL
) {

2659 *
buf
 = 
nc
->
£nd_mbuf
.buf;

2660 
mg_hexdump_cÚÃùiÚ
(
nc
,‚c->
mgr
->
hexdump_fe
, 
buf
, 
num_£Á
, 
MG_EV_SEND
);

2663 ià(
	gnum_£Á
 < 0) {

2664 
	gnc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

2666 
mbuf_»move
(&
nc
->
£nd_mbuf
, 
num_£Á
);

2667 
mbuf_Œim
(&
nc
->
£nd_mbuf
);

2669 
mg_ÿÎ
(
nc
, 
NULL
,‚c->
u£r_d©a
, 
MG_EV_SEND
, &
num_£Á
);

2672 
MG_INTERNAL
 
mg_»cv_commÚ
(
mg_cÚÃùiÚ
 *
nc
, *
buf
, 
Ën
,

2673 
own
) {

2674 
DBG
(("%°%d %u", 
nc
, 
Ën
, (ènc->
»cv_mbuf
.len));

2676 #ià!
defšed
(
NO_LIBC
è&& 
MG_ENABLE_HEXDUMP


2677 ià(
	gnc
->
	gmgr
 &&‚c->mgr->
	ghexdump_fe
 !ğ
NULL
) {

2678 
mg_hexdump_cÚÃùiÚ
(
nc
,‚c->
mgr
->
hexdump_fe
, 
buf
, 
Ën
, 
MG_EV_RECV
);

2682 ià(
	gnc
->
	gæags
 & 
	gMG_F_CLOSE_IMMEDIATELY
) {

2683 
DBG
(("%°disÿrded %d by‹s", 
nc
, 
Ën
));

2688 ià(
	gown
) {

2689 
MG_FREE
(
buf
);

2693 
	gnc
->
	gÏ¡_io_time
 = (
time_t
è
mg_time
();

2694 ià(!
	gown
) {

2695 
mbuf_­³nd
(&
nc
->
»cv_mbuf
, 
buf
, 
Ën
);

2696 } ià(
	gnc
->
	g»cv_mbuf
.
	gËn
 == 0) {

2698 
mbuf_ä“
(&
nc
->
»cv_mbuf
);

2699 
	gnc
->
	g»cv_mbuf
.
	gbuf
 = (*è
buf
;

2700 
	gnc
->
	g»cv_mbuf
.
	gsize
 = 
nc
->
»cv_mbuf
.
Ën
 =†en;

2702 
mbuf_­³nd
(&
nc
->
»cv_mbuf
, 
buf
, 
Ën
);

2703 
MG_FREE
(
buf
);

2705 
mg_ÿÎ
(
nc
, 
NULL
,‚c->
u£r_d©a
, 
MG_EV_RECV
, &
Ën
);

2708 
mg_if_»cv_tı_cb
(
mg_cÚÃùiÚ
 *
nc
, *
buf
, 
Ën
, 
own
) {

2709 
mg_»cv_commÚ
(
nc
, 
buf
, 
Ën
, 
own
);

2712 
mg_if_»cv_udp_cb
(
mg_cÚÃùiÚ
 *
nc
, *
buf
, 
Ën
,

2713 
sock‘_add»ss
 *
§
, 
size_t
 
§_Ën
) {

2714 
as£¹
(
nc
->
æags
 & 
MG_F_UDP
);

2715 
DBG
(("%°%u", 
nc
, (è
Ën
));

2716 ià(
	gnc
->
	gæags
 & 
	gMG_F_LISTENING
) {

2717 
mg_cÚÃùiÚ
 *
	glc
 = 
nc
;

2722 
	gnc
 = 
mg_Ãxt
(
lc
->
mgr
, 
NULL
);‚ø!ğNULL;‚øğmg_ÃxtÖc->mgr, 
nc
)) {

2723 ià(
memcmp
(&
nc
->
§
.§, &§->§, 
§_Ën
è=ğ0 &&‚c->
li¡’”
 =ğ
lc
) {

2727 ià(
	gnc
 =ğ
NULL
) {

2728 
mg_add_sock_İts
 
İts
;

2729 
mem£t
(&
İts
, 0, (opts));

2731 
	gnc
 = 
mg_ü—‹_cÚÃùiÚ_ba£
(
lc
->
mgr
,†c->
hªdËr
, 
İts
);

2732 ià(
	gnc
 !ğ
NULL
) {

2733 
nc
->
sock
 = 
lc
->sock;

2734 
	gnc
->
	gli¡’”
 = 
lc
;

2735 
	gnc
->
	g§
 = *
§
;

2736 
	gnc
->
	g´Ùo_hªdËr
 = 
lc
->
´Ùo_hªdËr
;

2737 
	gnc
->
	gu£r_d©a
 = 
lc
->
u£r_d©a
;

2738 
	gnc
->
	g»cv_mbuf_lim™
 = 
lc
->
»cv_mbuf_lim™
;

2739 
	gnc
->
	gæags
 = 
MG_F_UDP
;

2751 
	gnc
->
	gæags
 |ğ
MG_F_SEND_AND_CLOSE
;

2752 
mg_add_cÚn
(
lc
->
mgr
, 
nc
);

2753 
mg_ÿÎ
(
nc
, 
NULL
,‚c->
u£r_d©a
, 
MG_EV_ACCEPT
, &nc->
§
);

2755 
DBG
(("OOM"));

2760 ià(
	gnc
 !ğ
NULL
) {

2761 
mg_»cv_commÚ
(
nc
, 
buf
, 
Ën
, 1);

2764 
MG_FREE
(
buf
);

2765 
	gnc
->
	giçû
->
	gvbË
->
»cved
(
nc
, 
Ën
);

2775 
MG_INTERNAL
 
mg_cÚÃùiÚ
 *
mg_do_cÚÃù
(mg_cÚÃùiÚ *
nc
,

2776 
´Ùo
,

2777 
sock‘_add»ss
 *
§
) {

2778 
DBG
(("%°%s://%s:%hu", 
nc
, 
´Ùo
 =ğ
SOCK_DGRAM
 ? "udp" : "tcp",

2779 
š‘_Áß
(
§
->
sš
.
sš_addr
), 
Áohs
(§->sš.
sš_pÜt
)));

2781 
	gnc
->
	gæags
 |ğ
MG_F_CONNECTING
;

2782 ià(
	g´Ùo
 =ğ
SOCK_DGRAM
) {

2783 
nc
->
içû
->
vbË
->
cÚÃù_udp
(nc);

2785 
	gnc
->
	giçû
->
	gvbË
->
cÚÃù_tı
(
nc
, 
§
);

2787 
mg_add_cÚn
(
nc
->
mgr
,‚c);

2788  
	gnc
;

2791 
mg_if_cÚÃù_cb
(
mg_cÚÃùiÚ
 *
nc
, 
”r
) {

2792 
DBG
(("%°cÚÃù,ƒ¼=%d", 
nc
, 
”r
));

2793 
	gnc
->
	gæags
 &ğ~
MG_F_CONNECTING
;

2794 ià(
	g”r
 != 0) {

2795 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

2797 
mg_ÿÎ
(
nc
, 
NULL
,‚c->
u£r_d©a
, 
MG_EV_CONNECT
, &
”r
);

2800 #ià
MG_ENABLE_ASYNC_RESOLVER


2807 
»sŞve_cb
(
mg_dns_mes§ge
 *
msg
, *
d©a
,

2808 
mg_»sŞve_”r
 
e
) {

2809 
mg_cÚÃùiÚ
 *
	gnc
 = (mg_cÚÃùiÚ *è
d©a
;

2810 
	gi
;

2811 
	gçu»
 = -1;

2813 
	gnc
->
	gæags
 &ğ~
MG_F_RESOLVING
;

2814 ià(
	gmsg
 !ğ
NULL
) {

2818 
i
 = 0; 
	gi
 < 
	gmsg
->
	gnum_ªsw”s
; i++) {

2819 ià(
	gmsg
->
	gªsw”s
[
i
].
	g¹y³
 =ğ
MG_DNS_A_RECORD
) {

2824 
mg_dns_·r£_»cÜd_d©a
(
msg
, &msg->
ªsw”s
[
i
], &
nc
->
§
.
sš
.
sš_addr
,

2826 
mg_do_cÚÃù
(
nc
,‚c->
æags
 & 
MG_F_UDP
 ? 
SOCK_DGRAM
 : 
SOCK_STREAM
,

2827 &
nc
->
§
);

2833 ià(
	ge
 =ğ
MG_RESOLVE_TIMEOUT
) {

2834 
now
 = 
mg_time
();

2835 
mg_ÿÎ
(
nc
, 
NULL
,‚c->
u£r_d©a
, 
MG_EV_TIMER
, &
now
);

2841 
mg_ÿÎ
(
nc
, 
NULL
,‚c->
u£r_d©a
, 
MG_EV_CONNECT
, &
çu»
);

2842 
mg_ÿÎ
(
nc
, 
NULL
,‚c->
u£r_d©a
, 
MG_EV_CLOSE
, NULL);

2843 
mg_de¡roy_cÚn
(
nc
, 1 );

2847 
mg_cÚÃùiÚ
 *
mg_cÚÃù
(
mg_mgr
 *
mgr
, cÚ¡ *
add»ss
,

2848 
MG_CB
(
mg_ev’t_hªdËr_t
 
ÿÎback
,

2849 *
u£r_d©a
)) {

2850 
mg_cÚÃù_İts
 
	gİts
;

2851 
mem£t
(&
İts
, 0, (opts));

2852  
mg_cÚÃù_İt
(
mgr
, 
add»ss
, 
MG_CB
(
ÿÎback
, 
u£r_d©a
), 
İts
);

2855 
mg_cÚÃùiÚ
 *
mg_cÚÃù_İt
(
mg_mgr
 *
mgr
, cÚ¡ *
add»ss
,

2856 
MG_CB
(
mg_ev’t_hªdËr_t
 
ÿÎback
,

2857 *
u£r_d©a
),

2858 
mg_cÚÃù_İts
 
İts
) {

2859 
mg_cÚÃùiÚ
 *
	gnc
 = 
NULL
;

2860 
	g´Ùo
, 
	grc
;

2861 
mg_add_sock_İts
 
	gadd_sock_İts
;

2862 
	gho¡
[
MG_MAX_HOST_LEN
];

2864 
MG_COPY_COMMON_CONNECTION_OPTIONS
(&
add_sock_İts
, &
İts
);

2866 ià((
	gnc
 = 
mg_ü—‹_cÚÃùiÚ
(
mgr
, 
ÿÎback
, 
add_sock_İts
)è=ğ
NULL
) {

2867  
NULL
;

2870 ià((
	grc
 = 
mg_·r£_add»ss
(
add»ss
, &
nc
->
§
, &
´Ùo
, 
ho¡
, (host))) <

2873 
MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, "cannot…arse‡ddress");

2874 
mg_de¡roy_cÚn
(
nc
, 1 );

2875  
	gNULL
;

2878 
	gnc
->
	gæags
 |ğ
İts
.
æags
 & 
_MG_ALLOWED_CONNECT_FLAGS_MASK
;

2879 
	gnc
->
	gæags
 |ğ(
´Ùo
 =ğ
SOCK_DGRAM
è? 
MG_F_UDP
 : 0;

2880 #ià
MG_ENABLE_CALLBACK_USERDATA


2881 
	gnc
->
	gu£r_d©a
 = 
u£r_d©a
;

2883 
	gnc
->
	gu£r_d©a
 = 
İts
.
u£r_d©a
;

2886 #ià
MG_ENABLE_SSL


2887 
DBG
(("%°% %s,%s,%s", 
nc
, 
add»ss
, (
İts
.
s¦_û¹
 ? opts.ssl_cert : "-"),

2888 (
İts
.
s¦_key
 ? opts.ssl_key : "-"),

2889 (
İts
.
s¦_ÿ_û¹
 ? opts.ssl_ca_cert : "-")));

2891 ià(
	gİts
.
	gs¦_û¹
 !ğ
NULL
 || 
İts
.
s¦_ÿ_û¹
 != NULL ||

2892 
İts
.
s¦_psk_id’t™y
 !ğ
NULL
) {

2893 cÚ¡ *
”r_msg
 = 
NULL
;

2894 
mg_s¦_if_cÚn_·¿ms
 
	g·¿ms
;

2895 ià(
	gnc
->
	gæags
 & 
	gMG_F_UDP
) {

2896 
MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, "SSL for UDP is‚ot supported");

2897 
mg_de¡roy_cÚn
(
nc
, 1 );

2898  
	gNULL
;

2900 
mem£t
(&
·¿ms
, 0, (params));

2901 
	g·¿ms
.
	gû¹
 = 
İts
.
s¦_û¹
;

2902 
	g·¿ms
.
	gkey
 = 
İts
.
s¦_key
;

2903 
	g·¿ms
.
	gÿ_û¹
 = 
İts
.
s¦_ÿ_û¹
;

2904 
	g·¿ms
.
	gch”_su™es
 = 
İts
.
s¦_ch”_su™es
;

2905 
	g·¿ms
.
	gpsk_id’t™y
 = 
İts
.
s¦_psk_id’t™y
;

2906 
	g·¿ms
.
	gpsk_key
 = 
İts
.
s¦_psk_key
;

2907 ià(
	gİts
.
	gs¦_ÿ_û¹
 !ğ
NULL
) {

2908 ià(
İts
.
s¦_£rv”_Çme
 !ğ
NULL
) {

2909 ià(
¡rcmp
(
İts
.
s¦_£rv”_Çme
, "*") != 0) {

2910 
·¿ms
.
£rv”_Çme
 = 
İts
.
s¦_£rv”_Çme
;

2912 } ià(
	grc
 == 0) {

2913 
·¿ms
.
£rv”_Çme
 = 
ho¡
;

2916 ià(
mg_s¦_if_cÚn_š™
(
nc
, &
·¿ms
, &
”r_msg
è!ğ
MG_SSL_OK
) {

2917 
MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, 
”r_msg
);

2918 
mg_de¡roy_cÚn
(
nc
, 1 );

2919  
	gNULL
;

2921 
	gnc
->
	gæags
 |ğ
MG_F_SSL
;

2925 ià(
	grc
 == 0) {

2926 #ià
MG_ENABLE_ASYNC_RESOLVER


2931 
mg_cÚÃùiÚ
 *
dns_cÚn
 = 
NULL
;

2932 
mg_»sŞve_async_İts
 
	go
;

2933 
mem£t
(&
o
, 0, (o));

2934 
	go
.
	gdns_cÚn
 = &
dns_cÚn
;

2935 
	go
.
	gÇme£rv”
 = 
İts
.
Çme£rv”
;

2936 ià(
mg_»sŞve_async_İt
(
nc
->
mgr
, 
ho¡
, 
MG_DNS_A_RECORD
, 
»sŞve_cb
,‚c,

2937 
o
) != 0) {

2938 
MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, "cannot schedule DNS†ookup");

2939 
mg_de¡roy_cÚn
(
nc
, 1 );

2940  
	gNULL
;

2942 
	gnc
->
	g´iv_2
 = 
dns_cÚn
;

2943 
	gnc
->
	gæags
 |ğ
MG_F_RESOLVING
;

2944  
	gnc
;

2946 
MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, "Resolver is disabled");

2947 
mg_de¡roy_cÚn
(
nc
, 1 );

2948  
	gNULL
;

2952  
mg_do_cÚÃù
(
nc
, 
´Ùo
, &nc->
§
);

2956 
mg_cÚÃùiÚ
 *
mg_bšd
(
mg_mgr
 *
¤v
, cÚ¡ *
add»ss
,

2957 
MG_CB
(
mg_ev’t_hªdËr_t
 
ev’t_hªdËr
,

2958 *
u£r_d©a
)) {

2959 
mg_bšd_İts
 
	gİts
;

2960 
mem£t
(&
İts
, 0, (opts));

2961  
mg_bšd_İt
(
¤v
, 
add»ss
, 
MG_CB
(
ev’t_hªdËr
, 
u£r_d©a
), 
İts
);

2964 
mg_cÚÃùiÚ
 *
mg_bšd_İt
(
mg_mgr
 *
mgr
, cÚ¡ *
add»ss
,

2965 
MG_CB
(
mg_ev’t_hªdËr_t
 
ÿÎback
,

2966 *
u£r_d©a
),

2967 
mg_bšd_İts
 
İts
) {

2968 
sock‘_add»ss
 
	g§
;

2969 
mg_cÚÃùiÚ
 *
	gnc
 = 
NULL
;

2970 
	g´Ùo
, 
	grc
;

2971 
mg_add_sock_İts
 
	gadd_sock_İts
;

2972 
	gho¡
[
MG_MAX_HOST_LEN
];

2974 #ià
MG_ENABLE_CALLBACK_USERDATA


2975 
	gİts
.
	gu£r_d©a
 = 
u£r_d©a
;

2978 
MG_COPY_COMMON_CONNECTION_OPTIONS
(&
add_sock_İts
, &
İts
);

2980 #ià
MG_ENABLE_TUN


2981 ià(
mg_¡ºcmp
(
mg_mk_¡r
(
add»ss
), mg_mk_str("ws://"), 5) == 0 ||

2982 
mg_¡ºcmp
(
mg_mk_¡r
(
add»ss
), mg_mk_str("wss://"), 6) == 0) {

2983  
mg_tun_bšd_İt
(
mgr
, 
add»ss
, 
MG_CB
(
ÿÎback
, 
u£r_d©a
), 
İts
);

2987 ià(
mg_·r£_add»ss
(
add»ss
, &
§
, &
´Ùo
, 
ho¡
, (host)) <= 0) {

2988 
MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, "cannot…arse‡ddress");

2989  
	gNULL
;

2992 
	gnc
 = 
mg_ü—‹_cÚÃùiÚ
(
mgr
, 
ÿÎback
, 
add_sock_İts
);

2993 ià(
	gnc
 =ğ
NULL
) {

2994  
NULL
;

2997 
	gnc
->
	g§
 = 
§
;

2998 
	gnc
->
	gæags
 |ğ
MG_F_LISTENING
;

2999 ià(
	g´Ùo
 =ğ
SOCK_DGRAM
è
nc
->
æags
 |ğ
MG_F_UDP
;

3001 #ià
MG_ENABLE_SSL


3002 
DBG
(("%°% %s,%s,%s", 
nc
, 
add»ss
, (
İts
.
s¦_û¹
 ? opts.ssl_cert : "-"),

3003 (
İts
.
s¦_key
 ? opts.ssl_key : "-"),

3004 (
İts
.
s¦_ÿ_û¹
 ? opts.ssl_ca_cert : "-")));

3006 ià(
	gİts
.
	gs¦_û¹
 !ğ
NULL
 || 
İts
.
s¦_ÿ_û¹
 != NULL) {

3007 cÚ¡ *
”r_msg
 = 
NULL
;

3008 
mg_s¦_if_cÚn_·¿ms
 
	g·¿ms
;

3009 ià(
	gnc
->
	gæags
 & 
	gMG_F_UDP
) {

3010 
MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, "SSL for UDP is‚ot supported");

3011 
mg_de¡roy_cÚn
(
nc
, 1 );

3012  
	gNULL
;

3014 
mem£t
(&
·¿ms
, 0, (params));

3015 
	g·¿ms
.
	gû¹
 = 
İts
.
s¦_û¹
;

3016 
	g·¿ms
.
	gkey
 = 
İts
.
s¦_key
;

3017 
	g·¿ms
.
	gÿ_û¹
 = 
İts
.
s¦_ÿ_û¹
;

3018 
	g·¿ms
.
	gch”_su™es
 = 
İts
.
s¦_ch”_su™es
;

3019 ià(
mg_s¦_if_cÚn_š™
(
nc
, &
·¿ms
, &
”r_msg
è!ğ
MG_SSL_OK
) {

3020 
MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, 
”r_msg
);

3021 
mg_de¡roy_cÚn
(
nc
, 1 );

3022  
	gNULL
;

3024 
	gnc
->
	gæags
 |ğ
MG_F_SSL
;

3028 ià(
	gnc
->
	gæags
 & 
	gMG_F_UDP
) {

3029 
	grc
 = 
nc
->
içû
->
vbË
->
li¡’_udp
Òc, &nc->
§
);

3031 
	grc
 = 
nc
->
içû
->
vbË
->
li¡’_tı
Òc, &nc->
§
);

3033 ià(
	grc
 != 0) {

3034 
DBG
(("FaedØİ’†i¡’”: %d", 
rc
));

3035 
MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, "failedo open†istener");

3036 
mg_de¡roy_cÚn
(
nc
, 1 );

3037  
	gNULL
;

3039 
mg_add_cÚn
(
nc
->
mgr
,‚c);

3041  
	gnc
;

3044 
mg_cÚÃùiÚ
 *
mg_Ãxt
(
mg_mgr
 *
s
, mg_cÚÃùiÚ *
cÚn
) {

3045  
	gcÚn
 =ğ
NULL
 ? 
s
->
aùive_cÚÃùiÚs
 : 
cÚn
->
Ãxt
;

3048 #ià
MG_ENABLE_BROADCAST


3049 
mg_brßdÿ¡
(
mg_mgr
 *
mgr
, 
mg_ev’t_hªdËr_t
 
cb
, *
d©a
,

3050 
size_t
 
Ën
) {

3051 
ùl_msg
 
	gùl_msg
;

3060 ià(
	gmgr
->
	gùl
[0] !ğ
INVALID_SOCKET
 && 
d©a
 !ğ
NULL
 &&

3061 
Ën
 < (
ùl_msg
.
mes§ge
)) {

3062 
size_t
 
dummy
;

3064 
	gùl_msg
.
	gÿÎback
 = 
cb
;

3065 
memıy
(
ùl_msg
.
mes§ge
, 
d©a
, 
Ën
);

3066 
	gdummy
 = 
MG_SEND_FUNC
(
mgr
->
ùl
[0], (*è&
ùl_msg
,

3067 
off£tof
(
ùl_msg
, 
mes§ge
è+ 
Ën
, 0);

3068 
	gdummy
 = 
MG_RECV_FUNC
(
mgr
->
ùl
[0], (*è&
Ën
, 1, 0);

3069 (è
	gdummy
;

3074 
isby‹
(
n
) {

3075  
	gn
 >ğ0 && 
n
 <= 255;

3078 
·r£_Ãt
(cÚ¡ *
¥ec
, 
ušt32_t
 *
Ãt
, ušt32_ˆ*
mask
) {

3079 
	gn
, 
	ga
, 
	gb
, 
	gc
, 
	gd
, 
	g¦ash
 = 32, 
	gËn
 = 0;

3081 ià((
ssÿnf
(
¥ec
, "%d.%d.%d.%d/%d%n", &
a
, &
b
, &
c
, &
d
, &
¦ash
, &
n
) == 5 ||

3082 
ssÿnf
(
¥ec
, "%d.%d.%d.%d%n", &
a
, &
b
, &
c
, &
d
, &
n
) == 4) &&

3083 
isby‹
(
a
è&& isby‹(
b
è&& isby‹(
c
è&& isby‹(
d
è&& 
¦ash
 >= 0 &&

3084 
¦ash
 < 33) {

3085 
Ën
 = 
n
;

3086 *
	gÃt
 =

3087 ((
ušt32_t
è
a
 << 24è| ((ušt32_tè
b
 << 16è| ((ušt32_tè
c
 << 8è| 
d
;

3088 *
	gmask
 = 
¦ash
 ? 0xffffffffU << (32 - slash) : 0;

3091  
	gËn
;

3094 
mg_check__aş
(cÚ¡ *
aş
, 
ušt32_t
 
»mÙe_
) {

3095 
	g®lowed
, 
	gæag
;

3096 
ušt32_t
 
	gÃt
, 
	gmask
;

3097 
mg_¡r
 
	gvec
;

3100 
	g®lowed
 = (
aş
 =ğ
NULL
 || *acl == '\0') ? '+' : '-';

3102 (
	gaş
 = 
mg_Ãxt_comma_li¡_’Œy
(
aş
, &
vec
, 
NULL
)) != NULL) {

3103 
æag
 = 
vec
.
p
[0];

3104 ià((
	gæag
 !ğ'+' && 
æag
 != '-') ||

3105 
·r£_Ãt
(&
vec
.
p
[1], &
Ãt
, &
mask
) == 0) {

3109 ià(
	gÃt
 =ğ(
»mÙe_
 & 
mask
)) {

3110 
®lowed
 = 
æag
;

3114 
DBG
(("%08x %c", (è
»mÙe_
, 
®lowed
));

3115  
	g®lowed
 == '+';

3119 
mg_fÜw¬d
(
mg_cÚÃùiÚ
 *
äom
, mg_cÚÃùiÚ *
to
) {

3120 
mg_£nd
(
to
, 
äom
->
»cv_mbuf
.
buf
, from->»cv_mbuf.
Ën
);

3121 
mbuf_»move
(&
äom
->
»cv_mbuf
, from->»cv_mbuf.
Ën
);

3124 
mg_£t_tim”
(
mg_cÚÃùiÚ
 *
c
, 
time¡amp
) {

3125 
	g»suÉ
 = 
c
->
ev_tim”_time
;

3126 
	gc
->
	gev_tim”_time
 = 
time¡amp
;

3132 
DBG
(("%°%°%d -> %lu", 
c
, c->
´iv_2
, (c->
æags
 & 
MG_F_RESOLVING
 ? 1 : 0),

3133 (è
time¡amp
));

3134 ià((
	gc
->
	gæags
 & 
	gMG_F_RESOLVING
è&& c->
	g´iv_2
 !ğ
NULL
) {

3135 ((
mg_cÚÃùiÚ
 *è
c
->
´iv_2
)->
ev_tim”_time
 = 
time¡amp
;

3137  
	g»suÉ
;

3140 
mg_sock_£t
(
mg_cÚÃùiÚ
 *
nc
, 
sock_t
 
sock
) {

3141 ià(
	gsock
 !ğ
INVALID_SOCKET
) {

3142 
nc
->
içû
->
vbË
->
sock_£t
Òc, 
sock
);

3146 
mg_if_g‘_cÚn_addr
(
mg_cÚÃùiÚ
 *
nc
, 
»mÙe
,

3147 
sock‘_add»ss
 *
§
) {

3148 
	gnc
->
	giçû
->
	gvbË
->
g‘_cÚn_addr
(
nc
, 
»mÙe
, 
§
);

3151 
mg_cÚÃùiÚ
 *
mg_add_sock_İt
(
mg_mgr
 *
s
, 
sock_t
 
sock
,

3152 
MG_CB
(
mg_ev’t_hªdËr_t
 
ÿÎback
,

3153 *
u£r_d©a
),

3154 
mg_add_sock_İts
 
İts
) {

3155 #ià
MG_ENABLE_CALLBACK_USERDATA


3156 
	gİts
.
	gu£r_d©a
 = 
u£r_d©a
;

3159 
mg_cÚÃùiÚ
 *
	gnc
 = 
mg_ü—‹_cÚÃùiÚ_ba£
(
s
, 
ÿÎback
, 
İts
);

3160 ià(
	gnc
 !ğ
NULL
) {

3161 
mg_sock_£t
(
nc
, 
sock
);

3162 
mg_add_cÚn
(
nc
->
mgr
,‚c);

3164  
	gnc
;

3167 
mg_cÚÃùiÚ
 *
mg_add_sock
(
mg_mgr
 *
s
, 
sock_t
 
sock
,

3168 
MG_CB
(
mg_ev’t_hªdËr_t
 
ÿÎback
,

3169 *
u£r_d©a
)) {

3170 
mg_add_sock_İts
 
	gİts
;

3171 
mem£t
(&
İts
, 0, (opts));

3172  
mg_add_sock_İt
(
s
, 
sock
, 
MG_CB
(
ÿÎback
, 
u£r_d©a
), 
İts
);

3175 
mg_time
() {

3176  
cs_time
();

3178 #ifdeà
MG_MODULE_LINES


3186 #iâdeà
CS_MONGOOSE_SRC_NET_IF_SOCKET_H_


3187 
	#CS_MONGOOSE_SRC_NET_IF_SOCKET_H_


	)

3191 #ifdeà
__ılu¥lus


3195 #iâdeà
MG_ENABLE_NET_IF_SOCKET


3196 
	#MG_ENABLE_NET_IF_SOCKET
 
MG_NET_IF
 =ğ
MG_NET_IF_SOCKET


	)

3199 cÚ¡ 
mg_içû_vbË
 
mg_sock‘_içû_vbË
;

3201 #ifdeà
__ılu¥lus


3206 #ifdeà
MG_MODULE_LINES


3214 #iâdeà
CS_MONGOOSE_SRC_NET_IF_TUN_H_


3215 
	#CS_MONGOOSE_SRC_NET_IF_TUN_H_


	)

3217 #ià
MG_ENABLE_TUN


3221 
	gmg_tun_ş›Á
;

3223 #ifdeà
__ılu¥lus


3227 cÚ¡ 
mg_içû_vbË
 
mg_tun_içû_vbË
;

3229 
mg_cÚÃùiÚ
 *
mg_tun_if_fšd_cÚn
(
mg_tun_ş›Á
 *
ş›Á
,

3230 
ušt32_t
 
¡»am_id
);

3232 #ifdeà
__ılu¥lus


3239 #ifdeà
MG_MODULE_LINES


3247 #iâdeà
CS_MONGOOSE_SRC_NET_IF_SOCKS_H_


3248 
	#CS_MONGOOSE_SRC_NET_IF_SOCKS_H_


	)

3250 #ià
MG_ENABLE_SOCKS


3253 #ifdeà
__ılu¥lus


3257 cÚ¡ 
mg_içû_vbË
 
mg_socks_içû_vbË
;

3259 #ifdeà
__ılu¥lus


3264 #ifdeà
MG_MODULE_LINES


3272 cÚ¡ 
mg_içû_vbË
 
mg_deçuÉ_içû_vbË
;

3274 cÚ¡ 
mg_içû_vbË
 *
	gmg_içûs
[] = {

3275 &
mg_deçuÉ_içû_vbË
,

3276 #ià
MG_ENABLE_TUN


3277 &
mg_tun_içû_vbË
,

3281 
	gmg_num_içûs
 = (è((
mg_içûs
) / (mg_ifaces[0]));

3283 
mg_içû
 *
mg_if_ü—‹_içû
(cÚ¡ 
mg_içû_vbË
 *
vbË
,

3284 
mg_mgr
 *
mgr
) {

3285 
mg_içû
 *
	giçû
 = (mg_içû *è
MG_CALLOC
(1, (*
içû
));

3286 
	giçû
->
	gmgr
 = 
mgr
;

3287 
	giçû
->
	gd©a
 = 
NULL
;

3288 
	giçû
->
	gvbË
 = 
vbË
;

3289  
	giçû
;

3292 
mg_içû
 *
mg_fšd_içû
(
mg_mgr
 *
mgr
,

3293 cÚ¡ 
mg_içû_vbË
 *
vbË
,

3294 
mg_içû
 *
äom
) {

3295 
	gi
 = 0;

3296 ià(
	gäom
 !ğ
NULL
) {

3297 
i
 = 0; 
	gi
 < 
	gmgr
->
	gnum_içûs
; i++) {

3298 ià(
	gmgr
->
	giçûs
[
i
] =ğ
äom
) {

3299 
i
++;

3305 ; 
	gi
 < 
	gmgr
->
	gnum_içûs
; i++) {

3306 ià(
	gmgr
->
	giçûs
[
i
]->
	gvbË
 =ğ
vbË
) {

3307  
mgr
->
içûs
[
i
];

3310  
	gNULL
;

3312 #ifdeà
MG_MODULE_LINES


3320 #ià
MG_ENABLE_NET_IF_SOCKET


3326 
	#MG_TCP_RECV_BUFFER_SIZE
 1024

	)

3327 
	#MG_UDP_RECV_BUFFER_SIZE
 1500

	)

3329 
sock_t
 
mg_İ’_li¡’šg_sock‘
(
sock‘_add»ss
 *
§
, 
ty³
,

3330 
´Ùo
);

3331 #ià
MG_ENABLE_SSL


3332 
mg_s¦_begš
(
mg_cÚÃùiÚ
 *
nc
);

3335 
mg_£t_nÚ_blockšg_mode
(
sock_t
 
sock
) {

3336 #ifdeà
_WIN32


3337 
	gÚ
 = 1;

3338 
ioùlsock‘
(
sock
, 
FIONBIO
, &
Ú
);

3340 
	gæags
 = 
fú
(
sock
, 
F_GETFL
, 0);

3341 
fú
(
sock
, 
F_SETFL
, 
æags
 | 
O_NONBLOCK
);

3345 
mg_is_”rÜ
() {

3346 
	g”r
 = 
mg_g‘_”ºo
();

3347  
	g”r
 !ğ
EINPROGRESS
 && 
”r
 !ğ
EWOULDBLOCK


3348 #iâdeà
WINCE


3349 && 
”r
 !ğ
EAGAIN
 &&ƒ¼ !ğ
EINTR


3351 #ifdeà
_WIN32


3352 && 
WSAG‘La¡E¼Ü
(è!ğ
WSAEINTR
 && WSAG‘La¡E¼Ü(è!ğ
WSAEWOULDBLOCK


3357 
mg_sock‘_if_cÚÃù_tı
(
mg_cÚÃùiÚ
 *
nc
,

3358 cÚ¡ 
sock‘_add»ss
 *
§
) {

3359 
	grc
, 
	g´Ùo
 = 0;

3360 
	gnc
->
	gsock
 = 
sock‘
(
AF_INET
, 
SOCK_STREAM
, 
´Ùo
);

3361 ià(
	gnc
->
	gsock
 =ğ
INVALID_SOCKET
) {

3362 
nc
->
”r
 = 
mg_g‘_”ºo
() ? mg_get_errno() : 1;

3365 #ià!
defšed
(
MG_ESP8266
)

3366 
mg_£t_nÚ_blockšg_mode
(
nc
->
sock
);

3368 
	grc
 = 
cÚÃù
(
nc
->
sock
, &
§
->§, (§->
sš
));

3369 
	gnc
->
	g”r
 = 
rc
 < 0 && 
mg_is_”rÜ
(è? 
mg_g‘_”ºo
() : 0;

3370 
DBG
(("%°sock %d„ø%dƒ¼nØ%dƒ¼ %d", 
nc
,‚c->
sock
, 
rc
, 
mg_g‘_”ºo
(),

3371 
nc
->
”r
));

3374 
mg_sock‘_if_cÚÃù_udp
(
mg_cÚÃùiÚ
 *
nc
) {

3375 
	gnc
->
	gsock
 = 
sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

3376 ià(
	gnc
->
	gsock
 =ğ
INVALID_SOCKET
) {

3377 
nc
->
”r
 = 
mg_g‘_”ºo
() ? mg_get_errno() : 1;

3380 ià(
	gnc
->
	gæags
 & 
	gMG_F_ENABLE_BROADCAST
) {

3381 
	gİtv®
 = 1;

3382 
£tsockİt
(
nc
->
sock
, 
SOL_SOCKET
, 
SO_BROADCAST
, (cÚ¡ *è&
İtv®
,

3383 (
İtv®
));

3385 
	gnc
->
	g”r
 = 0;

3388 
mg_sock‘_if_li¡’_tı
(
mg_cÚÃùiÚ
 *
nc
,

3389 
sock‘_add»ss
 *
§
) {

3390 
	g´Ùo
 = 0;

3391 
sock_t
 
	gsock
 = 
mg_İ’_li¡’šg_sock‘
(
§
, 
SOCK_STREAM
, 
´Ùo
);

3392 ià(
	gsock
 =ğ
INVALID_SOCKET
) {

3393  (
mg_g‘_”ºo
() ? mg_get_errno() : 1);

3395 
mg_sock_£t
(
nc
, 
sock
);

3399 
mg_sock‘_if_li¡’_udp
(
mg_cÚÃùiÚ
 *
nc
,

3400 
sock‘_add»ss
 *
§
) {

3401 
sock_t
 
	gsock
 = 
mg_İ’_li¡’šg_sock‘
(
§
, 
SOCK_DGRAM
, 0);

3402 ià(
	gsock
 =ğ
INVALID_SOCKET
è (
mg_g‘_”ºo
() ? mg_get_errno() : 1);

3403 
mg_sock_£t
(
nc
, 
sock
);

3407 
mg_sock‘_if_tı_£nd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
,

3408 
size_t
 
Ën
) {

3409 
mbuf_­³nd
(&
nc
->
£nd_mbuf
, 
buf
, 
Ën
);

3412 
mg_sock‘_if_udp_£nd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
,

3413 
size_t
 
Ën
) {

3414 
mbuf_­³nd
(&
nc
->
£nd_mbuf
, 
buf
, 
Ën
);

3417 
mg_sock‘_if_»cved
(
mg_cÚÃùiÚ
 *
nc
, 
size_t
 
Ën
) {

3418 (è
	gnc
;

3419 (è
	gËn
;

3422 
mg_sock‘_if_ü—‹_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

3423 (è
	gnc
;

3427 
mg_sock‘_if_de¡roy_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

3428 ià(
	gnc
->
	gsock
 =ğ
INVALID_SOCKET
) ;

3429 ià(!(
	gnc
->
	gæags
 & 
	gMG_F_UDP
)) {

3430 
şo£sock‘
(
nc
->
sock
);

3433 ià(
	gnc
->
	gli¡’”
 =ğ
NULL
è
şo£sock‘
(
nc
->
sock
);

3435 
	gnc
->
	gsock
 = 
INVALID_SOCKET
;

3438 
mg_acû±_cÚn
(
mg_cÚÃùiÚ
 *
lc
) {

3439 
mg_cÚÃùiÚ
 *
	gnc
;

3440 
sock‘_add»ss
 
	g§
;

3441 
sockËn_t
 
	g§_Ën
 = (
§
);

3443 
sock_t
 
	gsock
 = 
acû±
(
lc
->
sock
, &
§
.§, &
§_Ën
);

3444 ià(
	gsock
 =ğ
INVALID_SOCKET
) {

3445 ià(
mg_is_”rÜ
()è
DBG
(("%p: faedØacû±: %d", 
lc
, 
mg_g‘_”ºo
()));

3448 
	gnc
 = 
mg_if_acû±_Ãw_cÚn
(
lc
);

3449 ià(
	gnc
 =ğ
NULL
) {

3450 
şo£sock‘
(
sock
);

3453 
DBG
(("%°cÚÀäom %s:%d", 
nc
, 
š‘_Áß
(
§
.
sš
.
sš_addr
),

3454 
Áohs
(
§
.
sš
.
sš_pÜt
)));

3455 
mg_sock_£t
(
nc
, 
sock
);

3456 #ià
MG_ENABLE_SSL


3457 ià(
	glc
->
	gæags
 & 
	gMG_F_SSL
) {

3458 ià(
mg_s¦_if_cÚn_acû±
(
nc
, 
lc
è!ğ
MG_SSL_OK
è
mg_şo£_cÚn
(nc);

3462 
mg_if_acû±_tı_cb
(
nc
, &
§
, 
§_Ën
);

3468 
sock_t
 
mg_İ’_li¡’šg_sock‘
(
sock‘_add»ss
 *
§
, 
ty³
,

3469 
´Ùo
) {

3470 
sockËn_t
 
	g§_Ën
 =

3471 (
§
->§.
§_çmy
 =ğ
AF_INET
è? (§->
sš
è: (§->
sš6
);

3472 
sock_t
 
	gsock
 = 
INVALID_SOCKET
;

3473 #ià!
MG_LWIP


3474 
	gÚ
 = 1;

3477 ià((
	gsock
 = 
sock‘
(
§
->§.
§_çmy
, 
ty³
, 
´Ùo
)è!ğ
INVALID_SOCKET
 &&

3478 #ià!
MG_LWIP


3479 #ià
defšed
(
_WIN32
è&& defšed(
SO_EXCLUSIVEADDRUSE
è&& !defšed(
WINCE
)

3481 !
£tsockİt
(
sock
, 
SOL_SOCKET
, 
SO_EXCLUSIVEADDRUSE
, (*è&
Ú
,

3482 (
Ú
)) &&

3485 #ià!
defšed
(
_WIN32
è|| !defšed(
SO_EXCLUSIVEADDRUSE
)

3495 !
£tsockİt
(
sock
, 
SOL_SOCKET
, 
SO_REUSEADDR
, (*è&
Ú
, (on)) &&

3499 !
bšd
(
sock
, &
§
->§, 
§_Ën
) &&

3500 (
	gty³
 =ğ
SOCK_DGRAM
 || 
li¡’
(
sock
, 
SOMAXCONN
) == 0)) {

3501 #ià!
MG_LWIP


3502 
mg_£t_nÚ_blockšg_mode
(
sock
);

3504 (è
g‘sockÇme
(
sock
, &
§
->§, &
§_Ën
);

3506 } ià(
	gsock
 !ğ
INVALID_SOCKET
) {

3507 
şo£sock‘
(
sock
);

3508 
	gsock
 = 
INVALID_SOCKET
;

3511  
	gsock
;

3514 
mg_wr™e_to_sock‘
(
mg_cÚÃùiÚ
 *
nc
) {

3515 
mbuf
 *
	gio
 = &
nc
->
£nd_mbuf
;

3516 
	gn
 = 0;

3518 #ià
MG_LWIP


3520 ià(
	gio
->
	gËn
 == 0) ;

3523 
as£¹
(
io
->
Ën
 > 0);

3525 ià(
	gnc
->
	gæags
 & 
	gMG_F_UDP
) {

3526 
	gn
 =

3527 
£ndto
(
nc
->
sock
, 
io
->
buf
, io->
Ën
, 0, &nc->
§
.§, Òc->§.
sš
));

3528 
DBG
(("%°%d %d %d %s:%hu", 
nc
,‚c->
sock
, 
n
, 
mg_g‘_”ºo
(),

3529 
š‘_Áß
(
nc
->
§
.
sš
.
sš_addr
), 
Áohs
Òc->§.sš.
sš_pÜt
)));

3530 
mg_if_£Á_cb
(
nc
, 
n
);

3534 #ià
MG_ENABLE_SSL


3535 ià(
	gnc
->
	gæags
 & 
	gMG_F_SSL
) {

3536 ià(
	gnc
->
	gæags
 & 
	gMG_F_SSL_HANDSHAKE_DONE
) {

3537 
	gn
 = 
mg_s¦_if_wr™e
(
nc
, 
io
->
buf
, io->
Ën
);

3538 
DBG
(("%°%d by‹ -> %d (SSL)", 
nc
, 
n
,‚c->
sock
));

3539 ià(
	gn
 < 0) {

3540 ià(
	gn
 !ğ
MG_SSL_WANT_READ
 && 
n
 !ğ
MG_SSL_WANT_WRITE
) {

3541 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

3546 
	gnc
->
	gæags
 &ğ~(
MG_F_WANT_READ
 | 
MG_F_WANT_WRITE
);

3549 
mg_s¦_begš
(
nc
);

3555 
	gn
 = (è
MG_SEND_FUNC
(
nc
->
sock
, 
io
->
buf
, io->
Ën
, 0);

3556 
DBG
(("%°%d by‹ -> %d", 
nc
, 
n
,‚c->
sock
));

3559 
mg_if_£Á_cb
(
nc
, 
n
);

3562 
MG_INTERNAL
 
size_t
 
»cv_ava_size
(
mg_cÚÃùiÚ
 *
cÚn
, size_ˆ
max
) {

3563 
size_t
 
	gava
;

3564 ià(
	gcÚn
->
	g»cv_mbuf_lim™
 < cÚn->
	g»cv_mbuf
.
	gËn
)  0;

3565 
	gava
 = 
cÚn
->
»cv_mbuf_lim™
 - cÚn->
»cv_mbuf
.
Ën
;

3566  
	gava
 > 
	gmax
 ? max : 
ava
;

3569 
mg_hªdË_tı_»ad
(
mg_cÚÃùiÚ
 *
cÚn
) {

3570 
	gn
 = 0;

3571 *
	gbuf
 = (*è
MG_MALLOC
(
MG_TCP_RECV_BUFFER_SIZE
);

3573 ià(
	gbuf
 =ğ
NULL
) {

3574 
DBG
(("OOM"));

3578 #ià
MG_ENABLE_SSL


3579 ià(
	gcÚn
->
	gæags
 & 
	gMG_F_SSL
) {

3580 ià(
	gcÚn
->
	gæags
 & 
	gMG_F_SSL_HANDSHAKE_DONE
) {

3584 (
	gn
 = 
mg_s¦_if_»ad
(
cÚn
, 
buf
, 
MG_TCP_RECV_BUFFER_SIZE
)) > 0) {

3585 
DBG
(("%°%d by‹ <- %d (SSL)", 
cÚn
, 
n
, cÚn->
sock
));

3586 
mg_if_»cv_tı_cb
(
cÚn
, 
buf
, 
n
, 1 );

3587 
	gbuf
 = 
NULL
;

3588 ià(
	gcÚn
->
	gæags
 & 
	gMG_F_CLOSE_IMMEDIATELY
) ;

3590 
	gbuf
 = (*è
MG_MALLOC
(
MG_TCP_RECV_BUFFER_SIZE
);

3591 ià(
	gbuf
 =ğ
NULL
) ;

3593 
MG_FREE
(
buf
);

3594 ià(
	gn
 < 0 &&‚ !ğ
MG_SSL_WANT_READ
è
cÚn
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

3596 
MG_FREE
(
buf
);

3597 
mg_s¦_begš
(
cÚn
);

3603 
	gn
 = (è
MG_RECV_FUNC
(
cÚn
->
sock
, 
buf
,

3604 
»cv_ava_size
(
cÚn
, 
MG_TCP_RECV_BUFFER_SIZE
), 0);

3605 
DBG
(("%°%d by‹ (PLAINè<- %d", 
cÚn
, 
n
, cÚn->
sock
));

3606 ià(
	gn
 > 0) {

3607 
mg_if_»cv_tı_cb
(
cÚn
, 
buf
, 
n
, 1 );

3609 
MG_FREE
(
buf
);

3611 ià(
	gn
 == 0) {

3613 
cÚn
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

3614 } ià(
	gn
 < 0 && 
mg_is_”rÜ
()) {

3615 
	gcÚn
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

3620 
mg_»cväom
(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
,

3621 
sockËn_t
 *
§_Ën
, **
buf
) {

3622 
	gn
;

3623 *
	gbuf
 = (*è
MG_MALLOC
(
MG_UDP_RECV_BUFFER_SIZE
);

3624 ià(*
	gbuf
 =ğ
NULL
) {

3625 
DBG
(("Out of memory"));

3626  -
	gENOMEM
;

3628 
	gn
 = 
»cväom
(
nc
->
sock
, *
buf
, 
MG_UDP_RECV_BUFFER_SIZE
, 0, &
§
->§, 
§_Ën
);

3629 ià(
	gn
 <= 0) {

3630 
DBG
(("%°»cväom: %s", 
nc
, 
¡»¼Ü
(
mg_g‘_”ºo
())));

3631 
MG_FREE
(*
buf
);

3633  
	gn
;

3636 
mg_hªdË_udp_»ad
(
mg_cÚÃùiÚ
 *
nc
) {

3637 *
	gbuf
 = 
NULL
;

3638 
sock‘_add»ss
 
	g§
;

3639 
sockËn_t
 
	g§_Ën
 = (
§
);

3640 
	gn
 = 
mg_»cväom
(
nc
, &
§
, &
§_Ën
, &
buf
);

3641 
DBG
(("%°%d by‹ äom %s:%d", 
nc
, 
n
, 
š‘_Áß
Òc->
§
.
sš
.
sš_addr
),

3642 
Áohs
(
nc
->
§
.
sš
.
sš_pÜt
)));

3643 
mg_if_»cv_udp_cb
(
nc
, 
buf
, 
n
, &
§
, 
§_Ën
);

3646 #ià
MG_ENABLE_SSL


3647 
mg_s¦_begš
(
mg_cÚÃùiÚ
 *
nc
) {

3648 
	g£rv”_side
 = (
nc
->
li¡’”
 !ğ
NULL
);

3649 
mg_s¦_if_»suÉ
 
	g»s
 = 
mg_s¦_if_hªdshake
(
nc
);

3650 
DBG
(("%°%d„e %d", 
nc
, 
£rv”_side
, 
»s
));

3652 ià(
	g»s
 =ğ
MG_SSL_OK
) {

3653 
nc
->
æags
 |ğ
MG_F_SSL_HANDSHAKE_DONE
;

3654 
	gnc
->
	gæags
 &ğ~(
MG_F_WANT_READ
 | 
MG_F_WANT_WRITE
);

3656 ià(
	g£rv”_side
) {

3657 
sock‘_add»ss
 
	g§
;

3658 
sockËn_t
 
	g§_Ën
 = (
§
);

3659 (è
g‘³”Çme
(
nc
->
sock
, &
§
.§, &
§_Ën
);

3660 
mg_if_acû±_tı_cb
(
nc
, &
§
, 
§_Ën
);

3662 
mg_if_cÚÃù_cb
(
nc
, 0);

3664 } ià(
	g»s
 !ğ
MG_SSL_WANT_READ
 && 
»s
 !ğ
MG_SSL_WANT_WRITE
) {

3665 ià(!
£rv”_side
) {

3666 
mg_if_cÚÃù_cb
(
nc
, 
»s
);

3668 
	gnc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

3673 
	#_MG_F_FD_CAN_READ
 1

	)

3674 
	#_MG_F_FD_CAN_WRITE
 1 << 1

	)

3675 
	#_MG_F_FD_ERROR
 1 << 2

	)

3677 
mg_mgr_hªdË_cÚn
(
mg_cÚÃùiÚ
 *
nc
, 
fd_æags
, 
now
) {

3678 
	gwÜth_loggšg
 =

3679 
fd_æags
 !ğ0 || (
nc
->
æags
 & (
MG_F_WANT_READ
 | 
MG_F_WANT_WRITE
));

3680 ià(
	gwÜth_loggšg
) {

3681 
DBG
(("%°fd=%d fd_æags=%d‚c_æags=%lu„mbl=%d smbl=%d", 
nc
,‚c->
sock
,

3682 
fd_æags
, 
nc
->
æags
, (ènc->
»cv_mbuf
.
Ën
,

3683 (è
nc
->
£nd_mbuf
.
Ën
));

3686 ià(
	gnc
->
	gæags
 & 
	gMG_F_CONNECTING
) {

3687 ià(
	gfd_æags
 != 0) {

3688 
”r
 = 0;

3689 #ià!
defšed
(
MG_ESP8266
)

3690 ià(!(
	gnc
->
	gæags
 & 
	gMG_F_UDP
)) {

3691 
sockËn_t
 
	gËn
 = (
”r
);

3692 
	g»t
 =

3693 
g‘sockİt
(
nc
->
sock
, 
SOL_SOCKET
, 
SO_ERROR
, (*è&
”r
, &
Ën
);

3694 ià(
	g»t
 != 0) {

3695 
”r
 = 1;

3696 } ià(
	g”r
 =ğ
EAGAIN
 || 
”r
 =ğ
EWOULDBLOCK
) {

3697 
”r
 = 0;

3704 
	g”r
 = 
nc
->
”r
;

3706 #ià
MG_ENABLE_SSL


3707 ià((
	gnc
->
	gæags
 & 
	gMG_F_SSL
è&& 
	g”r
 == 0) {

3708 
mg_s¦_begš
(
nc
);

3710 
mg_if_cÚÃù_cb
(
nc
, 
”r
);

3713 
mg_if_cÚÃù_cb
(
nc
, 
”r
);

3715 } ià(
	gnc
->
	g”r
 != 0) {

3716 
mg_if_cÚÃù_cb
(
nc
,‚c->
”r
);

3720 ià(
	gfd_æags
 & 
	g_MG_F_FD_CAN_READ
) {

3721 ià(
	gnc
->
	gæags
 & 
	gMG_F_UDP
) {

3722 
mg_hªdË_udp_»ad
(
nc
);

3724 ià(
	gnc
->
	gæags
 & 
	gMG_F_LISTENING
) {

3730 
mg_acû±_cÚn
(
nc
);

3732 
mg_hªdË_tı_»ad
(
nc
);

3737 ià(!(
	gnc
->
	gæags
 & 
	gMG_F_CLOSE_IMMEDIATELY
)) {

3738 ià((
	gfd_æags
 & 
	g_MG_F_FD_CAN_WRITE
è&& 
	gnc
->
	g£nd_mbuf
.
	gËn
 > 0) {

3739 
mg_wr™e_to_sock‘
(
nc
);

3741 
mg_if_pŞl
(
nc
, (
time_t
è
now
);

3742 
mg_if_tim”
(
nc
, 
now
);

3745 ià(
	gwÜth_loggšg
) {

3746 
DBG
(("%°aá” fd=%d‚c_æags=%lu„mbl=%d smbl=%d", 
nc
,‚c->
sock
,‚c->
æags
,

3747 (è
nc
->
»cv_mbuf
.
Ën
, (ènc->
£nd_mbuf
.len));

3751 #ià
MG_ENABLE_BROADCAST


3752 
mg_mgr_hªdË_ùl_sock
(
mg_mgr
 *
mgr
) {

3753 
ùl_msg
 
	gùl_msg
;

3754 
	gËn
 =

3755 (è
MG_RECV_FUNC
(
mgr
->
ùl
[1], (*è&
ùl_msg
, (ctl_msg), 0);

3756 
size_t
 
	gdummy
 = 
MG_SEND_FUNC
(
mgr
->
ùl
[1], 
ùl_msg
.
mes§ge
, 1, 0);

3757 
DBG
(("»ad %d from c sock‘", 
Ën
));

3758 (è
	gdummy
;

3759 ià(
	gËn
 >ğ(è(
ùl_msg
.
ÿÎback
è&& c_msg.ÿÎback !ğ
NULL
) {

3760 
mg_cÚÃùiÚ
 *
nc
;

3761 
	gnc
 = 
mg_Ãxt
(
mgr
, 
NULL
);‚ø!ğNULL;‚øğmg_Ãxt(mgr, 
nc
)) {

3762 
	gùl_msg
.
ÿÎback
(
nc
, 
MG_EV_POLL
,

3763 
ùl_msg
.
mes§ge
 
MG_UD_ARG
(
nc
->
u£r_d©a
));

3770 
mg_sock‘_if_sock_£t
(
mg_cÚÃùiÚ
 *
nc
, 
sock_t
 
sock
) {

3771 
mg_£t_nÚ_blockšg_mode
(
sock
);

3772 
mg_£t_şo£_Ú_exec
(
sock
);

3773 
	gnc
->
	gsock
 = 
sock
;

3774 
DBG
(("%°%d", 
nc
, 
sock
));

3777 
mg_sock‘_if_š™
(
mg_içû
 *
içû
) {

3778 (è
	giçû
;

3779 
DBG
(("%°usšg s–eù()", 
içû
->
mgr
));

3780 #ià
MG_ENABLE_BROADCAST


3781 
mg_sock‘·œ
(
içû
->
mgr
->
ùl
, 
SOCK_DGRAM
);

3785 
mg_sock‘_if_ä“
(
mg_içû
 *
içû
) {

3786 (è
	giçû
;

3789 
mg_sock‘_if_add_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

3790 (è
	gnc
;

3793 
mg_sock‘_if_»move_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

3794 (è
	gnc
;

3797 
mg_add_to_£t
(
sock_t
 
sock
, 
fd_£t
 *
£t
, sock_ˆ*
max_fd
) {

3798 ià(
	gsock
 !ğ
INVALID_SOCKET


3799 #ifdeà
__unix__


3800 && 
sock
 < (
sock_t
è
FD_SETSIZE


3803 
FD_SET
(
sock
, 
£t
);

3804 ià(*
	gmax_fd
 =ğ
INVALID_SOCKET
 || 
sock
 > *
max_fd
) {

3805 *
max_fd
 = 
sock
;

3810 
time_t
 
mg_sock‘_if_pŞl
(
mg_içû
 *
içû
, 
timeout_ms
) {

3811 
mg_mgr
 *
	gmgr
 = 
içû
->
mgr
;

3812 
	gnow
 = 
mg_time
();

3813 
	gmš_tim”
;

3814 
mg_cÚÃùiÚ
 *
	gnc
, *
	gtmp
;

3815 
timev®
 
	gtv
;

3816 
fd_£t
 
	g»ad_£t
, 
	gwr™e_£t
, 
	g”r_£t
;

3817 
sock_t
 
	gmax_fd
 = 
INVALID_SOCKET
;

3818 
	gnum_fds
, 
	gnum_ev
, 
	gnum_tim”s
 = 0;

3819 #ifdeà
__unix__


3820 
	gŒy_dup
 = 1;

3823 
FD_ZERO
(&
»ad_£t
);

3824 
FD_ZERO
(&
wr™e_£t
);

3825 
FD_ZERO
(&
”r_£t
);

3826 #ià
MG_ENABLE_BROADCAST


3827 
mg_add_to_£t
(
mgr
->
ùl
[1], &
»ad_£t
, &
max_fd
);

3834 
	gmš_tim”
 = 0;

3835 
	gnc
 = 
mgr
->
aùive_cÚÃùiÚs
, 
	gnum_fds
 = 0;‚ø!ğ
NULL
;‚øğ
tmp
) {

3836 
tmp
 = 
nc
->
Ãxt
;

3838 ià(
	gnc
->
	gsock
 !ğ
INVALID_SOCKET
) {

3839 
num_fds
++;

3841 #ifdeà
__unix__


3843 ià(
	gnc
->
	gsock
 >ğ(
sock_t
è
FD_SETSIZE
 && 
Œy_dup
) {

3844 
Ãw_sock
 = 
dup
(
nc
->
sock
);

3845 ià(
	gÃw_sock
 >ğ0 && 
Ãw_sock
 < (
sock_t
è
FD_SETSIZE
) {

3846 
şo£sock‘
(
nc
->
sock
);

3847 
DBG
(("Ãw sock %d -> %d", 
nc
->
sock
, 
Ãw_sock
));

3848 
	gnc
->
	gsock
 = 
Ãw_sock
;

3850 
	gŒy_dup
 = 0;

3855 ià(!(
	gnc
->
	gæags
 & 
	gMG_F_WANT_WRITE
) &&

3856 
	gnc
->
	g»cv_mbuf
.
	gËn
 <‚c->
	g»cv_mbuf_lim™
 &&

3857 (!(
	gnc
->
	gæags
 & 
	gMG_F_UDP
è||‚c->
	gli¡’”
 =ğ
NULL
)) {

3858 
mg_add_to_£t
(
nc
->
sock
, &
»ad_£t
, &
max_fd
);

3861 ià(((
	gnc
->
	gæags
 & 
	gMG_F_CONNECTING
è&& !Òc->æag & 
	gMG_F_WANT_READ
)) ||

3862 (
	gnc
->
	g£nd_mbuf
.
	gËn
 > 0 && !Òc->
	gæags
 & 
	gMG_F_CONNECTING
))) {

3863 
mg_add_to_£t
(
nc
->
sock
, &
wr™e_£t
, &
max_fd
);

3864 
mg_add_to_£t
(
nc
->
sock
, &
”r_£t
, &
max_fd
);

3868 ià(
	gnc
->
	gev_tim”_time
 > 0) {

3869 ià(
	gnum_tim”s
 =ğ0 || 
nc
->
ev_tim”_time
 < 
mš_tim”
) {

3870 
mš_tim”
 = 
nc
->
ev_tim”_time
;

3872 
	gnum_tim”s
++;

3880 ià(
	gnum_tim”s
 > 0) {

3881 
	gtim”_timeout_ms
 = (
mš_tim”
 - 
mg_time
()) * 1000 + 1 ;

3882 ià(
	gtim”_timeout_ms
 < 
	gtimeout_ms
) {

3883 
	gtimeout_ms
 = (è
tim”_timeout_ms
;

3886 ià(
	gtimeout_ms
 < 0)imeout_ms = 0;

3888 
	gtv
.
	gtv_£c
 = 
timeout_ms
 / 1000;

3889 
	gtv
.
	gtv_u£c
 = (
timeout_ms
 % 1000) * 1000;

3891 
	gnum_ev
 = 
£Ëù
((è
max_fd
 + 1, &
»ad_£t
, &
wr™e_£t
, &
”r_£t
, &
tv
);

3892 
	gnow
 = 
mg_time
();

3894 
DBG
(("£Ëù @ %ld‚um_ev=%d oà%d,imeout=%d", (è
now
, 
num_ev
, 
num_fds
,

3895 
timeout_ms
));

3898 #ià
MG_ENABLE_BROADCAST


3899 ià(
	gnum_ev
 > 0 && 
	gmgr
->
	gùl
[1] !ğ
INVALID_SOCKET
 &&

3900 
FD_ISSET
(
mgr
->
ùl
[1], &
»ad_£t
)) {

3901 
mg_mgr_hªdË_ùl_sock
(
mgr
);

3905 
	gnc
 = 
mgr
->
aùive_cÚÃùiÚs
;‚ø!ğ
NULL
;‚øğ
tmp
) {

3906 
fd_æags
 = 0;

3907 ià(
	gnc
->
	gsock
 !ğ
INVALID_SOCKET
) {

3908 ià(
num_ev
 > 0) {

3909 
fd_æags
 = (
FD_ISSET
(
nc
->
sock
, &
»ad_£t
) &&

3910 (!(
	gnc
->
	gæags
 & 
	gMG_F_UDP
è||‚c->
	gli¡’”
 =ğ
NULL
)

3911 ? 
_MG_F_FD_CAN_READ


3913 (
FD_ISSET
(
nc
->
sock
, &
wr™e_£t
è? 
	g_MG_F_FD_CAN_WRITE
 : 0) |

3914 (
FD_ISSET
(
nc
->
sock
, &
”r_£t
è? 
	g_MG_F_FD_ERROR
 : 0);

3916 #ià
MG_LWIP


3918 ià((
	gnc
->
	gæags
 & 
	gMG_F_UDP
è&&‚c->
	gli¡’”
 =ğ
NULL
) {

3919 
fd_æags
 |ğ
_MG_F_FD_CAN_WRITE
;

3923 
	gtmp
 = 
nc
->
Ãxt
;

3924 
mg_mgr_hªdË_cÚn
(
nc
, 
fd_æags
, 
now
);

3927 
	gnc
 = 
mgr
->
aùive_cÚÃùiÚs
;‚ø!ğ
NULL
;‚øğ
tmp
) {

3928 
tmp
 = 
nc
->
Ãxt
;

3929 ià((
	gnc
->
	gæags
 & 
	gMG_F_CLOSE_IMMEDIATELY
) ||

3930 (
	gnc
->
	g£nd_mbuf
.
	gËn
 =ğ0 && (
nc
->
æags
 & 
MG_F_SEND_AND_CLOSE
))) {

3931 
mg_şo£_cÚn
(
nc
);

3935  (
	gtime_t
è
	gnow
;

3938 #ià
MG_ENABLE_BROADCAST


3939 
MG_INTERNAL
 
mg_sock‘·œ_şo£
(
sock_t
 *
sock
) {

3941 ià(
şo£sock‘
(*
sock
è=ğ-1 && 
”ºo
 =ğ
EINTR
) ;

3944 *
	gsock
 = 
INVALID_SOCKET
;

3947 
MG_INTERNAL
 
sock_t


3948 
mg_sock‘·œ_acû±
(
sock_t
 
sock
, 
sock‘_add»ss
 *
§
, 
sockËn_t
 
§_Ën
) {

3949 
sock_t
 
	grc
;

3951 ià((
	grc
 = 
acû±
(
sock
, &
§
->§, &
§_Ën
)è=ğ
INVALID_SOCKET
 &&

3952 
”ºo
 =ğ
EINTR
)

3956  
	grc
;

3959 
mg_sock‘·œ
(
sock_t
 
¥
[2], 
sock_ty³
) {

3960 
sock‘_add»ss
 
	g§
;

3961 
sock_t
 
	gsock
;

3962 
sockËn_t
 
	gËn
 = (
§
.
sš
);

3963 
	g»t
 = 0;

3965 
	gsock
 = 
¥
[0] = sp[1] = 
INVALID_SOCKET
;

3967 (è
mem£t
(&
§
, 0, (sa));

3968 
	g§
.
	gsš
.
	gsš_çmy
 = 
AF_INET
;

3969 
	g§
.
	gsš
.
	gsš_pÜt
 = 
htÚs
(0);

3970 
	g§
.
	gsš
.
	gsš_addr
.
	gs_addr
 = 
htÚl
(0x7f000001);

3972 ià((
	gsock
 = 
sock‘
(
AF_INET
, 
sock_ty³
, 0)è=ğ
INVALID_SOCKET
) {

3973 } ià(
bšd
(
sock
, &
§
.§, 
Ën
) != 0) {

3974 } ià(
sock_ty³
 =ğ
SOCK_STREAM
 && 
li¡’
(
sock
, 1) != 0) {

3975 } ià(
g‘sockÇme
(
sock
, &
§
.§, &
Ën
) != 0) {

3976 } ià((
¥
[0] = 
sock‘
(
AF_INET
, 
sock_ty³
, 0)è=ğ
INVALID_SOCKET
) {

3977 } ià(
cÚÃù
(
¥
[0], &
§
.§, 
Ën
) != 0) {

3978 } ià(
sock_ty³
 =ğ
SOCK_DGRAM
 &&

3979 (
g‘sockÇme
(
¥
[0], &
§
.§, &
Ën
) != 0 ||

3980 
cÚÃù
(
sock
, &
§
.§, 
Ën
) != 0)) {

3981 } ià((
¥
[1] = (
sock_ty³
 =ğ
SOCK_DGRAM
 ? 
sock
 : 
mg_sock‘·œ_acû±
(

3982 
sock
, &
§
, 
Ën
))) ==

3983 
INVALID_SOCKET
) {

3985 
mg_£t_şo£_Ú_exec
(
¥
[0]);

3986 
mg_£t_şo£_Ú_exec
(
¥
[1]);

3987 ià(
	gsock_ty³
 =ğ
SOCK_STREAM
è
mg_sock‘·œ_şo£
(&
sock
);

3988 
	g»t
 = 1;

3991 ià(!
	g»t
) {

3992 ià(
	g¥
[0] !ğ
INVALID_SOCKET
è
mg_sock‘·œ_şo£
(&
¥
[0]);

3993 ià(
	g¥
[1] !ğ
INVALID_SOCKET
è
mg_sock‘·œ_şo£
(&
¥
[1]);

3994 ià(
	gsock
 !ğ
INVALID_SOCKET
è
mg_sock‘·œ_şo£
(&
sock
);

3997  
	g»t
;

4001 
mg_sock_g‘_addr
(
sock_t
 
sock
, 
»mÙe
,

4002 
sock‘_add»ss
 *
§
) {

4003 
sockËn_t
 
	g¦’
 = (*
§
);

4004 
mem£t
(
§
, 0, 
¦’
);

4005 ià(
	g»mÙe
) {

4006 
g‘³”Çme
(
sock
, &
§
->§, &
¦’
);

4008 
g‘sockÇme
(
sock
, &
§
->§, &
¦’
);

4012 
mg_sock_to_¡r
(
sock_t
 
sock
, *
buf
, 
size_t
 
Ën
, 
æags
) {

4013 
sock‘_add»ss
 
	g§
;

4014 
mg_sock_g‘_addr
(
sock
, 
æags
 & 
MG_SOCK_STRINGIFY_REMOTE
, &
§
);

4015 
mg_sock_addr_to_¡r
(&
§
, 
buf
, 
Ën
, 
æags
);

4018 
mg_sock‘_if_g‘_cÚn_addr
(
mg_cÚÃùiÚ
 *
nc
, 
»mÙe
,

4019 
sock‘_add»ss
 *
§
) {

4020 ià((
	gnc
->
	gæags
 & 
	gMG_F_UDP
è&& 
	g»mÙe
) {

4021 
memıy
(
§
, &
nc
->sa, (*sa));

4024 
mg_sock_g‘_addr
(
nc
->
sock
, 
»mÙe
, 
§
);

4028 
	#MG_SOCKET_IFACE_VTABLE
 \

4030 
mg_sock‘_if_š™
, \

4031 
mg_sock‘_if_ä“
, \

4032 
mg_sock‘_if_add_cÚn
, \

4033 
mg_sock‘_if_»move_cÚn
, \

4034 
mg_sock‘_if_pŞl
, \

4035 
mg_sock‘_if_li¡’_tı
, \

4036 
mg_sock‘_if_li¡’_udp
, \

4037 
mg_sock‘_if_cÚÃù_tı
, \

4038 
mg_sock‘_if_cÚÃù_udp
, \

4039 
mg_sock‘_if_tı_£nd
, \

4040 
mg_sock‘_if_udp_£nd
, \

4041 
mg_sock‘_if_»cved
, \

4042 
mg_sock‘_if_ü—‹_cÚn
, \

4043 
mg_sock‘_if_de¡roy_cÚn
, \

4044 
mg_sock‘_if_sock_£t
, \

4045 
mg_sock‘_if_g‘_cÚn_addr
, \

4046 }

	)

4049 cÚ¡ 
mg_içû_vbË
 
	gmg_sock‘_içû_vbË
 = 
MG_SOCKET_IFACE_VTABLE
;

4050 #ià
MG_NET_IF
 =ğ
MG_NET_IF_SOCKET


4051 cÚ¡ 
mg_içû_vbË
 
	gmg_deçuÉ_içû_vbË
 = 
MG_SOCKET_IFACE_VTABLE
;

4055 #ifdeà
MG_MODULE_LINES


4063 #ià
MG_ENABLE_SOCKS


4065 
	ssocksd©a
 {

4066 *
	g´oxy_addr
;

4067 
mg_cÚÃùiÚ
 *
	gs
;

4068 
mg_cÚÃùiÚ
 *
	gc
;

4069 
mbuf
 
	gtmp
;

4072 
socks_if_disbªd
(
socksd©a
 *
d
) {

4073 
LOG
(
LL_DEBUG
, ("disbªdšg…roxy %°%p", 
d
->
c
, d->
s
));

4074 ià(
	gd
->
	gc
èd->c->
	gæags
 |ğ
MG_F_SEND_AND_CLOSE
;

4075 ià(
	gd
->
	gs
èd->s->
	gæags
 |ğ
MG_F_SEND_AND_CLOSE
;

4076 
	gd
->
	gc
 = 
d
->
s
 = 
NULL
;

4079 
socks_if_hªdËr
(
mg_cÚÃùiÚ
 *
c
, 
ev
, *
ev_d©a
) {

4080 
socksd©a
 *
	gd
 = (socksd©¨*è
c
->
u£r_d©a
;

4081 ià(
	gev
 =ğ
MG_EV_CONNECT
) {

4082 
»s
 = *(*è
ev_d©a
;

4083 ià(
	g»s
 == 0) {

4085 
buf
[] = {
MG_SOCKS_VERSION
, 1, 
MG_SOCKS_HANDSHAKE_NOAUTH
};

4086 
mg_£nd
(
d
->
s
, 
buf
, (buf));

4087 
LOG
(
LL_DEBUG
, ("S’ˆhªdshaktØ%s", 
d
->
´oxy_addr
));

4089 
LOG
(
LL_ERROR
, ("CªnÙ cÚÃùØ%s: %d", 
d
->
´oxy_addr
, 
»s
));

4090 
	gd
->
	gc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

4092 } ià(
	gev
 =ğ
MG_EV_CLOSE
) {

4093 
socks_if_disbªd
(
d
);

4094 } ià(
	gev
 =ğ
MG_EV_RECV
) {

4096 ià(!(
c
->
æags
 & 
MG_SOCKS_HANDSHAKE_DONE
)) {

4098 
buf
[10] = {
MG_SOCKS_VERSION
, 
MG_SOCKS_CMD_CONNECT
, 0,

4099 
MG_SOCKS_ADDR_IPV4
};

4100 ià(
	gc
->
	g»cv_mbuf
.
	gËn
 < 2) ;

4101 ià((è
	gc
->
	g»cv_mbuf
.
	gbuf
[1] =ğ
MG_SOCKS_HANDSHAKE_FAILURE
) {

4102 
LOG
(
LL_ERROR
, ("Server kicked us out"));

4103 
socks_if_disbªd
(
d
);

4106 
mbuf_»move
(&
c
->
»cv_mbuf
, 2);

4107 
	gc
->
	gæags
 |ğ
MG_SOCKS_HANDSHAKE_DONE
;

4110 
memıy
(
buf
 + 4, &
d
->
c
->
§
.
sš
.
sš_addr
, 4);

4111 
memıy
(
buf
 + 8, &
d
->
c
->
§
.
sš
.
sš_pÜt
, 2);

4112 
mg_£nd
(
c
, 
buf
, (buf));

4115 ià((
	gc
->
	gæags
 & 
	gMG_SOCKS_HANDSHAKE_DONE
) &&

4116 !(
	gc
->
	gæags
 & 
	gMG_SOCKS_CONNECT_DONE
)) {

4117 ià(
	gc
->
	g»cv_mbuf
.
	gËn
 < 10) ;

4118 ià(
	gc
->
	g»cv_mbuf
.
	gbuf
[1] !ğ
MG_SOCKS_SUCCESS
) {

4119 
LOG
(
LL_ERROR
, ("Sock cÚÃùiÚƒ¼Ü: %d", 
c
->
»cv_mbuf
.
buf
[1]));

4120 
socks_if_disbªd
(
d
);

4123 
mbuf_»move
(&
c
->
»cv_mbuf
, 10);

4124 
	gc
->
	gæags
 |ğ
MG_SOCKS_CONNECT_DONE
;

4126 ià(
	gd
->
	gs
 && d->
	gc
) {

4127 
mbuf_­³nd
(&
d
->
s
->
£nd_mbuf
, d->
tmp
.
buf
, d->tmp.
Ën
);

4128 
mbuf_ä“
(&
d
->
tmp
);

4132 ià((
	gc
->
	gæags
 & 
	gMG_SOCKS_CONNECT_DONE
è&& 
	gd
->ø&& d->
	gs
) {

4133 
mbuf_­³nd
(&
d
->
c
->
»cv_mbuf
, d->
s
->»cv_mbuf.
buf
, d->s->»cv_mbuf.
Ën
);

4134 
mbuf_»move
(&
d
->
s
->
»cv_mbuf
, d->s->»cv_mbuf.
Ën
);

4139 
mg_socks_if_cÚÃù_tı
(
mg_cÚÃùiÚ
 *
c
,

4140 cÚ¡ 
sock‘_add»ss
 *
§
) {

4141 
socksd©a
 *
	gd
 = (socksd©¨*è
c
->
içû
->
d©a
;

4142 
	gd
->
	gc
 = 
c
;

4143 
	gd
->
	gs
 = 
mg_cÚÃù
(
c
->
mgr
, 
d
->
´oxy_addr
, 
socks_if_hªdËr
);

4144 
	gd
->
	gs
->
	gu£r_d©a
 = 
d
;

4145 
LOG
(
LL_DEBUG
, ("%°%s", 
c
, 
d
->
´oxy_addr
));

4146 (è
	g§
;

4149 
mg_socks_if_cÚÃù_udp
(
mg_cÚÃùiÚ
 *
c
) {

4150 (è
	gc
;

4153 
mg_socks_if_li¡’_tı
(
mg_cÚÃùiÚ
 *
c
,

4154 
sock‘_add»ss
 *
§
) {

4155 (è
	gc
;

4156 (è
	g§
;

4160 
mg_socks_if_li¡’_udp
(
mg_cÚÃùiÚ
 *
c
,

4161 
sock‘_add»ss
 *
§
) {

4162 (è
	gc
;

4163 (è
	g§
;

4167 
mg_socks_if_tı_£nd
(
mg_cÚÃùiÚ
 *
c
, cÚ¡ *
buf
,

4168 
size_t
 
Ën
) {

4169 
socksd©a
 *
	gd
 = (socksd©¨*è
c
->
içû
->
d©a
;

4170 
LOG
(
LL_DEBUG
, ("%°-> %°%d %d", 
c
, 
buf
, (è
Ën
, (èc->
£nd_mbuf
.len));

4171 ià(
	gd
 && d->
	gs
 && d->s->
	gæags
 & 
	gMG_SOCKS_CONNECT_DONE
) {

4172 
mbuf_­³nd
(&
d
->
s
->
£nd_mbuf
, d->
tmp
.
buf
, d->tmp.
Ën
);

4173 
mbuf_­³nd
(&
d
->
s
->
£nd_mbuf
, 
buf
, 
Ën
);

4174 
mbuf_ä“
(&
d
->
tmp
);

4176 
mbuf_­³nd
(&
d
->
tmp
, 
buf
, 
Ën
);

4180 
mg_socks_if_udp_£nd
(
mg_cÚÃùiÚ
 *
c
, cÚ¡ *
buf
,

4181 
size_t
 
Ën
) {

4182 (è
	gc
;

4183 (è
	gbuf
;

4184 (è
	gËn
;

4187 
mg_socks_if_»cved
(
mg_cÚÃùiÚ
 *
c
, 
size_t
 
Ën
) {

4188 (è
	gc
;

4189 (è
	gËn
;

4192 
mg_socks_if_ü—‹_cÚn
(
mg_cÚÃùiÚ
 *
c
) {

4193 (è
	gc
;

4197 
mg_socks_if_de¡roy_cÚn
(
mg_cÚÃùiÚ
 *
c
) {

4198 
	gc
->
	giçû
->
	gvbË
->
ä“
(
c
->
içû
);

4199 
MG_FREE
(
c
->
içû
);

4200 
	gc
->
	giçû
 = 
NULL
;

4201 
LOG
(
LL_DEBUG
, ("%p", 
c
));

4204 
mg_socks_if_sock_£t
(
mg_cÚÃùiÚ
 *
c
, 
sock_t
 
sock
) {

4205 (è
	gc
;

4206 (è
	gsock
;

4209 
mg_socks_if_š™
(
mg_içû
 *
içû
) {

4210 (è
	giçû
;

4213 
mg_socks_if_ä“
(
mg_içû
 *
içû
) {

4214 
socksd©a
 *
	gd
 = (socksd©¨*è
içû
->
d©a
;

4215 
LOG
(
LL_DEBUG
, ("%p", 
içû
));

4216 ià(
	gd
 !ğ
NULL
) {

4217 
socks_if_disbªd
(
d
);

4218 
mbuf_ä“
(&
d
->
tmp
);

4219 
MG_FREE
(
d
->
´oxy_addr
);

4220 
MG_FREE
(
d
);

4221 
	giçû
->
	gd©a
 = 
NULL
;

4225 
mg_socks_if_add_cÚn
(
mg_cÚÃùiÚ
 *
c
) {

4226 
	gc
->
	gsock
 = 
INVALID_SOCKET
;

4229 
mg_socks_if_»move_cÚn
(
mg_cÚÃùiÚ
 *
c
) {

4230 (è
	gc
;

4233 
time_t
 
mg_socks_if_pŞl
(
mg_içû
 *
içû
, 
timeout_ms
) {

4234 
LOG
(
LL_DEBUG
, ("%p", 
içû
));

4235 (è
	giçû
;

4236 (è
	gtimeout_ms
;

4237  (
	gtime_t
è
cs_time
();

4240 
mg_socks_if_g‘_cÚn_addr
(
mg_cÚÃùiÚ
 *
c
, 
»mÙe
,

4241 
sock‘_add»ss
 *
§
) {

4242 
LOG
(
LL_DEBUG
, ("%p", 
c
));

4243 (è
	gc
;

4244 (è
	g»mÙe
;

4245 (è
	g§
;

4248 cÚ¡ 
mg_içû_vbË
 
	gmg_socks_içû_vbË
 = {

4249 
mg_socks_if_š™
, 
mg_socks_if_ä“
,

4250 
mg_socks_if_add_cÚn
, 
mg_socks_if_»move_cÚn
,

4251 
mg_socks_if_pŞl
, 
mg_socks_if_li¡’_tı
,

4252 
mg_socks_if_li¡’_udp
, 
mg_socks_if_cÚÃù_tı
,

4253 
mg_socks_if_cÚÃù_udp
, 
mg_socks_if_tı_£nd
,

4254 
mg_socks_if_udp_£nd
, 
mg_socks_if_»cved
,

4255 
mg_socks_if_ü—‹_cÚn
, 
mg_socks_if_de¡roy_cÚn
,

4256 
mg_socks_if_sock_£t
, 
mg_socks_if_g‘_cÚn_addr
,

4259 
mg_içû
 *
mg_socks_mk_içû
(
mg_mgr
 *
mgr
, cÚ¡ *
´oxy_addr
) {

4260 
mg_içû
 *
	giçû
 = 
mg_if_ü—‹_içû
(&
mg_socks_içû_vbË
, 
mgr
);

4261 
	giçû
->
	gd©a
 = 
MG_CALLOC
(1, (
socksd©a
));

4262 ((
	gsocksd©a
 *è
	giçû
->
	gd©a
)->
	g´oxy_addr
 = 
¡rdup
(
´oxy_addr
);

4263  
	giçû
;

4267 #ifdeà
MG_MODULE_LINES


4275 #ià
MG_ENABLE_TUN


4284 
	#MG_TCP_RECV_BUFFER_SIZE
 1024

	)

4285 
	#MG_UDP_RECV_BUFFER_SIZE
 1500

	)

4287 
mg_tun_if_cÚÃù_tı
(
mg_cÚÃùiÚ
 *
nc
,

4288 cÚ¡ 
sock‘_add»ss
 *
§
) {

4289 (è
	gnc
;

4290 (è
	g§
;

4293 
mg_tun_if_cÚÃù_udp
(
mg_cÚÃùiÚ
 *
nc
) {

4294 (è
	gnc
;

4297 
mg_tun_if_li¡’_tı
(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
) {

4298 (è
	gnc
;

4299 (è
	g§
;

4303 
mg_tun_if_li¡’_udp
(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
) {

4304 (è
	gnc
;

4305 (è
	g§
;

4309 
mg_tun_if_tı_£nd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

4310 
mg_tun_ş›Á
 *
	gş›Á
 = (mg_tun_ş›Á *è
nc
->
içû
->
d©a
;

4311 
ušt32_t
 
	g¡»am_id
 = (ušt32_t)(
ušŒ_t
è
nc
->
mgr_d©a
;

4312 
mg_¡r
 
	gmsg
 = {(*è
buf
, 
Ën
};

4313 #ià
MG_ENABLE_HEXDUMP


4314 
	ghex
[512];

4315 
mg_hexdump
(
buf
, 
Ën
, 
hex
, (hex));

4316 
LOG
(
LL_DEBUG
, ("£ndšgØ¡»am 0x%x:\n%s", (è
¡»am_id
, 
hex
));

4319 
mg_tun_£nd_äame
(
ş›Á
->
di¥
, 
¡»am_id
, 
MG_TUN_DATA_FRAME
, 0, 
msg
);

4322 
mg_tun_if_udp_£nd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

4323 (è
	gnc
;

4324 (è
	gbuf
;

4325 (è
	gËn
;

4328 
mg_tun_if_»cved
(
mg_cÚÃùiÚ
 *
nc
, 
size_t
 
Ën
) {

4329 (è
	gnc
;

4330 (è
	gËn
;

4333 
mg_tun_if_ü—‹_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

4334 (è
	gnc
;

4338 
mg_tun_if_de¡roy_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

4339 
mg_tun_ş›Á
 *
	gş›Á
 = (mg_tun_ş›Á *è
nc
->
içû
->
d©a
;

4341 ià(
	gnc
->
	gæags
 & 
	gMG_F_LISTENING
) {

4342 
mg_tun_de¡roy_ş›Á
(
ş›Á
);

4343 } ià(
	gş›Á
->
	gdi¥
) {

4344 
ušt32_t
 
	g¡»am_id
 = (ušt32_t)(
ušŒ_t
è
nc
->
mgr_d©a
;

4345 
mg_¡r
 
	gmsg
 = {
NULL
, 0};

4347 
LOG
(
LL_DEBUG
, ("şosšg 0x%x:", (è
¡»am_id
));

4348 
mg_tun_£nd_äame
(
ş›Á
->
di¥
, 
¡»am_id
, 
MG_TUN_DATA_FRAME
,

4349 
MG_TUN_F_END_STREAM
, 
msg
);

4354 
mg_tun_if_sock_£t
(
mg_cÚÃùiÚ
 *
nc
, 
sock_t
 
sock
) {

4355 (è
	gnc
;

4356 (è
	gsock
;

4359 
mg_tun_if_š™
(
mg_içû
 *
içû
) {

4360 (è
	giçû
;

4363 
mg_tun_if_ä“
(
mg_içû
 *
içû
) {

4364 (è
	giçû
;

4367 
mg_tun_if_add_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

4368 
	gnc
->
	gsock
 = 
INVALID_SOCKET
;

4371 
mg_tun_if_»move_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

4372 (è
	gnc
;

4375 
time_t
 
mg_tun_if_pŞl
(
mg_içû
 *
içû
, 
timeout_ms
) {

4376 (è
	giçû
;

4377 (è
	gtimeout_ms
;

4378  (
	gtime_t
è
cs_time
();

4381 
mg_tun_if_g‘_cÚn_addr
(
mg_cÚÃùiÚ
 *
nc
, 
»mÙe
,

4382 
sock‘_add»ss
 *
§
) {

4383 (è
	gnc
;

4384 (è
	g»mÙe
;

4385 (è
	g§
;

4388 
mg_cÚÃùiÚ
 *
mg_tun_if_fšd_cÚn
(
mg_tun_ş›Á
 *
ş›Á
,

4389 
ušt32_t
 
¡»am_id
) {

4390 
mg_cÚÃùiÚ
 *
	gnc
 = 
NULL
;

4392 
	gnc
 = 
ş›Á
->
mgr
->
aùive_cÚÃùiÚs
;‚ø!ğ
NULL
;‚øğ
nc
->
Ãxt
) {

4393 ià(
nc
->
içû
 !ğ
ş›Á
->içû || (nc->
æags
 & 
MG_F_LISTENING
)) {

4396 ià(
	g¡»am_id
 =ğ(
ušt32_t
)(
ušŒ_t
è
nc
->
mgr_d©a
) {

4397  
nc
;

4401 ià(
	g¡»am_id
 > 
	gş›Á
->
	gÏ¡_¡»am_id
) {

4403 
LOG
(
LL_DEBUG
, ("Ãw sŒ—m 0x%x,‡cû±šg", (è
¡»am_id
));

4404 
	gnc
 = 
mg_if_acû±_Ãw_cÚn
(
ş›Á
->
li¡’”
);

4405 
	gnc
->
	gmgr_d©a
 = (*è(
ušŒ_t
è
¡»am_id
;

4406 
	gş›Á
->
	gÏ¡_¡»am_id
 = 
¡»am_id
;

4408 
LOG
(
LL_DEBUG
,

4409 ("IgnÜšg sŒ—m 0x%x (Ï¡_¡»am_id 0x%x)", (è
¡»am_id
,

4410 (è
ş›Á
->
Ï¡_¡»am_id
));

4413  
	gnc
;

4417 
	#MG_TUN_IFACE_VTABLE
 \

4419 
mg_tun_if_š™
, \

4420 
mg_tun_if_ä“
, \

4421 
mg_tun_if_add_cÚn
, \

4422 
mg_tun_if_»move_cÚn
, \

4423 
mg_tun_if_pŞl
, \

4424 
mg_tun_if_li¡’_tı
, \

4425 
mg_tun_if_li¡’_udp
, \

4426 
mg_tun_if_cÚÃù_tı
, \

4427 
mg_tun_if_cÚÃù_udp
, \

4428 
mg_tun_if_tı_£nd
, \

4429 
mg_tun_if_udp_£nd
, \

4430 
mg_tun_if_»cved
, \

4431 
mg_tun_if_ü—‹_cÚn
, \

4432 
mg_tun_if_de¡roy_cÚn
, \

4433 
mg_tun_if_sock_£t
, \

4434 
mg_tun_if_g‘_cÚn_addr
, \

4435 }

	)

4438 cÚ¡ 
mg_içû_vbË
 
	gmg_tun_içû_vbË
 = 
MG_TUN_IFACE_VTABLE
;

4441 #ifdeà
MG_MODULE_LINES


4449 #ià
MG_ENABLE_SSL
 && 
MG_SSL_IF
 =ğ
MG_SSL_IF_OPENSSL


4451 #ifdeà
__APPLE__


4452 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Wdeprecated-declarations"

4455 
	~<İ’s¦/s¦.h
>

4457 
	smg_s¦_if_ùx
 {

4458 
SSL
 *
	gs¦
;

4459 
SSL_CTX
 *
	gs¦_ùx
;

4460 
mbuf
 
	gpsk
;

4461 
size_t
 
	gid’t™y_Ën
;

4464 
mg_s¦_if_š™
() {

4465 
SSL_lib¿ry_š™
();

4468 
mg_s¦_if_»suÉ
 
mg_s¦_if_cÚn_acû±
(
mg_cÚÃùiÚ
 *
nc
,

4469 
mg_cÚÃùiÚ
 *
lc
) {

4470 
mg_s¦_if_ùx
 *
	gùx
 =

4471 (
mg_s¦_if_ùx
 *è
MG_CALLOC
(1, (*
ùx
));

4472 
mg_s¦_if_ùx
 *
	glc_ùx
 = (mg_s¦_if_ùx *è
lc
->
s¦_if_d©a
;

4473 
	gnc
->
	gs¦_if_d©a
 = 
ùx
;

4474 ià(
	gùx
 =ğ
NULL
 || 
lc_ùx
 =ğNULLè 
MG_SSL_ERROR
;

4475 
	gùx
->
	gs¦_ùx
 = 
lc_ùx
->
s¦_ùx
;

4476 ià((
	gùx
->
	gs¦
 = 
SSL_Ãw
(
ùx
->
s¦_ùx
)è=ğ
NULL
) {

4477  
MG_SSL_ERROR
;

4479  
	gMG_SSL_OK
;

4482 
mg_s¦_if_»suÉ
 
mg_u£_û¹
(
SSL_CTX
 *
ùx
, cÚ¡ *
û¹
,

4483 cÚ¡ *
key
, cÚ¡ **
”r_msg
);

4484 
mg_s¦_if_»suÉ
 
mg_u£_ÿ_û¹
(
SSL_CTX
 *
ùx
, cÚ¡ *
û¹
);

4485 
mg_s¦_if_»suÉ
 
mg_£t_ch”_li¡
(
SSL_CTX
 *
ùx
, cÚ¡ *
ş
);

4486 
mg_s¦_if_»suÉ
 
mg_s¦_if_os¦_£t_psk
(
mg_s¦_if_ùx
 *
ùx
,

4487 cÚ¡ *
id’t™y
,

4488 cÚ¡ *
key_¡r
);

4490 
mg_s¦_if_»suÉ
 
mg_s¦_if_cÚn_š™
(

4491 
mg_cÚÃùiÚ
 *
nc
, cÚ¡ 
mg_s¦_if_cÚn_·¿ms
 *
·¿ms
,

4492 cÚ¡ **
”r_msg
) {

4493 
mg_s¦_if_ùx
 *
	gùx
 =

4494 (
mg_s¦_if_ùx
 *è
MG_CALLOC
(1, (*
ùx
));

4495 
DBG
(("%°%s,%s,%s", 
nc
, (
·¿ms
->
û¹
 ?…arams->cert : ""),

4496 (
·¿ms
->
key
 ?…arams->key : ""),

4497 (
·¿ms
->
ÿ_û¹
 ?…arams->ca_cert : "")));

4498 ià(
	gùx
 =ğ
NULL
) {

4499 
MG_SET_PTRPTR
(
”r_msg
, "Out of memory");

4500  
	gMG_SSL_ERROR
;

4502 
	gnc
->
	gs¦_if_d©a
 = 
ùx
;

4503 ià(
	gnc
->
	gæags
 & 
	gMG_F_LISTENING
) {

4504 
	gùx
->
	gs¦_ùx
 = 
SSL_CTX_Ãw
(
SSLv23_£rv”_m‘hod
());

4506 
	gùx
->
	gs¦_ùx
 = 
SSL_CTX_Ãw
(
SSLv23_ş›Á_m‘hod
());

4508 ià(
	gùx
->
	gs¦_ùx
 =ğ
NULL
) {

4509 
MG_SET_PTRPTR
(
”r_msg
, "Failedo create SSL context");

4510  
	gMG_SSL_ERROR
;

4513 #iâdeà
KR_VERSION


4515 
SSL_CTX_£t_İtiÚs
(
ùx
->
s¦_ùx
, 
SSL_OP_NO_SSLv2
);

4516 
SSL_CTX_£t_İtiÚs
(
ùx
->
s¦_ùx
, 
SSL_OP_NO_SSLv3
);

4517 
SSL_CTX_£t_İtiÚs
(
ùx
->
s¦_ùx
, 
SSL_OP_NO_TLSv1
);

4518 #ifdeà
MG_SSL_OPENSSL_NO_COMPRESSION


4519 
SSL_CTX_£t_İtiÚs
(
ùx
->
s¦_ùx
, 
SSL_OP_NO_COMPRESSION
);

4521 #ifdeà
MG_SSL_OPENSSL_CIPHER_SERVER_PREFERENCE


4522 
SSL_CTX_£t_İtiÚs
(
ùx
->
s¦_ùx
, 
SSL_OP_CIPHER_SERVER_PREFERENCE
);

4528 ià(
	g·¿ms
->
	gû¹
 !ğ
NULL
 &&

4529 
mg_u£_û¹
(
ùx
->
s¦_ùx
, 
·¿ms
->
û¹
,…¬ams->
key
, 
”r_msg
) !=

4530 
MG_SSL_OK
) {

4531  
MG_SSL_ERROR
;

4534 ià(
	g·¿ms
->
	gÿ_û¹
 !ğ
NULL
 &&

4535 
mg_u£_ÿ_û¹
(
ùx
->
s¦_ùx
, 
·¿ms
->
ÿ_û¹
è!ğ
MG_SSL_OK
) {

4536 
MG_SET_PTRPTR
(
”r_msg
, "Invalid SSL CA cert");

4537  
	gMG_SSL_ERROR
;

4540 ià(
	g·¿ms
->
	g£rv”_Çme
 !ğ
NULL
) {

4541 #ifdeà
KR_VERSION


4542 
SSL_CTX_kr_£t_v”ify_Çme
(
ùx
->
s¦_ùx
, 
·¿ms
->
£rv”_Çme
);

4548 ià(
mg_£t_ch”_li¡
(
ùx
->
s¦_ùx
, 
·¿ms
->
ch”_su™es
è!ğ
MG_SSL_OK
) {

4549 
MG_SET_PTRPTR
(
”r_msg
, "Invalid cipher suite†ist");

4550  
	gMG_SSL_ERROR
;

4553 
mbuf_š™
(&
ùx
->
psk
, 0);

4554 ià(
mg_s¦_if_os¦_£t_psk
(
ùx
, 
·¿ms
->
psk_id’t™y
,…¬ams->
psk_key
) !=

4555 
MG_SSL_OK
) {

4556 
MG_SET_PTRPTR
(
”r_msg
, "Invalid PSK settings");

4557  
	gMG_SSL_ERROR
;

4560 ià(!(
	gnc
->
	gæags
 & 
	gMG_F_LISTENING
) &&

4561 (
	gùx
->
	gs¦
 = 
SSL_Ãw
(
ùx
->
s¦_ùx
)è=ğ
NULL
) {

4562 
MG_SET_PTRPTR
(
”r_msg
, "Failedo create SSL session");

4563  
	gMG_SSL_ERROR
;

4566 
	gnc
->
	gæags
 |ğ
MG_F_SSL
;

4568  
	gMG_SSL_OK
;

4571 
mg_s¦_if_»suÉ
 
mg_s¦_if_s¦_”r
(
mg_cÚÃùiÚ
 *
nc
,

4572 
»s
) {

4573 
mg_s¦_if_ùx
 *
	gùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

4574 
	g”r
 = 
SSL_g‘_”rÜ
(
ùx
->
s¦
, 
»s
);

4575 ià(
	g”r
 =ğ
SSL_ERROR_WANT_READ
è 
MG_SSL_WANT_READ
;

4576 ià(
	g”r
 =ğ
SSL_ERROR_WANT_WRITE
è 
MG_SSL_WANT_WRITE
;

4577 
DBG
(("%°%°SSLƒ¼Ü: %d %d", 
nc
, 
ùx
->
s¦_ùx
, 
»s
, 
”r
));

4578 
	gnc
->
	g”r
 = 
”r
;

4579  
	gMG_SSL_ERROR
;

4582 
mg_s¦_if_»suÉ
 
mg_s¦_if_hªdshake
(
mg_cÚÃùiÚ
 *
nc
) {

4583 
mg_s¦_if_ùx
 *
	gùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

4584 
	g£rv”_side
 = (
nc
->
li¡’”
 !ğ
NULL
);

4585 
	g»s
;

4587 ià(
SSL_g‘_fd
(
ùx
->
s¦
) < 0) {

4588 ià(
SSL_£t_fd
(
ùx
->
s¦
, 
nc
->
sock
è!ğ1è 
MG_SSL_ERROR
;

4590 
	g»s
 = 
£rv”_side
 ? 
SSL_acû±
(
ùx
->
s¦
è: 
SSL_cÚÃù
(ctx->ssl);

4591 ià(
	g»s
 !ğ1è 
mg_s¦_if_s¦_”r
(
nc
, 
»s
);

4592  
	gMG_SSL_OK
;

4595 
mg_s¦_if_»ad
(
mg_cÚÃùiÚ
 *
nc
, *
buf
, 
size_t
 
buf_size
) {

4596 
mg_s¦_if_ùx
 *
	gùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

4597 
	gn
 = 
SSL_»ad
(
ùx
->
s¦
, 
buf
, 
buf_size
);

4598 
DBG
(("%°%d -> %d", 
nc
, (è
buf_size
, 
n
));

4599 ià(
	gn
 < 0è 
mg_s¦_if_s¦_”r
(
nc
, 
n
);

4600 ià(
	gn
 =ğ0è
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

4601  
	gn
;

4604 
mg_s¦_if_wr™e
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
d©a
, 
size_t
 
Ën
) {

4605 
mg_s¦_if_ùx
 *
	gùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

4606 
	gn
 = 
SSL_wr™e
(
ùx
->
s¦
, 
d©a
, 
Ën
);

4607 
DBG
(("%°%d -> %d", 
nc
, (è
Ën
, 
n
));

4608 ià(
	gn
 <ğ0è 
mg_s¦_if_s¦_”r
(
nc
, 
n
);

4609  
	gn
;

4612 
mg_s¦_if_cÚn_şo£_nÙify
(
mg_cÚÃùiÚ
 *
nc
) {

4613 
mg_s¦_if_ùx
 *
	gùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

4614 ià(
	gùx
 =ğ
NULL
) ;

4615 
SSL_shutdown
(
ùx
->
s¦
);

4618 
mg_s¦_if_cÚn_ä“
(
mg_cÚÃùiÚ
 *
nc
) {

4619 
mg_s¦_if_ùx
 *
	gùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

4620 ià(
	gùx
 =ğ
NULL
) ;

4621 
	gnc
->
	gs¦_if_d©a
 = 
NULL
;

4622 ià(
	gùx
->
	gs¦
 !ğ
NULL
è
SSL_ä“
(
ùx
->
s¦
);

4623 ià(
	gùx
->
	gs¦_ùx
 !ğ
NULL
 && 
nc
->
li¡’”
 =ğNULLè
SSL_CTX_ä“
(
ùx
->
s¦_ùx
);

4624 
mbuf_ä“
(&
ùx
->
psk
);

4625 
mem£t
(
ùx
, 0, (*ctx));

4626 
MG_FREE
(
ùx
);

4633 cÚ¡ 
	gmg_s_ch”_li¡
[] =

4634 #ià
defšed
(
MG_SSL_CRYPTO_MODERN
)

4644 #–ià
defšed
(
MG_SSL_CRYPTO_OLD
)

4676 #ià!
MG_DISABLE_PFS
 && !
defšed
(
KR_VERSION
)

4677 cÚ¡ 
	gmg_s_deçuÉ_dh_·¿ms
[] =

4689 
mg_s¦_if_»suÉ
 
mg_u£_ÿ_û¹
(
SSL_CTX
 *
ùx
, cÚ¡ *
û¹
) {

4690 ià(
	gû¹
 =ğ
NULL
 || 
¡rcmp
(
û¹
, "*") == 0) {

4691  
MG_SSL_OK
;

4693 
SSL_CTX_£t_v”ify
(
ùx
, 
SSL_VERIFY_PEER
 | 
SSL_VERIFY_FAIL_IF_NO_PEER_CERT
, 0);

4694  
SSL_CTX_lßd_v”ify_loÿtiÚs
(
ùx
, 
û¹
, 
NULL
è=ğ1 ? 
MG_SSL_OK


4695 : 
MG_SSL_ERROR
;

4698 
mg_s¦_if_»suÉ
 
mg_u£_û¹
(
SSL_CTX
 *
ùx
, cÚ¡ *
û¹
,

4699 cÚ¡ *
key
,

4700 cÚ¡ **
”r_msg
) {

4701 ià(
	gkey
 =ğ
NULL
è
key
 = 
û¹
;

4702 ià(
	gû¹
 =ğ
NULL
 || 
û¹
[0] =ğ'\0' || 
key
 == NULL || key[0] == '\0') {

4703  
MG_SSL_OK
;

4704 } ià(
SSL_CTX_u£_û¹ifiÿ‹_fe
(
ùx
, 
û¹
, 1) == 0) {

4705 
MG_SET_PTRPTR
(
”r_msg
, "Invalid SSL cert");

4706  
	gMG_SSL_ERROR
;

4707 } ià(
SSL_CTX_u£_Priv©eKey_fe
(
ùx
, 
key
, 1) == 0) {

4708 
MG_SET_PTRPTR
(
”r_msg
, "Invalid SSL key");

4709  
	gMG_SSL_ERROR
;

4710 } ià(
SSL_CTX_u£_û¹ifiÿ‹_chaš_fe
(
ùx
, 
û¹
) == 0) {

4711 
MG_SET_PTRPTR
(
”r_msg
, "Invalid CA bundle");

4712  
	gMG_SSL_ERROR
;

4714 
SSL_CTX_£t_mode
(
ùx
, 
SSL_MODE_ACCEPT_MOVING_WRITE_BUFFER
);

4715 #ià!
MG_DISABLE_PFS
 && !
defšed
(
KR_VERSION
)

4716 
BIO
 *
	gbio
 = 
NULL
;

4717 
DH
 *
	gdh
 = 
NULL
;

4720 
	gbio
 = 
BIO_Ãw_fe
(
û¹
, "r");

4721 ià(
	gbio
 !ğ
NULL
) {

4722 
dh
 = 
PEM_»ad_bio_DH·¿ms
(
bio
, 
NULL
, NULL, NULL);

4723 
BIO_ä“
(
bio
);

4729 ià(
	gdh
 =ğ
NULL
) {

4730 
bio
 = 
BIO_Ãw_mem_buf
((*è
mg_s_deçuÉ_dh_·¿ms
, -1);

4731 
	gdh
 = 
PEM_»ad_bio_DH·¿ms
(
bio
, 
NULL
, NULL, NULL);

4732 
BIO_ä“
(
bio
);

4734 ià(
	gdh
 !ğ
NULL
) {

4735 
SSL_CTX_£t_tmp_dh
(
ùx
, 
dh
);

4736 
SSL_CTX_£t_İtiÚs
(
ùx
, 
SSL_OP_SINGLE_DH_USE
);

4737 
DH_ä“
(
dh
);

4739 #ià
OPENSSL_VERSION_NUMBER
 > 0x10002000L

4740 
SSL_CTX_£t_ecdh_auto
(
ùx
, 1);

4744  
	gMG_SSL_OK
;

4747 
mg_s¦_if_»suÉ
 
mg_£t_ch”_li¡
(
SSL_CTX
 *
ùx
, cÚ¡ *
ş
) {

4748  (
SSL_CTX_£t_ch”_li¡
(
ùx
, 
ş
 ? cÈ: 
mg_s_ch”_li¡
) == 1

4749 ? 
MG_SSL_OK


4750 : 
MG_SSL_ERROR
);

4753 #iâdeà
KR_VERSION


4754 
mg_s¦_if_os¦_psk_cb
(
SSL
 *
s¦
, cÚ¡ *
hšt
,

4755 *
id’t™y
,

4756 
max_id’t™y_Ën
,

4757 *
psk
,

4758 
max_psk_Ën
) {

4759 
mg_s¦_if_ùx
 *
	gùx
 =

4760 (
mg_s¦_if_ùx
 *è
SSL_CTX_g‘_­p_d©a
(
SSL_g‘_SSL_CTX
(
s¦
));

4761 
size_t
 
	gkey_Ën
 = 
ùx
->
psk
.
Ën
 - ctx->
id’t™y_Ën
 - 1;

4762 
DBG
(("hšt: '%s'", (
hšt
 ? hint : "")));

4763 ià(
	gùx
->
	gid’t™y_Ën
 + 1 > 
	gmax_id’t™y_Ën
) {

4764 
DBG
(("identityoo†ong"));

4767 ià(
	gkey_Ën
 > 
	gmax_psk_Ën
) {

4768 
DBG
(("keyoo†ong"));

4771 
memıy
(
id’t™y
, 
ùx
->
psk
.
buf
, ctx->
id’t™y_Ën
 + 1);

4772 
memıy
(
psk
, 
ùx
->psk.
buf
 + ctx->
id’t™y_Ën
 + 1, 
key_Ën
);

4773 (è
	gs¦
;

4774  
	gkey_Ën
;

4777 
mg_s¦_if_»suÉ
 
mg_s¦_if_os¦_£t_psk
(
mg_s¦_if_ùx
 *
ùx
,

4778 cÚ¡ *
id’t™y
,

4779 cÚ¡ *
key_¡r
) {

4780 
	gkey
[32];

4781 
size_t
 
	gkey_Ën
;

4782 
size_t
 
	gi
 = 0;

4783 ià(
	gid’t™y
 =ğ
NULL
 && 
key_¡r
 =ğNULLè 
MG_SSL_OK
;

4784 ià(
	gid’t™y
 =ğ
NULL
 || 
key_¡r
 =ğNULLè 
MG_SSL_ERROR
;

4785 
	gkey_Ën
 = 
¡¾’
(
key_¡r
);

4786 ià(
	gkey_Ën
 !ğ32 && 
key_Ën
 !ğ64è 
MG_SSL_ERROR
;

4787 
mem£t
(
key
, 0, (key));

4788 
	gkey_Ën
 = 0;

4789 
	gi
 = 0; 
	gkey_¡r
[
i
] != '\0'; i++) {

4790 
	gc
;

4791 
	ghc
 = 
tŞow”
((è
key_¡r
[
i
]);

4792 ià(
	ghc
 >ğ'0' && 
hc
 <= '9') {

4793 
c
 = 
hc
 - '0';

4794 } ià(
	ghc
 >ğ'a' && 
hc
 <= 'f') {

4795 
c
 = 
hc
 - 'a' + 0xa;

4797  
	gMG_SSL_ERROR
;

4799 
	gkey_Ën
 = 
i
 / 2;

4800 
	gkey
[
key_Ën
] <<= 4;

4801 
	gkey
[
key_Ën
] |ğ
c
;

4803 
	gkey_Ën
++;

4804 
DBG
(("id’t™y = '%s', key = (%u)", 
id’t™y
, (è
key_Ën
));

4805 
	gùx
->
	gid’t™y_Ën
 = 
¡¾’
(
id’t™y
);

4806 
mbuf_­³nd
(&
ùx
->
psk
, 
id’t™y
, ctx->
id’t™y_Ën
 + 1);

4807 
mbuf_­³nd
(&
ùx
->
psk
, 
key
, 
key_Ën
);

4808 
SSL_CTX_£t_psk_ş›Á_ÿÎback
(
ùx
->
s¦_ùx
, 
mg_s¦_if_os¦_psk_cb
);

4809 
SSL_CTX_£t_­p_d©a
(
ùx
->
s¦_ùx
, ctx);

4810  
	gMG_SSL_OK
;

4813 
mg_s¦_if_»suÉ
 
mg_s¦_if_os¦_£t_psk
(
mg_s¦_if_ùx
 *
ùx
,

4814 cÚ¡ *
id’t™y
,

4815 cÚ¡ *
key_¡r
) {

4816 (è
	gùx
;

4817 (è
	gid’t™y
;

4818 (è
	gkey_¡r
;

4820  
	gMG_SSL_ERROR
;

4824 cÚ¡ *
mg_£t_s¦
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
û¹
,

4825 cÚ¡ *
ÿ_û¹
) {

4826 cÚ¡ *
	g”r_msg
 = 
NULL
;

4827 
mg_s¦_if_cÚn_·¿ms
 
	g·¿ms
;

4828 
mem£t
(&
·¿ms
, 0, (params));

4829 
	g·¿ms
.
	gû¹
 = 
û¹
;

4830 
	g·¿ms
.
	gÿ_û¹
 = 
ÿ_û¹
;

4831 ià(
mg_s¦_if_cÚn_š™
(
nc
, &
·¿ms
, &
”r_msg
è!ğ
MG_SSL_OK
) {

4832  
”r_msg
;

4834  
	gNULL
;

4838 #ifdeà
MG_MODULE_LINES


4846 #ià
MG_ENABLE_SSL
 && 
MG_SSL_IF
 =ğ
MG_SSL_IF_MBEDTLS


4848 
	~<mbeds/debug.h
>

4849 
	~<mbeds/eı.h
>

4850 
	~<mbeds/¶©fÜm.h
>

4851 
	~<mbeds/s¦.h
>

4852 
	~<mbeds/x509_üt.h
>

4854 
mg_s¦_mbed_log
(*
ùx
, 
Ëv–
, cÚ¡ *
fe
, 
lše
,

4855 cÚ¡ *
¡r
) {

4856 
cs_log_Ëv–
 
	gcs_Ëv–
;

4857 
	gËv–
) {

4859 
cs_Ëv–
 = 
LL_ERROR
;

4863 
cs_Ëv–
 = 
LL_DEBUG
;

4866 
cs_Ëv–
 = 
LL_VERBOSE_DEBUG
;

4869 
LOG
(
cs_Ëv–
, ("%°%.*s", 
ùx
, (è(
¡¾’
(
¡r
) - 1), str));

4870 (è
	gfe
;

4871 (è
	glše
;

4874 
	smg_s¦_if_ùx
 {

4875 
mbeds_s¦_cÚfig
 *
	gcÚf
;

4876 
mbeds_s¦_cÚ‹xt
 *
	gs¦
;

4877 
mbeds_x509_üt
 *
	gû¹
;

4878 
mbeds_pk_cÚ‹xt
 *
	gkey
;

4879 
mbeds_x509_üt
 *
	gÿ_û¹
;

4880 
mbuf
 
	gch”_su™es
;

4884 
mg_s¦_if_mbed_¿ndom
(*
ùx
, *
buf
, 
size_t
 
Ën
);

4886 
mg_s¦_if_š™
() {

4889 
mg_s¦_if_»suÉ
 
mg_s¦_if_cÚn_acû±
(
mg_cÚÃùiÚ
 *
nc
,

4890 
mg_cÚÃùiÚ
 *
lc
) {

4891 
mg_s¦_if_ùx
 *
	gùx
 =

4892 (
mg_s¦_if_ùx
 *è
MG_CALLOC
(1, (*
ùx
));

4893 
mg_s¦_if_ùx
 *
	glc_ùx
 = (mg_s¦_if_ùx *è
lc
->
s¦_if_d©a
;

4894 
	gnc
->
	gs¦_if_d©a
 = 
ùx
;

4895 ià(
	gùx
 =ğ
NULL
 || 
lc_ùx
 =ğNULLè 
MG_SSL_ERROR
;

4896 
	gùx
->
	gs¦
 = (
mbeds_s¦_cÚ‹xt
 *è
MG_CALLOC
(1, (*
ùx
->
s¦
));

4897 ià(
mbeds_s¦_£tup
(
ùx
->
s¦
, 
lc_ùx
->
cÚf
) != 0) {

4898  
MG_SSL_ERROR
;

4900  
	gMG_SSL_OK
;

4903 
mg_s¦_if_»suÉ
 
mg_u£_û¹
(
mg_s¦_if_ùx
 *
ùx
,

4904 cÚ¡ *
û¹
, cÚ¡ *
key
,

4905 cÚ¡ **
”r_msg
);

4906 
mg_s¦_if_»suÉ
 
mg_u£_ÿ_û¹
(
mg_s¦_if_ùx
 *
ùx
,

4907 cÚ¡ *
û¹
);

4908 
mg_s¦_if_»suÉ
 
mg_£t_ch”_li¡
(
mg_s¦_if_ùx
 *
ùx
,

4909 cÚ¡ *
ch”s
);

4910 
mg_s¦_if_»suÉ
 
mg_s¦_if_mbed_£t_psk
(
mg_s¦_if_ùx
 *
ùx
,

4911 cÚ¡ *
id’t™y
,

4912 cÚ¡ *
key
);

4914 
mg_s¦_if_»suÉ
 
mg_s¦_if_cÚn_š™
(

4915 
mg_cÚÃùiÚ
 *
nc
, cÚ¡ 
mg_s¦_if_cÚn_·¿ms
 *
·¿ms
,

4916 cÚ¡ **
”r_msg
) {

4917 
mg_s¦_if_ùx
 *
	gùx
 =

4918 (
mg_s¦_if_ùx
 *è
MG_CALLOC
(1, (*
ùx
));

4919 
DBG
(("%°%s,%s,%s", 
nc
, (
·¿ms
->
û¹
 ?…arams->cert : ""),

4920 (
·¿ms
->
key
 ?…arams->key : ""),

4921 (
·¿ms
->
ÿ_û¹
 ?…arams->ca_cert : "")));

4923 ià(
	gùx
 =ğ
NULL
) {

4924 
MG_SET_PTRPTR
(
”r_msg
, "Out of memory");

4925  
	gMG_SSL_ERROR
;

4927 
	gnc
->
	gs¦_if_d©a
 = 
ùx
;

4928 
	gùx
->
	gcÚf
 = (
mbeds_s¦_cÚfig
 *è
MG_CALLOC
(1, (*
ùx
->
cÚf
));

4929 
mbuf_š™
(&
ùx
->
ch”_su™es
, 0);

4930 
mbeds_s¦_cÚfig_š™
(
ùx
->
cÚf
);

4931 
mbeds_s¦_cÚf_dbg
(
ùx
->
cÚf
, 
mg_s¦_mbed_log
, 
nc
);

4932 ià(
mbeds_s¦_cÚfig_deçuÉs
(

4933 
ùx
->
cÚf
, (
nc
->
æags
 & 
MG_F_LISTENING
 ? 
MBEDTLS_SSL_IS_SERVER


4934 : 
MBEDTLS_SSL_IS_CLIENT
),

4935 
MBEDTLS_SSL_TRANSPORT_STREAM
, 
MBEDTLS_SSL_PRESET_DEFAULT
) != 0) {

4936 
MG_SET_PTRPTR
(
”r_msg
, "Failedo init SSL config");

4937  
	gMG_SSL_ERROR
;

4941 
mbeds_s¦_cÚf_mš_v”siÚ
(
ùx
->
cÚf
, 
MBEDTLS_SSL_MAJOR_VERSION_3
,

4942 
MBEDTLS_SSL_MINOR_VERSION_3
);

4943 
mbeds_s¦_cÚf_ºg
(
ùx
->
cÚf
, 
mg_s¦_if_mbed_¿ndom
, 
nc
);

4945 ià(
	g·¿ms
->
	gû¹
 !ğ
NULL
 &&

4946 
mg_u£_û¹
(
ùx
, 
·¿ms
->
û¹
,…¬ams->
key
, 
”r_msg
è!ğ
MG_SSL_OK
) {

4947  
MG_SSL_ERROR
;

4950 ià(
	g·¿ms
->
	gÿ_û¹
 !ğ
NULL
 &&

4951 
mg_u£_ÿ_û¹
(
ùx
, 
·¿ms
->
ÿ_û¹
è!ğ
MG_SSL_OK
) {

4952 
MG_SET_PTRPTR
(
”r_msg
, "Invalid SSL CA cert");

4953  
	gMG_SSL_ERROR
;

4956 ià(
mg_£t_ch”_li¡
(
ùx
, 
·¿ms
->
ch”_su™es
è!ğ
MG_SSL_OK
) {

4957 
MG_SET_PTRPTR
(
”r_msg
, "Invalid cipher suite†ist");

4958  
	gMG_SSL_ERROR
;

4961 ià(
mg_s¦_if_mbed_£t_psk
(
ùx
, 
·¿ms
->
psk_id’t™y
,…¬ams->
psk_key
) !=

4962 
MG_SSL_OK
) {

4963 
MG_SET_PTRPTR
(
”r_msg
, "Invalid PSK settings");

4964  
	gMG_SSL_ERROR
;

4967 ià(!(
	gnc
->
	gæags
 & 
	gMG_F_LISTENING
)) {

4968 
	gùx
->
	gs¦
 = (
mbeds_s¦_cÚ‹xt
 *è
MG_CALLOC
(1, (*
ùx
->
s¦
));

4969 
mbeds_s¦_š™
(
ùx
->
s¦
);

4970 ià(
mbeds_s¦_£tup
(
ùx
->
s¦
, ctx->
cÚf
) != 0) {

4971 
MG_SET_PTRPTR
(
”r_msg
, "Failedo create SSL session");

4972  
	gMG_SSL_ERROR
;

4974 ià(
	g·¿ms
->
	g£rv”_Çme
 !ğ
NULL
 &&

4975 
mbeds_s¦_£t_ho¡Çme
(
ùx
->
s¦
, 
·¿ms
->
£rv”_Çme
) != 0) {

4976  
MG_SSL_ERROR
;

4980 #ifdeà
MG_SSL_IF_MBEDTLS_MAX_FRAG_LEN


4981 ià(
mbeds_s¦_cÚf_max_äag_Ën
(
ùx
->
cÚf
,

4982 #ià
MG_SSL_IF_MBEDTLS_MAX_FRAG_LEN
 == 512

4983 
MBEDTLS_SSL_MAX_FRAG_LEN_512


4984 #–ià
MG_SSL_IF_MBEDTLS_MAX_FRAG_LEN
 == 1024

4985 
MBEDTLS_SSL_MAX_FRAG_LEN_1024


4986 #–ià
MG_SSL_IF_MBEDTLS_MAX_FRAG_LEN
 == 2048

4987 
MBEDTLS_SSL_MAX_FRAG_LEN_2048


4988 #–ià
MG_SSL_IF_MBEDTLS_MAX_FRAG_LEN
 == 4096

4989 
MBEDTLS_SSL_MAX_FRAG_LEN_4096


4991 #”rÜ 
Inv®id
 
MG_SSL_IF_MBEDTLS_MAX_FRAG_LEN


4994  
MG_SSL_ERROR
;

4998 
	gnc
->
	gæags
 |ğ
MG_F_SSL
;

5000  
	gMG_SSL_OK
;

5003 #ià
MG_NET_IF
 =ğ
MG_NET_IF_LWIP_LOW_LEVEL


5004 
s¦_sock‘_£nd
(*
ùx
, cÚ¡ *
buf
, 
size_t
 
Ën
);

5005 
s¦_sock‘_»cv
(*
ùx
, *
buf
, 
size_t
 
Ën
);

5007 
s¦_sock‘_£nd
(*
ùx
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

5008 
mg_cÚÃùiÚ
 *
	gnc
 = (mg_cÚÃùiÚ *è
ùx
;

5009 
	gn
 = (è
MG_SEND_FUNC
(
nc
->
sock
, 
buf
, 
Ën
, 0);

5010 
LOG
(
LL_DEBUG
, ("%°%d -> %d", 
nc
, (è
Ën
, 
n
));

5011 ià(
	gn
 >ğ0è 
n
;

5012 
	gn
 = 
mg_g‘_”ºo
();

5013  ((
	gn
 =ğ
EAGAIN
 || 
n
 =ğ
EINPROGRESS
è? 
MBEDTLS_ERR_SSL_WANT_WRITE
 : -1);

5016 
s¦_sock‘_»cv
(*
ùx
, *
buf
, 
size_t
 
Ën
) {

5017 
mg_cÚÃùiÚ
 *
	gnc
 = (mg_cÚÃùiÚ *è
ùx
;

5018 
	gn
 = (è
MG_RECV_FUNC
(
nc
->
sock
, 
buf
, 
Ën
, 0);

5019 
LOG
(
LL_DEBUG
, ("%°%d <- %d", 
nc
, (è
Ën
, 
n
));

5020 ià(
	gn
 >ğ0è 
n
;

5021 
	gn
 = 
mg_g‘_”ºo
();

5022  ((
	gn
 =ğ
EAGAIN
 || 
n
 =ğ
EINPROGRESS
è? 
MBEDTLS_ERR_SSL_WANT_READ
 : -1);

5026 
mg_s¦_if_»suÉ
 
mg_s¦_if_mbed_”r
(
mg_cÚÃùiÚ
 *
nc
,

5027 
»t
) {

5028 ià(
	g»t
 =ğ
MBEDTLS_ERR_SSL_WANT_READ
è 
MG_SSL_WANT_READ
;

5029 ià(
	g»t
 =ğ
MBEDTLS_ERR_SSL_WANT_WRITE
è 
MG_SSL_WANT_WRITE
;

5030 ià(
	g»t
 !=

5031 
MBEDTLS_ERR_SSL_PEER_CLOSE_NOTIFY
) {

5032 
LOG
(
LL_ERROR
, ("%°SSLƒ¼Ü: %d", 
nc
, 
»t
));

5034 
	gnc
->
	g”r
 = 
»t
;

5035 
	gnc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

5036  
	gMG_SSL_ERROR
;

5039 
mg_s¦_if_mbed_ä“_û¹s_ªd_keys
(
mg_s¦_if_ùx
 *
ùx
) {

5040 ià(
	gùx
->
	gû¹
 !ğ
NULL
) {

5041 
mbeds_x509_üt_ä“
(
ùx
->
û¹
);

5042 
MG_FREE
(
ùx
->
û¹
);

5043 
	gùx
->
	gû¹
 = 
NULL
;

5044 
mbeds_pk_ä“
(
ùx
->
key
);

5045 
MG_FREE
(
ùx
->
key
);

5046 
	gùx
->
	gkey
 = 
NULL
;

5048 ià(
	gùx
->
	gÿ_û¹
 !ğ
NULL
) {

5049 
mbeds_s¦_cÚf_ÿ_chaš
(
ùx
->
cÚf
, 
NULL
, NULL);

5050 #ifdeà
MBEDTLS_X509_CA_CHAIN_ON_DISK


5051 ià(
	gùx
->
	gÿ_û¹
->
	gÿ_chaš_fe
 !ğ
NULL
) {

5052 
MG_FREE
((*è
ùx
->
ÿ_û¹
->
ÿ_chaš_fe
);

5053 
	gùx
->
	gÿ_û¹
->
	gÿ_chaš_fe
 = 
NULL
;

5056 
mbeds_x509_üt_ä“
(
ùx
->
ÿ_û¹
);

5057 
MG_FREE
(
ùx
->
ÿ_û¹
);

5058 
	gùx
->
	gÿ_û¹
 = 
NULL
;

5062 
mg_s¦_if_»suÉ
 
mg_s¦_if_hªdshake
(
mg_cÚÃùiÚ
 *
nc
) {

5063 
mg_s¦_if_ùx
 *
	gùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

5064 
	g”r
;

5066 ià(
	gùx
->
	gs¦
->
	gp_bio
 =ğ
NULL
) {

5067 
mbeds_s¦_£t_bio
(
ùx
->
s¦
, 
nc
, 
s¦_sock‘_£nd
, 
s¦_sock‘_»cv
, 
NULL
);

5069 
	g”r
 = 
mbeds_s¦_hªdshake
(
ùx
->
s¦
);

5070 ià(
	g”r
 !ğ0è 
mg_s¦_if_mbed_”r
(
nc
, 
”r
);

5071 #ifdeà
MG_SSL_IF_MBEDTLS_FREE_CERTS


5076 
mbeds_x509_üt_ä“
(
ùx
->
s¦
->
£ssiÚ
->
³”_û¹
);

5077 
mbeds_ä“
(
ùx
->
s¦
->
£ssiÚ
->
³”_û¹
);

5078 
	gùx
->
	gs¦
->
	g£ssiÚ
->
	g³”_û¹
 = 
NULL
;

5080 ià(
	gnc
->
	gli¡’”
 =ğ
NULL
) {

5081 ià(
ùx
->
cÚf
->
key_û¹
 !ğ
NULL
) {

5083 
MG_FREE
(
ùx
->
cÚf
->
key_û¹
);

5084 
	gùx
->
	gcÚf
->
	gkey_û¹
 = 
NULL
;

5086 
mbeds_s¦_cÚf_ÿ_chaš
(
ùx
->
cÚf
, 
NULL
, NULL);

5087 
mg_s¦_if_mbed_ä“_û¹s_ªd_keys
(
ùx
);

5090  
	gMG_SSL_OK
;

5093 
mg_s¦_if_»ad
(
mg_cÚÃùiÚ
 *
nc
, *
buf
, 
size_t
 
buf_size
) {

5094 
mg_s¦_if_ùx
 *
	gùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

5095 
	gn
 = 
mbeds_s¦_»ad
(
ùx
->
s¦
, (*è
buf
, 
buf_size
);

5096 
DBG
(("%°%d -> %d", 
nc
, (è
buf_size
, 
n
));

5097 ià(
	gn
 < 0è 
mg_s¦_if_mbed_”r
(
nc
, 
n
);

5098 ià(
	gn
 =ğ0è
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

5099  
	gn
;

5102 
mg_s¦_if_wr™e
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
d©a
, 
size_t
 
Ën
) {

5103 
mg_s¦_if_ùx
 *
	gùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

5104 
	gn
 = 
mbeds_s¦_wr™e
(
ùx
->
s¦
, (cÚ¡ *è
d©a
, 
Ën
);

5105 
DBG
(("%°%d -> %d", 
nc
, (è
Ën
, 
n
));

5106 ià(
	gn
 < 0è 
mg_s¦_if_mbed_”r
(
nc
, 
n
);

5107  
	gn
;

5110 
mg_s¦_if_cÚn_şo£_nÙify
(
mg_cÚÃùiÚ
 *
nc
) {

5111 
mg_s¦_if_ùx
 *
	gùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

5112 ià(
	gùx
 =ğ
NULL
) ;

5113 
mbeds_s¦_şo£_nÙify
(
ùx
->
s¦
);

5116 
mg_s¦_if_cÚn_ä“
(
mg_cÚÃùiÚ
 *
nc
) {

5117 
mg_s¦_if_ùx
 *
	gùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

5118 ià(
	gùx
 =ğ
NULL
) ;

5119 
	gnc
->
	gs¦_if_d©a
 = 
NULL
;

5120 ià(
	gùx
->
	gs¦
 !ğ
NULL
) {

5121 
mbeds_s¦_ä“
(
ùx
->
s¦
);

5122 
MG_FREE
(
ùx
->
s¦
);

5124 
mg_s¦_if_mbed_ä“_û¹s_ªd_keys
(
ùx
);

5125 ià(
	gùx
->
	gcÚf
 !ğ
NULL
) {

5126 
mbeds_s¦_cÚfig_ä“
(
ùx
->
cÚf
);

5127 
MG_FREE
(
ùx
->
cÚf
);

5129 
mbuf_ä“
(&
ùx
->
ch”_su™es
);

5130 
mem£t
(
ùx
, 0, (*ctx));

5131 
MG_FREE
(
ùx
);

5134 
mg_s¦_if_»suÉ
 
mg_u£_ÿ_û¹
(
mg_s¦_if_ùx
 *
ùx
,

5135 cÚ¡ *
ÿ_û¹
) {

5136 ià(
	gÿ_û¹
 =ğ
NULL
 || 
¡rcmp
(
ÿ_û¹
, "*") == 0) {

5137 
mbeds_s¦_cÚf_authmode
(
ùx
->
cÚf
, 
MBEDTLS_SSL_VERIFY_NONE
);

5138  
	gMG_SSL_OK
;

5140 
	gùx
->
	gÿ_û¹
 = (
mbeds_x509_üt
 *è
MG_CALLOC
(1, (*
ùx
->
ÿ_û¹
));

5141 
mbeds_x509_üt_š™
(
ùx
->
ÿ_û¹
);

5142 #ifdeà
MBEDTLS_X509_CA_CHAIN_ON_DISK


5143 
	gÿ_û¹
 = 
¡rdup
(
ÿ_û¹
);

5144 ià(
mbeds_x509_üt_£t_ÿ_chaš_fe
(
ùx
->
ÿ_û¹
, ca_cert) != 0) {

5145  
MG_SSL_ERROR
;

5148 ià(
mbeds_x509_üt_·r£_fe
(
ùx
->
ÿ_û¹
, ca_cert) != 0) {

5149  
MG_SSL_ERROR
;

5152 
mbeds_s¦_cÚf_ÿ_chaš
(
ùx
->
cÚf
, ctx->
ÿ_û¹
, 
NULL
);

5153 
mbeds_s¦_cÚf_authmode
(
ùx
->
cÚf
, 
MBEDTLS_SSL_VERIFY_REQUIRED
);

5154  
	gMG_SSL_OK
;

5157 
mg_s¦_if_»suÉ
 
mg_u£_û¹
(
mg_s¦_if_ùx
 *
ùx
,

5158 cÚ¡ *
û¹
, cÚ¡ *
key
,

5159 cÚ¡ **
”r_msg
) {

5160 ià(
	gkey
 =ğ
NULL
è
key
 = 
û¹
;

5161 ià(
	gû¹
 =ğ
NULL
 || 
û¹
[0] =ğ'\0' || 
key
 == NULL || key[0] == '\0') {

5162  
MG_SSL_OK
;

5164 
	gùx
->
	gû¹
 = (
mbeds_x509_üt
 *è
MG_CALLOC
(1, (*
ùx
->
û¹
));

5165 
mbeds_x509_üt_š™
(
ùx
->
û¹
);

5166 
	gùx
->
	gkey
 = (
mbeds_pk_cÚ‹xt
 *è
MG_CALLOC
(1, (*
ùx
->
key
));

5167 
mbeds_pk_š™
(
ùx
->
key
);

5168 ià(
mbeds_x509_üt_·r£_fe
(
ùx
->
û¹
, cert) != 0) {

5169 
MG_SET_PTRPTR
(
”r_msg
, "Invalid SSL cert");

5170  
	gMG_SSL_ERROR
;

5172 ià(
mbeds_pk_·r£_keyfe
(
ùx
->
key
, key, 
NULL
) != 0) {

5173 
MG_SET_PTRPTR
(
”r_msg
, "Invalid SSL key");

5174  
	gMG_SSL_ERROR
;

5176 ià(
mbeds_s¦_cÚf_own_û¹
(
ùx
->
cÚf
, ctx->
û¹
, ctx->
key
) != 0) {

5177 
MG_SET_PTRPTR
(
”r_msg
, "Invalid SSL key or cert");

5178  
	gMG_SSL_ERROR
;

5180  
	gMG_SSL_OK
;

5183 cÚ¡ 
	gmg_s_ch”_li¡
[] = {

5184 
MBEDTLS_TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
,

5185 
MBEDTLS_TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256
,

5186 
MBEDTLS_TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
,

5187 
MBEDTLS_TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256
,

5188 
MBEDTLS_TLS_DHE_RSA_WITH_AES_128_GCM_SHA256
,

5189 
MBEDTLS_TLS_DHE_RSA_WITH_AES_128_CBC_SHA256
,

5190 
MBEDTLS_TLS_ECDH_ECDSA_WITH_AES_128_GCM_SHA256
,

5191 
MBEDTLS_TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA256
,

5192 
MBEDTLS_TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA
,

5193 
MBEDTLS_TLS_ECDH_RSA_WITH_AES_128_GCM_SHA256
,

5194 
MBEDTLS_TLS_ECDH_RSA_WITH_AES_128_CBC_SHA256
,

5195 
MBEDTLS_TLS_ECDH_RSA_WITH_AES_128_CBC_SHA
,

5196 
MBEDTLS_TLS_RSA_WITH_AES_128_GCM_SHA256
,

5197 
MBEDTLS_TLS_RSA_WITH_AES_128_CBC_SHA256
,

5198 
MBEDTLS_TLS_RSA_WITH_AES_128_CBC_SHA
, 0};

5206 
mg_s¦_if_»suÉ
 
mg_£t_ch”_li¡
(
mg_s¦_if_ùx
 *
ùx
,

5207 cÚ¡ *
ch”s
) {

5208 ià(
	gch”s
 !ğ
NULL
) {

5209 
l
, 
id
;

5210 cÚ¡ *
	gs
 = 
ch”s
, *
	ge
;

5211 
	gtmp
[50];

5212 
	gs
 !ğ
NULL
) {

5213 
e
 = 
¡rchr
(
s
, ':');

5214 
	gl
 = (
e
 !ğ
NULL
 ? (- 
s
è: (è
¡¾’
(s));

5215 
¡ºıy
(
tmp
, 
s
, 
l
);

5216 
	gtmp
[
l
] = '\0';

5217 
	gid
 = 
mbeds_s¦_g‘_ch”su™e_id
(
tmp
);

5218 
DBG
(("% -> %04x", 
tmp
, 
id
));

5219 ià(
	gid
 != 0) {

5220 
mbuf_­³nd
(&
ùx
->
ch”_su™es
, &
id
, (id));

5222 
	gs
 = (
e
 !ğ
NULL
 ?ƒ + 1 : NULL);

5224 ià(
	gùx
->
	gch”_su™es
.
	gËn
 =ğ0è 
MG_SSL_ERROR
;

5225 
	gid
 = 0;

5226 
mbuf_­³nd
(&
ùx
->
ch”_su™es
, &
id
, (id));

5227 
mbuf_Œim
(&
ùx
->
ch”_su™es
);

5228 
mbeds_s¦_cÚf_ch”su™es
(
ùx
->
cÚf
,

5229 (cÚ¡ *è
ùx
->
ch”_su™es
.
buf
);

5231 
mbeds_s¦_cÚf_ch”su™es
(
ùx
->
cÚf
, 
mg_s_ch”_li¡
);

5233  
	gMG_SSL_OK
;

5236 
mg_s¦_if_»suÉ
 
mg_s¦_if_mbed_£t_psk
(
mg_s¦_if_ùx
 *
ùx
,

5237 cÚ¡ *
id’t™y
,

5238 cÚ¡ *
key_¡r
) {

5239 
	gkey
[32];

5240 
size_t
 
	gkey_Ën
;

5241 ià(
	gid’t™y
 =ğ
NULL
 && 
key_¡r
 =ğNULLè 
MG_SSL_OK
;

5242 ià(
	gid’t™y
 =ğ
NULL
 || 
key_¡r
 =ğNULLè 
MG_SSL_ERROR
;

5243 
	gkey_Ën
 = 
¡¾’
(
key_¡r
);

5244 ià(
	gkey_Ën
 !ğ32 && 
key_Ën
 !ğ64è 
MG_SSL_ERROR
;

5245 
size_t
 
	gi
 = 0;

5246 
mem£t
(
key
, 0, (key));

5247 
	gkey_Ën
 = 0;

5248 
	gi
 = 0; 
	gkey_¡r
[
i
] != '\0'; i++) {

5249 
	gc
;

5250 
	ghc
 = 
tŞow”
((è
key_¡r
[
i
]);

5251 ià(
	ghc
 >ğ'0' && 
hc
 <= '9') {

5252 
c
 = 
hc
 - '0';

5253 } ià(
	ghc
 >ğ'a' && 
hc
 <= 'f') {

5254 
c
 = 
hc
 - 'a' + 0xa;

5256  
	gMG_SSL_ERROR
;

5258 
	gkey_Ën
 = 
i
 / 2;

5259 
	gkey
[
key_Ën
] <<= 4;

5260 
	gkey
[
key_Ën
] |ğ
c
;

5262 
	gkey_Ën
++;

5263 
DBG
(("id’t™y = '%s', key = (%u)", 
id’t™y
, (è
key_Ën
));

5265 ià(
mbeds_s¦_cÚf_psk
(
ùx
->
cÚf
, (cÚ¡ *è
key
, 
key_Ën
,

5266 (cÚ¡ *è
id’t™y
,

5267 
¡¾’
(
id’t™y
)) != 0) {

5268  
MG_SSL_ERROR
;

5270  
	gMG_SSL_OK
;

5273 cÚ¡ *
mg_£t_s¦
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
û¹
,

5274 cÚ¡ *
ÿ_û¹
) {

5275 cÚ¡ *
	g”r_msg
 = 
NULL
;

5276 
mg_s¦_if_cÚn_·¿ms
 
	g·¿ms
;

5277 
mem£t
(&
·¿ms
, 0, (params));

5278 
	g·¿ms
.
	gû¹
 = 
û¹
;

5279 
	g·¿ms
.
	gÿ_û¹
 = 
ÿ_û¹
;

5280 ià(
mg_s¦_if_cÚn_š™
(
nc
, &
·¿ms
, &
”r_msg
è!ğ
MG_SSL_OK
) {

5281  
”r_msg
;

5283  
	gNULL
;

5287 #ifdeà
MG_SSL_MBED_DUMMY_RANDOM


5288 
mg_s¦_if_mbed_¿ndom
(*
ùx
, *
buf
, 
size_t
 
Ën
) {

5289 (è
	gùx
;

5290 
	gËn
--è*
	gbuf
++ = 
¿nd
();

5296 #ifdeà
MG_MODULE_LINES


5313 
·r£_uri_compÚ’t
(cÚ¡ **
p
, cÚ¡ *
’d
,

5314 cÚ¡ *
£ps
, 
mg_¡r
 *
»s
) {

5315 cÚ¡ *
	gq
;

5316 
	g»s
->
	gp
 = *
p
;

5317 ; *
	gp
 < 
	g’d
; (*p)++) {

5318 
	gq
 = 
£ps
; *q != '\0'; q++) {

5319 ià(**
	gp
 =ğ*
q
) ;

5321 ià(*
	gq
 != '\0') ;

5323 
	g»s
->
	gËn
 = (*
p
è- 
»s
->p;

5324 ià(*
	gp
 < 
	g’d
) (*p)++;

5327 
mg_·r£_uri
(cÚ¡ 
mg_¡r
 
uri
, mg_¡¸*
scheme
,

5328 
mg_¡r
 *
u£r_šfo
, mg_¡¸*
ho¡
,

5329 *
pÜt
, 
mg_¡r
 *
·th
, mg_¡¸*
qu”y
,

5330 
mg_¡r
 *
äagm’t
) {

5331 
mg_¡r
 
	grscheme
 = {0, 0}, 
	gru£r_šfo
 = {0, 0}, 
	grho¡
 = {0, 0},

5332 
	g½©h
 = {0, 0}, 
	grqu”y
 = {0, 0}, 
	gräagm’t
 = {0, 0};

5333 
	g½Üt
 = 0;

5335 
	gP_START
,

5336 
	gP_SCHEME_OR_PORT
,

5337 
	gP_USER_INFO
,

5338 
	gP_HOST
,

5339 
	gP_PORT
,

5340 
	gP_REST


5341 } 
	g¡©e
 = 
P_START
;

5343 cÚ¡ *
	gp
 = 
uri
.
p
, *
	g’d
 =… + uri.
Ën
;

5344 
	gp
 < 
	g’d
) {

5345 
	g¡©e
) {

5346 
	gP_START
:

5354 ià(*
p
 == '[') {

5355 
¡©e
 = 
P_HOST
;

5358 ; 
	gp
 < 
	g’d
;…++) {

5359 ià(*
	gp
 == ':') {

5360 
¡©e
 = 
P_SCHEME_OR_PORT
;

5362 } ià(*
	gp
 == '/') {

5363 
¡©e
 = 
P_REST
;

5367 ià(
	g¡©e
 =ğ
P_START
 || 
¡©e
 =ğ
P_REST
) {

5368 
rho¡
.
p
 = 
uri
.p;

5369 
	grho¡
.
	gËn
 = 
p
 - 
uri
.p;

5372 
	gP_SCHEME_OR_PORT
:

5373 ià(
’d
 - 
p
 >ğ3 && 
¡ºcmp
(p, "://", 3) == 0) {

5374 
rscheme
.
p
 = 
uri
.p;

5375 
	grscheme
.
	gËn
 = 
p
 - 
uri
.p;

5376 
	g¡©e
 = 
P_USER_INFO
;

5377 
	gp
 += 3;

5379 
	grho¡
.
	gp
 = 
uri
.
p
;

5380 
	grho¡
.
	gËn
 = 
p
 - 
uri
.p;

5381 
	g¡©e
 = 
P_PORT
;

5384 
	gP_USER_INFO
:

5385 
ru£r_šfo
.
p
 =…;

5386 ; 
	gp
 < 
	g’d
;…++) {

5387 ià(*
	gp
 =ğ'@' || *
p
 == '[') {

5391 ià(
	gp
 =ğ
’d
 || *
p
 == '/' || *p == '[') {

5393 
p
 = 
ru£r_šfo
.p;

5395 
	gru£r_šfo
.
	gËn
 = 
p
 - 
ru£r_šfo
.p;

5396 
	g¡©e
 = 
P_HOST
;

5398 
	gP_HOST
:

5399 ià(*
p
 == '@')…++;

5400 
	grho¡
.
	gp
 = 
p
;

5401 ià(*
	gp
 == '[') {

5402 
found
 = 0;

5403 ; !
	gfound
 && 
	gp
 < 
	g’d
;…++) {

5404 
	gfound
 = (*
p
 == ']');

5406 ià(!
	gfound
)  -1;

5408 ; 
	gp
 < 
	g’d
;…++) {

5409 ià(*
	gp
 =ğ':' || *
p
 == '/') ;

5412 
	grho¡
.
	gËn
 = 
p
 - 
rho¡
.p;

5413 ià(
	gp
 < 
	g’d
) {

5414 ià(*
	gp
 == ':') {

5415 
¡©e
 = 
P_PORT
;

5417 } ià(*
	gp
 == '/') {

5418 
¡©e
 = 
P_REST
;

5423 
	gP_PORT
:

5424 
p
++;

5425 ; 
	gp
 < 
	g’d
;…++) {

5426 ià(*
	gp
 == '/') {

5427 
¡©e
 = 
P_REST
;

5430 
	g½Üt
 *= 10;

5431 
	g½Üt
 +ğ*
p
 - '0';

5434 
	gP_REST
:

5436 
·r£_uri_compÚ’t
(&
p
, 
’d
, "?#", &
½©h
);

5437 ià(
	gp
 < 
	g’d
 && *(p - 1) == '?') {

5438 
·r£_uri_compÚ’t
(&
p
, 
’d
, "#", &
rqu”y
);

5440 
·r£_uri_compÚ’t
(&
p
, 
’d
, "", &
räagm’t
);

5445 ià(
	gscheme
 !ğ0è*
scheme
 = 
rscheme
;

5446 ià(
	gu£r_šfo
 !ğ0è*
u£r_šfo
 = 
ru£r_šfo
;

5447 ià(
	gho¡
 !ğ0è*
ho¡
 = 
rho¡
;

5448 ià(
	gpÜt
 !ğ0è*
pÜt
 = 
½Üt
;

5449 ià(
	g·th
 !ğ0è*
·th
 = 
½©h
;

5450 ià(
	gqu”y
 !ğ0è*
qu”y
 = 
rqu”y
;

5451 ià(
	gäagm’t
 !ğ0è*
äagm’t
 = 
räagm’t
;

5457 
mg_nÜm®ize_uri_·th
(cÚ¡ 
mg_¡r
 *
š
, mg_¡¸*
out
) {

5458 cÚ¡ *
	gs
 = 
š
->
p
, *
	g£
 = 
s
 + in->
Ën
;

5459 *
	gı
 = (*è
out
->
p
, *
	gd
;

5461 ià(
	gš
->
	gËn
 =ğ0 || *
s
 != '/') {

5462 
out
->
Ën
 = 0;

5466 
	gd
 = 
ı
;

5468 
	gs
 < 
	g£
) {

5469 cÚ¡ *
	gÃxt
 = 
s
;

5470 
mg_¡r
 
	gcompÚ’t
;

5471 
·r£_uri_compÚ’t
(&
Ãxt
, 
£
, "/", &
compÚ’t
);

5472 ià(
mg_vcmp
(&
compÚ’t
, ".") == 0) {

5474 } ià(
mg_vcmp
(&
compÚ’t
, "..") == 0) {

5476 ià(
d
 > 
ı
 + 1 && *(d - 1) == '/') d--;

5477 
	gd
 > 
	gı
 && *(d - 1è!ğ'/'è
d
--;

5479 
memmove
(
d
, 
s
, 
Ãxt
 - s);

5480 
	gd
 +ğ
Ãxt
 - 
s
;

5482 
	gs
 = 
Ãxt
;

5484 ià(
	gd
 =ğ
ı
è*
d
++ = '/';

5486 
	gout
->
	gp
 = 
ı
;

5487 
	gout
->
	gËn
 = 
d
 - 
ı
;

5491 
mg_as£mbË_uri
(cÚ¡ 
mg_¡r
 *
scheme
, cÚ¡ mg_¡¸*
u£r_šfo
,

5492 cÚ¡ 
mg_¡r
 *
ho¡
, 
pÜt
,

5493 cÚ¡ 
mg_¡r
 *
·th
, cÚ¡ mg_¡¸*
qu”y
,

5494 cÚ¡ 
mg_¡r
 *
äagm’t
, 
nÜm®ize_·th
,

5495 
mg_¡r
 *
uri
) {

5496 
	g»suÉ
 = -1;

5497 
mbuf
 
	gout
;

5498 
mbuf_š™
(&
out
, 0);

5500 ià(
	gscheme
 !ğ
NULL
 && 
scheme
->
Ën
 > 0) {

5501 
mbuf_­³nd
(&
out
, 
scheme
->
p
, scheme->
Ën
);

5502 
mbuf_­³nd
(&
out
, "://", 3);

5505 ià(
	gu£r_šfo
 !ğ
NULL
 && 
u£r_šfo
->
Ën
 > 0) {

5506 
mbuf_­³nd
(&
out
, 
u£r_šfo
->
p
, u£r_šfo->
Ën
);

5507 
mbuf_­³nd
(&
out
, "@", 1);

5510 ià(
	gho¡
 !ğ
NULL
 && 
ho¡
->
Ën
 > 0) {

5511 
mbuf_­³nd
(&
out
, 
ho¡
->
p
, ho¡->
Ën
);

5514 ià(
	gpÜt
 != 0) {

5515 
pÜt_¡r
[20];

5516 
	gpÜt_¡r_Ën
 = 
¥rštf
(
pÜt_¡r
, ":%u", 
pÜt
);

5517 
mbuf_­³nd
(&
out
, 
pÜt_¡r
, 
pÜt_¡r_Ën
);

5520 ià(
	g·th
 !ğ
NULL
 && 
·th
->
Ën
 > 0) {

5521 ià(
nÜm®ize_·th
) {

5522 
mg_¡r
 
Å©h
 = 
mg_¡rdup
(*
·th
);

5523 ià(
	gÅ©h
.
	gËn
 !ğ
·th
->
Ën
è
out
;

5524 ià(!
mg_nÜm®ize_uri_·th
(
·th
, &
Å©h
)) {

5525 
ä“
((*è
Å©h
.
p
);

5526 
	gout
;

5528 
mbuf_­³nd
(&
out
, 
Å©h
.
p
,‚·th.
Ën
);

5529 
ä“
((*è
Å©h
.
p
);

5531 
mbuf_­³nd
(&
out
, 
·th
->
p
,…©h->
Ën
);

5533 } ià(
	gnÜm®ize_·th
) {

5534 
mbuf_­³nd
(&
out
, "/", 1);

5537 ià(
	gqu”y
 !ğ
NULL
 && 
qu”y
->
Ën
 > 0) {

5538 
mbuf_­³nd
(&
out
, "?", 1);

5539 
mbuf_­³nd
(&
out
, 
qu”y
->
p
, qu”y->
Ën
);

5542 ià(
	gäagm’t
 !ğ
NULL
 && 
äagm’t
->
Ën
 > 0) {

5543 
mbuf_­³nd
(&
out
, "#", 1);

5544 
mbuf_­³nd
(&
out
, 
äagm’t
->
p
, f¿gm’t->
Ën
);

5547 
	g»suÉ
 = 0;

5549 
	gout
:

5550 ià(
»suÉ
 == 0) {

5551 
uri
->
p
 = 
out
.
buf
;

5552 
	guri
->
	gËn
 = 
out
.
Ën
;

5554 
mbuf_ä“
(&
out
);

5555 
	guri
->
	gp
 = 
NULL
;

5556 
	guri
->
	gËn
 = 0;

5558  
	g»suÉ
;

5560 #ifdeà
MG_MODULE_LINES


5568 #ià
MG_ENABLE_HTTP


5574 cÚ¡ *
	gmg_v”siÚ_h—d”
 = "MÚgoo£/" 
MG_VERSION
;

5576 
	emg_h‰p_´Ùo_d©a_ty³
 { 
	gDATA_NONE
, 
	gDATA_FILE
, 
	gDATA_PUT
 };

5578 
	smg_h‰p_´Ùo_d©a_fe
 {

5579 
FILE
 *
	gå
;

5580 
št64_t
 
	gş
;

5581 
št64_t
 
	g£Á
;

5582 
	gk“·live
;

5583 
mg_h‰p_´Ùo_d©a_ty³
 
	gty³
;

5586 #ià
MG_ENABLE_HTTP_CGI


5587 
	smg_h‰p_´Ùo_d©a_cgi
 {

5588 
mg_cÚÃùiÚ
 *
	gcgi_nc
;

5592 
	smg_h‰p_´Ùo_d©a_chuncked
 {

5593 
št64_t
 
	gbody_Ën
;

5596 
	smg_h‰p_’dpošt
 {

5597 
mg_h‰p_’dpošt
 *
	gÃxt
;

5598 
mg_¡r
 
	guri_·‰”n
;

5599 *
	gauth_domaš
;

5600 *
	gauth_fe
;

5602 
mg_ev’t_hªdËr_t
 
	ghªdËr
;

5603 #ià
MG_ENABLE_CALLBACK_USERDATA


5604 *
	gu£r_d©a
;

5608 
	emg_h‰p_muÉ¬t_¡»am_¡©e
 {

5609 
	gMPS_BEGIN
,

5610 
	gMPS_WAITING_FOR_BOUNDARY
,

5611 
	gMPS_WAITING_FOR_CHUNK
,

5612 
	gMPS_GOT_CHUNK
,

5613 
	gMPS_GOT_BOUNDARY
,

5614 
	gMPS_FINALIZE
,

5615 
	gMPS_FINISHED


5618 
	smg_h‰p_muÉ¬t_¡»am
 {

5619 cÚ¡ *
	gbound¬y
;

5620 
	gbound¬y_Ën
;

5621 cÚ¡ *
	gv¬_Çme
;

5622 cÚ¡ *
	gfe_Çme
;

5623 *
	gu£r_d©a
;

5624 
	g´ev_io_Ën
;

5625 
mg_h‰p_muÉ¬t_¡»am_¡©e
 
	g¡©e
;

5626 
	g´oûssšg_·¹
;

5629 
	smg_»v”£_´oxy_d©a
 {

5630 
mg_cÚÃùiÚ
 *
	glšked_cÚn
;

5633 
	smg_ws_´Ùo_d©a
 {

5634 
size_t
 
	g»ass_Ën
;

5637 
	smg_h‰p_´Ùo_d©a
 {

5638 #ià
MG_ENABLE_FILESYSTEM


5639 
mg_h‰p_´Ùo_d©a_fe
 
	gfe
;

5641 #ià
MG_ENABLE_HTTP_CGI


5642 
mg_h‰p_´Ùo_d©a_cgi
 
	gcgi
;

5644 #ià
MG_ENABLE_HTTP_STREAMING_MULTIPART


5645 
mg_h‰p_muÉ¬t_¡»am
 
	gmp_¡»am
;

5647 #ià
MG_ENABLE_HTTP_WEBSOCKET


5648 
mg_ws_´Ùo_d©a
 
	gws_d©a
;

5650 
mg_h‰p_´Ùo_d©a_chuncked
 
	gchunk
;

5651 
mg_h‰p_’dpošt
 *
	g’dpošts
;

5652 
mg_ev’t_hªdËr_t
 
	g’dpošt_hªdËr
;

5653 
mg_»v”£_´oxy_d©a
 
	g»v”£_´oxy_d©a
;

5654 
size_t
 
	grcvd
;

5657 
mg_h‰p_cÚn_de¡ruùÜ
(*
´Ùo_d©a
);

5658 
mg_cÚÃùiÚ
 *
mg_cÚÃù_h‰p_ba£
(

5659 
mg_mgr
 *
mgr
, 
MG_CB
(
mg_ev’t_hªdËr_t
 
ev_hªdËr
, *
u£r_d©a
),

5660 
mg_cÚÃù_İts
 
İts
, cÚ¡ *
scheme1
, cÚ¡ *
scheme2
,

5661 cÚ¡ *
scheme_s¦1
, cÚ¡ *
scheme_s¦2
, cÚ¡ *
u¾
,

5662 
mg_¡r
 *
·th
, mg_¡¸*
u£r_šfo
, mg_¡¸*
ho¡
);

5664 
mg_h‰p_´Ùo_d©a
 *
mg_h‰p_g‘_´Ùo_d©a
(

5665 
mg_cÚÃùiÚ
 *
c
) {

5666 ià(
	gc
->
	g´Ùo_d©a
 =ğ
NULL
) {

5667 
c
->
´Ùo_d©a
 = 
MG_CALLOC
(1, (
mg_h‰p_´Ùo_d©a
));

5668 
	gc
->
	g´Ùo_d©a_de¡ruùÜ
 = 
mg_h‰p_cÚn_de¡ruùÜ
;

5671  (
	gmg_h‰p_´Ùo_d©a
 *è
	gc
->
	g´Ùo_d©a
;

5674 #ià
MG_ENABLE_HTTP_STREAMING_MULTIPART


5675 
mg_h‰p_ä“_´Ùo_d©a_mp_¡»am
(

5676 
mg_h‰p_muÉ¬t_¡»am
 *
mp
) {

5677 
MG_FREE
((*è
mp
->
bound¬y
);

5678 
MG_FREE
((*è
mp
->
v¬_Çme
);

5679 
MG_FREE
((*è
mp
->
fe_Çme
);

5680 
mem£t
(
mp
, 0, (*mp));

5684 #ià
MG_ENABLE_FILESYSTEM


5685 
mg_h‰p_ä“_´Ùo_d©a_fe
(
mg_h‰p_´Ùo_d©a_fe
 *
d
) {

5686 ià(
	gd
 !ğ
NULL
) {

5687 ià(
d
->
å
 !ğ
NULL
) {

5688 
fşo£
(
d
->
å
);

5690 
mem£t
(
d
, 0, (
mg_h‰p_´Ùo_d©a_fe
));

5695 
mg_h‰p_ä“_´Ùo_d©a_’dpošts
(
mg_h‰p_’dpošt
 **
•
) {

5696 
mg_h‰p_’dpošt
 *
	gcu¼’t
 = *
•
;

5698 
	gcu¼’t
 !ğ
NULL
) {

5699 
mg_h‰p_’dpošt
 *
tmp
 = 
cu¼’t
->
Ãxt
;

5700 
MG_FREE
((*è
cu¼’t
->
uri_·‰”n
.
p
);

5701 
MG_FREE
((*è
cu¼’t
->
auth_domaš
);

5702 
MG_FREE
((*è
cu¼’t
->
auth_fe
);

5703 
MG_FREE
(
cu¼’t
);

5704 
	gcu¼’t
 = 
tmp
;

5707 
	g•
 = 
NULL
;

5710 
mg_h‰p_ä“_»v”£_´oxy_d©a
(
mg_»v”£_´oxy_d©a
 *
½d
) {

5711 ià(
	g½d
->
	glšked_cÚn
 !ğ
NULL
) {

5717 
mg_h‰p_´Ùo_d©a
 *
pd
 = 
mg_h‰p_g‘_´Ùo_d©a
(
½d
->
lšked_cÚn
);

5718 ià(
	gpd
->
	g»v”£_´oxy_d©a
.
	glšked_cÚn
 !ğ
NULL
) {

5719 
pd
->
»v”£_´oxy_d©a
.
lšked_cÚn
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

5720 
	gpd
->
	g»v”£_´oxy_d©a
.
	glšked_cÚn
 = 
NULL
;

5722 
	g½d
->
	glšked_cÚn
 = 
NULL
;

5726 
mg_h‰p_cÚn_de¡ruùÜ
(*
´Ùo_d©a
) {

5727 
mg_h‰p_´Ùo_d©a
 *
	gpd
 = (mg_h‰p_´Ùo_d©¨*è
´Ùo_d©a
;

5728 #ià
MG_ENABLE_FILESYSTEM


5729 
mg_h‰p_ä“_´Ùo_d©a_fe
(&
pd
->
fe
);

5731 #ià
MG_ENABLE_HTTP_CGI


5732 
mg_h‰p_ä“_´Ùo_d©a_cgi
(&
pd
->
cgi
);

5734 #ià
MG_ENABLE_HTTP_STREAMING_MULTIPART


5735 
mg_h‰p_ä“_´Ùo_d©a_mp_¡»am
(&
pd
->
mp_¡»am
);

5737 
mg_h‰p_ä“_´Ùo_d©a_’dpošts
(&
pd
->
’dpošts
);

5738 
mg_h‰p_ä“_»v”£_´oxy_d©a
(&
pd
->
»v”£_´oxy_d©a
);

5739 
MG_FREE
(
´Ùo_d©a
);

5742 #ià
MG_ENABLE_FILESYSTEM


5744 
	#MIME_ENTRY
(
_ext
, 
_ty³
) \

5745 { 
_ext
, (_extè- 1, 
_ty³
 }

	)

5747 cÚ¡ *
	gex‹nsiÚ
;

5748 
size_t
 
	gext_Ën
;

5749 cÚ¡ *
	gmime_ty³
;

5750 } 
	gmg_¡©ic_butš_mime_ty³s
[] = {

5751 
MIME_ENTRY
("html", "text/html"),

5752 
MIME_ENTRY
("html", "text/html"),

5753 
MIME_ENTRY
("htm", "text/html"),

5754 
MIME_ENTRY
("shtm", "text/html"),

5755 
MIME_ENTRY
("shtml", "text/html"),

5756 
MIME_ENTRY
("css", "text/css"),

5757 
MIME_ENTRY
("js", "application/x-javascript"),

5758 
MIME_ENTRY
("ico", "image/x-icon"),

5759 
MIME_ENTRY
("gif", "image/gif"),

5760 
MIME_ENTRY
("jpg", "image/jpeg"),

5761 
MIME_ENTRY
("jpeg", "image/jpeg"),

5762 
MIME_ENTRY
("png", "image/png"),

5763 
MIME_ENTRY
("svg", "image/svg+xml"),

5764 
MIME_ENTRY
("txt", "text/plain"),

5765 
MIME_ENTRY
("torrent", "application/x-bittorrent"),

5766 
MIME_ENTRY
("wav", "audio/x-wav"),

5767 
MIME_ENTRY
("mp3", "audio/x-mp3"),

5768 
MIME_ENTRY
("mid", "audio/mid"),

5769 
MIME_ENTRY
("m3u", "audio/x-mpegurl"),

5770 
MIME_ENTRY
("ogg", "application/ogg"),

5771 
MIME_ENTRY
("ram", "audio/x-pn-realaudio"),

5772 
MIME_ENTRY
("xml", "text/xml"),

5773 
MIME_ENTRY
("ttf", "application/x-font-ttf"),

5774 
MIME_ENTRY
("json", "application/json"),

5775 
MIME_ENTRY
("xslt", "application/xml"),

5776 
MIME_ENTRY
("xsl", "application/xml"),

5777 
MIME_ENTRY
("ra", "audio/x-pn-realaudio"),

5778 
MIME_ENTRY
("doc", "application/msword"),

5779 
MIME_ENTRY
("exe", "application/octet-stream"),

5780 
MIME_ENTRY
("zip", "application/x-zip-compressed"),

5781 
MIME_ENTRY
("xls", "application/excel"),

5782 
MIME_ENTRY
("tgz", "application/x-tar-gz"),

5783 
MIME_ENTRY
("tar", "application/x-tar"),

5784 
MIME_ENTRY
("gz", "application/x-gunzip"),

5785 
MIME_ENTRY
("arj", "application/x-arj-compressed"),

5786 
MIME_ENTRY
("rar", "application/x-rar-compressed"),

5787 
MIME_ENTRY
("rtf", "application/rtf"),

5788 
MIME_ENTRY
("pdf", "application/pdf"),

5789 
MIME_ENTRY
("swf", "application/x-shockwave-flash"),

5790 
MIME_ENTRY
("mpg", "video/mpeg"),

5791 
MIME_ENTRY
("webm", "video/webm"),

5792 
MIME_ENTRY
("mpeg", "video/mpeg"),

5793 
MIME_ENTRY
("mov", "video/quicktime"),

5794 
MIME_ENTRY
("mp4", "video/mp4"),

5795 
MIME_ENTRY
("m4v", "video/x-m4v"),

5796 
MIME_ENTRY
("asf", "video/x-ms-asf"),

5797 
MIME_ENTRY
("avi", "video/x-msvideo"),

5798 
MIME_ENTRY
("bmp", "image/bmp"),

5799 {
NULL
, 0, NULL}};

5801 
mg_¡r
 
mg_g‘_mime_ty³
(cÚ¡ *
·th
, cÚ¡ *
dæt
,

5802 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
) {

5803 cÚ¡ *
	gext
, *
	gov”rides
;

5804 
size_t
 
	gi
, 
	g·th_Ën
;

5805 
mg_¡r
 
	gr
, 
	gk
, 
	gv
;

5807 
	g·th_Ën
 = 
¡¾’
(
·th
);

5809 
	gov”rides
 = 
İts
->
cu¡om_mime_ty³s
;

5810 (
	gov”rides
 = 
mg_Ãxt_comma_li¡_’Œy
(
ov”rides
, &
k
, &
v
)è!ğ
NULL
) {

5811 
ext
 = 
·th
 + (
·th_Ën
 - 
k
.
Ën
);

5812 ià(
	g·th_Ën
 > 
	gk
.
	gËn
 && 
mg_vÿ£cmp
(&
k
, 
ext
) == 0) {

5813  
v
;

5817 
	gi
 = 0; 
	gmg_¡©ic_butš_mime_ty³s
[
i
].
	gex‹nsiÚ
 !ğ
NULL
; i++) {

5818 
	gext
 = 
·th
 + (
·th_Ën
 - 
mg_¡©ic_butš_mime_ty³s
[
i
].
ext_Ën
);

5819 ià(
	g·th_Ën
 > 
	gmg_¡©ic_butš_mime_ty³s
[
i
].
	gext_Ën
 && 
	gext
[-1] == '.' &&

5820 
mg_ÿ£cmp
(
ext
, 
mg_¡©ic_butš_mime_ty³s
[
i
].
ex‹nsiÚ
) == 0) {

5821 
r
.
p
 = 
mg_¡©ic_butš_mime_ty³s
[
i
].
mime_ty³
;

5822 
	gr
.
	gËn
 = 
¡¾’
(
r
.
p
);

5823  
	gr
;

5827 
	gr
.
	gp
 = 
dæt
;

5828 
	gr
.
	gËn
 = 
¡¾’
(
r
.
p
);

5829  
	gr
;

5839 
mg_h‰p_g‘_»que¡_Ën
(cÚ¡ *
s
, 
buf_Ën
) {

5840 cÚ¡ *
	gbuf
 = (*è
s
;

5841 
	gi
;

5843 
	gi
 = 0; i < 
	gbuf_Ën
; i++) {

5844 ià(!
i¥ršt
(
buf
[
i
]è&& 
	gbuf
[i] != '\r' && buf[i] != '\n' && buf[i] < 128) {

5846 } ià(
	gbuf
[
i
] =ğ'\n' && i + 1 < 
buf_Ën
 && 
buf
[i + 1] == '\n') {

5847  
i
 + 2;

5848 } ià(
	gbuf
[
i
] =ğ'\n' && i + 2 < 
buf_Ën
 && 
buf
[i + 1] == '\r' &&

5849 
buf
[
i
 + 2] == '\n') {

5850  
i
 + 3;

5857 cÚ¡ *
mg_h‰p_·r£_h—d”s
(cÚ¡ *
s
, cÚ¡ *
’d
,

5858 
Ën
, 
h‰p_mes§ge
 *
»q
) {

5859 
	gi
 = 0;

5860 
	gi
 < (è
ARRAY_SIZE
(
»q
->
h—d”_Çmes
) - 1) {

5861 
mg_¡r
 *
	gk
 = &
»q
->
h—d”_Çmes
[
i
], *
	gv
 = &»q->
h—d”_v®ues
[i];

5863 
	gs
 = 
mg_sk
(
s
, 
’d
, ": ", 
k
);

5864 
	gs
 = 
mg_sk
(
s
, 
’d
, "\r\n", 
v
);

5866 
	gv
->
	gËn
 > 0 && v->
	gp
[
v
->
Ën
 - 1] == ' ') {

5867 
v
->
Ën
--;

5875 ià(
	gk
->
	gËn
 !ğ0 && 
v
->
Ën
 == 0) {

5879 ià(
	gk
->
	gËn
 =ğ0 || 
v
->
Ën
 == 0) {

5880 
k
->
p
 = 
v
->°ğ
NULL
;

5881 
	gk
->
	gËn
 = 
v
->
Ën
 = 0;

5885 ià(!
mg_nÿ£cmp
(
k
->
p
, "Content-Length", 14)) {

5886 
	g»q
->
	gbody
.
	gËn
 = (
size_t
è
to64
(
v
->
p
);

5887 
	g»q
->
	gmes§ge
.
	gËn
 = 
Ën
 + 
»q
->
body
.len;

5890 
	gi
++;

5893  
	gs
;

5896 
mg_·r£_h‰p
(cÚ¡ *
s
, 
n
, 
h‰p_mes§ge
 *
hm
, 
is_»q
) {

5897 cÚ¡ *
	g’d
, *
	gqs
;

5898 
	gËn
 = 
mg_h‰p_g‘_»que¡_Ën
(
s
, 
n
);

5900 ià(
	gËn
 <ğ0è 
Ën
;

5902 
mem£t
(
hm
, 0, (*hm));

5903 
	ghm
->
	gmes§ge
.
	gp
 = 
s
;

5904 
	ghm
->
	gbody
.
	gp
 = 
s
 + 
Ën
;

5905 
	ghm
->
	gmes§ge
.
	gËn
 = 
hm
->
body
.
Ën
 = (
size_t
) ~0;

5906 
	g’d
 = 
s
 + 
Ën
;

5909 
	gs
 < 
	g’d
 && 
is¥aû
(*(*è
s
)) s++;

5911 ià(
	gis_»q
) {

5913 
	gs
 = 
mg_sk
(
s
, 
’d
, " ", &
hm
->
m‘hod
);

5914 
	gs
 = 
mg_sk
(
s
, 
’d
, " ", &
hm
->
uri
);

5915 
	gs
 = 
mg_sk
(
s
, 
’d
, "\r\n", &
hm
->
´Ùo
);

5916 ià(
	ghm
->
	guri
.
	gp
 <ğ
hm
->
m‘hod
.
p
 || hm->
´Ùo
.°<ğhm->
uri
.p)  -1;

5919 ià((
	gqs
 = (*è
memchr
(
hm
->
uri
.
p
, '?', hm->uri.
Ën
)è!ğ
NULL
) {

5920 
hm
->
qu”y_¡ršg
.
p
 = 
qs
 + 1;

5921 
	ghm
->
	gqu”y_¡ršg
.
	gËn
 = &
hm
->
uri
.
p
[hm->uri.
Ën
] - (
qs
 + 1);

5922 
	ghm
->
	guri
.
	gËn
 = 
qs
 - 
hm
->
uri
.
p
;

5925 
	gs
 = 
mg_sk
(
s
, 
’d
, " ", &
hm
->
´Ùo
);

5926 ià(
	g’d
 - 
	gs
 < 4 || s[3] != ' ')  -1;

5927 
	ghm
->
	g»¥_code
 = 
©oi
(
s
);

5928 ià(
	ghm
->
	g»¥_code
 < 100 || hm->resp_code >= 600)  -1;

5929 
	gs
 += 4;

5930 
	gs
 = 
mg_sk
(
s
, 
’d
, "\r\n", &
hm
->
»¥_¡©us_msg
);

5933 
	gs
 = 
mg_h‰p_·r£_h—d”s
(
s
, 
’d
, 
Ën
, 
hm
);

5950 ià(
	ghm
->
	gbody
.
	gËn
 =ğ(
size_t
è~0 && 
is_»q
 &&

5951 
mg_vÿ£cmp
(&
hm
->
m‘hod
, "PUT") != 0 &&

5952 
mg_vÿ£cmp
(&
hm
->
m‘hod
, "POST") != 0) {

5953 
hm
->
body
.
Ën
 = 0;

5954 
	ghm
->
	gmes§ge
.
	gËn
 = 
Ën
;

5957  
	gËn
;

5960 
mg_¡r
 *
mg_g‘_h‰p_h—d”
(
h‰p_mes§ge
 *
hm
, cÚ¡ *
Çme
) {

5961 
size_t
 
	gi
, 
	gËn
 = 
¡¾’
(
Çme
);

5963 
	gi
 = 0; 
	ghm
->
	gh—d”_Çmes
[
i
].
	gËn
 > 0; i++) {

5964 
mg_¡r
 *
	gh
 = &
hm
->
h—d”_Çmes
[
i
], *
	gv
 = &hm->
h—d”_v®ues
[i];

5965 ià(
	gh
->
	gp
 !ğ
NULL
 && 
h
->
Ën
 =ğËÀ&& !
mg_nÿ£cmp
(h->
p
, 
Çme
,†en))

5966  
	gv
;

5969  
	gNULL
;

5972 #ià
MG_ENABLE_FILESYSTEM


5973 
mg_h‰p_Œªsãr_fe_d©a
(
mg_cÚÃùiÚ
 *
nc
) {

5974 
mg_h‰p_´Ùo_d©a
 *
	gpd
 = 
mg_h‰p_g‘_´Ùo_d©a
(
nc
);

5975 
	gbuf
[
MG_MAX_HTTP_SEND_MBUF
];

5976 
size_t
 
	gn
 = 0, 
	gto_»ad
 = 0, 
	gËá
 = (size_t)(
pd
->
fe
.
ş
 -…d->fe.
£Á
);

5978 ià(
	gpd
->
	gfe
.
	gty³
 =ğ
DATA_FILE
) {

5979 
mbuf
 *
io
 = &
nc
->
£nd_mbuf
;

5980 ià(
	gio
->
	gËn
 >ğ
MG_MAX_HTTP_SEND_MBUF
) {

5981 
to_»ad
 = 0;

5983 
	gto_»ad
 = 
MG_MAX_HTTP_SEND_MBUF
 - 
io
->
Ën
;

5985 ià(
	gto_»ad
 > 
	gËá
) {

5986 
	gto_»ad
 = 
Ëá
;

5988 ià(
	gto_»ad
 > 0) {

5989 
	gn
 = 
mg_ä—d
(
buf
, 1, 
to_»ad
, 
pd
->
fe
.
å
);

5990 ià(
	gn
 > 0) {

5991 
mg_£nd
(
nc
, 
buf
, 
n
);

5992 
	gpd
->
	gfe
.
	g£Á
 +ğ
n
;

5993 
DBG
(("%°£Á %d (tÙ® %d)", 
nc
, (è
n
, (è
pd
->
fe
.
£Á
));

5998 ià(
	gpd
->
	gfe
.
	g£Á
 >ğ
pd
->
fe
.
ş
) {

5999 
LOG
(
LL_DEBUG
, ("%°dÚe, %d by‹s", 
nc
, (è
pd
->
fe
.
£Á
));

6000 ià(!
	gpd
->
	gfe
.
	gk“·live
è
	gnc
->
	gæags
 |ğ
MG_F_SEND_AND_CLOSE
;

6001 
mg_h‰p_ä“_´Ùo_d©a_fe
(&
pd
->
fe
);

6003 } ià(
	gpd
->
	gfe
.
	gty³
 =ğ
DATA_PUT
) {

6004 
mbuf
 *
io
 = &
nc
->
»cv_mbuf
;

6005 
size_t
 
	gto_wr™e
 = 
Ëá
 <ğ0 ? 0 :†eá < 
io
->
Ën
 ? (size_t)†eft : io->len;

6006 
size_t
 
	gn
 = 
mg_fwr™e
(
io
->
buf
, 1, 
to_wr™e
, 
pd
->
fe
.
å
);

6007 ià(
	gn
 > 0) {

6008 
mbuf_»move
(
io
, 
n
);

6009 
	gpd
->
	gfe
.
	g£Á
 +ğ
n
;

6011 ià(
	gn
 =ğ0 || 
pd
->
fe
.
£Á
 >ğpd->fe.
ş
) {

6012 ià(!
pd
->
fe
.
k“·live
è
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

6013 
mg_h‰p_ä“_´Ùo_d©a_fe
(&
pd
->
fe
);

6016 #ià
MG_ENABLE_HTTP_CGI


6017 ià(
	gpd
->
	gcgi
.
	gcgi_nc
 !ğ
NULL
) {

6019 ià(
pd
->
cgi
.
cgi_nc
 !ğ
NULL
) {

6020 
mg_fÜw¬d
(
nc
, 
pd
->
cgi
.
cgi_nc
);

6022 
	gnc
->
	gæags
 |ğ
MG_F_SEND_AND_CLOSE
;

6034 
size_t
 
mg_h‰p_·r£_chunk
(*
buf
, size_ˆ
Ën
, **
chunk_d©a
,

6035 
size_t
 *
chunk_Ën
) {

6036 *
	gs
 = (*è
buf
;

6037 
size_t
 
	gn
 = 0;

6038 
size_t
 
	gi
 = 0;

6041 
	gi
 < 
	gËn
 && 
isxdig™
(
s
[
i
])) {

6042 
	gn
 *= 16;

6043 
	gn
 +ğ(
s
[
i
] >ğ'0' && s[i] <ğ'9'è? s[i] - '0' : 
tŞow”
(s[i]) - 'a' + 10;

6044 
	gi
++;

6048 ià(
	gi
 =ğ0 || 
i
 + 2 > 
Ën
 || 
s
[i] != '\r' || s[i + 1] != '\n') {

6051 
	gi
 += 2;

6054 *
	gchunk_d©a
 = (*è
s
 + 
i
;

6055 *
	gchunk_Ën
 = 
n
;

6058 
	gi
 +ğ
n
;

6061 ià(
	gi
 =ğ0 || 
i
 + 2 > 
Ën
 || 
s
[i] != '\r' || s[i + 1] != '\n') {

6064  
	gi
 + 2;

6067 
MG_INTERNAL
 
size_t
 
mg_hªdË_chunked
(
mg_cÚÃùiÚ
 *
nc
,

6068 
h‰p_mes§ge
 *
hm
, *
buf
,

6069 
size_t
 
bËn
) {

6070 
mg_h‰p_´Ùo_d©a
 *
	gpd
 = 
mg_h‰p_g‘_´Ùo_d©a
(
nc
);

6071 *
	gd©a
;

6072 
size_t
 
	gi
, 
	gn
, 
	gd©a_Ën
, 
	gbody_Ën
, 
	gz”o_chunk_»ûived
 = 0;

6074 
	gbody_Ën
 = (
size_t
è
pd
->
chunk
.
body_Ën
;

6075 
as£¹
(
bËn
 >ğ
body_Ën
);

6078 
	gi
 = 
body_Ën
;

6079 (
	gn
 = 
mg_h‰p_·r£_chunk
(
buf
 + 
i
, 
bËn
 - i, &
d©a
, &
d©a_Ën
)) > 0;

6080 
	gi
 +ğ
n
) {

6082 
memmove
(
buf
 + 
body_Ën
, 
d©a
, 
d©a_Ën
);

6083 
	gbody_Ën
 +ğ
d©a_Ën
;

6084 
	ghm
->
	gbody
.
	gËn
 = 
body_Ën
;

6086 ià(
	gd©a_Ën
 == 0) {

6087 
z”o_chunk_»ûived
 = 1;

6088 
	gi
 +ğ
n
;

6093 ià(
	gi
 > 
	gbody_Ën
) {

6095 
as£¹
(
i
 <ğ
bËn
);

6096 
memmove
(
buf
 + 
body_Ën
, buà+ 
i
, 
bËn
 - i);

6097 
mem£t
(
buf
 + 
body_Ën
 + 
bËn
 - 
i
, 0, i - body_len);

6098 
	gnc
->
	g»cv_mbuf
.
	gËn
 -ğ
i
 - 
body_Ën
;

6099 
	gpd
->
	gchunk
.
	gbody_Ën
 = 
body_Ën
;

6102 
	gnc
->
	gæags
 &ğ~
MG_F_DELETE_CHUNK
;

6103 
mg_ÿÎ
(
nc
,‚c->
hªdËr
,‚c->
u£r_d©a
, 
MG_EV_HTTP_CHUNK
, 
hm
);

6106 ià(
	gnc
->
	gæags
 & 
	gMG_F_DELETE_CHUNK
) {

6107 
mem£t
(
buf
, 0, 
body_Ën
);

6108 
memmove
(
buf
, buà+ 
body_Ën
, 
bËn
 - 
i
);

6109 
	gnc
->
	g»cv_mbuf
.
	gËn
 -ğ
body_Ën
;

6110 
	ghm
->
	gbody
.
	gËn
 = 0;

6111 
	gpd
->
	gchunk
.
	gbody_Ën
 = 0;

6114 ià(
	gz”o_chunk_»ûived
) {

6116 
	ghm
->
	gmes§ge
.
	gËn
 =

6117 (
size_t
è
pd
->
chunk
.
body_Ën
 + 
bËn
 - 
i
 + (
hm
->
body
.
p
 - hm->
mes§ge
.p);

6121  
	gbody_Ën
;

6124 
mg_h‰p_’dpošt
 *
mg_h‰p_g‘_’dpošt_hªdËr
(
mg_cÚÃùiÚ
 *
nc
,

6125 
mg_¡r
 *
uri_·th
) {

6126 
mg_h‰p_´Ùo_d©a
 *
	gpd
;

6127 
mg_h‰p_’dpošt
 *
	g»t
 = 
NULL
;

6128 
	gm©ched
, 
	gm©ched_max
 = 0;

6129 
mg_h‰p_’dpošt
 *
	g•
;

6131 ià(
	gnc
 =ğ
NULL
) {

6132  
NULL
;

6135 
	gpd
 = 
mg_h‰p_g‘_´Ùo_d©a
(
nc
);

6137 
	g•
 = 
pd
->
’dpošts
;

6138 
	g•
 !ğ
NULL
) {

6139 ià((
m©ched
 = 
mg_m©ch_´efix_n
(
•
->
uri_·‰”n
, *
uri_·th
)) != -1) {

6140 ià(
m©ched
 > 
m©ched_max
) {

6142 
»t
 = 
•
;

6143 
	gm©ched_max
 = 
m©ched
;

6147 
	g•
 = 
•
->
Ãxt
;

6150  
	g»t
;

6153 #ià
MG_ENABLE_HTTP_STREAMING_MULTIPART


6154 
mg_h‰p_muÉ¬t_cÚtšue
(
mg_cÚÃùiÚ
 *
nc
);

6156 
mg_h‰p_muÉ¬t_begš
(
mg_cÚÃùiÚ
 *
nc
,

6157 
h‰p_mes§ge
 *
hm
, 
»q_Ën
);

6161 
mg_h‰p_ÿÎ_’dpošt_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
,

6162 
h‰p_mes§ge
 *
hm
);

6164 
d–iv”_chunk
(
mg_cÚÃùiÚ
 *
c
, 
h‰p_mes§ge
 *
hm
,

6165 
»q_Ën
) {

6167 
	ghm
->
	gbody
.
	gËn
 = 
c
->
»cv_mbuf
.
Ën
 - 
»q_Ën
;

6168 
	gc
->
	gæags
 &ğ~
MG_F_DELETE_CHUNK
;

6169 
mg_ÿÎ
(
c
, c->
hªdËr
, c->
u£r_d©a
, 
MG_EV_HTTP_CHUNK
, 
hm
);

6171 ià(
	gc
->
	gæags
 & 
	gMG_F_DELETE_CHUNK
èc->
	g»cv_mbuf
.
	gËn
 = 
»q_Ën
;

6179 #ifdeà
__x‹n§__


6180 
mg_h‰p_hªdËr2
(
mg_cÚÃùiÚ
 *
nc
, 
ev
,

6181 *
ev_d©a
 
MG_UD_ARG
(*
u£r_d©a
),

6182 
h‰p_mes§ge
 *
hm
è
__©Œibu‹__
((
nošlše
));

6184 
mg_h‰p_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
,

6185 *
ev_d©a
 
MG_UD_ARG
(*
u£r_d©a
)) {

6186 
h‰p_mes§ge
 
	ghm
;

6187 
mg_h‰p_hªdËr2
(
nc
, 
ev
, 
ev_d©a
 
MG_UD_ARG
(
u£r_d©a
), &
hm
);

6190 
mg_h‰p_hªdËr2
(
mg_cÚÃùiÚ
 *
nc
, 
ev
,

6191 *
ev_d©a
 
MG_UD_ARG
(*
u£r_d©a
),

6192 
h‰p_mes§ge
 *
hm
) {

6194 
mg_h‰p_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
,

6195 *
ev_d©a
 
MG_UD_ARG
(*
u£r_d©a
)) {

6196 
h‰p_mes§ge
 
	gshm
, *
	ghm
 = &
shm
;

6198 
mg_h‰p_´Ùo_d©a
 *
	gpd
 = 
mg_h‰p_g‘_´Ùo_d©a
(
nc
);

6199 
mbuf
 *
	gio
 = &
nc
->
»cv_mbuf
;

6200 
	g»q_Ën
;

6201 cÚ¡ 
	gis_»q
 = (
nc
->
li¡’”
 !ğ
NULL
);

6202 #ià
MG_ENABLE_HTTP_WEBSOCKET


6203 
mg_¡r
 *
	gvec
;

6205 ià(
	gev
 =ğ
MG_EV_CLOSE
) {

6206 #ià
MG_ENABLE_HTTP_CGI


6208 ià(
pd
->
cgi
.
cgi_nc
 !ğ
NULL
) {

6209 
pd
->
cgi
.
cgi_nc
->
u£r_d©a
 = 
NULL
;

6210 
	gpd
->
	gcgi
.
	gcgi_nc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

6213 #ià
MG_ENABLE_HTTP_STREAMING_MULTIPART


6214 ià(
	gpd
->
	gmp_¡»am
.
	gbound¬y
 !ğ
NULL
) {

6219 
mg_h‰p_muÉ¬t_·¹
 
mp
;

6220 
mem£t
(&
mp
, 0, (mp));

6221 
	gmp
.
	g¡©us
 = -1;

6222 
	gmp
.
	gv¬_Çme
 = 
pd
->
mp_¡»am
.
v¬_Çme
;

6223 
	gmp
.
	gfe_Çme
 = 
pd
->
mp_¡»am
.
fe_Çme
;

6224 
mg_ÿÎ
(
nc
, (
pd
->
’dpošt_hªdËr
 ?…d->’dpošt_hªdË¸:‚c->
hªdËr
),

6225 
nc
->
u£r_d©a
, 
MG_EV_HTTP_PART_END
, &
mp
);

6226 
	gmp
.
	gv¬_Çme
 = 
NULL
;

6227 
	gmp
.
	gfe_Çme
 = 
NULL
;

6228 
mg_ÿÎ
(
nc
, (
pd
->
’dpošt_hªdËr
 ?…d->’dpošt_hªdË¸:‚c->
hªdËr
),

6229 
nc
->
u£r_d©a
, 
MG_EV_HTTP_MULTIPART_REQUEST_END
, &
mp
);

6232 ià(
	gio
->
	gËn
 > 0 &&

6233 (
	g»q_Ën
 = 
mg_·r£_h‰p
(
io
->
buf
, io->
Ën
, 
hm
, 
is_»q
)) > 0) {

6238 
	gev2
 = 
is_»q
 ? 
MG_EV_HTTP_REQUEST
 : 
MG_EV_HTTP_REPLY
;

6239 
	ghm
->
	gmes§ge
.
	gËn
 = 
io
->
Ën
;

6240 
	ghm
->
	gbody
.
	gËn
 = 
io
->
buf
 + io->
Ën
 - 
hm
->
body
.
p
;

6241 
d–iv”_chunk
(
nc
, 
hm
, 
»q_Ën
);

6242 
mg_h‰p_ÿÎ_’dpošt_hªdËr
(
nc
, 
ev2
, 
hm
);

6244 
	gpd
->
	grcvd
 = 0;

6247 #ià
MG_ENABLE_FILESYSTEM


6248 ià(
	gpd
->
	gfe
.
	gå
 !ğ
NULL
) {

6249 
mg_h‰p_Œªsãr_fe_d©a
(
nc
);

6253 
mg_ÿÎ
(
nc
,‚c->
hªdËr
,‚c->
u£r_d©a
, 
ev
, 
ev_d©a
);

6255 ià(
	gev
 =ğ
MG_EV_RECV
) {

6256 
mg_¡r
 *
s
;

6257 
	gpd
->
	grcvd
 +ğ*(*è
ev_d©a
;

6259 #ià
MG_ENABLE_HTTP_STREAMING_MULTIPART


6260 ià(
	gpd
->
	gmp_¡»am
.
	gbound¬y
 !ğ
NULL
) {

6261 
mg_h‰p_muÉ¬t_cÚtšue
(
nc
);

6266 
	g»q_Ën
 = 
mg_·r£_h‰p
(
io
->
buf
, io->
Ën
, 
hm
, 
is_»q
);

6268 ià(
	g»q_Ën
 > 0 &&

6269 (
	gs
 = 
mg_g‘_h‰p_h—d”
(
hm
, "T¿nsãr-Encodšg")è!ğ
NULL
 &&

6270 
mg_vÿ£cmp
(
s
, "chunked") == 0) {

6271 
mg_hªdË_chunked
(
nc
, 
hm
, 
io
->
buf
 + 
»q_Ën
, io->
Ën
 -„eq_len);

6274 #ià
MG_ENABLE_HTTP_STREAMING_MULTIPART


6275 ià(
	g»q_Ën
 > 0 && (
	gs
 = 
mg_g‘_h‰p_h—d”
(
hm
, "CÚ‹Á-Ty³")è!ğ
NULL
 &&

6276 
s
->
Ën
 >ğ9 && 
¡ºcmp
(s->
p
, "multipart", 9) == 0) {

6277 
mg_h‰p_muÉ¬t_begš
(
nc
, 
hm
, 
»q_Ën
);

6278 
mg_h‰p_muÉ¬t_cÚtšue
(
nc
);

6284 ià((
	g»q_Ën
 < 0 ||

6285 (
	g»q_Ën
 =ğ0 && 
io
->
Ën
 >ğ
MG_MAX_HTTP_REQUEST_SIZE
))) {

6286 
DBG
(("invalid„equest"));

6287 
	gnc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

6288 } ià(
	g»q_Ën
 == 0) {

6291 #ià
MG_ENABLE_HTTP_WEBSOCKET


6292 ià(
nc
->
li¡’”
 =ğ
NULL
 &&

6293 
mg_g‘_h‰p_h—d”
(
hm
, "Sec-WebSocket-Accept")) {

6296 
mbuf_»move
(
io
, 
»q_Ën
);

6297 
	gnc
->
	g´Ùo_hªdËr
 = 
mg_ws_hªdËr
;

6298 
	gnc
->
	gæags
 |ğ
MG_F_IS_WEBSOCKET
;

6299 
mg_ÿÎ
(
nc
,‚c->
hªdËr
,‚c->
u£r_d©a
, 
MG_EV_WEBSOCKET_HANDSHAKE_DONE
,

6300 
NULL
);

6301 
mg_ws_hªdËr
(
nc
, 
MG_EV_RECV
, 
ev_d©a
 
MG_UD_ARG
(
u£r_d©a
));

6302 } ià(
	gnc
->
	gli¡’”
 !ğ
NULL
 &&

6303 (
vec
 = 
mg_g‘_h‰p_h—d”
(
hm
, "Sec-WebSock‘-Key")è!ğ
NULL
) {

6304 
mg_h‰p_’dpošt
 *
•
;

6307 
mbuf_»move
(
io
, 
»q_Ën
);

6308 
	gnc
->
	g´Ùo_hªdËr
 = 
mg_ws_hªdËr
;

6309 
	gnc
->
	gæags
 |ğ
MG_F_IS_WEBSOCKET
;

6316 
	g•
 = 
mg_h‰p_g‘_’dpošt_hªdËr
(
nc
->
li¡’”
, &
hm
->
uri
);

6317 ià(
	g•
 !ğ
NULL
) {

6318 
nc
->
hªdËr
 = 
•
->handler;

6319 #ià
MG_ENABLE_CALLBACK_USERDATA


6320 
	gnc
->
	gu£r_d©a
 = 
•
->
u£r_d©a
;

6325 
mg_ÿÎ
(
nc
,‚c->
hªdËr
,‚c->
u£r_d©a
, 
MG_EV_WEBSOCKET_HANDSHAKE_REQUEST
,

6326 
hm
);

6327 ià(!(
	gnc
->
	gæags
 & (
	gMG_F_CLOSE_IMMEDIATELY
 | 
	gMG_F_SEND_AND_CLOSE
))) {

6328 ià(
	gnc
->
	g£nd_mbuf
.
	gËn
 == 0) {

6329 
mg_ws_hªdshake
(
nc
, 
vec
, 
hm
);

6331 
mg_ÿÎ
(
nc
,‚c->
hªdËr
,‚c->
u£r_d©a
, 
MG_EV_WEBSOCKET_HANDSHAKE_DONE
,

6332 
NULL
);

6333 
mg_ws_hªdËr
(
nc
, 
MG_EV_RECV
, 
ev_d©a
 
MG_UD_ARG
(
u£r_d©a
));

6337 ià(
	ghm
->
	gmes§ge
.
	gËn
 > 
	gpd
->
	grcvd
) {

6339 
d–iv”_chunk
(
nc
, 
hm
, 
»q_Ën
);

6342 
	gŒigg”_ev
 = 
nc
->
li¡’”
 ? 
MG_EV_HTTP_REQUEST
 : 
MG_EV_HTTP_REPLY
;

6343 
	gaddr
[32];

6344 
mg_sock_addr_to_¡r
(&
nc
->
§
, 
addr
, (addr),

6345 
MG_SOCK_STRINGIFY_IP
 | 
MG_SOCK_STRINGIFY_PORT
);

6346 
DBG
(("%°% %.* %.*s", 
nc
, 
addr
, (è
hm
->
m‘hod
.
Ën
, hm->m‘hod.
p
,

6347 (è
hm
->
uri
.
Ën
, hm->uri.
p
));

6348 
d–iv”_chunk
(
nc
, 
hm
, 
»q_Ën
);

6350 
mg_h‰p_ÿÎ_’dpošt_hªdËr
(
nc
, 
Œigg”_ev
, 
hm
);

6351 
mbuf_»move
(
io
, 
hm
->
mes§ge
.
Ën
);

6352 
	gpd
->
	grcvd
 = 0;

6357 
size_t
 
mg_g‘_lše_Ën
(cÚ¡ *
buf
, size_ˆ
buf_Ën
) {

6358 
size_t
 
	gËn
 = 0;

6359 
	gËn
 < 
	gbuf_Ën
 && 
	gbuf
[
Ën
] != '\n')†en++;

6360  
	gËn
 =ğ
buf_Ën
 ? 0 : 
Ën
 + 1;

6363 #ià
MG_ENABLE_HTTP_STREAMING_MULTIPART


6364 
mg_h‰p_muÉ¬t_begš
(
mg_cÚÃùiÚ
 *
nc
,

6365 
h‰p_mes§ge
 *
hm
, 
»q_Ën
) {

6366 
mg_h‰p_´Ùo_d©a
 *
	gpd
 = 
mg_h‰p_g‘_´Ùo_d©a
(
nc
);

6367 
mg_¡r
 *
	gù
;

6368 
mbuf
 *
	gio
 = &
nc
->
»cv_mbuf
;

6370 
	gbound¬y
[100];

6371 
	gbound¬y_Ën
;

6373 
	gù
 = 
mg_g‘_h‰p_h—d”
(
hm
, "Content-Type");

6374 ià(
	gù
 =ğ
NULL
) {

6376 
ex™_mp
;

6380 ià(
	gù
->
	gËn
 < 9 || 
¡ºcmp
(
ù
->
p
, "multipart", 9) != 0) {

6381 
ex™_mp
;

6384 
	gbound¬y_Ën
 =

6385 
mg_h‰p_·r£_h—d”
(
ù
, "bound¬y", 
bound¬y
, (boundary));

6386 ià(
	gbound¬y_Ën
 == 0) {

6391 
nc
->
æags
 = 
MG_F_CLOSE_IMMEDIATELY
;

6392 
DBG
(("invalid„equest"));

6393 
	gex™_mp
;

6398 ià(
	gpd
->
	gmp_¡»am
.
	gbound¬y
 !ğ
NULL
) {

6403 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

6405 
mg_h‰p_’dpošt
 *
	g•
 = 
NULL
;

6406 
	gpd
->
	gmp_¡»am
.
	g¡©e
 = 
MPS_BEGIN
;

6407 
	gpd
->
	gmp_¡»am
.
	gbound¬y
 = 
¡rdup
(
bound¬y
);

6408 
	gpd
->
	gmp_¡»am
.
	gbound¬y_Ën
 = 
¡¾’
(
bound¬y
);

6409 
	gpd
->
	gmp_¡»am
.
	gv¬_Çme
 = 
pd
->
mp_¡»am
.
fe_Çme
 = 
NULL
;

6410 
	gpd
->
	g’dpošt_hªdËr
 = 
nc
->
hªdËr
;

6412 
	g•
 = 
mg_h‰p_g‘_’dpošt_hªdËr
(
nc
->
li¡’”
, &
hm
->
uri
);

6413 ià(
	g•
 !ğ
NULL
) {

6414 
pd
->
’dpošt_hªdËr
 = 
•
->
hªdËr
;

6417 
mg_h‰p_ÿÎ_’dpošt_hªdËr
(
nc
, 
MG_EV_HTTP_MULTIPART_REQUEST
, 
hm
);

6419 
mbuf_»move
(
io
, 
»q_Ën
);

6421 
	gex™_mp
:

6425 
	#CONTENT_DISPOSITION
 "CÚ‹Á-Di¥os™iÚ: "

	)

6427 
mg_h‰p_muÉ¬t_ÿÎ_hªdËr
(
mg_cÚÃùiÚ
 *
c
, 
ev
,

6428 cÚ¡ *
d©a
, 
size_t
 
d©a_Ën
) {

6429 
mg_h‰p_muÉ¬t_·¹
 
	gmp
;

6430 
mg_h‰p_´Ùo_d©a
 *
	gpd
 = 
mg_h‰p_g‘_´Ùo_d©a
(
c
);

6431 
mem£t
(&
mp
, 0, (mp));

6433 
	gmp
.
	gv¬_Çme
 = 
pd
->
mp_¡»am
.
v¬_Çme
;

6434 
	gmp
.
	gfe_Çme
 = 
pd
->
mp_¡»am
.
fe_Çme
;

6435 
	gmp
.
	gu£r_d©a
 = 
pd
->
mp_¡»am
.
u£r_d©a
;

6436 
	gmp
.
	gd©a
.
	gp
 = 
d©a
;

6437 
	gmp
.
	gd©a
.
	gËn
 = 
d©a_Ën
;

6438 
mg_ÿÎ
(
c
, 
pd
->
’dpošt_hªdËr
, c->
u£r_d©a
, 
ev
, &
mp
);

6439 
	gpd
->
	gmp_¡»am
.
	gu£r_d©a
 = 
mp
.
u£r_d©a
;

6442 
mg_h‰p_muÉ¬t_gÙ_chunk
(
mg_cÚÃùiÚ
 *
c
) {

6443 
mg_h‰p_´Ùo_d©a
 *
	gpd
 = 
mg_h‰p_g‘_´Ùo_d©a
(
c
);

6444 
mbuf
 *
	gio
 = &
c
->
»cv_mbuf
;

6446 
mg_h‰p_muÉ¬t_ÿÎ_hªdËr
(
c
, 
MG_EV_HTTP_PART_DATA
, 
io
->
buf
,

6447 
pd
->
mp_¡»am
.
´ev_io_Ën
);

6448 
mbuf_»move
(
io
, 
pd
->
mp_¡»am
.
´ev_io_Ën
);

6449 
	gpd
->
	gmp_¡»am
.
	g´ev_io_Ën
 = 0;

6450 
	gpd
->
	gmp_¡»am
.
	g¡©e
 = 
MPS_WAITING_FOR_CHUNK
;

6455 
mg_h‰p_muÉ¬t_fš®ize
(
mg_cÚÃùiÚ
 *
c
) {

6456 
mg_h‰p_´Ùo_d©a
 *
	gpd
 = 
mg_h‰p_g‘_´Ùo_d©a
(
c
);

6458 
mg_h‰p_muÉ¬t_ÿÎ_hªdËr
(
c
, 
MG_EV_HTTP_PART_END
, 
NULL
, 0);

6459 
MG_FREE
((*è
pd
->
mp_¡»am
.
fe_Çme
);

6460 
	gpd
->
	gmp_¡»am
.
	gfe_Çme
 = 
NULL
;

6461 
MG_FREE
((*è
pd
->
mp_¡»am
.
v¬_Çme
);

6462 
	gpd
->
	gmp_¡»am
.
	gv¬_Çme
 = 
NULL
;

6463 
mg_h‰p_muÉ¬t_ÿÎ_hªdËr
(
c
, 
MG_EV_HTTP_MULTIPART_REQUEST_END
, 
NULL
, 0);

6464 
mg_h‰p_ä“_´Ùo_d©a_mp_¡»am
(&
pd
->
mp_¡»am
);

6465 
	gpd
->
	gmp_¡»am
.
	g¡©e
 = 
MPS_FINISHED
;

6470 
mg_h‰p_muÉ¬t_wa™_fÜ_bound¬y
(
mg_cÚÃùiÚ
 *
c
) {

6471 cÚ¡ *
	gbound¬y
;

6472 
mbuf
 *
	gio
 = &
c
->
»cv_mbuf
;

6473 
mg_h‰p_´Ùo_d©a
 *
	gpd
 = 
mg_h‰p_g‘_´Ùo_d©a
(
c
);

6475 ià(
	gpd
->
	gmp_¡»am
.
	gbound¬y
 =ğ
NULL
) {

6476 
pd
->
mp_¡»am
.
¡©e
 = 
MPS_FINALIZE
;

6477 
DBG
(("Invalid„equest: boundary‚ot initialized"));

6481 ià((è
	gio
->
	gËn
 < 
	gpd
->
	gmp_¡»am
.
	gbound¬y_Ën
 + 2) {

6485 
	gbound¬y
 = 
c_¡º¡r
(
io
->
buf
, 
pd
->
mp_¡»am
.
bound¬y
, io->
Ën
);

6486 ià(
	gbound¬y
 !ğ
NULL
) {

6487 cÚ¡ *
bound¬y_’d
 = (
bound¬y
 + 
pd
->
mp_¡»am
.
bound¬y_Ën
);

6488 ià(
	gio
->
	gËn
 - (
	gbound¬y_’d
 - io->
	gbuf
) < 4) {

6491 ià(
¡ºcmp
(
bound¬y_’d
, "--\r\n", 4) == 0) {

6492 
pd
->
mp_¡»am
.
¡©e
 = 
MPS_FINALIZE
;

6493 
mbuf_»move
(
io
, (
bound¬y_’d
 - io->
buf
) + 4);

6495 
	gpd
->
	gmp_¡»am
.
	g¡©e
 = 
MPS_GOT_BOUNDARY
;

6504 
mg_h‰p_muÉ¬t_´oûss_bound¬y
(
mg_cÚÃùiÚ
 *
c
) {

6505 
	gd©a_size
;

6506 cÚ¡ *
	gbound¬y
, *
	gblock_begš
;

6507 
mbuf
 *
	gio
 = &
c
->
»cv_mbuf
;

6508 
mg_h‰p_´Ùo_d©a
 *
	gpd
 = 
mg_h‰p_g‘_´Ùo_d©a
(
c
);

6509 
	gfe_Çme
[100], 
	gv¬_Çme
[100];

6510 
	glše_Ën
;

6511 
	gbound¬y
 = 
c_¡º¡r
(
io
->
buf
, 
pd
->
mp_¡»am
.
bound¬y
, io->
Ën
);

6512 
	gblock_begš
 = 
bound¬y
 + 
pd
->
mp_¡»am
.
bound¬y_Ën
 + 2;

6513 
	gd©a_size
 = 
io
->
Ën
 - (
block_begš
 - io->
buf
);

6515 
	gd©a_size
 > 0 &&

6516 (
	glše_Ën
 = 
mg_g‘_lše_Ën
(
block_begš
, 
d©a_size
)) != 0) {

6517 ià(
lše_Ën
 > (è(
CONTENT_DISPOSITION
) &&

6518 
mg_nÿ£cmp
(
block_begš
, 
CONTENT_DISPOSITION
,

6519 (
CONTENT_DISPOSITION
) - 1) == 0) {

6520 
mg_¡r
 
h—d”
;

6522 
	gh—d”
.
	gp
 = 
block_begš
 + (
CONTENT_DISPOSITION
) - 1;

6523 
	gh—d”
.
	gËn
 = 
lše_Ën
 - (
CONTENT_DISPOSITION
) - 1;

6524 
mg_h‰p_·r£_h—d”
(&
h—d”
, "Çme", 
v¬_Çme
, (var_name) - 2);

6525 
mg_h‰p_·r£_h—d”
(&
h—d”
, "f’ame", 
fe_Çme
,

6526 (
fe_Çme
) - 2);

6527 
	gblock_begš
 +ğ
lše_Ën
;

6528 
	gd©a_size
 -ğ
lše_Ën
;

6532 ià(
	glše_Ën
 =ğ2 && 
mg_nÿ£cmp
(
block_begš
, "\r\n", 2) == 0) {

6533 
mbuf_»move
(
io
, 
block_begš
 - io->
buf
 + 2);

6535 ià(
	gpd
->
	gmp_¡»am
.
	g´oûssšg_·¹
 != 0) {

6536 
mg_h‰p_muÉ¬t_ÿÎ_hªdËr
(
c
, 
MG_EV_HTTP_PART_END
, 
NULL
, 0);

6539 
MG_FREE
((*è
pd
->
mp_¡»am
.
fe_Çme
);

6540 
	gpd
->
	gmp_¡»am
.
	gfe_Çme
 = 
¡rdup
(
fe_Çme
);

6541 
MG_FREE
((*è
pd
->
mp_¡»am
.
v¬_Çme
);

6542 
	gpd
->
	gmp_¡»am
.
	gv¬_Çme
 = 
¡rdup
(
v¬_Çme
);

6544 
mg_h‰p_muÉ¬t_ÿÎ_hªdËr
(
c
, 
MG_EV_HTTP_PART_BEGIN
, 
NULL
, 0);

6545 
	gpd
->
	gmp_¡»am
.
	g¡©e
 = 
MPS_WAITING_FOR_CHUNK
;

6546 
	gpd
->
	gmp_¡»am
.
	g´oûssšg_·¹
++;

6550 
	gblock_begš
 +ğ
lše_Ën
;

6553 
	gpd
->
	gmp_¡»am
.
	g¡©e
 = 
MPS_WAITING_FOR_BOUNDARY
;

6558 
mg_h‰p_muÉ¬t_cÚtšue_wa™_fÜ_chunk
(
mg_cÚÃùiÚ
 *
c
) {

6559 
mg_h‰p_´Ùo_d©a
 *
	gpd
 = 
mg_h‰p_g‘_´Ùo_d©a
(
c
);

6560 
mbuf
 *
	gio
 = &
c
->
»cv_mbuf
;

6562 cÚ¡ *
	gbound¬y
;

6563 ià((è
	gio
->
	gËn
 < 
	gpd
->
	gmp_¡»am
.
	gbound¬y_Ën
 + 6 ) {

6567 
	gbound¬y
 = 
c_¡º¡r
(
io
->
buf
, 
pd
->
mp_¡»am
.
bound¬y
, io->
Ën
);

6568 ià(
	gbound¬y
 =ğ
NULL
 && 
pd
->
mp_¡»am
.
´ev_io_Ën
 == 0) {

6569 
pd
->
mp_¡»am
.
´ev_io_Ën
 = 
io
->
Ën
;

6571 } ià(
	gbound¬y
 =ğ
NULL
 &&

6572 (è
io
->
Ën
 >

6573 
pd
->
mp_¡»am
.
´ev_io_Ën
 +…d->mp_¡»am.
bound¬y_Ën
 + 4) {

6574 
pd
->
mp_¡»am
.
¡©e
 = 
MPS_GOT_CHUNK
;

6576 } ià(
	gbound¬y
 !ğ
NULL
) {

6577 
d©a_size
 = (
bound¬y
 - 
io
->
buf
 - 4);

6578 
mg_h‰p_muÉ¬t_ÿÎ_hªdËr
(
c
, 
MG_EV_HTTP_PART_DATA
, 
io
->
buf
, 
d©a_size
);

6579 
mbuf_»move
(
io
, (
bound¬y
 - io->
buf
));

6580 
	gpd
->
	gmp_¡»am
.
	g´ev_io_Ën
 = 0;

6581 
	gpd
->
	gmp_¡»am
.
	g¡©e
 = 
MPS_WAITING_FOR_BOUNDARY
;

6588 
mg_h‰p_muÉ¬t_cÚtšue
(
mg_cÚÃùiÚ
 *
c
) {

6589 
mg_h‰p_´Ùo_d©a
 *
	gpd
 = 
mg_h‰p_g‘_´Ùo_d©a
(
c
);

6591 
	gpd
->
	gmp_¡»am
.
	g¡©e
) {

6592 
	gMPS_BEGIN
: {

6593 
pd
->
mp_¡»am
.
¡©e
 = 
MPS_WAITING_FOR_BOUNDARY
;

6596 
	gMPS_WAITING_FOR_BOUNDARY
: {

6597 ià(
mg_h‰p_muÉ¬t_wa™_fÜ_bound¬y
(
c
) == 0) {

6602 
	gMPS_GOT_BOUNDARY
: {

6603 ià(
mg_h‰p_muÉ¬t_´oûss_bound¬y
(
c
) == 0) {

6608 
	gMPS_WAITING_FOR_CHUNK
: {

6609 ià(
mg_h‰p_muÉ¬t_cÚtšue_wa™_fÜ_chunk
(
c
) == 0) {

6614 
	gMPS_GOT_CHUNK
: {

6615 ià(
mg_h‰p_muÉ¬t_gÙ_chunk
(
c
) == 0) {

6620 
	gMPS_FINALIZE
: {

6621 ià(
mg_h‰p_muÉ¬t_fš®ize
(
c
) == 0) {

6626 
	gMPS_FINISHED
: {

6627 
mbuf_»move
(&
c
->
»cv_mbuf
, c->»cv_mbuf.
Ën
);

6634 
	sfe_u¶ßd_¡©e
 {

6635 *
	glâ
;

6636 
size_t
 
	gnum_»cd
;

6637 
FILE
 *
	gå
;

6642 
mg_£t_´ÙocŞ_h‰p_websock‘
(
mg_cÚÃùiÚ
 *
nc
) {

6643 
	gnc
->
	g´Ùo_hªdËr
 = 
mg_h‰p_hªdËr
;

6646 cÚ¡ *
mg_¡©us_mes§ge
(
¡©us_code
) {

6647 
	g¡©us_code
) {

6673 #ià
MG_ENABLE_EXTRA_ERRORS_DESC


6777 
mg_£nd_»¥Ú£_lše_s
(
mg_cÚÃùiÚ
 *
nc
, 
¡©us_code
,

6778 cÚ¡ 
mg_¡r
 
exŒa_h—d”s
) {

6779 
mg_´štf
(
nc
, "HTTP/1.1 %d %s\r\nS”v”: %s\r\n", 
¡©us_code
,

6780 
mg_¡©us_mes§ge
(
¡©us_code
), 
mg_v”siÚ_h—d”
);

6781 ià(
	gexŒa_h—d”s
.
	gËn
 > 0) {

6782 
mg_´štf
(
nc
, "%.*s\r\n", (è
exŒa_h—d”s
.
Ën
,ƒxŒa_h—d”s.
p
);

6786 
mg_£nd_»¥Ú£_lše
(
mg_cÚÃùiÚ
 *
nc
, 
¡©us_code
,

6787 cÚ¡ *
exŒa_h—d”s
) {

6788 
mg_£nd_»¥Ú£_lše_s
(
nc
, 
¡©us_code
, 
mg_mk_¡r
(
exŒa_h—d”s
));

6791 
mg_h‰p_£nd_»dœeù
(
mg_cÚÃùiÚ
 *
nc
, 
¡©us_code
,

6792 cÚ¡ 
mg_¡r
 
loÿtiÚ
,

6793 cÚ¡ 
mg_¡r
 
exŒa_h—d”s
) {

6794 
	gbbody
[100], *
	gpbody
 = 
bbody
;

6795 
	gbl
 = 
mg_a¥rštf
(&
pbody
, (
bbody
),

6797 (è
loÿtiÚ
.
Ën
,†oÿtiÚ.
p
);

6798 
	gbh—d
[150], *
	gph—d
 = 
bh—d
;

6799 
mg_a¥rštf
(&
ph—d
, (
bh—d
),

6805 (è
loÿtiÚ
.
Ën
,†oÿtiÚ.
p
, 
bl
, (è
exŒa_h—d”s
.len,

6806 
exŒa_h—d”s
.
p
, (exŒa_h—d”s.
Ën
 > 0 ? "\r\n" : ""));

6807 
mg_£nd_»¥Ú£_lše
(
nc
, 
¡©us_code
, 
ph—d
);

6808 ià(
	gph—d
 !ğ
bh—d
è
MG_FREE
(
ph—d
);

6809 
mg_£nd
(
nc
, 
pbody
, 
bl
);

6810 ià(
	gpbody
 !ğ
bbody
è
MG_FREE
(
pbody
);

6813 
mg_£nd_h—d
(
mg_cÚÃùiÚ
 *
c
, 
¡©us_code
,

6814 
št64_t
 
cÚ‹Á_Ëngth
, cÚ¡ *
exŒa_h—d”s
) {

6815 
mg_£nd_»¥Ú£_lše
(
c
, 
¡©us_code
, 
exŒa_h—d”s
);

6816 ià(
	gcÚ‹Á_Ëngth
 < 0) {

6817 
mg_´štf
(
c
, "%s", "Transfer-Encoding: chunked\r\n");

6819 
mg_´štf
(
c
, "CÚ‹Á-L’gth: %" 
INT64_FMT
 "\r\n", 
cÚ‹Á_Ëngth
);

6821 
mg_£nd
(
c
, "\r\n", 2);

6824 
mg_h‰p_£nd_”rÜ
(
mg_cÚÃùiÚ
 *
nc
, 
code
,

6825 cÚ¡ *
»asÚ
) {

6826 ià(!
	g»asÚ
è»asÚ = 
mg_¡©us_mes§ge
(
code
);

6827 
LOG
(
LL_DEBUG
, ("%°%d %s", 
nc
, 
code
, 
»asÚ
));

6828 
mg_£nd_h—d
(
nc
, 
code
, 
¡¾’
(
»asÚ
),

6830 
mg_£nd
(
nc
, 
»asÚ
, 
¡¾’
(reason));

6831 
	gnc
->
	gæags
 |ğ
MG_F_SEND_AND_CLOSE
;

6834 #ià
MG_ENABLE_FILESYSTEM


6835 
mg_h‰p_cÚ¡ruù_‘ag
(*
buf
, 
size_t
 
buf_Ën
,

6836 cÚ¡ 
cs_¡©_t
 *
¡
) {

6837 
¢´štf
(
buf
, 
buf_Ën
, "\"%lx.%" 
INT64_FMT
 "\"", (è
¡
->
¡_mtime
,

6838 (
št64_t
è
¡
->
¡_size
);

6841 #iâdeà
WINCE


6842 
mg_gmt_time_¡ršg
(*
buf
, 
size_t
 
buf_Ën
, 
time_t
 *
t
) {

6843 
¡ráime
(
buf
, 
buf_Ën
, "%a, %d %b %Y %H:%M:%S GMT", 
gmtime
(
t
));

6847 
mg_gmt_time_¡ršg
(*
buf
, 
size_t
 
buf_Ën
, 
time_t
 *
t
);

6850 
mg_h‰p_·r£_¿nge_h—d”
(cÚ¡ 
mg_¡r
 *
h—d”
, 
št64_t
 *
a
,

6851 
št64_t
 *
b
) {

6856 
	g»suÉ
;

6857 *
	gp
 = (*è
MG_MALLOC
(
h—d”
->
Ën
 + 1);

6858 ià(
	gp
 =ğ
NULL
)  0;

6859 
memıy
(
p
, 
h—d”
->p, h—d”->
Ën
);

6860 
	gp
[
h—d”
->
Ën
] = '\0';

6861 
	g»suÉ
 = 
ssÿnf
(
p
, "by‹s=%" 
INT64_FMT
 "-%" INT64_FMT, 
a
, 
b
);

6862 
MG_FREE
(
p
);

6863  
	g»suÉ
;

6866 
mg_h‰p_£rve_fe
(
mg_cÚÃùiÚ
 *
nc
, 
h‰p_mes§ge
 *
hm
,

6867 cÚ¡ *
·th
, cÚ¡ 
mg_¡r
 
mime_ty³
,

6868 cÚ¡ 
mg_¡r
 
exŒa_h—d”s
) {

6869 
mg_h‰p_´Ùo_d©a
 *
	gpd
 = 
mg_h‰p_g‘_´Ùo_d©a
(
nc
);

6870 
cs_¡©_t
 
	g¡
;

6871 
LOG
(
LL_DEBUG
, ("%°[%s] %.*s", 
nc
, 
·th
, (è
mime_ty³
.
Ën
, mime_ty³.
p
));

6872 ià(
mg_¡©
(
·th
, &
¡
è!ğ0 || (
pd
->
fe
.
å
 = 
mg_fİ’
Õ©h, "rb")è=ğ
NULL
) {

6873 
code
, 
”r
 = 
mg_g‘_”ºo
();

6874 
	g”r
) {

6875 
	gEACCES
:

6876 
code
 = 403;

6878 
	gENOENT
:

6879 
code
 = 404;

6882 
code
 = 500;

6884 
mg_h‰p_£nd_”rÜ
(
nc
, 
code
, "Open failed");

6886 
	g‘ag
[50], 
	gcu¼’t_time
[50], 
	gÏ¡_modif›d
[50], 
	g¿nge
[70];

6887 
time_t
 
	gt
 = (time_tè
mg_time
();

6888 
št64_t
 
	gr1
 = 0, 
	gr2
 = 0, 
	gş
 = 
¡
.
¡_size
;

6889 
mg_¡r
 *
	g¿nge_hdr
 = 
mg_g‘_h‰p_h—d”
(
hm
, "Range");

6890 
	gn
, 
	g¡©us_code
 = 200;

6893 
	g¿nge
[0] = '\0';

6894 ià(
	g¿nge_hdr
 !ğ
NULL
 &&

6895 (
n
 = 
mg_h‰p_·r£_¿nge_h—d”
(
¿nge_hdr
, &
r1
, &
r2
)è> 0 && 
	gr1
 >= 0 &&

6896 
r2
 >= 0) {

6898 ià(
n
 == 1) {

6899 
r2
 = 
ş
 - 1;

6901 ià(
	gr1
 > 
	gr2
 ||„2 >ğ
ş
) {

6902 
¡©us_code
 = 416;

6903 
	gş
 = 0;

6904 
¢´štf
(
¿nge
, (range),

6905 "CÚ‹Á-Rªge: by‹ */%" 
INT64_FMT
 "\r\n",

6906 (
št64_t
è
¡
.
¡_size
);

6908 
	g¡©us_code
 = 206;

6909 
	gş
 = 
r2
 - 
r1
 + 1;

6910 
¢´štf
(
¿nge
, Ôªge), "CÚ‹Á-Rªge: by‹ %" 
INT64_FMT


6911 "-%" 
INT64_FMT
 "/%" INT64_FMT "\r\n",

6912 
r1
,„1 + 
ş
 - 1, (
št64_t
è
¡
.
¡_size
);

6913 #ià
_FILE_OFFSET_BITS
 =ğ64 || 
_POSIX_C_SOURCE
 >= 200112L || \

6914 
	g_XOPEN_SOURCE
 >= 600

6915 
f£eko
(
pd
->
fe
.
å
, 
r1
, 
SEEK_SET
);

6917 
f£ek
(
pd
->
fe
.
å
, (è
r1
, 
SEEK_SET
);

6922 #ià!
MG_DISABLE_HTTP_KEEP_ALIVE


6924 
mg_¡r
 *
	gcÚn_hdr
 = 
mg_g‘_h‰p_h—d”
(
hm
, "Connection");

6925 ià(
	gcÚn_hdr
 !ğ
NULL
) {

6926 
pd
->
fe
.
k“·live
 = (
mg_vÿ£cmp
(
cÚn_hdr
, "keep-alive") == 0);

6928 
	gpd
->
	gfe
.
	gk“·live
 = (
mg_vcmp
(&
hm
->
´Ùo
, "HTTP/1.1") == 0);

6933 
mg_h‰p_cÚ¡ruù_‘ag
(
‘ag
, Óg), &
¡
);

6934 
mg_gmt_time_¡ršg
(
cu¼’t_time
, (cu¼’t_time), &
t
);

6935 
mg_gmt_time_¡ršg
(
Ï¡_modif›d
, Öa¡_modif›d), &
¡
.
¡_mtime
);

6943 
mg_£nd_»¥Ú£_lše_s
(
nc
, 
¡©us_code
, 
exŒa_h—d”s
);

6944 
mg_´štf
(
nc
,

6950 "CÚ‹Á-L’gth: %" 
SIZE_T_FMT


6953 
cu¼’t_time
, 
Ï¡_modif›d
, (è
mime_ty³
.
Ën
, mime_ty³.
p
,

6954 (
pd
->
fe
.
k“·live
 ? "k“p-®ive" : "şo£"), (
size_t
è
ş
, 
¿nge
,

6955 
‘ag
);

6957 
	gpd
->
	gfe
.
	gş
 = 
ş
;

6958 
	gpd
->
	gfe
.
	gty³
 = 
DATA_FILE
;

6959 
mg_h‰p_Œªsãr_fe_d©a
(
nc
);

6963 
mg_h‰p_£rve_fe2
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

6964 
h‰p_mes§ge
 *
hm
,

6965 
mg_£rve_h‰p_İts
 *
İts
) {

6966 #ià
MG_ENABLE_HTTP_SSI


6967 ià(
mg_m©ch_´efix
(
İts
->
ssi_·‰”n
, 
¡¾’
(İts->ssi_·‰”n), 
·th
) > 0) {

6968 
mg_hªdË_ssi_»que¡
(
nc
, 
hm
, 
·th
, 
İts
);

6972 
mg_h‰p_£rve_fe
(
nc
, 
hm
, 
·th
, 
mg_g‘_mime_ty³
Õ©h, "‹xt/¶aš", 
İts
),

6973 
mg_mk_¡r
(
İts
->
exŒa_h—d”s
));

6978 
mg_u¾_decode
(cÚ¡ *
¤c
, 
¤c_Ën
, *
d¡
, 
d¡_Ën
,

6979 
is_fÜm_u¾_’coded
) {

6980 
	gi
, 
	gj
, 
	ga
, 
	gb
;

6981 
	#HEXTOI
(
x
è(
	`isdig™
(xè? x - '0' : x - 'W')

	)

6983 
	gi
 = 
j
 = 0; i < 
	g¤c_Ën
 && 
	gj
 < 
	gd¡_Ën
 - 1; i++, j++) {

6984 ià(
	g¤c
[
i
] == '%') {

6985 ià(
i
 < 
¤c_Ën
 - 2 && 
isxdig™
(*(cÚ¡ *è(
¤c
 + i + 1)) &&

6986 
isxdig™
(*(cÚ¡ *è(
¤c
 + 
i
 + 2))) {

6987 
a
 = 
tŞow”
(*(cÚ¡ *è(
¤c
 + 
i
 + 1));

6988 
	gb
 = 
tŞow”
(*(cÚ¡ *è(
¤c
 + 
i
 + 2));

6989 
	gd¡
[
j
] = (è((
HEXTOI
(
a
è<< 4è| HEXTOI(
b
));

6990 
	gi
 += 2;

6994 } ià(
	gis_fÜm_u¾_’coded
 && 
	g¤c
[
i
] == '+') {

6995 
d¡
[
j
] = ' ';

6997 
	gd¡
[
j
] = 
¤c
[
i
];

7001 
	gd¡
[
j
] = '\0';

7003  
	gi
 >ğ
¤c_Ën
 ? 
j
 : -1;

7006 
mg_g‘_h‰p_v¬
(cÚ¡ 
mg_¡r
 *
buf
, cÚ¡ *
Çme
, *
d¡
,

7007 
size_t
 
d¡_Ën
) {

7008 cÚ¡ *
	gp
, *
	ge
, *
	gs
;

7009 
size_t
 
	gÇme_Ën
;

7010 
	gËn
;

7020 ià(
	gd¡
 =ğ
NULL
 || 
d¡_Ën
 == 0) {

7021 
Ën
 = -2;

7022 } ià(
	gbuf
->
	gp
 =ğ
NULL
 || 
Çme
 =ğNULL || 
buf
->
Ën
 == 0) {

7023 
Ën
 = -1;

7024 
	gd¡
[0] = '\0';

7026 
	gÇme_Ën
 = 
¡¾’
(
Çme
);

7027 
	ge
 = 
buf
->
p
 + buf->
Ën
;

7028 
	gËn
 = -4;

7029 
	gd¡
[0] = '\0';

7031 
	gp
 = 
buf
->
p
;… + 
	gÇme_Ën
 < 
	ge
;…++) {

7032 ià((
	gp
 =ğ
buf
->
p
 ||…[-1] =ğ'&'è&&…[
Çme_Ën
] == '=' &&

7033 !
mg_nÿ£cmp
(
Çme
, 
p
, 
Çme_Ën
)) {

7034 
	gp
 +ğ
Çme_Ën
 + 1;

7035 
	gs
 = (cÚ¡ *è
memchr
(
p
, '&', (
size_t
)(
e
 -…));

7036 ià(
	gs
 =ğ
NULL
) {

7037 
s
 = 
e
;

7039 
	gËn
 = 
mg_u¾_decode
(
p
, (
size_t
)(
s
 -…), 
d¡
, 
d¡_Ën
, 1);

7041 ià(
	gËn
 == -1) {

7042 
Ën
 = -3;

7049  
	gËn
;

7052 
mg_£nd_h‰p_chunk
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

7053 
	gchunk_size
[50];

7054 
	gn
;

7056 
	gn
 = 
¢´štf
(
chunk_size
, (chunk_size), "%lX\r\n", (è
Ën
);

7057 
mg_£nd
(
nc
, 
chunk_size
, 
n
);

7058 
mg_£nd
(
nc
, 
buf
, 
Ën
);

7059 
mg_£nd
(
nc
, "\r\n", 2);

7062 
mg_´štf_h‰p_chunk
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
fmt
, ...) {

7063 
	gmem
[
MG_VPRINTF_BUFFER_SIZE
], *
	gbuf
 = 
mem
;

7064 
	gËn
;

7065 
va_li¡
 
	g­
;

7067 
va_¡¬t
(
­
, 
fmt
);

7068 
	gËn
 = 
mg_av´štf
(&
buf
, (
mem
), 
fmt
, 
­
);

7069 
va_’d
(
­
);

7071 ià(
	gËn
 >= 0) {

7072 
mg_£nd_h‰p_chunk
(
nc
, 
buf
, 
Ën
);

7076 ià(
	gbuf
 !ğ
mem
 && 
buf
 !ğ
NULL
) {

7077 
MG_FREE
(
buf
);

7082 
mg_´štf_html_esÿ³
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
fmt
, ...) {

7083 
	gmem
[
MG_VPRINTF_BUFFER_SIZE
], *
	gbuf
 = 
mem
;

7084 
	gi
, 
	gj
, 
	gËn
;

7085 
va_li¡
 
	g­
;

7087 
va_¡¬t
(
­
, 
fmt
);

7088 
	gËn
 = 
mg_av´štf
(&
buf
, (
mem
), 
fmt
, 
­
);

7089 
va_’d
(
­
);

7091 ià(
	gËn
 >= 0) {

7092 
i
 = 
j
 = 0; 
	gi
 < 
	gËn
; i++) {

7093 ià(
	gbuf
[
i
] =ğ'<' || 
buf
[i] == '>') {

7094 
mg_£nd
(
nc
, 
buf
 + 
j
, 
i
 - j);

7095 
mg_£nd
(
nc
, 
buf
[
i
] == '<' ? "&lt;" : "&gt;", 4);

7096 
	gj
 = 
i
 + 1;

7099 
mg_£nd
(
nc
, 
buf
 + 
j
, 
i
 - j);

7103 ià(
	gbuf
 !ğ
mem
 && 
buf
 !ğ
NULL
) {

7104 
MG_FREE
(
buf
);

7109 
mg_h‰p_·r£_h—d”
(
mg_¡r
 *
hdr
, cÚ¡ *
v¬_Çme
, *
buf
,

7110 
size_t
 
buf_size
) {

7111 
	gch
 = ' ', 
	gch1
 = ',', 
	gËn
 = 0, 
	gn
 = 
¡¾’
(
v¬_Çme
);

7112 cÚ¡ *
	gp
, *
	g’d
 = 
hdr
 ? hdr->
p
 + hdr->
Ën
 : 
NULL
, *
	gs
 = NULL;

7114 ià(
	gbuf
 !ğ
NULL
 && 
buf_size
 > 0è
buf
[0] = '\0';

7115 ià(
	ghdr
 =ğ
NULL
)  0;

7118 
	gs
 = 
hdr
->
p
; s !ğ
NULL
 && 
s
 + 
n
 < 
’d
; s++) {

7119 ià((
	gs
 =ğ
hdr
->
p
 || 
s
[-1] =ğ
ch
 || s[-1] =ğ
ch1
 || s[-1] == ';') &&

7120 
s
[
n
] =ğ'=' && !
¡ºcmp
(s, 
v¬_Çme
,‚))

7124 ià(
	gs
 !ğ
NULL
 && &
s
[
n
 + 1] < 
’d
) {

7125 
s
 +ğ
n
 + 1;

7126 ià(*
	gs
 =ğ'"' || *
s
 == '\'') {

7127 
ch
 = 
ch1
 = *
s
++;

7129 
	gp
 = 
s
;

7130 
	gp
 < 
	g’d
 &&…[0] !ğ
ch
 && 
p
[0] !ğ
ch1
 && 
Ën
 < (è
buf_size
) {

7131 ià(
ch
 !ğ' ' && 
p
[0] == '\\' &&…[1] == ch)…++;

7132 
	gbuf
[
Ën
++] = *
p
++;

7134 ià(
	gËn
 >ğ(è
buf_size
 || (
ch
 !ğ' ' && *
p
 != ch)) {

7135 
Ën
 = 0;

7137 ià(
	gËn
 > 0 && 
	gs
[
Ën
 - 1] == ',')†en--;

7138 ià(
	gËn
 > 0 && 
	gs
[
Ën
 - 1] == ';')†en--;

7139 
	gbuf
[
Ën
] = '\0';

7143  
	gËn
;

7146 
mg_g‘_h‰p_basic_auth
(
h‰p_mes§ge
 *
hm
, *
u£r
, 
size_t
 
u£r_Ën
,

7147 *
·ss
, 
size_t
 
·ss_Ën
) {

7148 
mg_¡r
 *
	ghdr
 = 
mg_g‘_h‰p_h—d”
(
hm
, "Authorization");

7149 ià(
	ghdr
 =ğ
NULL
)  -1;

7150  
mg_·r£_h‰p_basic_auth
(
hdr
, 
u£r
, 
u£r_Ën
, 
·ss
, 
·ss_Ën
);

7153 
mg_·r£_h‰p_basic_auth
(
mg_¡r
 *
hdr
, *
u£r
, 
size_t
 
u£r_Ën
,

7154 *
·ss
, 
size_t
 
·ss_Ën
) {

7155 *
	gbuf
 = 
NULL
;

7156 
	gfmt
[64];

7157 
	g»s
 = 0;

7159 ià(
mg_¡ºcmp
(*
hdr
, 
mg_mk_¡r
("Basic "), 6) != 0)  -1;

7161 
	gbuf
 = (*è
MG_MALLOC
(
hdr
->
Ën
);

7162 
cs_ba£64_decode
((*è
hdr
->
p
 + 6, hdr->
Ën
, 
buf
, 
NULL
);

7165 
¢´štf
(
fmt
, (fmt), "%%%" 
SIZE_T_FMT
 "[^:]:%%%" SIZE_T_FMT "[^\n]",

7166 
u£r_Ën
 - 1, 
·ss_Ën
 - 1);

7167 ià(
ssÿnf
(
buf
, 
fmt
, 
u£r
, 
·ss
) == 0) {

7168 
»s
 = -1;

7171 
MG_FREE
(
buf
);

7172  
	g»s
;

7175 #ià
MG_ENABLE_FILESYSTEM


7176 
mg_is_fe_hidd’
(cÚ¡ *
·th
,

7177 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
,

7178 
exşude_¥ecŸls
) {

7179 cÚ¡ *
	gp1
 = 
İts
->
³r_dœeùÜy_auth_fe
;

7180 cÚ¡ *
	gp2
 = 
İts
->
hidd’_fe_·‰”n
;

7183 cÚ¡ *
	gpdœ
 = 
¡¼chr
(
·th
, 
DIRSEP
);

7184 ià(
	gpdœ
 !ğ
NULL
) {

7185 
·th
 = 
pdœ
 + 1;

7188  (
	gexşude_¥ecŸls
 && (!
¡rcmp
(
·th
, ".") || !strcmp(path, ".."))) ||

7189 (
	gp1
 !ğ
NULL
 &&

7190 
mg_m©ch_´efix
(
p1
, 
¡¾’
Õ1), 
·th
) == () strlen(p1)) ||

7191 (
p2
 !ğ
NULL
 && 
mg_m©ch_´efix
Õ2, 
¡¾’
Õ2), 
·th
) > 0);

7194 #ià!
MG_DISABLE_HTTP_DIGEST_AUTH


7196 #iâdeà
MG_EXT_MD5


7197 
mg_hash_md5_v
(
size_t
 
num_msgs
, cÚ¡ 
ušt8_t
 *
msgs
[],

7198 cÚ¡ 
size_t
 *
msg_Ëns
, 
ušt8_t
 *
dige¡
) {

7199 
size_t
 
	gi
;

7200 
cs_md5_ùx
 
	gmd5_ùx
;

7201 
cs_md5_š™
(&
md5_ùx
);

7202 
	gi
 = 0; i < 
	gnum_msgs
; i++) {

7203 
cs_md5_upd©e
(&
md5_ùx
, 
msgs
[
i
], 
msg_Ëns
[i]);

7205 
cs_md5_fš®
(
dige¡
, &
md5_ùx
);

7208 
mg_hash_md5_v
(
size_t
 
num_msgs
, cÚ¡ 
ušt8_t
 *
msgs
[],

7209 cÚ¡ 
size_t
 *
msg_Ëns
, 
ušt8_t
 *
dige¡
);

7212 
cs_md5
(
buf
[33], ...) {

7213 
	ghash
[16];

7214 cÚ¡ 
ušt8_t
 *
	gmsgs
[20], *
	gp
;

7215 
size_t
 
	gmsg_Ëns
[20];

7216 
size_t
 
	gnum_msgs
 = 0;

7217 
va_li¡
 
	g­
;

7219 
va_¡¬t
(
­
, 
buf
);

7220 (
	gp
 = 
va_¬g
(
­
, cÚ¡ *èè!ğ
NULL
) {

7221 
msgs
[
num_msgs
] = 
p
;

7222 
	gmsg_Ëns
[
num_msgs
] = 
va_¬g
(
­
, 
size_t
);

7223 
	gnum_msgs
++;

7225 
va_’d
(
­
);

7227 
mg_hash_md5_v
(
num_msgs
, 
msgs
, 
msg_Ëns
, 
hash
);

7228 
cs_to_hex
(
buf
, 
hash
, (hash));

7231 
mg_mkmd5»¥
(cÚ¡ *
m‘hod
, 
size_t
 
m‘hod_Ën
, cÚ¡ *
uri
,

7232 
size_t
 
uri_Ën
, cÚ¡ *
ha1
, size_ˆ
ha1_Ën
,

7233 cÚ¡ *
nÚû
, 
size_t
 
nÚû_Ën
, cÚ¡ *
nc
,

7234 
size_t
 
nc_Ën
, cÚ¡ *
úÚû
, size_ˆ
úÚû_Ën
,

7235 cÚ¡ *
qİ
, 
size_t
 
qİ_Ën
, *
»¥
) {

7236 cÚ¡ 
	gcŞÚ
[] = ":";

7237 cÚ¡ 
size_t
 
	gÚe
 = 1;

7238 
	gha2
[33];

7239 
cs_md5
(
ha2
, 
m‘hod
, 
m‘hod_Ën
, 
cŞÚ
, 
Úe
, 
uri
, 
uri_Ën
, 
NULL
);

7240 
cs_md5
(
»¥
, 
ha1
, 
ha1_Ën
, 
cŞÚ
, 
Úe
, 
nÚû
, 
nÚû_Ën
, cŞÚ, oÃ, 
nc
,

7241 
nc_Ën
, 
cŞÚ
, 
Úe
, 
úÚû
, 
úÚû_Ën
, cŞÚ, oÃ, 
qİ
, 
qİ_Ën
,

7242 
cŞÚ
, 
Úe
, 
ha2
, (ha2è- 1, 
NULL
);

7245 
mg_h‰p_ü—‹_dige¡_auth_h—d”
(*
buf
, 
size_t
 
buf_Ën
,

7246 cÚ¡ *
m‘hod
, cÚ¡ *
uri
,

7247 cÚ¡ *
auth_domaš
, cÚ¡ *
u£r
,

7248 cÚ¡ *
·sswd
) {

7249 cÚ¡ 
	gcŞÚ
[] = ":", 
	gqİ
[] = "auth";

7250 cÚ¡ 
size_t
 
	gÚe
 = 1;

7251 
	gha1
[33], 
	g»¥
[33], 
	gúÚû
[40];

7253 
¢´štf
(
úÚû
, (úÚû), "%x", (è
mg_time
());

7254 
cs_md5
(
ha1
, 
u£r
, (
size_t
è
¡¾’
(u£r), 
cŞÚ
, 
Úe
, 
auth_domaš
,

7255 (
size_t
è
¡¾’
(
auth_domaš
), 
cŞÚ
, 
Úe
, 
·sswd
,

7256 (
size_t
è
¡¾’
(
·sswd
), 
NULL
);

7257 
mg_mkmd5»¥
(
m‘hod
, 
¡¾’
(m‘hod), 
uri
, sŒËn(uri), 
ha1
, (ha1) - 1,

7258 
úÚû
, 
¡¾’
(úÚû), "1", 
Úe
, cnÚû, sŒËn(úÚû), 
qİ
,

7259 (
qİ
è- 1, 
»¥
);

7260  
¢´štf
(
buf
, 
buf_Ën
,

7264 
u£r
, 
auth_domaš
, 
uri
, 
qİ
, 
úÚû
, cnÚû, 
»¥
);

7273 
mg_check_nÚû
(cÚ¡ *
nÚû
) {

7274 
	gnow
 = (è
mg_time
();

7275 
	gv®
 = (è
¡¹oul
(
nÚû
, 
NULL
, 16);

7276  
	gnow
 < 
	gv®
 ||‚ow - val < 3600;

7279 
mg_h‰p_check_dige¡_auth
(
h‰p_mes§ge
 *
hm
, cÚ¡ *
auth_domaš
,

7280 
FILE
 *
å
) {

7281 
mg_¡r
 *
	ghdr
;

7282 
	gu£ºame
[50], 
	gúÚû
[64], 
	g»¥Ú£
[40], 
	guri
[200], 
	gqİ
[20], 
	gnc
[20],

7283 
	gnÚû
[30];

7286 ià(
	ghm
 =ğ
NULL
 || 
å
 == NULL ||

7287 (
hdr
 = 
mg_g‘_h‰p_h—d”
(
hm
, "AuthÜiz©iÚ")è=ğ
NULL
 ||

7288 
mg_h‰p_·r£_h—d”
(
hdr
, "u£ºame", 
u£ºame
, (username)) == 0 ||

7289 
mg_h‰p_·r£_h—d”
(
hdr
, "úÚû", 
úÚû
, (cnonce)) == 0 ||

7290 
mg_h‰p_·r£_h—d”
(
hdr
, "»¥Ú£", 
»¥Ú£
, (response)) == 0 ||

7291 
mg_h‰p_·r£_h—d”
(
hdr
, "uri", 
uri
, (uri)) == 0 ||

7292 
mg_h‰p_·r£_h—d”
(
hdr
, "qİ", 
qİ
, (qop)) == 0 ||

7293 
mg_h‰p_·r£_h—d”
(
hdr
, "nc", 
nc
, (nc)) == 0 ||

7294 
mg_h‰p_·r£_h—d”
(
hdr
, "nÚû", 
nÚû
, (nonce)) == 0 ||

7295 
mg_check_nÚû
(
nÚû
) == 0) {

7301  
mg_check_dige¡_auth
(

7302 
hm
->
m‘hod
,

7303 
mg_mk_¡r_n
(

7304 
hm
->
uri
.
p
,

7305 
hm
->
uri
.
Ën
 + (hm->
qu”y_¡ršg
.len ? hm->query_string.len + 1 : 0)),

7306 
mg_mk_¡r
(
u£ºame
), mg_mk_¡r(
úÚû
), mg_mk_¡r(
»¥Ú£
),

7307 
mg_mk_¡r
(
qİ
), mg_mk_¡r(
nc
), mg_mk_¡r(
nÚû
), mg_mk_¡r(
auth_domaš
),

7308 
å
);

7311 
mg_check_dige¡_auth
(
mg_¡r
 
m‘hod
, mg_¡¸
uri
,

7312 
mg_¡r
 
u£ºame
, mg_¡¸
úÚû
,

7313 
mg_¡r
 
»¥Ú£
, mg_¡¸
qİ
,

7314 
mg_¡r
 
nc
, mg_¡¸
nÚû
,

7315 
mg_¡r
 
auth_domaš
, 
FILE
 *
å
) {

7316 
	gbuf
[128], 
	gf_u£r
[(
buf
)], 
	gf_ha1
[(buf)], 
	gf_domaš
[(buf)];

7317 
	gex³ùed_»¥Ú£
[33];

7324 
fg‘s
(
buf
, (buf), 
å
è!ğ
NULL
) {

7325 ià(
ssÿnf
(
buf
, "%[^:]:%[^:]:%s", 
f_u£r
, 
f_domaš
, 
f_ha1
) == 3 &&

7326 
mg_vcmp
(&
u£ºame
, 
f_u£r
) == 0 &&

7327 
mg_vcmp
(&
auth_domaš
, 
f_domaš
) == 0) {

7329 
mg_mkmd5»¥
(
m‘hod
.
p
, m‘hod.
Ën
, 
uri
.p, uri.Ën, 
f_ha1
, 
¡¾’
(f_ha1),

7330 
nÚû
.
p
,‚Úû.
Ën
, 
nc
.p,‚c.Ën, 
úÚû
.p, cnonce.len,

7331 
qİ
.
p
, qİ.
Ën
, 
ex³ùed_»¥Ú£
);

7332 
LOG
(
LL_DEBUG
,

7333 ("%.* % %.* %s", (è
u£ºame
.
Ën
, u£ºame.
p
, 
f_domaš
,

7334 (è
»¥Ú£
.
Ën
,„e¥Ú£.
p
, 
ex³ùed_»¥Ú£
));

7335  
mg_nÿ£cmp
(
»¥Ú£
.
p
, 
ex³ùed_»¥Ú£
,„e¥Ú£.
Ën
) == 0;

7343 
mg_h‰p_is_authÜized
(
h‰p_mes§ge
 *
hm
, 
mg_¡r
 
·th
,

7344 
is_dœeùÜy
, cÚ¡ *
domaš
,

7345 cÚ¡ *
·sswÜds_fe
,

7346 
is_glob®_·ss_fe
) {

7347 
	gbuf
[
MG_MAX_PATH
];

7348 cÚ¡ *
	gp
;

7349 
FILE
 *
	gå
;

7350 
	gauthÜized
 = 1;

7352 ià(
	gdomaš
 !ğ
NULL
 && 
·sswÜds_fe
 != NULL) {

7353 ià(
is_glob®_·ss_fe
) {

7354 
å
 = 
mg_fİ’
(
·sswÜds_fe
, "r");

7355 } ià(
	gis_dœeùÜy
) {

7356 
¢´štf
(
buf
, (buf), "%.*s%c%s", (è
·th
.
Ën
,…©h.
p
, 
DIRSEP
,

7357 
·sswÜds_fe
);

7358 
	gå
 = 
mg_fİ’
(
buf
, "r");

7360 
	gp
 = 
¡¼chr
(
·th
.
p
, 
DIRSEP
);

7361 ià(
	gp
 =ğ
NULL
è
p
 = 
·th
.p;

7362 
¢´štf
(
buf
, (buf), "%.*s%c%s", (è(
p
 - 
·th
.p),…©h.p, 
DIRSEP
,

7363 
·sswÜds_fe
);

7364 
	gå
 = 
mg_fİ’
(
buf
, "r");

7367 ià(
	gå
 !ğ
NULL
) {

7368 
authÜized
 = 
mg_h‰p_check_dige¡_auth
(
hm
, 
domaš
, 
å
);

7369 
fşo£
(
å
);

7373 
LOG
(
LL_DEBUG
,

7374 ("%.* % %d %d", (è
·th
.
Ën
,…©h.
p
,

7375 
·sswÜds_fe
 ?…asswÜds_f: "", 
is_glob®_·ss_fe
, 
authÜized
));

7376  
	gauthÜized
;

7379 
mg_h‰p_is_authÜized
(
h‰p_mes§ge
 *
hm
,

7380 cÚ¡ 
mg_¡r
 
·th
, 
is_dœeùÜy
,

7381 cÚ¡ *
domaš
, cÚ¡ *
·sswÜds_fe
,

7382 
is_glob®_·ss_fe
) {

7383 (è
	ghm
;

7384 (è
	g·th
;

7385 (è
	gis_dœeùÜy
;

7386 (è
	gdomaš
;

7387 (è
	g·sswÜds_fe
;

7388 (è
	gis_glob®_·ss_fe
;

7393 #ià
MG_ENABLE_DIRECTORY_LISTING


7394 
mg_esÿ³
(cÚ¡ *
¤c
, *
d¡
, 
size_t
 
d¡_Ën
) {

7395 
size_t
 
	gn
 = 0;

7396 *
	g¤c
 !ğ'\0' && 
n
 + 5 < 
d¡_Ën
) {

7397 
ch
 = *(*è
¤c
++;

7398 ià(
	gch
 == '<') {

7399 
n
 +ğ
¢´štf
(
d¡
 +‚, 
d¡_Ën
 -‚, "%s", "&lt;");

7401 
	gd¡
[
n
++] = 
ch
;

7404 
	gd¡
[
n
] = '\0';

7407 
mg_´št_dœ_’Œy
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
fe_Çme
,

7408 
cs_¡©_t
 *
¡p
) {

7409 
	gsize
[64], 
	gmod
[64], 
	g·th
[
MG_MAX_PATH
];

7410 
št64_t
 
	gfsize
 = 
¡p
->
¡_size
;

7411 
	gis_dœ
 = 
S_ISDIR
(
¡p
->
¡_mode
);

7412 cÚ¡ *
	g¦ash
 = 
is_dœ
 ? "/" : "";

7413 
mg_¡r
 
	gh»f
;

7415 ià(
	gis_dœ
) {

7416 
¢´štf
(
size
, (size), "%s", "[DIRECTORY]");

7422 ià(
	gfsize
 < 1024) {

7423 
¢´štf
(
size
, (size), "%d", (è
fsize
);

7424 } ià(
	gfsize
 < 0x100000) {

7425 
¢´štf
(
size
, (size), "%.1fk", (è
fsize
 / 1024.0);

7426 } ià(
	gfsize
 < 0x40000000) {

7427 
¢´štf
(
size
, (size), "%.1fM", (è
fsize
 / 1048576);

7429 
¢´štf
(
size
, (size), "%.1fG", (è
fsize
 / 1073741824);

7432 
¡ráime
(
mod
, (mod), "%d-%b-%Y %H:%M", 
loÿÉime
(&
¡p
->
¡_mtime
));

7433 
mg_esÿ³
(
fe_Çme
, 
·th
, (path));

7434 
	gh»f
 = 
mg_u¾_’code
(
mg_mk_¡r
(
fe_Çme
));

7435 
mg_´štf_h‰p_chunk
(
nc
,

7437 "<td>%s</td><td‚ame=%" 
INT64_FMT
 ">%s</td></tr>\n",

7438 
h»f
.
p
, 
¦ash
, 
·th
, sÏsh, 
mod
, 
is_dœ
 ? -1 : 
fsize
,

7439 
size
);

7440 
ä“
((*è
h»f
.
p
);

7443 
mg_sÿn_dœeùÜy
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
dœ
,

7444 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
,

7445 (*
func
)(
mg_cÚÃùiÚ
 *, const *,

7446 
cs_¡©_t
 *)) {

7447 
	g·th
[
MG_MAX_PATH
];

7448 
cs_¡©_t
 
	g¡
;

7449 
dœ’t
 *
	gdp
;

7450 
DIR
 *
	gdœp
;

7452 
LOG
(
LL_DEBUG
, ("%°[%s]", 
nc
, 
dœ
));

7453 ià((
	gdœp
 = (
İ’dœ
(
dœ
))è!ğ
NULL
) {

7454 (
dp
 = 
»addœ
(
dœp
)è!ğ
NULL
) {

7456 ià(
mg_is_fe_hidd’
((cÚ¡ *è
dp
->
d_Çme
, 
İts
, 1)) {

7459 
¢´štf
(
·th
, Õ©h), "%s/%s", 
dœ
, 
dp
->
d_Çme
);

7460 ià(
mg_¡©
(
·th
, &
¡
) == 0) {

7461 
func
(
nc
, (cÚ¡ *è
dp
->
d_Çme
, &
¡
);

7464 
şo£dœ
(
dœp
);

7466 
LOG
(
LL_DEBUG
, ("%°İ’dœ(%sè-> %d", 
nc
, 
dœ
, 
mg_g‘_”ºo
()));

7470 
mg_£nd_dœeùÜy_li¡šg
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
dœ
,

7471 
h‰p_mes§ge
 *
hm
,

7472 
mg_£rve_h‰p_İts
 *
İts
) {

7473 cÚ¡ *
	gsÜt_js_code
 =

7483 cÚ¡ *
	gsÜt_js_code2
 =

7497 
mg_£nd_»¥Ú£_lše
(
nc
, 200, 
İts
->
exŒa_h—d”s
);

7498 
mg_´štf
(
nc
, "%s: %s\r\n%s: %s\r\n\r\n", "Transfer-Encoding", "chunked",

7501 
mg_´štf_h‰p_chunk
(

7502 
nc
,

7513 (è
hm
->
uri
.
Ën
, hm->uri.
p
, 
sÜt_js_code
, 
sÜt_js_code2
,

7514 (è
hm
->
uri
.
Ën
, hm->uri.
p
);

7515 
mg_sÿn_dœeùÜy
(
nc
, 
dœ
, 
İts
, 
mg_´št_dœ_’Œy
);

7516 
mg_´štf_h‰p_chunk
(
nc
,

7521 
mg_v”siÚ_h—d”
);

7522 
mg_£nd_h‰p_chunk
(
nc
, "", 0);

7524 
	gnc
->
	gæags
 |ğ
MG_F_SEND_AND_CLOSE
;

7535 
MG_INTERNAL
 
mg_fšd_šdex_fe
(cÚ¡ *
·th
, cÚ¡ *
li¡
,

7536 **
šdex_fe
, 
cs_¡©_t
 *
¡p
) {

7537 
mg_¡r
 
	gvec
;

7538 
size_t
 
	g·th_Ën
 = 
¡¾’
(
·th
);

7539 
	gfound
 = 0;

7540 *
	gšdex_fe
 = 
NULL
;

7544 (
	gli¡
 = 
mg_Ãxt_comma_li¡_’Œy
(
li¡
, &
vec
, 
NULL
)) != NULL) {

7545 
cs_¡©_t
 
¡
;

7546 
size_t
 
	gËn
 = 
·th_Ën
 + 1 + 
vec
.
Ën
 + 1;

7547 *
	gšdex_fe
 = (*è
MG_REALLOC
(*
šdex_fe
, 
Ën
);

7548 ià(*
	gšdex_fe
 =ğ
NULL
) ;

7549 
¢´štf
(*
šdex_fe
, 
Ën
, "%s%c%.*s", 
·th
, 
DIRSEP
, (è
vec
.Ën, vec.
p
);

7552 ià(
mg_¡©
(*
šdex_fe
, &
¡
è=ğ0 && 
S_ISREG
(¡.
¡_mode
)) {

7554 *
¡p
 = 
¡
;

7555 
	gfound
 = 1;

7559 ià(!
	gfound
) {

7560 
MG_FREE
(*
šdex_fe
);

7561 *
	gšdex_fe
 = 
NULL
;

7563 
LOG
(
LL_DEBUG
, ("[%s] [%s]", 
·th
, (*
šdex_fe
 ? *index_file : "")));

7566 #ià
MG_ENABLE_HTTP_URL_REWRITES


7567 
mg_h‰p_£nd_pÜt_ba£d_»dœeù
(

7568 
mg_cÚÃùiÚ
 *
c
, 
h‰p_mes§ge
 *
hm
,

7569 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
) {

7570 cÚ¡ *
	g»wr™es
 = 
İts
->
u¾_»wr™es
;

7571 
mg_¡r
 
	ga
, 
	gb
;

7572 
	gloÿl_pÜt
[20] = {'%'};

7574 
mg_cÚn_addr_to_¡r
(
c
, 
loÿl_pÜt
 + 1, (local_port) - 1,

7575 
MG_SOCK_STRINGIFY_PORT
);

7577 (
	g»wr™es
 = 
mg_Ãxt_comma_li¡_’Œy
(
»wr™es
, &
a
, &
b
)è!ğ
NULL
) {

7578 ià(
mg_vcmp
(&
a
, 
loÿl_pÜt
) == 0) {

7579 
mg_£nd_»¥Ú£_lše
(
c
, 301, 
NULL
);

7580 
mg_´štf
(
c
, "Content-Length: 0\r\nLocation: %.*s%.*s\r\n\r\n",

7581 (è
b
.
Ën
, b.
p
, (è(
hm
->
´Ùo
.°- hm->
uri
.p - 1),

7582 
hm
->
uri
.
p
);

7590 
mg_»v”£_´oxy_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
,

7591 *
ev_d©a
 
MG_UD_ARG
(*
u£r_d©a
)) {

7592 
h‰p_mes§ge
 *
	ghm
 = (h‰p_mes§g*è
ev_d©a
;

7593 
mg_h‰p_´Ùo_d©a
 *
	gpd
 = 
mg_h‰p_g‘_´Ùo_d©a
(
nc
);

7595 ià(
	gpd
 =ğ
NULL
 || 
pd
->
»v”£_´oxy_d©a
.
lšked_cÚn
 == NULL) {

7596 
DBG
(("%p: up¡»am clo£d", 
nc
));

7600 
	gev
) {

7601 
	gMG_EV_CONNECT
:

7602 ià(*(*è
ev_d©a
 != 0) {

7603 
mg_h‰p_£nd_”rÜ
(
pd
->
»v”£_´oxy_d©a
.
lšked_cÚn
, 502, 
NULL
);

7607 
	gMG_EV_HTTP_REPLY
:

7608 
mg_£nd
(
pd
->
»v”£_´oxy_d©a
.
lšked_cÚn
, 
hm
->
mes§ge
.
p
,

7609 
hm
->
mes§ge
.
Ën
);

7610 
	gpd
->
	g»v”£_´oxy_d©a
.
	glšked_cÚn
->
	gæags
 |ğ
MG_F_SEND_AND_CLOSE
;

7611 
	gnc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

7613 
	gMG_EV_CLOSE
:

7614 
pd
->
»v”£_´oxy_d©a
.
lšked_cÚn
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

7618 #ià
MG_ENABLE_CALLBACK_USERDATA


7619 (è
	gu£r_d©a
;

7623 
mg_h‰p_»v”£_´oxy
(
mg_cÚÃùiÚ
 *
nc
,

7624 cÚ¡ 
h‰p_mes§ge
 *
hm
, 
mg_¡r
 
mouÁ
,

7625 
mg_¡r
 
up¡»am
) {

7626 
mg_cÚÃùiÚ
 *
	gbe
;

7627 
	gbu¾
[256], *
	gpu¾
 = 
bu¾
;

7628 
	gi
;

7629 cÚ¡ *
	g”rÜ
;

7630 
mg_cÚÃù_İts
 
	gİts
;

7631 
mg_¡r
 
	g·th
 = 
MG_NULL_STR
, 
	gu£r_šfo
 = MG_NULL_STR, 
	gho¡
 = MG_NULL_STR;

7632 
mem£t
(&
İts
, 0, (opts));

7633 
	gİts
.
	g”rÜ_¡ršg
 = &
”rÜ
;

7635 
mg_a¥rštf
(&
pu¾
, (
bu¾
), "%.*s%.*s", (è
up¡»am
.
Ën
, up¡»am.
p
,

7636 (è(
hm
->
uri
.
Ën
 - 
mouÁ
.Ën), hm->uri.
p
 + mount.len);

7638 
	gbe
 = 
mg_cÚÃù_h‰p_ba£
(
nc
->
mgr
, 
MG_CB
(
mg_»v”£_´oxy_hªdËr
, 
NULL
),

7639 
İts
, "h‰p", 
NULL
, "h‰ps", NULL, 
pu¾
, &
·th
,

7640 &
u£r_šfo
, &
ho¡
);

7641 
LOG
(
LL_DEBUG
, ("Proxyšg %.* tØ% ÔuË: %.*s)", (è
hm
->
uri
.
Ën
,

7642 
hm
->
uri
.
p
, 
pu¾
, (è
mouÁ
.
Ën
, mount.p));

7644 ià(
	gbe
 =ğ
NULL
) {

7645 
LOG
(
LL_ERROR
, ("E¼Ü cÚÃùšgØ%s: %s", 
pu¾
, 
”rÜ
));

7646 
mg_h‰p_£nd_”rÜ
(
nc
, 502, 
NULL
);

7647 
	gş—nup
;

7651 
mg_h‰p_g‘_´Ùo_d©a
(
be
)->
	g»v”£_´oxy_d©a
.
	glšked_cÚn
 = 
nc
;

7652 
mg_h‰p_g‘_´Ùo_d©a
(
nc
)->
	g»v”£_´oxy_d©a
.
	glšked_cÚn
 = 
be
;

7655 
mg_´štf
(
be
, "%.* %.* HTTP/1.1\r\n", (è
hm
->
m‘hod
.
Ën
, hm->m‘hod.
p
,

7656 (è
·th
.
Ën
,…©h.
p
);

7658 
mg_´štf
(
be
, "Ho¡: %.*s\r\n", (è
ho¡
.
Ën
, ho¡.
p
);

7659 
	gi
 = 0; i < 
	gMG_MAX_HTTP_HEADERS
 && 
	ghm
->
	gh—d”_Çmes
[
i
].
	gËn
 > 0; i++) {

7660 
mg_¡r
 
	ghn
 = 
hm
->
h—d”_Çmes
[
i
];

7661 
mg_¡r
 
	ghv
 = 
hm
->
h—d”_v®ues
[
i
];

7664 ià(
mg_vÿ£cmp
(&
hn
, "Host") == 0) ;

7669 ià(
mg_vÿ£cmp
(&
hn
, "Transfer-encoding") == 0 &&

7670 
mg_vÿ£cmp
(&
hv
, "chunked") == 0) {

7671 
mg_´štf
(
be
, "CÚ‹Á-L’gth: %" 
SIZE_T_FMT
 "\r\n", 
hm
->
body
.
Ën
);

7675 ià(
mg_vÿ£cmp
(&
hn
, "Expect") == 0 &&

7676 
mg_vÿ£cmp
(&
hv
, "100-continue") == 0) {

7680 
mg_´štf
(
be
, "%.*s: %.*s\r\n", (è
hn
.
Ën
, hn.
p
, (è
hv
.len, hv.p);

7683 
mg_£nd
(
be
, "\r\n", 2);

7684 
mg_£nd
(
be
, 
hm
->
body
.
p
, hm->body.
Ën
);

7686 
	gş—nup
:

7687 ià(
pu¾
 !ğ
bu¾
è
MG_FREE
(purl);

7690 
mg_h‰p_hªdË_fÜw¬dšg
(
mg_cÚÃùiÚ
 *
nc
,

7691 
h‰p_mes§ge
 *
hm
,

7692 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
) {

7693 cÚ¡ *
	g»wr™es
 = 
İts
->
u¾_»wr™es
;

7694 
mg_¡r
 
	ga
, 
	gb
;

7695 
mg_¡r
 
	gp1
 = 
MG_MK_STR
("h‰p://"), 
	gp2
 = MG_MK_STR("https://");

7697 (
	g»wr™es
 = 
mg_Ãxt_comma_li¡_’Œy
(
»wr™es
, &
a
, &
b
)è!ğ
NULL
) {

7698 ià(
mg_¡ºcmp
(
a
, 
hm
->
uri
,‡.
Ën
) == 0) {

7699 ià(
mg_¡ºcmp
(
b
, 
p1
,…1.
Ën
è=ğ0 || mg_¡ºcmp(b, 
p2
,…2.len) == 0) {

7700 
mg_h‰p_»v”£_´oxy
(
nc
, 
hm
, 
a
, 
b
);

7710 
MG_INTERNAL
 
mg_uri_to_loÿl_·th
(
h‰p_mes§ge
 *
hm
,

7711 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
,

7712 **
loÿl_·th
,

7713 
mg_¡r
 *
»mašd”
) {

7714 
	gok
 = 1;

7715 cÚ¡ *
	gı
 = 
hm
->
uri
.
p
, *
	gı_’d
 = hm->uri.°+ hm->uri.
Ën
;

7716 
mg_¡r
 
	groÙ
 = {
NULL
, 0};

7717 cÚ¡ *
	gfe_uri_¡¬t
 = 
ı
;

7718 *
	gloÿl_·th
 = 
NULL
;

7719 
	g»mašd”
->
	gp
 = 
NULL
;

7720 
	g»mašd”
->
	gËn
 = 0;

7724 #ià
MG_ENABLE_HTTP_URL_REWRITES


7725 cÚ¡ *
	g»wr™es
 = 
İts
->
u¾_»wr™es
;

7727 cÚ¡ *
	g»wr™es
 = "";

7729 
mg_¡r
 *
	ghh
 = 
mg_g‘_h‰p_h—d”
(
hm
, "Host");

7730 
mg_¡r
 
	ga
, 
	gb
;

7732 (
	g»wr™es
 = 
mg_Ãxt_comma_li¡_’Œy
(
»wr™es
, &
a
, &
b
)è!ğ
NULL
) {

7733 ià(
a
.
Ën
 > 1 &&‡.
p
[0] == '@') {

7735 ià(
hh
 !ğ
NULL
 && hh->
Ën
 =ğ
a
.len - 1 &&

7736 
mg_nÿ£cmp
(
a
.
p
 + 1, 
hh
->p,‡.
Ën
 - 1) == 0) {

7737 
roÙ
 = 
b
;

7742 
	gm©ch_Ën
 = 
mg_m©ch_´efix_n
(
a
, 
hm
->
uri
);

7743 ià(
	gm©ch_Ën
 > 0) {

7744 
	gfe_uri_¡¬t
 = 
hm
->
uri
.
p
 + 
m©ch_Ën
;

7745 ià(*
	gfe_uri_¡¬t
 =ğ'/' || 
fe_uri_¡¬t
 =ğ
ı_’d
) {

7747 } ià(*(
fe_uri_¡¬t
 - 1) == '/') {

7749 
fe_uri_¡¬t
--;

7754 
	groÙ
 = 
b
;

7760 ià(
	groÙ
.
	gp
 =ğ
NULL
) {

7761 #ià
MG_ENABLE_HTTP_WEBDAV


7762 ià(
İts
->
dav_docum’t_roÙ
 !ğ
NULL
 && 
mg_is_dav_»que¡
(&
hm
->
m‘hod
)) {

7763 
roÙ
.
p
 = 
İts
->
dav_docum’t_roÙ
;

7764 
	groÙ
.
	gËn
 = 
¡¾’
(
İts
->
dav_docum’t_roÙ
);

7768 
	groÙ
.
	gp
 = 
İts
->
docum’t_roÙ
;

7769 
	groÙ
.
	gËn
 = 
¡¾’
(
İts
->
docum’t_roÙ
);

7772 
as£¹
(
roÙ
.
p
 !ğ
NULL
 &&„oÙ.
Ën
 > 0);

7776 cÚ¡ *
	gu
 = 
fe_uri_¡¬t
 + 1;

7777 *
	gÍ
 = (*è
MG_MALLOC
(
roÙ
.
Ën
 + 
hm
->
uri
.len + 1);

7778 *
	gÍ_’d
 = 
Í
 + 
roÙ
.
Ën
 + 
hm
->
uri
.len + 1;

7779 *
	gp
 = 
Í
, *
	gps
;

7780 
	gexi¡s
 = 1;

7781 ià(
	gÍ
 =ğ
NULL
) {

7782 
ok
 = 0;

7783 
	gout
;

7785 
memıy
(
p
, 
roÙ
.p,„oÙ.
Ën
);

7786 
	gp
 +ğ
roÙ
.
Ën
;

7787 ià(*(
	gp
 - 1è=ğ
DIRSEP
è
p
--;

7788 *
	gp
 = '\0';

7789 
	gps
 = 
p
;

7792 
	gu
 <ğ
ı_’d
) {

7793 cÚ¡ *
Ãxt
 = 
u
;

7794 
mg_¡r
 
	gcompÚ’t
;

7795 ià(
	gexi¡s
) {

7796 
cs_¡©_t
 
	g¡
;

7797 
	gexi¡s
 = (
mg_¡©
(
Í
, &
¡
) == 0);

7798 ià(
	gexi¡s
 && 
S_ISREG
(
¡
.
¡_mode
)) {

7801 ià(*(
	gu
 - 1è=ğ'/'è
u
--;

7805 ià(
	gu
 >ğ
ı_’d
) ;

7806 
·r£_uri_compÚ’t
((cÚ¡ **è&
Ãxt
, 
ı_’d
, "/", &
compÚ’t
);

7807 ià(
	gcompÚ’t
.
	gËn
 > 0) {

7808 
	gËn
;

7809 
memmove
(
p
 + 1, 
compÚ’t
.p, compÚ’t.
Ën
);

7810 
	gËn
 = 
mg_u¾_decode
(
p
 + 1, 
compÚ’t
.
Ën
,… + 1, 
Í_’d
 -… - 1, 0);

7811 ià(
	gËn
 <= 0) {

7812 
ok
 = 0;

7815 
	gcompÚ’t
.
	gp
 = 
p
 + 1;

7816 
	gcompÚ’t
.
	gËn
 = 
Ën
;

7817 ià(
mg_vcmp
(&
compÚ’t
, ".") == 0) {

7819 } ià(
mg_vcmp
(&
compÚ’t
, "..") == 0) {

7820 
p
 > 
ps
 && *°!ğ
DIRSEP
)…--;

7821 *
	gp
 = '\0';

7823 
size_t
 
	gi
;

7824 #ifdeà
_WIN32


7826 
wch¬_t
 
	gbuf
[
MG_MAX_PATH
 * 2];

7827 ià(
to_wch¬
(
compÚ’t
.
p
, 
buf
, 
MG_MAX_PATH
) == 0) {

7828 
DBG
(("[%.*s] sm–l fuÂy", (è
compÚ’t
.
Ën
, compÚ’t.
p
));

7829 
	gok
 = 0;

7833 *
	gp
++ = 
DIRSEP
;

7835 
	gi
 = 0; i < 
	gcompÚ’t
.
	gËn
; i++, 
	gp
++) {

7836 ià(*
	gp
 =ğ'\0' || *
p
 =ğ
DIRSEP


7837 #ifdeà
_WIN32


7840 *
p
 == '/'

7843 
ok
 = 0;

7849 
	gu
 = 
Ãxt
;

7851 ià(
	gok
) {

7852 *
	gloÿl_·th
 = 
Í
;

7853 ià(
	gu
 > 
	gı_’d
èu = 
ı_’d
;

7854 
	g»mašd”
->
	gp
 = 
u
;

7855 
	g»mašd”
->
	gËn
 = 
ı_’d
 - 
u
;

7857 
MG_FREE
(
Í
);

7861 
	gout
:

7862 
LOG
(
LL_DEBUG
,

7863 ("'%.*s' -> '%s' + '%.*s'", (è
hm
->
uri
.
Ën
, hm->uri.
p
,

7864 *
loÿl_·th
 ? *loÿl_·th : "", (è
»mašd”
->
Ën
,„emašd”->
p
));

7865  
	gok
;

7868 
mg_g‘_mÚth_šdex
(cÚ¡ *
s
) {

7869 cÚ¡ *
	gmÚth_Çmes
[] = {"Jan", "Feb", "Mar", "Apr", "May", "Jun",

7871 
size_t
 
	gi
;

7873 
	gi
 = 0; i < 
ARRAY_SIZE
(
mÚth_Çmes
); i++)

7874 ià(!
¡rcmp
(
s
, 
mÚth_Çmes
[
i
])è (è
	gi
;

7879 
mg_num_Ë­_y—rs
(
y—r
) {

7880  
	gy—r
 / 4 - year / 100 + year / 400;

7884 
MG_INTERNAL
 
time_t
 
mg_·r£_d©e_¡ršg
(cÚ¡ *
d©‘ime
) {

7885 cÚ¡ 
	gdays_befÜe_mÚth
[] = {

7887 
	gmÚth_¡r
[32];

7888 
	g£cÚd
, 
	gmšu‹
, 
	ghour
, 
	gday
, 
	gmÚth
, 
	gy—r
, 
	gË­_days
, 
	gdays
;

7889 
time_t
 
	g»suÉ
 = (time_t) 0;

7891 ià(((
ssÿnf
(
d©‘ime
, "%d/%3s/%d %d:%d:%d", &
day
, 
mÚth_¡r
, &
y—r
, &
hour
,

7892 &
mšu‹
, &
£cÚd
) == 6) ||

7893 (
ssÿnf
(
d©‘ime
, "%d %3 %d %d:%d:%d", &
day
, 
mÚth_¡r
, &
y—r
, &
hour
,

7894 &
mšu‹
, &
£cÚd
) == 6) ||

7895 (
ssÿnf
(
d©‘ime
, "%*3s, %d %3 %d %d:%d:%d", &
day
, 
mÚth_¡r
, &
y—r
,

7896 &
hour
, &
mšu‹
, &
£cÚd
) == 6) ||

7897 (
ssÿnf
(
d©‘ime
, "%d-%3s-%d %d:%d:%d", &
day
, 
mÚth_¡r
, &
y—r
, &
hour
,

7898 &
mšu‹
, &
£cÚd
) == 6)) &&

7899 
y—r
 > 1970 && (
mÚth
 = 
mg_g‘_mÚth_šdex
(
mÚth_¡r
)) != -1) {

7900 
Ë­_days
 = 
mg_num_Ë­_y—rs
(
y—r
) - mg_num_leap_years(1970);

7901 
	gy—r
 -= 1970;

7902 
	gdays
 = 
y—r
 * 365 + 
days_befÜe_mÚth
[
mÚth
] + (
day
 - 1è+ 
Ë­_days
;

7903 
	g»suÉ
 = 
days
 * 24 * 3600 + 
hour
 * 3600 + 
mšu‹
 * 60 + 
£cÚd
;

7906  
	g»suÉ
;

7909 
MG_INTERNAL
 
mg_is_nÙ_modif›d
(
h‰p_mes§ge
 *
hm
, 
cs_¡©_t
 *
¡
) {

7910 
mg_¡r
 *
	ghdr
;

7911 ià((
	ghdr
 = 
mg_g‘_h‰p_h—d”
(
hm
, "If-NÚe-M©ch")è!ğ
NULL
) {

7912 
‘ag
[64];

7913 
mg_h‰p_cÚ¡ruù_‘ag
(
‘ag
, Óg), 
¡
);

7914  
mg_vÿ£cmp
(
hdr
, 
‘ag
) == 0;

7915 } ià((
	ghdr
 = 
mg_g‘_h‰p_h—d”
(
hm
, "If-Modif›d-Sšû")è!ğ
NULL
) {

7916  
¡
->
¡_mtime
 <ğ
mg_·r£_d©e_¡ršg
(
hdr
->
p
);

7922 
mg_h‰p_£nd_dige¡_auth_»que¡
(
mg_cÚÃùiÚ
 *
c
,

7923 cÚ¡ *
domaš
) {

7924 
mg_´štf
(
c
,

7929 
domaš
, (è
mg_time
());

7932 
mg_h‰p_£nd_İtiÚs
(
mg_cÚÃùiÚ
 *
nc
) {

7933 
mg_´štf
(
nc
, "%s",

7935 #ià
MG_ENABLE_HTTP_WEBDAV


7939 
	gnc
->
	gæags
 |ğ
MG_F_SEND_AND_CLOSE
;

7942 
mg_is_ü—tiÚ_»que¡
(cÚ¡ 
h‰p_mes§ge
 *
hm
) {

7943  
mg_vcmp
(&
hm
->
m‘hod
, "MKCOL") == 0 || mg_vcmp(&hm->method, "PUT") == 0;

7946 
MG_INTERNAL
 
mg_£nd_h‰p_fe
(
mg_cÚÃùiÚ
 *
nc
, *
·th
,

7947 cÚ¡ 
mg_¡r
 *
·th_šfo
,

7948 
h‰p_mes§ge
 *
hm
,

7949 
mg_£rve_h‰p_İts
 *
İts
) {

7950 
	gexi¡s
, 
	gis_dœeùÜy
, 
	gis_cgi
;

7951 #ià
MG_ENABLE_HTTP_WEBDAV


7952 
	gis_dav
 = 
mg_is_dav_»que¡
(&
hm
->
m‘hod
);

7954 
	gis_dav
 = 0;

7956 *
	gšdex_fe
 = 
NULL
;

7957 
cs_¡©_t
 
	g¡
;

7959 
	gexi¡s
 = (
mg_¡©
(
·th
, &
¡
) == 0);

7960 
	gis_dœeùÜy
 = 
exi¡s
 && 
S_ISDIR
(
¡
.
¡_mode
);

7962 ià(
	gis_dœeùÜy
)

7963 
mg_fšd_šdex_fe
(
·th
, 
İts
->
šdex_fes
, &
šdex_fe
, &
¡
);

7965 
	gis_cgi
 =

7966 (
mg_m©ch_´efix
(
İts
->
cgi_fe_·‰”n
, 
¡¾’
(opts->cgi_file_pattern),

7967 
šdex_fe
 ? index_f: 
·th
) > 0);

7969 
LOG
(
LL_DEBUG
,

7970 ("%°%.* [%s]ƒxi¡s=%d is_dœ=%d is_dav=%d is_cgi=%d index=%s", 
nc
,

7971 (è
hm
->
m‘hod
.
Ën
, hm->m‘hod.
p
, 
·th
, 
exi¡s
, 
is_dœeùÜy
, 
is_dav
,

7972 
is_cgi
, 
šdex_fe
 ? index_file : ""));

7974 ià(
	gis_dœeùÜy
 && 
	ghm
->
	guri
.
	gp
[
hm
->
uri
.
Ën
 - 1] !ğ'/' && !
is_dav
) {

7975 
mg_´štf
(
nc
,

7978 (è
hm
->
uri
.
Ën
, hm->uri.
p
);

7979 
MG_FREE
(
šdex_fe
);

7984 ià(
	g·th_šfo
->
	gËn
 > 0 && !
	gis_cgi
) {

7985 
mg_h‰p_£nd_”rÜ
(
nc
, 501, 
NULL
);

7986 
MG_FREE
(
šdex_fe
);

7990 ià(
	gis_dav
 && 
	gİts
->
	gdav_docum’t_roÙ
 =ğ
NULL
) {

7991 
mg_h‰p_£nd_”rÜ
(
nc
, 501, 
NULL
);

7992 } ià(!
mg_h‰p_is_authÜized
(
hm
, 
mg_mk_¡r
(
·th
), 
is_dœeùÜy
,

7993 
İts
->
auth_domaš
, o±s->
glob®_auth_fe
,

7995 !
mg_h‰p_is_authÜized
(
hm
, 
mg_mk_¡r
(
·th
), 
is_dœeùÜy
,

7996 
İts
->
auth_domaš
,

7997 
İts
->
³r_dœeùÜy_auth_fe
, 0)) {

7998 
mg_h‰p_£nd_dige¡_auth_»que¡
(
nc
, 
İts
->
auth_domaš
);

7999 } ià(
	gis_cgi
) {

8000 #ià
MG_ENABLE_HTTP_CGI


8001 
mg_hªdË_cgi
(
nc
, 
šdex_fe
 ? index_f: 
·th
, 
·th_šfo
, 
hm
, 
İts
);

8003 
mg_h‰p_£nd_”rÜ
(
nc
, 501, 
NULL
);

8005 } ià((!
	gexi¡s
 ||

8006 
mg_is_fe_hidd’
(
·th
, 
İts
, 0 )) &&

8007 !
mg_is_ü—tiÚ_»que¡
(
hm
)) {

8008 
mg_h‰p_£nd_”rÜ
(
nc
, 404, 
NULL
);

8009 #ià
MG_ENABLE_HTTP_WEBDAV


8010 } ià(!
mg_vcmp
(&
hm
->
m‘hod
, "PROPFIND")) {

8011 
mg_hªdË_´İfšd
(
nc
, 
·th
, &
¡
, 
hm
, 
İts
);

8012 #ià!
MG_DISABLE_DAV_AUTH


8013 } ià(
	gis_dav
 && (
	gİts
->
	gdav_auth_fe
 =ğ
NULL
 ||

8014 (
¡rcmp
(
İts
->
dav_auth_fe
, "-") != 0 &&

8015 !
mg_h‰p_is_authÜized
(
hm
, 
mg_mk_¡r
(
·th
),

8016 
is_dœeùÜy
, 
İts
->
auth_domaš
,

8017 
İts
->
dav_auth_fe
, 1)))) {

8018 
mg_h‰p_£nd_dige¡_auth_»que¡
(
nc
, 
İts
->
auth_domaš
);

8020 } ià(!
mg_vcmp
(&
hm
->
m‘hod
, "MKCOL")) {

8021 
mg_hªdË_mkcŞ
(
nc
, 
·th
, 
hm
);

8022 } ià(!
mg_vcmp
(&
hm
->
m‘hod
, "DELETE")) {

8023 
mg_hªdË_d–‘e
(
nc
, 
İts
, 
·th
);

8024 } ià(!
mg_vcmp
(&
hm
->
m‘hod
, "PUT")) {

8025 
mg_hªdË_put
(
nc
, 
·th
, 
hm
);

8026 } ià(!
mg_vcmp
(&
hm
->
m‘hod
, "MOVE")) {

8027 
mg_hªdË_move
(
nc
, 
İts
, 
·th
, 
hm
);

8028 #ià
MG_ENABLE_FAKE_DAVLOCK


8029 } ià(!
mg_vcmp
(&
hm
->
m‘hod
, "LOCK")) {

8030 
mg_hªdË_lock
(
nc
, 
·th
);

8033 } ià(!
mg_vcmp
(&
hm
->
m‘hod
, "OPTIONS")) {

8034 
mg_h‰p_£nd_İtiÚs
(
nc
);

8035 } ià(
	gis_dœeùÜy
 && 
	gšdex_fe
 =ğ
NULL
) {

8036 #ià
MG_ENABLE_DIRECTORY_LISTING


8037 ià(
¡rcmp
(
İts
->
’abË_dœeùÜy_li¡šg
, "yes") == 0) {

8038 
mg_£nd_dœeùÜy_li¡šg
(
nc
, 
·th
, 
hm
, 
İts
);

8040 
mg_h‰p_£nd_”rÜ
(
nc
, 403, 
NULL
);

8043 
mg_h‰p_£nd_”rÜ
(
nc
, 501, 
NULL
);

8045 } ià(
mg_is_nÙ_modif›d
(
hm
, &
¡
)) {

8046 
mg_h‰p_£nd_”rÜ
(
nc
, 304, "Not Modified");

8048 
mg_h‰p_£rve_fe2
(
nc
, 
šdex_fe
 ? index_f: 
·th
, 
hm
, 
İts
);

8050 
MG_FREE
(
šdex_fe
);

8053 
mg_£rve_h‰p
(
mg_cÚÃùiÚ
 *
nc
, 
h‰p_mes§ge
 *
hm
,

8054 
mg_£rve_h‰p_İts
 
İts
) {

8055 *
	g·th
 = 
NULL
;

8056 
mg_¡r
 *
	ghdr
, 
	g·th_šfo
;

8057 
ušt32_t
 
	g»mÙe_
 = 
Áohl
(*(ušt32_ˆ*è&
nc
->
§
.
sš
.
sš_addr
);

8059 ià(
mg_check__aş
(
İts
.
_aş
, 
»mÙe_
) != 1) {

8061 
mg_h‰p_£nd_”rÜ
(
nc
, 403, 
NULL
);

8062 
	gnc
->
	gæags
 |ğ
MG_F_SEND_AND_CLOSE
;

8066 #ià
MG_ENABLE_HTTP_URL_REWRITES


8067 ià(
mg_h‰p_hªdË_fÜw¬dšg
(
nc
, 
hm
, &
İts
)) {

8071 ià(
mg_h‰p_£nd_pÜt_ba£d_»dœeù
(
nc
, 
hm
, &
İts
)) {

8076 ià(
	gİts
.
	gdocum’t_roÙ
 =ğ
NULL
) {

8077 
İts
.
docum’t_roÙ
 = ".";

8079 ià(
	gİts
.
	g³r_dœeùÜy_auth_fe
 =ğ
NULL
) {

8080 
İts
.
³r_dœeùÜy_auth_fe
 = ".htpasswd";

8082 ià(
	gİts
.
	g’abË_dœeùÜy_li¡šg
 =ğ
NULL
) {

8083 
İts
.
’abË_dœeùÜy_li¡šg
 = "yes";

8085 ià(
	gİts
.
	gcgi_fe_·‰”n
 =ğ
NULL
) {

8086 
İts
.
cgi_fe_·‰”n
 = "**.cgi$|**.php$";

8088 ià(
	gİts
.
	gssi_·‰”n
 =ğ
NULL
) {

8089 
İts
.
ssi_·‰”n
 = "**.shtml$|**.shtm$";

8091 ià(
	gİts
.
	gšdex_fes
 =ğ
NULL
) {

8092 
İts
.
šdex_fes
 = "index.html,index.htm,index.shtml,index.cgi,index.php";

8095 ià(!
mg_nÜm®ize_uri_·th
(&
hm
->
uri
, &hm->uri)) {

8096 
mg_h‰p_£nd_”rÜ
(
nc
, 400, 
NULL
);

8099 ià(
mg_uri_to_loÿl_·th
(
hm
, &
İts
, &
·th
, &
·th_šfo
) == 0) {

8100 
mg_h‰p_£nd_”rÜ
(
nc
, 404, 
NULL
);

8103 
mg_£nd_h‰p_fe
(
nc
, 
·th
, &
·th_šfo
, 
hm
, &
İts
);

8105 
MG_FREE
(
·th
);

8106 
	g·th
 = 
NULL
;

8109 ià(
mg_vcmp
(&
hm
->
´Ùo
, "HTTP/1.1") != 0 ||

8110 ((
hdr
 = 
mg_g‘_h‰p_h—d”
(
hm
, "CÚÃùiÚ")è!ğ
NULL
 &&

8111 
mg_vcmp
(
hdr
, "keep-alive") != 0)) {

8113 
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

8118 #ià
MG_ENABLE_HTTP_STREAMING_MULTIPART


8119 
mg_fe_u¶ßd_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
, *
ev_d©a
,

8120 
mg_fu_âame_â
 
loÿl_Çme_â


8121 
MG_UD_ARG
(*
u£r_d©a
)) {

8122 
	gev
) {

8123 
	gMG_EV_HTTP_PART_BEGIN
: {

8124 
mg_h‰p_muÉ¬t_·¹
 *
mp
 =

8125 (
mg_h‰p_muÉ¬t_·¹
 *è
ev_d©a
;

8126 
fe_u¶ßd_¡©e
 *
	gfus
 =

8127 (
fe_u¶ßd_¡©e
 *è
MG_CALLOC
(1, (*
fus
));

8128 
mg_¡r
 
	glâ
 = 
loÿl_Çme_â
(
nc
, 
mg_mk_¡r
(
mp
->
fe_Çme
));

8129 
	gmp
->
	gu£r_d©a
 = 
NULL
;

8130 ià(
	glâ
.
	gp
 =ğ
NULL
 || 
lâ
.
Ën
 == 0) {

8131 
LOG
(
LL_ERROR
, ("%°NÙ‡ÎowedØu¶ßd %s", 
nc
, 
mp
->
fe_Çme
));

8132 
mg_´štf
(
nc
,

8137 
mp
->
fe_Çme
);

8138 
	gnc
->
	gæags
 |ğ
MG_F_SEND_AND_CLOSE
;

8141 
	gfus
->
	glâ
 = (*è
MG_MALLOC
(
lâ
.
Ën
 + 1);

8142 
memıy
(
fus
->
lâ
,†â.
p
,†â.
Ën
);

8143 
	gfus
->
	glâ
[
lâ
.
Ën
] = '\0';

8144 ià(
	glâ
.
	gp
 !ğ
mp
->
fe_Çme
è
MG_FREE
((*è
lâ
.
p
);

8145 
LOG
(
LL_DEBUG
,

8146 ("%°Reûivšg f% -> %s", 
nc
, 
mp
->
fe_Çme
, 
fus
->
lâ
));

8147 
	gfus
->
	gå
 = 
mg_fİ’
(
fus
->
lâ
, "w");

8148 ià(
	gfus
->
	gå
 =ğ
NULL
) {

8149 
mg_´štf
(
nc
,

8153 
LOG
(
LL_ERROR
, ("FaedØİ’ %s: %d\n", 
fus
->
lâ
, 
mg_g‘_”ºo
()));

8154 
mg_´štf
(
nc
, "FaedØİ’ %s: %d\n", 
fus
->
lâ
, 
mg_g‘_”ºo
());

8159 
	gmp
->
	gu£r_d©a
 = (*è
fus
;

8162 
	gMG_EV_HTTP_PART_DATA
: {

8163 
mg_h‰p_muÉ¬t_·¹
 *
mp
 =

8164 (
mg_h‰p_muÉ¬t_·¹
 *è
ev_d©a
;

8165 
fe_u¶ßd_¡©e
 *
	gfus
 =

8166 (
fe_u¶ßd_¡©e
 *è
mp
->
u£r_d©a
;

8167 ià(
	gfus
 =ğ
NULL
 || 
fus
->
å
 == NULL) ;

8168 ià(
mg_fwr™e
(
mp
->
d©a
.
p
, 1, mp->d©a.
Ën
, 
fus
->
å
) != mp->data.len) {

8169 
LOG
(
LL_ERROR
, ("FaedØwr™tØ%s: %d, wrÙ%d", 
fus
->
lâ
,

8170 
mg_g‘_”ºo
(), (è
fus
->
num_»cd
));

8171 ià(
mg_g‘_”ºo
(è=ğ
ENOSPC


8172 #ifdeà
SPIFFS_ERR_FULL


8173 || 
mg_g‘_”ºo
(è=ğ
SPIFFS_ERR_FULL


8176 
mg_´štf
(
nc
,

8180 
mg_´štf
(
nc
, "Failedo writeo %s:‚o space†eft; wrote %d\r\n",

8181 
fus
->
lâ
, (èfus->
num_»cd
);

8183 
mg_´štf
(
nc
,

8187 
mg_´štf
(
nc
, "FaedØwr™tØ%s: %d, wrÙ%d", 
mp
->
fe_Çme
,

8188 
mg_g‘_”ºo
(), (è
fus
->
num_»cd
);

8190 
fşo£
(
fus
->
å
);

8191 
»move
(
fus
->
lâ
);

8192 
	gfus
->
	gå
 = 
NULL
;

8198 
	gfus
->
	gnum_»cd
 +ğ
mp
->
d©a
.
Ën
;

8199 
LOG
(
LL_DEBUG
, ("%°»c'd %d by‹s, %dÙ®", 
nc
, (è
mp
->
d©a
.
Ën
,

8200 (è
fus
->
num_»cd
));

8203 
	gMG_EV_HTTP_PART_END
: {

8204 
mg_h‰p_muÉ¬t_·¹
 *
mp
 =

8205 (
mg_h‰p_muÉ¬t_·¹
 *è
ev_d©a
;

8206 
fe_u¶ßd_¡©e
 *
	gfus
 =

8207 (
fe_u¶ßd_¡©e
 *è
mp
->
u£r_d©a
;

8208 ià(
	gfus
 =ğ
NULL
) ;

8209 ià(
	gmp
->
	g¡©us
 >ğ0 && 
fus
->
å
 !ğ
NULL
) {

8210 
LOG
(
LL_DEBUG
, ("%°U¶ßded % (%s), %d by‹s", 
nc
, 
mp
->
fe_Çme
,

8211 
fus
->
lâ
, (èfus->
num_»cd
));

8212 
mg_´štf
(
nc
,

8217 
mp
->
fe_Çme
, (è
fus
->
num_»cd
);

8219 
LOG
(
LL_ERROR
, ("FaedØ¡Ü% (%s)", 
mp
->
fe_Çme
, 
fus
->
lâ
));

8225 ià(
	gfus
->
	gå
 !ğ
NULL
è
fşo£
(
fus
->
å
);

8226 
MG_FREE
(
fus
->
lâ
);

8227 
MG_FREE
(
fus
);

8228 
	gmp
->
	gu£r_d©a
 = 
NULL
;

8229 
	gnc
->
	gæags
 |ğ
MG_F_SEND_AND_CLOSE
;

8234 #ià
MG_ENABLE_CALLBACK_USERDATA


8235 (è
	gu£r_d©a
;

8242 
mg_cÚÃùiÚ
 *
mg_cÚÃù_h‰p_ba£
(

8243 
mg_mgr
 *
mgr
, 
MG_CB
(
mg_ev’t_hªdËr_t
 
ev_hªdËr
, *
u£r_d©a
),

8244 
mg_cÚÃù_İts
 
İts
, cÚ¡ *
scheme1
, cÚ¡ *
scheme2
,

8245 cÚ¡ *
scheme_s¦1
, cÚ¡ *
scheme_s¦2
, cÚ¡ *
u¾
,

8246 
mg_¡r
 *
·th
, mg_¡¸*
u£r_šfo
, mg_¡¸*
ho¡
) {

8247 
mg_cÚÃùiÚ
 *
	gnc
 = 
NULL
;

8248 
	gpÜt_i
 = 0;

8249 
	gu£_s¦
 = 0;

8250 
mg_¡r
 
	gscheme
, 
	gqu”y
, 
	gäagm’t
;

8251 
	gcÚn_addr_buf
[2];

8252 *
	gcÚn_addr
 = 
cÚn_addr_buf
;

8254 ià(
mg_·r£_uri
(
mg_mk_¡r
(
u¾
), &
scheme
, 
u£r_šfo
, 
ho¡
, &
pÜt_i
, 
·th
,

8255 &
qu”y
, &
äagm’t
) != 0) {

8256 
MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, "cannot…arse url");

8257 
	gout
;

8261 ià(
	gqu”y
.
	gËn
 > 0è
	g·th
->ËÀ+ğ
qu”y
.
Ën
 + 1;

8263 ià(
	gscheme
.
	gËn
 =ğ0 || 
mg_vcmp
(&
scheme
, 
scheme1
) == 0 ||

8264 (
scheme2
 !ğ
NULL
 && 
mg_vcmp
(&
scheme
, scheme2) == 0)) {

8265 
u£_s¦
 = 0;

8266 ià(
	gpÜt_i
 =ğ0è
pÜt_i
 = 80;

8267 } ià(
mg_vcmp
(&
scheme
, 
scheme_s¦1
) == 0 ||

8268 (
scheme2
 !ğ
NULL
 && 
mg_vcmp
(&
scheme
, 
scheme_s¦2
) == 0)) {

8269 
u£_s¦
 = 1;

8270 ià(
	gpÜt_i
 =ğ0è
pÜt_i
 = 443;

8272 
	gout
;

8275 
mg_a¥rštf
(&
cÚn_addr
, (
cÚn_addr_buf
), "tcp://%.*s:%u",

8276 (è
ho¡
->
Ën
, ho¡->
p
, 
pÜt_i
);

8277 ià(
	gcÚn_addr
 =ğ
NULL
è
out
;

8279 
LOG
(
LL_DEBUG
, ("% u£_s¦? %d %s", 
u¾
, 
u£_s¦
, 
cÚn_addr
));

8280 ià(
	gu£_s¦
) {

8281 #ià
MG_ENABLE_SSL


8287 ià(
	gİts
.
	gs¦_ÿ_û¹
 =ğ
NULL
) {

8288 
İts
.
s¦_ÿ_û¹
 = "*";

8291 
MG_SET_PTRPTR
(
İts
.
”rÜ_¡ršg
, "ssl is disabled");

8292 
	gout
;

8296 ià((
	gnc
 = 
mg_cÚÃù_İt
(
mgr
, 
cÚn_addr
, 
MG_CB
(
ev_hªdËr
, 
u£r_d©a
),

8297 
İts
)è!ğ
NULL
) {

8298 
mg_£t_´ÙocŞ_h‰p_websock‘
(
nc
);

8301 
	gout
:

8302 ià(
cÚn_addr
 !ğ
NULL
 && cÚn_add¸!ğ
cÚn_addr_buf
è
MG_FREE
(conn_addr);

8303  
	gnc
;

8306 
mg_cÚÃùiÚ
 *
mg_cÚÃù_h‰p_İt
(

8307 
mg_mgr
 *
mgr
, 
MG_CB
(
mg_ev’t_hªdËr_t
 
ev_hªdËr
, *
u£r_d©a
),

8308 
mg_cÚÃù_İts
 
İts
, cÚ¡ *
u¾
, cÚ¡ *
exŒa_h—d”s
,

8309 cÚ¡ *
po¡_d©a
) {

8310 
mg_¡r
 
	gu£r
 = 
MG_NULL_STR
, 
	gnuÎ_¡r
 = MG_NULL_STR;

8311 
mg_¡r
 
	gho¡
 = 
MG_NULL_STR
, 
	g·th
 = MG_NULL_STR;

8312 
mbuf
 
	gauth
;

8313 
mg_cÚÃùiÚ
 *
	gnc
 =

8314 
mg_cÚÃù_h‰p_ba£
(
mgr
, 
MG_CB
(
ev_hªdËr
, 
u£r_d©a
), 
İts
, "http",

8315 
NULL
, "h‰ps", NULL, 
u¾
, &
·th
, &
u£r
, &
ho¡
);

8317 ià(
	gnc
 =ğ
NULL
) {

8318  
NULL
;

8321 
mbuf_š™
(&
auth
, 0);

8322 ià(
	gu£r
.
	gËn
 > 0) {

8323 
mg_basic_auth_h—d”
(
u£r
, 
nuÎ_¡r
, &
auth
);

8326 ià(
	gpo¡_d©a
 =ğ
NULL
è
po¡_d©a
 = "";

8327 ià(
	gexŒa_h—d”s
 =ğ
NULL
è
exŒa_h—d”s
 = "";

8328 ià(
	g·th
.
	gËn
 =ğ0è
·th
 = 
mg_mk_¡r
("/");

8330 
mg_´štf
(
nc
, "% %.* HTTP/1.1\r\nHo¡: %.*s\r\nCÚ‹Á-L’gth: %" 
SIZE_T_FMT


8332 (
po¡_d©a
[0] =ğ'\0' ? "GET" : "POST"), (è
·th
.
Ën
,…©h.
p
,

8333 (è(
·th
.
p
 - 
ho¡
.p), ho¡.p, 
¡¾’
(
po¡_d©a
), (è
auth
.
Ën
,

8334 (
auth
.
buf
 =ğ
NULL
 ? "" :‡uth.buf), 
exŒa_h—d”s
, 
po¡_d©a
);

8336 
mbuf_ä“
(&
auth
);

8337  
	gnc
;

8340 
mg_cÚÃùiÚ
 *
mg_cÚÃù_h‰p
(

8341 
mg_mgr
 *
mgr
, 
MG_CB
(
mg_ev’t_hªdËr_t
 
ev_hªdËr
, *
u£r_d©a
),

8342 cÚ¡ *
u¾
, cÚ¡ *
exŒa_h—d”s
, cÚ¡ *
po¡_d©a
) {

8343 
mg_cÚÃù_İts
 
	gİts
;

8344 
mem£t
(&
İts
, 0, (opts));

8345  
mg_cÚÃù_h‰p_İt
(
mgr
, 
MG_CB
(
ev_hªdËr
, 
u£r_d©a
), 
İts
, 
u¾
,

8346 
exŒa_h—d”s
, 
po¡_d©a
);

8349 
size_t
 
mg_·r£_muÉ¬t
(cÚ¡ *
buf
, size_ˆ
buf_Ën
, *
v¬_Çme
,

8350 
size_t
 
v¬_Çme_Ën
, *
fe_Çme
,

8351 
size_t
 
fe_Çme_Ën
, cÚ¡ **
d©a
,

8352 
size_t
 *
d©a_Ën
) {

8353 cÚ¡ 
	gcd
[] = "Content-Disposition: ";

8354 
size_t
 
	ghl
, 
	gbl
, 
	gn
, 
	gÎ
, 
	gpos
, 
	gcdl
 = (
cd
) - 1;

8356 ià(
	gbuf
 =ğ
NULL
 || 
buf_Ën
 <= 0)  0;

8357 ià((
	ghl
 = 
mg_h‰p_g‘_»que¡_Ën
(
buf
, 
buf_Ën
)) <= 0)  0;

8358 ià(
	gbuf
[0] !ğ'-' || 
buf
[1] != '-' || buf[2] == '\n')  0;

8361 
	gbl
 = 
mg_g‘_lše_Ën
(
buf
, 
buf_Ën
);

8364 
	gv¬_Çme
[0] = 
fe_Çme
[0] = '\0';

8365 
	gn
 = 
bl
; (
	gÎ
 = 
mg_g‘_lše_Ën
(
buf
 + 
n
, 
hl
 -‚)è> 0;‚ +ğ
Î
) {

8366 ià(
mg_nÿ£cmp
(
cd
, 
buf
 + 
n
, 
cdl
) == 0) {

8367 
mg_¡r
 
h—d”
;

8368 
	gh—d”
.
	gp
 = 
buf
 + 
n
 + 
cdl
;

8369 
	gh—d”
.
	gËn
 = 
Î
 - (
cdl
 + 2);

8370 
mg_h‰p_·r£_h—d”
(&
h—d”
, "Çme", 
v¬_Çme
, 
v¬_Çme_Ën
);

8371 
mg_h‰p_·r£_h—d”
(&
h—d”
, "f’ame", 
fe_Çme
, 
fe_Çme_Ën
);

8376 
	gpos
 = 
hl
;…o + (
	gbl
 - 2è< 
	gbuf_Ën
;…os++) {

8377 ià(
	gbuf
[
pos
] =ğ'-' && !
¡ºcmp
(
buf
, &buf[pos], 
bl
 - 2)) {

8378 ià(
	gd©a_Ën
 !ğ
NULL
è*
d©a_Ën
 = (
pos
 - 2è- 
hl
;

8379 ià(
	gd©a
 !ğ
NULL
è*
d©a
 = 
buf
 + 
hl
;

8380  
	gpos
;

8387 
mg_»gi¡”_h‰p_’dpošt_İt
(
mg_cÚÃùiÚ
 *
nc
,

8388 cÚ¡ *
uri_·th
,

8389 
mg_ev’t_hªdËr_t
 
hªdËr
,

8390 
mg_h‰p_’dpošt_İts
 
İts
) {

8391 
mg_h‰p_´Ùo_d©a
 *
	gpd
 = 
NULL
;

8392 
mg_h‰p_’dpošt
 *
	gÃw_•
 = 
NULL
;

8394 ià(
	gnc
 =ğ
NULL
) ;

8395 
	gÃw_•
 = (
mg_h‰p_’dpošt
 *è
MG_CALLOC
(1, (*
Ãw_•
));

8396 ià(
	gÃw_•
 =ğ
NULL
) ;

8398 
	gpd
 = 
mg_h‰p_g‘_´Ùo_d©a
(
nc
);

8399 
	gÃw_•
->
	guri_·‰”n
 = 
mg_¡rdup
(
mg_mk_¡r
(
uri_·th
));

8400 ià(
	gİts
.
	gauth_domaš
 !ğ
NULL
 && 
İts
.
auth_fe
 != NULL) {

8401 
Ãw_•
->
auth_domaš
 = 
¡rdup
(
İts
.auth_domain);

8402 
	gÃw_•
->
	gauth_fe
 = 
¡rdup
(
İts
.
auth_fe
);

8404 
	gÃw_•
->
	ghªdËr
 = 
hªdËr
;

8405 #ià
MG_ENABLE_CALLBACK_USERDATA


8406 
	gÃw_•
->
	gu£r_d©a
 = 
İts
.
u£r_d©a
;

8408 
	gÃw_•
->
	gÃxt
 = 
pd
->
’dpošts
;

8409 
	gpd
->
	g’dpošts
 = 
Ãw_•
;

8412 
mg_h‰p_ÿÎ_’dpošt_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
,

8413 
h‰p_mes§ge
 *
hm
) {

8414 
mg_h‰p_´Ùo_d©a
 *
	gpd
 = 
mg_h‰p_g‘_´Ùo_d©a
(
nc
);

8415 *
	gu£r_d©a
 = 
nc
->
u£r_d©a
;

8417 ià(
	gev
 =ğ
MG_EV_HTTP_REQUEST


8418 #ià
MG_ENABLE_HTTP_STREAMING_MULTIPART


8419 || 
ev
 =ğ
MG_EV_HTTP_MULTIPART_REQUEST


8422 
mg_h‰p_’dpošt
 *
•
 =

8423 
mg_h‰p_g‘_’dpošt_hªdËr
(
nc
->
li¡’”
, &
hm
->
uri
);

8424 ià(
	g•
 !ğ
NULL
) {

8425 #ià
MG_ENABLE_FILESYSTEM
 && !
MG_DISABLE_HTTP_DIGEST_AUTH


8426 ià(!
mg_h‰p_is_authÜized
(
hm
, hm->
uri
, 0 ,

8427 
•
->
auth_domaš
,ƒp->
auth_fe
,

8429 
mg_h‰p_£nd_dige¡_auth_»que¡
(
nc
, 
•
->
auth_domaš
);

8433 
	gpd
->
	g’dpošt_hªdËr
 = 
•
->
hªdËr
;

8434 #ià
MG_ENABLE_CALLBACK_USERDATA


8435 
	gu£r_d©a
 = 
•
->
u£r_d©a
;

8439 
mg_ÿÎ
(
nc
, 
pd
->
’dpošt_hªdËr
 ?…d->’dpošt_hªdË¸:‚c->
hªdËr
,

8440 
u£r_d©a
, 
ev
, 
hm
);

8443 
mg_»gi¡”_h‰p_’dpošt
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
uri_·th
,

8444 
MG_CB
(
mg_ev’t_hªdËr_t
 
hªdËr
,

8445 *
u£r_d©a
)) {

8446 
mg_h‰p_’dpošt_İts
 
	gİts
;

8447 
mem£t
(&
İts
, 0, (opts));

8448 #ià
MG_ENABLE_CALLBACK_USERDATA


8449 
	gİts
.
	gu£r_d©a
 = 
u£r_d©a
;

8451 
mg_»gi¡”_h‰p_’dpošt_İt
(
nc
, 
uri_·th
, 
hªdËr
, 
İts
);

8455 #ifdeà
MG_MODULE_LINES


8463 #iâdeà
_WIN32


8464 
	~<sigÇl.h
>

8467 #ià
MG_ENABLE_HTTP
 && 
MG_ENABLE_HTTP_CGI


8469 #iâdeà
MG_MAX_CGI_ENVIR_VARS


8470 
	#MG_MAX_CGI_ENVIR_VARS
 64

	)

8473 #iâdeà
MG_ENV_EXPORT_TO_CGI


8474 
	#MG_ENV_EXPORT_TO_CGI
 "MONGOOSE_CGI"

	)

8477 
	#MG_F_HTTP_CGI_PARSE_HEADERS
 
MG_F_USER_1


	)

8489 
	smg_cgi_’v_block
 {

8490 
mg_cÚÃùiÚ
 *
	gnc
;

8491 
	gbuf
[
MG_CGI_ENVIRONMENT_SIZE
];

8492 cÚ¡ *
	gv¬s
[
MG_MAX_CGI_ENVIR_VARS
];

8493 
	gËn
;

8494 
	gnv¬s
;

8497 #ifdeà
_WIN32


8498 
	smg_th»ad·¿m
 {

8499 
sock_t
 
	gs
;

8500 
HANDLE
 
	ghPe
;

8503 
mg_wa™_uÁ_»ady
(
sock_t
 
sock
, 
fÜ_»ad
) {

8504 
fd_£t
 
	g£t
;

8505 
FD_ZERO
(&
£t
);

8506 
FD_SET
(
sock
, &
£t
);

8507  
£Ëù
(
sock
 + 1, 
fÜ_»ad
 ? &
£t
 : 0, for_read ? 0 : &set, 0, 0) == 1;

8510 *
mg_push_to_¡dš
(*
¬g
) {

8511 
mg_th»ad·¿m
 *
	g
 = (mg_th»ad·¿m *è
¬g
;

8512 
	gn
, 
	g£Á
, 
	g¡İ
 = 0;

8513 
DWORD
 
	gk
;

8514 
	gbuf
[
BUFSIZ
];

8516 !
	g¡İ
 && 
mg_wa™_uÁ_»ady
(

->
s
, 1) &&

8517 (
	gn
 = 
»cv
(

->
s
, 
buf
, (buf), 0)) > 0) {

8518 ià(
	gn
 =ğ-1 && 
G‘La¡E¼Ü
(è=ğ
WSAEWOULDBLOCK
) ;

8519 
	g£Á
 = 0; !
	g¡İ
 && s’ˆ< 
	gn
; s’ˆ+ğ
k
) {

8520 ià(!
Wr™eFe
(

->
hPe
, 
buf
 + 
£Á
, 
n
 - s’t, &
k
, 0)è
¡İ
 = 1;

8523 
DBG
(("%s", "FORWARED EVERYTHING TO CGI"));

8524 
Clo£HªdË
(

->
hPe
);

8525 
MG_FREE
(

);

8526  
	gNULL
;

8529 *
mg_puÎ_äom_¡dout
(*
¬g
) {

8530 
mg_th»ad·¿m
 *
	g
 = (mg_th»ad·¿m *è
¬g
;

8531 
	gk
 = 0, 
	g¡İ
 = 0;

8532 
DWORD
 
	gn
, 
	g£Á
;

8533 
	gbuf
[
BUFSIZ
];

8535 !
	g¡İ
 && 
R—dFe
(

->
hPe
, 
buf
, (buf), &
n
, 
NULL
)) {

8536 
	g£Á
 = 0; !
	g¡İ
 && s’ˆ< 
	gn
; s’ˆ+ğ
k
) {

8537 ià(
mg_wa™_uÁ_»ady
(

->
s
, 0) &&

8538 (
k
 = 
£nd
(

->
s
, 
buf
 + 
£Á
, 
n
 - sent, 0)) <= 0)

8539 
¡İ
 = 1;

8542 
DBG
(("%s", "EOF FROM CGI"));

8543 
Clo£HªdË
(

->
hPe
);

8544 
shutdown
(

->
s
, 2);

8545 
şo£sock‘
(

->
s
);

8546 
MG_FREE
(

);

8547  
	gNULL
;

8549 #ià
MG_ENABLE_THREADS


8550 
mg_¥awn_¡dio_th»ad
(
sock_t
 
sock
, 
HANDLE
 
hPe
,

8551 *(*
func
)(*)) {

8552 
mg_th»ad·¿m
 *
	g
 = (mg_th»ad·¿m *è
MG_MALLOC
((*

));

8553 ià(
	g
 !ğ
NULL
) {

8554 

->
s
 = 
sock
;

8555 
	g
->
	ghPe
 = 
hPe
;

8556 
mg_¡¬t_th»ad
(
func
, 

);

8560 
mg_abs_·th
(cÚ¡ *
utf8_·th
, *
abs_·th
, 
size_t
 
Ën
) {

8561 
wch¬_t
 
	gbuf
[
MG_MAX_PATH
], 
	gbuf2
[MG_MAX_PATH];

8562 
to_wch¬
(
utf8_·th
, 
buf
, 
ARRAY_SIZE
(buf));

8563 
G‘FuÎP©hNameW
(
buf
, 
ARRAY_SIZE
(
buf2
), buf2, 
NULL
);

8564 
WideCh¬ToMuÉiBy‹
(
CP_UTF8
, 0, 
buf2
, 
wc¦’
(buf2è+ 1, 
abs_·th
, 
Ën
, 0, 0);

8567 
mg_¡¬t_´oûss
(cÚ¡ *
š‹½
, cÚ¡ *
cmd
,

8568 cÚ¡ *
’v
, cÚ¡ *
’vp
[],

8569 cÚ¡ *
dœ
, 
sock_t
 
sock
) {

8570 
STARTUPINFOW
 
	gsi
;

8571 
PROCESS_INFORMATION
 
	gpi
;

8572 
HANDLE
 
	ga
[2], 
	gb
[2], 
	gme
 = 
G‘Cu¼’tProûss
();

8573 
wch¬_t
 
	gwcmd
[
MG_MAX_PATH
], 
	gfuÎ_dœ
[MG_MAX_PATH];

8574 
	gbuf
[
MG_MAX_PATH
], 
	gbuf2
[MG_MAX_PATH], 
	gbuf5
[MG_MAX_PATH],

8575 
	gbuf4
[
MG_MAX_PATH
], 
	gcmdlše
[MG_MAX_PATH];

8576 
DWORD
 
	gæags
 = 
DUPLICATE_CLOSE_SOURCE
 | 
DUPLICATE_SAME_ACCESS
;

8577 
FILE
 *
	gå
;

8579 
mem£t
(&
si
, 0, (si));

8580 
mem£t
(&
pi
, 0, (pi));

8582 
	gsi
.
	gcb
 = (
si
);

8583 
	gsi
.
	gdwFÏgs
 = 
STARTF_USESTDHANDLES
 | 
STARTF_USESHOWWINDOW
;

8584 
	gsi
.
	gwShowWšdow
 = 
SW_HIDE
;

8585 
	gsi
.
	ghStdE¼Ü
 = 
G‘StdHªdË
(
STD_ERROR_HANDLE
);

8587 
C»©ePe
(&
a
[0], &a[1], 
NULL
, 0);

8588 
C»©ePe
(&
b
[0], &b[1], 
NULL
, 0);

8589 
Du¶iÿ‹HªdË
(
me
, 
a
[0], me, &
si
.
hStdIÅut
, 0, 
TRUE
, 
æags
);

8590 
Du¶iÿ‹HªdË
(
me
, 
b
[1], me, &
si
.
hStdOuut
, 0, 
TRUE
, 
æags
);

8592 ià(
	gš‹½
 =ğ
NULL
 && (
å
 = 
mg_fİ’
(
cmd
, "r")) != NULL) {

8593 
buf
[0] = buf[1] = '\0';

8594 
fg‘s
(
buf
, (buf), 
å
);

8595 
	gbuf
[(
buf
) - 1] = '\0';

8596 ià(
	gbuf
[0] =ğ'#' && 
buf
[1] == '!') {

8597 
š‹½
 = 
buf
 + 2;

8599 *
	gš‹½
 !ğ'\0' && 
is¥aû
(*(*è
š‹½
)) {

8600 
š‹½
++;

8603 
fşo£
(
å
);

8606 
¢´štf
(
buf
, (buf), "%s/%s", 
dœ
, 
cmd
);

8607 
mg_abs_·th
(
buf
, 
buf2
, 
ARRAY_SIZE
(buf2));

8609 
mg_abs_·th
(
dœ
, 
buf5
, 
ARRAY_SIZE
(buf5));

8610 
to_wch¬
(
dœ
, 
fuÎ_dœ
, 
ARRAY_SIZE
(full_dir));

8612 ià(
	gš‹½
 !ğ
NULL
) {

8613 
mg_abs_·th
(
š‹½
, 
buf4
, 
ARRAY_SIZE
(buf4));

8614 
¢´štf
(
cmdlše
, (cmdlše), "% \"%s\"", 
buf4
, 
buf2
);

8616 
¢´štf
(
cmdlše
, (cmdlše), "\"%s\"", 
buf2
);

8618 
to_wch¬
(
cmdlše
, 
wcmd
, 
ARRAY_SIZE
(wcmd));

8620 ià(
C»©eProûssW
(
NULL
, 
wcmd
, NULL, NULL, 
TRUE
, 
CREATE_NEW_PROCESS_GROUP
,

8621 (*è
’v
, 
fuÎ_dœ
, &
si
, &
pi
) != 0) {

8622 
mg_¥awn_¡dio_th»ad
(
sock
, 
a
[1], 
mg_push_to_¡dš
);

8623 
mg_¥awn_¡dio_th»ad
(
sock
, 
b
[0], 
mg_puÎ_äom_¡dout
);

8625 
Clo£HªdË
(
si
.
hStdOuut
);

8626 
Clo£HªdË
(
si
.
hStdIÅut
);

8628 
Clo£HªdË
(
pi
.
hTh»ad
);

8629 
Clo£HªdË
(
pi
.
hProûss
);

8631 
Clo£HªdË
(
a
[1]);

8632 
Clo£HªdË
(
b
[0]);

8633 
şo£sock‘
(
sock
);

8635 
DBG
(("CGI commªd: [%ls] -> %p", 
wcmd
, 
pi
.
hProûss
));

8638 (è
	g’vp
;

8639  (
	gpi
.
	ghProûss
 !ğ
NULL
);

8642 
mg_¡¬t_´oûss
(cÚ¡ *
š‹½
, cÚ¡ *
cmd
,

8643 cÚ¡ *
’v
, cÚ¡ *
’vp
[],

8644 cÚ¡ *
dœ
, 
sock_t
 
sock
) {

8645 
	gbuf
[500];

8646 
pid_t
 
	gpid
 = 
fÜk
();

8647 (è
	g’v
;

8649 ià(
	gpid
 == 0) {

8654 
tmp
 = 
chdœ
(
dœ
);

8655 (è
	gtmp
;

8656 (è
dup2
(
sock
, 0);

8657 (è
dup2
(
sock
, 1);

8658 
şo£sock‘
(
sock
);

8666 
sigÇl
(
SIGCHLD
, 
SIG_DFL
);

8668 ià(
	gš‹½
 =ğ
NULL
) {

8669 
exeşe
(
cmd
, cmd, (*è0, 
’vp
);

8671 
exeşe
(
š‹½
, iÁ”p, 
cmd
, (*è0, 
’vp
);

8673 
¢´štf
(
buf
, (buf),

8676 
š‹½
 =ğ
NULL
 ? "" : iÁ”p, iÁ”°=ğNULL ? "" : " ", 
cmd
,

8677 
¡»¼Ü
(
”ºo
));

8678 
£nd
(1, 
buf
, 
¡¾’
(buf), 0);

8679 
_ex™
(
EXIT_FAILURE
);

8682  (
	gpid
 != 0);

8690 *
mg_add’v
(
mg_cgi_’v_block
 *
block
, cÚ¡ *
fmt
, ...) {

8691 
	gn
, 
	g¥aû
;

8692 *
	gadded
 = 
block
->
buf
 + block->
Ën
;

8693 
va_li¡
 
	g­
;

8696 
	g¥aû
 = (
block
->
buf
è- (block->
Ën
 + 2);

8697 ià(
	g¥aû
 > 0) {

8699 
va_¡¬t
(
­
, 
fmt
);

8700 
	gn
 = 
v¢´štf
(
added
, (
size_t
è
¥aû
, 
fmt
, 
­
);

8701 
va_’d
(
­
);

8704 ià(
	gn
 > 0 &&‚ + 1 < 
	g¥aû
 &&

8705 
	gblock
->
	gnv¬s
 < (è
ARRAY_SIZE
(
block
->
v¬s
) - 2) {

8707 
	gblock
->
	gv¬s
[
block
->
nv¬s
++] = 
added
;

8709 
	gblock
->
	gËn
 +ğ
n
 + 1;

8713  
	gadded
;

8716 
mg_add’v2
(
mg_cgi_’v_block
 *
blk
, cÚ¡ *
Çme
) {

8717 cÚ¡ *
	gs
;

8718 ià((
	gs
 = 
g‘’v
(
Çme
)è!ğ
NULL
è
mg_add’v
(
blk
, "%s=%s",‚ame, 
s
);

8721 
mg_´•¬e_cgi_’vœÚm’t
(
mg_cÚÃùiÚ
 *
nc
,

8722 cÚ¡ *
´og
,

8723 cÚ¡ 
mg_¡r
 *
·th_šfo
,

8724 cÚ¡ 
h‰p_mes§ge
 *
hm
,

8725 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
,

8726 
mg_cgi_’v_block
 *
blk
) {

8727 cÚ¡ *
	gs
;

8728 
mg_¡r
 *
	gh
;

8729 *
	gp
;

8730 
size_t
 
	gi
;

8731 
	gbuf
[100];

8733 
	gblk
->
	gËn
 = 
blk
->
nv¬s
 = 0;

8734 
	gblk
->
	gnc
 = 
nc
;

8736 ià((
	gs
 = 
g‘’v
("SERVER_NAME")è!ğ
NULL
) {

8737 
mg_add’v
(
blk
, "SERVER_NAME=%s", 
s
);

8739 
mg_sock_to_¡r
(
nc
->
sock
, 
buf
, (buf), 3);

8740 
mg_add’v
(
blk
, "SERVER_NAME=%s", 
buf
);

8742 
mg_add’v
(
blk
, "SERVER_ROOT=%s", 
İts
->
docum’t_roÙ
);

8743 
mg_add’v
(
blk
, "DOCUMENT_ROOT=%s", 
İts
->
docum’t_roÙ
);

8744 
mg_add’v
(
blk
, "SERVER_SOFTWARE=%s/%s", "MÚgoo£", 
MG_VERSION
);

8747 
mg_add’v
(
blk
, "%s", "GATEWAY_INTERFACE=CGI/1.1");

8748 
mg_add’v
(
blk
, "%s", "SERVER_PROTOCOL=HTTP/1.1");

8749 
mg_add’v
(
blk
, "%s", "REDIRECT_STATUS=200");

8751 
mg_add’v
(
blk
, "REQUEST_METHOD=%.*s", (è
hm
->
m‘hod
.
Ën
, hm->m‘hod.
p
);

8753 
mg_add’v
(
blk
, "REQUEST_URI=%.*s%s%.*s", (è
hm
->
uri
.
Ën
, hm->uri.
p
,

8754 
hm
->
qu”y_¡ršg
.
Ën
 == 0 ? "" : "?", () hm->query_string.len,

8755 
hm
->
qu”y_¡ršg
.
p
);

8757 
mg_cÚn_addr_to_¡r
(
nc
, 
buf
, (buf),

8758 
MG_SOCK_STRINGIFY_REMOTE
 | 
MG_SOCK_STRINGIFY_IP
);

8759 
mg_add’v
(
blk
, "REMOTE_ADDR=%s", 
buf
);

8760 
mg_cÚn_addr_to_¡r
(
nc
, 
buf
, (buf), 
MG_SOCK_STRINGIFY_PORT
);

8761 
mg_add’v
(
blk
, "SERVER_PORT=%s", 
buf
);

8763 
	gs
 = 
hm
->
uri
.
p
 + hm->uri.
Ën
 - 
·th_šfo
->len - 1;

8764 ià(*
	gs
 == '/') {

8765 cÚ¡ *
ba£_Çme
 = 
¡¼chr
(
´og
, 
DIRSEP
);

8766 
mg_add’v
(
blk
, "SCRIPT_NAME=%.*s/%s", (è(
s
 - 
hm
->
uri
.
p
), hm->uri.p,

8767 (
ba£_Çme
 !ğ
NULL
 ? ba£_Çm+ 1 : 
´og
));

8769 
mg_add’v
(
blk
, "SCRIPT_NAME=%.*s", (è(
s
 - 
hm
->
uri
.
p
 + 1), hm->uri.p);

8771 
mg_add’v
(
blk
, "SCRIPT_FILENAME=%s", 
´og
);

8773 ià(
	g·th_šfo
 !ğ
NULL
 && 
·th_šfo
->
Ën
 > 0) {

8774 
mg_add’v
(
blk
, "PATH_INFO=%.*s", (è
·th_šfo
->
Ën
,…©h_šfo->
p
);

8776 
mg_add’v
(
blk
, "PATH_TRANSLATED=%.*s", (è
·th_šfo
->
Ën
,…©h_šfo->
p
);

8779 #ià
MG_ENABLE_SSL


8780 
mg_add’v
(
blk
, "HTTPS=%s", (
nc
->
æags
 & 
MG_F_SSL
 ? "on" : "off"));

8782 
mg_add’v
(
blk
, "HTTPS=off");

8785 ià((
	gh
 = 
mg_g‘_h‰p_h—d”
((
h‰p_mes§ge
 *è
hm
, "Content-Type")) !=

8786 
NULL
) {

8787 
mg_add’v
(
blk
, "CONTENT_TYPE=%.*s", (è
h
->
Ën
, h->
p
);

8790 ià(
	ghm
->
	gqu”y_¡ršg
.
	gËn
 > 0) {

8791 
mg_add’v
(
blk
, "QUERY_STRING=%.*s", (è
hm
->
qu”y_¡ršg
.
Ën
,

8792 
hm
->
qu”y_¡ršg
.
p
);

8795 ià((
	gh
 = 
mg_g‘_h‰p_h—d”
((
h‰p_mes§ge
 *è
hm
, "Content-Length")) !=

8796 
NULL
) {

8797 
mg_add’v
(
blk
, "CONTENT_LENGTH=%.*s", (è
h
->
Ën
, h->
p
);

8800 
mg_add’v2
(
blk
, "PATH");

8801 
mg_add’v2
(
blk
, "TMP");

8802 
mg_add’v2
(
blk
, "TEMP");

8803 
mg_add’v2
(
blk
, "TMPDIR");

8804 
mg_add’v2
(
blk
, "PERLLIB");

8805 
mg_add’v2
(
blk
, 
MG_ENV_EXPORT_TO_CGI
);

8807 #ifdeà
_WIN32


8808 
mg_add’v2
(
blk
, "COMSPEC");

8809 
mg_add’v2
(
blk
, "SYSTEMROOT");

8810 
mg_add’v2
(
blk
, "SystemDrive");

8811 
mg_add’v2
(
blk
, "ProgramFiles");

8812 
mg_add’v2
(
blk
, "ProgramFiles(x86)");

8813 
mg_add’v2
(
blk
, "CommonProgramFiles(x86)");

8815 
mg_add’v2
(
blk
, "LD_LIBRARY_PATH");

8819 
	gi
 = 0; 
	ghm
->
	gh—d”_Çmes
[
i
].
	gËn
 > 0; i++) {

8820 
	gp
 = 
mg_add’v
(
blk
, "HTTP_%.*s=%.*s", (è
hm
->
h—d”_Çmes
[
i
].
Ën
,

8821 
hm
->
h—d”_Çmes
[
i
].
p
, (èhm->
h—d”_v®ues
[i].
Ën
,

8822 
hm
->
h—d”_v®ues
[
i
].
p
);

8825 ; *
	gp
 !ğ'=' && *
p
 != '\0';…++) {

8826 ià(*
	gp
 =ğ'-'è*
p
 = '_';

8827 *
	gp
 = (è
touµ”
(*(*è
p
);

8831 
	gblk
->
	gv¬s
[
blk
->
nv¬s
++] = 
NULL
;

8832 
	gblk
->
	gbuf
[
blk
->
Ën
++] = '\0';

8835 
mg_cgi_ev_hªdËr
(
mg_cÚÃùiÚ
 *
cgi_nc
, 
ev
,

8836 *
ev_d©a
 
MG_UD_ARG
(*
u£r_d©a
)) {

8837 #ià!
MG_ENABLE_CALLBACK_USERDATA


8838 *
	gu£r_d©a
 = 
cgi_nc
->
u£r_d©a
;

8840 
mg_cÚÃùiÚ
 *
	gnc
 = (mg_cÚÃùiÚ *è
u£r_d©a
;

8841 (è
	gev_d©a
;

8843 ià(
	gnc
 =ğ
NULL
) {

8845 
cgi_nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

8849 
	gev
) {

8850 
	gMG_EV_RECV
:

8864 ià(
nc
->
æags
 & 
MG_F_HTTP_CGI_PARSE_HEADERS
) {

8865 
mbuf
 *
io
 = &
cgi_nc
->
»cv_mbuf
;

8866 
	gËn
 = 
mg_h‰p_g‘_»que¡_Ën
(
io
->
buf
, io->
Ën
);

8868 ià(
	gËn
 == 0) ;

8869 ià(
	gËn
 < 0 || 
	gio
->ËÀ> 
	gMG_MAX_HTTP_REQUEST_SIZE
) {

8870 
	gcgi_nc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

8871 
mg_h‰p_£nd_”rÜ
(
nc
, 500, "Bad headers");

8873 
h‰p_mes§ge
 
	ghm
;

8874 
mg_¡r
 *
	gh
;

8875 
mg_h‰p_·r£_h—d”s
(
io
->
buf
, io->buà+ io->
Ën
, io->Ën, &
hm
);

8876 ià(
mg_g‘_h‰p_h—d”
(&
hm
, "LoÿtiÚ"è!ğ
NULL
) {

8877 
mg_´štf
(
nc
, "%s", "HTTP/1.1 302 Moved\r\n");

8878 } ià((
	gh
 = 
mg_g‘_h‰p_h—d”
(&
hm
, "Stus")è!ğ
NULL
) {

8879 
mg_´štf
(
nc
, "HTTP/1.1 %.*s\r\n", (è
h
->
Ën
, h->
p
);

8881 
mg_´štf
(
nc
, "%s", "HTTP/1.1 200 OK\r\n");

8884 
	gnc
->
	gæags
 &ğ~
MG_F_HTTP_CGI_PARSE_HEADERS
;

8886 ià(!(
	gnc
->
	gæags
 & 
	gMG_F_HTTP_CGI_PARSE_HEADERS
)) {

8887 
mg_fÜw¬d
(
cgi_nc
, 
nc
);

8890 
	gMG_EV_CLOSE
:

8891 
DBG
(("%°CLOSE", 
cgi_nc
));

8892 
mg_h‰p_ä“_´Ùo_d©a_cgi
(&
mg_h‰p_g‘_´Ùo_d©a
(
nc
)->
cgi
);

8893 
	gnc
->
	gæags
 |ğ
MG_F_SEND_AND_CLOSE
;

8898 
MG_INTERNAL
 
mg_hªdË_cgi
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
´og
,

8899 cÚ¡ 
mg_¡r
 *
·th_šfo
,

8900 cÚ¡ 
h‰p_mes§ge
 *
hm
,

8901 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
) {

8902 
mg_cgi_’v_block
 
	gblk
;

8903 
	gdœ
[
MG_MAX_PATH
];

8904 cÚ¡ *
	gp
;

8905 
sock_t
 
	gfds
[2];

8907 
DBG
(("%°[%s]", 
nc
, 
´og
));

8908 
mg_´•¬e_cgi_’vœÚm’t
(
nc
, 
´og
, 
·th_šfo
, 
hm
, 
İts
, &
blk
);

8914 ià((
	gp
 = 
¡¼chr
(
´og
, 
DIRSEP
)è=ğ
NULL
) {

8915 
¢´štf
(
dœ
, (dir), "%s", ".");

8917 
¢´štf
(
dœ
, (dœ), "%.*s", (è(
p
 - 
´og
),…rog);

8918 
	g´og
 = 
p
 + 1;

8921 ià(!
mg_sock‘·œ
(
fds
, 
SOCK_STREAM
)) {

8922 
	gnc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

8926 #iâdeà
_WIN32


8927 
sigaùiÚ
 
	g§
;

8929 
sigem±y£t
(&
§
.
§_mask
);

8930 
	g§
.
	g§_hªdËr
 = 
SIG_IGN
;

8931 
	g§
.
	g§_æags
 = 0;

8932 
sigaùiÚ
(
SIGCHLD
, &
§
, 
NULL
);

8935 ià(
mg_¡¬t_´oûss
(
İts
->
cgi_š‹½»‹r
, 
´og
, 
blk
.
buf
, blk.
v¬s
, 
dœ
,

8936 
fds
[1]) != 0) {

8937 
size_t
 
n
 = 
nc
->
»cv_mbuf
.
Ën
 - (
hm
->
mes§ge
.ËÀ- hm->
body
.len);

8938 
mg_cÚÃùiÚ
 *
	gcgi_nc
 =

8939 
mg_add_sock
(
nc
->
mgr
, 
fds
[0], 
mg_cgi_ev_hªdËr
 
MG_UD_ARG
(nc));

8940 
mg_h‰p_´Ùo_d©a
 *
	gcgi_pd
 = 
mg_h‰p_g‘_´Ùo_d©a
(
nc
);

8941 
	gcgi_pd
->
	gcgi
.
	gcgi_nc
 = 
cgi_nc
;

8942 #ià!
MG_ENABLE_CALLBACK_USERDATA


8943 
	gcgi_pd
->
	gcgi
.
	gcgi_nc
->
	gu£r_d©a
 = 
nc
;

8945 
	gnc
->
	gæags
 |ğ
MG_F_HTTP_CGI_PARSE_HEADERS
;

8947 ià(
	gn
 > 0 &&‚ < 
	gnc
->
	g»cv_mbuf
.
	gËn
) {

8948 
mg_£nd
(
cgi_pd
->
cgi
.
cgi_nc
, 
hm
->
body
.
p
, 
n
);

8950 
mbuf_»move
(&
nc
->
»cv_mbuf
,‚c->»cv_mbuf.
Ën
);

8952 
şo£sock‘
(
fds
[0]);

8953 
mg_h‰p_£nd_”rÜ
(
nc
, 500, "CGI failure");

8956 #iâdeà
_WIN32


8957 
şo£sock‘
(
fds
[1]);

8961 
MG_INTERNAL
 
mg_h‰p_ä“_´Ùo_d©a_cgi
(
mg_h‰p_´Ùo_d©a_cgi
 *
d
) {

8962 ià(
	gd
 =ğ
NULL
) ;

8963 ià(
	gd
->
	gcgi_nc
 !ğ
NULL
) {

8964 
d
->
cgi_nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

8965 
	gd
->
	gcgi_nc
->
	gu£r_d©a
 = 
NULL
;

8967 
mem£t
(
d
, 0, (*d));

8971 #ifdeà
MG_MODULE_LINES


8979 #ià
MG_ENABLE_HTTP
 && 
MG_ENABLE_HTTP_SSI
 && 
MG_ENABLE_FILESYSTEM


8981 
mg_£nd_ssi_fe
(
mg_cÚÃùiÚ
 *
nc
, 
h‰p_mes§ge
 *
hm
,

8982 cÚ¡ *
·th
, 
FILE
 *
å
, 
šşude_Ëv–
,

8983 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
);

8985 
mg_£nd_fe_d©a
(
mg_cÚÃùiÚ
 *
nc
, 
FILE
 *
å
) {

8986 
	gbuf
[
BUFSIZ
];

8987 
size_t
 
	gn
;

8988 (
	gn
 = 
mg_ä—d
(
buf
, 1, (buf), 
å
)) > 0) {

8989 
mg_£nd
(
nc
, 
buf
, 
n
);

8993 
mg_do_ssi_šşude
(
mg_cÚÃùiÚ
 *
nc
, 
h‰p_mes§ge
 *
hm
,

8994 cÚ¡ *
ssi
, *
g
, 
šşude_Ëv–
,

8995 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
) {

8996 
	gfe_Çme
[
MG_MAX_PATH
], 
	g·th
[MG_MAX_PATH], *
	gp
;

8997 
FILE
 *
	gå
;

9003 ià(
ssÿnf
(
g
, " vœtu®=\"%[^\"]\"", 
fe_Çme
) == 1) {

9005 
¢´štf
(
·th
, Õ©h), "%s/%s", 
İts
->
docum’t_roÙ
, 
fe_Çme
);

9006 } ià(
ssÿnf
(
g
, "‡b¥©h=\"%[^\"]\"", 
fe_Çme
) == 1) {

9011 
¢´štf
(
·th
, Õ©h), "%s", 
fe_Çme
);

9012 } ià(
ssÿnf
(
g
, " fe=\"%[^\"]\"", 
fe_Çme
) == 1 ||

9013 
ssÿnf
(
g
, " \"%[^\"]\"", 
fe_Çme
) == 1) {

9015 
¢´štf
(
·th
, Õ©h), "%s", 
ssi
);

9016 ià((
	gp
 = 
¡¼chr
(
·th
, 
DIRSEP
)è!ğ
NULL
) {

9017 
p
[1] = '\0';

9019 
¢´štf
(
·th
 + 
¡¾’
Õ©h), Õ©hè- sŒËnÕ©h), "%s", 
fe_Çme
);

9021 
mg_´štf
(
nc
, "Bad SSI #šşude: [%s]", 
g
);

9025 ià((
	gå
 = 
mg_fİ’
(
·th
, "rb")è=ğ
NULL
) {

9026 
mg_´štf
(
nc
, "SSI inşud”rÜ: mg_fİ’(%s): %s", 
·th
,

9027 
¡»¼Ü
(
mg_g‘_”ºo
()));

9029 
mg_£t_şo£_Ú_exec
((
sock_t
è
f’o
(
å
));

9030 ià(
mg_m©ch_´efix
(
İts
->
ssi_·‰”n
, 
¡¾’
(İts->ssi_·‰”n), 
·th
) >

9032 
mg_£nd_ssi_fe
(
nc
, 
hm
, 
·th
, 
å
, 
šşude_Ëv–
 + 1, 
İts
);

9034 
mg_£nd_fe_d©a
(
nc
, 
å
);

9036 
fşo£
(
å
);

9040 #ià
MG_ENABLE_HTTP_SSI_EXEC


9041 
do_ssi_exec
(
mg_cÚÃùiÚ
 *
nc
, *
g
) {

9042 
	gcmd
[
BUFSIZ
];

9043 
FILE
 *
	gå
;

9045 ià(
ssÿnf
(
g
, " \"%[^\"]\"", 
cmd
) != 1) {

9046 
mg_´štf
(
nc
, "Bad SSI #exec: [%s]", 
g
);

9047 } ià((
	gå
 = 
pİ’
(
cmd
, "r")è=ğ
NULL
) {

9048 
mg_´štf
(
nc
, "CªnÙ SSI #exec: [%s]: %s", 
cmd
, 
¡»¼Ü
(
mg_g‘_”ºo
()));

9050 
mg_£nd_fe_d©a
(
nc
, 
å
);

9051 
pşo£
(
å
);

9060 
mg_£nd_ssi_fe
(
mg_cÚÃùiÚ
 *
nc
, 
h‰p_mes§ge
 *
hm
,

9061 cÚ¡ *
·th
, 
FILE
 *
å
, 
šşude_Ëv–
,

9062 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
) {

9063 cÚ¡ 
mg_¡r
 
	gbg
 = 
MG_MK_STR
("<!--#");

9064 cÚ¡ 
mg_¡r
 
	gd_šşude
 = 
MG_MK_STR
("include");

9065 cÚ¡ 
mg_¡r
 
	gd_ÿÎ
 = 
MG_MK_STR
("call");

9066 #ià
MG_ENABLE_HTTP_SSI_EXEC


9067 cÚ¡ 
mg_¡r
 
	gd_exec
 = 
MG_MK_STR
("exec");

9069 
	gbuf
[
BUFSIZ
], *
	gp
 = 
buf
 + 
bg
.
Ën
;

9070 
	gch
, 
	gËn
, 
	gš_ssi_g
;

9072 ià(
	gšşude_Ëv–
 > 10) {

9073 
mg_´štf
(
nc
, "SSI #šşudËv– i toØd“°(%s)", 
·th
);

9077 
	gš_ssi_g
 = 
Ën
 = 0;

9078 (
	gch
 = 
fg‘c
(
å
)è!ğ
EOF
) {

9079 ià(
š_ssi_g
 && 
ch
 =ğ'>' && 
buf
[
Ën
 - 1] == '-' && buf[len - 2] == '-') {

9080 
size_t
 
i
 = 
Ën
 - 2;

9081 
	gš_ssi_g
 = 0;

9084 
	gbuf
[
i
--] = '\0';

9085 
	gi
 > 0 && 
	gbuf
[
i
] == ' ') {

9086 
buf
[
i
--] = '\0';

9090 ià(
¡ºcmp
(
p
, 
d_šşude
.p, d_šşude.
Ën
) == 0) {

9091 
mg_do_ssi_šşude
(
nc
, 
hm
, 
·th
, 
p
 + 
d_šşude
.
Ën
 + 1, 
šşude_Ëv–
,

9092 
İts
);

9093 } ià(
¡ºcmp
(
p
, 
d_ÿÎ
.p, d_ÿÎ.
Ën
) == 0) {

9094 
mg_ssi_ÿÎ_ùx
 
cùx
;

9095 
mem£t
(&
cùx
, 0, (cctx));

9096 
	gcùx
.
	g»q
 = 
hm
;

9097 
	gcùx
.
	gfe
 = 
mg_mk_¡r
(
·th
);

9098 
	gcùx
.
	g¬g
 = 
mg_mk_¡r
(
p
 + 
d_ÿÎ
.
Ën
 + 1);

9099 
mg_ÿÎ
(
nc
, 
NULL
,‚c->
u£r_d©a
, 
MG_EV_SSI_CALL
,

9100 (*è
cùx
.
¬g
.
p
);

9101 
mg_ÿÎ
(
nc
, 
NULL
,‚c->
u£r_d©a
, 
MG_EV_SSI_CALL_CTX
, &
cùx
);

9102 #ià
MG_ENABLE_HTTP_SSI_EXEC


9103 } ià(
¡ºcmp
(
p
, 
d_exec
.p, d_exec.
Ën
) == 0) {

9104 
do_ssi_exec
(
nc
, 
p
 + 
d_exec
.
Ën
 + 1);

9109 
	gËn
 = 0;

9110 } ià(
	gch
 == '<') {

9111 
š_ssi_g
 = 1;

9112 ià(
	gËn
 > 0) {

9113 
mg_£nd
(
nc
, 
buf
, (
size_t
è
Ën
);

9115 
	gËn
 = 0;

9116 
	gbuf
[
Ën
++] = 
ch
 & 0xff;

9117 } ià(
	gš_ssi_g
) {

9118 ià(
	gËn
 =ğ(è
bg
.
Ën
 && 
¡ºcmp
(
buf
, bg.
p
, btag.len) != 0) {

9120 
š_ssi_g
 = 0;

9121 } ià(
	gËn
 =ğ(è(
buf
) - 2) {

9122 
mg_´štf
(
nc
, "%s: SSIag i toØÏrge", 
·th
);

9123 
	gËn
 = 0;

9125 
	gbuf
[
Ën
++] = 
ch
 & 0xff;

9127 
	gbuf
[
Ën
++] = 
ch
 & 0xff;

9128 ià(
	gËn
 =ğ(è(
buf
)) {

9129 
mg_£nd
(
nc
, 
buf
, (
size_t
è
Ën
);

9130 
	gËn
 = 0;

9136 ià(
	gËn
 > 0) {

9137 
mg_£nd
(
nc
, 
buf
, (
size_t
è
Ën
);

9141 
MG_INTERNAL
 
mg_hªdË_ssi_»que¡
(
mg_cÚÃùiÚ
 *
nc
,

9142 
h‰p_mes§ge
 *
hm
,

9143 cÚ¡ *
·th
,

9144 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
) {

9145 
FILE
 *
	gå
;

9146 
mg_¡r
 
	gmime_ty³
;

9147 
DBG
(("%°%s", 
nc
, 
·th
));

9149 ià((
	gå
 = 
mg_fİ’
(
·th
, "rb")è=ğ
NULL
) {

9150 
mg_h‰p_£nd_”rÜ
(
nc
, 404, 
NULL
);

9152 
mg_£t_şo£_Ú_exec
((
sock_t
è
f’o
(
å
));

9154 
	gmime_ty³
 = 
mg_g‘_mime_ty³
(
·th
, "‹xt/¶aš", 
İts
);

9155 
mg_£nd_»¥Ú£_lše
(
nc
, 200, 
İts
->
exŒa_h—d”s
);

9156 
mg_´štf
(
nc
,

9159 (è
mime_ty³
.
Ën
, mime_ty³.
p
);

9160 
mg_£nd_ssi_fe
(
nc
, 
hm
, 
·th
, 
å
, 0, 
İts
);

9161 
fşo£
(
å
);

9162 
	gnc
->
	gæags
 |ğ
MG_F_SEND_AND_CLOSE
;

9167 #ifdeà
MG_MODULE_LINES


9175 #ià
MG_ENABLE_HTTP
 && 
MG_ENABLE_HTTP_WEBDAV


9177 
MG_INTERNAL
 
mg_is_dav_»que¡
(cÚ¡ 
mg_¡r
 *
s
) {

9178 cÚ¡ *
	gm‘hods
[] = {

9184 #ià
MG_ENABLE_FAKE_DAVLOCK


9190 
size_t
 
	gi
;

9192 
	gi
 = 0; i < 
ARRAY_SIZE
(
m‘hods
); i++) {

9193 ià(
mg_vcmp
(
s
, 
m‘hods
[
i
]) == 0) {

9201 
mg_mkdœ
(cÚ¡ *
·th
, 
ušt32_t
 
mode
) {

9202 #iâdeà
_WIN32


9203  
mkdœ
(
·th
, 
mode
);

9205 (è
	gmode
;

9206  
_mkdœ
(
·th
);

9210 
mg_´št_´İs
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
Çme
,

9211 
cs_¡©_t
 *
¡p
) {

9212 
	gmtime
[64];

9213 
time_t
 
	gt
 = 
¡p
->
¡_mtime
;

9214 
mg_¡r
 
	gÇme_esc
 = 
mg_u¾_’code
(
mg_mk_¡r
(
Çme
));

9215 
mg_gmt_time_¡ršg
(
mtime
, (mtime), &
t
);

9216 
mg_´štf
(
nc
,

9222 "<d:g‘cÚ‹ÁËngth>%" 
INT64_FMT


9229 
Çme_esc
.
p
, 
S_ISDIR
(
¡p
->
¡_mode
) ? "<d:collection/>" : "",

9230 (
št64_t
è
¡p
->
¡_size
, 
mtime
);

9231 
ä“
((*è
Çme_esc
.
p
);

9234 
MG_INTERNAL
 
mg_hªdË_´İfšd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

9235 
cs_¡©_t
 *
¡p
, 
h‰p_mes§ge
 *
hm
,

9236 
mg_£rve_h‰p_İts
 *
İts
) {

9237 cÚ¡ 
	gh—d”
[] =

9243 cÚ¡ 
	gfoÙ”
[] = "</d:multistatus>\n";

9244 cÚ¡ 
mg_¡r
 *
	gd•th
 = 
mg_g‘_h‰p_h—d”
(
hm
, "Depth");

9247 ià(
S_ISDIR
(
¡p
->
¡_mode
) &&

9248 
¡rcmp
(
İts
->
’abË_dœeùÜy_li¡šg
, "yes") != 0) {

9249 
mg_´štf
(
nc
, "%s", "HTTP/1.1 403 Directory Listing Denied\r\n\r\n");

9251 
	guri
[
MG_MAX_PATH
];

9252 
mg_£nd
(
nc
, 
h—d”
, (header) - 1);

9253 
¢´štf
(
uri
, (uri), "%.*s", (è
hm
->uri.
Ën
, hm->uri.
p
);

9254 
mg_´št_´İs
(
nc
, 
uri
, 
¡p
);

9255 ià(
S_ISDIR
(
¡p
->
¡_mode
è&& (
	gd•th
 =ğ
NULL
 || 
mg_vcmp
(
d•th
, "0") != 0)) {

9256 
mg_sÿn_dœeùÜy
(
nc
, 
·th
, 
İts
, 
mg_´št_´İs
);

9258 
mg_£nd
(
nc
, 
foÙ”
, (footer) - 1);

9259 
	gnc
->
	gæags
 |ğ
MG_F_SEND_AND_CLOSE
;

9263 #ià
MG_ENABLE_FAKE_DAVLOCK


9275 
MG_INTERNAL
 
mg_hªdË_lock
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
) {

9276 cÚ¡ *
	g»¶y
 =

9292 
mg_´štf
(
nc
, 
»¶y
, 
·th
, (è
mg_time
());

9293 
	gnc
->
	gæags
 |ğ
MG_F_SEND_AND_CLOSE
;

9297 
MG_INTERNAL
 
mg_hªdË_mkcŞ
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

9298 
h‰p_mes§ge
 *
hm
) {

9299 
	g¡©us_code
 = 500;

9300 ià(
	ghm
->
	gbody
.
	gËn
 !ğ(
size_t
è~0 && 
hm
->
body
.
Ën
 > 0) {

9301 
¡©us_code
 = 415;

9302 } ià(!
mg_mkdœ
(
·th
, 0755)) {

9303 
	g¡©us_code
 = 201;

9304 } ià(
	g”ºo
 =ğ
EEXIST
) {

9305 
¡©us_code
 = 405;

9306 } ià(
	g”ºo
 =ğ
EACCES
) {

9307 
¡©us_code
 = 403;

9308 } ià(
	g”ºo
 =ğ
ENOENT
) {

9309 
¡©us_code
 = 409;

9311 
	g¡©us_code
 = 500;

9313 
mg_h‰p_£nd_”rÜ
(
nc
, 
¡©us_code
, 
NULL
);

9316 
mg_»move_dœeùÜy
(cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
,

9317 cÚ¡ *
dœ
) {

9318 
	g·th
[
MG_MAX_PATH
];

9319 
dœ’t
 *
	gdp
;

9320 
cs_¡©_t
 
	g¡
;

9321 
DIR
 *
	gdœp
;

9323 ià((
	gdœp
 = 
İ’dœ
(
dœ
)è=ğ
NULL
)  0;

9325 (
	gdp
 = 
»addœ
(
dœp
)è!ğ
NULL
) {

9326 ià(
mg_is_fe_hidd’
((cÚ¡ *è
dp
->
d_Çme
, 
İts
, 1)) {

9329 
¢´štf
(
·th
, Õ©h), "%s%c%s", 
dœ
, '/', 
dp
->
d_Çme
);

9330 
mg_¡©
(
·th
, &
¡
);

9331 ià(
S_ISDIR
(
¡
.
¡_mode
)) {

9332 
mg_»move_dœeùÜy
(
İts
, 
·th
);

9334 
»move
(
·th
);

9337 
şo£dœ
(
dœp
);

9338 
rmdœ
(
dœ
);

9343 
MG_INTERNAL
 
mg_hªdË_move
(
mg_cÚÃùiÚ
 *
c
,

9344 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
,

9345 cÚ¡ *
·th
, 
h‰p_mes§ge
 *
hm
) {

9346 cÚ¡ 
mg_¡r
 *
	gde¡
 = 
mg_g‘_h‰p_h—d”
(
hm
, "Destination");

9347 ià(
	gde¡
 =ğ
NULL
) {

9348 
mg_h‰p_£nd_”rÜ
(
c
, 411, 
NULL
);

9350 cÚ¡ *
	gp
 = (*è
memchr
(
de¡
->
p
, '/', de¡->
Ën
);

9351 ià(
	gp
 !ğ
NULL
 && 
p
[1] == '/' &&

9352 (
p
 = (*è
memchr
Õ + 2, '/', 
de¡
->°+ de¡->
Ën
 -…)è!ğ
NULL
) {

9353 
buf
[
MG_MAX_PATH
];

9354 
¢´štf
(
buf
, (buf), "%s%.*s", 
İts
->
dav_docum’t_roÙ
,

9355 (è(
de¡
->
p
 + de¡->
Ën
 -…),…);

9356 ià(
»Çme
(
·th
, 
buf
) == 0) {

9357 
mg_h‰p_£nd_”rÜ
(
c
, 200, 
NULL
);

9359 
mg_h‰p_£nd_”rÜ
(
c
, 418, 
NULL
);

9362 
mg_h‰p_£nd_”rÜ
(
c
, 500, 
NULL
);

9367 
MG_INTERNAL
 
mg_hªdË_d–‘e
(
mg_cÚÃùiÚ
 *
nc
,

9368 cÚ¡ 
mg_£rve_h‰p_İts
 *
İts
,

9369 cÚ¡ *
·th
) {

9370 
cs_¡©_t
 
	g¡
;

9371 ià(
mg_¡©
(
·th
, &
¡
) != 0) {

9372 
mg_h‰p_£nd_”rÜ
(
nc
, 404, 
NULL
);

9373 } ià(
S_ISDIR
(
¡
.
¡_mode
)) {

9374 
mg_»move_dœeùÜy
(
İts
, 
·th
);

9375 
mg_h‰p_£nd_”rÜ
(
nc
, 204, 
NULL
);

9376 } ià(
»move
(
·th
) == 0) {

9377 
mg_h‰p_£nd_”rÜ
(
nc
, 204, 
NULL
);

9379 
mg_h‰p_£nd_”rÜ
(
nc
, 423, 
NULL
);

9384 
mg_ü—‹_™”medŸ‹_dœeùÜ›s
(cÚ¡ *
·th
) {

9385 cÚ¡ *
	gs
;

9388 
	gs
 = 
·th
 + 1; *s != '\0'; s++) {

9389 ià(*
	gs
 == '/') {

9390 
buf
[
MG_MAX_PATH
];

9391 
cs_¡©_t
 
	g¡
;

9392 
¢´štf
(
buf
, (buf), "%.*s", (è(
s
 - 
·th
),…ath);

9393 
	gbuf
[(
buf
) - 1] = '\0';

9394 ià(
mg_¡©
(
buf
, &
¡
è!ğ0 && 
mg_mkdœ
(buf, 0755) != 0) {

9403 
MG_INTERNAL
 
mg_hªdË_put
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

9404 
h‰p_mes§ge
 *
hm
) {

9405 
mg_h‰p_´Ùo_d©a
 *
	gpd
 = 
mg_h‰p_g‘_´Ùo_d©a
(
nc
);

9406 
cs_¡©_t
 
	g¡
;

9407 cÚ¡ 
mg_¡r
 *
	gş_hdr
 = 
mg_g‘_h‰p_h—d”
(
hm
, "Content-Length");

9408 
	grc
, 
	g¡©us_code
 = 
mg_¡©
(
·th
, &
¡
) == 0 ? 200 : 201;

9410 
mg_h‰p_ä“_´Ùo_d©a_fe
(&
pd
->
fe
);

9411 ià((
	grc
 = 
mg_ü—‹_™”medŸ‹_dœeùÜ›s
(
·th
)) == 0) {

9412 
mg_´štf
(
nc
, "HTTP/1.1 %d OK\r\nCÚ‹Á-L’gth: 0\r\n\r\n", 
¡©us_code
);

9413 } ià(
	grc
 == -1) {

9414 
mg_h‰p_£nd_”rÜ
(
nc
, 500, 
NULL
);

9415 } ià(
	gş_hdr
 =ğ
NULL
) {

9416 
mg_h‰p_£nd_”rÜ
(
nc
, 411, 
NULL
);

9417 } ià((
	gpd
->
	gfe
.
	gå
 = 
mg_fİ’
(
·th
, "w+b")è=ğ
NULL
) {

9418 
mg_h‰p_£nd_”rÜ
(
nc
, 500, 
NULL
);

9420 cÚ¡ 
mg_¡r
 *
	g¿nge_hdr
 = 
mg_g‘_h‰p_h—d”
(
hm
, "Content-Range");

9421 
št64_t
 
	gr1
 = 0, 
	gr2
 = 0;

9422 
	gpd
->
	gfe
.
	gty³
 = 
DATA_PUT
;

9423 
mg_£t_şo£_Ú_exec
((
sock_t
è
f’o
(
pd
->
fe
.
å
));

9424 
	gpd
->
	gfe
.
	gş
 = 
to64
(
ş_hdr
->
p
);

9425 ià(
	g¿nge_hdr
 !ğ
NULL
 &&

9426 
mg_h‰p_·r£_¿nge_h—d”
(
¿nge_hdr
, &
r1
, &
r2
) > 0) {

9427 
	g¡©us_code
 = 206;

9428 
f£eko
(
pd
->
fe
.
å
, 
r1
, 
SEEK_SET
);

9429 
	gpd
->
	gfe
.
	gş
 = 
r2
 > 
r1
 ?„2 -„1 + 1 : 
pd
->
fe
.
ş
 -„1;

9431 
mg_´štf
(
nc
, "HTTP/1.1 %d OK\r\nCÚ‹Á-L’gth: 0\r\n\r\n", 
¡©us_code
);

9433 
mbuf_»move
(&
nc
->
»cv_mbuf
, 
hm
->
mes§ge
.
Ën
 - hm->
body
.len);

9434 
mg_h‰p_Œªsãr_fe_d©a
(
nc
);

9439 #ifdeà
MG_MODULE_LINES


9447 #ià
MG_ENABLE_HTTP
 && 
MG_ENABLE_HTTP_WEBSOCKET


9451 #iâdeà
MG_WEBSOCKET_PING_INTERVAL_SECONDS


9452 
	#MG_WEBSOCKET_PING_INTERVAL_SECONDS
 5

	)

9455 
mg_is_ws_äagm’t
(
æags
) {

9456  (
	gæags
 & 0x80è=ğ0 || (
æags
 & 0x0f) == 0;

9459 
mg_is_ws_fœ¡_äagm’t
(
æags
) {

9460  (
	gæags
 & 0x80è=ğ0 && (
æags
 & 0x0f) != 0;

9463 
mg_hªdË_šcomšg_websock‘_äame
(
mg_cÚÃùiÚ
 *
nc
,

9464 
websock‘_mes§ge
 *
wsm
) {

9465 ià(
	gwsm
->
	gæags
 & 0x8) {

9466 
mg_ÿÎ
(
nc
,‚c->
hªdËr
,‚c->
u£r_d©a
, 
MG_EV_WEBSOCKET_CONTROL_FRAME
, 
wsm
);

9468 
mg_ÿÎ
(
nc
,‚c->
hªdËr
,‚c->
u£r_d©a
, 
MG_EV_WEBSOCKET_FRAME
, 
wsm
);

9472 
mg_ws_´Ùo_d©a
 *
mg_ws_g‘_´Ùo_d©a
(
mg_cÚÃùiÚ
 *
nc
) {

9473 
mg_h‰p_´Ùo_d©a
 *
	ghtd
 = 
mg_h‰p_g‘_´Ùo_d©a
(
nc
);

9474  (
	ghtd
 !ğ
NULL
 ? &
htd
->
ws_d©a
 : NULL);

9477 
mg_d–iv”_websock‘_d©a
(
mg_cÚÃùiÚ
 *
nc
) {

9479 
ušt64_t
 
	gi
, 
	gd©a_Ën
 = 0, 
	gäame_Ën
 = 0, 
	gbuf_Ën
 = 
nc
->
»cv_mbuf
.
Ën
, 
	gËn
,

9480 
	gmask_Ën
 = 0, 
	gh—d”_Ën
 = 0;

9481 *
	gp
 = (*è
nc
->
»cv_mbuf
.
buf
, *
	gbuf
 = 
p
,

9482 *
	ge
 = 
p
 + 
buf_Ën
;

9483 
mg_ws_´Ùo_d©a
 *
	gwsd
 = 
mg_ws_g‘_´Ùo_d©a
(
nc
);

9484 
	gok
;

9485 
	g»ass
 = 
buf_Ën
 > 0 && 
mg_is_ws_äagm’t
(
p
[0]) &&

9486 !(
nc
->
æags
 & 
MG_F_WEBSOCKET_NO_DEFRAG
);

9489 ià(
	g»ass
 && !
mg_is_ws_fœ¡_äagm’t
(
p
[0]è&& 
	gbuf_Ën
 >= 1 &&

9490 
buf_Ën
 >ğ1 + 
wsd
->
»ass_Ën
) {

9491 
buf
 +ğ1 + 
wsd
->
»ass_Ën
;

9492 
	gbuf_Ën
 -ğ1 + 
wsd
->
»ass_Ën
;

9495 ià(
	gbuf_Ën
 >= 2) {

9496 
Ën
 = 
buf
[1] & 0x7f;

9497 
	gmask_Ën
 = 
buf
[1] & 0x80 ? 4 : 0;

9498 ià(
	gËn
 < 126 && 
	gbuf_Ën
 >ğ
mask_Ën
) {

9499 
d©a_Ën
 = 
Ën
;

9500 
	gh—d”_Ën
 = 2 + 
mask_Ën
;

9501 } ià(
	gËn
 =ğ126 && 
buf_Ën
 >ğ4 + 
mask_Ën
) {

9502 
h—d”_Ën
 = 4 + 
mask_Ën
;

9503 
	gd©a_Ën
 = 
Áohs
(*(
ušt16_t
 *è&
buf
[2]);

9504 } ià(
	gbuf_Ën
 >ğ10 + 
mask_Ën
) {

9505 
h—d”_Ën
 = 10 + 
mask_Ën
;

9506 
	gd©a_Ën
 = (((
ušt64_t
è
Áohl
(*(
ušt32_t
 *è&
buf
[2])) << 32) +

9507 
Áohl
(*(
ušt32_t
 *è&
buf
[6]);

9511 
	gäame_Ën
 = 
h—d”_Ën
 + 
d©a_Ën
;

9512 
	gok
 = (
äame_Ën
 > 0 && f¿me_ËÀ<ğ
buf_Ën
);

9515 ià(
	gäame_Ën
 < 
	gh—d”_Ën
 || f¿me_ËÀ< 
	gd©a_Ën
) {

9516 
	gok
 = 0;

9517 
	gnc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

9520 ià(
	gok
) {

9521 
websock‘_mes§ge
 
	gwsm
;

9523 
	gwsm
.
	gsize
 = (
size_t
è
d©a_Ën
;

9524 
	gwsm
.
	gd©a
 = 
buf
 + 
h—d”_Ën
;

9525 
	gwsm
.
	gæags
 = 
buf
[0];

9528 ià(
	gmask_Ën
 > 0) {

9529 
	gi
 = 0; i < 
	gd©a_Ën
; i++) {

9530 
	gbuf
[
i
 + 
h—d”_Ën
] ^ğ(
buf
 + h—d”_ËÀ- 
mask_Ën
)[i % 4];

9534 ià(
	g»ass
) {

9536 ià(
mg_is_ws_fœ¡_äagm’t
(
wsm
.
æags
)) {

9537 
	gp
[0] &= ~0x0f;

9538 
	gbuf
 = 
p
 + 1;

9539 
	gwsd
->
	g»ass_Ën
 = 0;

9543 
memmove
(
buf
, 
wsm
.
d©a
, 
e
 - wsm.data);

9544 
	gwsd
->
	g»ass_Ën
 +ğ
wsm
.
size
;

9545 
	gnc
->
	g»cv_mbuf
.
	gËn
 -ğ
wsm
.
d©a
 - 
buf
;

9548 ià(
	gwsm
.
	gæags
 & 0x80) {

9549 
	gwsm
.
	gd©a
 = 
p
 + 1;

9550 
	gwsm
.
	gsize
 = 
wsd
->
»ass_Ën
;

9551 
mg_hªdË_šcomšg_websock‘_äame
(
nc
, &
wsm
);

9552 
mbuf_»move
(&
nc
->
»cv_mbuf
, 1 + 
wsd
->
»ass_Ën
);

9553 
	gwsd
->
	g»ass_Ën
 = 0;

9557 
mg_hªdË_šcomšg_websock‘_äame
(
nc
, &
wsm
);

9558 
mbuf_»move
(&
nc
->
»cv_mbuf
, (
size_t
è
äame_Ën
);

9559 
	gwsd
->
	g»ass_Ën
 = 0;

9563 ià(!
	g»ass
 && (
	gbuf
[0] & 0x0fè=ğ
WEBSOCKET_OP_CLOSE
) {

9564 
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

9568  
	gok
;

9571 
	sws_mask_ùx
 {

9572 
size_t
 
	gpos
;

9573 
ušt32_t
 
	gmask
;

9576 
ušt32_t
 
mg_ws_¿ndom_mask
() {

9577 
ušt32_t
 
	gmask
;

9592 #ià
MG_DISABLE_WS_RANDOM_MASK


9593 
	gmask
 = 0xefbeadde;

9596 
mask
 = (
ušt32_t
è
¿nd
();

9598 
mask
 = (
ušt32_t
è
¿nd
() << 16 | (uint32_t)„and();

9601  
	gmask
;

9604 
mg_£nd_ws_h—d”
(
mg_cÚÃùiÚ
 *
nc
, 
İ
, 
size_t
 
Ën
,

9605 
ws_mask_ùx
 *
ùx
) {

9606 
	gh—d”_Ën
;

9607 
	gh—d”
[10];

9609 
	gh—d”
[0] = (
İ
 & 
WEBSOCKET_DONT_FIN
 ? 0x0 : 0x80) + (op & 0x0f);

9610 ià(
	gËn
 < 126) {

9611 
	gh—d”
[1] = (è
Ën
;

9612 
	gh—d”_Ën
 = 2;

9613 } ià(
	gËn
 < 65535) {

9614 
ušt16_t
 
	gtmp
 = 
htÚs
((ušt16_tè
Ën
);

9615 
	gh—d”
[1] = 126;

9616 
memıy
(&
h—d”
[2], &
tmp
, (tmp));

9617 
	gh—d”_Ën
 = 4;

9619 
ušt32_t
 
	gtmp
;

9620 
	gh—d”
[1] = 127;

9621 
	gtmp
 = 
htÚl
((
ušt32_t
)((
ušt64_t
è
Ën
 >> 32));

9622 
memıy
(&
h—d”
[2], &
tmp
, (tmp));

9623 
	gtmp
 = 
htÚl
((
ušt32_t
)(
Ën
 & 0xffffffff));

9624 
memıy
(&
h—d”
[6], &
tmp
, (tmp));

9625 
	gh—d”_Ën
 = 10;

9629 ià(
	gnc
->
	gli¡’”
 =ğ
NULL
) {

9630 
h—d”
[1] |= 1 << 7;

9631 
mg_£nd
(
nc
, 
h—d”
, 
h—d”_Ën
);

9632 
	gùx
->
	gmask
 = 
mg_ws_¿ndom_mask
();

9633 
mg_£nd
(
nc
, &
ùx
->
mask
, (ctx->mask));

9634 
	gùx
->
	gpos
 = 
nc
->
£nd_mbuf
.
Ën
;

9636 
mg_£nd
(
nc
, 
h—d”
, 
h—d”_Ën
);

9637 
	gùx
->
	gpos
 = 0;

9641 
mg_ws_mask_äame
(
mbuf
 *mbuf, 
ws_mask_ùx
 *
ùx
) {

9642 
size_t
 
	gi
;

9643 ià(
	gùx
->
	gpos
 == 0) ;

9644 
	gi
 = 0; i < (
	gmbuf
->
	gËn
 - 
	gùx
->
	gpos
); i++) {

9645 
	gmbuf
->
	gbuf
[
ùx
->
pos
 + 
i
] ^ğ((*è&ùx->
mask
)[i % 4];

9649 
mg_£nd_websock‘_äame
(
mg_cÚÃùiÚ
 *
nc
, 
İ
, cÚ¡ *
d©a
,

9650 
size_t
 
Ën
) {

9651 
ws_mask_ùx
 
	gùx
;

9652 
DBG
(("%°%d %d", 
nc
, 
İ
, (è
Ën
));

9653 
mg_£nd_ws_h—d”
(
nc
, 
İ
, 
Ën
, &
ùx
);

9654 
mg_£nd
(
nc
, 
d©a
, 
Ën
);

9656 
mg_ws_mask_äame
(&
nc
->
£nd_mbuf
, &
ùx
);

9658 ià(
	gİ
 =ğ
WEBSOCKET_OP_CLOSE
) {

9659 
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

9663 
mg_£nd_websock‘_äamev
(
mg_cÚÃùiÚ
 *
nc
, 
İ
,

9664 cÚ¡ 
mg_¡r
 *
¡rv
, 
¡rvút
) {

9665 
ws_mask_ùx
 
	gùx
;

9666 
	gi
;

9667 
	gËn
 = 0;

9668 
	gi
 = 0; i < 
	g¡rvút
; i++) {

9669 
	gËn
 +ğ
¡rv
[
i
].
Ën
;

9672 
mg_£nd_ws_h—d”
(
nc
, 
İ
, 
Ën
, &
ùx
);

9674 
	gi
 = 0; i < 
	g¡rvút
; i++) {

9675 
mg_£nd
(
nc
, 
¡rv
[
i
].
p
, sŒv[i].
Ën
);

9678 
mg_ws_mask_äame
(&
nc
->
£nd_mbuf
, &
ùx
);

9680 ià(
	gİ
 =ğ
WEBSOCKET_OP_CLOSE
) {

9681 
nc
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

9685 
mg_´štf_websock‘_äame
(
mg_cÚÃùiÚ
 *
nc
, 
İ
,

9686 cÚ¡ *
fmt
, ...) {

9687 
	gmem
[
MG_VPRINTF_BUFFER_SIZE
], *
	gbuf
 = 
mem
;

9688 
va_li¡
 
	g­
;

9689 
	gËn
;

9691 
va_¡¬t
(
­
, 
fmt
);

9692 ià((
	gËn
 = 
mg_av´štf
(&
buf
, (
mem
), 
fmt
, 
­
)) > 0) {

9693 
mg_£nd_websock‘_äame
(
nc
, 
İ
, 
buf
, 
Ën
);

9695 
va_’d
(
­
);

9697 ià(
	gbuf
 !ğ
mem
 && 
buf
 !ğ
NULL
) {

9698 
MG_FREE
(
buf
);

9702 
MG_INTERNAL
 
mg_ws_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
,

9703 *
ev_d©a
 
MG_UD_ARG
(*
u£r_d©a
)) {

9704 
mg_ÿÎ
(
nc
,‚c->
hªdËr
,‚c->
u£r_d©a
, 
ev
, 
ev_d©a
);

9706 
	gev
) {

9707 
	gMG_EV_RECV
:

9709 } 
mg_d–iv”_websock‘_d©a
(
nc
));

9711 
	gMG_EV_POLL
:

9714 
time_t
 
now
 = *Ñime_ˆ*è
ev_d©a
;

9715 ià(
	gnc
->
	gæags
 & 
	gMG_F_IS_WEBSOCKET
 &&

9716 
	gnow
 > 
	gnc
->
	gÏ¡_io_time
 + 
	gMG_WEBSOCKET_PING_INTERVAL_SECONDS
) {

9717 
mg_£nd_websock‘_äame
(
nc
, 
WEBSOCKET_OP_PING
, "", 0);

9724 #ià
MG_ENABLE_CALLBACK_USERDATA


9725 (è
	gu£r_d©a
;

9729 #iâdeà
MG_EXT_SHA1


9730 
mg_hash_sha1_v
(
size_t
 
num_msgs
, cÚ¡ 
ušt8_t
 *
msgs
[],

9731 cÚ¡ 
size_t
 *
msg_Ëns
, 
ušt8_t
 *
dige¡
) {

9732 
size_t
 
	gi
;

9733 
cs_sha1_ùx
 
	gsha_ùx
;

9734 
cs_sha1_š™
(&
sha_ùx
);

9735 
	gi
 = 0; i < 
	gnum_msgs
; i++) {

9736 
cs_sha1_upd©e
(&
sha_ùx
, 
msgs
[
i
], 
msg_Ëns
[i]);

9738 
cs_sha1_fš®
(
dige¡
, &
sha_ùx
);

9741 
mg_hash_sha1_v
(
size_t
 
num_msgs
, cÚ¡ 
ušt8_t
 *
msgs
[],

9742 cÚ¡ 
size_t
 *
msg_Ëns
, 
ušt8_t
 *
dige¡
);

9745 
MG_INTERNAL
 
mg_ws_hªdshake
(
mg_cÚÃùiÚ
 *
nc
,

9746 cÚ¡ 
mg_¡r
 *
key
,

9747 
h‰p_mes§ge
 *
hm
) {

9748 cÚ¡ *
	gmagic
 = "258EAFA5-E914-47DA-95CA-C5AB0DC85B11";

9749 cÚ¡ 
ušt8_t
 *
	gmsgs
[2] = {(cÚ¡ ušt8_ˆ*è
key
->
p
, (cÚ¡ ušt8_ˆ*è
magic
};

9750 cÚ¡ 
size_t
 
	gmsg_Ëns
[2] = {
key
->
Ën
, 36};

9751 
	gsha
[20];

9752 
	gb64_sha
[30];

9753 
mg_¡r
 *
	gs
;

9755 
mg_hash_sha1_v
(2, 
msgs
, 
msg_Ëns
, 
sha
);

9756 
mg_ba£64_’code
(
sha
, (sha), 
b64_sha
);

9757 
mg_´štf
(
nc
, "%s",

9762 
	gs
 = 
mg_g‘_h‰p_h—d”
(
hm
, "Sec-WebSocket-Protocol");

9763 ià(
	gs
 !ğ
NULL
) {

9764 
mg_´štf
(
nc
, "Sec-WebSock‘-PrÙocŞ: %.*s\r\n", (è
s
->
Ën
, s->
p
);

9766 
mg_´štf
(
nc
, "Sec-WebSock‘-Acû±: %s%s", 
b64_sha
, "\r\n\r\n");

9768 
DBG
(("%°%.* %s", 
nc
, (è
key
->
Ën
, key->
p
, 
b64_sha
));

9771 
mg_£nd_websock‘_hªdshake2
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

9772 cÚ¡ *
ho¡
, cÚ¡ *
´ÙocŞ
,

9773 cÚ¡ *
exŒa_h—d”s
) {

9774 
mg_£nd_websock‘_hªdshake3
(
nc
, 
·th
, 
ho¡
, 
´ÙocŞ
, 
exŒa_h—d”s
, 
NULL
,

9775 
NULL
);

9778 
mg_£nd_websock‘_hªdshake3
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

9779 cÚ¡ *
ho¡
, cÚ¡ *
´ÙocŞ
,

9780 cÚ¡ *
exŒa_h—d”s
, cÚ¡ *
u£r
,

9781 cÚ¡ *
·ss
) {

9782 
mg_£nd_websock‘_hªdshake3v
(
nc
, 
mg_mk_¡r
(
·th
), mg_mk_¡r(
ho¡
),

9783 
mg_mk_¡r
(
´ÙocŞ
), mg_mk_¡r(
exŒa_h—d”s
),

9784 
mg_mk_¡r
(
u£r
), mg_mk_¡r(
·ss
));

9787 
mg_£nd_websock‘_hªdshake3v
(
mg_cÚÃùiÚ
 *
nc
,

9788 cÚ¡ 
mg_¡r
 
·th
,

9789 cÚ¡ 
mg_¡r
 
ho¡
,

9790 cÚ¡ 
mg_¡r
 
´ÙocŞ
,

9791 cÚ¡ 
mg_¡r
 
exŒa_h—d”s
,

9792 cÚ¡ 
mg_¡r
 
u£r
,

9793 cÚ¡ 
mg_¡r
 
·ss
) {

9794 
mbuf
 
	gauth
;

9795 
	gkey
[25];

9796 
ušt32_t
 
	gnÚû
[4];

9797 
	gnÚû
[0] = 
mg_ws_¿ndom_mask
();

9798 
	gnÚû
[1] = 
mg_ws_¿ndom_mask
();

9799 
	gnÚû
[2] = 
mg_ws_¿ndom_mask
();

9800 
	gnÚû
[3] = 
mg_ws_¿ndom_mask
();

9801 
mg_ba£64_’code
((*è&
nÚû
, ÒÚû), 
key
);

9803 
mbuf_š™
(&
auth
, 0);

9804 ià(
	gu£r
.
	gËn
 > 0) {

9805 
mg_basic_auth_h—d”
(
u£r
, 
·ss
, &
auth
);

9814 
mg_´štf
(
nc
,

9821 (è
·th
.
Ën
,…©h.
p
, (è
auth
.len,

9822 (
auth
.
buf
 =ğ
NULL
 ? "" :‡uth.buf), 
key
);

9825 ià(
	gho¡
.
	gËn
 > 0) {

9826 
	gho¡_Ën
 = (è(
·th
.
p
 - 
ho¡
.p);

9827 
mg_´štf
(
nc
, "Ho¡: %.*s\r\n", 
ho¡_Ën
, 
ho¡
.
p
);

9829 ià(
	g´ÙocŞ
.
	gËn
 > 0) {

9830 
mg_´štf
(
nc
, "Sec-WebSock‘-PrÙocŞ: %.*s\r\n", (è
´ÙocŞ
.
Ën
,

9831 
´ÙocŞ
.
p
);

9833 ià(
	gexŒa_h—d”s
.
	gËn
 > 0) {

9834 
mg_´štf
(
nc
, "%.*s", (è
exŒa_h—d”s
.
Ën
,ƒxŒa_h—d”s.
p
);

9836 
mg_´štf
(
nc
, "\r\n");

9838 
mbuf_ä“
(&
auth
);

9841 
mg_£nd_websock‘_hªdshake
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

9842 cÚ¡ *
exŒa_h—d”s
) {

9843 
mg_¡r
 
	gnuÎ_¡r
 = 
MG_NULL_STR
;

9844 
mg_£nd_websock‘_hªdshake3v
(

9845 
nc
, 
mg_mk_¡r
(
·th
), 
nuÎ_¡r
 ,‚ull_str ,

9846 
mg_mk_¡r
(
exŒa_h—d”s
), 
nuÎ_¡r
 ,‚ull_str );

9849 
mg_cÚÃùiÚ
 *
mg_cÚÃù_ws_İt
(

9850 
mg_mgr
 *
mgr
, 
MG_CB
(
mg_ev’t_hªdËr_t
 
ev_hªdËr
, *
u£r_d©a
),

9851 
mg_cÚÃù_İts
 
İts
, cÚ¡ *
u¾
, cÚ¡ *
´ÙocŞ
,

9852 cÚ¡ *
exŒa_h—d”s
) {

9853 
mg_¡r
 
	gnuÎ_¡r
 = 
MG_NULL_STR
;

9854 
mg_¡r
 
	gho¡
 = 
MG_NULL_STR
, 
	g·th
 = MG_NULL_STR, 
	gu£r_šfo
 = MG_NULL_STR;

9855 
mg_cÚÃùiÚ
 *
	gnc
 =

9856 
mg_cÚÃù_h‰p_ba£
(
mgr
, 
MG_CB
(
ev_hªdËr
, 
u£r_d©a
), 
İts
, "http",

9857 "ws", "h‰ps", "wss", 
u¾
, &
·th
, &
u£r_šfo
, &
ho¡
);

9858 ià(
	gnc
 !ğ
NULL
) {

9859 
mg_£nd_websock‘_hªdshake3v
(
nc
, 
·th
, 
ho¡
, 
mg_mk_¡r
(
´ÙocŞ
),

9860 
mg_mk_¡r
(
exŒa_h—d”s
), 
u£r_šfo
,

9861 
nuÎ_¡r
);

9863  
	gnc
;

9866 
mg_cÚÃùiÚ
 *
mg_cÚÃù_ws
(

9867 
mg_mgr
 *
mgr
, 
MG_CB
(
mg_ev’t_hªdËr_t
 
ev_hªdËr
, *
u£r_d©a
),

9868 cÚ¡ *
u¾
, cÚ¡ *
´ÙocŞ
, cÚ¡ *
exŒa_h—d”s
) {

9869 
mg_cÚÃù_İts
 
	gİts
;

9870 
mem£t
(&
İts
, 0, (opts));

9871  
mg_cÚÃù_ws_İt
(
mgr
, 
MG_CB
(
ev_hªdËr
, 
u£r_d©a
), 
İts
, 
u¾
,

9872 
´ÙocŞ
, 
exŒa_h—d”s
);

9875 #ifdeà
MG_MODULE_LINES


9888 #iâdeà
MAX


9889 
	#MAX
(
a
, 
b
è(×è> (bè? (aè: (b))

	)

9892 cÚ¡ *
mg_sk
(cÚ¡ *
s
, cÚ¡ *
’d
, cÚ¡ *
d–ims
,

9893 
mg_¡r
 *
v
) {

9894 
	gv
->
	gp
 = 
s
;

9895 
	gs
 < 
	g’d
 && 
¡rchr
(
d–ims
, *(*è
s
è=ğ
NULL
) s++;

9896 
	gv
->
	gËn
 = 
s
 - 
v
->
p
;

9897 
	gs
 < 
	g’d
 && 
¡rchr
(
d–ims
, *(*è
s
è!ğ
NULL
) s++;

9898  
	gs
;

9901 #ià
MG_ENABLE_FILESYSTEM
 && !
defšed
(
MG_USER_FILE_FUNCTIONS
)

9902 
mg_¡©
(cÚ¡ *
·th
, 
cs_¡©_t
 *
¡
) {

9903 #ifdeà
_WIN32


9904 
wch¬_t
 
	gw·th
[
MG_MAX_PATH
];

9905 
to_wch¬
(
·th
, 
w·th
, 
ARRAY_SIZE
(wpath));

9906 
DBG
(("[%ls] -> %d", 
w·th
, 
_w¡©i64
(w·th, 
¡
)));

9907  
_w¡©i64
(
w·th
, 
¡
);

9909  
¡©
(
·th
, 
¡
);

9913 
FILE
 *
mg_fİ’
(cÚ¡ *
·th
, cÚ¡ *
mode
) {

9914 #ifdeà
_WIN32


9915 
wch¬_t
 
	gw·th
[
MG_MAX_PATH
], 
	gwmode
[10];

9916 
to_wch¬
(
·th
, 
w·th
, 
ARRAY_SIZE
(wpath));

9917 
to_wch¬
(
mode
, 
wmode
, 
ARRAY_SIZE
(wmode));

9918  
_wfİ’
(
w·th
, 
wmode
);

9920  
fİ’
(
·th
, 
mode
);

9924 
mg_İ’
(cÚ¡ *
·th
, 
æag
, 
mode
) {

9925 #ià
defšed
(
_WIN32
è&& !defšed(
WINCE
)

9926 
wch¬_t
 
	gw·th
[
MG_MAX_PATH
];

9927 
to_wch¬
(
·th
, 
w·th
, 
ARRAY_SIZE
(wpath));

9928  
_wİ’
(
w·th
, 
æag
, 
mode
);

9930  
İ’
(
·th
, 
æag
, 
mode
);

9934 
size_t
 
mg_ä—d
(*
±r
, size_ˆ
size
, size_ˆ
couÁ
, 
FILE
 *
f
) {

9935  
ä—d
(
±r
, 
size
, 
couÁ
, 
f
);

9938 
size_t
 
mg_fwr™e
(cÚ¡ *
±r
, size_ˆ
size
, size_ˆ
couÁ
, 
FILE
 *
f
) {

9939  
fwr™e
(
±r
, 
size
, 
couÁ
, 
f
);

9943 
mg_ba£64_’code
(cÚ¡ *
¤c
, 
¤c_Ën
, *
d¡
) {

9944 
cs_ba£64_’code
(
¤c
, 
¤c_Ën
, 
d¡
);

9947 
mg_ba£64_decode
(cÚ¡ *
s
, 
Ën
, *
d¡
) {

9948  
cs_ba£64_decode
(
s
, 
Ën
, 
d¡
, 
NULL
);

9951 #ià
MG_ENABLE_THREADS


9952 *
mg_¡¬t_th»ad
(*(*
f
)(*), *
p
) {

9953 #ifdeà
WINCE


9954  (*è
C»©eTh»ad
(
NULL
, 0, (
LPTHREAD_START_ROUTINE
è
f
, 
p
, 0, NULL);

9955 #–ià
defšed
(
_WIN32
)

9956  (*è
_begšth»ad
(((
__cdeş
 *è(*èè
f
, 0, 
p
);

9958 
±h»ad_t
 
	gth»ad_id
 = (pthread_t) 0;

9959 
±h»ad_©Œ_t
 
	g©Œ
;

9961 (è
±h»ad_©Œ_š™
(&
©Œ
);

9962 (è
±h»ad_©Œ_£td‘ach¡©e
(&
©Œ
, 
PTHREAD_CREATE_DETACHED
);

9964 #ià
defšed
(
MG_STACK_SIZE
) && MG_STACK_SIZE > 1

9965 (è
±h»ad_©Œ_£t¡acksize
(&
©Œ
, 
MG_STACK_SIZE
);

9968 
±h»ad_ü—‹
(&
th»ad_id
, &
©Œ
, 
f
, 
p
);

9969 
±h»ad_©Œ_de¡roy
(&
©Œ
);

9971  (*è
	gth»ad_id
;

9977 
mg_£t_şo£_Ú_exec
(
sock_t
 
sock
) {

9978 #ià
defšed
(
_WIN32
è&& !defšed(
WINCE
)

9979 (è
S‘HªdËInfÜm©iÚ
((
HANDLE
è
sock
, 
HANDLE_FLAG_INHERIT
, 0);

9980 #–ià
defšed
(
__unix__
)

9981 
fú
(
sock
, 
F_SETFD
, 
FD_CLOEXEC
);

9983 (è
	gsock
;

9987 
mg_sock_addr_to_¡r
(cÚ¡ 
sock‘_add»ss
 *
§
, *
buf
, 
size_t
 
Ën
,

9988 
æags
) {

9989 
	gis_v6
;

9990 ià(
	gbuf
 =ğ
NULL
 || 
Ën
 <= 0)  0;

9991 
mem£t
(
buf
, 0, 
Ën
);

9992 #ià
MG_ENABLE_IPV6


9993 
	gis_v6
 = 
§
->§.
§_çmy
 =ğ
AF_INET6
;

9995 
	gis_v6
 = 0;

9997 ià(
	gæags
 & 
	gMG_SOCK_STRINGIFY_IP
) {

9998 #ià
MG_ENABLE_IPV6


9999 cÚ¡ *
	gaddr
 = 
NULL
;

10000 *
	g¡¬t
 = 
buf
;

10001 
sockËn_t
 
	gÿ·c™y
 = 
Ën
;

10002 ià(!
	gis_v6
) {

10003 
	gaddr
 = &
§
->
sš
.
sš_addr
;

10005 
	gaddr
 = (*è&
§
->
sš6
.
sš6_addr
;

10006 ià(
	gæags
 & 
	gMG_SOCK_STRINGIFY_PORT
) {

10007 *
	gbuf
 = '[';

10008 
	g¡¬t
++;

10009 
	gÿ·c™y
--;

10012 ià(
š‘_Áİ
(
§
->§.
§_çmy
, 
addr
, 
¡¬t
, 
ÿ·c™y
è=ğ
NULL
) {

10013 
ş—nup
;

10015 #–ià
defšed
(
_WIN32
è|| 
MG_LWIP
 || (
MG_NET_IF
 =ğ
MG_NET_IF_PIC32
)

10017 *
	gaddr_¡r
 = 
š‘_Áß
(
§
->
sš
.
sš_addr
);

10018 ià(
	gaddr_¡r
 !ğ
NULL
) {

10019 
¡ºıy
(
buf
, 
š‘_Áß
(
§
->
sš
.
sš_addr
), 
Ën
 - 1);

10021 
	gş—nup
;

10024 ià(
š‘_Áİ
(
AF_INET
, (*è&
§
->
sš
.
sš_addr
, 
buf
, 
Ën
 - 1è=ğ
NULL
) {

10025 
ş—nup
;

10029 ià(
	gæags
 & 
	gMG_SOCK_STRINGIFY_PORT
) {

10030 
	gpÜt
 = 
Áohs
(
§
->
sš
.
sš_pÜt
);

10031 ià(
	gæags
 & 
	gMG_SOCK_STRINGIFY_IP
) {

10032 
	gbuf_Ën
 = 
¡¾’
(
buf
);

10033 
¢´štf
(
buf
 + 
buf_Ën
, 
Ën
 - (buf_ËÀ+ 1), "%s:%d", (
is_v6
 ? "]" : ""),

10034 
pÜt
);

10036 
¢´štf
(
buf
, 
Ën
, "%d", 
pÜt
);

10040  
¡¾’
(
buf
);

10042 
	gş—nup
:

10043 *
buf
 = '\0';

10047 
mg_cÚn_addr_to_¡r
(
mg_cÚÃùiÚ
 *
nc
, *
buf
, 
size_t
 
Ën
,

10048 
æags
) {

10049 
sock‘_add»ss
 
	g§
;

10050 
mem£t
(&
§
, 0, (sa));

10051 
mg_if_g‘_cÚn_addr
(
nc
, 
æags
 & 
MG_SOCK_STRINGIFY_REMOTE
, &
§
);

10052  
mg_sock_addr_to_¡r
(&
§
, 
buf
, 
Ën
, 
æags
);

10055 #ià
MG_ENABLE_HEXDUMP


10056 
mg_hexdump_n
(cÚ¡ *
buf
, 
Ën
, *
d¡
, 
d¡_Ën
,

10057 
off£t
) {

10058 cÚ¡ *
	gp
 = (cÚ¡ *è
buf
;

10059 
	gascii
[17] = "";

10060 
	gi
, 
	gidx
, 
	gn
 = 0;

10062 
	gi
 = 0; i < 
	gËn
; i++) {

10063 
	gidx
 = 
i
 % 16;

10064 ià(
	gidx
 == 0) {

10065 ià(
i
 > 0è
n
 +ğ
¢´štf
(
d¡
 +‚, 
MAX
(
d¡_Ën
 -‚, 0), " %s\n", 
ascii
);

10066 
	gn
 +ğ
¢´štf
(
d¡
 + 
n
, 
MAX
(
d¡_Ën
 -‚, 0), "%04x ", 
i
 + 
off£t
);

10068 ià(
	gd¡_Ën
 - 
	gn
 < 0) {

10069  
	gn
;

10071 
	gn
 +ğ
¢´štf
(
d¡
 + 
n
, 
MAX
(
d¡_Ën
 -‚, 0), " %02x", 
p
[
i
]);

10072 
	gascii
[
idx
] = 
p
[
i
] < 0x20 ||…[i] > 0x7e ? '.' :…[i];

10073 
	gascii
[
idx
 + 1] = '\0';

10076 
	gi
++ % 16è
	gn
 +ğ
¢´štf
(
d¡
 + 
n
, 
MAX
(
d¡_Ën
 -‚, 0), "%s", " ");

10077 
	gn
 +ğ
¢´štf
(
d¡
 + 
n
, 
MAX
(
d¡_Ën
 -‚, 0), " %s\n", 
ascii
);

10079  
	gn
;

10082 
mg_hexdump
(cÚ¡ *
buf
, 
Ën
, *
d¡
, 
d¡_Ën
) {

10083  
mg_hexdump_n
(
buf
, 
Ën
, 
d¡
, 
d¡_Ën
, 0);

10086 
mg_hexdumpf
(
FILE
 *
å
, cÚ¡ *
buf
, 
Ën
) {

10087 
	gtmp
[80];

10088 
	goff£t
 = 0, 
	gn
;

10089 
	gËn
 > 0) {

10090 
	gn
 = (
Ën
 < 16 ?†en : 16);

10091 
mg_hexdump_n
(((cÚ¡ *è
buf
è+ 
off£t
, 
n
, 
tmp
, (tmp), offset);

10092 
åuts
(
tmp
, 
å
);

10093 
	goff£t
 +ğ
n
;

10094 
	gËn
 -ğ
n
;

10098 
mg_hexdump_cÚÃùiÚ
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

10099 cÚ¡ *
buf
, 
num_by‹s
, 
ev
) {

10100 
FILE
 *
	gå
 = 
NULL
;

10101 
	g¤c
[60], 
	gd¡
[60];

10102 cÚ¡ *
	gg
 = 
NULL
;

10103 
	gev
) {

10104 
	gMG_EV_RECV
:

10105 
g
 = "<-";

10107 
	gMG_EV_SEND
:

10108 
g
 = "->";

10110 
	gMG_EV_ACCEPT
:

10111 
g
 = "<A";

10113 
	gMG_EV_CONNECT
:

10114 
g
 = "C>";

10116 
	gMG_EV_CLOSE
:

10117 
g
 = "XX";

10120 ià(
	gg
 =ğ
NULL
) ;

10122 ià(
¡rcmp
(
·th
, "-") == 0) {

10123 
å
 = 
¡dout
;

10124 } ià(
¡rcmp
(
·th
, "--") == 0) {

10125 
å
 = 
¡d”r
;

10126 #ià
MG_ENABLE_FILESYSTEM


10128 
	gå
 = 
mg_fİ’
(
·th
, "a");

10131 ià(
	gå
 =ğ
NULL
) ;

10133 
mg_cÚn_addr_to_¡r
(
nc
, 
¤c
, (src),

10134 
MG_SOCK_STRINGIFY_IP
 | 
MG_SOCK_STRINGIFY_PORT
);

10135 
mg_cÚn_addr_to_¡r
(
nc
, 
d¡
, (d¡), 
MG_SOCK_STRINGIFY_IP
 |

10136 
MG_SOCK_STRINGIFY_PORT
 |

10137 
MG_SOCK_STRINGIFY_REMOTE
);

10138 
årštf
(
å
, "%lu %°% % % %d\n", (è
mg_time
(), (*è
nc
,

10139 
¤c
, 
g
, 
d¡
, (è
num_by‹s
);

10140 ià(
	gnum_by‹s
 > 0) {

10141 
mg_hexdumpf
(
å
, 
buf
, 
num_by‹s
);

10143 ià(
	gå
 !ğ
¡dout
 && 
å
 !ğ
¡d”r
è
fşo£
(fp);

10147 
mg_is_big_’dŸn
() {

10148 cÚ¡ 
	gn
 = 1;

10150  ((*è&
	gn
)[0] == 0;

10153 
DO_NOT_WARN_UNUSED
 
MG_INTERNAL
 
mg_g‘_”ºo
() {

10154 #iâdeà
WINCE


10155  
	g”ºo
;

10158  
G‘La¡E¼Ü
();

10162 
mg_mbuf_­³nd_ba£64_putc
(
ch
, *
u£r_d©a
) {

10163 
mbuf
 *
	gmbuf
 = (mbuà*è
u£r_d©a
;

10164 
mbuf_­³nd
(
mbuf
, &
ch
, (ch));

10167 
mg_mbuf_­³nd_ba£64
(
mbuf
 *mbuf, cÚ¡ *
d©a
, 
size_t
 
Ën
) {

10168 
cs_ba£64_ùx
 
	gùx
;

10169 
cs_ba£64_š™
(&
ùx
, 
mg_mbuf_­³nd_ba£64_putc
, 
mbuf
);

10170 
cs_ba£64_upd©e
(&
ùx
, (cÚ¡ *è
d©a
, 
Ën
);

10171 
cs_ba£64_fšish
(&
ùx
);

10174 
mg_basic_auth_h—d”
(cÚ¡ 
mg_¡r
 
u£r
, cÚ¡ mg_¡¸
·ss
,

10175 
mbuf
 *
buf
) {

10176 cÚ¡ *
	gh—d”_´efix
 = "Authorization: Basic ";

10177 cÚ¡ *
	gh—d”_suffix
 = "\r\n";

10179 
cs_ba£64_ùx
 
	gùx
;

10180 
cs_ba£64_š™
(&
ùx
, 
mg_mbuf_­³nd_ba£64_putc
, 
buf
);

10182 
mbuf_­³nd
(
buf
, 
h—d”_´efix
, 
¡¾’
(header_prefix));

10184 
cs_ba£64_upd©e
(&
ùx
, 
u£r
.
p
, u£r.
Ën
);

10185 ià(
	g·ss
.
	gËn
 > 0) {

10186 
cs_ba£64_upd©e
(&
ùx
, ":", 1);

10187 
cs_ba£64_upd©e
(&
ùx
, 
·ss
.
p
,…ass.
Ën
);

10189 
cs_ba£64_fšish
(&
ùx
);

10190 
mbuf_­³nd
(
buf
, 
h—d”_suffix
, 
¡¾’
(header_suffix));

10193 
mg_¡r
 
mg_u¾_’code
(cÚ¡ mg_¡¸
¤c
) {

10194 cÚ¡ *
	gdÚt_esÿ³
 = "._-$,;~()/";

10195 cÚ¡ *
	ghex
 = "0123456789abcdef";

10196 
size_t
 
	gi
 = 0;

10197 
mbuf
 
	gmb
;

10198 
mbuf_š™
(&
mb
, 
¤c
.
Ën
);

10200 
	gi
 = 0; i < 
	g¤c
.
	gËn
; i++) {

10201 cÚ¡ 
	gc
 = *((cÚ¡ *è
¤c
.
p
 + 
i
);

10202 ià(
i§Êum
(
c
è|| 
¡rchr
(
dÚt_esÿ³
, cè!ğ
NULL
) {

10203 
mbuf_­³nd
(&
mb
, &
c
, 1);

10205 
mbuf_­³nd
(&
mb
, "%", 1);

10206 
mbuf_­³nd
(&
mb
, &
hex
[
c
 >> 4], 1);

10207 
mbuf_­³nd
(&
mb
, &
hex
[
c
 & 15], 1);

10210 
mbuf_­³nd
(&
mb
, "", 1);

10211 
mbuf_Œim
(&
mb
);

10212  
mg_mk_¡r_n
(
mb
.
buf
, mb.
Ën
 - 1);

10214 #ifdeà
MG_MODULE_LINES


10222 #ià
MG_ENABLE_MQTT


10224 
	~<¡ršg.h
>

10229 
ušt16_t
 
g‘u16
(cÚ¡ *
p
) {

10230 cÚ¡ 
ušt8_t
 *
	gup
 = (cÚ¡ ušt8_ˆ*è
p
;

10231  (
	gup
[0] << 8) + up[1];

10234 cÚ¡ *
sÿÁo
(cÚ¡ *
p
, 
mg_¡r
 *
s
) {

10235 
	gs
->
	gËn
 = 
g‘u16
(
p
);

10236 
	gs
->
	gp
 = 
p
 + 2;

10237  
	gs
->
	gp
 + s->
	gËn
;

10240 
MG_INTERNAL
 
·r£_mq‰
(
mbuf
 *
io
, 
mg_mq‰_mes§ge
 *
mm
) {

10241 
ušt8_t
 
	gh—d”
;

10242 
size_t
 
	gËn
 = 0, 
	gËn_Ën
 = 0;

10243 cÚ¡ *
	gp
, *
	g’d
;

10244 
	glc
 = 0;

10245 
	gcmd
;

10247 ià(
	gio
->
	gËn
 < 2)  -1;

10248 
	gh—d”
 = 
io
->
buf
[0];

10249 
	gcmd
 = 
h—d”
 >> 4;

10252 
	gËn
 = 
Ën_Ën
 = 0;

10253 
	gp
 = 
io
->
buf
 + 1;

10254 (
	gsize_t
)(
	gp
 - 
	gio
->
	gbuf
è< io->
	gËn
) {

10255 
	glc
 = *((cÚ¡ *è
p
++);

10256 
	gËn
 +ğ(
lc
 & 0x7fè<< 7 * 
Ën_Ën
;

10257 
	gËn_Ën
++;

10258 ià(!(
	glc
 & 0x80)) ;

10259 ià(
	gËn_Ën
 > 4)  -2;

10262 
	g’d
 = 
p
 + 
Ën
;

10263 ià(
	glc
 & 0x80 || 
	gËn
 > (
	gio
->ËÀ- (
	gp
 - io->
	gbuf
))) {

10267 
	gmm
->
	gcmd
 = 
cmd
;

10268 
	gmm
->
	gqos
 = 
MG_MQTT_GET_QOS
(
h—d”
);

10270 
	gcmd
) {

10271 
	gMG_MQTT_CMD_CONNECT
: {

10272 
p
 = 
sÿÁo
Õ, &
mm
->
´ÙocŞ_Çme
);

10273 ià(
	gp
 > 
	g’d
 - 4)  -2;

10274 
	gmm
->
	g´ÙocŞ_v”siÚ
 = *(
ušt8_t
 *è
p
++;

10275 
	gmm
->
	gcÚÃù_æags
 = *(
ušt8_t
 *è
p
++;

10276 
	gmm
->
	gk“p_®ive_tim”
 = 
g‘u16
(
p
);

10277 
	gp
 += 2;

10278 ià(
	gp
 >ğ
’d
)  -2;

10279 
	gp
 = 
sÿÁo
(
p
, &
mm
->
ş›Á_id
);

10280 ià(
	gp
 > 
	g’d
)  -2;

10281 ià(
	gmm
->
	gcÚÃù_æags
 & 
	gMG_MQTT_HAS_WILL
) {

10282 ià(
	gp
 >ğ
’d
)  -2;

10283 
	gp
 = 
sÿÁo
(
p
, &
mm
->
wl_tİic
);

10285 ià(
	gmm
->
	gcÚÃù_æags
 & 
	gMG_MQTT_HAS_WILL
) {

10286 ià(
	gp
 >ğ
’d
)  -2;

10287 
	gp
 = 
sÿÁo
(
p
, &
mm
->
wl_mes§ge
);

10289 ià(
	gmm
->
	gcÚÃù_æags
 & 
	gMG_MQTT_HAS_USER_NAME
) {

10290 ià(
	gp
 >ğ
’d
)  -2;

10291 
	gp
 = 
sÿÁo
(
p
, &
mm
->
u£r_Çme
);

10293 ià(
	gmm
->
	gcÚÃù_æags
 & 
	gMG_MQTT_HAS_PASSWORD
) {

10294 ià(
	gp
 >ğ
’d
)  -2;

10295 
	gp
 = 
sÿÁo
(
p
, &
mm
->
·sswÜd
);

10297 ià(
	gp
 !ğ
’d
)  -2;

10299 
LOG
(
LL_DEBUG
,

10302 (è
Ën
, (è
mm
->
cÚÃù_æags
, (èmm->
k“p_®ive_tim”
,

10303 (è
mm
->
´ÙocŞ_Çme
.
Ën
, mm->´ÙocŞ_Çme.
p
,

10304 (è
mm
->
ş›Á_id
.
Ën
, mm->ş›Á_id.
p
, (èmm->
wl_tİic
.len,

10305 
mm
->
wl_tİic
.
p
, (èmm->
wl_mes§ge
.
Ën
, mm->will_message.p,

10306 (è
mm
->
u£r_Çme
.
Ën
, mm->u£r_Çme.
p
, (èmm->
·sswÜd
.len,

10307 
mm
->
·sswÜd
.
p
));

10310 
	gMG_MQTT_CMD_CONNACK
:

10311 ià(
’d
 - 
p
 < 2)  -2;

10312 
	gmm
->
	gcÚÇck_»t_code
 = 
p
[1];

10314 
	gMG_MQTT_CMD_PUBACK
:

10315 
MG_MQTT_CMD_PUBREC
:

10316 
MG_MQTT_CMD_PUBREL
:

10317 
MG_MQTT_CMD_PUBCOMP
:

10318 
MG_MQTT_CMD_SUBACK
:

10319 
mm
->
mes§ge_id
 = 
g‘u16
(
p
);

10321 
	gMG_MQTT_CMD_PUBLISH
: {

10322 
p
 = 
sÿÁo
Õ, &
mm
->
tİic
);

10323 ià(
	gp
 > 
	g’d
)  -2;

10324 ià(
	gmm
->
	gqos
 > 0) {

10325 ià(
	g’d
 - 
	gp
 < 2)  -2;

10326 
	gmm
->
	gmes§ge_id
 = 
g‘u16
(
p
);

10327 
	gp
 += 2;

10329 
	gmm
->
	g·ylßd
.
	gp
 = 
p
;

10330 
	gmm
->
	g·ylßd
.
	gËn
 = 
’d
 - 
p
;

10333 
	gMG_MQTT_CMD_SUBSCRIBE
:

10334 ià(
’d
 - 
p
 < 2)  -2;

10335 
	gmm
->
	gmes§ge_id
 = 
g‘u16
(
p
);

10336 
	gp
 += 2;

10341 
	gmm
->
	g·ylßd
.
	gp
 = 
p
;

10342 
	gmm
->
	g·ylßd
.
	gËn
 = 
’d
 - 
p
;

10349 
	gmm
->
	gËn
 = 
’d
 - 
io
->
buf
;

10350  
	gmm
->
	gËn
;

10353 
mq‰_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
,

10354 *
ev_d©a
 
MG_UD_ARG
(*
u£r_d©a
)) {

10355 
mbuf
 *
	gio
 = &
nc
->
»cv_mbuf
;

10356 
mg_mq‰_mes§ge
 
	gmm
;

10357 
mem£t
(&
mm
, 0, (mm));

10359 
	gnc
->
hªdËr
(
nc
, 
ev
, 
ev_d©a
 
MG_UD_ARG
(
u£r_d©a
));

10361 
	gev
) {

10362 
	gMG_EV_ACCEPT
:

10363 ià(
nc
->
´Ùo_d©a
 =ğ
NULL
è
mg_£t_´ÙocŞ_mq‰
(nc);

10365 
	gMG_EV_RECV
: {

10368 
Ën
 = 
·r£_mq‰
(
io
, &
mm
);

10369 ià(
	gËn
 < 0) {

10370 ià(
	gËn
 == -1) ;

10372 
	gnc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

10375 
	gnc
->
hªdËr
(
nc
, 
MG_MQTT_EVENT_BASE
 + 
mm
.
cmd
, &mm 
MG_UD_ARG
(
u£r_d©a
));

10376 
mbuf_»move
(
io
, 
Ën
);

10380 
	gMG_EV_POLL
: {

10381 
mg_mq‰_´Ùo_d©a
 *
pd
 =

10382 (
mg_mq‰_´Ùo_d©a
 *è
nc
->
´Ùo_d©a
;

10383 
	gnow
 = 
mg_time
();

10384 ià(
	gpd
->
	gk“p_®ive
 > 0 &&…d->
	gÏ¡_cÚŒŞ_time
 > 0 &&

10385 (
	gnow
 - 
	gpd
->
	gÏ¡_cÚŒŞ_time
è>…d->
	gk“p_®ive
) {

10386 
LOG
(
LL_DEBUG
, ("Send PINGREQ"));

10387 
mg_mq‰_pšg
(
nc
);

10394 
mg_mq‰_´Ùo_d©a_de¡ruùÜ
(*
´Ùo_d©a
) {

10395 
MG_FREE
(
´Ùo_d©a
);

10398 
mg_mq‰_m©ch_tİic_ex´essiÚ
(
mg_¡r
 
exp
, mg_¡¸
tİic
) {

10400 ià(
memchr
(
exp
.
p
, '#',ƒxp.
Ën
)) {

10402 
	gexp
.
	gËn
 -= 1;

10407 ià(
	gtİic
.
	gËn
 <ğ
exp
.
Ën
) {

10412 
	gtİic
.
	gËn
 = 
exp
.
Ën
;

10414 ià(
	gtİic
.
	gËn
 !ğ
exp
.
Ën
) {

10417  
¡ºcmp
(
tİic
.
p
, 
exp
.p,ƒxp.
Ën
) == 0;

10420 
mg_mq‰_vm©ch_tİic_ex´essiÚ
(cÚ¡ *
exp
, 
mg_¡r
 
tİic
) {

10421  
mg_mq‰_m©ch_tİic_ex´essiÚ
(
mg_mk_¡r
(
exp
), 
tİic
);

10424 
mg_£t_´ÙocŞ_mq‰
(
mg_cÚÃùiÚ
 *
nc
) {

10425 
	gnc
->
	g´Ùo_hªdËr
 = 
mq‰_hªdËr
;

10426 
	gnc
->
	g´Ùo_d©a
 = 
MG_CALLOC
(1, (
mg_mq‰_´Ùo_d©a
));

10427 
	gnc
->
	g´Ùo_d©a_de¡ruùÜ
 = 
mg_mq‰_´Ùo_d©a_de¡ruùÜ
;

10430 
mg_mq‰_´•’d_h—d”
(
mg_cÚÃùiÚ
 *
nc
, 
ušt8_t
 
cmd
,

10431 
ušt8_t
 
æags
, 
size_t
 
Ën
) {

10432 
mg_mq‰_´Ùo_d©a
 *
	gpd
 = (mg_mq‰_´Ùo_d©¨*è
nc
->
´Ùo_d©a
;

10433 
size_t
 
	goff
 = 
nc
->
£nd_mbuf
.
Ën
 -†en;

10434 
ušt8_t
 
	gh—d”
 = 
cmd
 << 4 | (ušt8_tè
æags
;

10436 
ušt8_t
 
	gbuf
[1 + (
size_t
)];

10437 
ušt8_t
 *
	gvËn
 = &
buf
[1];

10439 
as£¹
(
nc
->
£nd_mbuf
.
Ën
 >=†en);

10441 
	gbuf
[0] = 
h—d”
;

10445 *
	gvËn
 = 
Ën
 % 0x80;

10446 
	gËn
 /= 0x80;

10447 ià(
	gËn
 > 0è*
	gvËn
 |= 0x80;

10448 
	gvËn
++;

10449 } 
	gËn
 > 0);

10451 
mbuf_š£¹
(&
nc
->
£nd_mbuf
, 
off
, 
buf
, 
vËn
 - buf);

10452 
	gpd
->
	gÏ¡_cÚŒŞ_time
 = 
mg_time
();

10455 
mg_£nd_mq‰_hªdshake
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
ş›Á_id
) {

10456 
mg_£nd_mq‰_hªdshake_İts
 
	gİts
;

10457 
mg_£nd_mq‰_hªdshake_İt
(
nc
, 
ş›Á_id
, 
İts
);

10460 
mg_£nd_mq‰_hªdshake_İt
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
ş›Á_id
,

10461 
mg_£nd_mq‰_hªdshake_İts
 
İts
) {

10462 
ušt16_t
 
	ghËn
, 
	gÆ’
, 
	g»m_Ën
 = 0;

10463 
mg_mq‰_´Ùo_d©a
 *
	gpd
 = (mg_mq‰_´Ùo_d©¨*è
nc
->
´Ùo_d©a
;

10465 
mg_£nd
(
nc
, "\00\04MQTT\04", 7);

10466 
	g»m_Ën
 += 7;

10468 ià(
	gİts
.
	gu£r_Çme
 !ğ
NULL
) {

10469 
İts
.
æags
 |ğ
MG_MQTT_HAS_USER_NAME
;

10471 ià(
	gİts
.
	g·sswÜd
 !ğ
NULL
) {

10472 
İts
.
æags
 |ğ
MG_MQTT_HAS_PASSWORD
;

10474 ià(
	gİts
.
	gwl_tİic
 !ğ
NULL
 && 
İts
.
wl_mes§ge
 != NULL) {

10475 
İts
.
æags
 |ğ
MG_MQTT_HAS_WILL
;

10477 ià(
	gİts
.
	gk“p_®ive
 == 0) {

10478 
İts
.
k“p_®ive
 = 60;

10481 
mg_£nd
(
nc
, &
İts
.
æags
, 1);

10482 
	g»m_Ën
 += 1;

10484 
	gÆ’
 = 
htÚs
(
İts
.
k“p_®ive
);

10485 
mg_£nd
(
nc
, &
Æ’
, 2);

10486 
	g»m_Ën
 += 2;

10488 
	ghËn
 = 
¡¾’
(
ş›Á_id
);

10489 
	gÆ’
 = 
htÚs
((
ušt16_t
è
hËn
);

10490 
mg_£nd
(
nc
, &
Æ’
, 2);

10491 
mg_£nd
(
nc
, 
ş›Á_id
, 
hËn
);

10492 
	g»m_Ën
 +ğ2 + 
hËn
;

10494 ià(
	gİts
.
	gæags
 & 
	gMG_MQTT_HAS_WILL
) {

10495 
	ghËn
 = 
¡¾’
(
İts
.
wl_tİic
);

10496 
	gÆ’
 = 
htÚs
((
ušt16_t
è
hËn
);

10497 
mg_£nd
(
nc
, &
Æ’
, 2);

10498 
mg_£nd
(
nc
, 
İts
.
wl_tİic
, 
hËn
);

10499 
	g»m_Ën
 +ğ2 + 
hËn
;

10501 
	ghËn
 = 
¡¾’
(
İts
.
wl_mes§ge
);

10502 
	gÆ’
 = 
htÚs
((
ušt16_t
è
hËn
);

10503 
mg_£nd
(
nc
, &
Æ’
, 2);

10504 
mg_£nd
(
nc
, 
İts
.
wl_mes§ge
, 
hËn
);

10505 
	g»m_Ën
 +ğ2 + 
hËn
;

10508 ià(
	gİts
.
	gæags
 & 
	gMG_MQTT_HAS_USER_NAME
) {

10509 
	ghËn
 = 
¡¾’
(
İts
.
u£r_Çme
);

10510 
	gÆ’
 = 
htÚs
((
ušt16_t
è
hËn
);

10511 
mg_£nd
(
nc
, &
Æ’
, 2);

10512 
mg_£nd
(
nc
, 
İts
.
u£r_Çme
, 
hËn
);

10513 
	g»m_Ën
 +ğ2 + 
hËn
;

10515 ià(
	gİts
.
	gæags
 & 
	gMG_MQTT_HAS_PASSWORD
) {

10516 
	ghËn
 = 
¡¾’
(
İts
.
·sswÜd
);

10517 
	gÆ’
 = 
htÚs
((
ušt16_t
è
hËn
);

10518 
mg_£nd
(
nc
, &
Æ’
, 2);

10519 
mg_£nd
(
nc
, 
İts
.
·sswÜd
, 
hËn
);

10520 
	g»m_Ën
 +ğ2 + 
hËn
;

10523 
mg_mq‰_´•’d_h—d”
(
nc
, 
MG_MQTT_CMD_CONNECT
, 0, 
»m_Ën
);

10525 ià(
	gpd
 !ğ
NULL
) {

10526 
pd
->
k“p_®ive
 = 
İts
.keep_alive;

10530 
mg_mq‰_publish
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
tİic
,

10531 
ušt16_t
 
mes§ge_id
, 
æags
, cÚ¡ *
d©a
,

10532 
size_t
 
Ën
) {

10533 
size_t
 
	gŞd_Ën
 = 
nc
->
£nd_mbuf
.
Ën
;

10535 
ušt16_t
 
	gtİic_Ën
 = 
htÚs
((ušt16_tè
¡¾’
(
tİic
));

10536 
ušt16_t
 
	gmes§ge_id_Ãt
 = 
htÚs
(
mes§ge_id
);

10538 
mg_£nd
(
nc
, &
tİic_Ën
, 2);

10539 
mg_£nd
(
nc
, 
tİic
, 
¡¾’
(topic));

10540 ià(
MG_MQTT_GET_QOS
(
æags
) > 0) {

10541 
mg_£nd
(
nc
, &
mes§ge_id_Ãt
, 2);

10543 
mg_£nd
(
nc
, 
d©a
, 
Ën
);

10545 
mg_mq‰_´•’d_h—d”
(
nc
, 
MG_MQTT_CMD_PUBLISH
, 
æags
,

10546 
nc
->
£nd_mbuf
.
Ën
 - 
Şd_Ën
);

10549 
mg_mq‰_subsüibe
(
mg_cÚÃùiÚ
 *
nc
,

10550 cÚ¡ 
mg_mq‰_tİic_ex´essiÚ
 *
tİics
,

10551 
size_t
 
tİics_Ën
, 
ušt16_t
 
mes§ge_id
) {

10552 
size_t
 
	gŞd_Ën
 = 
nc
->
£nd_mbuf
.
Ën
;

10554 
ušt16_t
 
	gmes§ge_id_n
 = 
htÚs
(
mes§ge_id
);

10555 
size_t
 
	gi
;

10557 
mg_£nd
(
nc
, (*è&
mes§ge_id_n
, 2);

10558 
	gi
 = 0; i < 
	gtİics_Ën
; i++) {

10559 
ušt16_t
 
	gtİic_Ën_n
 = 
htÚs
((ušt16_tè
¡¾’
(
tİics
[
i
].
tİic
));

10560 
mg_£nd
(
nc
, &
tİic_Ën_n
, 2);

10561 
mg_£nd
(
nc
, 
tİics
[
i
].
tİic
, 
¡¾’
(topics[i].topic));

10562 
mg_£nd
(
nc
, &
tİics
[
i
].
qos
, 1);

10565 
mg_mq‰_´•’d_h—d”
(
nc
, 
MG_MQTT_CMD_SUBSCRIBE
, 
MG_MQTT_QOS
(1),

10566 
nc
->
£nd_mbuf
.
Ën
 - 
Şd_Ën
);

10569 
mg_mq‰_Ãxt_subsüibe_tİic
(
mg_mq‰_mes§ge
 *
msg
,

10570 
mg_¡r
 *
tİic
, 
ušt8_t
 *
qos
, 
pos
) {

10571 *
	gbuf
 = (*è
msg
->
·ylßd
.
p
 + 
pos
;

10572 
	gÃw_pos
;

10574 ià((
	gsize_t
è
	gpos
 >ğ
msg
->
·ylßd
.
Ën
)  -1;

10576 
	gtİic
->
	gËn
 = 
buf
[0] << 8 | buf[1];

10577 
	gtİic
->
	gp
 = (*è
buf
 + 2;

10578 
	gÃw_pos
 = 
pos
 + 2 + 
tİic
->
Ën
 + 1;

10579 ià((
	gsize_t
è
	gÃw_pos
 > 
	gmsg
->
	g·ylßd
.
	gËn
)  -1;

10580 *
	gqos
 = 
buf
[2 + 
tİic
->
Ën
];

10581  
	gÃw_pos
;

10584 
mg_mq‰_unsubsüibe
(
mg_cÚÃùiÚ
 *
nc
, **
tİics
,

10585 
size_t
 
tİics_Ën
, 
ušt16_t
 
mes§ge_id
) {

10586 
size_t
 
	gŞd_Ën
 = 
nc
->
£nd_mbuf
.
Ën
;

10588 
ušt16_t
 
	gmes§ge_id_n
 = 
htÚs
(
mes§ge_id
);

10589 
size_t
 
	gi
;

10591 
mg_£nd
(
nc
, (*è&
mes§ge_id_n
, 2);

10592 
	gi
 = 0; i < 
	gtİics_Ën
; i++) {

10593 
ušt16_t
 
	gtİic_Ën_n
 = 
htÚs
((ušt16_tè
¡¾’
(
tİics
[
i
]));

10594 
mg_£nd
(
nc
, &
tİic_Ën_n
, 2);

10595 
mg_£nd
(
nc
, 
tİics
[
i
], 
¡¾’
(topics[i]));

10598 
mg_mq‰_´•’d_h—d”
(
nc
, 
MG_MQTT_CMD_UNSUBSCRIBE
, 
MG_MQTT_QOS
(1),

10599 
nc
->
£nd_mbuf
.
Ën
 - 
Şd_Ën
);

10602 
mg_mq‰_cÚÇck
(
mg_cÚÃùiÚ
 *
nc
, 
ušt8_t
 
»tuº_code
) {

10603 
ušt8_t
 
	gunu£d
 = 0;

10604 
mg_£nd
(
nc
, &
unu£d
, 1);

10605 
mg_£nd
(
nc
, &
»tuº_code
, 1);

10606 
mg_mq‰_´•’d_h—d”
(
nc
, 
MG_MQTT_CMD_CONNACK
, 0, 2);

10614 
mg_£nd_mq‰_shÜt_commªd
(
mg_cÚÃùiÚ
 *
nc
, 
ušt8_t
 
cmd
,

10615 
ušt16_t
 
mes§ge_id
) {

10616 
ušt16_t
 
	gmes§ge_id_Ãt
 = 
htÚs
(
mes§ge_id
);

10617 
ušt8_t
 
	gæags
 = (
cmd
 =ğ
MG_MQTT_CMD_PUBREL
 ? 2 : 0);

10618 
mg_£nd
(
nc
, &
mes§ge_id_Ãt
, 2);

10619 
mg_mq‰_´•’d_h—d”
(
nc
, 
cmd
, 
æags
, 2 );

10622 
mg_mq‰_puback
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
mes§ge_id
) {

10623 
mg_£nd_mq‰_shÜt_commªd
(
nc
, 
MG_MQTT_CMD_PUBACK
, 
mes§ge_id
);

10626 
mg_mq‰_pub»c
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
mes§ge_id
) {

10627 
mg_£nd_mq‰_shÜt_commªd
(
nc
, 
MG_MQTT_CMD_PUBREC
, 
mes§ge_id
);

10630 
mg_mq‰_pub»l
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
mes§ge_id
) {

10631 
mg_£nd_mq‰_shÜt_commªd
(
nc
, 
MG_MQTT_CMD_PUBREL
, 
mes§ge_id
);

10634 
mg_mq‰_pubcomp
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
mes§ge_id
) {

10635 
mg_£nd_mq‰_shÜt_commªd
(
nc
, 
MG_MQTT_CMD_PUBCOMP
, 
mes§ge_id
);

10638 
mg_mq‰_suback
(
mg_cÚÃùiÚ
 *
nc
, 
ušt8_t
 *
qoss
, 
size_t
 
qoss_Ën
,

10639 
ušt16_t
 
mes§ge_id
) {

10640 
size_t
 
	gi
;

10641 
ušt16_t
 
	gmes§ge_id_Ãt
 = 
htÚs
(
mes§ge_id
);

10642 
mg_£nd
(
nc
, &
mes§ge_id_Ãt
, 2);

10643 
	gi
 = 0; i < 
	gqoss_Ën
; i++) {

10644 
mg_£nd
(
nc
, &
qoss
[
i
], 1);

10646 
mg_mq‰_´•’d_h—d”
(
nc
, 
MG_MQTT_CMD_SUBACK
, 
MG_MQTT_QOS
(1), 2 + 
qoss_Ën
);

10649 
mg_mq‰_unsuback
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
mes§ge_id
) {

10650 
mg_£nd_mq‰_shÜt_commªd
(
nc
, 
MG_MQTT_CMD_UNSUBACK
, 
mes§ge_id
);

10653 
mg_mq‰_pšg
(
mg_cÚÃùiÚ
 *
nc
) {

10654 
mg_mq‰_´•’d_h—d”
(
nc
, 
MG_MQTT_CMD_PINGREQ
, 0, 0);

10657 
mg_mq‰_pÚg
(
mg_cÚÃùiÚ
 *
nc
) {

10658 
mg_mq‰_´•’d_h—d”
(
nc
, 
MG_MQTT_CMD_PINGRESP
, 0, 0);

10661 
mg_mq‰_discÚÃù
(
mg_cÚÃùiÚ
 *
nc
) {

10662 
mg_mq‰_´•’d_h—d”
(
nc
, 
MG_MQTT_CMD_DISCONNECT
, 0, 0);

10666 #ifdeà
MG_MODULE_LINES


10677 #ià
MG_ENABLE_MQTT_BROKER


10679 
mg_mq‰_£ssiÚ_š™
(
mg_mq‰_brok”
 *
brk
,

10680 
mg_mq‰_£ssiÚ
 *
s
,

10681 
mg_cÚÃùiÚ
 *
nc
) {

10682 
	gs
->
	gbrk
 = 
brk
;

10683 
	gs
->
	gsubsütiÚs
 = 
NULL
;

10684 
	gs
->
	gnum_subsütiÚs
 = 0;

10685 
	gs
->
	gnc
 = 
nc
;

10688 
mg_mq‰_add_£ssiÚ
(
mg_mq‰_£ssiÚ
 *
s
) {

10689 
LIST_INSERT_HEAD
(&
s
->
brk
->
£ssiÚs
, s, 
lšk
);

10692 
mg_mq‰_»move_£ssiÚ
(
mg_mq‰_£ssiÚ
 *
s
) {

10693 
LIST_REMOVE
(
s
, 
lšk
);

10696 
mg_mq‰_de¡roy_£ssiÚ
(
mg_mq‰_£ssiÚ
 *
s
) {

10697 
size_t
 
	gi
;

10698 
	gi
 = 0; i < 
	gs
->
	gnum_subsütiÚs
; i++) {

10699 
MG_FREE
((*è
s
->
subsütiÚs
[
i
].
tİic
);

10701 
MG_FREE
(
s
->
subsütiÚs
);

10702 
MG_FREE
(
s
);

10705 
mg_mq‰_şo£_£ssiÚ
(
mg_mq‰_£ssiÚ
 *
s
) {

10706 
mg_mq‰_»move_£ssiÚ
(
s
);

10707 
mg_mq‰_de¡roy_£ssiÚ
(
s
);

10710 
mg_mq‰_brok”_š™
(
mg_mq‰_brok”
 *
brk
, *
u£r_d©a
) {

10711 
LIST_INIT
(&
brk
->
£ssiÚs
);

10712 
	gbrk
->
	gu£r_d©a
 = 
u£r_d©a
;

10715 
mg_mq‰_brok”_hªdË_cÚÃù
(
mg_mq‰_brok”
 *
brk
,

10716 
mg_cÚÃùiÚ
 *
nc
) {

10717 
mg_mq‰_£ssiÚ
 *
	gs
 =

10718 (
mg_mq‰_£ssiÚ
 *è
MG_CALLOC
(1,  *
s
);

10719 ià(
	gs
 =ğ
NULL
) {

10721 
mg_mq‰_cÚÇck
(
nc
, 
MG_EV_MQTT_CONNACK_SERVER_UNAVAILABLE
);

10728 
mg_mq‰_£ssiÚ_š™
(
brk
, 
s
, 
nc
);

10729 
	gs
->
	gu£r_d©a
 = 
nc
->
u£r_d©a
;

10730 
	gnc
->
	gu£r_d©a
 = 
s
;

10731 
mg_mq‰_add_£ssiÚ
(
s
);

10733 
mg_mq‰_cÚÇck
(
nc
, 
MG_EV_MQTT_CONNACK_ACCEPTED
);

10736 
mg_mq‰_brok”_hªdË_subsüibe
(
mg_cÚÃùiÚ
 *
nc
,

10737 
mg_mq‰_mes§ge
 *
msg
) {

10738 
mg_mq‰_£ssiÚ
 *
	gss
 = (mg_mq‰_£ssiÚ *è
nc
->
u£r_d©a
;

10739 
ušt8_t
 
	gqoss
[
MG_MQTT_MAX_SESSION_SUBSCRIPTIONS
];

10740 
size_t
 
	gnum_subs
 = 0;

10741 
mg_¡r
 
	gtİic
;

10742 
ušt8_t
 
	gqos
;

10743 
	gpos
;

10744 
mg_mq‰_tİic_ex´essiÚ
 *
	g‹
;

10746 
	gpos
 = 0;

10747 (
	gpos
 = 
mg_mq‰_Ãxt_subsüibe_tİic
(
msg
, &
tİic
, &
qos
, 
pos
)) != -1;) {

10748 ià(
	gnum_subs
 >ğ(
MG_MQTT_MAX_SESSION_SUBSCRIPTIONS
) ||

10749 (
ss
->
num_subsütiÚs
 + 
num_subs
 >=

10750 
MG_MQTT_MAX_SESSION_SUBSCRIPTIONS
)) {

10751 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

10754 
	gqoss
[
num_subs
++] = 
qos
;

10757 ià(
	gnum_subs
 > 0) {

10758 
	g‹
 = (
mg_mq‰_tİic_ex´essiÚ
 *è
MG_REALLOC
(

10759 
ss
->
subsütiÚs
,

10760 (*
ss
->
subsütiÚs
è* (ss->
num_subsütiÚs
 + 
num_subs
));

10761 ià(
	g‹
 =ğ
NULL
) {

10762 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

10765 
	gss
->
	gsubsütiÚs
 = 
‹
;

10766 
	gpos
 = 0;

10767 
	gpos
 < (è
	gmsg
->
	g·ylßd
.
	gËn
 &&

10768 (
	gpos
 = 
mg_mq‰_Ãxt_subsüibe_tİic
(
msg
, &
tİic
, &
qos
, 
pos
)) != -1;

10769 
	gss
->
	gnum_subsütiÚs
++) {

10770 
	g‹
 = &
ss
->
subsütiÚs
[ss->
num_subsütiÚs
];

10771 
	g‹
->
	gtİic
 = (*è
MG_MALLOC
(
tİic
.
Ën
 + 1);

10772 
	g‹
->
	gqos
 = 
qos
;

10773 
memıy
((*è
‹
->
tİic
,İic.
p
,İic.
Ën
);

10774 ((*è
	g‹
->
	gtİic
)[
tİic
.
Ën
] = '\0';

10778 ià(
	gpos
 =ğ(è
msg
->
·ylßd
.
Ën
) {

10779 
mg_mq‰_suback
(
nc
, 
qoss
, 
num_subs
, 
msg
->
mes§ge_id
);

10782 
	gnc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

10786 
mg_mq‰_brok”_hªdË_publish
(
mg_mq‰_brok”
 *
brk
,

10787 
mg_mq‰_mes§ge
 *
msg
) {

10788 
mg_mq‰_£ssiÚ
 *
	gs
;

10789 
size_t
 
	gi
;

10791 
	gs
 = 
mg_mq‰_Ãxt
(
brk
, 
NULL
); s !ğNULL; s = mg_mq‰_Ãxt(brk, 
s
)) {

10792 
	gi
 = 0; i < 
	gs
->
	gnum_subsütiÚs
; i++) {

10793 ià(
mg_mq‰_vm©ch_tİic_ex´essiÚ
(
s
->
subsütiÚs
[
i
].
tİic
,

10794 
msg
->
tİic
)) {

10795 
	gbuf
[100], *
	gp
 = 
buf
;

10796 
mg_a¥rštf
(&
p
, (
buf
), "%.*s", (è
msg
->
tİic
.
Ën
,

10797 
msg
->
tİic
.
p
);

10798 ià(
	gp
 =ğ
NULL
) {

10801 
mg_mq‰_publish
(
s
->
nc
, 
p
, 0, 0, 
msg
->
·ylßd
.p, msg->·ylßd.
Ën
);

10802 ià(
	gp
 !ğ
buf
) {

10803 
MG_FREE
(
p
);

10811 
mg_mq‰_brok”
(
mg_cÚÃùiÚ
 *
nc
, 
ev
, *
d©a
) {

10812 
mg_mq‰_mes§ge
 *
	gmsg
 = (mg_mq‰_mes§g*è
d©a
;

10813 
mg_mq‰_brok”
 *
	gbrk
;

10815 ià(
	gnc
->
	gli¡’”
) {

10816 
	gbrk
 = (
mg_mq‰_brok”
 *è
nc
->
li¡’”
->
u£r_d©a
;

10818 
	gbrk
 = (
mg_mq‰_brok”
 *è
nc
->
u£r_d©a
;

10821 
	gev
) {

10822 
	gMG_EV_ACCEPT
:

10823 ià(
nc
->
´Ùo_d©a
 =ğ
NULL
è
mg_£t_´ÙocŞ_mq‰
(nc);

10824 
	gnc
->
	gu£r_d©a
 = 
NULL
;

10826 
	gMG_EV_MQTT_CONNECT
:

10827 ià(
nc
->
u£r_d©a
 =ğ
NULL
) {

10828 
mg_mq‰_brok”_hªdË_cÚÃù
(
brk
, 
nc
);

10831 
	gnc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

10834 
	gMG_EV_MQTT_SUBSCRIBE
:

10835 ià(
nc
->
u£r_d©a
 !ğ
NULL
) {

10836 
mg_mq‰_brok”_hªdË_subsüibe
(
nc
, 
msg
);

10839 
	gnc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

10842 
	gMG_EV_MQTT_PUBLISH
:

10843 ià(
nc
->
u£r_d©a
 !ğ
NULL
) {

10844 
mg_mq‰_brok”_hªdË_publish
(
brk
, 
msg
);

10847 
	gnc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

10850 
	gMG_EV_CLOSE
:

10851 ià(
nc
->
li¡’”
 &&‚c->
u£r_d©a
 !ğ
NULL
) {

10852 
mg_mq‰_şo£_£ssiÚ
((
mg_mq‰_£ssiÚ
 *è
nc
->
u£r_d©a
);

10858 
mg_mq‰_£ssiÚ
 *
mg_mq‰_Ãxt
(
mg_mq‰_brok”
 *
brk
,

10859 
mg_mq‰_£ssiÚ
 *
s
) {

10860  
	gs
 =ğ
NULL
 ? 
LIST_FIRST
(&
brk
->
£ssiÚs
è: 
LIST_NEXT
(
s
, 
lšk
);

10864 #ifdeà
MG_MODULE_LINES


10872 #ià
MG_ENABLE_DNS


10877 
	gmg_dns_tid
 = 0xa0;

10879 
	smg_dns_h—d”
 {

10880 
ušt16_t
 
	gŒª§ùiÚ_id
;

10881 
ušt16_t
 
	gæags
;

10882 
ušt16_t
 
	gnum_que¡iÚs
;

10883 
ušt16_t
 
	gnum_ªsw”s
;

10884 
ušt16_t
 
	gnum_authÜ™y_´s
;

10885 
ušt16_t
 
	gnum_Ùh”_´s
;

10888 
mg_dns_»sourû_»cÜd
 *
mg_dns_Ãxt_»cÜd
(

10889 
mg_dns_mes§ge
 *
msg
, 
qu”y
,

10890 
mg_dns_»sourû_»cÜd
 *
´ev
) {

10891 
mg_dns_»sourû_»cÜd
 *
	g¼
;

10893 
	g¼
 = (
´ev
 =ğ
NULL
 ? 
msg
->
ªsw”s
 :…rev + 1);

10894 
	g¼
 - 
	gmsg
->
	gªsw”s
 < msg->
	gnum_ªsw”s
;„r++) {

10895 ià(
	g¼
->
	g¹y³
 =ğ
qu”y
) {

10896  
¼
;

10899  
	gNULL
;

10902 
mg_dns_·r£_»cÜd_d©a
(
mg_dns_mes§ge
 *
msg
,

10903 
mg_dns_»sourû_»cÜd
 *
¼
, *
d©a
,

10904 
size_t
 
d©a_Ën
) {

10905 
	g¼
->
	g¹y³
) {

10906 
	gMG_DNS_A_RECORD
:

10907 ià(
d©a_Ën
 < (
š_addr
)) {

10910 ià(
	g¼
->
	grd©a
.
	gp
 + 
	gd©a_Ën
 > 
	gmsg
->
	gpkt
.°+ msg->pkt.
	gËn
) {

10913 
memıy
(
d©a
, 
¼
->
rd©a
.
p
, 
d©a_Ën
);

10915 #ià
MG_ENABLE_IPV6


10916 
	gMG_DNS_AAAA_RECORD
:

10917 ià(
d©a_Ën
 < (
š6_addr
)) {

10920 
memıy
(
d©a
, 
¼
->
rd©a
.
p
, 
d©a_Ën
);

10923 
	gMG_DNS_CNAME_RECORD
:

10924 
mg_dns_uncom´ess_Çme
(
msg
, &
¼
->
rd©a
, (*è
d©a
, 
d©a_Ën
);

10931 
mg_dns_š£¹_h—d”
(
mbuf
 *
io
, 
size_t
 
pos
,

10932 
mg_dns_mes§ge
 *
msg
) {

10933 
mg_dns_h—d”
 
	gh—d”
;

10935 
mem£t
(&
h—d”
, 0, (header));

10936 
	gh—d”
.
	gŒª§ùiÚ_id
 = 
msg
->
Œª§ùiÚ_id
;

10937 
	gh—d”
.
	gæags
 = 
htÚs
(
msg
->
æags
);

10938 
	gh—d”
.
	gnum_que¡iÚs
 = 
htÚs
(
msg
->
num_que¡iÚs
);

10939 
	gh—d”
.
	gnum_ªsw”s
 = 
htÚs
(
msg
->
num_ªsw”s
);

10941  
mbuf_š£¹
(
io
, 
pos
, &
h—d”
, (header));

10944 
mg_dns_cİy_que¡iÚs
(
mbuf
 *
io
, 
mg_dns_mes§ge
 *
msg
) {

10945 *
	gbegš
, *
	g’d
;

10946 
mg_dns_»sourû_»cÜd
 *
	gÏ¡_q
;

10947 ià(
	gmsg
->
	gnum_que¡iÚs
 <= 0)  0;

10948 
	gbegš
 = (*è
msg
->
pkt
.
p
 + (
mg_dns_h—d”
);

10949 
	gÏ¡_q
 = &
msg
->
que¡iÚs
[msg->
num_que¡iÚs
 - 1];

10950 
	g’d
 = (*è
Ï¡_q
->
Çme
.
p
 +†a¡_q->Çme.
Ën
 + 4;

10951  
mbuf_­³nd
(
io
, 
begš
, 
’d
 - begin);

10954 
mg_dns_’code_Çme
(
mbuf
 *
io
, cÚ¡ *
Çme
, 
size_t
 
Ën
) {

10955 cÚ¡ *
	gs
;

10956 
	gn
;

10957 
size_t
 
	gpos
 = 
io
->
Ën
;

10960 ià((
	gs
 = 
¡rchr
(
Çme
, '.')è=ğ
NULL
) {

10961 
s
 = 
Çme
 + 
Ën
;

10964 ià(
	gs
 - 
	gÇme
 > 127) {

10967 
	gn
 = 
s
 - 
Çme
;

10968 
mbuf_­³nd
(
io
, &
n
, 1);

10969 
mbuf_­³nd
(
io
, 
Çme
, 
n
);

10971 ià(*
	gs
 == '.') {

10972 
n
++;

10975 
	gÇme
 +ğ
n
;

10976 
	gËn
 -ğ
n
;

10977 } *
	gs
 != '\0');

10978 
mbuf_­³nd
(
io
, "\0", 1);

10980  
	gio
->
	gËn
 - 
	gpos
;

10983 
mg_dns_’code_»cÜd
(
mbuf
 *
io
, 
mg_dns_»sourû_»cÜd
 *
¼
,

10984 cÚ¡ *
Çme
, 
size_t
 
Æ’
, cÚ¡ *
rd©a
,

10985 
size_t
 
¾’
) {

10986 
size_t
 
	gpos
 = 
io
->
Ën
;

10987 
ušt16_t
 
	gu16
;

10988 
ušt32_t
 
	gu32
;

10990 ià(
	g¼
->
	gkšd
 =ğ
MG_DNS_INVALID_RECORD
) {

10994 ià(
mg_dns_’code_Çme
(
io
, 
Çme
, 
Æ’
) == -1) {

10998 
	gu16
 = 
htÚs
(
¼
->
¹y³
);

10999 
mbuf_­³nd
(
io
, &
u16
, 2);

11000 
	gu16
 = 
htÚs
(
¼
->
rşass
);

11001 
mbuf_­³nd
(
io
, &
u16
, 2);

11003 ià(
	g¼
->
	gkšd
 =ğ
MG_DNS_ANSWER
) {

11004 
u32
 = 
htÚl
(
¼
->
‰l
);

11005 
mbuf_­³nd
(
io
, &
u32
, 4);

11007 ià(
	g¼
->
	g¹y³
 =ğ
MG_DNS_CNAME_RECORD
) {

11008 
ş’
;

11010 
size_t
 
	goff
 = 
io
->
Ën
;

11011 
mbuf_­³nd
(
io
, &
u16
, 2);

11012 ià((
	gş’
 = 
mg_dns_’code_Çme
(
io
, (cÚ¡ *è
rd©a
, 
¾’
)) == -1) {

11015 
	gu16
 = 
ş’
;

11016 
	gio
->
	gbuf
[
off
] = 
u16
 >> 8;

11017 
	gio
->
	gbuf
[
off
 + 1] = 
u16
 & 0xff;

11019 
	gu16
 = 
htÚs
((
ušt16_t
è
¾’
);

11020 
mbuf_­³nd
(
io
, &
u16
, 2);

11021 
mbuf_­³nd
(
io
, 
rd©a
, 
¾’
);

11025  
	gio
->
	gËn
 - 
	gpos
;

11028 
mg_£nd_dns_qu”y
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
Çme
,

11029 
qu”y_ty³
) {

11030 
mg_dns_mes§ge
 *
	gmsg
 =

11031 (
mg_dns_mes§ge
 *è
MG_CALLOC
(1, (*
msg
));

11032 
mbuf
 
	gpkt
;

11033 
mg_dns_»sourû_»cÜd
 *
	g¼
 = &
msg
->
que¡iÚs
[0];

11035 
DBG
(("% %d", 
Çme
, 
qu”y_ty³
));

11037 
mbuf_š™
(&
pkt
, 64 );

11039 
	gmsg
->
	gŒª§ùiÚ_id
 = ++
mg_dns_tid
;

11040 
	gmsg
->
	gæags
 = 0x100;

11041 
	gmsg
->
	gnum_que¡iÚs
 = 1;

11043 
mg_dns_š£¹_h—d”
(&
pkt
, 0, 
msg
);

11045 
	g¼
->
	g¹y³
 = 
qu”y_ty³
;

11046 
	g¼
->
	grşass
 = 1;

11047 
	g¼
->
	gkšd
 = 
MG_DNS_QUESTION
;

11049 ià(
mg_dns_’code_»cÜd
(&
pkt
, 
¼
, 
Çme
, 
¡¾’
Òame), 
NULL
, 0) == -1) {

11051 
ş—nup
;

11055 ià(!(
	gnc
->
	gæags
 & 
	gMG_F_UDP
)) {

11056 
ušt16_t
 
	gËn
 = 
htÚs
((ušt16_tè
pkt
.
Ën
);

11057 
mbuf_š£¹
(&
pkt
, 0, &
Ën
, 2);

11060 
mg_£nd
(
nc
, 
pkt
.
buf
,…kt.
Ën
);

11061 
mbuf_ä“
(&
pkt
);

11063 
	gş—nup
:

11064 
MG_FREE
(
msg
);

11067 *
mg_·r£_dns_»sourû_»cÜd
(

11068 *
d©a
, *
’d
, 
mg_dns_»sourû_»cÜd
 *
¼
,

11069 
»¶y
) {

11070 *
	gÇme
 = 
d©a
;

11071 
	gchunk_Ën
, 
	gd©a_Ën
;

11073 
	gd©a
 < 
	g’d
 && (
	gchunk_Ën
 = *
d©a
)) {

11074 ià(((*è
d©a
)[0] & 0xc0) {

11075 
d©a
 += 1;

11078 
	gd©a
 +ğ
chunk_Ën
 + 1;

11081 ià(
	gd©a
 > 
	g’d
 - 5) {

11082  
	gNULL
;

11085 
	g¼
->
	gÇme
.
	gp
 = (*è
Çme
;

11086 
	g¼
->
	gÇme
.
	gËn
 = 
d©a
 - 
Çme
 + 1;

11087 
	gd©a
++;

11089 
	g¼
->
	g¹y³
 = 
d©a
[0] << 8 | data[1];

11090 
	gd©a
 += 2;

11092 
	g¼
->
	grşass
 = 
d©a
[0] << 8 | data[1];

11093 
	gd©a
 += 2;

11095 
	g¼
->
	gkšd
 = 
»¶y
 ? 
MG_DNS_ANSWER
 : 
MG_DNS_QUESTION
;

11096 ià(
	g»¶y
) {

11097 ià(
	gd©a
 >ğ
’d
 - 6) {

11098  
NULL
;

11101 
	g¼
->
	g‰l
 = (
ušt32_t
è
d©a
[0] << 24 | (uint32_t) data[1] << 16 |

11102 
d©a
[2] << 8 | data[3];

11103 
	gd©a
 += 4;

11105 
	gd©a_Ën
 = *
d©a
 << 8 | *(data + 1);

11106 
	gd©a
 += 2;

11108 
	g¼
->
	grd©a
.
	gp
 = (*è
d©a
;

11109 
	g¼
->
	grd©a
.
	gËn
 = 
d©a_Ën
;

11110 
	gd©a
 +ğ
d©a_Ën
;

11112  
	gd©a
;

11115 
mg_·r£_dns
(cÚ¡ *
buf
, 
Ën
, 
mg_dns_mes§ge
 *
msg
) {

11116 
mg_dns_h—d”
 *
	gh—d”
 = (mg_dns_h—d” *è
buf
;

11117 *
	gd©a
 = (*è
buf
 + (*
h—d”
);

11118 *
	g’d
 = (*è
buf
 + 
Ën
;

11119 
	gi
;

11121 
mem£t
(
msg
, 0, (*msg));

11122 
	gmsg
->
	gpkt
.
	gp
 = 
buf
;

11123 
	gmsg
->
	gpkt
.
	gËn
 = 
Ën
;

11125 ià(
	gËn
 < (è(*
	gh—d”
))  -1;

11127 
	gmsg
->
	gŒª§ùiÚ_id
 = 
h—d”
->
Œª§ùiÚ_id
;

11128 
	gmsg
->
	gæags
 = 
Áohs
(
h—d”
->
æags
);

11129 
	gmsg
->
	gnum_que¡iÚs
 = 
Áohs
(
h—d”
->
num_que¡iÚs
);

11130 ià(
	gmsg
->
	gnum_que¡iÚs
 > (è
ARRAY_SIZE
(
msg
->
que¡iÚs
)) {

11131 
	gmsg
->
	gnum_que¡iÚs
 = (è
ARRAY_SIZE
(
msg
->
que¡iÚs
);

11133 
	gmsg
->
	gnum_ªsw”s
 = 
Áohs
(
h—d”
->
num_ªsw”s
);

11134 ià(
	gmsg
->
	gnum_ªsw”s
 > (è
ARRAY_SIZE
(
msg
->
ªsw”s
)) {

11135 
	gmsg
->
	gnum_ªsw”s
 = (è
ARRAY_SIZE
(
msg
->
ªsw”s
);

11138 
	gi
 = 0; i < 
	gmsg
->
	gnum_que¡iÚs
; i++) {

11139 
	gd©a
 = 
mg_·r£_dns_»sourû_»cÜd
(
d©a
, 
’d
, &
msg
->
que¡iÚs
[
i
], 0);

11140 ià(
	gd©a
 =ğ
NULL
)  -1;

11143 
	gi
 = 0; i < 
	gmsg
->
	gnum_ªsw”s
; i++) {

11144 
	gd©a
 = 
mg_·r£_dns_»sourû_»cÜd
(
d©a
, 
’d
, &
msg
->
ªsw”s
[
i
], 1);

11145 ià(
	gd©a
 =ğ
NULL
)  -1;

11151 
size_t
 
mg_dns_uncom´ess_Çme
(
mg_dns_mes§ge
 *
msg
, 
mg_¡r
 *
Çme
,

11152 *
d¡
, 
d¡_Ën
) {

11153 
	gchunk_Ën
, 
	gnum_±rs
 = 0;

11154 *
	gŞd_d¡
 = 
d¡
;

11155 cÚ¡ *
	gd©a
 = (*è
Çme
->
p
;

11156 cÚ¡ *
	g’d
 = (*è
msg
->
pkt
.
p
 + msg->pkt.
Ën
;

11158 ià(
	gd©a
 >ğ
’d
) {

11162 (
	gchunk_Ën
 = *
d©a
++)) {

11163 
Ëeway
 = 
d¡_Ën
 - (
d¡
 - 
Şd_d¡
);

11164 ià(
	gd©a
 >ğ
’d
) {

11168 ià((
	gchunk_Ën
 & 0xc0) == 0xc0) {

11169 
ušt16_t
 
off
 = (
d©a
[-1] & (~0xc0)) << 8 | data[0];

11170 ià(
	goff
 >ğ
msg
->
pkt
.
Ën
) {

11174 ià(++
	gnum_±rs
 > 15) {

11177 
	gd©a
 = (*è
msg
->
pkt
.
p
 + 
off
;

11180 ià(
	gchunk_Ën
 > 63) {

11183 ià(
	gchunk_Ën
 > 
	gËeway
) {

11184 
	gchunk_Ën
 = 
Ëeway
;

11187 ià(
	gd©a
 + 
	gchunk_Ën
 >ğ
’d
) {

11191 
memıy
(
d¡
, 
d©a
, 
chunk_Ën
);

11192 
	gd©a
 +ğ
chunk_Ën
;

11193 
	gd¡
 +ğ
chunk_Ën
;

11194 
	gËeway
 -ğ
chunk_Ën
;

11195 ià(
	gËeway
 == 0) {

11196  
d¡
 - 
Şd_d¡
;

11198 *
	gd¡
++ = '.';

11201 ià(
	gd¡
 !ğ
Şd_d¡
) {

11202 *--
d¡
 = 0;

11204  
	gd¡
 - 
	gŞd_d¡
;

11207 
dns_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
,

11208 *
ev_d©a
 
MG_UD_ARG
(*
u£r_d©a
)) {

11209 
mbuf
 *
	gio
 = &
nc
->
»cv_mbuf
;

11210 
mg_dns_mes§ge
 
	gmsg
;

11213 
	gnc
->
hªdËr
(
nc
, 
ev
, 
ev_d©a
 
MG_UD_ARG
(
u£r_d©a
));

11215 
	gev
) {

11216 
	gMG_EV_RECV
:

11217 ià(!(
nc
->
æags
 & 
MG_F_UDP
)) {

11218 
mbuf_»move
(&
nc
->
»cv_mbuf
, 2);

11220 ià(
mg_·r£_dns
(
nc
->
»cv_mbuf
.
buf
,‚c->»cv_mbuf.
Ën
, &
msg
) == -1) {

11222 
mem£t
(&
msg
, 0, (msg));

11223 
	gmsg
.
	gæags
 = 0x8081;

11224 
mg_dns_š£¹_h—d”
(
io
, 0, &
msg
);

11225 ià(!(
	gnc
->
	gæags
 & 
	gMG_F_UDP
)) {

11226 
ušt16_t
 
	gËn
 = 
htÚs
((ušt16_tè
io
->
Ën
);

11227 
mbuf_š£¹
(
io
, 0, &
Ën
, 2);

11229 
mg_£nd
(
nc
, 
io
->
buf
, io->
Ën
);

11232 
	gnc
->
hªdËr
(
nc
, 
MG_DNS_MESSAGE
, &
msg
 
MG_UD_ARG
(
u£r_d©a
));

11234 
mbuf_»move
(
io
, io->
Ën
);

11239 
mg_£t_´ÙocŞ_dns
(
mg_cÚÃùiÚ
 *
nc
) {

11240 
	gnc
->
	g´Ùo_hªdËr
 = 
dns_hªdËr
;

11244 #ifdeà
MG_MODULE_LINES


11252 #ià
MG_ENABLE_DNS_SERVER


11257 
mg_dns_»¶y
 
mg_dns_ü—‹_»¶y
(
mbuf
 *
io
,

11258 
mg_dns_mes§ge
 *
msg
) {

11259 
mg_dns_»¶y
 
	g»p
;

11260 
	g»p
.
	gmsg
 = 
msg
;

11261 
	g»p
.
	gio
 = 
io
;

11262 
	g»p
.
	g¡¬t
 = 
io
->
Ën
;

11265 
	gmsg
->
	gæags
 |= 0x8080;

11266 
mg_dns_cİy_que¡iÚs
(
io
, 
msg
);

11268 
	gmsg
->
	gnum_ªsw”s
 = 0;

11269  
	g»p
;

11272 
mg_dns_£nd_»¶y
(
mg_cÚÃùiÚ
 *
nc
, 
mg_dns_»¶y
 *
r
) {

11273 
size_t
 
	g£Á
 = 
r
->
io
->
Ën
 -„->
¡¬t
;

11274 
mg_dns_š£¹_h—d”
(
r
->
io
,„->
¡¬t
,„->
msg
);

11275 ià(!(
	gnc
->
	gæags
 & 
	gMG_F_UDP
)) {

11276 
ušt16_t
 
	gËn
 = 
htÚs
((ušt16_tè
£Á
);

11277 
mbuf_š£¹
(
r
->
io
,„->
¡¬t
, &
Ën
, 2);

11280 ià(&
	gnc
->
	g£nd_mbuf
 !ğ
r
->
io
) {

11281 
mg_£nd
(
nc
, 
r
->
io
->
buf
 +„->
¡¬t
,„->io->
Ën
 -„->start);

11282 
	gr
->
	gio
->
	gËn
 = 
r
->
¡¬t
;

11286 
mg_dns_»¶y_»cÜd
(
mg_dns_»¶y
 *
»¶y
,

11287 
mg_dns_»sourû_»cÜd
 *
que¡iÚ
,

11288 cÚ¡ *
Çme
, 
¹y³
, 
‰l
, cÚ¡ *
rd©a
,

11289 
size_t
 
rd©a_Ën
) {

11290 
mg_dns_mes§ge
 *
	gmsg
 = (mg_dns_mes§g*è
»¶y
->
msg
;

11291 
	gºame
[512];

11292 
mg_dns_»sourû_»cÜd
 *
	gªs
 = &
msg
->
ªsw”s
[msg->
num_ªsw”s
];

11293 ià(
	gmsg
->
	gnum_ªsw”s
 >ğ
MG_MAX_DNS_ANSWERS
) {

11297 ià(
	gÇme
 =ğ
NULL
) {

11298 
Çme
 = 
ºame
;

11299 
	gºame
[511] = 0;

11300 
mg_dns_uncom´ess_Çme
(
msg
, &
que¡iÚ
->
Çme
, 
ºame
, (rname) - 1);

11303 *
	gªs
 = *
que¡iÚ
;

11304 
	gªs
->
	gkšd
 = 
MG_DNS_ANSWER
;

11305 
	gªs
->
	g¹y³
 = 
¹y³
;

11306 
	gªs
->
	g‰l
 = 
‰l
;

11308 ià(
mg_dns_’code_»cÜd
(
»¶y
->
io
, 
ªs
, 
Çme
, 
¡¾’
Òame), 
rd©a
,

11309 
rd©a_Ën
) == -1) {

11313 
	gmsg
->
	gnum_ªsw”s
++;

11318 #ifdeà
MG_MODULE_LINES


11326 #ià
MG_ENABLE_ASYNC_RESOLVER


11331 #iâdeà
MG_DEFAULT_NAMESERVER


11332 
	#MG_DEFAULT_NAMESERVER
 "8.8.8.8"

	)

11335 
	smg_»sŞve_async_»que¡
 {

11336 
	gÇme
[1024];

11337 
	gqu”y
;

11338 
mg_»sŞve_ÿÎback_t
 
	gÿÎback
;

11339 *
	gd©a
;

11340 
time_t
 
	gtimeout
;

11341 
	gmax_»Œ›s
;

11342 
mg_»sŞve_”r
 
	g”r
;

11345 
time_t
 
	gÏ¡_time
;

11346 
	g»Œ›s
;

11354 
mg_g‘__add»ss_of_Çme£rv”
(*
Çme
, 
size_t
 
Çme_Ën
) {

11355 
	g»t
 = -1;

11357 #ifdeà
_WIN32


11358 
	gi
;

11359 
LONG
 
	g”r
;

11360 
HKEY
 
	ghKey
, 
	ghSub
;

11361 
wch¬_t
 
	gsubkey
[512], 
	gv®ue
[128],

11362 *
	gkey
 = 
L
"SYSTEM\\ControlSet001\\Services\\Tcpip\\Parameters\\Interfaces";

11364 ià((
	g”r
 = 
RegO³nKeyExW
(
HKEY_LOCAL_MACHINE
, 
key
, 0, 
KEY_READ
, &
hKey
)) !=

11365 
ERROR_SUCCESS
) {

11366 
årštf
(
¡d”r
, "ÿÂÙ o³À»g key %S: %ld\n", 
key
, 
”r
);

11367 
	g»t
 = -1;

11369 
	g»t
 = -1, 
	gi
 = 0; 1; i++) {

11370 
DWORD
 
	gsubkey_size
 = (
subkey
), 
	gty³
, 
	gËn
 = (
v®ue
);

11371 ià(
RegEnumKeyExW
(
hKey
, 
i
, 
subkey
, &
subkey_size
, 
NULL
, NULL, NULL,

11372 
NULL
è!ğ
ERROR_SUCCESS
) {

11375 ià(
RegO³nKeyExW
(
hKey
, 
subkey
, 0, 
KEY_READ
, &
hSub
è=ğ
ERROR_SUCCESS
 &&

11376 ((
RegQu”yV®ueExW
(
hSub
, 
L
"NameS”v”", 0, &
ty³
, (*è
v®ue
,

11377 &
Ën
è=ğ
ERROR_SUCCESS
 &&

11378 
v®ue
[0] != '\0') ||

11379 (
RegQu”yV®ueExW
(
hSub
, 
L
"DhıNameS”v”", 0, &
ty³
, (*è
v®ue
,

11380 &
Ën
è=ğ
ERROR_SUCCESS
 &&

11381 
v®ue
[0] != '\0'))) {

11389 
wch¬_t
 *
comma
 = 
wcschr
(
v®ue
, ',');

11390 ià(
	gcomma
 !ğ
NULL
) {

11391 *
comma
 = '\0';

11394 
¢´štf
(
Çme
, 
Çme_Ën
, "%S", 
v®ue
);

11395 
	g»t
 = 0;

11396 
RegClo£Key
(
hSub
);

11400 
RegClo£Key
(
hKey
);

11402 #–ià
MG_ENABLE_FILESYSTEM
 && 
defšed
(
MG_RESOLV_CONF_FILE_NAME
)

11403 
FILE
 *
	gå
;

11404 
	glše
[512];

11406 ià((
	gå
 = 
mg_fİ’
(
MG_RESOLV_CONF_FILE_NAME
, "r")è=ğ
NULL
) {

11407 
»t
 = -1;

11410 
	g»t
 = -1; 
fg‘s
(
lše
, Öše), 
å
è!ğ
NULL
;) {

11411 
	ga
, 
	gb
, 
	gc
, 
	gd
;

11412 ià(
ssÿnf
(
lše
, "Çme£rv” %u.%u.%u.%u", &
a
, &
b
, &
c
, &
d
) == 4) {

11413 
¢´štf
(
Çme
, 
Çme_Ën
, "%u.%u.%u.%u", 
a
, 
b
, 
c
, 
d
);

11414 
	g»t
 = 0;

11418 (è
fşo£
(
å
);

11421 
¢´štf
(
Çme
, 
Çme_Ën
, "%s", 
MG_DEFAULT_NAMESERVER
);

11424  
	g»t
;

11427 
mg_»sŞve_äom_ho¡s_fe
(cÚ¡ *
Çme
, 
sock‘_add»ss
 *
u§
) {

11428 #ià
MG_ENABLE_FILESYSTEM
 && 
defšed
(
MG_HOSTS_FILE_NAME
)

11430 
FILE
 *
	gå
;

11431 
	glše
[1024];

11432 *
	gp
;

11433 
	g®Ÿs
[256];

11434 
	ga
, 
	gb
, 
	gc
, 
	gd
;

11435 
	gËn
 = 0;

11437 ià((
	gå
 = 
mg_fİ’
(
MG_HOSTS_FILE_NAME
, "r")è=ğ
NULL
) {

11441 ; 
fg‘s
(
lše
, Öše), 
å
è!ğ
NULL
;) {

11442 ià(
	glše
[0] == '#') ;

11444 ià(
ssÿnf
(
lše
, "%u.%u.%u.%u%n", &
a
, &
b
, &
c
, &
d
, &
Ën
) == 0) {

11448 
	gp
 = 
lše
 + 
Ën
; 
ssÿnf
(
p
, "%s%n", 
®Ÿs
, &len) == 1;… +=†en) {

11449 ià(
¡rcmp
(
®Ÿs
, 
Çme
) == 0) {

11450 
u§
->
sš
.
sš_addr
.
s_addr
 = 
htÚl
(
a
 << 24 | 
b
 << 16 | 
c
 << 8 | 
d
);

11451 
fşo£
(
å
);

11457 
fşo£
(
å
);

11459 (è
	gÇme
;

11460 (è
	gu§
;

11466 
mg_»sŞve_async_eh
(
mg_cÚÃùiÚ
 *
nc
, 
ev
,

11467 *
d©a
 
MG_UD_ARG
(*
u£r_d©a
)) {

11468 
time_t
 
	gnow
 = (time_tè
mg_time
();

11469 
mg_»sŞve_async_»que¡
 *
	g»q
;

11470 
mg_dns_mes§ge
 *
	gmsg
;

11471 
	gfœ¡
 = 0;

11472 #ià!
MG_ENABLE_CALLBACK_USERDATA


11473 *
	gu£r_d©a
 = 
nc
->
u£r_d©a
;

11476 ià(
	gev
 !ğ
MG_EV_POLL
è
DBG
(("ev=%d u£r_d©a=%p", 
ev
, 
u£r_d©a
));

11478 
	g»q
 = (
mg_»sŞve_async_»que¡
 *è
u£r_d©a
;

11480 ià(
	g»q
 =ğ
NULL
) {

11484 
	gev
) {

11485 
	gMG_EV_CONNECT
:

11487 
fœ¡
 = 1;

11489 
	gMG_EV_POLL
:

11490 ià(
»q
->
»Œ›s
 >„eq->
max_»Œ›s
) {

11491 
»q
->
”r
 = 
MG_RESOLVE_EXCEEDED_RETRY_COUNT
;

11492 
	gnc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

11495 ià(
	gfœ¡
 || 
	gnow
 - 
	g»q
->
	gÏ¡_time
 >ğ
»q
->
timeout
) {

11496 
mg_£nd_dns_qu”y
(
nc
, 
»q
->
Çme
,„eq->
qu”y
);

11497 
	g»q
->
	gÏ¡_time
 = 
now
;

11498 
	g»q
->
	g»Œ›s
++;

11501 
	gMG_EV_RECV
:

11502 
msg
 = (
mg_dns_mes§ge
 *è
MG_MALLOC
((*msg));

11503 ià(
mg_·r£_dns
(
nc
->
»cv_mbuf
.
buf
, *(*è
d©a
, 
msg
) == 0 &&

11504 
msg
->
num_ªsw”s
 > 0) {

11505 
»q
->
ÿÎback
(
msg
,„eq->
d©a
, 
MG_RESOLVE_OK
);

11506 
	gnc
->
	gu£r_d©a
 = 
NULL
;

11507 
MG_FREE
(
»q
);

11509 
	g»q
->
	g”r
 = 
MG_RESOLVE_NO_ANSWERS
;

11511 
MG_FREE
(
msg
);

11512 
	gnc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

11514 
	gMG_EV_SEND
:

11519 
nc
->
æags
 &ğ~
MG_F_CLOSE_IMMEDIATELY
;

11520 
mbuf_»move
(&
nc
->
£nd_mbuf
,‚c->£nd_mbuf.
Ën
);

11522 
	gMG_EV_TIMER
:

11523 
»q
->
”r
 = 
MG_RESOLVE_TIMEOUT
;

11524 
	gnc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

11526 
	gMG_EV_CLOSE
:

11528 ià(
»q
 !ğ
NULL
) {

11529 
addr
[32];

11530 
mg_sock_addr_to_¡r
(&
nc
->
§
, 
addr
, ×ddr), 
MG_SOCK_STRINGIFY_IP
);

11531 #ifdeà
MG_LOG_DNS_FAILURES


11532 
LOG
(
LL_ERROR
, ("FaedØ»sŞv'%s', s”v” %s", 
»q
->
Çme
, 
addr
));

11534 
	g»q
->
ÿÎback
(
NULL
, 
»q
->
d©a
,„eq->
”r
);

11535 
	gnc
->
	gu£r_d©a
 = 
NULL
;

11536 
MG_FREE
(
»q
);

11542 
mg_»sŞve_async
(
mg_mgr
 *
mgr
, cÚ¡ *
Çme
, 
qu”y
,

11543 
mg_»sŞve_ÿÎback_t
 
cb
, *
d©a
) {

11544 
mg_»sŞve_async_İts
 
	gİts
;

11545 
mem£t
(&
İts
, 0, (opts));

11546  
mg_»sŞve_async_İt
(
mgr
, 
Çme
, 
qu”y
, 
cb
, 
d©a
, 
İts
);

11549 
mg_»sŞve_async_İt
(
mg_mgr
 *
mgr
, cÚ¡ *
Çme
, 
qu”y
,

11550 
mg_»sŞve_ÿÎback_t
 
cb
, *
d©a
,

11551 
mg_»sŞve_async_İts
 
İts
) {

11552 
mg_»sŞve_async_»que¡
 *
	g»q
;

11553 
mg_cÚÃùiÚ
 *
	gdns_nc
;

11554 cÚ¡ *
	gÇme£rv”
 = 
İts
.
Çme£rv”
;

11555 
	gdns_£rv”_buff
[17], 
	gÇme£rv”_u¾
[26];

11557 ià(
	gÇme£rv”
 =ğ
NULL
) {

11558 
Çme£rv”
 = 
mgr
->nameserver;

11561 
DBG
(("% %d %p", 
Çme
, 
qu”y
, 
İts
.
dns_cÚn
));

11564 
	g»q
 = (
mg_»sŞve_async_»que¡
 *è
MG_CALLOC
(1, (*
»q
));

11565 ià(
	g»q
 =ğ
NULL
) {

11569 
¡ºıy
(
»q
->
Çme
,‚ame, (req->name));

11570 
	g»q
->
	gqu”y
 = 
qu”y
;

11571 
	g»q
->
	gÿÎback
 = 
cb
;

11572 
	g»q
->
	gd©a
 = 
d©a
;

11574 
	g»q
->
	gmax_»Œ›s
 = 
İts
.
max_»Œ›s
 ? opts.max_retries : 2;

11575 
	g»q
->
	gtimeout
 = 
İts
.
timeout
 ? opts.timeout : 5;

11578 ià(
	gÇme£rv”
 =ğ
NULL
) {

11579 ià(
mg_g‘__add»ss_of_Çme£rv”
(
dns_£rv”_buff
,

11580 (
dns_£rv”_buff
)) != -1) {

11581 
Çme£rv”
 = 
dns_£rv”_buff
;

11583 
	gÇme£rv”
 = 
MG_DEFAULT_NAMESERVER
;

11587 
¢´štf
(
Çme£rv”_u¾
, Òame£rv”_u¾), "udp://%s:53", 
Çme£rv”
);

11589 
	gdns_nc
 = 
mg_cÚÃù
(
mgr
, 
Çme£rv”_u¾
, 
MG_CB
(
mg_»sŞve_async_eh
, 
NULL
));

11590 ià(
	gdns_nc
 =ğ
NULL
) {

11591 
MG_FREE
(
»q
);

11594 
	gdns_nc
->
	gu£r_d©a
 = 
»q
;

11595 ià(
	gİts
.
	gdns_cÚn
 !ğ
NULL
) {

11596 *
İts
.
dns_cÚn
 = 
dns_nc
;

11602 
mg_£t_Çme£rv”
(
mg_mgr
 *
mgr
, cÚ¡ *
Çme£rv”
) {

11603 
MG_FREE
((*è
mgr
->
Çme£rv”
);

11604 
	gmgr
->
	gÇme£rv”
 = 
NULL
;

11605 ià(
	gÇme£rv”
 !ğ
NULL
) {

11606 
mgr
->
Çme£rv”
 = 
¡rdup
(nameserver);

11611 #ifdeà
MG_MODULE_LINES


11634 #ià
MG_ENABLE_COAP


11636 
mg_cßp_ä“_İtiÚs
(
mg_cßp_mes§ge
 *
cm
) {

11637 
	gcm
->
	gİtiÚs
 !ğ
NULL
) {

11638 
mg_cßp_İtiÚ
 *
Ãxt
 = 
cm
->
İtiÚs
->next;

11639 
MG_FREE
(
cm
->
İtiÚs
);

11640 
	gcm
->
	gİtiÚs
 = 
Ãxt
;

11644 
mg_cßp_İtiÚ
 *
mg_cßp_add_İtiÚ
(
mg_cßp_mes§ge
 *
cm
,

11645 
ušt32_t
 
numb”
, *
v®ue
,

11646 
size_t
 
Ën
) {

11647 
mg_cßp_İtiÚ
 *
	gÃw_İtiÚ
 =

11648 (
mg_cßp_İtiÚ
 *è
MG_CALLOC
(1, (*
Ãw_İtiÚ
));

11650 
	gÃw_İtiÚ
->
	gnumb”
 = 
numb”
;

11651 
	gÃw_İtiÚ
->
	gv®ue
.
	gp
 = 
v®ue
;

11652 
	gÃw_İtiÚ
->
	gv®ue
.
	gËn
 = 
Ën
;

11654 ià(
	gcm
->
	gİtiÚs
 =ğ
NULL
) {

11655 
cm
->
İtiÚs
 = cm->
İtiomg_
 = 
Ãw_İtiÚ
;

11662 ià(
	gcm
->
	gİtiomg_
->
	gnumb”
 <ğ
Ãw_İtiÚ
->
numb”
) {

11664 
cm
->
İtiomg_
 = cm->İtiomg_->
Ãxt
 = 
Ãw_İtiÚ
;

11667 
mg_cßp_İtiÚ
 *
	gcu¼’t_İt
 = 
cm
->
İtiÚs
;

11668 
mg_cßp_İtiÚ
 *
	g´ev_İt
 = 0;

11670 
	gcu¼’t_İt
 !ğ
NULL
) {

11671 ià(
cu¼’t_İt
->
numb”
 > 
Ãw_İtiÚ
->number) {

11674 
	g´ev_İt
 = 
cu¼’t_İt
;

11675 
	gcu¼’t_İt
 = 
cu¼’t_İt
->
Ãxt
;

11678 ià(
	g´ev_İt
 !ğ
NULL
) {

11679 
´ev_İt
->
Ãxt
 = 
Ãw_İtiÚ
;

11680 
	gÃw_İtiÚ
->
	gÃxt
 = 
cu¼’t_İt
;

11683 
	gÃw_İtiÚ
->
	gÃxt
 = 
cm
->
İtiÚs
;

11684 
	gcm
->
	gİtiÚs
 = 
Ãw_İtiÚ
;

11689  
	gÃw_İtiÚ
;

11697 *
cßp_·r£_h—d”
(*
±r
, 
mbuf
 *
io
,

11698 
mg_cßp_mes§ge
 *
cm
) {

11699 ià(
	gio
->
	gËn
 < (
	gušt32_t
)) {

11700 
	gcm
->
	gæags
 |ğ
MG_COAP_NOT_ENOUGH_DATA
;

11701  
	gNULL
;

11710 ià(((
	gušt8_t
è*
	g±r
 >> 6) != 1) {

11711 
cm
->
æags
 |ğ
MG_COAP_IGNORE
;

11712  
	gNULL
;

11720 
	gcm
->
	gmsg_ty³
 = ((
ušt8_t
è*
±r
 & 0x30) >> 4;

11721 
	gcm
->
	gæags
 |ğ
MG_COAP_MSG_TYPE_FIELD
;

11729 
	gcm
->
	gtok’
.
	gËn
 = *
±r
 & 0x0F;

11730 ià(
	gcm
->
	gtok’
.
	gËn
 > 8) {

11731 
	gcm
->
	gæags
 |ğ
MG_COAP_FORMAT_ERROR
;

11732  
	gNULL
;

11735 
	g±r
++;

11741 
	gcm
->
	gcode_şass
 = (
ušt8_t
è*
±r
 >> 5;

11742 
	gcm
->
	gcode_d‘a
 = *
±r
 & 0x1F;

11743 
	gcm
->
	gæags
 |ğ(
MG_COAP_CODE_CLASS_FIELD
 | 
MG_COAP_CODE_DETAIL_FIELD
);

11745 
	g±r
++;

11748 
	gcm
->
	gmsg_id
 = (
ušt8_t
è*
±r
 << 8 | (uint8_t) * (ptr + 1);

11749 
	gcm
->
	gæags
 |ğ
MG_COAP_MSG_ID_FIELD
;

11751 
	g±r
 += 2;

11753  
	g±r
;

11761 *
cßp_g‘_tok’
(*
±r
, 
mbuf
 *
io
,

11762 
mg_cßp_mes§ge
 *
cm
) {

11763 ià(
	gcm
->
	gtok’
.
	gËn
 != 0) {

11764 ià(
±r
 + 
cm
->
tok’
.
Ën
 > 
io
->
buf
 + io->len) {

11765 
cm
->
æags
 |ğ
MG_COAP_NOT_ENOUGH_DATA
;

11766  
	gNULL
;

11768 
	gcm
->
	gtok’
.
	gp
 = 
±r
;

11769 
	g±r
 +ğ
cm
->
tok’
.
Ën
;

11770 
	gcm
->
	gæags
 |ğ
MG_COAP_TOKEN_FIELD
;

11774  
	g±r
;

11782 
cßp_g‘_ext_İt
(*
±r
, 
mbuf
 *
io
, 
ušt16_t
 *
İt_šfo
) {

11783 
	g»t
 = 0;

11785 ià(*
	gİt_šfo
 == 13) {

11790 ià(
±r
 < 
io
->
buf
 + io->
Ën
) {

11791 *
İt_šfo
 = (
ušt8_t
è*
±r
 + 13;

11792 
	g»t
 = (
ušt8_t
);

11794 
	g»t
 = -1;

11796 } ià(*
	gİt_šfo
 == 14) {

11801 ià(
±r
 + (
ušt8_t
è< 
io
->
buf
 + io->
Ën
) {

11802 *
İt_šfo
 = ((
ušt8_t
è*
±r
 << 8 | (uint8_t) * (ptr + 1)) + 269;

11803 
	g»t
 = (
ušt16_t
);

11805 
	g»t
 = -1;

11809  
	g»t
;

11828 *
cßp_g‘_İtiÚs
(*
±r
, 
mbuf
 *
io
,

11829 
mg_cßp_mes§ge
 *
cm
) {

11830 
ušt16_t
 
	g´ev_İt
 = 0;

11832 ià(
	g±r
 =ğ
io
->
buf
 + io->
Ën
) {

11834  
NULL
;

11838 
	g±r
 < 
	gio
->
	gbuf
 + io->
	gËn
 && (
	gušt8_t
) *ptr != 0xFF) {

11839 
ušt16_t
 
İtiÚ_d–
, 
İtiÚ_Ënght
;

11840 
	gİtšfo_Ën
;

11843 
	gİtiÚ_d–
 = ((
ušt8_t
è*
±r
 & 0xF0) >> 4;

11845 
	gİtiÚ_Ënght
 = *
±r
 & 0x0F;

11847 ià(
	gİtiÚ_d–
 =ğ15 || 
İtiÚ_Ënght
 == 15) {

11852 
cm
->
æags
 |ğ
MG_COAP_FORMAT_ERROR
;

11856 
	g±r
++;

11859 
	gİtšfo_Ën
 = 
cßp_g‘_ext_İt
(
±r
, 
io
, &
İtiÚ_d–
);

11860 ià(
	gİtšfo_Ën
 == -1) {

11861 
cm
->
æags
 |ğ
MG_COAP_NOT_ENOUGH_DATA
;

11865 
	g±r
 +ğ
İtšfo_Ën
;

11868 
	gİtšfo_Ën
 = 
cßp_g‘_ext_İt
(
±r
, 
io
, &
İtiÚ_Ënght
);

11869 ià(
	gİtšfo_Ën
 == -1) {

11870 
cm
->
æags
 |ğ
MG_COAP_NOT_ENOUGH_DATA
;

11874 
	g±r
 +ğ
İtšfo_Ën
;

11881 
	gİtiÚ_d–
 +ğ
´ev_İt
;

11883 
mg_cßp_add_İtiÚ
(
cm
, 
İtiÚ_d–
, 
±r
, 
İtiÚ_Ënght
);

11885 
	g´ev_İt
 = 
İtiÚ_d–
;

11887 ià(
	g±r
 + 
	gİtiÚ_Ënght
 > 
	gio
->
	gbuf
 + io->
	gËn
) {

11888 
	gcm
->
	gæags
 |ğ
MG_COAP_NOT_ENOUGH_DATA
;

11892 
	g±r
 +ğ
İtiÚ_Ënght
;

11895 ià((
	gcm
->
	gæags
 & 
	gMG_COAP_ERROR
) != 0) {

11896 
mg_cßp_ä“_İtiÚs
(
cm
);

11897  
	gNULL
;

11900 
	gcm
->
	gæags
 |ğ
MG_COAP_OPTIOMG_FIELD
;

11902 ià(
	g±r
 =ğ
io
->
buf
 + io->
Ën
) {

11904  
NULL
;

11907 
	g±r
++;

11909  
	g±r
;

11912 
ušt32_t
 
mg_cßp_·r£
(
mbuf
 *
io
, 
mg_cßp_mes§ge
 *
cm
) {

11913 *
	g±r
;

11915 
mem£t
(
cm
, 0, (*cm));

11917 ià((
	g±r
 = 
cßp_·r£_h—d”
(
io
->
buf
, io, 
cm
)è=ğ
NULL
) {

11918  
cm
->
æags
;

11921 ià((
	g±r
 = 
cßp_g‘_tok’
(
±r
, 
io
, 
cm
)è=ğ
NULL
) {

11922  
cm
->
æags
;

11925 ià((
	g±r
 = 
cßp_g‘_İtiÚs
(
±r
, 
io
, 
cm
)è=ğ
NULL
) {

11926  
cm
->
æags
;

11930 
	gcm
->
	g·ylßd
.
	gËn
 = 
io
->
Ën
 - (
±r
 - io->
buf
);

11931 ià(
	gcm
->
	g·ylßd
.
	gËn
 != 0) {

11932 
cm
->
·ylßd
.
p
 = 
±r
;

11933 
	gcm
->
	gæags
 |ğ
MG_COAP_PAYLOAD_FIELD
;

11936  
	gcm
->
	gæags
;

11944 
size_t
 
cßp_g‘_ext_İt_size
(
ušt32_t
 
v®ue
) {

11945 
	g»t
 = 0;

11947 ià(
	gv®ue
 >ğ13 && 
v®ue
 <= 0xFF + 13) {

11948 
»t
 = (
ušt8_t
);

11949 } ià(
	gv®ue
 > 0xFF + 13 && value <= 0xFFFF + 269) {

11950 
»t
 = (
ušt16_t
);

11953  
	g»t
;

11961 
cßp_¥l™_İt
(
ušt32_t
 
v®ue
, 
ušt8_t
 *
ba£
, 
ušt16_t
 *
ext
) {

11962 
	g»t
 = 0;

11964 ià(
	gv®ue
 < 13) {

11965 *
	gba£
 = 
v®ue
;

11966 } ià(
	gv®ue
 >ğ13 && 
v®ue
 <= 0xFF + 13) {

11967 *
ba£
 = 13;

11968 *
	gext
 = 
v®ue
 - 13;

11969 
	g»t
 = (
ušt8_t
);

11970 } ià(
	gv®ue
 > 0xFF + 13 && value <= 0xFFFF + 269) {

11971 *
ba£
 = 14;

11972 *
	gext
 = 
v®ue
 - 269;

11973 
	g»t
 = (
ušt16_t
);

11976  
	g»t
;

11984 *
cßp_add_ušt16
(*
±r
, 
ušt16_t
 
v®
) {

11985 *
	g±r
 = 
v®
 >> 8;

11986 
	g±r
++;

11987 *
	g±r
 = 
v®
 & 0x00FF;

11988 
	g±r
++;

11989  
	g±r
;

11997 *
cßp_add_İt_šfo
(*
±r
, 
ušt16_t
 
v®
, 
size_t
 
Ën
) {

11998 ià(
	gËn
 =ğ(
ušt8_t
)) {

11999 *
±r
 = (è
v®
;

12000 
	g±r
++;

12001 } ià(
	gËn
 =ğ(
ušt16_t
)) {

12002 
±r
 = 
cßp_add_ušt16
ÕŒ, 
v®
);

12005  
	g±r
;

12013 
ušt32_t
 
cßp_ÿlcuÏ‹_·ck‘_size
(
mg_cßp_mes§ge
 *
cm
,

12014 
size_t
 *
Ën
) {

12015 
mg_cßp_İtiÚ
 *
	gİt
;

12016 
ušt32_t
 
	g´ev_İt_numb”
;

12018 *
	gËn
 = 4;

12019 ià(
	gcm
->
	gmsg_ty³
 > 
	gMG_COAP_MSG_MAX
) {

12020  
	gMG_COAP_ERROR
 | 
	gMG_COAP_MSG_TYPE_FIELD
;

12022 ià(
	gcm
->
	gtok’
.
	gËn
 > 8) {

12023  
	gMG_COAP_ERROR
 | 
	gMG_COAP_TOKEN_FIELD
;

12025 ià(
	gcm
->
	gcode_şass
 > 7) {

12026  
	gMG_COAP_ERROR
 | 
	gMG_COAP_CODE_CLASS_FIELD
;

12028 ià(
	gcm
->
	gcode_d‘a
 > 31) {

12029  
	gMG_COAP_ERROR
 | 
	gMG_COAP_CODE_DETAIL_FIELD
;

12032 *
	gËn
 +ğ
cm
->
tok’
.
Ën
;

12033 ià(
	gcm
->
	g·ylßd
.
	gËn
 != 0) {

12034 *
Ën
 +ğ
cm
->
·ylßd
.len + 1;

12037 
	gİt
 = 
cm
->
İtiÚs
;

12038 
	g´ev_İt_numb”
 = 0;

12039 
	gİt
 !ğ
NULL
) {

12040 *
Ën
 += 1;

12041 *
	gËn
 +ğ
cßp_g‘_ext_İt_size
(
İt
->
numb”
 - 
´ev_İt_numb”
);

12042 *
	gËn
 +ğ
cßp_g‘_ext_İt_size
((
ušt32_t
è
İt
->
v®ue
.
Ën
);

12049 ià((
	gİt
->
	gÃxt
 !ğ
NULL
 && 
İt
->
numb”
 > o±->
Ãxt
->number) ||

12050 
İt
->
v®ue
.
Ën
 > 0xFFFF + 269 ||

12051 
İt
->
numb”
 - 
´ev_İt_numb”
 > 0xFFFF + 269) {

12052  
MG_COAP_ERROR
 | 
MG_COAP_OPTIOMG_FIELD
;

12054 *
	gËn
 +ğ
İt
->
v®ue
.
Ën
;

12055 
	g´ev_İt_numb”
 = 
İt
->
numb”
;

12056 
	gİt
 = 
İt
->
Ãxt
;

12062 
ušt32_t
 
mg_cßp_compo£
(
mg_cßp_mes§ge
 *
cm
, 
mbuf
 *
io
) {

12063 
mg_cßp_İtiÚ
 *
	gİt
;

12064 
ušt32_t
 
	g»s
, 
	g´ev_İt_numb”
;

12065 
size_t
 
	g´ev_io_Ën
, 
	g·ck‘_size
;

12066 *
	g±r
;

12068 
	g»s
 = 
cßp_ÿlcuÏ‹_·ck‘_size
(
cm
, &
·ck‘_size
);

12069 ià(
	g»s
 != 0) {

12070  
»s
;

12074 
	g´ev_io_Ën
 = 
io
->
Ën
;

12075 ià(
mbuf_­³nd
(
io
, 
NULL
, 
·ck‘_size
è=ğ0è 
MG_COAP_ERROR
;

12076 
	g±r
 = 
io
->
buf
 + 
´ev_io_Ën
;

12084 *
	g±r
 = (1 << 6è| (
cm
->
msg_ty³
 << 4è| (
ušt8_t
)(cm->
tok’
.
Ën
);

12085 
	g±r
++;

12088 *
	g±r
 = (
cm
->
code_şass
 << 5è| (cm->
code_d‘a
);

12089 
	g±r
++;

12091 
	g±r
 = 
cßp_add_ušt16
(
±r
, 
cm
->
msg_id
);

12093 ià(
	gcm
->
	gtok’
.
	gËn
 != 0) {

12094 
memıy
(
±r
, 
cm
->
tok’
.
p
, cm->tok’.
Ën
);

12095 
	g±r
 +ğ
cm
->
tok’
.
Ën
;

12098 
	gİt
 = 
cm
->
İtiÚs
;

12099 
	g´ev_İt_numb”
 = 0;

12100 
	gİt
 !ğ
NULL
) {

12101 
ušt8_t
 
d–_ba£
 = 0, 
	gËngth_ba£
 = 0;

12102 
ušt16_t
 
	gd–_ext
 = 0, 
	gËngth_ext
 = 0;

12104 
size_t
 
	gİt_d–_Ën
 =

12105 
cßp_¥l™_İt
(
İt
->
numb”
 - 
´ev_İt_numb”
, &
d–_ba£
, &
d–_ext
);

12106 
size_t
 
	gİt_Ënght_Ën
 =

12107 
cßp_¥l™_İt
((
ušt32_t
è
İt
->
v®ue
.
Ën
, &
Ëngth_ba£
, &
Ëngth_ext
);

12109 *
	g±r
 = (
d–_ba£
 << 4è| 
Ëngth_ba£
;

12110 
	g±r
++;

12112 
	g±r
 = 
cßp_add_İt_šfo
(
±r
, 
d–_ext
, 
İt_d–_Ën
);

12113 
	g±r
 = 
cßp_add_İt_šfo
(
±r
, 
Ëngth_ext
, 
İt_Ënght_Ën
);

12115 ià(
	gİt
->
	gv®ue
.
	gËn
 != 0) {

12116 
memıy
(
±r
, 
İt
->
v®ue
.
p
, o±->v®ue.
Ën
);

12117 
	g±r
 +ğ
İt
->
v®ue
.
Ën
;

12120 
	g´ev_İt_numb”
 = 
İt
->
numb”
;

12121 
	gİt
 = 
İt
->
Ãxt
;

12124 ià(
	gcm
->
	g·ylßd
.
	gËn
 != 0) {

12125 *
±r
 = () -1;

12126 
	g±r
++;

12127 
memıy
(
±r
, 
cm
->
·ylßd
.
p
, cm->·ylßd.
Ën
);

12133 
ušt32_t
 
mg_cßp_£nd_mes§ge
(
mg_cÚÃùiÚ
 *
nc
,

12134 
mg_cßp_mes§ge
 *
cm
) {

12135 
mbuf
 
	g·ck‘_out
;

12136 
ušt32_t
 
	gcompo£_»s
;

12138 
mbuf_š™
(&
·ck‘_out
, 0);

12139 
	gcompo£_»s
 = 
mg_cßp_compo£
(
cm
, &
·ck‘_out
);

12140 ià(
	gcompo£_»s
 != 0) {

12141  
compo£_»s
;

12144 
mg_£nd
(
nc
, 
·ck‘_out
.
buf
, (è·ck‘_out.
Ën
);

12145 
mbuf_ä“
(&
·ck‘_out
);

12150 
ušt32_t
 
mg_cßp_£nd_ack
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
msg_id
) {

12151 
mg_cßp_mes§ge
 
	gcm
;

12152 
mem£t
(&
cm
, 0, (cm));

12153 
	gcm
.
	gmsg_ty³
 = 
MG_COAP_MSG_ACK
;

12154 
	gcm
.
	gmsg_id
 = 
msg_id
;

12156  
mg_cßp_£nd_mes§ge
(
nc
, &
cm
);

12159 
cßp_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
,

12160 *
ev_d©a
 
MG_UD_ARG
(*
u£r_d©a
)) {

12161 
mbuf
 *
	gio
 = &
nc
->
»cv_mbuf
;

12162 
mg_cßp_mes§ge
 
	gcm
;

12163 
ušt32_t
 
	g·r£_»s
;

12165 
mem£t
(&
cm
, 0, (cm));

12167 
	gnc
->
hªdËr
(
nc
, 
ev
, 
ev_d©a
 
MG_UD_ARG
(
u£r_d©a
));

12169 
	gev
) {

12170 
	gMG_EV_RECV
:

12171 
·r£_»s
 = 
mg_cßp_·r£
(
io
, &
cm
);

12172 ià((
	g·r£_»s
 & 
	gMG_COAP_IGNORE
) == 0) {

12173 ià((
cm
.
æags
 & 
MG_COAP_NOT_ENOUGH_DATA
) != 0) {

12178 
cm
.
æags
 |ğ
MG_COAP_FORMAT_ERROR
;

12180 
	gnc
->
hªdËr
(
nc
, 
MG_COAP_EVENT_BASE
 + 
cm
.
msg_ty³
,

12181 &
cm
 
MG_UD_ARG
(
u£r_d©a
));

12184 
mg_cßp_ä“_İtiÚs
(&
cm
);

12185 
mbuf_»move
(
io
, io->
Ën
);

12199 
mg_£t_´ÙocŞ_cßp
(
mg_cÚÃùiÚ
 *
nc
) {

12201 ià((
	gnc
->
	gæags
 & 
	gMG_F_UDP
) == 0) {

12205 
	gnc
->
	g´Ùo_hªdËr
 = 
cßp_hªdËr
;

12211 #ifdeà
MG_MODULE_LINES


12219 #ià
MG_ENABLE_TUN


12229 
mg_tun_»cÚÃù
(
mg_tun_ş›Á
 *
ş›Á
, 
timeout
);

12231 
mg_tun_š™_ş›Á
(
mg_tun_ş›Á
 *
ş›Á
, 
mg_mgr
 *
mgr
,

12232 
mg_içû
 *
içû
, cÚ¡ *
di¥©ch”
,

12233 
mg_tun_s¦_İts
 
s¦
) {

12234 
	gş›Á
->
	gmgr
 = 
mgr
;

12235 
	gş›Á
->
	giçû
 = 
içû
;

12236 
	gş›Á
->
	gdi¥_u¾
 = 
di¥©ch”
;

12237 
	gş›Á
->
	gÏ¡_¡»am_id
 = 0;

12238 
	gş›Á
->
	gs¦
 = 
s¦
;

12240 
	gş›Á
->
	gdi¥
 = 
NULL
;

12241 
	gş›Á
->
	gli¡’”
 = 
NULL
;

12242 
	gş›Á
->
	g»cÚÃù
 = 
NULL
;

12245 
mg_tun_log_äame
(
mg_tun_äame
 *
äame
) {

12246 
LOG
(
LL_DEBUG
, ("Got TUN frame:ype=0x%x, flags=0x%x stream_id=0x%x, "

12248 
äame
->
ty³
, f¿me->
æags
, (èäame->
¡»am_id
,

12249 (è
äame
->
body
.
Ën
));

12250 #ià
MG_ENABLE_HEXDUMP


12252 
	ghex
[512];

12253 
mg_hexdump
(
äame
->
body
.
p
, f¿me->body.
Ën
, 
hex
, (hex) - 1);

12254 
	ghex
[(
hex
) - 1] = '\0';

12255 
LOG
(
LL_DEBUG
, ("body:\n%s", 
hex
));

12258 
LOG
(
LL_DEBUG
, ("body: '%.*s'", (è
äame
->
body
.
Ën
, f¿me->body.
p
));

12262 
mg_tun_şo£_®l
(
mg_tun_ş›Á
 *
ş›Á
) {

12263 
mg_cÚÃùiÚ
 *
	gnc
;

12264 
	gnc
 = 
ş›Á
->
mgr
->
aùive_cÚÃùiÚs
;‚ø!ğ
NULL
;‚øğ
nc
->
Ãxt
) {

12265 ià(
nc
->
içû
 =ğ
ş›Á
->içû && !Òc->
æags
 & 
MG_F_LISTENING
)) {

12266 
LOG
(
LL_DEBUG
, ("ClosšguÂ–ed cÚÃùiÚ %p", 
nc
));

12267 
	gnc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

12273 
mg_tun_ş›Á_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
,

12274 *
ev_d©a
 
MG_UD_ARG
(*
u£r_d©a
)) {

12275 #ià!
MG_ENABLE_CALLBACK_USERDATA


12276 *
	gu£r_d©a
 = 
nc
->
u£r_d©a
;

12278 (è
	gnc
;

12280 
mg_tun_ş›Á
 *
	gş›Á
 = (mg_tun_ş›Á *è
u£r_d©a
;

12282 
	gev
) {

12283 
	gMG_EV_CONNECT
: {

12284 
”r
 = *(*è
ev_d©a
;

12286 ià(
	g”r
) {

12287 
LOG
(
LL_ERROR
, ("CªnÙ cÚÃùØthtuÂ– di¥©ch”: %d", 
”r
));

12289 
LOG
(
LL_INFO
, ("Connectedoheunnel dispatcher"));

12293 
	gMG_EV_HTTP_REPLY
: {

12294 
h‰p_mes§ge
 *
hm
 = (h‰p_mes§g*è
ev_d©a
;

12296 ià(
	ghm
->
	g»¥_code
 != 200) {

12297 
LOG
(
LL_ERROR
,

12298 ("TuÂ– di¥©ch”„•ly‚Ú-OK stu cod%d", 
hm
->
»¥_code
));

12302 
	gMG_EV_WEBSOCKET_HANDSHAKE_DONE
: {

12303 
LOG
(
LL_INFO
, ("Tunnel dispatcher handshake done"));

12306 
	gMG_EV_WEBSOCKET_FRAME
: {

12307 
websock‘_mes§ge
 *
wm
 = (websock‘_mes§g*è
ev_d©a
;

12308 
mg_cÚÃùiÚ
 *
	gtc
;

12309 
mg_tun_äame
 
	gäame
;

12311 ià(
mg_tun_·r£_äame
(
wm
->
d©a
, wm->
size
, &
äame
) == -1) {

12312 
LOG
(
LL_ERROR
, ("Got invalidun frame dropping"));

12316 
mg_tun_log_äame
(&
äame
);

12318 
	gtc
 = 
mg_tun_if_fšd_cÚn
(
ş›Á
, 
äame
.
¡»am_id
);

12319 ià(
	gtc
 =ğ
NULL
) {

12320 ià(
äame
.
body
.
Ën
 > 0) {

12321 
LOG
(
LL_DEBUG
, ("Got frame‡fter„eceivingƒnd has been closed"));

12325 ià(
	gäame
.
	gbody
.
	gËn
 > 0) {

12326 
mg_if_»cv_tı_cb
(
tc
, (*è
äame
.
body
.
p
, f¿me.body.
Ën
,

12329 ià(
	gäame
.
	gæags
 & 
	gMG_TUN_F_END_STREAM
) {

12330 
LOG
(
LL_DEBUG
, ("Closingunneled connection because gotƒnd of stream "

12332 
	gtc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

12333 
mg_şo£_cÚn
(
tc
);

12337 
	gMG_EV_CLOSE
: {

12338 
LOG
(
LL_DEBUG
, ("Closing‡llunneled connections"));

12343 ià(
	gş›Á
 !ğ
NULL
) {

12344 
mg_tun_şo£_®l
(
ş›Á
);

12345 
	gş›Á
->
	gdi¥
 = 
NULL
;

12346 
LOG
(
LL_INFO
, ("Dispatcher connection is‚o more,„econnecting"));

12348 
mg_tun_»cÚÃù
(
ş›Á
, 
MG_TUN_RECONNECT_INTERVAL
);

12357 
mg_tun_do_»cÚÃù
(
mg_tun_ş›Á
 *
ş›Á
) {

12358 
mg_cÚÃùiÚ
 *
	gdc
;

12359 
mg_cÚÃù_İts
 
	gİts
;

12360 
mem£t
(&
İts
, 0, (opts));

12361 #ià
MG_ENABLE_SSL


12362 
	gİts
.
	gs¦_û¹
 = 
ş›Á
->
s¦
.
s¦_û¹
;

12363 
	gİts
.
	gs¦_key
 = 
ş›Á
->
s¦
.
s¦_key
;

12364 
	gİts
.
	gs¦_ÿ_û¹
 = 
ş›Á
->
s¦
.
s¦_ÿ_û¹
;

12367 ià((
	gdc
 = 
mg_cÚÃù_ws_İt
(
ş›Á
->
mgr
, 
MG_CB
(
mg_tun_ş›Á_hªdËr
, client),

12368 
İts
, 
ş›Á
->
di¥_u¾
, 
MG_TUN_PROTO_NAME
,

12369 
NULL
)) == NULL) {

12370 
LOG
(
LL_ERROR
,

12371 ("CªnÙ cÚÃùØWS s”v” oÀadd¸[%s]\n", 
ş›Á
->
di¥_u¾
));

12375 
	gş›Á
->
	gdi¥
 = 
dc
;

12376 #ià!
MG_ENABLE_CALLBACK_USERDATA


12377 
	gdc
->
	gu£r_d©a
 = 
ş›Á
;

12381 
mg_tun_»cÚÃù_ev_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
,

12382 *
ev_d©a
 
MG_UD_ARG
(*
u£r_d©a
)) {

12383 #ià!
MG_ENABLE_CALLBACK_USERDATA


12384 *
	gu£r_d©a
 = 
nc
->
u£r_d©a
;

12386 (è
	gnc
;

12388 
mg_tun_ş›Á
 *
	gş›Á
 = (mg_tun_ş›Á *è
u£r_d©a
;

12389 (è
	gev_d©a
;

12391 
	gev
) {

12392 
	gMG_EV_TIMER
:

12393 ià(!(
ş›Á
->
li¡’”
->
æags
 & 
MG_F_TUN_DO_NOT_RECONNECT
)) {

12394 
mg_tun_do_»cÚÃù
(
ş›Á
);

12397 
mg_tun_»cÚÃù
(
ş›Á
, 0);

12403 
mg_tun_»cÚÃù
(
mg_tun_ş›Á
 *
ş›Á
, 
timeout
) {

12404 ià(
	gş›Á
->
	g»cÚÃù
 =ğ
NULL
) {

12405 
ş›Á
->
»cÚÃù
 = 
mg_add_sock
(ş›Á->
mgr
, 
INVALID_SOCKET
,

12406 
MG_CB
(
mg_tun_»cÚÃù_ev_hªdËr
, 
ş›Á
));

12407 #ià!
MG_ENABLE_CALLBACK_USERDATA


12408 
	gş›Á
->
	g»cÚÃù
->
	gu£r_d©a
 = 
ş›Á
;

12411 
	gş›Á
->
	g»cÚÃù
->
	gev_tim”_time
 = 
mg_time
(è+ 
timeout
;

12414 
mg_tun_ş›Á
 *
mg_tun_ü—‹_ş›Á
(
mg_mgr
 *
mgr
,

12415 cÚ¡ *
di¥©ch”
,

12416 
mg_tun_s¦_İts
 
s¦
) {

12417 
mg_tun_ş›Á
 *
	gş›Á
 = 
NULL
;

12418 
mg_içû
 *
	giçû
 = 
mg_fšd_içû
(
mgr
, &
mg_tun_içû_vbË
, 
NULL
);

12419 ià(
	giçû
 =ğ
NULL
) {

12420 
LOG
(
LL_ERROR
, ("Theun feature„equireshe managero have‡un "

12422  
	gNULL
;

12425 
	gş›Á
 = (
mg_tun_ş›Á
 *è
MG_MALLOC
((*
ş›Á
));

12426 
mg_tun_š™_ş›Á
(
ş›Á
, 
mgr
, 
içû
, 
di¥©ch”
, 
s¦
);

12427 
	giçû
->
	gd©a
 = 
ş›Á
;

12434 
mg_tun_»cÚÃù
(
ş›Á
, 0);

12435  
	gş›Á
;

12438 
mg_tun_de¡roy_ş›Á
(
mg_tun_ş›Á
 *
ş›Á
) {

12446 ià(
	gş›Á
 !ğ
NULL
 && 
ş›Á
->
di¥
 != NULL) {

12448 
ş›Á
->
di¥
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

12450 
	gş›Á
->
	gdi¥
->
	gu£r_d©a
 = 
NULL
;

12453 ià(
	gş›Á
 !ğ
NULL
 && 
ş›Á
->
»cÚÃù
 != NULL) {

12454 
ş›Á
->
»cÚÃù
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

12457 ià(
	gş›Á
 !ğ
NULL
 && 
ş›Á
->
içû
 != NULL) {

12458 
ş›Á
->
içû
->
d©a
 = 
NULL
;

12461 
MG_FREE
(
ş›Á
);

12464 
mg_cÚÃùiÚ
 *
mg_tun_do_bšd
(
mg_tun_ş›Á
 *
ş›Á
,

12465 
MG_CB
(
mg_ev’t_hªdËr_t
 
hªdËr
,

12466 *
u£r_d©a
),

12467 
mg_bšd_İts
 
İts
) {

12468 
mg_cÚÃùiÚ
 *
	glc
;

12469 
	gİts
.
	giçû
 = 
ş›Á
->
içû
;

12470 
	glc
 = 
mg_bšd_İt
(
ş›Á
->
mgr
, ":1234" ,

12471 
MG_CB
(
hªdËr
, 
u£r_d©a
), 
İts
);

12472 
	gş›Á
->
	gli¡’”
 = 
lc
;

12473  
	glc
;

12476 
mg_cÚÃùiÚ
 *
mg_tun_bšd_İt
(
mg_mgr
 *
mgr
,

12477 cÚ¡ *
di¥©ch”
,

12478 
MG_CB
(
mg_ev’t_hªdËr_t
 
hªdËr
,

12479 *
u£r_d©a
),

12480 
mg_bšd_İts
 
İts
) {

12481 #ià
MG_ENABLE_SSL


12482 
mg_tun_s¦_İts
 
	gs¦
 = {
İts
.
s¦_û¹
, o±s.
s¦_key
, o±s.
s¦_ÿ_û¹
};

12484 
mg_tun_s¦_İts
 
	gs¦
 = {0};

12486 
mg_tun_ş›Á
 *
	gş›Á
 = 
mg_tun_ü—‹_ş›Á
(
mgr
, 
di¥©ch”
, 
s¦
);

12487 ià(
	gş›Á
 =ğ
NULL
) {

12488  
NULL
;

12490 #ià
MG_ENABLE_SSL


12492 
	gİts
.
	gs¦_û¹
 = 
NULL
;

12493 
	gİts
.
	gs¦_key
 = 
NULL
;

12494 
	gİts
.
	gs¦_ÿ_û¹
 = 
NULL
;

12496  
mg_tun_do_bšd
(
ş›Á
, 
MG_CB
(
hªdËr
, 
u£r_d©a
), 
İts
);

12499 
mg_tun_·r£_äame
(*
d©a
, 
size_t
 
Ën
, 
mg_tun_äame
 *
äame
) {

12500 cÚ¡ 
size_t
 
	gh—d”_size
 = (
ušt32_t
è+ (
ušt8_t
) * 2;

12501 ià(
	gËn
 < 
	gh—d”_size
) {

12505 
	gäame
->
	gty³
 = *(
ušt8_t
 *è(
d©a
);

12506 
	gäame
->
	gæags
 = *(
ušt8_t
 *è((*è
d©a
 + 1);

12507 
memıy
(&
äame
->
¡»am_id
, (*è
d©a
 + 2, (
ušt32_t
));

12508 
	gäame
->
	g¡»am_id
 = 
Áohl
(
äame
->
¡»am_id
);

12509 
	gäame
->
	gbody
.
	gp
 = (*è
d©a
 + 
h—d”_size
;

12510 
	gäame
->
	gbody
.
	gËn
 = 
Ën
 - 
h—d”_size
;

12514 
mg_tun_£nd_äame
(
mg_cÚÃùiÚ
 *
ws
, 
ušt32_t
 
¡»am_id
,

12515 
ušt8_t
 
ty³
, ušt8_ˆ
æags
, 
mg_¡r
 
msg
) {

12516 
	g¡»am_id
 = 
htÚl
(
¡»am_id
);

12518 
mg_¡r
 
	g·¹s
[] = {

12519 {(*è&
ty³
, (type)},

12520 {(*è&
æags
, (flags)},

12521 {(*è&
¡»am_id
, (stream_id)},

12522 {
msg
.
p
, msg.
Ën
} };

12523 
mg_£nd_websock‘_äamev
(
ws
, 
WEBSOCKET_OP_BINARY
, 
·¹s
,

12524 (
·¹s
) / (parts[0]));

12529 #ifdeà
MG_MODULE_LINES


12541 #ià
MG_ENABLE_SNTP


12543 
	#SNTP_TIME_OFFSET
 2208988800

	)

12545 #iâdeà
SNTP_TIMEOUT


12546 
	#SNTP_TIMEOUT
 10

	)

12549 #iâdeà
SNTP_ATTEMPTS


12550 
	#SNTP_ATTEMPTS
 3

	)

12553 
ušt64_t
 
mg_g‘_£c
(ušt64_ˆ
v®
) {

12554  (
	gv®
 & 0xFFFFFFFF00000000) >> 32;

12557 
ušt64_t
 
mg_g‘_u£c
(ušt64_ˆ
v®
) {

12558 
ušt64_t
 
	gtmp
 = (
v®
 & 0x00000000FFFFFFFF);

12559 
	gtmp
 *= 1000000;

12560 
	gtmp
 >>= 32;

12561  
	gtmp
;

12564 
mg_Áp_to_tv
(
ušt64_t
 
v®
, 
timev®
 *
tv
) {

12565 
ušt64_t
 
	gtmp
;

12566 
	gtmp
 = 
mg_g‘_£c
(
v®
);

12567 
	gtmp
 -ğ
SNTP_TIME_OFFSET
;

12568 
	gtv
->
	gtv_£c
 = 
tmp
;

12569 
	gtv
->
	gtv_u£c
 = 
mg_g‘_u£c
(
v®
);

12572 
mg_g‘_Áp_ts
(cÚ¡ *
Áp
, 
ušt64_t
 *
v®
) {

12573 
ušt32_t
 
	gtmp
;

12574 
memıy
(&
tmp
, 
Áp
, (tmp));

12575 
	gtmp
 = 
Áohl
(
tmp
);

12576 *
	gv®
 = (
ušt64_t
è
tmp
 << 32;

12577 
memıy
(&
tmp
, 
Áp
 + 4, (tmp));

12578 
	gtmp
 = 
Áohl
(
tmp
);

12579 *
	gv®
 |ğ
tmp
;

12582 
mg_¢_£nd_»que¡
(
mg_cÚÃùiÚ
 *
c
) {

12583 
ušt8_t
 
	gbuf
[48] = {0};

12589 
	gbuf
[0] = (3 << 6) | (4 << 3) | 3;

12611 #iâdeà
MG_SNTP_NO_DELAY_CORRECTION


12612 
ušt32_t
 
	g£c
;

12613 
	g£c
 = 
htÚl
((
ušt32_t
)(
mg_time
(è+ 
SNTP_TIME_OFFSET
));

12614 
memıy
(&
buf
[40], &
£c
, (sec));

12617 
mg_£nd
(
c
, 
buf
, (buf));

12620 #iâdeà
MG_SNTP_NO_DELAY_CORRECTION


12621 
ušt64_t
 
mg_ÿlcuÏ‹_d–ay
(ušt64_ˆ
t1
, ušt64_ˆ
t2
, ušt64_ˆ
t3
) {

12623 
ušt64_t
 
	gd1
 = ((
mg_time
(è+ 
SNTP_TIME_OFFSET
) * 1000000) -

12624 (
mg_g‘_£c
(
t1
è* 1000000 + 
mg_g‘_u£c
(t1));

12625 
ušt64_t
 
	gd2
 = (
mg_g‘_£c
(
t3
è* 1000000 + 
mg_g‘_u£c
(t3)) -

12626 (
mg_g‘_£c
(
t2
è* 1000000 + 
mg_g‘_u£c
(t2));

12628  (
	gd1
 > 
	gd2
) ? d1 - d2 : 0;

12632 
MG_INTERNAL
 
mg_¢_·r£_»¶y
(cÚ¡ *
buf
, 
Ën
,

12633 
mg_¢_mes§ge
 *
msg
) {

12634 
ušt8_t
 
	ghdr
;

12635 
ušt64_t
 
	gŒsm_ts_T3
, 
	gd–ay
 = 0;

12636 
	gmode
;

12637 
timev®
 
	gtv
;

12639 ià(
	gËn
 < 48) {

12643 
	ghdr
 = 
buf
[0];

12645 ià((
	ghdr
 & 0x38) >> 3 != 4) {

12650 
	gmode
 = 
hdr
 & 0x7;

12651 ià(
	gmode
 !ğ4 && 
mode
 != 5) {

12656 
mem£t
(
msg
, 0, (*msg));

12658 
	gmsg
->
	gkiss_of_d—th
 = (
buf
[1] == 0);

12660 
mg_g‘_Áp_ts
(&
buf
[40], &
Œsm_ts_T3
);

12662 #iâdeà
MG_SNTP_NO_DELAY_CORRECTION


12664 
ušt64_t
 
	gÜig_ts_T1
, 
	g»cv_ts_T2
;

12665 
mg_g‘_Áp_ts
(&
buf
[24], &
Üig_ts_T1
);

12666 
mg_g‘_Áp_ts
(&
buf
[32], &
»cv_ts_T2
);

12667 
	gd–ay
 = 
mg_ÿlcuÏ‹_d–ay
(
Üig_ts_T1
, 
»cv_ts_T2
, 
Œsm_ts_T3
);

12671 
mg_Áp_to_tv
(
Œsm_ts_T3
, &
tv
);

12673 
	gmsg
->
	gtime
 = (è
tv
.
tv_£c
 + (((ètv.
tv_u£c
 + 
d–ay
) / 1000000.0);

12678 
mg_¢_hªdËr
(
mg_cÚÃùiÚ
 *
c
, 
ev
,

12679 *
ev_d©a
 
MG_UD_ARG
(*
u£r_d©a
)) {

12680 
mbuf
 *
	gio
 = &
c
->
»cv_mbuf
;

12681 
mg_¢_mes§ge
 
	gmsg
;

12683 
	gc
->
hªdËr
(
c
, 
ev
, 
ev_d©a
 
MG_UD_ARG
(
u£r_d©a
));

12685 
	gev
) {

12686 
	gMG_EV_RECV
: {

12687 ià(
mg_¢_·r£_»¶y
(
io
->
buf
, io->
Ën
, &
msg
) < 0) {

12688 
DBG
(("Inv®id SNTP…ack‘„eûived (%d)", (è
io
->
Ën
));

12689 
	gc
->
hªdËr
(
c
, 
MG_SNTP_MALFORMED_REPLY
, 
NULL
 
MG_UD_ARG
(
u£r_d©a
));

12691 
	gc
->
hªdËr
(
c
, 
MG_SNTP_REPLY
, (*è&
msg
 
MG_UD_ARG
(
u£r_d©a
));

12694 
mbuf_»move
(
io
, io->
Ën
);

12700 
mg_£t_´ÙocŞ_¢
(
mg_cÚÃùiÚ
 *
c
) {

12701 ià((
	gc
->
	gæags
 & 
	gMG_F_UDP
) == 0) {

12705 
	gc
->
	g´Ùo_hªdËr
 = 
mg_¢_hªdËr
;

12710 
mg_cÚÃùiÚ
 *
mg_¢_cÚÃù
(
mg_mgr
 *
mgr
,

12711 
MG_CB
(
mg_ev’t_hªdËr_t
 
ev’t_hªdËr
,

12712 *
u£r_d©a
),

12713 cÚ¡ *
¢_£rv”_Çme
) {

12714 
mg_cÚÃùiÚ
 *
	gc
 = 
NULL
;

12715 
	gu¾
[100], *
	gp_u¾
 = 
u¾
;

12716 cÚ¡ *
	g´Ùo
 = "", *
	gpÜt
 = "", *
	gtmp
;

12719 
	gtmp
 = 
¡rchr
(
¢_£rv”_Çme
, ':');

12720 ià(
	gtmp
 !ğ
NULL
 && *(
tmp
 + 1) == '/') {

12721 
tmp
 = 
¡rchr
(tmp + 1, ':');

12724 ià(
	gtmp
 =ğ
NULL
) {

12725 
pÜt
 = ":123";

12729 ià(
¡ºcmp
(
¢_£rv”_Çme
, "udp://", 6) != 0) {

12730 
´Ùo
 = "udp://";

12733 
mg_a¥rštf
(&
p_u¾
, (
u¾
), "%s%s%s", 
´Ùo
, 
¢_£rv”_Çme
, 
pÜt
);

12735 
	gc
 = 
mg_cÚÃù
(
mgr
, 
p_u¾
, 
ev’t_hªdËr
 
MG_UD_ARG
(
u£r_d©a
));

12737 ià(
	gc
 =ğ
NULL
) {

12738 
ş—nup
;

12741 
mg_£t_´ÙocŞ_¢
(
c
);

12743 
	gş—nup
:

12744 ià(
p_u¾
 !ğ
u¾
) {

12745 
MG_FREE
(
p_u¾
);

12748  
	gc
;

12751 
	s¢_d©a
 {

12752 
mg_ev’t_hªdËr_t
 
	ghªd”
;

12753 
	gcouÁ
;

12756 
mg_¢_ut_ev_hªdËr
(
mg_cÚÃùiÚ
 *
c
, 
ev
,

12757 *
ev_d©a
 
MG_UD_ARG
(*
u£r_d©a
)) {

12758 #ià!
MG_ENABLE_CALLBACK_USERDATA


12759 *
	gu£r_d©a
 = 
c
->
u£r_d©a
;

12761 
¢_d©a
 *
	gsd
 = (¢_d©¨*è
u£r_d©a
;

12763 
	gev
) {

12764 
	gMG_EV_CONNECT
:

12765 ià(*(*è
ev_d©a
 != 0) {

12766 
mg_ÿÎ
(
c
, 
sd
->
hªd”
, c->
u£r_d©a
, 
MG_SNTP_FAILED
, 
NULL
);

12770 
	gMG_EV_TIMER
:

12771 ià(
sd
->
couÁ
 <ğ
SNTP_ATTEMPTS
) {

12772 
mg_¢_£nd_»que¡
(
c
);

12773 
mg_£t_tim”
(
c
, 
mg_time
() + 10);

12774 
	gsd
->
	gcouÁ
++;

12776 
mg_ÿÎ
(
c
, 
sd
->
hªd”
, c->
u£r_d©a
, 
MG_SNTP_FAILED
, 
NULL
);

12777 
	gc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

12780 
	gMG_SNTP_MALFORMED_REPLY
:

12781 
mg_ÿÎ
(
c
, 
sd
->
hªd”
, c->
u£r_d©a
, 
MG_SNTP_FAILED
, 
NULL
);

12782 
	gc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

12784 
	gMG_SNTP_REPLY
:

12785 
mg_ÿÎ
(
c
, 
sd
->
hªd”
, c->
u£r_d©a
, 
MG_SNTP_REPLY
, 
ev_d©a
);

12786 
	gc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

12788 
	gMG_EV_CLOSE
:

12789 
MG_FREE
(
u£r_d©a
);

12790 
	gc
->
	gu£r_d©a
 = 
NULL
;

12795 
mg_cÚÃùiÚ
 *
mg_¢_g‘_time
(
mg_mgr
 *
mgr
,

12796 
mg_ev’t_hªdËr_t
 
ev’t_hªdËr
,

12797 cÚ¡ *
¢_£rv”_Çme
) {

12798 
mg_cÚÃùiÚ
 *
	gc
;

12799 
¢_d©a
 *
	gsd
 = (¢_d©¨*è
MG_CALLOC
(1, (*
sd
));

12800 ià(
	gsd
 =ğ
NULL
) {

12801  
NULL
;

12804 
	gc
 = 
mg_¢_cÚÃù
(
mgr
, 
MG_CB
(
mg_¢_ut_ev_hªdËr
, 
sd
),

12805 
¢_£rv”_Çme
);

12806 ià(
	gc
 =ğ
NULL
) {

12807 
MG_FREE
(
sd
);

12808  
	gNULL
;

12811 
	gsd
->
	ghªd”
 = 
ev’t_hªdËr
;

12812 #ià!
MG_ENABLE_CALLBACK_USERDATA


12813 
	gc
->
	gu£r_d©a
 = 
sd
;

12816  
	gc
;

12820 #ifdeà
MG_MODULE_LINES


12828 #ià
MG_ENABLE_SOCKS


12842 
mg_socks5_hªdshake
(
mg_cÚÃùiÚ
 *
c
) {

12843 
mbuf
 *
	gr
 = &
c
->
»cv_mbuf
;

12844 ià(
	gr
->
	gbuf
[0] !ğ
MG_SOCKS_VERSION
) {

12845 
c
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

12846 } ià(
	gr
->
	gËn
 > 2 && (
	gsize_t
èr->
	gbuf
[1] + 2 <ğ
r
->
Ën
) {

12848 
»¶y
[2] = {
MG_SOCKS_VERSION
, 
MG_SOCKS_HANDSHAKE_FAILURE
};

12849 
	gi
;

12850 
	gi
 = 2; i < 
	gr
->
	gbuf
[1] + 2; i++) {

12852 ià(
	gr
->
	gbuf
[
i
] =ğ
MG_SOCKS_HANDSHAKE_NOAUTH
è
»¶y
[1] = 
r
->
buf
[i];

12854 
mbuf_»move
(
r
, 2 +„->
buf
[1]);

12855 
mg_£nd
(
c
, 
»¶y
, (reply));

12856 
	gc
->
	gæags
 |ğ
MG_SOCKS_HANDSHAKE_DONE
;

12860 
disbªd
(
mg_cÚÃùiÚ
 *
c
) {

12861 
mg_cÚÃùiÚ
 *
	gc2
 = (mg_cÚÃùiÚ *è
c
->
u£r_d©a
;

12862 ià(
	gc2
 !ğ
NULL
) {

12863 
c2
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

12864 
	gc2
->
	gu£r_d©a
 = 
NULL
;

12866 
	gc
->
	gæags
 |ğ
MG_F_SEND_AND_CLOSE
;

12867 
	gc
->
	gu£r_d©a
 = 
NULL
;

12870 
»Ïy_d©a
(
mg_cÚÃùiÚ
 *
c
) {

12871 
mg_cÚÃùiÚ
 *
	gc2
 = (mg_cÚÃùiÚ *è
c
->
u£r_d©a
;

12872 ià(
	gc2
 !ğ
NULL
) {

12873 
mg_£nd
(
c2
, 
c
->
»cv_mbuf
.
buf
, c->»cv_mbuf.
Ën
);

12874 
mbuf_»move
(&
c
->
»cv_mbuf
, c->»cv_mbuf.
Ën
);

12876 
	gc
->
	gæags
 |ğ
MG_F_SEND_AND_CLOSE
;

12880 
£rv_ev_hªdËr
(
mg_cÚÃùiÚ
 *
c
, 
ev
, *
ev_d©a
) {

12881 ià(
	gev
 =ğ
MG_EV_CLOSE
) {

12882 
disbªd
(
c
);

12883 } ià(
	gev
 =ğ
MG_EV_RECV
) {

12884 
»Ïy_d©a
(
c
);

12885 } ià(
	gev
 =ğ
MG_EV_CONNECT
) {

12886 
»s
 = *(*è
ev_d©a
;

12887 ià(
	g»s
 !ğ0è
LOG
(
LL_ERROR
, ("cÚÃùƒ¼Ü: %d", 
»s
));

12891 
mg_socks5_cÚÃù
(
mg_cÚÃùiÚ
 *
c
, cÚ¡ *
addr
) {

12892 
mg_cÚÃùiÚ
 *
	g£rv
 = 
mg_cÚÃù
(
c
->
mgr
, 
addr
, 
£rv_ev_hªdËr
);

12893 
	g£rv
->
	gu£r_d©a
 = 
c
;

12894 
	gc
->
	gu£r_d©a
 = 
£rv
;

12906 
mg_socks5_hªdË_»que¡
(
mg_cÚÃùiÚ
 *
c
) {

12907 
mbuf
 *
	gr
 = &
c
->
»cv_mbuf
;

12908 *
	gp
 = (*è
r
->
buf
;

12909 
	gaddr_Ën
 = 4, 
	g»¶y
 = 
MG_SOCKS_SUCCESS
;

12910 
	gv”
, 
	gcmd
, 
	g©yp
;

12911 
	gaddr
[300];

12913 ià(
	gr
->
	gËn
 < 8) ;

12914 
	gv”
 = 
p
[0];

12915 
	gcmd
 = 
p
[1];

12916 
	g©yp
 = 
p
[3];

12919 ià(
	gv”
 !ğ
MG_SOCKS_VERSION
 || 
cmd
 !ğ
MG_SOCKS_CMD_CONNECT
) {

12920 
»¶y
 = 
MG_SOCKS_CMD_NOT_SUPPORTED
;

12921 } ià(
	g©yp
 =ğ
MG_SOCKS_ADDR_IPV4
) {

12922 
addr_Ën
 = 4;

12923 ià(
	gr
->
	gËn
 < (
	gsize_t
è
	gaddr_Ën
 + 6) ;

12924 
¢´štf
(
addr
, ×ddr), "%d.%d.%d.%d:%d", 
p
[4],…[5],…[6],…[7],

12925 
p
[8] << 8 |…[9]);

12926 
mg_socks5_cÚÃù
(
c
, 
addr
);

12927 } ià(
	g©yp
 =ğ
MG_SOCKS_ADDR_IPV6
) {

12928 
addr_Ën
 = 16;

12929 ià(
	gr
->
	gËn
 < (
	gsize_t
è
	gaddr_Ën
 + 6) ;

12930 
¢´štf
(
addr
, (addr), "[%x:%x:%x:%x:%x:%x:%x:%x]:%d",

12931 
p
[4] << 8 |…[5],…[6] << 8 |…[7],…[8] << 8 |…[9],

12932 
p
[10] << 8 |…[11],…[12] << 8 |…[13],…[14] << 8 |…[15],

12933 
p
[16] << 8 |…[17],…[18] << 8 |…[19],…[20] << 8 |…[21]);

12934 
mg_socks5_cÚÃù
(
c
, 
addr
);

12935 } ià(
	g©yp
 =ğ
MG_SOCKS_ADDR_DOMAIN
) {

12936 
addr_Ën
 = 
p
[4] + 1;

12937 ià(
	gr
->
	gËn
 < (
	gsize_t
è
	gaddr_Ën
 + 6) ;

12938 
¢´štf
(
addr
, ×ddr), "%.*s:%d", 
p
[4],… + 5,

12939 
p
[4 + 
addr_Ën
] << 8 |…[4 +‡ddr_len + 1]);

12940 
mg_socks5_cÚÃù
(
c
, 
addr
);

12942 
	g»¶y
 = 
MG_SOCKS_ADDR_NOT_SUPPORTED
;

12955 
	gbuf
[] = {
MG_SOCKS_VERSION
, 
»¶y
, 0};

12956 
mg_£nd
(
c
, 
buf
, (buf));

12958 
mg_£nd
(
c
, 
r
->
buf
 + 3, 
addr_Ën
 + 1 + 2);

12960 
mbuf_»move
(
r
, 6 + 
addr_Ën
);

12961 
	gc
->
	gæags
 |ğ
MG_SOCKS_CONNECT_DONE
;

12964 
socks_hªdËr
(
mg_cÚÃùiÚ
 *
c
, 
ev
, *
ev_d©a
) {

12965 ià(
	gev
 =ğ
MG_EV_RECV
) {

12966 ià(!(
c
->
æags
 & 
MG_SOCKS_HANDSHAKE_DONE
)è
mg_socks5_hªdshake
(c);

12967 ià(
	gc
->
	gæags
 & 
	gMG_SOCKS_HANDSHAKE_DONE
 &&

12968 !(
	gc
->
	gæags
 & 
	gMG_SOCKS_CONNECT_DONE
)) {

12969 
mg_socks5_hªdË_»que¡
(
c
);

12971 ià(
	gc
->
	gæags
 & 
	gMG_SOCKS_CONNECT_DONE
è
»Ïy_d©a
(
c
);

12972 } ià(
	gev
 =ğ
MG_EV_CLOSE
) {

12973 
disbªd
(
c
);

12975 (è
	gev_d©a
;

12978 
mg_£t_´ÙocŞ_socks
(
mg_cÚÃùiÚ
 *
c
) {

12979 
	gc
->
	g´Ùo_hªdËr
 = 
socks_hªdËr
;

12982 #ifdeà
MG_MODULE_LINES


12990 #ià
CS_PLATFORM
 =ğ
CS_P_CC3200


12993 
	~<¡dio.h
>

12994 
	~<¡ršg.h
>

12996 #iâdeà
__TI_COMPILER_VERSION__


12997 
	~<»’t.h
>

12998 
	~<sys/¡©.h
>

12999 
	~<sys/time.h
>

13000 
	~<uni¡d.h
>

13003 
	~<šc/hw_ty³s.h
>

13004 
	~<šc/hw_memm­.h
>

13005 
	~<driv”lib/´cm.h
>

13006 
	~<driv”lib/rom.h
>

13007 
	~<driv”lib/rom_m­.h
>

13008 
	~<driv”lib/u¬t.h
>

13009 
	~<driv”lib/uts.h
>

13011 
	#CONSOLE_UART
 
UARTA0_BASE


	)

13013 #ifdeà
__TI_COMPILER_VERSION__


13014 
a¥rštf
(**
¡½
, cÚ¡ *
fmt
, ...) {

13015 
va_li¡
 
	g­
;

13016 
	gËn
;

13018 *
	g¡½
 = 
MG_MALLOC
(
BUFSIZ
);

13019 ià(*
	g¡½
 =ğ
NULL
)  -1;

13021 
va_¡¬t
(
­
, 
fmt
);

13022 
	gËn
 = 
v¢´štf
(*
¡½
, 
BUFSIZ
, 
fmt
, 
­
);

13023 
va_’d
(
­
);

13025 ià(
	gËn
 > 0) {

13026 *
	g¡½
 = 
MG_REALLOC
(*
¡½
, 
Ën
 + 1);

13027 ià(*
	g¡½
 =ğ
NULL
)  -1;

13030 ià(
	gËn
 >ğ
BUFSIZ
) {

13031 
va_¡¬t
(
­
, 
fmt
);

13032 
	gËn
 = 
v¢´štf
(*
¡½
, 
Ën
 + 1, 
fmt
, 
­
);

13033 
va_’d
(
­
);

13036  
	gËn
;

13039 #ià
MG_TI_NO_HOST_INTERFACE


13040 
time_t
 
HOSTtime
() {

13041 
timev®
 
	g
;

13042 
g‘timeofday
(&

, 
NULL
);

13043  
	g
.
	gtv_£c
;

13049 
åršt_¡r
(
FILE
 *
å
, cÚ¡ *
¡r
) {

13050 *
	g¡r
 != '\0') {

13051 ià(*
¡r
 =ğ'\n'è
MAP_UARTCh¬Put
(
CONSOLE_UART
, '\r');

13052 
MAP_UARTCh¬Put
(
CONSOLE_UART
, *
¡r
++);

13056 
_ex™
(
¡©us
) {

13057 
åršt_¡r
(
¡d”r
, "_exit\n");

13059 *(*è1 = 
¡©us
;

13064 
_nÙ_im¶em’‹d
(cÚ¡ *
wh©
) {

13065 
åršt_¡r
(
¡d”r
, 
wh©
);

13066 
åršt_¡r
(
¡d”r
, " is‚ot implemented\n");

13067 
_ex™
(42);

13070 
_kl
(
pid
, 
sig
) {

13071 (è
	gpid
;

13072 (è
	gsig
;

13073 
_nÙ_im¶em’‹d
("_kill");

13077 
_g‘pid
() {

13078 
åršt_¡r
(
¡d”r
, "_getpid is‚ot implemented\n");

13082 
_i§‰y
(
fd
) {

13084  
	gfd
 < 2;

13088 #ifdeà
MG_MODULE_LINES


13096 #ià
CS_PLATFORM
 =ğ
CS_P_MSP432


13098 
	~<ti/sysbios/BIOS.h
>

13099 
	~<ti/sysbios/kÆ/Clock.h
>

13101 
g‘timeofday
(
timev®
 *

, *
tzp
) {

13102 
ušt32_t
 
	gticks
 = 
Clock_g‘Ticks
();

13103 
	g
->
	gtv_£c
 = 
ticks
 / 1000;

13104 
	g
->
	gtv_u£c
 = (
ticks
 % 1000) * 1000;

13109 #ifdeà
MG_MODULE_LINES


13117 #ià(
CS_PLATFORM
 =ğ
CS_P_NRF51
 || CS_PLATFORM =ğ
CS_P_NRF52
) && \

13118 
defšed
(
__ARMCC_VERSION
)

13119 
g‘timeofday
(
timev®
 *

, *
tzp
) {

13121 
	g
->
	gtv_£c
 = 0;

13122 
	g
->
	gtv_u£c
 = 0;

13126 #ifdeà
MG_MODULE_LINES


13134 #iâdeà
CS_COMMON_PLATFORMS_SIMPLELINK_SL_FS_SLFS_H_


13135 
	#CS_COMMON_PLATFORMS_SIMPLELINK_SL_FS_SLFS_H_


	)

13137 #ià
defšed
(
MG_FS_SLFS
)

13139 
	~<¡dio.h
>

13140 #iâdeà
__TI_COMPILER_VERSION__


13141 
	~<uni¡d.h
>

13142 
	~<sys/¡©.h
>

13145 
	#MAX_OPEN_SLFS_FILES
 8

	)

13148 
fs_¦fs_İ’
(cÚ¡ *
·thÇme
, 
æags
, 
mode_t
 
mode
);

13149 
fs_¦fs_şo£
(
fd
);

13150 
ssize_t
 
fs_¦fs_»ad
(
fd
, *
buf
, 
size_t
 
couÁ
);

13151 
ssize_t
 
fs_¦fs_wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

13152 
fs_¦fs_¡©
(cÚ¡ *
·thÇme
, 
¡©
 *
s
);

13153 
fs_¦fs_f¡©
(
fd
, 
¡©
 *
s
);

13154 
off_t
 
fs_¦fs_l£ek
(
fd
, off_ˆ
off£t
, 
wh’û
);

13155 
fs_¦fs_uÆšk
(cÚ¡ *
f’ame
);

13156 
fs_¦fs_»Çme
(cÚ¡ *
äom
, cÚ¡ *
to
);

13158 
fs_¦fs_£t_Ãw_fe_size
(cÚ¡ *
Çme
, 
size_t
 
size
);

13163 #ifdeà
MG_MODULE_LINES


13173 #ià
defšed
(
MG_FS_SLFS
è|| defšed(
CC3200_FS_SLFS
)

13177 
	~<”ºo.h
>

13179 #ià
CS_PLATFORM
 =ğ
CS_P_CC3200


13180 
	~<šc/hw_ty³s.h
>

13186 #ià
SL_MAJOR_VERSION_NUM
 < 2

13187 
¦fs_İ’
(cÚ¡ *
âame
, 
ušt32_t
 
æags
) {

13188 
_i32
 
	gfh
;

13189 
_i32
 
	gr
 = 
¦_FsO³n
(
âame
, 
æags
, 
NULL
 , &
fh
);

13190  (
	gr
 < 0 ?„ : 
fh
);

13193 
¦fs_İ’
(cÚ¡ *
âame
, 
ušt32_t
 
æags
) {

13194  
¦_FsO³n
(
âame
, 
æags
, 
NULL
 );

13199 
£t_”ºo
(
e
);

13200 cÚ¡ *
drİ_dœ
(cÚ¡ *
âame
, 
boŞ
 *
is_¦fs
);

13206 #iâdeà
FS_SLFS_MAX_FILE_SIZE


13207 
	#FS_SLFS_MAX_FILE_SIZE
 (64 * 1024)

	)

13210 
	s¦_fe_size_hšt
 {

13211 *
	gÇme
;

13212 
size_t
 
	gsize
;

13215 
	s¦_fd_šfo
 {

13216 
_i32
 
	gfh
;

13217 
_off_t
 
	gpos
;

13218 
size_t
 
	gsize
;

13221 
¦_fd_šfo
 
	gs_¦_fds
[
MAX_OPEN_SLFS_FILES
];

13222 
¦_fe_size_hšt
 
	gs_¦_fe_size_hšts
[
MAX_OPEN_SLFS_FILES
];

13224 
¦_fs_to_”ºo
(
_i32
 
r
) {

13225 
DBG
(("SLƒ¼Ü: %d", (è
r
));

13226 
	gr
) {

13227 
	gSL_FS_OK
:

13229 
	gSL_ERROR_FS_FILE_NAME_EXIST
:

13230  
EEXIST
;

13231 
	gSL_ERROR_FS_WRONG_FILE_NAME
:

13232  
EINVAL
;

13233 
	gSL_ERROR_FS_NO_AVAILABLE_NV_INDEX
:

13234 
SL_ERROR_FS_NOT_ENOUGH_STORAGE_SPACE
:

13235  
ENOSPC
;

13236 
	gSL_ERROR_FS_FAILED_TO_ALLOCATE_MEM
:

13237  
ENOMEM
;

13238 
	gSL_ERROR_FS_FILE_NOT_EXISTS
:

13239  
ENOENT
;

13240 
	gSL_ERROR_FS_NOT_SUPPORTED
:

13241  
ENOTSUP
;

13243  
	gENXIO
;

13246 
fs_¦fs_İ’
(cÚ¡ *
·thÇme
, 
æags
, 
mode_t
 
mode
) {

13247 
	gfd
;

13248 
	gfd
 = 0; fd < 
	gMAX_OPEN_SLFS_FILES
; fd++) {

13249 ià(
	gs_¦_fds
[
fd
].
	gfh
 <= 0) ;

13251 ià(
	gfd
 >ğ
MAX_OPEN_SLFS_FILES
è 
£t_”ºo
(
ENOMEM
);

13252 
¦_fd_šfo
 *
	gfi
 = &
s_¦_fds
[
fd
];

13258 
	g·thÇme
 = 
drİ_dœ
(
·thÇme
, 
NULL
);

13260 
_u32
 
	gam
 = 0;

13261 
	gfi
->
	gsize
 = (
size_t
) -1;

13262 
	grw
 = (
æags
 & 3);

13263 
size_t
 
	gÃw_size
 = 
FS_SLFS_MAX_FILE_SIZE
;

13264 ià(
	grw
 =ğ
O_RDONLY
) {

13265 
SlFsFeInfo_t
 
¦_fi
;

13266 
_i32
 
	gr
 = 
¦_FsG‘Info
((cÚ¡ 
_u8
 *è
·thÇme
, 0, &
¦_fi
);

13267 ià(
	gr
 =ğ
SL_FS_OK
) {

13268 
fi
->
size
 = 
SL_FI_FILE_SIZE
(
¦_fi
);

13270 
	gam
 = 
SL_FS_READ
;

13272 ià(!(
	gæags
 & 
	gO_TRUNC
è|| (æag & 
	gO_APPEND
)) {

13275  
£t_”ºo
(
ENOTSUP
);

13277 ià(
	gæags
 & 
	gO_CREAT
) {

13278 
size_t
 
	gi
;

13279 
	gi
 = 0; i < 
	gMAX_OPEN_SLFS_FILES
; i++) {

13280 ià(
	gs_¦_fe_size_hšts
[
i
].
	gÇme
 !ğ
NULL
 &&

13281 
¡rcmp
(
s_¦_fe_size_hšts
[
i
].
Çme
, 
·thÇme
) == 0) {

13282 
Ãw_size
 = 
s_¦_fe_size_hšts
[
i
].
size
;

13283 
MG_FREE
(
s_¦_fe_size_hšts
[
i
].
Çme
);

13284 
	gs_¦_fe_size_hšts
[
i
].
	gÇme
 = 
NULL
;

13288 
	gam
 = 
FS_MODE_OPEN_CREATE
(
Ãw_size
, 0);

13290 
	gam
 = 
SL_FS_WRITE
;

13293 
	gfi
->
	gfh
 = 
¦fs_İ’
((
_u8
 *è
·thÇme
, 
am
);

13294 
LOG
(
LL_DEBUG
, ("¦_FsO³n(%s, 0x%xèsz %u = %d", 
·thÇme
, (è
am
,

13295 (è
Ãw_size
, (è
fi
->
fh
));

13296 
	gr
;

13297 ià(
	gfi
->
	gfh
 >= 0) {

13298 
fi
->
pos
 = 0;

13299 
	gr
 = 
fd
;

13301 
	gr
 = 
£t_”ºo
(
¦_fs_to_”ºo
(
fi
->
fh
));

13303  
	gr
;

13306 
fs_¦fs_şo£
(
fd
) {

13307 
¦_fd_šfo
 *
	gfi
 = &
s_¦_fds
[
fd
];

13308 ià(
	gfi
->
	gfh
 <ğ0è 
£t_”ºo
(
EBADF
);

13309 
_i32
 
	gr
 = 
¦_FsClo£
(
fi
->
fh
, 
NULL
, NULL, 0);

13310 
LOG
(
LL_DEBUG
, ("¦_FsClo£(%dèğ%d", (è
fi
->
fh
, (è
r
));

13311 
	gs_¦_fds
[
fd
].
	gfh
 = -1;

13312  
£t_”ºo
(
¦_fs_to_”ºo
(
r
));

13315 
ssize_t
 
fs_¦fs_»ad
(
fd
, *
buf
, 
size_t
 
couÁ
) {

13316 
¦_fd_šfo
 *
	gfi
 = &
s_¦_fds
[
fd
];

13317 ià(
	gfi
->
	gfh
 <ğ0è 
£t_”ºo
(
EBADF
);

13320 ià(
	gfi
->
	gpos
 =ğ
fi
->
size
)  0;

13321 
_i32
 
	gr
 = 
¦_FsR—d
(
fi
->
fh
, fi->
pos
, 
buf
, 
couÁ
);

13322 
DBG
(("¦_FsR—d(%d, %d, %dèğ%d", (è
fi
->
fh
, (èfi->
pos
, (è
couÁ
,

13323 (è
r
));

13324 ià(
	gr
 >= 0) {

13325 
fi
->
pos
 +ğ
r
;

13326  
	gr
;

13328  
£t_”ºo
(
¦_fs_to_”ºo
(
r
));

13331 
ssize_t
 
fs_¦fs_wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
) {

13332 
¦_fd_šfo
 *
	gfi
 = &
s_¦_fds
[
fd
];

13333 ià(
	gfi
->
	gfh
 <ğ0è 
£t_”ºo
(
EBADF
);

13334 
_i32
 
	gr
 = 
¦_FsWr™e
(
fi
->
fh
, fi->
pos
, (
_u8
 *è
buf
, 
couÁ
);

13335 
DBG
(("¦_FsWr™e(%d, %d, %dèğ%d", (è
fi
->
fh
, (èfi->
pos
, (è
couÁ
,

13336 (è
r
));

13337 ià(
	gr
 >= 0) {

13338 
fi
->
pos
 +ğ
r
;

13339  
	gr
;

13341  
£t_”ºo
(
¦_fs_to_”ºo
(
r
));

13344 
fs_¦fs_¡©
(cÚ¡ *
·thÇme
, 
¡©
 *
s
) {

13345 
SlFsFeInfo_t
 
	g¦_fi
;

13350 
	g·thÇme
 = 
drİ_dœ
(
·thÇme
, 
NULL
);

13351 
_i32
 
	gr
 = 
¦_FsG‘Info
((cÚ¡ 
_u8
 *è
·thÇme
, 0, &
¦_fi
);

13352 ià(
	gr
 =ğ
SL_FS_OK
) {

13353 
s
->
¡_mode
 = 
S_IFREG
 | 0666;

13354 
	gs
->
	g¡_Æšk
 = 1;

13355 
	gs
->
	g¡_size
 = 
SL_FI_FILE_SIZE
(
¦_fi
);

13358  
£t_”ºo
(
¦_fs_to_”ºo
(
r
));

13361 
fs_¦fs_f¡©
(
fd
, 
¡©
 *
s
) {

13362 
¦_fd_šfo
 *
	gfi
 = &
s_¦_fds
[
fd
];

13363 ià(
	gfi
->
	gfh
 <ğ0è 
£t_”ºo
(
EBADF
);

13364 
	gs
->
	g¡_mode
 = 0666;

13365 
	gs
->
	g¡_mode
 = 
S_IFREG
 | 0666;

13366 
	gs
->
	g¡_Æšk
 = 1;

13367 
	gs
->
	g¡_size
 = 
fi
->
size
;

13371 
off_t
 
fs_¦fs_l£ek
(
fd
, off_ˆ
off£t
, 
wh’û
) {

13372 ià(
	gs_¦_fds
[
fd
].
	gfh
 <ğ0è 
£t_”ºo
(
EBADF
);

13373 
	gwh’û
) {

13374 
	gSEEK_SET
:

13375 
s_¦_fds
[
fd
].
pos
 = 
off£t
;

13377 
	gSEEK_CUR
:

13378 
s_¦_fds
[
fd
].
pos
 +ğ
off£t
;

13380 
	gSEEK_END
:

13381  
£t_”ºo
(
ENOTSUP
);

13386 
fs_¦fs_uÆšk
(cÚ¡ *
·thÇme
) {

13391 
	g·thÇme
 = 
drİ_dœ
(
·thÇme
, 
NULL
);

13392  
£t_”ºo
(
¦_fs_to_”ºo
(
¦_FsD–
((cÚ¡ 
_u8
 *è
·thÇme
, 0)));

13395 
fs_¦fs_»Çme
(cÚ¡ *
äom
, cÚ¡ *
to
) {

13396  
£t_”ºo
(
ENOTSUP
);

13399 
fs_¦fs_£t_Ãw_fe_size
(cÚ¡ *
Çme
, 
size_t
 
size
) {

13400 
	gi
;

13401 
	gi
 = 0; i < 
	gMAX_OPEN_SLFS_FILES
; i++) {

13402 ià(
	gs_¦_fe_size_hšts
[
i
].
	gÇme
 =ğ
NULL
) {

13403 
DBG
(("Fsizhšt: % %d", 
Çme
, (è
size
));

13404 
	gs_¦_fe_size_hšts
[
i
].
	gÇme
 = 
¡rdup
(
Çme
);

13405 
	gs_¦_fe_size_hšts
[
i
].
	gsize
 = 
size
;

13412 #ifdeà
MG_MODULE_LINES


13420 #ià
MG_NET_IF
 =ğ
MG_NET_IF_SIMPLELINK
 && \

13421 (
defšed
(
MG_FS_SLFS
è|| defšed(
MG_FS_SPIFFS
))

13423 
£t_”ºo
(
e
) {

13424 
	g”ºo
 = 
e
;

13425  (
	ge
 == 0 ? 0 : -1);

13428 cÚ¡ *
drİ_dœ
(cÚ¡ *
âame
, 
boŞ
 *
is_¦fs
) {

13429 ià(
	gis_¦fs
 !ğ
NULL
) {

13430 *
is_¦fs
 = (
¡ºcmp
(
âame
, "SL:", 3) == 0);

13431 ià(*
	gis_¦fs
è
	gâame
 += 3;

13434 ià(
	gâame
[0] =ğ'.' && 
âame
[1] == '/') {

13435 
âame
 += 2;

13441 ià(
	gâame
[0] =ğ'/' && 
¡rchr
(
âame
 + 1, '/'è=ğ
NULL
) {

13442 
âame
++;

13444  
	gâame
;

13447 #ià!
defšed
(
MG_FS_NO_VFS
)

13449 
	~<”ºo.h
>

13450 
	~<¡dboŞ.h
>

13451 
	~<¡dio.h
>

13452 
	~<¡dlib.h
>

13453 
	~<¡ršg.h
>

13454 #ifdeà
__TI_COMPILER_VERSION__


13455 
	~<fe.h
>

13461 #ifdeà
CC3200_FS_SPIFFS


13465 #ifdeà
MG_FS_SLFS


13469 
	#NUM_SYS_FDS
 3

	)

13470 
	#SPIFFS_FD_BASE
 10

	)

13471 
	#SLFS_FD_BASE
 100

	)

13473 #ià!
defšed
(
MG_UART_CHAR_PUT
è&& !defšed(
MG_UART_WRITE
)

13474 #ià
CS_PLATFORM
 =ğ
CS_P_CC3200


13475 
	~<šc/hw_ty³s.h
>

13476 
	~<šc/hw_memm­.h
>

13477 
	~<driv”lib/rom.h
>

13478 
	~<driv”lib/rom_m­.h
>

13479 
	~<driv”lib/u¬t.h
>

13480 
	#MG_UART_CHAR_PUT
(
fd
, 
c
è
	`MAP_UARTCh¬Put
(
UARTA0_BASE
, c);

	)

13482 
	#MG_UART_WRITE
(
fd
, 
buf
, 
Ën
)

	)

13486 
	efd_ty³
 {

13487 
	gFD_INVALID
,

13488 
	gFD_SYS
,

13489 #ifdeà
CC3200_FS_SPIFFS


13490 
	gFD_SPIFFS
,

13492 #ifdeà
MG_FS_SLFS


13493 
	gFD_SLFS


13496 
fd_ty³
(
fd
) {

13497 ià(
	gfd
 >ğ0 && 
fd
 < 
NUM_SYS_FDS
è 
FD_SYS
;

13498 #ifdeà
CC3200_FS_SPIFFS


13499 ià(
	gfd
 >ğ
SPIFFS_FD_BASE
 && 
fd
 < SPIFFS_FD_BASE + 
MAX_OPEN_SPIFFS_FILES
) {

13500  
FD_SPIFFS
;

13503 #ifdeà
MG_FS_SLFS


13504 ià(
	gfd
 >ğ
SLFS_FD_BASE
 && 
fd
 < SLFS_FD_BASE + 
MAX_OPEN_SLFS_FILES
) {

13505  
FD_SLFS
;

13508  
	gFD_INVALID
;

13511 #ià
MG_TI_NO_HOST_INTERFACE


13512 
İ’
(cÚ¡ *
·thÇme
, 
æags
, 
mode
) {

13514 
_İ’
(cÚ¡ *
·thÇme
, 
æags
, 
mode_t
 
mode
) {

13516 
	gfd
 = -1;

13517 
boŞ
 
	gis_¦
;

13518 cÚ¡ *
	gâame
 = 
drİ_dœ
(
·thÇme
, &
is_¦
);

13519 ià(
	gis_¦
) {

13520 #ifdeà
MG_FS_SLFS


13521 
	gfd
 = 
fs_¦fs_İ’
(
âame
, 
æags
, 
mode
);

13522 ià(
	gfd
 >ğ0è
fd
 +ğ
SLFS_FD_BASE
;

13525 #ifdeà
CC3200_FS_SPIFFS


13526 
	gfd
 = 
fs_¥iffs_İ’
(
âame
, 
æags
, 
mode
);

13527 ià(
	gfd
 >ğ0è
fd
 +ğ
SPIFFS_FD_BASE
;

13530 
LOG
(
LL_DEBUG
,

13531 ("İ’(%s, 0x%xèğ%d, fÇmğ%s", 
·thÇme
, 
æags
, 
fd
, 
âame
));

13532  
	gfd
;

13535 
_¡©
(cÚ¡ *
·thÇme
, 
¡©
 *
¡
) {

13536 
	g»s
 = -1;

13537 
boŞ
 
	gis_¦
;

13538 cÚ¡ *
	gâame
 = 
drİ_dœ
(
·thÇme
, &
is_¦
);

13539 
mem£t
(
¡
, 0, (*st));

13541 ià(
	gâame
[0] =ğ'\0' || 
¡rcmp
(
âame
, ".") == 0) {

13542 
¡
->
¡_šo
 = 0;

13543 
	g¡
->
	g¡_mode
 = 
S_IFDIR
 | 0777;

13544 
	g¡
->
	g¡_Æšk
 = 1;

13545 
	g¡
->
	g¡_size
 = 0;

13548 ià(
	gis_¦
) {

13549 #ifdeà
MG_FS_SLFS


13550 
	g»s
 = 
fs_¦fs_¡©
(
âame
, 
¡
);

13553 #ifdeà
CC3200_FS_SPIFFS


13554 
	g»s
 = 
fs_¥iffs_¡©
(
âame
, 
¡
);

13557 
LOG
(
LL_DEBUG
, ("¡©(%sèğ%d; fÇmğ%s", 
·thÇme
, 
»s
, 
âame
));

13558  
	g»s
;

13561 #ià
MG_TI_NO_HOST_INTERFACE


13562 
şo£
(
fd
) {

13564 
_şo£
(
fd
) {

13566 
	gr
 = -1;

13567 
fd_ty³
(
fd
)) {

13568 
	gFD_INVALID
:

13569 
r
 = 
£t_”ºo
(
EBADF
);

13571 
	gFD_SYS
:

13572 
r
 = 
£t_”ºo
(
EACCES
);

13574 #ifdeà
CC3200_FS_SPIFFS


13575 
	gFD_SPIFFS
:

13576 
r
 = 
fs_¥iffs_şo£
(
fd
 - 
SPIFFS_FD_BASE
);

13579 #ifdeà
MG_FS_SLFS


13580 
	gFD_SLFS
:

13581 
r
 = 
fs_¦fs_şo£
(
fd
 - 
SLFS_FD_BASE
);

13585 
DBG
(("şo£(%dèğ%d", 
fd
, 
r
));

13586  
	gr
;

13589 #ià
MG_TI_NO_HOST_INTERFACE


13590 
off_t
 
l£ek
(
fd
, off_ˆ
off£t
, 
wh’û
) {

13592 
off_t
 
_l£ek
(
fd
, off_ˆ
off£t
, 
wh’û
) {

13594 
	gr
 = -1;

13595 
fd_ty³
(
fd
)) {

13596 
	gFD_INVALID
:

13597 
r
 = 
£t_”ºo
(
EBADF
);

13599 
	gFD_SYS
:

13600 
r
 = 
£t_”ºo
(
ESPIPE
);

13602 #ifdeà
CC3200_FS_SPIFFS


13603 
	gFD_SPIFFS
:

13604 
r
 = 
fs_¥iffs_l£ek
(
fd
 - 
SPIFFS_FD_BASE
, 
off£t
, 
wh’û
);

13607 #ifdeà
MG_FS_SLFS


13608 
	gFD_SLFS
:

13609 
r
 = 
fs_¦fs_l£ek
(
fd
 - 
SLFS_FD_BASE
, 
off£t
, 
wh’û
);

13613 
DBG
(("l£ek(%d, %d, %dèğ%d", 
fd
, (è
off£t
, 
wh’û
, 
r
));

13614  
	gr
;

13617 
_f¡©
(
fd
, 
¡©
 *
s
) {

13618 
	gr
 = -1;

13619 
mem£t
(
s
, 0, (*s));

13620 
fd_ty³
(
fd
)) {

13621 
	gFD_INVALID
:

13622 
r
 = 
£t_”ºo
(
EBADF
);

13624 
	gFD_SYS
: {

13626 
mem£t
(
s
, 0, (*s));

13627 
	gs
->
	g¡_šo
 = 
fd
;

13628 
	gs
->
	g¡_mode
 = 
S_IFCHR
 | 0666;

13629 
	gr
 = 0;

13632 #ifdeà
CC3200_FS_SPIFFS


13633 
	gFD_SPIFFS
:

13634 
r
 = 
fs_¥iffs_f¡©
(
fd
 - 
SPIFFS_FD_BASE
, 
s
);

13637 #ifdeà
MG_FS_SLFS


13638 
	gFD_SLFS
:

13639 
r
 = 
fs_¦fs_f¡©
(
fd
 - 
SLFS_FD_BASE
, 
s
);

13643 
DBG
(("f¡©(%dèğ%d", 
fd
, 
r
));

13644  
	gr
;

13647 #ià
MG_TI_NO_HOST_INTERFACE


13648 
»ad
(
fd
, *
buf
, 
couÁ
) {

13650 
ssize_t
 
_»ad
(
fd
, *
buf
, 
size_t
 
couÁ
) {

13652 
	gr
 = -1;

13653 
fd_ty³
(
fd
)) {

13654 
	gFD_INVALID
:

13655 
r
 = 
£t_”ºo
(
EBADF
);

13657 
	gFD_SYS
: {

13658 ià(
fd
 != 0) {

13659 
r
 = 
£t_”ºo
(
EACCES
);

13663 
	gr
 = 
£t_”ºo
(
ENOTSUP
);

13666 #ifdeà
CC3200_FS_SPIFFS


13667 
	gFD_SPIFFS
:

13668 
r
 = 
fs_¥iffs_»ad
(
fd
 - 
SPIFFS_FD_BASE
, 
buf
, 
couÁ
);

13671 #ifdeà
MG_FS_SLFS


13672 
	gFD_SLFS
:

13673 
r
 = 
fs_¦fs_»ad
(
fd
 - 
SLFS_FD_BASE
, 
buf
, 
couÁ
);

13677 
DBG
(("»ad(%d, %uèğ%d", 
fd
, 
couÁ
, 
r
));

13678  
	gr
;

13681 #ià
MG_TI_NO_HOST_INTERFACE


13682 
wr™e
(
fd
, cÚ¡ *
buf
, 
couÁ
) {

13684 
ssize_t
 
_wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
) {

13686 
	gr
 = -1;

13687 
fd_ty³
(
fd
)) {

13688 
	gFD_INVALID
:

13689 
r
 = 
£t_”ºo
(
EBADF
);

13691 
	gFD_SYS
: {

13692 ià(
fd
 == 0) {

13693 
r
 = 
£t_”ºo
(
EACCES
);

13696 #ifdeà
MG_UART_WRITE


13697 
MG_UART_WRITE
(
fd
, 
buf
, 
couÁ
);

13698 #–ià
defšed
(
MG_UART_CHAR_PUT
)

13700 
size_t
 
	gi
;

13701 
	gi
 = 0; i < 
	gcouÁ
; i++) {

13702 cÚ¡ 
	gc
 = ((cÚ¡ *è
buf
)[
i
];

13703 ià(
	gc
 =ğ'\n'è
MG_UART_CHAR_PUT
(
fd
, '\r');

13704 
MG_UART_CHAR_PUT
(
fd
, 
c
);

13708 
	gr
 = 
couÁ
;

13711 #ifdeà
CC3200_FS_SPIFFS


13712 
	gFD_SPIFFS
:

13713 
r
 = 
fs_¥iffs_wr™e
(
fd
 - 
SPIFFS_FD_BASE
, 
buf
, 
couÁ
);

13716 #ifdeà
MG_FS_SLFS


13717 
	gFD_SLFS
:

13718 
r
 = 
fs_¦fs_wr™e
(
fd
 - 
SLFS_FD_BASE
, 
buf
, 
couÁ
);

13722  
	gr
;

13729 #ià
MG_TI_NO_HOST_INTERFACE
 || 
defšed
(
_NEWLIB_VERSION
)

13730 
»Çme
(cÚ¡ *
äom·th
, cÚ¡ *
tİ©h
) {

13731 
	gr
 = -1;

13732 
boŞ
 
	gis_¦_äom
, 
	gis_¦_to
;

13733 cÚ¡ *
	gäom
 = 
drİ_dœ
(
äom·th
, &
is_¦_äom
);

13734 cÚ¡ *
	gto
 = 
drİ_dœ
(
tİ©h
, &
is_¦_to
);

13735 ià(
	gis_¦_äom
 || 
	gis_¦_to
) {

13736 
£t_”ºo
(
ENOTSUP
);

13738 #ifdeà
CC3200_FS_SPIFFS


13739 
	gr
 = 
fs_¥iffs_»Çme
(
äom
, 
to
);

13742 
DBG
(("»Çme(%s, %sèğ%d", 
äom
, 
to
, 
r
));

13743  
	gr
;

13747 #ià
MG_TI_NO_HOST_INTERFACE


13748 
uÆšk
(cÚ¡ *
·thÇme
) {

13750 
_uÆšk
(cÚ¡ *
·thÇme
) {

13752 
	gr
 = -1;

13753 
boŞ
 
	gis_¦
;

13754 cÚ¡ *
	gâame
 = 
drİ_dœ
(
·thÇme
, &
is_¦
);

13755 ià(
	gis_¦
) {

13756 #ifdeà
MG_FS_SLFS


13757 
	gr
 = 
fs_¦fs_uÆšk
(
âame
);

13760 #ifdeà
CC3200_FS_SPIFFS


13761 
	gr
 = 
fs_¥iffs_uÆšk
(
âame
);

13764 
DBG
(("uÆšk(%sèğ%d, fÇmğ%s", 
·thÇme
, 
r
, 
âame
));

13765  
	gr
;

13768 #ifdeà
CC3200_FS_SPIFFS


13769 
DIR
 *
İ’dœ
(cÚ¡ *
dœ_Çme
) {

13770 
DIR
 *
	gr
 = 
NULL
;

13771 
boŞ
 
	gis_¦
;

13772 
drİ_dœ
(
dœ_Çme
, &
is_¦
);

13773 ià(
	gis_¦
) {

13774 
	gr
 = 
NULL
;

13775 
£t_”ºo
(
ENOTSUP
);

13777 
	gr
 = 
fs_¥iffs_İ’dœ
(
dœ_Çme
);

13779 
DBG
(("İ’dœ(%sèğ%p", 
dœ_Çme
, 
r
));

13780  
	gr
;

13783 
dœ’t
 *
»addœ
(
DIR
 *
dœ
) {

13784 
dœ’t
 *
	g»s
 = 
fs_¥iffs_»addœ
(
dœ
);

13785 
DBG
(("»addœ(%pèğ%p", 
dœ
, 
»s
));

13786  
	g»s
;

13789 
şo£dœ
(
DIR
 *
dœ
) {

13790 
	g»s
 = 
fs_¥iffs_şo£dœ
(
dœ
);

13791 
DBG
(("şo£dœ(%pèğ%d", 
dœ
, 
»s
));

13792  
	g»s
;

13795 
rmdœ
(cÚ¡ *
·th
) {

13796  
fs_¥iffs_rmdœ
(
·th
);

13799 
mkdœ
(cÚ¡ *
·th
, 
mode_t
 
mode
) {

13800 (è
	g·th
;

13801 (è
	gmode
;

13803  (
¡¾’
(
·th
è=ğ1 && *·th =ğ'.'è? 0 : 
ENOTDIR
;

13807 
¦_fs_š™
() {

13808 
	g»t
 = 1;

13809 #ifdeà
__TI_COMPILER_VERSION__


13810 #ifdeà
MG_FS_SLFS


13811 #´agm¨
dŸg_push


13812 #´agm¨
dŸg_suµ»ss
 169

13814 
	g»t
 = (
add_deviû
("SL", 
_MSA
, 
fs_¦fs_İ’
, 
fs_¦fs_şo£
, 
fs_¦fs_»ad
,

13815 
fs_¦fs_wr™e
, 
fs_¦fs_l£ek
, 
fs_¦fs_uÆšk
,

13816 
fs_¦fs_»Çme
) == 0);

13817 #´agm¨
dŸg_pİ


13820  
	g»t
;

13825 
defšed
(
MG_FS_SPIFFS
)) */

13826 #ifdeà
MG_MODULE_LINES


13834 #ià
MG_NET_IF
 =ğ
MG_NET_IF_SIMPLELINK


13836 
	~<”ºo.h
>

13837 
	~<¡dio.h
>

13841 cÚ¡ *
š‘_Áİ
(
af
, cÚ¡ *
¤c
, *
d¡
, 
sockËn_t
 
size
) {

13842 
	g»s
;

13843 
š_addr
 *
	gš
 = (š_add¸*è
¤c
;

13844 ià(
	gaf
 !ğ
AF_INET
) {

13845 
”ºo
 = 
ENOTSUP
;

13846  
	gNULL
;

13848 
	g»s
 = 
¢´štf
(
d¡
, 
size
, "%lu.%lu.%lu.%lu", 
SL_IPV4_BYTE
(
š
->
s_addr
, 0),

13849 
SL_IPV4_BYTE
(
š
->
s_addr
, 1), SL_IPV4_BYTE(in->s_addr, 2),

13850 
SL_IPV4_BYTE
(
š
->
s_addr
, 3));

13851  
	g»s
 > 0 ? 
	gd¡
 : 
NULL
;

13854 *
š‘_Áß
(
š_addr
 
n
) {

13855 
	ga
[16];

13856  (*è
š‘_Áİ
(
AF_INET
, &
n
, 
a
, (a));

13859 
š‘_±Ú
(
af
, cÚ¡ *
¤c
, *
d¡
) {

13860 
ušt32_t
 
	ga0
, 
	ga1
, 
	ga2
, 
	ga3
;

13861 
ušt8_t
 *
	gdb
 = (ušt8_ˆ*è
d¡
;

13862 ià(
	gaf
 !ğ
AF_INET
) {

13863 
”ºo
 = 
ENOTSUP
;

13866 ià(
ssÿnf
(
¤c
, "%lu.%lu.%lu.%lu", &
a0
, &
a1
, &
a2
, &
a3
) != 4) {

13869 *
	gdb
 = 
a3
;

13870 *(
	gdb
 + 1èğ
a2
;

13871 *(
	gdb
 + 2èğ
a1
;

13872 *(
	gdb
 + 3èğ
a0
;

13877 #ifdeà
MG_MODULE_LINES


13880 #ià
MG_NET_IF
 =ğ
MG_NET_IF_SIMPLELINK
 && !
defšed
(
MG_SIMPLELINK_NO_OSI
)

13884 
	~<o¦ib/osi.h
>

13886 
	emg_q_msg_ty³
 {

13887 
	gMG_Q_MSG_CB
,

13889 
	smg_q_msg
 {

13890 
mg_q_msg_ty³
 
	gty³
;

13891 (*
	gcb
)(
mg_mgr
 *
	gmgr
, *
	g¬g
);

13892 *
	g¬g
;

13894 
OsiMsgQ_t
 
	gs_mg_q
;

13895 
mg_sk
(*
¬g
);

13897 
boŞ
 
mg_¡¬t_sk
(
´iÜ™y
, 
¡ack_size
, 
mg_š™_cb
 
mg_š™
) {

13898 ià(
osi_MsgQC»©e
(&
s_mg_q
, "MG", (
mg_q_msg
), 16è!ğ
OSI_OK
) {

13899  
çl£
;

13901 ià(
osi_TaskC»©e
(
mg_sk
, (cÚ¡ sigÃd *è"MG", 
¡ack_size
,

13902 (*è
mg_š™
, 
´iÜ™y
, 
NULL
è!ğ
OSI_OK
) {

13903  
çl£
;

13905  
	gŒue
;

13908 
mg_sk
(*
¬g
) {

13909 
mg_mgr
 
	gmgr
;

13910 
mg_š™_cb
 
	gmg_š™
 = (mg_š™_cbè
¬g
;

13911 
mg_mgr_š™
(&
mgr
, 
NULL
);

13912 
mg_š™
(&
mgr
);

13914 
mg_q_msg
 
	gmsg
;

13915 
mg_mgr_pŞl
(&
mgr
, 1);

13916 ià(
osi_MsgQR—d
(&
s_mg_q
, &
msg
, 1è!ğ
OSI_OK
) ;

13917 
	gmsg
.
	gty³
) {

13918 
	gMG_Q_MSG_CB
: {

13919 
msg
.
cb
(&
mgr
, msg.
¬g
);

13925 
mg_run_š_sk
((*
cb
)(
mg_mgr
 *
mgr
, *
¬g
), *
cb_¬g
) {

13926 
mg_q_msg
 
	gmsg
 = {
MG_Q_MSG_CB
, 
cb
, 
cb_¬g
};

13927 
osi_MsgQWr™e
(&
s_mg_q
, &
msg
, 
OSI_NO_WAIT
);

13932 #ifdeà
MG_MODULE_LINES


13940 #iâdeà
CS_COMMON_PLATFORMS_SIMPLELINK_SL_NET_IF_H_


13941 
	#CS_COMMON_PLATFORMS_SIMPLELINK_SL_NET_IF_H_


	)

13945 #ifdeà
__ılu¥lus


13949 #iâdeà
MG_ENABLE_NET_IF_SIMPLELINK


13950 
	#MG_ENABLE_NET_IF_SIMPLELINK
 
MG_NET_IF
 =ğ
MG_NET_IF_SIMPLELINK


	)

13953 cÚ¡ 
mg_içû_vbË
 
mg_sim¶–šk_içû_vbË
;

13955 #ifdeà
__ılu¥lus


13960 #ifdeà
MG_MODULE_LINES


13970 #ià
MG_ENABLE_NET_IF_SIMPLELINK


13975 
	#MG_TCP_RECV_BUFFER_SIZE
 1024

	)

13976 
	#MG_UDP_RECV_BUFFER_SIZE
 1500

	)

13978 
sock_t
 
mg_İ’_li¡’šg_sock‘
(
mg_cÚÃùiÚ
 *
nc
,

13979 
sock‘_add»ss
 *
§
, 
ty³
,

13980 
´Ùo
);

13982 
mg_£t_nÚ_blockšg_mode
(
sock_t
 
sock
) {

13983 
SlSockNÚblockšg_t
 
	gİt
;

13984 #ià
SL_MAJOR_VERSION_NUM
 < 2

13985 
	gİt
.
	gNÚblockšgEÇbËd
 = 1;

13987 
	gİt
.
	gNÚBlockšgEÇbËd
 = 1;

13989 
¦_S‘SockO±
(
sock
, 
SL_SOL_SOCKET
, 
SL_SO_NONBLOCKING
, &
İt
, (opt));

13992 
mg_is_”rÜ
(
n
) {

13993  (
	gn
 < 0 &&‚ !ğ
SL_ERROR_BSD_EALREADY
 && 
n
 !ğ
SL_ERROR_BSD_EAGAIN
);

13996 
mg_¦_if_cÚÃù_tı
(
mg_cÚÃùiÚ
 *
nc
,

13997 cÚ¡ 
sock‘_add»ss
 *
§
) {

13998 
	g´Ùo
 = 0;

13999 ià(
	gnc
->
	gæags
 & 
	gMG_F_SSL
è
	g´Ùo
 = 
SL_SEC_SOCKET
;

14000 
sock_t
 
	gsock
 = 
¦_Sock‘
(
AF_INET
, 
SOCK_STREAM
, 
´Ùo
);

14001 ià(
	gsock
 < 0) {

14002 
	gnc
->
	g”r
 = 
sock
;

14003 
	gout
;

14005 
mg_sock_£t
(
nc
, 
sock
);

14006 #ià
MG_ENABLE_SSL


14007 
	gnc
->
	g”r
 = 
¦_£t_s¦_İts
(
sock
, 
nc
);

14008 ià(
	gnc
->
	g”r
 !ğ0è
out
;

14010 
	gnc
->
	g”r
 = 
¦_CÚÃù
(
sock
, &
§
->§, (§->
sš
));

14011 
	gout
:

14012 
DBG
(("%°tØ%s:%d sock %d %dƒ¼ %d", 
nc
, 
š‘_Áß
(
§
->
sš
.
sš_addr
),

14013 
Áohs
(
§
->
sš
.
sš_pÜt
), 
nc
->
sock
, 
´Ùo
,‚c->
”r
));

14016 
mg_¦_if_cÚÃù_udp
(
mg_cÚÃùiÚ
 *
nc
) {

14017 
sock_t
 
	gsock
 = 
¦_Sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

14018 ià(
	gsock
 < 0) {

14019 
	gnc
->
	g”r
 = 
sock
;

14022 
mg_sock_£t
(
nc
, 
sock
);

14023 
	gnc
->
	g”r
 = 0;

14026 
mg_¦_if_li¡’_tı
(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
) {

14027 
	g´Ùo
 = 0;

14028 ià(
	gnc
->
	gæags
 & 
	gMG_F_SSL
è
	g´Ùo
 = 
SL_SEC_SOCKET
;

14029 
sock_t
 
	gsock
 = 
mg_İ’_li¡’šg_sock‘
(
nc
, 
§
, 
SOCK_STREAM
, 
´Ùo
);

14030 ià(
	gsock
 < 0)  sock;

14031 
mg_sock_£t
(
nc
, 
sock
);

14035 
mg_¦_if_li¡’_udp
(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
) {

14036 
sock_t
 
	gsock
 = 
mg_İ’_li¡’šg_sock‘
(
nc
, 
§
, 
SOCK_DGRAM
, 0);

14037 ià(
	gsock
 =ğ
INVALID_SOCKET
è (
”ºo
 ?ƒrrno : 1);

14038 
mg_sock_£t
(
nc
, 
sock
);

14042 
mg_¦_if_tı_£nd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

14043 
mbuf_­³nd
(&
nc
->
£nd_mbuf
, 
buf
, 
Ën
);

14046 
mg_¦_if_udp_£nd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

14047 
mbuf_­³nd
(&
nc
->
£nd_mbuf
, 
buf
, 
Ën
);

14050 
mg_¦_if_»cved
(
mg_cÚÃùiÚ
 *
nc
, 
size_t
 
Ën
) {

14051 (è
	gnc
;

14052 (è
	gËn
;

14055 
mg_¦_if_ü—‹_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

14056 (è
	gnc
;

14060 
mg_¦_if_de¡roy_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

14061 ià(
	gnc
->
	gsock
 =ğ
INVALID_SOCKET
) ;

14063 ià(!(
	gnc
->
	gæags
 & 
	gMG_F_UDP
è||‚c->
	gli¡’”
 =ğ
NULL
) {

14064 
¦_Clo£
(
nc
->
sock
);

14066 
	gnc
->
	gsock
 = 
INVALID_SOCKET
;

14069 
mg_acû±_cÚn
(
mg_cÚÃùiÚ
 *
lc
) {

14070 
mg_cÚÃùiÚ
 *
	gnc
;

14071 
sock‘_add»ss
 
	g§
;

14072 
sockËn_t
 
	g§_Ën
 = (
§
);

14073 
sock_t
 
	gsock
 = 
¦_Acû±
(
lc
->
sock
, &
§
.§, &
§_Ën
);

14074 ià(
	gsock
 < 0) {

14075 
DBG
(("%p: faedØacû±: %d", 
lc
, 
sock
));

14078 
	gnc
 = 
mg_if_acû±_Ãw_cÚn
(
lc
);

14079 ià(
	gnc
 =ğ
NULL
) {

14080 
¦_Clo£
(
sock
);

14083 
DBG
(("%°cÚÀäom %s:%d", 
nc
, 
š‘_Áß
(
§
.
sš
.
sš_addr
),

14084 
Áohs
(
§
.
sš
.
sš_pÜt
)));

14085 
mg_sock_£t
(
nc
, 
sock
);

14086 ià(
	gnc
->
	gæags
 & 
	gMG_F_SSL
ènc->æag |ğ
MG_F_SSL_HANDSHAKE_DONE
;

14087 
mg_if_acû±_tı_cb
(
nc
, &
§
, 
§_Ën
);

14092 
sock_t
 
mg_İ’_li¡’šg_sock‘
(
mg_cÚÃùiÚ
 *
nc
,

14093 
sock‘_add»ss
 *
§
, 
ty³
,

14094 
´Ùo
) {

14095 
	gr
;

14096 
sockËn_t
 
	g§_Ën
 =

14097 (
§
->§.
§_çmy
 =ğ
AF_INET
è? (§->
sš
è: (§->
sš6
);

14098 
sock_t
 
	gsock
 = 
¦_Sock‘
(
§
->§.
§_çmy
, 
ty³
, 
´Ùo
);

14099 ià(
	gsock
 < 0)  sock;

14100 ià((
	gr
 = 
¦_Bšd
(
sock
, &
§
->§, 
§_Ën
)è< 0è
	gş—n
;

14101 ià(
	gty³
 !ğ
SOCK_DGRAM
) {

14102 #ià
MG_ENABLE_SSL


14103 ià((
r
 = 
¦_£t_s¦_İts
(
sock
, 
nc
)è< 0è
	gş—n
;

14105 ià((
	gr
 = 
¦_Li¡’
(
sock
, 
SOMAXCONN
)è< 0è
	gş—n
;

14107 
mg_£t_nÚ_blockšg_mode
(
sock
);

14108 
	gş—n
:

14109 ià(
r
 < 0) {

14110 
¦_Clo£
(
sock
);

14111 
	gsock
 = 
r
;

14113  
	gsock
;

14116 
mg_wr™e_to_sock‘
(
mg_cÚÃùiÚ
 *
nc
) {

14117 
mbuf
 *
	gio
 = &
nc
->
£nd_mbuf
;

14118 
	gn
 = 0;

14120 ià(
	gnc
->
	gæags
 & 
	gMG_F_UDP
) {

14121 
	gn
 = 
¦_S’dTo
(
nc
->
sock
, 
io
->
buf
, io->
Ën
, 0, &nc->
§
.sa,

14122 (
nc
->
§
.
sš
));

14123 
DBG
(("%°%d %d %d %s:%hu", 
nc
,‚c->
sock
, 
n
, 
”ºo
,

14124 
š‘_Áß
(
nc
->
§
.
sš
.
sš_addr
), 
Áohs
Òc->§.sš.
sš_pÜt
)));

14126 
	gn
 = (è
¦_S’d
(
nc
->
sock
, 
io
->
buf
, io->
Ën
, 0);

14127 
DBG
(("%°%d by‹ -> %d", 
nc
, 
n
,‚c->
sock
));

14130 ià(
	gn
 > 0) {

14131 
mg_if_£Á_cb
(
nc
, 
n
);

14132 } ià(
	gn
 < 0 && 
mg_is_”rÜ
(
n
)) {

14134 
	gnc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

14138 
MG_INTERNAL
 
size_t
 
»cv_ava_size
(
mg_cÚÃùiÚ
 *
cÚn
, size_ˆ
max
) {

14139 
size_t
 
	gava
;

14140 ià(
	gcÚn
->
	g»cv_mbuf_lim™
 < cÚn->
	g»cv_mbuf
.
	gËn
)  0;

14141 
	gava
 = 
cÚn
->
»cv_mbuf_lim™
 - cÚn->
»cv_mbuf
.
Ën
;

14142  
	gava
 > 
	gmax
 ? max : 
ava
;

14145 
mg_hªdË_tı_»ad
(
mg_cÚÃùiÚ
 *
cÚn
) {

14146 
	gn
 = 0;

14147 *
	gbuf
 = (*è
MG_MALLOC
(
MG_TCP_RECV_BUFFER_SIZE
);

14149 ià(
	gbuf
 =ğ
NULL
) {

14150 
DBG
(("OOM"));

14154 
	gn
 = (è
¦_Recv
(
cÚn
->
sock
, 
buf
,

14155 
»cv_ava_size
(
cÚn
, 
MG_TCP_RECV_BUFFER_SIZE
), 0);

14156 
DBG
(("%°%d by‹ <- %d", 
cÚn
, 
n
, cÚn->
sock
));

14157 ià(
	gn
 > 0) {

14158 
mg_if_»cv_tı_cb
(
cÚn
, 
buf
, 
n
, 1 );

14160 
MG_FREE
(
buf
);

14162 ià(
	gn
 == 0) {

14164 
cÚn
->
æags
 |ğ
MG_F_SEND_AND_CLOSE
;

14165 } ià(
mg_is_”rÜ
(
n
)) {

14166 
	gcÚn
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

14170 
mg_hªdË_udp_»ad
(
mg_cÚÃùiÚ
 *
nc
) {

14171 *
	gbuf
 = (*è
MG_MALLOC
(
MG_UDP_RECV_BUFFER_SIZE
);

14172 ià(
	gbuf
 =ğ
NULL
) ;

14173 
sock‘_add»ss
 
	g§
;

14174 
sockËn_t
 
	g§_Ën
 = (
§
);

14175 
	gn
 = 
¦_RecvFrom
(
nc
->
sock
, 
buf
, 
MG_UDP_RECV_BUFFER_SIZE
, 0,

14176 (
SlSockAddr_t
 *è&
§
, &
§_Ën
);

14177 
DBG
(("%°%d by‹ äom %s:%d", 
nc
, 
n
, 
š‘_Áß
Òc->
§
.
sš
.
sš_addr
),

14178 
Áohs
(
nc
->
§
.
sš
.
sš_pÜt
)));

14179 ià(
	gn
 > 0) {

14180 
mg_if_»cv_udp_cb
(
nc
, 
buf
, 
n
, &
§
, 
§_Ën
);

14182 
MG_FREE
(
buf
);

14186 
	#_MG_F_FD_CAN_READ
 1

	)

14187 
	#_MG_F_FD_CAN_WRITE
 1 << 1

	)

14188 
	#_MG_F_FD_ERROR
 1 << 2

	)

14190 
mg_mgr_hªdË_cÚn
(
mg_cÚÃùiÚ
 *
nc
, 
fd_æags
, 
now
) {

14191 
DBG
(("%°fd=%d fd_æags=%d‚c_æags=%lu„mbl=%d smbl=%d", 
nc
,‚c->
sock
,

14192 
fd_æags
, 
nc
->
æags
, (ènc->
»cv_mbuf
.
Ën
, (ènc->
£nd_mbuf
.len));

14194 ià(
	gnc
->
	gæags
 & 
	gMG_F_CONNECTING
) {

14195 ià(
	gnc
->
	gæags
 & 
	gMG_F_UDP
 ||‚c->
	g”r
 !ğ
SL_ERROR_BSD_EALREADY
) {

14196 
mg_if_cÚÃù_cb
(
nc
,‚c->
”r
);

14201 ià(
	gfd_æags
 & 
	g_MG_F_FD_CAN_WRITE
) {

14202 
	gnc
->
	g”r
 = 
¦_CÚÃù
(
nc
->
sock
, &nc->
§
.§, Òc->§.
sš
));

14203 
DBG
(("%°cÚÀ»s=%d", 
nc
,‚c->
”r
));

14204 ià(
	gnc
->
	g”r
 =ğ
SL_ERROR_BSD_ESECSNOVERIFY
 ||

14206 
nc
->
”r
 =ğ
SL_ERROR_BSD_ESECDATEERROR


14207 #ià
SL_MAJOR_VERSION_NUM
 >= 2

14212 
nc
->
”r
 =ğ
SL_ERROR_BSD_ESECUNKNOWNROOTCA


14215 
nc
->
”r
 = 0;

14217 ià(
	gnc
->
	gæags
 & 
	gMG_F_SSL
 &&‚c->
	g”r
 == 0) {

14218 
nc
->
æags
 |ğ
MG_F_SSL_HANDSHAKE_DONE
;

14220 
mg_if_cÚÃù_cb
(
nc
,‚c->
”r
);

14224 
	gfd_æags
 &ğ~(
_MG_F_FD_CAN_READ
 | 
_MG_F_FD_CAN_WRITE
);

14227 ià(
	gfd_æags
 & 
	g_MG_F_FD_CAN_READ
) {

14228 ià(
	gnc
->
	gæags
 & 
	gMG_F_UDP
) {

14229 
mg_hªdË_udp_»ad
(
nc
);

14231 ià(
	gnc
->
	gæags
 & 
	gMG_F_LISTENING
) {

14232 
mg_acû±_cÚn
(
nc
);

14234 
mg_hªdË_tı_»ad
(
nc
);

14239 ià(!(
	gnc
->
	gæags
 & 
	gMG_F_CLOSE_IMMEDIATELY
)) {

14240 ià((
	gfd_æags
 & 
	g_MG_F_FD_CAN_WRITE
è&& 
	gnc
->
	g£nd_mbuf
.
	gËn
 > 0) {

14241 
mg_wr™e_to_sock‘
(
nc
);

14244 ià(!(
	gfd_æags
 & (
	g_MG_F_FD_CAN_READ
 | 
	g_MG_F_FD_CAN_WRITE
))) {

14245 
mg_if_pŞl
(
nc
, 
now
);

14247 
mg_if_tim”
(
nc
, 
now
);

14250 
DBG
(("%°aá” fd=%d‚c_æags=%lu„mbl=%d smbl=%d", 
nc
,‚c->
sock
,‚c->
æags
,

14251 (è
nc
->
»cv_mbuf
.
Ën
, (ènc->
£nd_mbuf
.len));

14255 
mg_¦_if_sock_£t
(
mg_cÚÃùiÚ
 *
nc
, 
sock_t
 
sock
) {

14256 
mg_£t_nÚ_blockšg_mode
(
sock
);

14257 
	gnc
->
	gsock
 = 
sock
;

14258 
DBG
(("%°%d", 
nc
, 
sock
));

14261 
mg_¦_if_š™
(
mg_içû
 *
içû
) {

14262 (è
	giçû
;

14263 
DBG
(("%°usšg sl_S–eù()", 
içû
->
mgr
));

14266 
mg_¦_if_ä“
(
mg_içû
 *
içû
) {

14267 (è
	giçû
;

14270 
mg_¦_if_add_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

14271 (è
	gnc
;

14274 
mg_¦_if_»move_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

14275 (è
	gnc
;

14278 
time_t
 
mg_¦_if_pŞl
(
mg_içû
 *
içû
, 
timeout_ms
) {

14279 
mg_mgr
 *
	gmgr
 = 
içû
->
mgr
;

14280 
	gnow
 = 
mg_time
();

14281 
	gmš_tim”
;

14282 
mg_cÚÃùiÚ
 *
	gnc
, *
	gtmp
;

14283 
SlTimev®_t
 
	gtv
;

14284 
SlFdS‘_t
 
	g»ad_£t
, 
	gwr™e_£t
, 
	g”r_£t
;

14285 
sock_t
 
	gmax_fd
 = 
INVALID_SOCKET
;

14286 
	gnum_fds
, 
	gnum_ev
 = 0, 
	gnum_tim”s
 = 0;

14288 
SL_SOCKET_FD_ZERO
(&
»ad_£t
);

14289 
SL_SOCKET_FD_ZERO
(&
wr™e_£t
);

14290 
SL_SOCKET_FD_ZERO
(&
”r_£t
);

14296 
	gmš_tim”
 = 0;

14297 
	gnc
 = 
mgr
->
aùive_cÚÃùiÚs
, 
	gnum_fds
 = 0;‚ø!ğ
NULL
;‚øğ
tmp
) {

14298 
tmp
 = 
nc
->
Ãxt
;

14300 ià(
	gnc
->
	gsock
 !ğ
INVALID_SOCKET
) {

14301 
num_fds
++;

14303 ià(!(
	gnc
->
	gæags
 & 
	gMG_F_WANT_WRITE
) &&

14304 
	gnc
->
	g»cv_mbuf
.
	gËn
 <‚c->
	g»cv_mbuf_lim™
 &&

14305 (!(
	gnc
->
	gæags
 & 
	gMG_F_UDP
è||‚c->
	gli¡’”
 =ğ
NULL
)) {

14306 
SL_SOCKET_FD_SET
(
nc
->
sock
, &
»ad_£t
);

14307 ià(
	gmax_fd
 =ğ
INVALID_SOCKET
 || 
nc
->
sock
 > 
max_fd
) max_fd =‚c->sock;

14310 ià(((
	gnc
->
	gæags
 & 
	gMG_F_CONNECTING
è&& !Òc->æag & 
	gMG_F_WANT_READ
)) ||

14311 (
	gnc
->
	g£nd_mbuf
.
	gËn
 > 0 && !Òc->
	gæags
 & 
	gMG_F_CONNECTING
))) {

14312 
SL_SOCKET_FD_SET
(
nc
->
sock
, &
wr™e_£t
);

14313 
SL_SOCKET_FD_SET
(
nc
->
sock
, &
”r_£t
);

14314 ià(
	gmax_fd
 =ğ
INVALID_SOCKET
 || 
nc
->
sock
 > 
max_fd
) max_fd =‚c->sock;

14318 ià(
	gnc
->
	gev_tim”_time
 > 0) {

14319 ià(
	gnum_tim”s
 =ğ0 || 
nc
->
ev_tim”_time
 < 
mš_tim”
) {

14320 
mš_tim”
 = 
nc
->
ev_tim”_time
;

14322 
	gnum_tim”s
++;

14330 ià(
	gnum_tim”s
 > 0) {

14331 
	gtim”_timeout_ms
 = (
mš_tim”
 - 
mg_time
()) * 1000 + 1 ;

14332 ià(
	gtim”_timeout_ms
 < 
	gtimeout_ms
) {

14333 
	gtimeout_ms
 = 
tim”_timeout_ms
;

14336 ià(
	gtimeout_ms
 < 0)imeout_ms = 0;

14338 
	gtv
.
	gtv_£c
 = 
timeout_ms
 / 1000;

14339 
	gtv
.
	gtv_u£c
 = (
timeout_ms
 % 1000) * 1000;

14341 ià(
	gnum_fds
 > 0) {

14342 
	gnum_ev
 = 
¦_S–eù
((è
max_fd
 + 1, &
»ad_£t
, &
wr™e_£t
, &
”r_£t
, &
tv
);

14345 
	gnow
 = 
mg_time
();

14346 
DBG
(("¦_S–eù @ %ld‚um_ev=%d oà%d,imeout=%d", (è
now
, 
num_ev
,

14347 
num_fds
, 
timeout_ms
));

14349 
	gnc
 = 
mgr
->
aùive_cÚÃùiÚs
;‚ø!ğ
NULL
;‚øğ
tmp
) {

14350 
fd_æags
 = 0;

14351 ià(
	gnc
->
	gsock
 !ğ
INVALID_SOCKET
) {

14352 ià(
num_ev
 > 0) {

14353 
fd_æags
 =

14354 (
SL_SOCKET_FD_ISSET
(
nc
->
sock
, &
»ad_£t
) &&

14355 (!(
	gnc
->
	gæags
 & 
	gMG_F_UDP
è||‚c->
	gli¡’”
 =ğ
NULL
)

14356 ? 
_MG_F_FD_CAN_READ


14358 (
SL_SOCKET_FD_ISSET
(
nc
->
sock
, &
wr™e_£t
è? 
	g_MG_F_FD_CAN_WRITE


14360 (
SL_SOCKET_FD_ISSET
(
nc
->
sock
, &
”r_£t
è? 
	g_MG_F_FD_ERROR
 : 0);

14363 ià(
	gnc
->
	gæags
 & 
	gMG_F_UDP
 &&‚c->
	g£nd_mbuf
.
	gËn
 > 0) {

14364 
	gfd_æags
 |ğ
_MG_F_FD_CAN_WRITE
;

14367 
	gtmp
 = 
nc
->
Ãxt
;

14368 
mg_mgr_hªdË_cÚn
(
nc
, 
fd_æags
, 
now
);

14371 
	gnc
 = 
mgr
->
aùive_cÚÃùiÚs
;‚ø!ğ
NULL
;‚øğ
tmp
) {

14372 
tmp
 = 
nc
->
Ãxt
;

14373 ià((
	gnc
->
	gæags
 & 
	gMG_F_CLOSE_IMMEDIATELY
) ||

14374 (
	gnc
->
	g£nd_mbuf
.
	gËn
 =ğ0 && (
nc
->
æags
 & 
MG_F_SEND_AND_CLOSE
))) {

14375 
mg_şo£_cÚn
(
nc
);

14379  
	gnow
;

14382 
mg_¦_if_g‘_cÚn_addr
(
mg_cÚÃùiÚ
 *
nc
, 
»mÙe
,

14383 
sock‘_add»ss
 *
§
) {

14387 ià(
	g»mÙe
è
memıy
(
§
, &
nc
->sa, (*sa));

14390 
¦_»¡¬t_cb
(
mg_mgr
 *
mgr
) {

14396 
mg_cÚÃùiÚ
 *
	gnc
;

14397 
	gnc
 = 
mg_Ãxt
(
mgr
, 
NULL
);‚ø!ğNULL;‚øğmg_Ãxt(mgr, 
nc
)) {

14398 ià(
	gnc
->
	gsock
 =ğ
INVALID_SOCKET
) ;

14399 ià(
	gnc
->
	gæags
 & 
	gMG_F_LISTENING
) {

14400 
DBG
(("»¡¬tšg %°%s:%d", 
nc
, 
š‘_Áß
Òc->
§
.
sš
.
sš_addr
),

14401 
Áohs
(
nc
->
§
.
sš
.
sš_pÜt
)));

14402 
	g»s
 = (
nc
->
æags
 & 
MG_F_UDP
 ? 
mg_¦_if_li¡’_udp
Òc, &nc->
§
)

14403 : 
mg_¦_if_li¡’_tı
(
nc
, &nc->
§
));

14404 ià(
	g»s
 == 0) ;

14407 
	gnc
->
	gsock
 = 
INVALID_SOCKET
;

14408 
DBG
(("‹rmš©šg %°%s:%d", 
nc
, 
š‘_Áß
Òc->
§
.
sš
.
sš_addr
),

14409 
Áohs
(
nc
->
§
.
sš
.
sš_pÜt
)));

14411 
	gnc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

14416 
	#MG_SL_IFACE_VTABLE
 \

14418 
mg_¦_if_š™
, \

14419 
mg_¦_if_ä“
, \

14420 
mg_¦_if_add_cÚn
, \

14421 
mg_¦_if_»move_cÚn
, \

14422 
mg_¦_if_pŞl
, \

14423 
mg_¦_if_li¡’_tı
, \

14424 
mg_¦_if_li¡’_udp
, \

14425 
mg_¦_if_cÚÃù_tı
, \

14426 
mg_¦_if_cÚÃù_udp
, \

14427 
mg_¦_if_tı_£nd
, \

14428 
mg_¦_if_udp_£nd
, \

14429 
mg_¦_if_»cved
, \

14430 
mg_¦_if_ü—‹_cÚn
, \

14431 
mg_¦_if_de¡roy_cÚn
, \

14432 
mg_¦_if_sock_£t
, \

14433 
mg_¦_if_g‘_cÚn_addr
, \

14434 }

	)

14437 cÚ¡ 
mg_içû_vbË
 
	gmg_sim¶–šk_içû_vbË
 = 
MG_SL_IFACE_VTABLE
;

14438 #ià
MG_NET_IF
 =ğ
MG_NET_IF_SIMPLELINK


14439 cÚ¡ 
mg_içû_vbË
 
	gmg_deçuÉ_içû_vbË
 = 
MG_SL_IFACE_VTABLE
;

14443 #ifdeà
MG_MODULE_LINES


14451 #ià
MG_ENABLE_SSL
 && 
MG_SSL_IF
 =ğ
MG_SSL_IF_SIMPLELINK


14455 #iâdeà
MG_SSL_IF_SIMPLELINK_SLFS_PREFIX


14456 
	#MG_SSL_IF_SIMPLELINK_SLFS_PREFIX
 "SL:"

	)

14459 
	#MG_SSL_IF_SIMPLELINK_SLFS_PREFIX_LEN
 \

14460 ((
MG_SSL_IF_SIMPLELINK_SLFS_PREFIX
è- 1)

	)

14462 
	smg_s¦_if_ùx
 {

14463 *
	gs¦_û¹
;

14464 *
	gs¦_key
;

14465 *
	gs¦_ÿ_û¹
;

14466 *
	gs¦_£rv”_Çme
;

14469 
mg_s¦_if_š™
() {

14472 
mg_s¦_if_»suÉ
 
mg_s¦_if_cÚn_š™
(

14473 
mg_cÚÃùiÚ
 *
nc
, cÚ¡ 
mg_s¦_if_cÚn_·¿ms
 *
·¿ms
,

14474 cÚ¡ **
”r_msg
) {

14475 
mg_s¦_if_ùx
 *
	gùx
 =

14476 (
mg_s¦_if_ùx
 *è
MG_CALLOC
(1, (*
ùx
));

14477 ià(
	gùx
 =ğ
NULL
) {

14478 
MG_SET_PTRPTR
(
”r_msg
, "Out of memory");

14479  
	gMG_SSL_ERROR
;

14481 
	gnc
->
	gs¦_if_d©a
 = 
ùx
;

14483 ià(
	g·¿ms
->
	gû¹
 !ğ
NULL
 || 
·¿ms
->
key
 != NULL) {

14484 ià(
·¿ms
->
û¹
 !ğ
NULL
 &&…¬ams->
key
 != NULL) {

14485 
ùx
->
s¦_û¹
 = 
¡rdup
(
·¿ms
->
û¹
);

14486 
	gùx
->
	gs¦_key
 = 
¡rdup
(
·¿ms
->
key
);

14488 
MG_SET_PTRPTR
(
”r_msg
, "Both cert‡nd key‡re„equired.");

14489  
	gMG_SSL_ERROR
;

14492 ià(
	g·¿ms
->
	gÿ_û¹
 !ğ
NULL
 && 
¡rcmp
(
·¿ms
->
ÿ_û¹
, "*") != 0) {

14493 
ùx
->
s¦_ÿ_û¹
 = 
¡rdup
(
·¿ms
->
ÿ_û¹
);

14496 ià(
	g·¿ms
->
	g£rv”_Çme
 !ğ
NULL
) {

14497 
ùx
->
s¦_£rv”_Çme
 = 
¡rdup
(
·¿ms
->
£rv”_Çme
);

14499  
	gMG_SSL_OK
;

14502 
mg_s¦_if_cÚn_şo£_nÙify
(
mg_cÚÃùiÚ
 *
nc
) {

14504 (è
	gnc
;

14507 
mg_s¦_if_cÚn_ä“
(
mg_cÚÃùiÚ
 *
nc
) {

14508 
mg_s¦_if_ùx
 *
	gùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

14509 ià(
	gùx
 =ğ
NULL
) ;

14510 
	gnc
->
	gs¦_if_d©a
 = 
NULL
;

14511 
MG_FREE
(
ùx
->
s¦_û¹
);

14512 
MG_FREE
(
ùx
->
s¦_key
);

14513 
MG_FREE
(
ùx
->
s¦_ÿ_û¹
);

14514 
MG_FREE
(
ùx
->
s¦_£rv”_Çme
);

14515 
mem£t
(
ùx
, 0, (*ctx));

14516 
MG_FREE
(
ùx
);

14519 
boŞ
 
³m_to_d”
(cÚ¡ *
³m_fe
, cÚ¡ *
d”_fe
) {

14520 
boŞ
 
	g»t
 = 
çl£
;

14521 
FILE
 *
	gpf
 = 
NULL
, *
	gdf
 = NULL;

14522 
boŞ
 
	gwr™šg
 = 
çl£
;

14523 
	gpf
 = 
fİ’
(
³m_fe
, "r");

14524 ià(
	gpf
 =ğ
NULL
è
ş—n
;

14525 
»move
(
d”_fe
);

14526 
fs_¦fs_£t_Ãw_fe_size
(
d”_fe
 + 
MG_SSL_IF_SIMPLELINK_SLFS_PREFIX_LEN
,

14528 
	gdf
 = 
fİ’
(
d”_fe
, "w");

14529 ià(
	gdf
 =ğ
NULL
è
ş—n
;

14531 
	g³m_buf
[70];

14532 
	gd”_buf
[48];

14533 ià(!
fg‘s
(
³m_buf
, Õem_buf), 
pf
)) ;

14534 ià(
	gwr™šg
) {

14535 ià(
¡r¡r
(
³m_buf
, "-----END "è!ğ
NULL
) {

14536 
»t
 = 
Œue
;

14539 
	gl
 = 0;

14540 !
is¥aû
((è
³m_buf
[
l
])è
	gl
++;

14541 
	gd”_Ën
 = 0;

14542 
cs_ba£64_decode
((cÚ¡ *è
³m_buf
, (pem_buf),

14543 
d”_buf
, &
d”_Ën
);

14544 ià(
	gd”_Ën
 <= 0) ;

14545 ià(
fwr™e
(
d”_buf
, 1, 
d”_Ën
, 
df
) != der_len) ;

14546 } ià(
¡r¡r
(
³m_buf
, "-----BEGIN "è!ğ
NULL
) {

14547 
wr™šg
 = 
Œue
;

14551 
	gş—n
:

14552 ià(
pf
 !ğ
NULL
è
fşo£
(pf);

14553 ià(
	gdf
 !ğ
NULL
) {

14554 
fşo£
(
df
);

14555 ià(!
	g»t
è
»move
(
d”_fe
);

14557  
	g»t
;

14560 #ià
MG_ENABLE_FILESYSTEM
 && 
defšed
(
MG_FS_SLFS
)

14562 *
¦_³m2d”
(cÚ¡ *
³m_fe
) {

14563 cÚ¡ *
	g³m_ext
 = 
¡r¡r
(
³m_fe
, ".pem");

14564 ià(
	g³m_ext
 =ğ
NULL
 || *(
³m_ext
 + 4) != '\0') {

14565  
¡rdup
(
³m_fe
);

14567 *
	gd”_fe
 = 
NULL
;

14569 
	gl
 = 
mg_a¥rštf
(&
d”_fe
, 0, 
MG_SSL_IF_SIMPLELINK_SLFS_PREFIX
 "%.*s.der",

14570 (è(
³m_ext
 - 
³m_fe
),…em_file);

14571 ià(
	gd”_fe
 =ğ
NULL
)  NULL;

14572 
boŞ
 
	g»suÉ
 = 
çl£
;

14573 
cs_¡©_t
 
	g¡
;

14574 ià(
mg_¡©
(
d”_fe
, &
¡
) != 0) {

14575 
»suÉ
 = 
³m_to_d”
(
³m_fe
, 
d”_fe
);

14576 
LOG
(
LL_DEBUG
, ("% -> % ğ%d", 
³m_fe
, 
d”_fe
, 
»suÉ
));

14579 
	g»suÉ
 = 
Œue
;

14581 ià(
	g»suÉ
) {

14583 
memmove
(
d”_fe
, d”_f+ 
MG_SSL_IF_SIMPLELINK_SLFS_PREFIX_LEN
,

14584 
l
 - 2 );

14586 
MG_FREE
(
d”_fe
);

14587 
	gd”_fe
 = 
NULL
;

14589  
	gd”_fe
;

14592 *
¦_³m2d”
(cÚ¡ *
³m_fe
) {

14593  
¡rdup
(
³m_fe
);

14597 
¦_£t_s¦_İts
(
sock
, 
mg_cÚÃùiÚ
 *
nc
) {

14598 
	g”r
;

14599 cÚ¡ 
mg_s¦_if_ùx
 *
	gùx
 = (mg_s¦_if_ùx *è
nc
->
s¦_if_d©a
;

14600 
DBG
(("%°s¦ ctx: %p", 
nc
, 
ùx
));

14602 ià(
	gùx
 !ğ
NULL
) {

14603 
DBG
(("%°%s,%s,%s,%s", 
nc
, (
ùx
->
s¦_û¹
 ? ctx->ssl_cert : "-"),

14604 (
ùx
->
s¦_key
 ? ctx->
s¦_û¹
 : "-"),

14605 (
ùx
->
s¦_ÿ_û¹
 ? ctx->ssl_ca_cert : "-"),

14606 (
ùx
->
s¦_£rv”_Çme
 ? ctx->ssl_server_name : "-")));

14607 ià(
	gùx
->
	gs¦_û¹
 !ğ
NULL
 && 
ùx
->
s¦_key
 != NULL) {

14608 *
s¦_û¹
 = 
¦_³m2d”
(
ùx
->ssl_cert);

14609 *
	gs¦_key
 = 
¦_³m2d”
(
ùx
->
s¦_key
);

14610 ià(
	gs¦_û¹
 !ğ
NULL
 && 
s¦_key
 != NULL) {

14611 
”r
 = 
¦_S‘SockO±
(
sock
, 
SL_SOL_SOCKET
,

14612 
SL_SO_SECURE_FILES_CERTIFICATE_FILE_NAME
, 
s¦_û¹
,

14613 
¡¾’
(
s¦_û¹
));

14614 
LOG
(
LL_INFO
, ("CERTIFICATE_FILE_NAME % -> %d", 
s¦_û¹
, 
”r
));

14615 
	g”r
 = 
¦_S‘SockO±
(
sock
, 
SL_SOL_SOCKET
,

14616 
SL_SO_SECURE_FILES_PRIVATE_KEY_FILE_NAME
, 
s¦_key
,

14617 
¡¾’
(
s¦_key
));

14618 
LOG
(
LL_INFO
, ("PRIVATE_KEY_FILE_NAME % -> %d", 
s¦_key
, 
”r
));

14620 
	g”r
 = -1;

14622 
MG_FREE
(
s¦_û¹
);

14623 
MG_FREE
(
s¦_key
);

14624 ià(
	g”r
 !ğ0è 
”r
;

14626 ià(
	gùx
->
	gs¦_ÿ_û¹
 !ğ
NULL
) {

14627 ià(
ùx
->
s¦_ÿ_û¹
[0] != '\0') {

14628 *
s¦_ÿ_û¹
 = 
¦_³m2d”
(
ùx
->ssl_ca_cert);

14629 ià(
	gs¦_ÿ_û¹
 !ğ
NULL
) {

14630 
”r
 = 
¦_S‘SockO±
(
sock
, 
SL_SOL_SOCKET
,

14631 
SL_SO_SECURE_FILES_CA_FILE_NAME
, 
s¦_ÿ_û¹
,

14632 
¡¾’
(
s¦_ÿ_û¹
));

14633 
LOG
(
LL_INFO
, ("CA_FILE_NAME % -> %d", 
s¦_ÿ_û¹
, 
”r
));

14635 
	g”r
 = -1;

14637 
MG_FREE
(
s¦_ÿ_û¹
);

14638 ià(
	g”r
 !ğ0è 
”r
;

14641 ià(
	gùx
->
	gs¦_£rv”_Çme
 !ğ
NULL
) {

14642 
”r
 = 
¦_S‘SockO±
(
sock
, 
SL_SOL_SOCKET
,

14643 
SL_SO_SECURE_DOMAIN_NAME_VERIFICATION
,

14644 
ùx
->
s¦_£rv”_Çme
, 
¡¾’
(ctx->ssl_server_name));

14645 
DBG
(("DOMAIN_NAME_VERIFICATION % -> %d", 
ùx
->
s¦_£rv”_Çme
, 
”r
));

14650 ià(
	g”r
 !ğ0 && 
”r
 !ğ
SL_ERROR_BSD_ENOPROTOOPT
) ƒrr;

14657 #ifdeà
MG_MODULE_LINES


14665 #iâdeà
CS_COMMON_PLATFORMS_LWIP_MG_NET_IF_LWIP_H_


14666 
	#CS_COMMON_PLATFORMS_LWIP_MG_NET_IF_LWIP_H_


	)

14668 #iâdeà
MG_ENABLE_NET_IF_LWIP_LOW_LEVEL


14669 
	#MG_ENABLE_NET_IF_LWIP_LOW_LEVEL
 
MG_NET_IF
 =ğ
MG_NET_IF_LWIP_LOW_LEVEL


	)

14672 #ià
MG_ENABLE_NET_IF_LWIP_LOW_LEVEL


14674 
	~<¡dšt.h
>

14676 cÚ¡ 
mg_içû_vbË
 
mg_lw_içû_vbË
;

14678 
	smg_lw_cÚn_¡©e
 {

14679 
mg_cÚÃùiÚ
 *
	gnc
;

14680 
mg_cÚÃùiÚ
 *
	glc
;

14682 
tı_pcb
 *
	gtı
;

14683 
udp_pcb
 *
	gudp
;

14684 } 
	gpcb
;

14685 
”r_t
 
	g”r
;

14686 
size_t
 
	gnum_£Á
;

14687 
pbuf
 *
	grx_chaš
;

14688 
size_t
 
	grx_off£t
;

14690 
	gÏ¡_s¦_wr™e_size
;

14692 
	g»cv_³ndšg
;

14695 
	emg_sig_ty³
 {

14696 
	gMG_SIG_CONNECT_RESULT
 = 1,

14697 
	gMG_SIG_RECV
 = 2,

14698 
	gMG_SIG_CLOSE_CONN
 = 3,

14699 
	gMG_SIG_TOMBSTONE
 = 4,

14700 
	gMG_SIG_ACCEPT
 = 5,

14703 
mg_lw_po¡_sigÇl
(
mg_sig_ty³
 
sig
, 
mg_cÚÃùiÚ
 *
nc
);

14706 
mg_lw_mgr_scheduË_pŞl
(
mg_mgr
 *
mgr
);

14711 #ifdeà
MG_MODULE_LINES


14719 #ià
MG_ENABLE_NET_IF_LWIP_LOW_LEVEL


14723 
	~<lw/š™.h
>

14724 
	~<lw/pbuf.h
>

14725 
	~<lw/tı.h
>

14726 
	~<lw/tı.h
>

14727 #ià
LWIP_VERSION
 >= 0x01050000

14728 
	~<lw/´iv/tı_´iv.h
>

14730 
	~<lw/tı_im¶.h
>

14732 
	~<lw/udp.h
>

14740 #iâdeà
_2_4


14741 #ifdeà
X_2_


14742 
	#_2_4
(
addr
è
	`X_2_
×ddr)

	)

14744 
	#_2_4
(
addr
è×ddr)

	)

14752 #ià
MG_ENABLE_IPV6


14753 
	#TCP_NEW
 
tı_Ãw_6


	)

14754 
	#TCP_BIND
 
tı_bšd_6


	)

14755 
	#UDP_BIND
 
udp_bšd_6


	)

14756 
	#IPADDR_NTOA
(
x
è
	`6addr_Áß
((cÚ¡ 
6_addr_t
 *)(x))

	)

14757 
	#SET_ADDR
(
d¡
, 
¤c
) \

14758 
	`memıy
((
d¡
)->
sš6
.
sš6_addr
.
s6_addr
, (
¤c
)->
6
.
addr
, \

14759 ((
d¡
)->
sš6
.
sš6_addr
.
s6_addr
))

	)

14761 
	#TCP_NEW
 
tı_Ãw


	)

14762 
	#TCP_BIND
 
tı_bšd


	)

14763 
	#UDP_BIND
 
udp_bšd


	)

14764 
	#IPADDR_NTOA
 
addr_Áß


	)

14765 
	#SET_ADDR
(
d¡
, 
¤c
è(d¡)->
sš
.
sš_addr
.
s_addr
 = 
	`_2_4
(¤c)->
addr


	)

14768 #ià
NO_SYS


14769 
	#tı_ÿÎback
(
â
, 
¬g
è(â)×rg)

	)

14770 (*
	gtı_ÿÎback_â
)(*
	t¬g
);

14773 
mg_lw_s¦_do_hs
(
mg_cÚÃùiÚ
 *
nc
);

14774 
mg_lw_s¦_£nd
(
mg_cÚÃùiÚ
 *
nc
);

14775 
mg_lw_s¦_»cv
(
mg_cÚÃùiÚ
 *
nc
);

14777 
mg_lw_if_š™
(
mg_içû
 *
içû
);

14778 
mg_lw_if_ä“
(
mg_içû
 *
içû
);

14779 
mg_lw_if_add_cÚn
(
mg_cÚÃùiÚ
 *
nc
);

14780 
mg_lw_if_»move_cÚn
(
mg_cÚÃùiÚ
 *
nc
);

14781 
time_t
 
mg_lw_if_pŞl
(
mg_içû
 *
içû
, 
timeout_ms
);

14783 #ià
defšed
(
RTOS_SDK
è|| defšed(
ESP_PLATFORM
)

14784 
mgos_lock
();

14785 
mgos_uÆock
();

14787 
	#mgos_lock
()

	)

14788 
	#mgos_uÆock
()

	)

14791 
mg_lw_»cv_commÚ
(
mg_cÚÃùiÚ
 *
nc
, 
pbuf
 *
p
);

14793 #ià
LWIP_TCP_KEEPALIVE


14794 
mg_lw_£t_k“·live_·¿ms
(
mg_cÚÃùiÚ
 *
nc
, 
idË
,

14795 
š‹rv®
, 
couÁ
) {

14796 ià(
	gnc
->
	gsock
 =ğ
INVALID_SOCKET
 || 
nc
->
æags
 & 
MG_F_UDP
) {

14799 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14800 
tı_pcb
 *
	gcb
 = 
cs
->
pcb
.
tı
;

14801 ià(
	gidË
 > 0 && 
	gš‹rv®
 > 0 && 
	gcouÁ
 > 0) {

14802 
	gcb
->
	gk“p_idË
 = 
idË
 * 1000;

14803 
	gcb
->
	gk“p_štvl
 = 
š‹rv®
 * 1000;

14804 
	gcb
->
	gk“p_út
 = 
couÁ
;

14805 
	gcb
->
	gso_İtiÚs
 |ğ
SOF_KEEPALIVE
;

14807 
	gcb
->
	gso_İtiÚs
 &ğ~
SOF_KEEPALIVE
;

14810 #–ià!
defšed
(
MG_NO_LWIP_TCP_KEEPALIVE
)

14811 #w¬nšg 
LWIP
 
TCP
 
k“·live
 
is
 
di§bËd
. 
PËa£
 
cÚsid”
 
’ablšg
 
™
.

14814 
”r_t
 
mg_lw_tı_cÚn_cb
(*
¬g
, 
tı_pcb
 *
cb
,ƒ¼_ˆ
”r
) {

14815 
mg_cÚÃùiÚ
 *
	gnc
 = (mg_cÚÃùiÚ *è
¬g
;

14816 
DBG
(("%°cÚÃùØ%s:%u = %d", 
nc
, 
IPADDR_NTOA
(
X_2_
(&
cb
->
»mÙe_
)),

14817 
cb
->
»mÙe_pÜt
, 
”r
));

14818 ià(
	gnc
 =ğ
NULL
) {

14819 
tı_abÜt
(
cb
);

14820  
	gERR_ARG
;

14822 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14823 
	gcs
->
	g”r
 = 
”r
;

14824 #ià
LWIP_TCP_KEEPALIVE


14825 ià(
	g”r
 =ğ0è
mg_lw_£t_k“·live_·¿ms
(
nc
, 60, 10, 6);

14827 
mg_lw_po¡_sigÇl
(
MG_SIG_CONNECT_RESULT
, 
nc
);

14828  
	gERR_OK
;

14831 
mg_lw_tı_”rÜ_cb
(*
¬g
, 
”r_t
 
”r
) {

14832 
mg_cÚÃùiÚ
 *
	gnc
 = (mg_cÚÃùiÚ *è
¬g
;

14833 
DBG
(("%°cÚÀ”rÜ %d", 
nc
, 
”r
));

14834 ià(
	gnc
 =ğ
NULL
) ;

14835 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14836 
	gcs
->
	gpcb
.
	gtı
 = 
NULL
;

14837 ià(
	gnc
->
	gæags
 & 
	gMG_F_CONNECTING
) {

14838 
	gcs
->
	g”r
 = 
”r
;

14839 
mg_lw_po¡_sigÇl
(
MG_SIG_CONNECT_RESULT
, 
nc
);

14841 
mg_lw_po¡_sigÇl
(
MG_SIG_CLOSE_CONN
, 
nc
);

14845 
”r_t
 
mg_lw_tı_»cv_cb
(*
¬g
, 
tı_pcb
 *
cb
,

14846 
pbuf
 *
p
, 
”r_t
 
”r
) {

14847 
mg_cÚÃùiÚ
 *
	gnc
 = (mg_cÚÃùiÚ *è
¬g
;

14848 
DBG
(("%°%°%u %d", 
nc
, 
cb
, (
p
 !ğ
NULL
 ?…->
tÙ_Ën
 : 0), 
”r
));

14849 ià(
	gp
 =ğ
NULL
) {

14850 ià(
nc
 !ğ
NULL
 && !Òc->
æags
 & 
MG_F_CLOSE_IMMEDIATELY
)) {

14851 
mg_lw_po¡_sigÇl
(
MG_SIG_CLOSE_CONN
, 
nc
);

14855  
	gERR_OK
;

14856 } ià(
	gnc
 =ğ
NULL
) {

14857 
tı_abÜt
(
cb
);

14858  
	gERR_ARG
;

14860 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14865 ià(
	gp
->
	gÃxt
 !ğ
NULL
) {

14866 
pbuf
 *
q
 = 
p
->
Ãxt
;

14867 ; 
	gq
 !ğ
NULL
; q = 
q
->
Ãxt
è
pbuf_»f
(q);

14869 
mgos_lock
();

14870 ià(
	gcs
->
	grx_chaš
 =ğ
NULL
) {

14871 
cs
->
rx_off£t
 = 0;

14872 } ià(
pbuf_ş’
(
cs
->
rx_chaš
) >= 4) {

14876 
pbuf
 *
Å
 = 
pbuf_®loc
(
PBUF_RAW
, 
p
->
tÙ_Ën
, 
PBUF_RAM
);

14877 ià(
	gÅ
 !ğ
NULL
) {

14878 
pbuf_cİy
(
Å
, 
p
);

14879 
pbuf_ä“
(
p
);

14880 
	gp
 = 
Å
;

14883 
mgos_uÆock
();

14884 
mg_lw_»cv_commÚ
(
nc
, 
p
);

14885  
	gERR_OK
;

14888 
mg_lw_hªdË_»cv_tı
(
mg_cÚÃùiÚ
 *
nc
) {

14889 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14891 #ià
MG_ENABLE_SSL


14892 ià(
	gnc
->
	gæags
 & 
	gMG_F_SSL
) {

14893 ià(
	gnc
->
	gæags
 & 
	gMG_F_SSL_HANDSHAKE_DONE
) {

14894 
mg_lw_s¦_»cv
(
nc
);

14896 
mg_lw_s¦_do_hs
(
nc
);

14902 
mgos_lock
();

14903 
	gcs
->
	grx_chaš
 !ğ
NULL
) {

14904 
pbuf
 *
£g
 = 
cs
->
rx_chaš
;

14905 
size_t
 
	gËn
 = (
£g
->
Ën
 - 
cs
->
rx_off£t
);

14906 *
	gd©a
 = (*è
MG_MALLOC
(
Ën
);

14907 ià(
	gd©a
 =ğ
NULL
) {

14908 
mgos_uÆock
();

14909 
DBG
(("OOM"));

14912 
pbuf_cİy_·¹Ÿl
(
£g
, 
d©a
, 
Ën
, 
cs
->
rx_off£t
);

14913 
	gcs
->
	grx_off£t
 +ğ
Ën
;

14914 ià(
	gcs
->
	grx_off£t
 =ğ
cs
->
rx_chaš
->
Ën
) {

14915 
cs
->
rx_chaš
 = 
pbuf_dechaš
(cs->rx_chain);

14916 
pbuf_ä“
(
£g
);

14917 
	gcs
->
	grx_off£t
 = 0;

14919 
mgos_uÆock
();

14920 
mg_if_»cv_tı_cb
(
nc
, 
d©a
, 
Ën
, 1 );

14921 
mgos_lock
();

14923 
mgos_uÆock
();

14925 ià(
	gnc
->
	g£nd_mbuf
.
	gËn
 > 0) {

14926 
mg_lw_mgr_scheduË_pŞl
(
nc
->
mgr
);

14930 
”r_t
 
mg_lw_tı_£Á_cb
(*
¬g
, 
tı_pcb
 *
cb
,

14931 
u16_t
 
num_£Á
) {

14932 
mg_cÚÃùiÚ
 *
	gnc
 = (mg_cÚÃùiÚ *è
¬g
;

14933 
DBG
(("%°%°%u %°%p", 
nc
, 
cb
, 
num_£Á
,pcb->
un£Á
,pcb->
uÇcked
));

14934 ià(
	gnc
 =ğ
NULL
è 
ERR_OK
;

14935 ià((
	gnc
->
	gæags
 & 
	gMG_F_SEND_AND_CLOSE
è&& !Òc->æag & 
	gMG_F_WANT_WRITE
) &&

14936 
	gnc
->
	g£nd_mbuf
.
	gËn
 =ğ0 && 
cb
->
un£Á
 =ğ
NULL
 &&pcb->
uÇcked
 == NULL) {

14937 
mg_lw_po¡_sigÇl
(
MG_SIG_CLOSE_CONN
, 
nc
);

14939  
	gERR_OK
;

14942 
	smg_lw_if_cÚÃù_tı_ùx
 {

14943 
mg_cÚÃùiÚ
 *
	gnc
;

14944 cÚ¡ 
sock‘_add»ss
 *
	g§
;

14947 
mg_lw_if_cÚÃù_tı_tı
(*
¬g
) {

14948 
mg_lw_if_cÚÃù_tı_ùx
 *
	gùx
 =

14949 (
mg_lw_if_cÚÃù_tı_ùx
 *è
¬g
;

14950 
mg_cÚÃùiÚ
 *
	gnc
 = 
ùx
->
nc
;

14951 cÚ¡ 
sock‘_add»ss
 *
	g§
 = 
ùx
->
§
;

14953 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

14954 
tı_pcb
 *
	gcb
 = 
TCP_NEW
();

14955 
	gcs
->
	gpcb
.
	gtı
 = 
cb
;

14956 
_addr_t
 *
	g
 = (_addr_ˆ*è&
§
->
sš
.
sš_addr
.
s_addr
;

14957 
u16_t
 
	gpÜt
 = 
Áohs
(
§
->
sš
.
sš_pÜt
);

14958 
tı_¬g
(
cb
, 
nc
);

14959 
tı_”r
(
cb
, 
mg_lw_tı_”rÜ_cb
);

14960 
tı_£Á
(
cb
, 
mg_lw_tı_£Á_cb
);

14961 
tı_»cv
(
cb
, 
mg_lw_tı_»cv_cb
);

14962 
	gcs
->
	g”r
 = 
TCP_BIND
(
cb
, 
IP_ADDR_ANY
, 0 );

14963 
DBG
(("%°tı_bšd = %d", 
nc
, 
cs
->
”r
));

14964 ià(
	gcs
->
	g”r
 !ğ
ERR_OK
) {

14965 
mg_lw_po¡_sigÇl
(
MG_SIG_CONNECT_RESULT
, 
nc
);

14968 
	gcs
->
	g”r
 = 
tı_cÚÃù
(
cb
, 

, 
pÜt
, 
mg_lw_tı_cÚn_cb
);

14969 
DBG
(("%°tı_cÚÃù %°ğ%d", 
nc
, 
cb
, 
cs
->
”r
));

14970 ià(
	gcs
->
	g”r
 !ğ
ERR_OK
) {

14971 
mg_lw_po¡_sigÇl
(
MG_SIG_CONNECT_RESULT
, 
nc
);

14976 
mg_lw_if_cÚÃù_tı
(
mg_cÚÃùiÚ
 *
nc
,

14977 cÚ¡ 
sock‘_add»ss
 *
§
) {

14978 
mg_lw_if_cÚÃù_tı_ùx
 
	gùx
 = {.
nc
 =‚c, .
	g§
 = 
§
};

14979 
tı_ÿÎback
(
mg_lw_if_cÚÃù_tı_tı
, &
ùx
);

14986 #ià
LWIP_VERSION
 >= 0x01050000

14987 
mg_lw_udp_»cv_cb
(*
¬g
, 
udp_pcb
 *
pcb
, 
pbuf
 *
p
,

14988 cÚ¡ 
_addr_t
 *
addr
, 
u16_t
 
pÜt
)

14990 
mg_lw_udp_»cv_cb
(*
¬g
, 
udp_pcb
 *
pcb
, 
pbuf
 *
p
,

14991 
_addr_t
 *
addr
, 
u16_t
 
pÜt
)

14994 
mg_cÚÃùiÚ
 *
	gnc
 = (mg_cÚÃùiÚ *è
¬g
;

14995 
DBG
(("%°%s:%u %°%u %u", 
nc
, 
IPADDR_NTOA
(
addr
), 
pÜt
, 
p
,…->
»f
,…->
Ën
));

14997 
pbuf
 *
	g§p
 =

14998 
pbuf_®loc
(
PBUF_RAW
, (
sock‘_add»ss
), 
PBUF_RAM
);

14999 ià(
	g§p
 =ğ
NULL
) {

15000 
pbuf_ä“
(
p
);

15003 
sock‘_add»ss
 *
	g§
 = (sock‘_add»s *è
§p
->
·ylßd
;

15004 #ià
LWIP_VERSION
 >= 0x01050000

15005 
	g§
->
	gsš
.
	gsš_addr
.
	gs_addr
 = 
_2_4
(
addr
)->addr;

15007 
	g§
->
	gsš
.
	gsš_addr
.
	gs_addr
 = 
addr
->addr;

15009 
	g§
->
	gsš
.
	gsš_pÜt
 = 
htÚs
(
pÜt
);

15011 
	gp
 = 
pbuf_cßËsû
(
p
, 
PBUF_RAW
);

15012 
pbuf_chaš
(
§p
, 
p
);

15013 
mg_lw_»cv_commÚ
(
nc
, 
§p
);

15014 (è
	gpcb
;

15017 
mg_lw_»cv_commÚ
(
mg_cÚÃùiÚ
 *
nc
, 
pbuf
 *
p
) {

15018 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

15019 
mgos_lock
();

15020 ià(
	gcs
->
	grx_chaš
 =ğ
NULL
) {

15021 
cs
->
rx_chaš
 = 
p
;

15023 
pbuf_chaš
(
cs
->
rx_chaš
, 
p
);

15025 ià(!
	gcs
->
	g»cv_³ndšg
) {

15026 
	gcs
->
	g»cv_³ndšg
 = 1;

15027 
mg_lw_po¡_sigÇl
(
MG_SIG_RECV
, 
nc
);

15029 
mgos_uÆock
();

15032 
mg_lw_hªdË_»cv_udp
(
mg_cÚÃùiÚ
 *
nc
) {

15033 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

15038 
	gcs
->
	grx_chaš
 !ğ
NULL
) {

15039 
pbuf
 *
§p
 = 
cs
->
rx_chaš
;

15040 
pbuf
 *
	gp
 = 
§p
->
Ãxt
;

15041 
	gcs
->
	grx_chaš
 = 
pbuf_dechaš
(
p
);

15042 
size_t
 
	gd©a_Ën
 = 
p
->
Ën
;

15043 *
	gd©a
 = (*è
MG_MALLOC
(
d©a_Ën
);

15044 ià(
	gd©a
 !ğ
NULL
) {

15045 
pbuf_cİy_·¹Ÿl
(
p
, 
d©a
, 
d©a_Ën
, 0);

15046 
pbuf_ä“
(
p
);

15047 
mg_if_»cv_udp_cb
(
nc
, 
d©a
, 
d©a_Ën
,

15048 (
sock‘_add»ss
 *è
§p
->
·ylßd
, s­->
Ën
);

15049 
pbuf_ä“
(
§p
);

15051 
pbuf_ä“
(
p
);

15052 
pbuf_ä“
(
§p
);

15057 
mg_lw_if_cÚÃù_udp_tı
(*
¬g
) {

15058 
mg_cÚÃùiÚ
 *
	gnc
 = (mg_cÚÃùiÚ *è
¬g
;

15059 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

15060 
udp_pcb
 *
	gupcb
 = 
udp_Ãw
();

15061 
	gcs
->
	g”r
 = 
UDP_BIND
(
upcb
, 
IP_ADDR_ANY
, 0 );

15062 
DBG
(("%°udp_bšd %°ğ%d", 
nc
, 
upcb
, 
cs
->
”r
));

15063 ià(
	gcs
->
	g”r
 =ğ
ERR_OK
) {

15064 
udp_»cv
(
upcb
, 
mg_lw_udp_»cv_cb
, 
nc
);

15065 
	gcs
->
	gpcb
.
	gudp
 = 
upcb
;

15067 
udp_»move
(
upcb
);

15069 
mg_lw_po¡_sigÇl
(
MG_SIG_CONNECT_RESULT
, 
nc
);

15072 
mg_lw_if_cÚÃù_udp
(
mg_cÚÃùiÚ
 *
nc
) {

15073 
tı_ÿÎback
(
mg_lw_if_cÚÃù_udp_tı
, 
nc
);

15076 
mg_lw_acû±_cÚn
(
mg_cÚÃùiÚ
 *
nc
, 
tı_pcb
 *
cb
) {

15077 
sock‘_add»ss
 
	g§
;

15078 
SET_ADDR
(&
§
, &
cb
->
»mÙe_
);

15079 
	g§
.
	gsš
.
	gsš_pÜt
 = 
htÚs
(
cb
->
»mÙe_pÜt
);

15080 
mg_if_acû±_tı_cb
(
nc
, &
§
, (§.
sš
));

15083 
tı_şo£_tı
(*
¬g
) {

15084 
tı_şo£
((
tı_pcb
 *è
¬g
);

15087 
mg_lw_hªdË_acû±
(
mg_cÚÃùiÚ
 *
nc
) {

15088 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

15089 ià(
	gcs
->
	gpcb
.
	gtı
 =ğ
NULL
) ;

15090 #ià
MG_ENABLE_SSL


15091 ià(
	gcs
->
	glc
->
	gæags
 & 
	gMG_F_SSL
) {

15092 ià(
mg_s¦_if_cÚn_acû±
(
nc
, 
cs
->
lc
è!ğ
MG_SSL_OK
) {

15093 
LOG
(
LL_ERROR
, ("SSLƒrror"));

15094 
tı_ÿÎback
(
tı_şo£_tı
, 
cs
->
pcb
.
tı
);

15099 
mg_lw_acû±_cÚn
(
nc
, 
cs
->
pcb
.
tı
);

15103 
”r_t
 
mg_lw_acû±_cb
(*
¬g
, 
tı_pcb
 *
Ãwcb
,ƒ¼_ˆ
”r
) {

15104 
mg_cÚÃùiÚ
 *
	glc
 = (mg_cÚÃùiÚ *è
¬g
, *
	gnc
;

15105 
mg_lw_cÚn_¡©e
 *
	glcs
, *
	gcs
;

15106 
tı_pcb_li¡’
 *
	gÍcb
;

15107 
LOG
(
LL_DEBUG
,

15108 ("%°cÚÀ%°äom %s:%u", 
lc
, 
Ãwcb
,

15109 
IPADDR_NTOA
(
X_2_
(&
Ãwcb
->
»mÙe_
)),‚ewcb->
»mÙe_pÜt
));

15110 ià(
	glc
 =ğ
NULL
) {

15111 
tı_abÜt
(
Ãwcb
);

15112  
	gERR_ABRT
;

15114 
	glcs
 = (
mg_lw_cÚn_¡©e
 *è
lc
->
sock
;

15115 
	gÍcb
 = (
tı_pcb_li¡’
 *è
lcs
->
pcb
.
tı
;

15116 #ià
TCP_LISTEN_BACKLOG


15117 
tı_acû±ed
(
Ícb
);

15119 
	gnc
 = 
mg_if_acû±_Ãw_cÚn
(
lc
);

15120 ià(
	gnc
 =ğ
NULL
) {

15121 
tı_abÜt
(
Ãwcb
);

15122  
	gERR_ABRT
;

15124 
	gcs
 = (
mg_lw_cÚn_¡©e
 *è
nc
->
sock
;

15125 
	gcs
->
	glc
 = 
lc
;

15126 
	gcs
->
	gpcb
.
	gtı
 = 
Ãwcb
;

15129 
tı_¬g
(
Ãwcb
, 
nc
);

15130 
tı_”r
(
Ãwcb
, 
mg_lw_tı_”rÜ_cb
);

15131 
tı_£Á
(
Ãwcb
, 
mg_lw_tı_£Á_cb
);

15132 
tı_»cv
(
Ãwcb
, 
mg_lw_tı_»cv_cb
);

15133 #ià
LWIP_TCP_KEEPALIVE


15134 
mg_lw_£t_k“·live_·¿ms
(
nc
, 60, 10, 6);

15136 
mg_lw_po¡_sigÇl
(
MG_SIG_ACCEPT
, 
nc
);

15137 (è
	g”r
;

15138 (è
	gÍcb
;

15139  
	gERR_OK
;

15142 
	smg_lw_if_li¡’_ùx
 {

15143 
mg_cÚÃùiÚ
 *
	gnc
;

15144 
sock‘_add»ss
 *
	g§
;

15145 
	g»t
;

15148 
mg_lw_if_li¡’_tı_tı
(*
¬g
) {

15149 
mg_lw_if_li¡’_ùx
 *
	gùx
 = (mg_lw_if_li¡’_ùx *è
¬g
;

15150 
mg_cÚÃùiÚ
 *
	gnc
 = 
ùx
->
nc
;

15151 
sock‘_add»ss
 *
	g§
 = 
ùx
->
§
;

15152 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

15153 
tı_pcb
 *
	gcb
 = 
TCP_NEW
();

15154 
_addr_t
 *
	g
 = (_addr_ˆ*è&
§
->
sš
.
sš_addr
.
s_addr
;

15155 
u16_t
 
	gpÜt
 = 
Áohs
(
§
->
sš
.
sš_pÜt
);

15156 
	gcs
->
	g”r
 = 
TCP_BIND
(
cb
, 

, 
pÜt
);

15157 
DBG
(("%°tı_bšd(%s:%uèğ%d", 
nc
, 
IPADDR_NTOA
(

), 
pÜt
, 
cs
->
”r
));

15158 ià(
	gcs
->
	g”r
 !ğ
ERR_OK
) {

15159 
tı_şo£
(
cb
);

15160 
	gùx
->
	g»t
 = -1;

15163 
tı_¬g
(
cb
, 
nc
);

15164 
	gcb
 = 
tı_li¡’
(
cb
);

15165 
	gcs
->
	gpcb
.
	gtı
 = 
cb
;

15166 
tı_acû±
(
cb
, 
mg_lw_acû±_cb
);

15167 
	gùx
->
	g»t
 = 0;

15170 
mg_lw_if_li¡’_tı
(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
) {

15171 
mg_lw_if_li¡’_ùx
 
	gùx
 = {.
nc
 =‚c, .
	g§
 = 
§
};

15172 
tı_ÿÎback
(
mg_lw_if_li¡’_tı_tı
, &
ùx
);

15173  
	gùx
.
	g»t
;

15176 
mg_lw_if_li¡’_udp_tı
(*
¬g
) {

15177 
mg_lw_if_li¡’_ùx
 *
	gùx
 = (mg_lw_if_li¡’_ùx *è
¬g
;

15178 
mg_cÚÃùiÚ
 *
	gnc
 = 
ùx
->
nc
;

15179 
sock‘_add»ss
 *
	g§
 = 
ùx
->
§
;

15180 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

15181 
udp_pcb
 *
	gupcb
 = 
udp_Ãw
();

15182 
_addr_t
 *
	g
 = (_addr_ˆ*è&
§
->
sš
.
sš_addr
.
s_addr
;

15183 
u16_t
 
	gpÜt
 = 
Áohs
(
§
->
sš
.
sš_pÜt
);

15184 
	gcs
->
	g”r
 = 
UDP_BIND
(
upcb
, 

, 
pÜt
);

15185 
DBG
(("%°udb_bšd(%s:%uèğ%d", 
nc
, 
IPADDR_NTOA
(

), 
pÜt
, 
cs
->
”r
));

15186 ià(
	gcs
->
	g”r
 !ğ
ERR_OK
) {

15187 
udp_»move
(
upcb
);

15188 
	gùx
->
	g»t
 = -1;

15190 
udp_»cv
(
upcb
, 
mg_lw_udp_»cv_cb
, 
nc
);

15191 
	gcs
->
	gpcb
.
	gudp
 = 
upcb
;

15192 
	gùx
->
	g»t
 = 0;

15196 
mg_lw_if_li¡’_udp
(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
) {

15197 
mg_lw_if_li¡’_ùx
 
	gùx
 = {.
nc
 =‚c, .
	g§
 = 
§
};

15198 
tı_ÿÎback
(
mg_lw_if_li¡’_udp_tı
, &
ùx
);

15199  
	gùx
.
	g»t
;

15202 
	smg_lw_tı_wr™e_ùx
 {

15203 
mg_cÚÃùiÚ
 *
	gnc
;

15204 cÚ¡ *
	gd©a
;

15205 
ušt16_t
 
	gËn
;

15206 
	g»t
;

15209 
tı_ouut_tı
(*
¬g
) {

15210 
tı_ouut
((
tı_pcb
 *è
¬g
);

15213 
mg_lw_tı_wr™e_tı
(*
¬g
) {

15214 
mg_lw_tı_wr™e_ùx
 *
	gùx
 = (mg_lw_tı_wr™e_ùx *è
¬g
;

15215 
mg_cÚÃùiÚ
 *
	gnc
 = 
ùx
->
nc
;

15216 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

15217 
tı_pcb
 *
	gcb
 = 
cs
->
pcb
.
tı
;

15218 
size_t
 
	gËn
 = 
MIN
(
cb
->
mss
, MIN(
ùx
->
Ën
,pcb->
¢d_buf
));

15219 
size_t
 
	gun£Á
, 
	guÇcked
;

15220 ià(
	gËn
 == 0) {

15221 
DBG
(("%°nØbuàava %u %u %u %°%p", 
cb
,pcb->
acked
,pcb->
¢d_buf
,

15222 
cb
->
¢d_queu–’
,pcb->
un£Á
,pcb->
uÇcked
));

15223 
tı_ÿÎback
(
tı_ouut_tı
, 
cb
);

15224 
	gùx
->
	g»t
 = 0;

15227 
	gun£Á
 = (
cb
->
un£Á
 !ğ
NULL
 ?pcb->un£Á->
Ën
 : 0);

15228 
	guÇcked
 = (
cb
->
uÇcked
 !ğ
NULL
 ?pcb->uÇcked->
Ën
 : 0);

15235 #ià
CS_PLATFORM
 =ğ
CS_P_ESP8266


15236 ià(
	guÇcked
 > 0) {

15237 
	gùx
->
	g»t
 = 0;

15240 
	gËn
 = 
MIN
(
Ën
, (
TCP_MSS
 - 
un£Á
));

15242 
	gcs
->
	g”r
 = 
tı_wr™e
(
cb
, 
ùx
->
d©a
, 
Ën
, 
TCP_WRITE_FLAG_COPY
);

15243 
	gun£Á
 = (
cb
->
un£Á
 !ğ
NULL
 ?pcb->un£Á->
Ën
 : 0);

15244 
	guÇcked
 = (
cb
->
uÇcked
 !ğ
NULL
 ?pcb->uÇcked->
Ën
 : 0);

15245 
DBG
(("%°tı_wr™%u = %d, %u %u", 
cb
, 
Ën
, 
cs
->
”r
, 
un£Á
, 
uÇcked
));

15246 ià(
	gcs
->
	g”r
 !ğ
ERR_OK
) {

15251 
ùx
->
»t
 = (
cs
->
”r
 =ğ
ERR_MEM
 ? 0 : -1);

15254 
	gùx
->
	g»t
 = 
Ën
;

15257 
mg_lw_tı_wr™e
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
d©a
,

15258 
ušt16_t
 
Ën
) {

15259 
mg_lw_tı_wr™e_ùx
 
	gùx
 = {.
nc
 =‚c, .
	gd©a
 = 
d©a
, .
	gËn
 = 
Ën
};

15260 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

15261 
tı_pcb
 *
	gcb
 = 
cs
->
pcb
.
tı
;

15262 ià(
	gcb
 =ğ
NULL
) {

15265 
tı_ÿÎback
(
mg_lw_tı_wr™e_tı
, &
ùx
);

15266  
	gùx
.
	g»t
;

15269 
	sudp_£ndto_ùx
 {

15270 
udp_pcb
 *
	gupcb
;

15271 
pbuf
 *
	gp
;

15272 
_addr_t
 *
	g
;

15273 
ušt16_t
 
	gpÜt
;

15274 
	g»t
;

15277 
udp_£ndto_tı
(*
¬g
) {

15278 
udp_£ndto_ùx
 *
	gùx
 = (udp_£ndto_ùx *è
¬g
;

15279 
	gùx
->
	g»t
 = 
udp_£ndto
(
ùx
->
upcb
, ctx->
p
, ctx->

, ctx->
pÜt
);

15282 
mg_lw_udp_£nd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
d©a
,

15283 
ušt16_t
 
Ën
) {

15284 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

15285 ià(
	gcs
->
	gpcb
.
	gudp
 =ğ
NULL
) {

15291 
DBG
(("%°sock‘ i nÙ cÚÃùed", 
nc
));

15294 
udp_pcb
 *
	gupcb
 = 
cs
->
pcb
.
udp
;

15295 
pbuf
 *
	gp
 = 
pbuf_®loc
(
PBUF_TRANSPORT
, 
Ën
, 
PBUF_RAM
);

15296 #ià
defšed
(
LWIP_IPV4
è&& LWIP_IPV4 && defšed(
LWIP_IPV6
) && LWIP_IPV6

15297 
_addr_t
 
	g
 = {.
u_addr
.
4
.
addr
 = 
nc
->
§
.
sš
.
sš_addr
.
s_addr
, .
	gty³
 = 0};

15299 
_addr_t
 
	g
 = {.
addr
 = 
nc
->
§
.
sš
.
sš_addr
.
s_addr
};

15301 
u16_t
 
	gpÜt
 = 
Áohs
(
nc
->
§
.
sš
.
sš_pÜt
);

15302 ià(
	gp
 =ğ
NULL
) {

15303 
DBG
(("OOM"));

15306 
memıy
(
p
->
·ylßd
, 
d©a
, 
Ën
);

15307 
udp_£ndto_ùx
 
	gùx
 = {.
upcb
 = upcb, .
	gp
 = 
p
, .
	g
 = &

, .
	gpÜt
 = 
pÜt
};

15308 
tı_ÿÎback
(
udp_£ndto_tı
, &
ùx
);

15309 
	gcs
->
	g”r
 = 
ùx
.
»t
;

15310 
pbuf_ä“
(
p
);

15311  (
	gcs
->
	g”r
 =ğ
ERR_OK
 ? 
Ën
 : -1);

15314 
mg_lw_£nd_mÜe
(
mg_cÚÃùiÚ
 *
nc
) {

15315 
	gnum_£Á
 = 0;

15316 ià(
	gnc
->
	gsock
 =ğ
INVALID_SOCKET
) ;

15317 ià(
	gnc
->
	gæags
 & 
	gMG_F_UDP
) {

15318 
	gnum_£Á
 = 
mg_lw_udp_£nd
(
nc
,‚c->
£nd_mbuf
.
buf
,‚c->£nd_mbuf.
Ën
);

15319 
DBG
(("%°mg_lw_udp_£nd %u = %d", 
nc
,‚c->
£nd_mbuf
.
Ën
, 
num_£Á
));

15321 
	gnum_£Á
 = 
mg_lw_tı_wr™e
(
nc
,‚c->
£nd_mbuf
.
buf
,‚c->£nd_mbuf.
Ën
);

15322 
DBG
(("%°mg_lw_tı_wr™%u = %d", 
nc
,‚c->
£nd_mbuf
.
Ën
, 
num_£Á
));

15324 ià(
	gnum_£Á
 == 0) ;

15325 ià(
	gnum_£Á
 > 0) {

15326 
mg_if_£Á_cb
(
nc
, 
num_£Á
);

15328 
mg_lw_po¡_sigÇl
(
MG_SIG_CLOSE_CONN
, 
nc
);

15332 
mg_lw_if_tı_£nd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
,

15333 
size_t
 
Ën
) {

15334 
mbuf_­³nd
(&
nc
->
£nd_mbuf
, 
buf
, 
Ën
);

15335 
mg_lw_mgr_scheduË_pŞl
(
nc
->
mgr
);

15338 
mg_lw_if_udp_£nd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
,

15339 
size_t
 
Ën
) {

15340 
mbuf_­³nd
(&
nc
->
£nd_mbuf
, 
buf
, 
Ën
);

15341 
mg_lw_mgr_scheduË_pŞl
(
nc
->
mgr
);

15344 
	stı_»cved_ùx
 {

15345 
tı_pcb
 *
	gcb
;

15346 
size_t
 
	gËn
;

15349 
tı_»cved_tı
(*
¬g
) {

15350 
tı_»cved_ùx
 *
	gùx
 = (tı_»cved_ùx *è
¬g
;

15351 
tı_»cved
(
ùx
->
cb
, ctx->
Ën
);

15354 
mg_lw_if_»cved
(
mg_cÚÃùiÚ
 *
nc
, 
size_t
 
Ën
) {

15355 ià(
	gnc
->
	gæags
 & 
	gMG_F_UDP
) ;

15356 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

15357 ià(
	gnc
->
	gsock
 =ğ
INVALID_SOCKET
 || 
cs
->
pcb
.
tı
 =ğ
NULL
) {

15358 
DBG
(("%°šv®id sock‘", 
nc
));

15361 
DBG
(("%°%°%u %u", 
nc
, 
cs
->
pcb
.
tı
, 
Ën
,

15362 (
cs
->
rx_chaš
 ? cs->rx_chaš->
tÙ_Ën
 : 0)));

15363 
tı_»cved_ùx
 
	gùx
 = {.
cb
 = 
cs
->
pcb
.
tı
, .
	gËn
 = 
Ën
};

15364 #ià
MG_ENABLE_SSL


15365 ià(!(
	gnc
->
	gæags
 & 
	gMG_F_SSL
)) {

15366 
tı_ÿÎback
(
tı_»cved_tı
, &
ùx
);

15372 
tı_ÿÎback
(
tı_»cved_tı
, &
ùx
);

15374 
mbuf_Œim
(&
nc
->
»cv_mbuf
);

15377 
mg_lw_if_ü—‹_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

15378 
mg_lw_cÚn_¡©e
 *
	gcs
 =

15379 (
mg_lw_cÚn_¡©e
 *è
MG_CALLOC
(1, (*
cs
));

15380 ià(
	gcs
 =ğ
NULL
)  0;

15381 
	gcs
->
	gnc
 = 
nc
;

15382 
	gnc
->
	gsock
 = (
šŒ_t
è
cs
;

15386 
udp_»move_tı
(*
¬g
) {

15387 
udp_»move
((
udp_pcb
 *è
¬g
);

15390 
mg_lw_if_de¡roy_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

15391 ià(
	gnc
->
	gsock
 =ğ
INVALID_SOCKET
) ;

15392 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

15393 ià(!(
	gnc
->
	gæags
 & 
	gMG_F_UDP
)) {

15394 
tı_pcb
 *
	gcb
 = 
cs
->
pcb
.
tı
;

15395 ià(
	gcb
 !ğ
NULL
) {

15396 
tı_¬g
(
cb
, 
NULL
);

15397 
DBG
(("%°tı_şo£ %p", 
nc
, 
cb
));

15398 
tı_¬g
(
cb
, 
NULL
);

15399 
tı_ÿÎback
(
tı_şo£_tı
, 
cb
);

15401 
	gcs
->
	grx_chaš
 !ğ
NULL
) {

15402 
pbuf
 *
£g
 = 
cs
->
rx_chaš
;

15403 
	gcs
->
	grx_chaš
 = 
pbuf_dechaš
(
cs
->
rx_chaš
);

15404 
pbuf_ä“
(
£g
);

15406 
mem£t
(
cs
, 0, (*cs));

15407 
MG_FREE
(
cs
);

15408 } ià(
	gnc
->
	gli¡’”
 =ğ
NULL
) {

15410 
udp_pcb
 *
upcb
 = 
cs
->
pcb
.
udp
;

15411 ià(
	gupcb
 !ğ
NULL
) {

15412 
DBG
(("%°udp_»mov%p", 
nc
, 
upcb
));

15413 
tı_ÿÎback
(
udp_»move_tı
, 
upcb
);

15415 
mem£t
(
cs
, 0, (*cs));

15416 
MG_FREE
(
cs
);

15418 
	gnc
->
	gsock
 = 
INVALID_SOCKET
;

15421 
mg_lw_if_g‘_cÚn_addr
(
mg_cÚÃùiÚ
 *
nc
, 
»mÙe
,

15422 
sock‘_add»ss
 *
§
) {

15423 
mem£t
(
§
, 0, (*sa));

15424 ià(
	gnc
 =ğ
NULL
 || 
nc
->
sock
 =ğ
INVALID_SOCKET
) ;

15425 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

15426 ià(
	gnc
->
	gæags
 & 
	gMG_F_UDP
) {

15427 
udp_pcb
 *
	gupcb
 = 
cs
->
pcb
.
udp
;

15428 ià(
	g»mÙe
) {

15429 
memıy
(
§
, &
nc
->sa, (*sa));

15430 } ià(
	gupcb
 !ğ
NULL
) {

15431 
§
->
sš
.
sš_pÜt
 = 
htÚs
(
upcb
->
loÿl_pÜt
);

15432 
SET_ADDR
(
§
, &
upcb
->
loÿl_
);

15435 
tı_pcb
 *
	gcb
 = 
cs
->
pcb
.
tı
;

15436 ià(
	g»mÙe
) {

15437 
memıy
(
§
, &
nc
->sa, (*sa));

15438 } ià(
	gcb
 !ğ
NULL
) {

15439 
§
->
sš
.
sš_pÜt
 = 
htÚs
(
cb
->
loÿl_pÜt
);

15440 
SET_ADDR
(
§
, &
cb
->
loÿl_
);

15445 
mg_lw_if_sock_£t
(
mg_cÚÃùiÚ
 *
nc
, 
sock_t
 
sock
) {

15446 
	gnc
->
	gsock
 = 
sock
;

15450 
	#MG_LWIP_IFACE_VTABLE
 \

15452 
mg_lw_if_š™
, \

15453 
mg_lw_if_ä“
, \

15454 
mg_lw_if_add_cÚn
, \

15455 
mg_lw_if_»move_cÚn
, \

15456 
mg_lw_if_pŞl
, \

15457 
mg_lw_if_li¡’_tı
, \

15458 
mg_lw_if_li¡’_udp
, \

15459 
mg_lw_if_cÚÃù_tı
, \

15460 
mg_lw_if_cÚÃù_udp
, \

15461 
mg_lw_if_tı_£nd
, \

15462 
mg_lw_if_udp_£nd
, \

15463 
mg_lw_if_»cved
, \

15464 
mg_lw_if_ü—‹_cÚn
, \

15465 
mg_lw_if_de¡roy_cÚn
, \

15466 
mg_lw_if_sock_£t
, \

15467 
mg_lw_if_g‘_cÚn_addr
, \

15468 }

	)

15471 cÚ¡ 
mg_içû_vbË
 
	gmg_lw_içû_vbË
 = 
MG_LWIP_IFACE_VTABLE
;

15472 #ià
MG_NET_IF
 =ğ
MG_NET_IF_LWIP_LOW_LEVEL


15473 cÚ¡ 
mg_içû_vbË
 
	gmg_deçuÉ_içû_vbË
 = 
MG_LWIP_IFACE_VTABLE
;

15477 #ifdeà
MG_MODULE_LINES


15485 #ià
MG_NET_IF
 =ğ
MG_NET_IF_LWIP_LOW_LEVEL


15487 #iâdeà
MG_SIG_QUEUE_LEN


15488 
	#MG_SIG_QUEUE_LEN
 32

	)

15491 
	smg_ev_mgr_lw_sigÇl
 {

15492 
	gsig
;

15493 
mg_cÚÃùiÚ
 *
	gnc
;

15496 
	smg_ev_mgr_lw_d©a
 {

15497 
mg_ev_mgr_lw_sigÇl
 
	gsig_queue
[
MG_SIG_QUEUE_LEN
];

15498 
	gsig_queue_Ën
;

15499 
	g¡¬t_šdex
;

15502 
mg_lw_po¡_sigÇl
(
mg_sig_ty³
 
sig
, 
mg_cÚÃùiÚ
 *
nc
) {

15503 
mg_ev_mgr_lw_d©a
 *
	gmd
 =

15504 (
mg_ev_mgr_lw_d©a
 *è
nc
->
içû
->
d©a
;

15505 
mgos_lock
();

15506 ià(
	gmd
->
	gsig_queue_Ën
 >ğ
MG_SIG_QUEUE_LEN
) {

15507 
mgos_uÆock
();

15510 
	g’d_šdex
 = (
md
->
¡¬t_šdex
 + md->
sig_queue_Ën
è% 
MG_SIG_QUEUE_LEN
;

15511 
	gmd
->
	gsig_queue
[
’d_šdex
].
	gsig
 = 
sig
;

15512 
	gmd
->
	gsig_queue
[
’d_šdex
].
	gnc
 = 
nc
;

15513 
	gmd
->
	gsig_queue_Ën
++;

15514 
mg_lw_mgr_scheduË_pŞl
(
nc
->
mgr
);

15515 
mgos_uÆock
();

15518 
mg_ev_mgr_lw_´oûss_sigÇls
(
mg_mgr
 *
mgr
) {

15519 
mg_ev_mgr_lw_d©a
 *
	gmd
 =

15520 (
mg_ev_mgr_lw_d©a
 *è
mgr
->
içûs
[
MG_MAIN_IFACE
]->
d©a
;

15521 
	gmd
->
	gsig_queue_Ën
 > 0) {

15522 
mgos_lock
();

15523 
	gsig
 = 
md
->
sig_queue
[md->
¡¬t_šdex
].
sig
;

15524 
mg_cÚÃùiÚ
 *
	gnc
 = 
md
->
sig_queue
[md->
¡¬t_šdex
].
nc
;

15525 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

15526 
	gmd
->
	g¡¬t_šdex
 = (
md
->
¡¬t_šdex
 + 1è% 
MG_SIG_QUEUE_LEN
;

15527 
	gmd
->
	gsig_queue_Ën
--;

15528 
mgos_uÆock
();

15529 ià(
	gnc
->
	giçû
 =ğ
NULL
 || 
nc
->
mgr
 == NULL) ;

15530 
	gsig
) {

15531 
	gMG_SIG_CONNECT_RESULT
: {

15532 #ià
MG_ENABLE_SSL


15533 ià(
cs
->
”r
 =ğ0 && (
nc
->
æags
 & 
MG_F_SSL
) &&

15534 !(
nc
->
æags
 & 
MG_F_SSL_HANDSHAKE_DONE
)) {

15535 
mg_lw_s¦_do_hs
(
nc
);

15539 
mg_if_cÚÃù_cb
(
nc
, 
cs
->
”r
);

15543 
	gMG_SIG_CLOSE_CONN
: {

15544 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

15545 
mg_şo£_cÚn
(
nc
);

15548 
	gMG_SIG_RECV
: {

15549 
cs
->
»cv_³ndšg
 = 0;

15550 ià(
	gnc
->
	gæags
 & 
	gMG_F_UDP
) {

15551 
mg_lw_hªdË_»cv_udp
(
nc
);

15553 
mg_lw_hªdË_»cv_tı
(
nc
);

15557 
	gMG_SIG_TOMBSTONE
: {

15560 
	gMG_SIG_ACCEPT
: {

15561 
mg_lw_hªdË_acû±
(
nc
);

15568 
mg_lw_if_š™
(
mg_içû
 *
içû
) {

15569 
LOG
(
LL_INFO
, ("%°MÚgoo£ in™", 
içû
));

15570 
	giçû
->
	gd©a
 = 
MG_CALLOC
(1, (
mg_ev_mgr_lw_d©a
));

15573 
mg_lw_if_ä“
(
mg_içû
 *
içû
) {

15574 
MG_FREE
(
içû
->
d©a
);

15575 
	giçû
->
	gd©a
 = 
NULL
;

15578 
mg_lw_if_add_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

15579 (è
	gnc
;

15582 
mg_lw_if_»move_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

15583 
mg_ev_mgr_lw_d©a
 *
	gmd
 =

15584 (
mg_ev_mgr_lw_d©a
 *è
nc
->
içû
->
d©a
;

15586 
	gi
 = 0; i < 
	gMG_SIG_QUEUE_LEN
; i++) {

15587 ià(
	gmd
->
	gsig_queue
[
i
].
	gnc
 =ğ
nc
) {

15588 
md
->
sig_queue
[
i
].
sig
 = 
MG_SIG_TOMBSTONE
;

15593 
time_t
 
mg_lw_if_pŞl
(
mg_içû
 *
içû
, 
timeout_ms
) {

15594 
mg_mgr
 *
	gmgr
 = 
içû
->
mgr
;

15595 
	gn
 = 0;

15596 
	gnow
 = 
mg_time
();

15597 
mg_cÚÃùiÚ
 *
	gnc
, *
	gtmp
;

15598 
	gmš_tim”
 = 0;

15599 
	gnum_tim”s
 = 0;

15601 
DBG
(("begš…ŞÈ@%u", (è(
now
 * 1000)));

15603 
mg_ev_mgr_lw_´oûss_sigÇls
(
mgr
);

15604 
	gnc
 = 
mgr
->
aùive_cÚÃùiÚs
;‚ø!ğ
NULL
;‚øğ
tmp
) {

15605 
mg_lw_cÚn_¡©e
 *
cs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

15606 
	gtmp
 = 
nc
->
Ãxt
;

15607 
	gn
++;

15608 ià((
	gnc
->
	gæags
 & 
	gMG_F_CLOSE_IMMEDIATELY
) ||

15609 ((
	gnc
->
	gæags
 & 
	gMG_F_SEND_AND_CLOSE
è&& (nc->æag & 
	gMG_F_UDP
) &&

15610 (
	gnc
->
	g£nd_mbuf
.
	gËn
 == 0))) {

15611 
mg_şo£_cÚn
(
nc
);

15614 
mg_if_pŞl
(
nc
, 
now
);

15615 
mg_if_tim”
(
nc
, 
now
);

15616 #ià
MG_ENABLE_SSL


15617 ià((
	gnc
->
	gæags
 & 
	gMG_F_SSL
è&& 
	gcs
 !ğ
NULL
 && 
cs
->
pcb
.
tı
 != NULL &&

15618 
cs
->
pcb
.
tı
->
¡©e
 =ğ
ESTABLISHED
) {

15619 ià(((
nc
->
æags
 & 
MG_F_WANT_WRITE
) ||

15620 ((
nc
->
£nd_mbuf
.
Ën
 > 0) &&

15621 (
nc
->
æags
 & 
MG_F_SSL_HANDSHAKE_DONE
))) &&

15622 
cs
->
pcb
.
tı
->
¢d_buf
 > 0) {

15624 ià(
nc
->
æags
 & 
MG_F_SSL_HANDSHAKE_DONE
) {

15625 ià(!(
nc
->
æags
 & 
MG_F_CONNECTING
)è
mg_lw_s¦_£nd
(nc);

15627 
mg_lw_s¦_do_hs
(
nc
);

15630 ià(
	gcs
->
	grx_chaš
 !ğ
NULL
 || (
nc
->
æags
 & 
MG_F_WANT_READ
)) {

15631 ià(
nc
->
æags
 & 
MG_F_SSL_HANDSHAKE_DONE
) {

15632 ià(!(
nc
->
æags
 & 
MG_F_CONNECTING
)è
mg_lw_s¦_»cv
(nc);

15634 
mg_lw_s¦_do_hs
(
nc
);

15640 ià(
	gnc
->
	g£nd_mbuf
.
	gËn
 > 0 && !Òc->
	gæags
 & 
	gMG_F_CONNECTING
)) {

15641 
mg_lw_£nd_mÜe
(
nc
);

15644 ià(
	gnc
->
	gsock
 !ğ
INVALID_SOCKET
 &&

15645 !(
nc
->
æags
 & (
MG_F_UDP
 | 
MG_F_LISTENING
)è&& 
cs
->
pcb
.
tı
 !ğ
NULL
 &&

15646 
cs
->
pcb
.
tı
->
un£Á
 !ğ
NULL
) {

15647 
tı_ÿÎback
(
tı_ouut_tı
, 
cs
->
pcb
.
tı
);

15649 ià(
	gnc
->
	gev_tim”_time
 > 0) {

15650 ià(
	gnum_tim”s
 =ğ0 || 
nc
->
ev_tim”_time
 < 
mš_tim”
) {

15651 
mš_tim”
 = 
nc
->
ev_tim”_time
;

15653 
	gnum_tim”s
++;

15657 
DBG
(("end…oll @%u, %d conns, %dimers (min %u),‚ext in %d ms",

15658 (è(
now
 * 1000), 
n
, 
num_tim”s
,

15659 (è(
mš_tim”
 * 1000), 
timeout_ms
));

15661 (è
	gtimeout_ms
;

15662  
	gnow
;

15665 
ušt32_t
 
mg_lw_g‘_pŞl_d–ay_ms
(
mg_mgr
 *
mgr
) {

15666 
mg_cÚÃùiÚ
 *
	gnc
;

15667 
	gnow
;

15668 
	gmš_tim”
 = 0;

15669 
	gnum_tim”s
 = 0;

15670 
mg_ev_mgr_lw_´oûss_sigÇls
(
mgr
);

15671 
	gnc
 = 
mg_Ãxt
(
mgr
, 
NULL
);‚ø!ğNULL;‚øğmg_Ãxt(mgr, 
nc
)) {

15672 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

15673 ià(
	gnc
->
	gev_tim”_time
 > 0) {

15674 ià(
	gnum_tim”s
 =ğ0 || 
nc
->
ev_tim”_time
 < 
mš_tim”
) {

15675 
mš_tim”
 = 
nc
->
ev_tim”_time
;

15677 
	gnum_tim”s
++;

15679 ià(
	gnc
->
	g£nd_mbuf
.
	gËn
 > 0

15680 #ià
MG_ENABLE_SSL


15681 || (
	gnc
->
	gæags
 & 
	gMG_F_WANT_WRITE
)

15684 
	gÿn_£nd
 = 0;

15686 ià(
	gnc
->
	gæags
 & 
	gMG_F_UDP
) {

15688 
	gÿn_£nd
 = (
cs
->
pcb
.
udp
 !ğ
NULL
);

15690 
	gÿn_£nd
 = (
cs
->
pcb
.
tı
 !ğ
NULL
 && cs->pcb.tı->
¢d_buf
 > 0);

15693 ià(
	gÿn_£nd
)  0;

15696 
ušt32_t
 
	gtimeout_ms
 = ~0;

15697 
	gnow
 = 
mg_time
();

15698 ià(
	gnum_tim”s
 > 0) {

15700 ià(
	gmš_tim”
 < 
	gnow
)  0;

15701 
	gtim”_timeout_ms
 = (
mš_tim”
 - 
now
) * 1000 + 1 ;

15702 ià(
	gtim”_timeout_ms
 < 
	gtimeout_ms
) {

15703 
	gtimeout_ms
 = 
tim”_timeout_ms
;

15706  
	gtimeout_ms
;

15710 #ifdeà
MG_MODULE_LINES


15718 #ià
MG_ENABLE_SSL
 && 
MG_NET_IF
 =ğ
MG_NET_IF_LWIP_LOW_LEVEL


15723 
	~<lw/pbuf.h
>

15724 
	~<lw/tı.h
>

15726 #iâdeà
MG_LWIP_SSL_IO_SIZE


15727 
	#MG_LWIP_SSL_IO_SIZE
 1024

	)

15734 #iâdeà
MG_LWIP_SSL_RECV_MBUF_LIMIT


15735 
	#MG_LWIP_SSL_RECV_MBUF_LIMIT
 3072

	)

15738 #iâdeà
MIN


15739 
	#MIN
(
a
, 
b
è(×è< (bè? (aè: (b))

	)

15742 
mg_lw_s¦_do_hs
(
mg_cÚÃùiÚ
 *
nc
) {

15743 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

15744 
	g£rv”_side
 = (
nc
->
li¡’”
 !ğ
NULL
);

15745 
mg_s¦_if_»suÉ
 
	g»s
;

15746 ià(
	gnc
->
	gæags
 & 
	gMG_F_CLOSE_IMMEDIATELY
) ;

15747 
	g»s
 = 
mg_s¦_if_hªdshake
(
nc
);

15748 
DBG
(("%°%lu %d %d", 
nc
,‚c->
æags
, 
£rv”_side
, 
»s
));

15749 ià(
	g»s
 !ğ
MG_SSL_OK
) {

15750 ià(
»s
 =ğ
MG_SSL_WANT_WRITE
) {

15751 
nc
->
æags
 |ğ
MG_F_WANT_WRITE
;

15752 
	gcs
->
	g”r
 = 0;

15753 } ià(
	g»s
 =ğ
MG_SSL_WANT_READ
) {

15758 
nc
->
æags
 &ğ~
MG_F_WANT_READ
;

15759 
	gcs
->
	g”r
 = 0;

15761 
	gcs
->
	g”r
 = 
»s
;

15762 ià(
	g£rv”_side
) {

15763 
mg_lw_po¡_sigÇl
(
MG_SIG_CLOSE_CONN
, 
nc
);

15765 
mg_lw_po¡_sigÇl
(
MG_SIG_CONNECT_RESULT
, 
nc
);

15769 
	gcs
->
	g”r
 = 0;

15770 
	gnc
->
	gæags
 &ğ~
MG_F_WANT_WRITE
;

15775 
	gnc
->
	gæags
 |ğ(
MG_F_SSL_HANDSHAKE_DONE
 | 
MG_F_WANT_READ
);

15776 ià(
	g£rv”_side
) {

15777 
mg_lw_acû±_cÚn
(
nc
, 
cs
->
pcb
.
tı
);

15779 
mg_lw_po¡_sigÇl
(
MG_SIG_CONNECT_RESULT
, 
nc
);

15784 
mg_lw_s¦_£nd
(
mg_cÚÃùiÚ
 *
nc
) {

15785 ià(
	gnc
->
	gsock
 =ğ
INVALID_SOCKET
) {

15786 
DBG
(("%°šv®id sock‘", 
nc
));

15789 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

15791 
	gËn
 = 
cs
->
Ï¡_s¦_wr™e_size
;

15792 ià(
	gËn
 == 0) {

15793 
Ën
 = 
MIN
(
MG_LWIP_SSL_IO_SIZE
, 
nc
->
£nd_mbuf
.len);

15795 
	g»t
 = 
mg_s¦_if_wr™e
(
nc
,‚c->
£nd_mbuf
.
buf
, 
Ën
);

15796 
DBG
(("%°SSL_wr™%u = %d", 
nc
, 
Ën
, 
»t
));

15797 ià(
	g»t
 > 0) {

15798 
mg_if_£Á_cb
(
nc
, 
»t
);

15799 
	gcs
->
	gÏ¡_s¦_wr™e_size
 = 0;

15800 } ià(
	g»t
 < 0) {

15803 
	gcs
->
	gÏ¡_s¦_wr™e_size
 = 
Ën
;

15805 ià(
	g»t
 =ğ
Ën
) {

15806 
nc
->
æags
 &ğ~
MG_F_WANT_WRITE
;

15807 } ià(
	g»t
 =ğ
MG_SSL_WANT_WRITE
) {

15808 
nc
->
æags
 |ğ
MG_F_WANT_WRITE
;

15810 
mg_lw_po¡_sigÇl
(
MG_SIG_CLOSE_CONN
, 
nc
);

15814 
mg_lw_s¦_»cv
(
mg_cÚÃùiÚ
 *
nc
) {

15815 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

15817 ià(
	gnc
->
	gæags
 & 
	gMG_F_CONNECTING
) ;

15818 
	gnc
->
	g»cv_mbuf
.
	gËn
 < 
	gMG_LWIP_SSL_RECV_MBUF_LIMIT
) {

15819 *
	gbuf
 = (*è
MG_MALLOC
(
MG_LWIP_SSL_IO_SIZE
);

15820 ià(
	gbuf
 =ğ
NULL
) ;

15821 
	g»t
 = 
mg_s¦_if_»ad
(
nc
, 
buf
, 
MG_LWIP_SSL_IO_SIZE
);

15822 
DBG
(("%°%°SSL_»ad %u = %d", 
nc
, 
cs
->
rx_chaš
, 
MG_LWIP_SSL_IO_SIZE
, 
»t
));

15823 ià(
	g»t
 <= 0) {

15824 
MG_FREE
(
buf
);

15825 ià(
	g»t
 =ğ
MG_SSL_WANT_WRITE
) {

15826 
nc
->
æags
 |ğ
MG_F_WANT_WRITE
;

15828 } ià(
	g»t
 =ğ
MG_SSL_WANT_READ
) {

15833 
nc
->
æags
 &ğ~
MG_F_WANT_READ
;

15834 
	gcs
->
	g”r
 = 0;

15837 
mg_lw_po¡_sigÇl
(
MG_SIG_CLOSE_CONN
, 
nc
);

15841 
mg_if_»cv_tı_cb
(
nc
, 
buf
, 
»t
, 1 );

15846 #ifdeà
KR_VERSION


15848 
ssize_t
 
kr_£nd
(
fd
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

15849 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
fd
;

15850 
	g»t
 = 
mg_lw_tı_wr™e
(
cs
->
nc
, 
buf
, 
Ën
);

15851 
DBG
(("%°mg_lw_tı_wr™%u = %d", 
cs
->
nc
, 
Ën
, 
»t
));

15852 ià(
	g»t
 =ğ0è
»t
 = 
KR_IO_WOULDBLOCK
;

15853  
	g»t
;

15856 
ssize_t
 
kr_»cv
(
fd
, *
buf
, 
size_t
 
Ën
) {

15857 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
fd
;

15858 
pbuf
 *
	g£g
 = 
cs
->
rx_chaš
;

15859 ià(
	g£g
 =ğ
NULL
) {

15860 
DBG
(("%u -‚ÙhšgØ»ad", 
Ën
));

15861  
	gKR_IO_WOULDBLOCK
;

15863 
size_t
 
	g£g_Ën
 = (
£g
->
Ën
 - 
cs
->
rx_off£t
);

15864 
DBG
(("%u %u %u %u", 
Ën
, 
cs
->
rx_chaš
->Ën, 
£g_Ën
, cs->rx_chaš->
tÙ_Ën
));

15865 
	gËn
 = 
MIN
(
Ën
, 
£g_Ën
);

15866 
pbuf_cİy_·¹Ÿl
(
£g
, 
buf
, 
Ën
, 
cs
->
rx_off£t
);

15867 
	gcs
->
	grx_off£t
 +ğ
Ën
;

15868 
tı_»cved
(
cs
->
pcb
.
tı
, 
Ën
);

15869 ià(
	gcs
->
	grx_off£t
 =ğ
cs
->
rx_chaš
->
Ën
) {

15870 
cs
->
rx_chaš
 = 
pbuf_dechaš
(cs->rx_chain);

15871 
pbuf_ä“
(
£g
);

15872 
	gcs
->
	grx_off£t
 = 0;

15874  
	gËn
;

15877 #–ià
MG_SSL_IF
 =ğ
MG_SSL_IF_MBEDTLS


15879 
s¦_sock‘_£nd
(*
ùx
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

15880 
mg_cÚÃùiÚ
 *
	gnc
 = (mg_cÚÃùiÚ *è
ùx
;

15881 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

15882 
	g»t
 = 
mg_lw_tı_wr™e
(
cs
->
nc
, 
buf
, 
Ën
);

15883 ià(
	g»t
 =ğ0è
»t
 = 
MBEDTLS_ERR_SSL_WANT_WRITE
;

15884 
LOG
(
LL_DEBUG
, ("%°%d -> %d", 
nc
, 
Ën
, 
»t
));

15885  
	g»t
;

15888 
s¦_sock‘_»cv
(*
ùx
, *
buf
, 
size_t
 
Ën
) {

15889 
mg_cÚÃùiÚ
 *
	gnc
 = (mg_cÚÃùiÚ *è
ùx
;

15890 
mg_lw_cÚn_¡©e
 *
	gcs
 = (mg_lw_cÚn_¡©*è
nc
->
sock
;

15891 
pbuf
 *
	g£g
 = 
cs
->
rx_chaš
;

15892 ià(
	g£g
 =ğ
NULL
) {

15893 
DBG
(("%u -‚ÙhšgØ»ad", 
Ën
));

15894  
	gMBEDTLS_ERR_SSL_WANT_READ
;

15896 
size_t
 
	g£g_Ën
 = (
£g
->
Ën
 - 
cs
->
rx_off£t
);

15897 
DBG
(("%u %u %u %u", 
Ën
, 
cs
->
rx_chaš
->Ën, 
£g_Ën
, cs->rx_chaš->
tÙ_Ën
));

15898 
mgos_lock
();

15899 
	gËn
 = 
MIN
(
Ën
, 
£g_Ën
);

15900 
pbuf_cİy_·¹Ÿl
(
£g
, 
buf
, 
Ën
, 
cs
->
rx_off£t
);

15901 
	gcs
->
	grx_off£t
 +ğ
Ën
;

15904 ià(
	gcs
->
	gpcb
.
	gtı
 !ğ
NULL
è
tı_»cved
(
cs
->
pcb
.
tı
, 
Ën
);

15905 ià(
	gcs
->
	grx_off£t
 =ğ
cs
->
rx_chaš
->
Ën
) {

15906 
cs
->
rx_chaš
 = 
pbuf_dechaš
(cs->rx_chain);

15907 
pbuf_ä“
(
£g
);

15908 
	gcs
->
	grx_off£t
 = 0;

15910 
mgos_uÆock
();

15911 
LOG
(
LL_DEBUG
, ("%°<- %d", 
nc
, (è
Ën
));

15912  
	gËn
;

15918 #ifdeà
MG_MODULE_LINES


15926 #ifdeà
WINCE


15928 cÚ¡ *
¡»¼Ü
(
”r
) {

15933 
	gbuf
[10];

15934 
¢´štf
(
buf
, (buf), "%d", 
”r
);

15935  
	gbuf
;

15938 
İ’
(cÚ¡ *
f’ame
, 
oæag
, 
pmode
) {

15944 
DebugB»ak
();

15948 
_w¡©i64
(cÚ¡ 
wch¬_t
 *
·th
, 
cs_¡©_t
 *
¡
) {

15949 
DWORD
 
	gç
 = 
G‘FeA‰ribu‹sW
(
·th
);

15950 ià(
	gç
 =ğ
INVALID_FILE_ATTRIBUTES
) {

15953 
mem£t
(
¡
, 0, (*st));

15954 ià((
	gç
 & 
	gFILE_ATTRIBUTE_DIRECTORY
) == 0) {

15955 
HANDLE
 
h
;

15956 
FILETIME
 
	gáime
;

15957 
	g¡
->
	g¡_mode
 |ğ
_S_IFREG
;

15958 
	gh
 = 
C»©eFeW
(
·th
, 
GENERIC_READ
, 0, 
NULL
, 
OPEN_EXISTING
,

15959 
FILE_ATTRIBUTE_NORMAL
, 
NULL
);

15960 ià(
	gh
 =ğ
INVALID_HANDLE_VALUE
) {

15963 
	g¡
->
	g¡_size
 = 
G‘FeSize
(
h
, 
NULL
);

15964 
G‘FeTime
(
h
, 
NULL
, NULL, &
áime
);

15965 
	g¡
->
	g¡_mtime
 = (
ušt32_t
)((((
ušt64_t
è
áime
.
dwLowD©eTime
 +

15966 ((
ušt64_t
è
áime
.
dwHighD©eTime
 << 32)) /

15969 
Clo£HªdË
(
h
);

15971 
	g¡
->
	g¡_mode
 |ğ
_S_IFDIR
;

15977 
mg_gmt_time_¡ršg
(*
buf
, 
size_t
 
buf_Ën
, 
time_t
 *
t
) {

15978 
FILETIME
 
	gá
;

15979 
SYSTEMTIME
 
	gsy¡ime
;

15980 ià(
	gt
 !ğ
NULL
) {

15981 
ušt64_t
 
f‘ime
 = (*
t
 + 11644473600) * 10000000;

15982 
	gá
.
	gdwLowD©eTime
 = 
f‘ime
 & 0xFFFFFFFF;

15983 
	gá
.
	gdwHighD©eTime
 = (
f‘ime
 & 0xFFFFFFFF00000000) >> 32;

15984 
FeTimeToSy¡emTime
(&
á
, &
sy¡ime
);

15986 
G‘Sy¡emTime
(&
sy¡ime
);

15989 
¢´štf
(
buf
, 
buf_Ën
, "%d.%d.%d %d:%d:%d GMT", (è
sy¡ime
.
wY—r
,

15990 (è
sy¡ime
.
wMÚth
, (èsy¡ime.
wDay
, (èsy¡ime.
wHour
,

15991 (è
sy¡ime
.
wMšu‹
, (èsy¡ime.
wSecÚd
);

15995 #ifdeà
MG_MODULE_LINES


16003 #iâdeà
CS_COMMON_PLATFORMS_PIC32_NET_IF_H_


16004 
	#CS_COMMON_PLATFORMS_PIC32_NET_IF_H_


	)

16008 #ifdeà
__ılu¥lus


16012 #iâdeà
MG_ENABLE_NET_IF_PIC32


16013 
	#MG_ENABLE_NET_IF_PIC32
 
MG_NET_IF
 =ğ
MG_NET_IF_PIC32


	)

16016 cÚ¡ 
mg_içû_vbË
 
mg_pic32_içû_vbË
;

16018 #ifdeà
__ılu¥lus


16023 #ifdeà
MG_MODULE_LINES


16031 #ià
MG_ENABLE_NET_IF_PIC32


16033 
mg_pic32_if_ü—‹_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

16034 (è
	gnc
;

16038 
mg_pic32_if_»cved
(
mg_cÚÃùiÚ
 *
nc
, 
size_t
 
Ën
) {

16039 (è
	gnc
;

16040 (è
	gËn
;

16043 
mg_pic32_if_add_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

16044 (è
	gnc
;

16047 
mg_pic32_if_š™
(
mg_içû
 *
içû
) {

16048 (è
	giçû
;

16049 (è
mg_g‘_”ºo
();

16052 
mg_pic32_if_ä“
(
mg_içû
 *
içû
) {

16053 (è
	giçû
;

16056 
mg_pic32_if_»move_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

16057 (è
	gnc
;

16060 
mg_pic32_if_de¡roy_cÚn
(
mg_cÚÃùiÚ
 *
nc
) {

16061 ià(
	gnc
->
	gsock
 =ğ
INVALID_SOCKET
) ;

16063 ià(!(
	gnc
->
	gæags
 & 
	gMG_F_UDP
)) {

16065 
TCPIP_TCP_Clo£
((
TCP_SOCKET
è
nc
->
sock
);

16066 } ià(
	gnc
->
	gli¡’”
 =ğ
NULL
) {

16068 
TCPIP_UDP_Clo£
((
UDP_SOCKET
è
nc
->
sock
);

16071 
	gnc
->
	gsock
 = 
INVALID_SOCKET
;

16074 
mg_pic32_if_li¡’_udp
(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
) {

16075 
	gnc
->
	gsock
 = 
TCPIP_UDP_S”v”O³n
(

16076 
§
->
sš
.
sš_çmy
 =ğ
AF_INET
 ? 
IP_ADDRESS_TYPE_IPV4


16077 : 
IP_ADDRESS_TYPE_IPV6
,

16078 
Áohs
(
§
->
sš
.
sš_pÜt
),

16079 
§
->
sš
.
sš_addr
.
s_addr
 =ğ0 ? 0 : (
IP_MULTI_ADDRESS
 *) &sa->sin);

16080 ià(
	gnc
->
	gsock
 =ğ
INVALID_SOCKET
) {

16086 
mg_pic32_if_udp_£nd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
,

16087 
size_t
 
Ën
) {

16088 
mbuf_­³nd
(&
nc
->
£nd_mbuf
, 
buf
, 
Ën
);

16091 
mg_pic32_if_tı_£nd
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
,

16092 
size_t
 
Ën
) {

16093 
mbuf_­³nd
(&
nc
->
£nd_mbuf
, 
buf
, 
Ën
);

16096 
mg_pic32_if_li¡’_tı
(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
) {

16097 
	gnc
->
	gsock
 = 
TCPIP_TCP_S”v”O³n
(

16098 
§
->
sš
.
sš_çmy
 =ğ
AF_INET
 ? 
IP_ADDRESS_TYPE_IPV4


16099 : 
IP_ADDRESS_TYPE_IPV6
,

16100 
Áohs
(
§
->
sš
.
sš_pÜt
),

16101 
§
->
sš
.
sš_addr
.
s_addr
 =ğ0 ? 0 : (
IP_MULTI_ADDRESS
 *) &sa->sin);

16102 
memıy
(&
nc
->
§
, sa, (*sa));

16103 ià(
	gnc
->
	gsock
 =ğ
INVALID_SOCKET
) {

16109 
mg_acû±_cÚn
(
mg_cÚÃùiÚ
 *
lc
) {

16110 
mg_cÚÃùiÚ
 *
	gnc
;

16111 
TCP_SOCKET_INFO
 
	gsi
;

16112 
sock‘_add»ss
 
	g§
;

16114 
	gnc
 = 
mg_if_acû±_Ãw_cÚn
(
lc
);

16116 ià(
	gnc
 =ğ
NULL
) {

16120 
	gnc
->
	gsock
 = 
lc
->
sock
;

16121 
	gnc
->
	gæags
 &ğ~
MG_F_LISTENING
;

16123 ià(!
TCPIP_TCP_Sock‘InfoG‘
((
TCP_SOCKET
è
nc
->
sock
, &
si
)) {

16127 ià(
	gsi
.
	gadd»ssTy³
 =ğ
IP_ADDRESS_TYPE_IPV4
) {

16128 
§
.
sš
.
sš_çmy
 = 
AF_INET
;

16129 
	g§
.
	gsš
.
	gsš_pÜt
 = 
htÚs
(
si
.
»mÙePÜt
);

16130 
	g§
.
	gsš
.
	gsš_addr
.
	gs_addr
 = 
si
.
»mÙeIPadd»ss
.
v4Add
.
V®
;

16133 
mem£t
(&
§
, 0, (sa));

16136 
mg_if_acû±_tı_cb
(
nc
, (
sock‘_add»ss
 *è&
§
, (sa));

16138  
mg_pic32_if_li¡’_tı
(
lc
, &lc->
§
) >= 0;

16141 *
š‘_Áß
(
š_addr
 
š
) {

16142 
	gaddr
[17];

16143 
¢´štf
(
addr
, ×ddr), "%d.%d.%d.%d", (è
š
.
S_un
.
S_un_b
.
s_b1
,

16144 (è
š
.
S_un
.
S_un_b
.
s_b2
, (èš.S_un.S_un_b.
s_b3
,

16145 (è
š
.
S_un
.
S_un_b
.
s_b4
);

16146  
	gaddr
;

16149 
mg_hªdË_£nd
(
mg_cÚÃùiÚ
 *
nc
) {

16150 
ušt16_t
 
	gby‹s_wr™‹n
 = 0;

16151 ià(
	gnc
->
	gæags
 & 
	gMG_F_UDP
) {

16152 ià(!
TCPIP_UDP_RemÙeBšd
(

16153 (
UDP_SOCKET
è
nc
->
sock
,

16154 
nc
->
§
.
sš
.
sš_çmy
 =ğ
AF_INET
 ? 
IP_ADDRESS_TYPE_IPV4


16155 : 
IP_ADDRESS_TYPE_IPV6
,

16156 
Áohs
(
nc
->
§
.
sš
.
sš_pÜt
), (
IP_MULTI_ADDRESS
 *) &nc->sa.sin)) {

16157 
	gnc
->
	gæags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

16160 
	gby‹s_wr™‹n
 = 
TCPIP_UDP_TxPutIsR—dy
((
UDP_SOCKET
è
nc
->
sock
, 0);

16161 ià(
	gby‹s_wr™‹n
 >ğ
nc
->
£nd_mbuf
.
Ën
) {

16162 ià(
TCPIP_UDP_A¼ayPut
((
UDP_SOCKET
è
nc
->
sock
,

16163 (
ušt8_t
 *è
nc
->
£nd_mbuf
.
buf
,

16164 
nc
->
£nd_mbuf
.
Ën
) !=‚c->send_mbuf.len) {

16165 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

16166 
	gby‹s_wr™‹n
 = 0;

16170 
	gby‹s_wr™‹n
 = 
TCPIP_TCP_FifoTxF»eG‘
((
TCP_SOCKET
è
nc
->
sock
);

16171 ià(
	gby‹s_wr™‹n
 != 0) {

16172 ià(
by‹s_wr™‹n
 > 
nc
->
£nd_mbuf
.
Ën
) {

16173 
by‹s_wr™‹n
 = 
nc
->
£nd_mbuf
.
Ën
;

16175 ià(
TCPIP_TCP_A¼ayPut
((
TCP_SOCKET
è
nc
->
sock
,

16176 (
ušt8_t
 *è
nc
->
£nd_mbuf
.
buf
,

16177 
by‹s_wr™‹n
) != bytes_written) {

16178 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

16179 
	gby‹s_wr™‹n
 = 0;

16184 
mg_if_£Á_cb
(
nc
, 
by‹s_wr™‹n
);

16187 
mg_hªdË_»cv
(
mg_cÚÃùiÚ
 *
nc
) {

16188 
ušt16_t
 
	gby‹s_»ad
 = 0;

16189 
ušt8_t
 *
	gbuf
 = 
NULL
;

16190 ià(
	gnc
->
	gæags
 & 
	gMG_F_UDP
) {

16191 
	gby‹s_»ad
 = 
TCPIP_UDP_G‘IsR—dy
((
UDP_SOCKET
è
nc
->
sock
);

16192 ià(
	gby‹s_»ad
 != 0 &&

16193 (
nc
->
»cv_mbuf_lim™
 == -1 ||

16194 
nc
->
»cv_mbuf
.
Ën
 + 
by‹s_»ad
 <‚c->
»cv_mbuf_lim™
)) {

16195 
buf
 = (
ušt8_t
 *è
MG_MALLOC
(
by‹s_»ad
);

16196 ià(
TCPIP_UDP_A¼ayG‘
((
UDP_SOCKET
è
nc
->
sock
, 
buf
, 
by‹s_»ad
) !=

16197 
by‹s_»ad
) {

16198 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

16199 
	gby‹s_»ad
 = 0;

16200 
MG_FREE
(
buf
);

16204 
	gby‹s_»ad
 = 
TCPIP_TCP_G‘IsR—dy
((
TCP_SOCKET
è
nc
->
sock
);

16205 ià(
	gby‹s_»ad
 != 0) {

16206 ià(
nc
->
»cv_mbuf_lim™
 != -1 &&

16207 
nc
->
»cv_mbuf_lim™
 -‚c->
»cv_mbuf
.
Ën
 > 
by‹s_»ad
) {

16208 
by‹s_»ad
 = 
nc
->
»cv_mbuf_lim™
 -‚c->
»cv_mbuf
.
Ën
;

16210 
	gbuf
 = (
ušt8_t
 *è
MG_MALLOC
(
by‹s_»ad
);

16211 ià(
TCPIP_TCP_A¼ayG‘
((
TCP_SOCKET
è
nc
->
sock
, 
buf
, 
by‹s_»ad
) !=

16212 
by‹s_»ad
) {

16213 
nc
->
æags
 |ğ
MG_F_CLOSE_IMMEDIATELY
;

16214 
MG_FREE
(
buf
);

16215 
	gby‹s_»ad
 = 0;

16220 ià(
	gby‹s_»ad
 != 0) {

16221 
mg_if_»cv_tı_cb
(
nc
, 
buf
, 
by‹s_»ad
, 1 );

16225 
time_t
 
mg_pic32_if_pŞl
(
mg_içû
 *
içû
, 
timeout_ms
) {

16226 
mg_mgr
 *
	gmgr
 = 
içû
->
mgr
;

16227 
	gnow
 = 
mg_time
();

16228 
mg_cÚÃùiÚ
 *
	gnc
, *
	gtmp
;

16230 
	gnc
 = 
mgr
->
aùive_cÚÃùiÚs
;‚ø!ğ
NULL
;‚øğ
tmp
) {

16231 
tmp
 = 
nc
->
Ãxt
;

16233 ià(
	gnc
->
	gæags
 & 
	gMG_F_CONNECTING
) {

16235 ià(
	gnc
->
	gæags
 & 
	gMG_F_UDP
 ||

16236 
TCPIP_TCP_IsCÚÃùed
((
TCP_SOCKET
è
nc
->
sock
)) {

16237 
mg_if_cÚÃù_cb
(
nc
, 0);

16239 } ià(
	gnc
->
	gæags
 & 
	gMG_F_LISTENING
) {

16240 ià(
TCPIP_TCP_IsCÚÃùed
((
TCP_SOCKET
è
nc
->
sock
)) {

16242 
mg_acû±_cÚn
(
nc
);

16245 ià(
	gnc
->
	g£nd_mbuf
.
	gËn
 != 0) {

16246 
mg_hªdË_£nd
(
nc
);

16249 ià(
	gnc
->
	g»cv_mbuf_lim™
 == -1 ||

16250 
nc
->
»cv_mbuf
.
Ën
 <‚c->
»cv_mbuf_lim™
) {

16251 
mg_hªdË_»cv
(
nc
);

16256 
	gnc
 = 
mgr
->
aùive_cÚÃùiÚs
;‚ø!ğ
NULL
;‚øğ
tmp
) {

16257 
tmp
 = 
nc
->
Ãxt
;

16258 ià((
	gnc
->
	gæags
 & 
	gMG_F_CLOSE_IMMEDIATELY
) ||

16259 (
	gnc
->
	g£nd_mbuf
.
	gËn
 =ğ0 && (
nc
->
æags
 & 
MG_F_SEND_AND_CLOSE
))) {

16260 
mg_şo£_cÚn
(
nc
);

16264  
	gnow
;

16267 
mg_pic32_if_sock_£t
(
mg_cÚÃùiÚ
 *
nc
, 
sock_t
 
sock
) {

16268 
	gnc
->
	gsock
 = 
sock
;

16271 
mg_pic32_if_g‘_cÚn_addr
(
mg_cÚÃùiÚ
 *
nc
, 
»mÙe
,

16272 
sock‘_add»ss
 *
§
) {

16276 
mg_pic32_if_cÚÃù_tı
(
mg_cÚÃùiÚ
 *
nc
,

16277 cÚ¡ 
sock‘_add»ss
 *
§
) {

16278 
	gnc
->
	gsock
 = 
TCPIP_TCP_Cl›ÁO³n
(

16279 
§
->
sš
.
sš_çmy
 =ğ
AF_INET
 ? 
IP_ADDRESS_TYPE_IPV4


16280 : 
IP_ADDRESS_TYPE_IPV6
,

16281 
Áohs
(
§
->
sš
.
sš_pÜt
), (
IP_MULTI_ADDRESS
 *) &sa->sin);

16282 
	gnc
->
	g”r
 = (
nc
->
sock
 =ğ
INVALID_SOCKET
) ? -1 : 0;

16285 
mg_pic32_if_cÚÃù_udp
(
mg_cÚÃùiÚ
 *
nc
) {

16286 
	gnc
->
	gsock
 = 
TCPIP_UDP_Cl›ÁO³n
(
IP_ADDRESS_TYPE_ANY
, 0, 
NULL
);

16287 
	gnc
->
	g”r
 = (
nc
->
sock
 =ğ
INVALID_SOCKET
) ? -1 : 0;

16291 
	#MG_PIC32_IFACE_VTABLE
 \

16293 
mg_pic32_if_š™
, \

16294 
mg_pic32_if_ä“
, \

16295 
mg_pic32_if_add_cÚn
, \

16296 
mg_pic32_if_»move_cÚn
, \

16297 
mg_pic32_if_pŞl
, \

16298 
mg_pic32_if_li¡’_tı
, \

16299 
mg_pic32_if_li¡’_udp
, \

16300 
mg_pic32_if_cÚÃù_tı
, \

16301 
mg_pic32_if_cÚÃù_udp
, \

16302 
mg_pic32_if_tı_£nd
, \

16303 
mg_pic32_if_udp_£nd
, \

16304 
mg_pic32_if_»cved
, \

16305 
mg_pic32_if_ü—‹_cÚn
, \

16306 
mg_pic32_if_de¡roy_cÚn
, \

16307 
mg_pic32_if_sock_£t
, \

16308 
mg_pic32_if_g‘_cÚn_addr
, \

16309 }

	)

16312 cÚ¡ 
mg_içû_vbË
 
	gmg_pic32_içû_vbË
 = 
MG_PIC32_IFACE_VTABLE
;

16313 #ià
MG_NET_IF
 =ğ
MG_NET_IF_PIC32


16314 cÚ¡ 
mg_içû_vbË
 
	gmg_deçuÉ_içû_vbË
 = 
MG_PIC32_IFACE_VTABLE
;

16318 #ifdeà
MG_MODULE_LINES


16326 #ifdeà
_WIN32


16328 
rmdœ
(cÚ¡ *
dœÇme
) {

16329  
_rmdœ
(
dœÇme
);

16332 
¦“p
(
£cÚds
) {

16333 
SË•
(
£cÚds
 * 1000);

	@mongoose.h

1 #ifdeà
MG_MODULE_LINES


23 #iâdeà
CS_MONGOOSE_SRC_COMMON_H_


24 
	#CS_MONGOOSE_SRC_COMMON_H_


	)

26 
	#MG_VERSION
 "6.10"

	)

29 #ifdeà
MG_LOCALS


30 
	~<mg_loÿls.h
>

34 #ifdeà
MG_MODULE_LINES


37 #iâdeà
CS_COMMON_PLATFORM_H_


38 
	#CS_COMMON_PLATFORM_H_


	)

44 
	#CS_P_CUSTOM
 0

	)

45 
	#CS_P_UNIX
 1

	)

46 
	#CS_P_WINDOWS
 2

	)

47 
	#CS_P_ESP32
 15

	)

48 
	#CS_P_ESP8266
 3

	)

49 
	#CS_P_CC3100
 6

	)

50 
	#CS_P_CC3200
 4

	)

51 
	#CS_P_CC3220
 17

	)

52 
	#CS_P_MSP432
 5

	)

53 
	#CS_P_TM4C129
 14

	)

54 
	#CS_P_MBED
 7

	)

55 
	#CS_P_WINCE
 8

	)

56 
	#CS_P_NXP_LPC
 13

	)

57 
	#CS_P_NXP_KINETIS
 9

	)

58 
	#CS_P_NRF51
 12

	)

59 
	#CS_P_NRF52
 10

	)

60 
	#CS_P_PIC32
 11

	)

61 
	#CS_P_STM32
 16

	)

65 #iâdeà
CS_PLATFORM


67 #ià
defšed
(
TARGET_IS_MSP432P4XX
è|| defšed(
__MSP432P401R__
)

68 
	#CS_PLATFORM
 
CS_P_MSP432


	)

69 #–ià
defšed
(
cc3200
è|| defšed(
TARGET_IS_CC3200
)

70 
	#CS_PLATFORM
 
CS_P_CC3200


	)

71 #–ià
defšed
(
cc3220
è|| defšed(
TARGET_IS_CC3220
)

72 
	#CS_PLATFORM
 
CS_P_CC3220


	)

73 #–ià
defšed
(
__unix__
è|| defšed(
__APPLE__
)

74 
	#CS_PLATFORM
 
CS_P_UNIX


	)

75 #–ià
defšed
(
WINCE
)

76 
	#CS_PLATFORM
 
CS_P_WINCE


	)

77 #–ià
defšed
(
_WIN32
)

78 
	#CS_PLATFORM
 
CS_P_WINDOWS


	)

79 #–ià
defšed
(
__MBED__
)

80 
	#CS_PLATFORM
 
CS_P_MBED


	)

81 #–ià
defšed
(
__USE_LPCOPEN
)

82 
	#CS_PLATFORM
 
CS_P_NXP_LPC


	)

83 #–ià
defšed
(
FRDM_K64F
è|| defšed(
FREEDOM
)

84 
	#CS_PLATFORM
 
CS_P_NXP_KINETIS


	)

85 #–ià
defšed
(
PIC32
)

86 
	#CS_PLATFORM
 
CS_P_PIC32


	)

87 #–ià
defšed
(
ESP_PLATFORM
)

88 
	#CS_PLATFORM
 
CS_P_ESP32


	)

89 #–ià
defšed
(
ICACHE_FLASH
)

90 
	#CS_PLATFORM
 
CS_P_ESP8266


	)

91 #–ià
defšed
(
TARGET_IS_TM4C129_RA0
è|| defšed(
TARGET_IS_TM4C129_RA1
) || \

92 
	$defšed
(
TARGET_IS_TM4C129_RA2
)

93 
	#CS_PLATFORM
 
CS_P_TM4C129


	)

94 #–ià
	`defšed
(
STM32
)

95 
	#CS_PLATFORM
 
CS_P_STM32


	)

98 #iâdeà
CS_PLATFORM


104 
	#MG_NET_IF_SOCKET
 1

	)

105 
	#MG_NET_IF_SIMPLELINK
 2

	)

106 
	#MG_NET_IF_LWIP_LOW_LEVEL
 3

	)

107 
	#MG_NET_IF_PIC32
 4

	)

109 
	#MG_SSL_IF_OPENSSL
 1

	)

110 
	#MG_SSL_IF_MBEDTLS
 2

	)

111 
	#MG_SSL_IF_SIMPLELINK
 3

	)

131 #ià!
	`defšed
(
WEAK
)

132 #ià(
	`defšed
(
__GNUC__
è|| defšed(
__TI_COMPILER_VERSION__
)è&& !defšed(
_WIN32
)

133 
	#WEAK
 
	`__©Œibu‹__
((
w—k
))

	)

135 
	#WEAK


	)

139 #ifdeà
__GNUC__


140 
	#NORETURN
 
	`__©Œibu‹__
((
nÜ‘uº
))

	)

141 
	#NOINLINE
 
	`__©Œibu‹__
((
nošlše
))

	)

142 
	#WARN_UNUSED_RESULT
 
	`__©Œibu‹__
((
w¬n_unu£d_»suÉ
))

	)

143 
	#NOINSTR
 
	`__©Œibu‹__
((
no_š¡rum’t_funùiÚ
))

	)

144 
	#DO_NOT_WARN_UNUSED
 
	`__©Œibu‹__
((
unu£d
))

	)

146 
	#NORETURN


	)

147 
	#NOINLINE


	)

148 
	#WARN_UNUSED_RESULT


	)

149 
	#NOINSTR


	)

150 
	#DO_NOT_WARN_UNUSED


	)

153 #iâdeà
ARRAY_SIZE


154 
	#ARRAY_SIZE
(
¬¿y
è(×¼ayè/ ×¼ay[0]))

	)

158 #ifdeà
MG_MODULE_LINES


161 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_WINDOWS_H_


162 
	#CS_COMMON_PLATFORMS_PLATFORM_WINDOWS_H_


	)

163 #ià
CS_PLATFORM
 =ğ
CS_P_WINDOWS


177 #ifdeà
_MSC_VER


178 #´agm¨
	`w¬nšg
(
di§bË
 : 4127)

179 #´agm¨
	`w¬nšg
(
di§bË
 : 4204)

182 #iâdeà
_WINSOCK_DEPRECATED_NO_WARNINGS


183 
	#_WINSOCK_DEPRECATED_NO_WARNINGS
 1

	)

186 #iâdeà
_CRT_SECURE_NO_WARNINGS


187 
	#_CRT_SECURE_NO_WARNINGS


	)

190 
	~<as£¹.h
>

191 
	~<dœeù.h
>

192 
	~<”ºo.h
>

193 
	~<fú.h
>

194 
	~<io.h
>

195 
	~<lim™s.h
>

196 
	~<sigÇl.h
>

197 
	~<¡ddef.h
>

198 
	~<¡dio.h
>

199 
	~<¡dlib.h
>

200 
	~<sys/¡©.h
>

201 
	~<time.h
>

202 
	~<ùy³.h
>

204 #ifdeà
_MSC_VER


205 #´agm¨
	`comm’t
(
lib
, "ws2_32.lib")

208 
	~<wšsock2.h
>

209 
	~<ws2tı.h
>

210 
	~<wšdows.h
>

211 
	~<´oûss.h
>

213 #ià
_MSC_VER
 < 1700

214 
	tboŞ
;

216 
	~<¡dboŞ.h
>

219 #ià
	`defšed
(
_MSC_VER
) && _MSC_VER >= 1800

220 
	#¡rdup
 
_¡rdup


	)

223 #iâdeà
EINPROGRESS


224 
	#EINPROGRESS
 
WSAEINPROGRESS


	)

226 #iâdeà
EWOULDBLOCK


227 
	#EWOULDBLOCK
 
WSAEWOULDBLOCK


	)

229 #iâdeà
__func__


230 
	#STRX
(
x
è#x

	)

231 
	#STR
(
x
è
	`STRX
(x)

	)

232 
	#__func__
 
__FILE__
 ":" 
	`STR
(
__LINE__
)

	)

234 
	#¢´štf
 
_¢´štf


	)

235 
	#v¢´štf
 
_v¢´štf


	)

236 
	#to64
(
x
è
	`_©oi64
(x)

	)

237 #ià!
	`defšed
(
__MINGW32__
è&& !defšed(
__MINGW64__
)

238 
	#pİ’
(
x
, 
y
è
	`_pİ’
((x), (y))

	)

239 
	#pşo£
(
x
è
	`_pşo£
(x)

	)

240 
	#f’o
 
_f’o


	)

242 #ià
	`defšed
(
_MSC_VER
) && _MSC_VER >= 1400

243 
	#f£eko
(
x
, 
y
, 
z
è
	`_f£eki64
((x), (y), (z))

	)

245 
	#f£eko
(
x
, 
y
, 
z
è
	`f£ek
((x), (y), (z))

	)

247 #ià
	`defšed
(
_MSC_VER
) && _MSC_VER <= 1200

248 
	tušŒ_t
;

249 
	tšŒ_t
;

251 
	tsockËn_t
;

252 #ià
_MSC_VER
 >= 1700

253 
	~<¡dšt.h
>

255 sigÃd 
	tšt8_t
;

256 
	tušt8_t
;

257 
	tšt32_t
;

258 
	tušt32_t
;

259 
	tšt16_t
;

260 
	tušt16_t
;

261 
__št64
 
	tšt64_t
;

262 
	t__št64
 
	tušt64_t
;

264 
SOCKET
 
	tsock_t
;

265 
ušt32_t
 
	tš_addr_t
;

266 #iâdeà
UINT16_MAX


267 
	#UINT16_MAX
 65535

	)

269 #iâdeà
UINT32_MAX


270 
	#UINT32_MAX
 4294967295

	)

272 #iâdeà
pid_t


273 
	#pid_t
 
HANDLE


	)

275 
	#INT64_FMT
 "I64d"

	)

276 
	#INT64_X_FMT
 "I64x"

	)

277 
	#SIZE_T_FMT
 "Iu"

	)

278 
_¡©i64
 
	tcs_¡©_t
;

279 #iâdeà
S_ISDIR


280 
	#S_ISDIR
(
x
è(((xè&
_S_IFMT
è=ğ
_S_IFDIR
)

	)

282 #iâdeà
S_ISREG


283 
	#S_ISREG
(
x
è(((xè&
_S_IFMT
è=ğ
_S_IFREG
)

	)

285 
	#DIRSEP
 '\\'

	)

286 
	#CS_DEFINE_DIRENT


	)

288 #iâdeà
va_cİy


289 #ifdeà
__va_cİy


290 
	#va_cİy
 
__va_cİy


	)

292 
	#va_cİy
(
x
, 
y
è(xèğ(y)

	)

296 #iâdeà
MG_MAX_HTTP_REQUEST_SIZE


297 
	#MG_MAX_HTTP_REQUEST_SIZE
 8192

	)

300 #iâdeà
MG_MAX_HTTP_SEND_MBUF


301 
	#MG_MAX_HTTP_SEND_MBUF
 4096

	)

304 #iâdeà
MG_MAX_HTTP_HEADERS


305 
	#MG_MAX_HTTP_HEADERS
 40

	)

308 #iâdeà
CS_ENABLE_STDIO


309 
	#CS_ENABLE_STDIO
 1

	)

312 #iâdeà
MG_ENABLE_BROADCAST


313 
	#MG_ENABLE_BROADCAST
 1

	)

316 #iâdeà
MG_ENABLE_DIRECTORY_LISTING


317 
	#MG_ENABLE_DIRECTORY_LISTING
 1

	)

320 #iâdeà
MG_ENABLE_FILESYSTEM


321 
	#MG_ENABLE_FILESYSTEM
 1

	)

324 #iâdeà
MG_ENABLE_HTTP_CGI


325 
	#MG_ENABLE_HTTP_CGI
 
MG_ENABLE_FILESYSTEM


	)

328 #iâdeà
MG_NET_IF


329 
	#MG_NET_IF
 
MG_NET_IF_SOCKET


	)

332 
	`¦“p
(
£cÚds
);

335 
	#timegm
 
_mkgmtime


	)

337 
	#gmtime_r
(
a
, 
b
) \

339 *(
b
èğ*
	`gmtime
(
a
); \

340 
	}
} 0)

	)

344 #ifdeà
MG_MODULE_LINES


347 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_UNIX_H_


348 
	#CS_COMMON_PLATFORMS_PLATFORM_UNIX_H_


	)

349 #ià
CS_PLATFORM
 =ğ
CS_P_UNIX


351 #iâdeà
_XOPEN_SOURCE


352 
	#_XOPEN_SOURCE
 600

	)

356 #iâdeà
__STDC_FORMAT_MACROS


357 
	#__STDC_FORMAT_MACROS


	)

361 #iâdeà
__STDC_LIMIT_MACROS


362 
	#__STDC_LIMIT_MACROS


	)

366 #iâdeà
_LARGEFILE_SOURCE


367 
	#_LARGEFILE_SOURCE


	)

371 #iâdeà
_FILE_OFFSET_BITS


372 
	#_FILE_OFFSET_BITS
 64

	)

375 
	~<¬·/š‘.h
>

376 
	~<as£¹.h
>

377 
	~<ùy³.h
>

378 
	~<dœ’t.h
>

379 
	~<”ºo.h
>

380 
	~<fú.h
>

381 
	~<š‰y³s.h
>

382 
	~<¡dšt.h
>

383 
	~<lim™s.h
>

384 
	~<m©h.h
>

385 
	~<Ãtdb.h
>

386 
	~<Ãtš‘/š.h
>

387 
	~<±h»ad.h
>

388 
	~<sigÇl.h
>

389 
	~<¡d¬g.h
>

390 
	~<¡dboŞ.h
>

391 
	~<¡dio.h
>

392 
	~<¡dlib.h
>

393 
	~<¡ršg.h
>

394 
	~<sys/·¿m.h
>

395 
	~<sys/sock‘.h
>

396 
	~<sys/£Ëù.h
>

397 
	~<sys/¡©.h
>

398 
	~<sys/time.h
>

399 
	~<sys/ty³s.h
>

400 
	~<uni¡d.h
>

402 #ifdeà
__APPLE__


403 
	~<machše/’dŸn.h
>

404 #iâdeà
BYTE_ORDER


405 
	#LITTLE_ENDIAN
 
__DARWIN_LITTLE_ENDIAN


	)

406 
	#BIG_ENDIAN
 
__DARWIN_BIG_ENDIAN


	)

407 
	#PDP_ENDIAN
 
__DARWIN_PDP_ENDIAN


	)

408 
	#BYTE_ORDER
 
__DARWIN_BYTE_ORDER


	)

418 #ià!(
defšed
(
__ılu¥lus
) && __cplusplus >= 201103L) && \

419 !(
defšed
(
__DARWIN_C_LEVEL
è&& 
	g__DARWIN_C_LEVEL
 >= 200809L)

420 
¡¹Şl
(const *, **, );

423 
	tsock_t
;

424 
	#INVALID_SOCKET
 (-1)

	)

425 
	#SIZE_T_FMT
 "zu"

	)

426 
¡©
 
	tcs_¡©_t
;

427 
	#DIRSEP
 '/'

	)

428 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

429 
	#INT64_FMT
 
PRId64


	)

430 
	#INT64_X_FMT
 
PRIx64


	)

432 #iâdeà
__cdeş


433 
	#__cdeş


	)

436 #iâdeà
va_cİy


437 #ifdeà
__va_cİy


438 
	#va_cİy
 
__va_cİy


	)

440 
	#va_cİy
(
x
, 
y
è(xèğ(y)

	)

444 
	#şo£sock‘
(
x
è
	`şo£
(x)

	)

446 #iâdeà
MG_MAX_HTTP_REQUEST_SIZE


447 
	#MG_MAX_HTTP_REQUEST_SIZE
 8192

	)

450 #iâdeà
MG_MAX_HTTP_SEND_MBUF


451 
	#MG_MAX_HTTP_SEND_MBUF
 4096

	)

454 #iâdeà
MG_MAX_HTTP_HEADERS


455 
	#MG_MAX_HTTP_HEADERS
 40

	)

458 #iâdeà
CS_ENABLE_STDIO


459 
	#CS_ENABLE_STDIO
 1

	)

462 #iâdeà
MG_ENABLE_BROADCAST


463 
	#MG_ENABLE_BROADCAST
 1

	)

466 #iâdeà
MG_ENABLE_DIRECTORY_LISTING


467 
	#MG_ENABLE_DIRECTORY_LISTING
 1

	)

470 #iâdeà
MG_ENABLE_FILESYSTEM


471 
	#MG_ENABLE_FILESYSTEM
 1

	)

474 #iâdeà
MG_ENABLE_HTTP_CGI


475 
	#MG_ENABLE_HTTP_CGI
 
MG_ENABLE_FILESYSTEM


	)

478 #iâdeà
MG_NET_IF


479 
	#MG_NET_IF
 
MG_NET_IF_SOCKET


	)

482 #iâdeà
MG_HOSTS_FILE_NAME


483 
	#MG_HOSTS_FILE_NAME
 "/‘c/ho¡s"

	)

486 #iâdeà
MG_RESOLV_CONF_FILE_NAME


487 
	#MG_RESOLV_CONF_FILE_NAME
 "/‘c/»sŞv.cÚf"

	)

492 #ifdeà
MG_MODULE_LINES


500 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_ESP32_H_


501 
	#CS_COMMON_PLATFORMS_PLATFORM_ESP32_H_


	)

502 #ià
CS_PLATFORM
 =ğ
CS_P_ESP32


504 
	~<as£¹.h
>

505 
	~<ùy³.h
>

506 
	~<dœ’t.h
>

507 
	~<fú.h
>

508 
	~<š‰y³s.h
>

509 
	~<machše/’dŸn.h
>

510 
	~<¡dboŞ.h
>

511 
	~<¡dšt.h
>

512 
	~<¡ršg.h
>

513 
	~<sys/¡©.h
>

514 
	~<sys/time.h
>

516 
	#SIZE_T_FMT
 "u"

	)

517 
¡©
 
	tcs_¡©_t
;

518 
	#DIRSEP
 '/'

	)

519 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

520 
	#INT64_FMT
 
PRId64


	)

521 
	#INT64_X_FMT
 
PRIx64


	)

522 
	#__cdeş


	)

523 
	#_FILE_OFFSET_BITS
 32

	)

525 
	#MG_LWIP
 1

	)

527 #iâdeà
MG_NET_IF


528 
	#MG_NET_IF
 
MG_NET_IF_SOCKET


	)

531 #iâdeà
CS_ENABLE_STDIO


532 
	#CS_ENABLE_STDIO
 1

	)

537 #ifdeà
MG_MODULE_LINES


545 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_ESP8266_H_


546 
	#CS_COMMON_PLATFORMS_PLATFORM_ESP8266_H_


	)

547 #ià
CS_PLATFORM
 =ğ
CS_P_ESP8266


549 
	~<as£¹.h
>

550 
	~<ùy³.h
>

551 
	~<fú.h
>

552 
	~<š‰y³s.h
>

553 
	~<machše/’dŸn.h
>

554 
	~<¡dboŞ.h
>

555 
	~<¡ršg.h
>

556 
	~<sys/¡©.h
>

557 
	~<sys/time.h
>

559 
	#SIZE_T_FMT
 "u"

	)

560 
¡©
 
	tcs_¡©_t
;

561 
	#DIRSEP
 '/'

	)

562 #ià!
defšed
(
MGOS_VFS_DEFINE_DIRENT
)

563 
	#CS_DEFINE_DIRENT


	)

566 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

567 
	#INT64_FMT
 
PRId64


	)

568 
	#INT64_X_FMT
 
PRIx64


	)

569 
	#__cdeş


	)

570 
	#_FILE_OFFSET_BITS
 32

	)

572 #ià!
defšed
(
RTOS_SDK
è&& !defšed(
__ılu¥lus
)

573 
	#f’o
(
x
è-1

	)

576 
	#MG_LWIP
 1

	)

579 
	#LWIP_TIMEVAL_PRIVATE
 0

	)

581 #iâdeà
MG_NET_IF


582 
	~<lw/İt.h
>

583 #ià
LWIP_SOCKET


584 
	#MG_NET_IF
 
MG_NET_IF_SOCKET


	)

586 
	#MG_NET_IF
 
MG_NET_IF_LWIP_LOW_LEVEL


	)

590 #iâdeà
CS_ENABLE_STDIO


591 
	#CS_ENABLE_STDIO
 1

	)

596 #ifdeà
MG_MODULE_LINES


604 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_CC3100_H_


605 
	#CS_COMMON_PLATFORMS_PLATFORM_CC3100_H_


	)

606 #ià
CS_PLATFORM
 =ğ
CS_P_CC3100


608 
	~<as£¹.h
>

609 
	~<ùy³.h
>

610 
	~<”ºo.h
>

611 
	~<š‰y³s.h
>

612 
	~<¡dšt.h
>

613 
	~<¡ršg.h
>

614 
	~<time.h
>

616 
	#MG_NET_IF
 
MG_NET_IF_SIMPLELINK


	)

617 
	#MG_SSL_IF
 
MG_SSL_IF_SIMPLELINK


	)

625 
	~<sim¶–šk.h
>

626 
	~<Ãµ.h
>

627 #undeà
timev®


629 
	tsock_t
;

630 
	#INVALID_SOCKET
 (-1)

	)

632 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

633 
	#INT64_FMT
 
PRId64


	)

634 
	#INT64_X_FMT
 
PRIx64


	)

635 
	#SIZE_T_FMT
 "u"

	)

637 
	#SOMAXCONN
 8

	)

639 cÚ¡ *
š‘_Áİ
(
af
, cÚ¡ *
¤c
, *
d¡
, 
sockËn_t
 
size
);

640 *
š‘_Áß
(
š_addr
 
š
);

641 
š‘_±Ú
(
af
, cÚ¡ *
¤c
, *
d¡
);

645 #ifdeà
MG_MODULE_LINES


653 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_CC3200_H_


654 
	#CS_COMMON_PLATFORMS_PLATFORM_CC3200_H_


	)

655 #ià
CS_PLATFORM
 =ğ
CS_P_CC3200


657 
	~<as£¹.h
>

658 
	~<ùy³.h
>

659 
	~<”ºo.h
>

660 
	~<š‰y³s.h
>

661 
	~<¡dboŞ.h
>

662 
	~<¡dšt.h
>

663 
	~<¡ršg.h
>

664 
	~<time.h
>

666 #iâdeà
__TI_COMPILER_VERSION__


667 
	~<fú.h
>

668 
	~<sys/time.h
>

671 
	#MG_NET_IF
 
MG_NET_IF_SIMPLELINK


	)

672 
	#MG_SSL_IF
 
MG_SSL_IF_SIMPLELINK


	)

675 #ià
defšed
(
CC3200_FS_SPIFFS
è&& !defšed(
MG_ENABLE_DIRECTORY_LISTING
)

676 
	#MG_ENABLE_DIRECTORY_LISTING
 1

	)

681 
	tsock_t
;

682 
	#INVALID_SOCKET
 (-1)

	)

683 
	#SIZE_T_FMT
 "u"

	)

684 
¡©
 
	tcs_¡©_t
;

685 
	#DIRSEP
 '/'

	)

686 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

687 
	#INT64_FMT
 
PRId64


	)

688 
	#INT64_X_FMT
 
PRIx64


	)

689 
	#__cdeş


	)

691 
	#f’o
(
x
è-1

	)

695 #ifdeà
__ılu¥lus


699 #ifdeà
__TI_COMPILER_VERSION__


700 
SlTimev®_t
;

701 
	#timev®
 
SlTimev®_t


	)

702 
g‘timeofday
(
timev®
 *
t
, *
tz
);

703 
£‰imeofday
(cÚ¡ 
timev®
 *
tv
, cÚ¡ *
tz
);

705 
a¥rštf
(**
¡½
, cÚ¡ *
fmt
, ...);

710 #ifdeà
__TI_COMPILER_VERSION__


712 
	~<fe.h
>

714 
	tmode_t
;

715 
size_t
 
	t_off_t
;

716 
	tssize_t
;

718 
	s¡©
 {

719 
	m¡_šo
;

720 
mode_t
 
	m¡_mode
;

721 
	m¡_Æšk
;

722 
time_t
 
	m¡_mtime
;

723 
off_t
 
	m¡_size
;

726 
_¡©
(cÚ¡ *
·thÇme
, 
¡©
 *
¡
);

727 
¡©
(cÚ¡ *
·thÇme
, ¡© *
¡
);

729 
	#__S_IFMT
 0170000

	)

731 
	#__S_IFDIR
 0040000

	)

732 
	#__S_IFCHR
 0020000

	)

733 
	#__S_IFREG
 0100000

	)

735 
	#__S_ISTYPE
(
mode
, 
mask
è(((modeè&
__S_IFMT
è=ğ(mask))

	)

737 
	#S_IFDIR
 
__S_IFDIR


	)

738 
	#S_IFCHR
 
__S_IFCHR


	)

739 
	#S_IFREG
 
__S_IFREG


	)

740 
	#S_ISDIR
(
mode
è
	`__S_ISTYPE
((mode), 
__S_IFDIR
)

	)

741 
	#S_ISREG
(
mode
è
	`__S_ISTYPE
((mode), 
__S_IFREG
)

	)

744 #ià
__TI_COMPILER_VERSION__
 < 16000000

745 
	#va_cİy
(
­c
, 
­
è(×pcèğ×p))

	)

750 #ifdeà
CC3200_FS_SLFS


751 
	#MG_FS_SLFS


	)

754 #ià(
defšed
(
CC3200_FS_SPIFFS
è|| defšed(
CC3200_FS_SLFS
)) && \

755 !
	$defšed
(
MG_ENABLE_FILESYSTEM
)

756 
	#MG_ENABLE_FILESYSTEM
 1

	)

757 
	#CS_DEFINE_DIRENT


	)

760 #iâdeà
CS_ENABLE_STDIO


761 
	#CS_ENABLE_STDIO
 1

	)

764 #ifdeà
__ılu¥lus


765 
	}
}

770 #ifdeà
MG_MODULE_LINES


778 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_MSP432_H_


779 
	#CS_COMMON_PLATFORMS_PLATFORM_MSP432_H_


	)

780 #ià
CS_PLATFORM
 =ğ
CS_P_MSP432


782 
	~<as£¹.h
>

783 
	~<ùy³.h
>

784 
	~<”ºo.h
>

785 
	~<š‰y³s.h
>

786 
	~<¡dšt.h
>

787 
	~<¡ršg.h
>

788 
	~<time.h
>

790 #iâdeà
__TI_COMPILER_VERSION__


791 
	~<fú.h
>

792 
	~<sys/time.h
>

795 
	#MG_NET_IF
 
MG_NET_IF_SIMPLELINK


	)

796 
	#MG_SSL_IF
 
MG_SSL_IF_SIMPLELINK


	)

800 
	tsock_t
;

801 
	#INVALID_SOCKET
 (-1)

	)

802 
	#SIZE_T_FMT
 "u"

	)

803 
¡©
 
	tcs_¡©_t
;

804 
	#DIRSEP
 '/'

	)

805 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

806 
	#INT64_FMT
 
PRId64


	)

807 
	#INT64_X_FMT
 
PRIx64


	)

808 
	#__cdeş


	)

810 
	#f’o
(
x
è-1

	)

814 #ifdeà
__ılu¥lus


818 #ifdeà
__TI_COMPILER_VERSION__


819 
SlTimev®_t
;

820 
	#timev®
 
SlTimev®_t


	)

821 
g‘timeofday
(
timev®
 *
t
, *
tz
);

825 #ifdeà
__TI_COMPILER_VERSION__


827 
	~<fe.h
>

829 
	tmode_t
;

830 
size_t
 
	t_off_t
;

831 
	tssize_t
;

833 
	s¡©
 {

834 
	m¡_šo
;

835 
mode_t
 
	m¡_mode
;

836 
	m¡_Æšk
;

837 
time_t
 
	m¡_mtime
;

838 
off_t
 
	m¡_size
;

841 
_¡©
(cÚ¡ *
·thÇme
, 
¡©
 *
¡
);

842 
	#¡©
(
a
, 
b
è
	`_¡©
×, b)

	)

844 
	#__S_IFMT
 0170000

	)

846 
	#__S_IFDIR
 0040000

	)

847 
	#__S_IFCHR
 0020000

	)

848 
	#__S_IFREG
 0100000

	)

850 
	#__S_ISTYPE
(
mode
, 
mask
è(((modeè&
__S_IFMT
è=ğ(mask))

	)

852 
	#S_IFDIR
 
__S_IFDIR


	)

853 
	#S_IFCHR
 
__S_IFCHR


	)

854 
	#S_IFREG
 
__S_IFREG


	)

855 
	#S_ISDIR
(
mode
è
	`__S_ISTYPE
((mode), 
__S_IFDIR
)

	)

856 
	#S_ISREG
(
mode
è
	`__S_ISTYPE
((mode), 
__S_IFREG
)

	)

859 
	#va_cİy
(
­c
, 
­
è(×pcèğ×p))

	)

863 #iâdeà
CS_ENABLE_STDIO


864 
	#CS_ENABLE_STDIO
 1

	)

867 #ià(
defšed
(
CC3200_FS_SPIFFS
è|| defšed(
CC3200_FS_SLFS
)) && \

868 !
	$defšed
(
MG_ENABLE_FILESYSTEM
)

869 
	#MG_ENABLE_FILESYSTEM
 1

	)

872 #ifdeà
__ılu¥lus


873 
	}
}

878 #ifdeà
MG_MODULE_LINES


886 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_TM4C129_H_


887 
	#CS_COMMON_PLATFORMS_PLATFORM_TM4C129_H_


	)

888 #ià
CS_PLATFORM
 =ğ
CS_P_TM4C129


890 
	~<as£¹.h
>

891 
	~<ùy³.h
>

892 
	~<”ºo.h
>

893 
	~<š‰y³s.h
>

894 
	~<¡dšt.h
>

895 
	~<¡ršg.h
>

896 
	~<time.h
>

898 #iâdeà
__TI_COMPILER_VERSION__


899 
	~<fú.h
>

900 
	~<sys/time.h
>

903 
	#SIZE_T_FMT
 "u"

	)

904 
¡©
 
	tcs_¡©_t
;

905 
	#DIRSEP
 '/'

	)

906 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

907 
	#INT64_FMT
 
PRId64


	)

908 
	#INT64_X_FMT
 
PRIx64


	)

909 
	#__cdeş


	)

911 #iâdeà
MG_NET_IF


912 
	~<lw/İt.h
>

913 #ià
LWIP_SOCKET


914 
	#MG_NET_IF
 
MG_NET_IF_SOCKET


	)

916 
	#MG_NET_IF
 
MG_NET_IF_LWIP_LOW_LEVEL


	)

918 
	#MG_LWIP
 1

	)

919 #–ià
MG_NET_IF
 =ğ
MG_NET_IF_SIMPLELINK


923 #iâdeà
CS_ENABLE_STDIO


924 
	#CS_ENABLE_STDIO
 1

	)

927 #ifdeà
__TI_COMPILER_VERSION__


929 
	#va_cİy
(
­c
, 
­
è(×pcèğ×p))

	)

932 #ifdeà
__ılu¥lus


938 #ifdeà
MG_MODULE_LINES


946 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_MBED_H_


947 
	#CS_COMMON_PLATFORMS_PLATFORM_MBED_H_


	)

948 #ià
CS_PLATFORM
 =ğ
CS_P_MBED


954 #ifdeà
__ılu¥lus


958 
	~<as£¹.h
>

959 
	~<ùy³.h
>

960 
	~<”ºo.h
>

961 
	~<š‰y³s.h
>

962 
	~<¡dšt.h
>

963 
	~<¡ršg.h
>

964 
	~<time.h
>

965 
	~<sys/¡©.h
>

966 
	~<sys/ty³s.h
>

967 
	~<fú.h
>

968 
	~<¡dio.h
>

970 
¡©
 
	tcs_¡©_t
;

971 
	#DIRSEP
 '/'

	)

973 #iâdeà
CS_ENABLE_STDIO


974 
	#CS_ENABLE_STDIO
 1

	)

983 #ià
defšed
(
__ARMCC_VERSION
è|| defšed(
__ICCARM__
)

984 
	#_TIMEVAL_DEFINED


	)

985 
	#g‘timeofday
 
_g‘timeofday


	)

988 
	tsu£cÚds_t
;

989 
	stimev®
 {

990 
time_t
 
	mtv_£c
;

991 
su£cÚds_t
 
	mtv_u£c
;

996 #ià
MG_NET_IF
 =ğ
MG_NET_IF_SIMPLELINK


998 
	#MG_SIMPLELINK_NO_OSI
 1

	)

1000 
	~<sim¶–šk.h
>

1002 
	tsock_t
;

1003 
	#INVALID_SOCKET
 (-1)

	)

1005 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

1006 
	#INT64_FMT
 
PRId64


	)

1007 
	#INT64_X_FMT
 
PRIx64


	)

1008 
	#SIZE_T_FMT
 "u"

	)

1010 
	#SOMAXCONN
 8

	)

1012 cÚ¡ *
š‘_Áİ
(
af
, cÚ¡ *
¤c
, *
d¡
, 
sockËn_t
 
size
);

1013 *
š‘_Áß
(
š_addr
 
š
);

1014 
š‘_±Ú
(
af
, cÚ¡ *
¤c
, *
d¡
);

1015 
š‘_©Ú
(cÚ¡ *
ı
, 
š_addr
 *
šp
);

1016 
š_addr_t
 
š‘_addr
(cÚ¡ *
ı
);

1022 #ifdeà
MG_MODULE_LINES


1029 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_NRF51_H_


1030 
	#CS_COMMON_PLATFORMS_PLATFORM_NRF51_H_


	)

1031 #ià
CS_PLATFORM
 =ğ
CS_P_NRF51


1033 
	~<as£¹.h
>

1034 
	~<ùy³.h
>

1035 
	~<š‰y³s.h
>

1036 
	~<¡dšt.h
>

1037 
	~<¡ršg.h
>

1038 
	~<time.h
>

1040 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

1042 
	#MG_NET_IF
 
MG_NET_IF_LWIP_LOW_LEVEL


	)

1043 
	#MG_LWIP
 1

	)

1044 
	#MG_ENABLE_IPV6
 1

	)

1050 #ià!
defšed
(
__ARMCC_VERSION
)

1051 
	#LWIP_TIMEVAL_PRIVATE
 0

	)

1053 
	gtimev®
;

1054 
g‘timeofday
(
timev®
 *

, *
tzp
);

1057 
	#INT64_FMT
 
PRId64


	)

1058 
	#SIZE_T_FMT
 "u"

	)

1063 
	#CS_ENABLE_STRDUP
 
	`defšed
(
__ARMCC_VERSION
)

	)

1067 #ifdeà
MG_MODULE_LINES


1074 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_NRF52_H_


1075 
	#CS_COMMON_PLATFORMS_PLATFORM_NRF52_H_


	)

1076 #ià
CS_PLATFORM
 =ğ
CS_P_NRF52


1078 
	~<as£¹.h
>

1079 
	~<ùy³.h
>

1080 
	~<”ºo.h
>

1081 
	~<š‰y³s.h
>

1082 
	~<¡dšt.h
>

1083 
	~<¡ršg.h
>

1084 
	~<time.h
>

1086 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

1088 
	#MG_NET_IF
 
MG_NET_IF_LWIP_LOW_LEVEL


	)

1089 
	#MG_LWIP
 1

	)

1090 
	#MG_ENABLE_IPV6
 1

	)

1092 #ià!
defšed
(
ENOSPC
)

1093 
	#ENOSPC
 28

	)

1100 #ià!
defšed
(
__ARMCC_VERSION
)

1101 
	#LWIP_TIMEVAL_PRIVATE
 0

	)

1104 
	#INT64_FMT
 
PRId64


	)

1105 
	#SIZE_T_FMT
 "u"

	)

1110 
	#CS_ENABLE_STRDUP
 
	`defšed
(
__ARMCC_VERSION
)

	)

1114 #ifdeà
MG_MODULE_LINES


1122 #iâdeà
CS_COMMON_PLATFORMS_SIMPLELINK_CS_SIMPLELINK_H_


1123 
	#CS_COMMON_PLATFORMS_SIMPLELINK_CS_SIMPLELINK_H_


	)

1125 #ià
defšed
(
MG_NET_IF
è&& MG_NET_IF =ğ
MG_NET_IF_SIMPLELINK


1128 #ià!
defšed
(
__SIMPLELINK_H__
)

1130 
	~<¡dboŞ.h
>

1132 #iâdeà
__TI_COMPILER_VERSION__


1133 #undeà
__CONCAT


1134 #undeà
FD_CLR


1135 #undeà
FD_ISSET


1136 #undeà
FD_SET


1137 #undeà
FD_SETSIZE


1138 #undeà
FD_ZERO


1139 #undeà
fd_£t


1142 #ià
CS_PLATFORM
 =ğ
CS_P_CC3220


1143 
	~<ti/driv”s/Ãt/wifi/pÜtšg/u£r.h
>

1144 
	~<ti/driv”s/Ãt/wifi/sim¶–šk.h
>

1145 
	~<ti/driv”s/Ãt/wifi/¦_sock‘.h
>

1146 
	~<ti/driv”s/Ãt/wifi/Ãµ.h
>

1150 
	#PROVISIONING_API_H_


	)

1151 
	~<sim¶–šk/u£r.h
>

1152 #undeà
PROVISIONING_API_H_


1153 #undeà
SL_INC_STD_BSD_API_NAMING


1155 
	~<sim¶–šk/šşude/sim¶–šk.h
>

1156 
	~<sim¶–šk/šşude/Ãµ.h
>

1161 
	#AF_INET
 
SL_AF_INET


	)

1163 
	#sockËn_t
 
SlSockËn_t


	)

1164 
	#sockaddr
 
SlSockAddr_t


	)

1165 
	#sockaddr_š
 
SlSockAddrIn_t


	)

1166 
	#š_addr
 
SlInAddr_t


	)

1168 
	#SOCK_STREAM
 
SL_SOCK_STREAM


	)

1169 
	#SOCK_DGRAM
 
SL_SOCK_DGRAM


	)

1171 
	#htÚl
 
¦_HtÚl


	)

1172 
	#Áohl
 
¦_Ntohl


	)

1173 
	#htÚs
 
¦_HtÚs


	)

1174 
	#Áohs
 
¦_Ntohs


	)

1176 #iâdeà
EACCES


1177 
	#EACCES
 
SL_EACCES


	)

1179 #iâdeà
EAFNOSUPPORT


1180 
	#EAFNOSUPPORT
 
SL_EAFNOSUPPORT


	)

1182 #iâdeà
EAGAIN


1183 
	#EAGAIN
 
SL_EAGAIN


	)

1185 #iâdeà
EBADF


1186 
	#EBADF
 
SL_EBADF


	)

1188 #iâdeà
EINVAL


1189 
	#EINVAL
 
SL_EINVAL


	)

1191 #iâdeà
ENOMEM


1192 
	#ENOMEM
 
SL_ENOMEM


	)

1194 #iâdeà
EWOULDBLOCK


1195 
	#EWOULDBLOCK
 
SL_EWOULDBLOCK


	)

1198 
	#SOMAXCONN
 8

	)

1200 #ifdeà
__ılu¥lus


1204 cÚ¡ *
š‘_Áİ
(
af
, cÚ¡ *
¤c
, *
d¡
, 
sockËn_t
 
size
);

1205 *
š‘_Áß
(
š_addr
 
š
);

1206 
š‘_±Ú
(
af
, cÚ¡ *
¤c
, *
d¡
);

1208 
mg_mgr
;

1209 
mg_cÚÃùiÚ
;

1211 (*
mg_š™_cb
)(
	tmg_mgr
 *
	tmgr
);

1212 
boŞ
 
mg_¡¬t_sk
(
´iÜ™y
, 
¡ack_size
, 
mg_š™_cb
 
mg_š™
);

1214 
mg_run_š_sk
((*
cb
)(
mg_mgr
 *
mgr
, *
¬g
), *
cb_¬g
);

1216 
¦_fs_š™
();

1218 
¦_»¡¬t_cb
(
mg_mgr
 *
mgr
);

1220 
¦_£t_s¦_İts
(
sock
, 
mg_cÚÃùiÚ
 *
nc
);

1222 #ifdeà
__ılu¥lus


1229 #ià
SL_MAJOR_VERSION_NUM
 < 2

1231 
	#SL_ERROR_BSD_EAGAIN
 
SL_EAGAIN


	)

1232 
	#SL_ERROR_BSD_EALREADY
 
SL_EALREADY


	)

1233 
	#SL_ERROR_BSD_ENOPROTOOPT
 
SL_ENOPROTOOPT


	)

1234 
	#SL_ERROR_BSD_ESECDATEERROR
 
SL_ESECDATEERROR


	)

1235 
	#SL_ERROR_BSD_ESECSNOVERIFY
 
SL_ESECSNOVERIFY


	)

1236 
	#SL_ERROR_FS_FAILED_TO_ALLOCATE_MEM
 
SL_FS_ERR_FAILED_TO_ALLOCATE_MEM


	)

1237 
	#SL_ERROR_FS_FILE_HAS_NOT_BEEN_CLOSE_CORRECTLY
 \

1238 
SL_FS_FILE_HAS_NOT_BEEN_CLOSE_CORRECTLY


	)

1239 
	#SL_ERROR_FS_FILE_NAME_EXIST
 
SL_FS_FILE_NAME_EXIST


	)

1240 
	#SL_ERROR_FS_FILE_NOT_EXISTS
 
SL_FS_ERR_FILE_NOT_EXISTS


	)

1241 
	#SL_ERROR_FS_NO_AVAILABLE_NV_INDEX
 
SL_FS_ERR_NO_AVAILABLE_NV_INDEX


	)

1242 
	#SL_ERROR_FS_NOT_ENOUGH_STORAGE_SPACE
 
SL_FS_ERR_NO_AVAILABLE_BLOCKS


	)

1243 
	#SL_ERROR_FS_NOT_SUPPORTED
 
SL_FS_ERR_NOT_SUPPORTED


	)

1244 
	#SL_ERROR_FS_WRONG_FILE_NAME
 
SL_FS_WRONG_FILE_NAME


	)

1245 
	#SL_ERROR_FS_INVALID_HANDLE
 
SL_FS_ERR_INVALID_HANDLE


	)

1246 
	#SL_NETCFG_MAC_ADDRESS_GET
 
SL_MAC_ADDRESS_GET


	)

1247 
	#SL_SOCKET_FD_ZERO
 
SL_FD_ZERO


	)

1248 
	#SL_SOCKET_FD_SET
 
SL_FD_SET


	)

1249 
	#SL_SOCKET_FD_ISSET
 
SL_FD_ISSET


	)

1250 
	#SL_SO_SECURE_DOMAIN_NAME_VERIFICATION
 
SO_SECURE_DOMAIN_NAME_VERIFICATION


	)

1252 
	#SL_FS_READ
 
FS_MODE_OPEN_READ


	)

1253 
	#SL_FS_WRITE
 
FS_MODE_OPEN_WRITE


	)

1255 
	#SL_FI_FILE_SIZE
(
fi
è((fi).
FeL’
)

	)

1256 
	#SL_FI_FILE_MAX_SIZE
(
fi
è((fi).
AÎoÿ‹dL’
)

	)

1258 
	#SlDeviûV”siÚ_t
 
SlV”siÚFuÎ


	)

1259 
	#¦_DeviûG‘
 
¦_DevG‘


	)

1260 
	#SL_DEVICE_GENERAL
 
SL_DEVICE_GENERAL_CONFIGURATION


	)

1261 
	#SL_LEN_TYPE
 
_u8


	)

1262 
	#SL_OPT_TYPE
 
_u8


	)

1266 
	#FS_MODE_OPEN_CREATE
(
max_size
, 
æag
) \

1267 (
SL_FS_CREATE
 | 
	`SL_FS_CREATE_MAX_SIZE
(
max_size
))

	)

1268 
	#SL_FI_FILE_SIZE
(
fi
è((fi).
L’
)

	)

1269 
	#SL_FI_FILE_MAX_SIZE
(
fi
è((fi).
MaxSize
)

	)

1271 
	#SL_LEN_TYPE
 
_u16


	)

1272 
	#SL_OPT_TYPE
 
_u16


	)

1276 
¦fs_İ’
(cÚ¡ *
âame
, 
ušt32_t
 
æags
);

1281 #ifdeà
MG_MODULE_LINES


1284 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_WINCE_H_


1285 
	#CS_COMMON_PLATFORMS_PLATFORM_WINCE_H_


	)

1287 #ià
CS_PLATFORM
 =ğ
CS_P_WINCE


1301 #´agm¨
w¬nšg
(
di§bË
 : 4127)

1302 #´agm¨
w¬nšg
(
di§bË
 : 4204)

1304 #iâdeà
_WINSOCK_DEPRECATED_NO_WARNINGS


1305 
	#_WINSOCK_DEPRECATED_NO_WARNINGS
 1

	)

1308 #iâdeà
_CRT_SECURE_NO_WARNINGS


1309 
	#_CRT_SECURE_NO_WARNINGS


	)

1312 
	~<as£¹.h
>

1313 
	~<lim™s.h
>

1314 
	~<¡ddef.h
>

1315 
	~<¡dio.h
>

1316 
	~<¡dlib.h
>

1317 
	~<time.h
>

1319 #´agm¨
comm’t
(
lib
, "ws2.lib")

1321 
	~<wšsock2.h
>

1322 
	~<ws2tı.h
>

1323 
	~<wšdows.h
>

1325 
	#¡rdup
 
_¡rdup


	)

1327 #iâdeà
EINPROGRESS


1328 
	#EINPROGRESS
 
WSAEINPROGRESS


	)

1331 #iâdeà
EWOULDBLOCK


1332 
	#EWOULDBLOCK
 
WSAEWOULDBLOCK


	)

1335 #iâdeà
EAGAIN


1336 
	#EAGAIN
 
EWOULDBLOCK


	)

1339 #iâdeà
__func__


1340 
	#STRX
(
x
è#x

	)

1341 
	#STR
(
x
è
	`STRX
(x)

	)

1342 
	#__func__
 
__FILE__
 ":" 
	`STR
(
__LINE__
)

	)

1345 
	#¢´štf
 
_¢´štf


	)

1346 
	#f’o
 
_f’o


	)

1347 
	#v¢´štf
 
_v¢´štf


	)

1348 
	#¦“p
(
x
è
	`SË•
((xè*1000)

	)

1349 
	#to64
(
x
è
	`_©oi64
(x)

	)

1350 
	#rmdœ
 
_rmdœ


	)

1352 #ià
defšed
(
_MSC_VER
) && _MSC_VER >= 1400

1353 
	#f£eko
(
x
, 
y
, 
z
è
	`_f£eki64
((x), (y), (z))

	)

1355 
	#f£eko
(
x
, 
y
, 
z
è
	`f£ek
((x), (y), (z))

	)

1358 
	tsockËn_t
;

1360 #ià
_MSC_VER
 >= 1700

1361 
	~<¡dšt.h
>

1363 sigÃd 
	tšt8_t
;

1364 
	tušt8_t
;

1365 
	tšt32_t
;

1366 
	tušt32_t
;

1367 
	tšt16_t
;

1368 
	tušt16_t
;

1369 
__št64
 
	tšt64_t
;

1370 
	t__št64
 
	tušt64_t
;

1373 
SOCKET
 
	tsock_t
;

1374 
ušt32_t
 
	tš_addr_t
;

1376 #iâdeà
UINT16_MAX


1377 
	#UINT16_MAX
 65535

	)

1380 #iâdeà
UINT32_MAX


1381 
	#UINT32_MAX
 4294967295

	)

1384 #iâdeà
pid_t


1385 
	#pid_t
 
HANDLE


	)

1388 
	#INT64_FMT
 "I64d"

	)

1389 
	#INT64_X_FMT
 "I64x"

	)

1391 
	#SIZE_T_FMT
 "u"

	)

1393 
	#DIRSEP
 '\\'

	)

1394 
	#CS_DEFINE_DIRENT


	)

1396 #iâdeà
va_cİy


1397 #ifdeà
__va_cİy


1398 
	#va_cİy
 
__va_cİy


	)

1400 
	#va_cİy
(
x
, 
y
è(xèğ(y)

	)

1404 #iâdeà
MG_MAX_HTTP_REQUEST_SIZE


1405 
	#MG_MAX_HTTP_REQUEST_SIZE
 8192

	)

1408 #iâdeà
MG_MAX_HTTP_SEND_MBUF


1409 
	#MG_MAX_HTTP_SEND_MBUF
 4096

	)

1412 #iâdeà
MG_MAX_HTTP_HEADERS


1413 
	#MG_MAX_HTTP_HEADERS
 40

	)

1416 #iâdeà
CS_ENABLE_STDIO


1417 
	#CS_ENABLE_STDIO
 1

	)

1420 
	#abÜt
(è
	`DebugB»ak
();

	)

1422 #iâdeà
BUFSIZ


1423 
	#BUFSIZ
 4096

	)

1429 #iâdeà
MG_ENABLE_THREADS


1430 
	#MG_ENABLE_THREADS
 0

	)

1433 #iâdeà
MG_ENABLE_FILESYSTEM


1434 
	#MG_ENABLE_FILESYSTEM
 1

	)

1437 #iâdeà
MG_NET_IF


1438 
	#MG_NET_IF
 
MG_NET_IF_SOCKET


	)

1441 
	s_¡©i64
 {

1442 
ušt32_t
 
	g¡_mtime
;

1443 
ušt32_t
 
	g¡_size
;

1444 
ušt32_t
 
	g¡_mode
;

1445 } 
	tcs_¡©_t
;

1452 #iâdeà
ENOENT


1453 
	#ENOENT
 
ERROR_PATH_NOT_FOUND


	)

1456 #iâdeà
EACCES


1457 
	#EACCES
 
ERROR_ACCESS_DENIED


	)

1460 #iâdeà
ENOMEM


1461 
	#ENOMEM
 
ERROR_NOT_ENOUGH_MEMORY


	)

1464 #iâdeà
_UINTPTR_T_DEFINED


1465 *
	tušŒ_t
;

1468 
	#_S_IFREG
 2

	)

1469 
	#_S_IFDIR
 4

	)

1471 #iâdeà
S_ISDIR


1472 
	#S_ISDIR
(
x
è(((xè&
_S_IFDIR
è!ğ0)

	)

1475 #iâdeà
S_ISREG


1476 
	#S_ISREG
(
x
è(((xè&
_S_IFREG
è!ğ0)

	)

1479 
İ’
(cÚ¡ *
f’ame
, 
oæag
, 
pmode
);

1480 
_w¡©i64
(cÚ¡ 
wch¬_t
 *
·th
, 
cs_¡©_t
 *
¡
);

1481 cÚ¡ *
¡»¼Ü
();

1485 #ifdeà
MG_MODULE_LINES


1493 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_NXP_LPC_H_


1494 
	#CS_COMMON_PLATFORMS_PLATFORM_NXP_LPC_H_


	)

1496 #ià
CS_PLATFORM
 =ğ
CS_P_NXP_LPC


1498 
	~<ùy³.h
>

1499 
	~<¡dšt.h
>

1500 
	~<¡ršg.h
>

1502 
	#SIZE_T_FMT
 "u"

	)

1503 
¡©
 
	tcs_¡©_t
;

1504 
	#INT64_FMT
 "Îd"

	)

1505 
	#INT64_X_FMT
 "Îx"

	)

1506 
	#__cdeş


	)

1508 
	#MG_LWIP
 1

	)

1510 
	#MG_NET_IF
 
MG_NET_IF_LWIP_LOW_LEVEL


	)

1519 #ifdeà
__REDLIB_INTERFACE_VERSION__


1522 
	#LWIP_TIMEVAL_PRIVATE
 1

	)

1524 
	#va_cİy
(
d
, 
s
è
	`__butš_va_cİy
(d, s)

	)

1526 
	#CS_ENABLE_TO64
 1

	)

1527 
	#to64
(
x
è
	`cs_to64
(x)

	)

1529 
	#CS_ENABLE_STRDUP
 1

	)

1533 
	~<sys/time.h
>

1534 
	#LWIP_TIMEVAL_PRIVATE
 0

	)

1535 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

1541 #ifdeà
MG_MODULE_LINES


1549 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_NXP_KINETIS_H_


1550 
	#CS_COMMON_PLATFORMS_PLATFORM_NXP_KINETIS_H_


	)

1552 #ià
CS_PLATFORM
 =ğ
CS_P_NXP_KINETIS


1554 
	~<ùy³.h
>

1555 
	~<š‰y³s.h
>

1556 
	~<¡ršg.h
>

1557 
	~<sys/time.h
>

1559 
	#SIZE_T_FMT
 "u"

	)

1560 
¡©
 
	tcs_¡©_t
;

1561 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

1562 
	#INT64_FMT
 "Îd"

	)

1563 
	#INT64_X_FMT
 "Îx"

	)

1564 
	#__cdeş


	)

1566 
	#MG_LWIP
 1

	)

1568 
	#MG_NET_IF
 
MG_NET_IF_LWIP_LOW_LEVEL


	)

1571 
	#LWIP_TIMEVAL_PRIVATE
 0

	)

1575 #ifdeà
MG_MODULE_LINES


1583 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_PIC32_H_


1584 
	#CS_COMMON_PLATFORMS_PLATFORM_PIC32_H_


	)

1586 #ià
CS_PLATFORM
 =ğ
CS_P_PIC32


1588 
	#MG_NET_IF
 
MG_NET_IF_PIC32


	)

1590 
	~<¡dšt.h
>

1591 
	~<time.h
>

1592 
	~<ùy³.h
>

1593 
	~<¡dlib.h
>

1595 
	~<sy¡em_cÚfig.h
>

1596 
	~<sy¡em_defš™iÚs.h
>

1598 
	~<sys/ty³s.h
>

1600 
TCP_SOCKET
 
	tsock_t
;

1601 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

1603 
	#SIZE_T_FMT
 "lu"

	)

1604 
	#INT64_FMT
 "Îd"

	)

1606 #iâdeà
CS_ENABLE_STDIO


1607 
	#CS_ENABLE_STDIO
 1

	)

1610 *
š‘_Áß
(
š_addr
 
š
);

1615 #ifdeà
MG_MODULE_LINES


1623 #iâdeà
CS_COMMON_PLATFORMS_PLATFORM_STM32_H_


1624 
	#CS_COMMON_PLATFORMS_PLATFORM_STM32_H_


	)

1625 #ià
CS_PLATFORM
 =ğ
CS_P_STM32


1627 
	~<sys/ty³s.h
>

1628 
	~<sys/¡©.h
>

1629 
	~<¡dšt.h
>

1630 
	~<š‰y³s.h
>

1631 
	~<¡dio.h
>

1632 
	~<ùy³.h
>

1633 
	~<”ºo.h
>

1634 
	~<memÜy.h
>

1635 
	~<fú.h
>

1636 
	~<¡m32_sdk_h®.h
>

1638 
	#to64
(
x
è
	`¡¹Şl
(x, 
NULL
, 10)

	)

1639 
	#INT64_FMT
 
PRId64


	)

1640 
	#SIZE_T_FMT
 "u"

	)

1641 
¡©
 
	tcs_¡©_t
;

1642 
	#DIRSEP
 '/'

	)

1644 #iâdeà
CS_ENABLE_STDIO


1645 
	#CS_ENABLE_STDIO
 1

	)

1648 #iâdeà
MG_ENABLE_FILESYSTEM


1649 
	#MG_ENABLE_FILESYSTEM
 1

	)

1652 
	#CS_DEFINE_DIRENT


	)

1656 #ifdeà
MG_MODULE_LINES


1664 #iâdeà
CS_COMMON_PLATFORMS_LWIP_MG_LWIP_H_


1665 
	#CS_COMMON_PLATFORMS_LWIP_MG_LWIP_H_


	)

1667 #iâdeà
MG_LWIP


1668 
	#MG_LWIP
 0

	)

1671 #ià
MG_LWIP


1682 #ià
CS_PLATFORM
 =ğ
CS_P_NRF51
 || CS_PLATFORM =ğ
CS_P_NRF52


1683 #undeà
BYTE_ORDER


1686 
	~<lw/İt.h
>

1687 
	~<lw/”r.h
>

1688 
	~<lw/_addr.h
>

1689 
	~<lw/š‘.h
>

1690 
	~<lw/Ãtdb.h
>

1691 
	~<lw/dns.h
>

1693 #iâdeà
LWIP_PROVIDE_ERRNO


1694 
	~<”ºo.h
>

1697 #ià
LWIP_SOCKET


1698 
	~<lw/sock‘s.h
>

1701 #undeà
LWIP_SOCKET


1702 
	#LWIP_SOCKET
 1

	)

1703 
	~<lw/sock‘s.h
>

1704 #undeà
LWIP_SOCKET


1705 
	#LWIP_SOCKET
 0

	)

1708 
	#INVALID_SOCKET
 (-1)

	)

1709 
	#SOMAXCONN
 10

	)

1710 
	tsock_t
;

1712 #ià
MG_NET_IF
 =ğ
MG_NET_IF_LWIP_LOW_LEVEL


1713 
	gmg_mgr
;

1714 
	gmg_cÚÃùiÚ
;

1715 
ušt32_t
 
mg_lw_g‘_pŞl_d–ay_ms
(
mg_mgr
 *
mgr
);

1716 
mg_lw_£t_k“·live_·¿ms
(
mg_cÚÃùiÚ
 *
nc
, 
idË
,

1717 
š‹rv®
, 
couÁ
);

1721 #iâdeà
X_2_


1722 
	#X_2_
(
x
è(x)

	)

1728 #ifdeà
MG_MODULE_LINES


1736 #iâdeà
CS_COMMON_MD5_H_


1737 
	#CS_COMMON_MD5_H_


	)

1741 #iâdeà
CS_DISABLE_MD5


1742 
	#CS_DISABLE_MD5
 0

	)

1745 #ifdeà
__ılu¥lus


1750 
ušt32_t
 
buf
[4];

1751 
ušt32_t
 
b™s
[2];

1752 
š
[64];

1753 } 
	tcs_md5_ùx
;

1755 
cs_md5_š™
(
cs_md5_ùx
 *
c
);

1756 
cs_md5_upd©e
(
cs_md5_ùx
 *
c
, cÚ¡ *
d©a
, 
size_t
 
Ën
);

1757 
cs_md5_fš®
(*
md
, 
cs_md5_ùx
 *
c
);

1759 #ifdeà
__ılu¥lus


1764 #ifdeà
MG_MODULE_LINES


1772 #iâdeà
CS_COMMON_SHA1_H_


1773 
	#CS_COMMON_SHA1_H_


	)

1775 #iâdeà
CS_DISABLE_SHA1


1776 
	#CS_DISABLE_SHA1
 0

	)

1779 #ià!
CS_DISABLE_SHA1


1783 #ifdeà
__ılu¥lus


1788 
ušt32_t
 
¡©e
[5];

1789 
ušt32_t
 
couÁ
[2];

1790 
bufãr
[64];

1791 } 
	tcs_sha1_ùx
;

1793 
cs_sha1_š™
(
cs_sha1_ùx
 *);

1794 
cs_sha1_upd©e
(
cs_sha1_ùx
 *, cÚ¡ *
d©a
, 
ušt32_t
 
Ën
);

1795 
cs_sha1_fš®
(
dige¡
[20], 
cs_sha1_ùx
 *);

1796 
cs_hmac_sha1
(cÚ¡ *
key
, 
size_t
 
key_Ën
,

1797 cÚ¡ *
‹xt
, 
size_t
 
‹xt_Ën
,

1798 
out
[20]);

1799 #ifdeà
__ılu¥lus


1806 #ifdeà
MG_MODULE_LINES


1814 #iâdeà
CS_COMMON_CS_TIME_H_


1815 
	#CS_COMMON_CS_TIME_H_


	)

1817 
	~<time.h
>

1821 #ifdeà
__ılu¥lus


1826 
cs_time
();

1832 
cs_timegm
(cÚ¡ 
tm
 *tm);

1834 #ifdeà
__ılu¥lus


1839 #ifdeà
MG_MODULE_LINES


1847 #iâdeà
CS_COMMON_MG_STR_H_


1848 
	#CS_COMMON_MG_STR_H_


	)

1850 
	~<¡ddef.h
>

1854 #ifdeà
__ılu¥lus


1859 
	smg_¡r
 {

1860 cÚ¡ *
p
;

1861 
size_t
 
Ën
;

1868 
mg_¡r
 
mg_mk_¡r
(cÚ¡ *
s
);

1869 
mg_¡r
 
mg_mk_¡r_n
(cÚ¡ *
s
, 
size_t
 
Ën
);

1872 
	#MG_MK_STR
(
¡r_l™”®
) \

1873 { 
¡r_l™”®
, (¡r_l™”®è- 1 }

	)

1874 
	#MG_NULL_STR
 \

1875 { 
NULL
, 0 }

	)

1881 
mg_vcmp
(cÚ¡ 
mg_¡r
 *
¡r2
, cÚ¡ *
¡r1
);

1887 
mg_vÿ£cmp
(cÚ¡ 
mg_¡r
 *
¡r2
, cÚ¡ *
¡r1
);

1890 
mg_¡r
 
mg_¡rdup
(cÚ¡ mg_¡¸
s
);

1896 
mg_¡r
 
mg_¡rdup_nul
(cÚ¡ mg_¡¸
s
);

1901 cÚ¡ *
mg_¡rchr
(cÚ¡ 
mg_¡r
 
s
, 
c
);

1903 
mg_¡rcmp
(cÚ¡ 
mg_¡r
 
¡r1
, cÚ¡ mg_¡¸
¡r2
);

1904 
mg_¡ºcmp
(cÚ¡ 
mg_¡r
 
¡r1
, cÚ¡ mg_¡¸
¡r2
, 
size_t
 
n
);

1906 cÚ¡ *
mg_¡r¡r
(cÚ¡ 
mg_¡r
 
hay¡ack
, cÚ¡ mg_¡¸
ÃedË
);

1908 #ifdeà
__ılu¥lus


1913 #ifdeà
MG_MODULE_LINES


1930 #iâdeà
CS_COMMON_MBUF_H_


1931 
	#CS_COMMON_MBUF_H_


	)

1933 
	~<¡dlib.h
>

1936 #ià
defšed
(
__ılu¥lus
)

1940 #iâdeà
MBUF_SIZE_MULTIPLIER


1941 
	#MBUF_SIZE_MULTIPLIER
 1.5

	)

1945 
	smbuf
 {

1946 *
buf
;

1947 
size_t
 
Ën
;

1948 
size_t
 
size
;

1955 
mbuf_š™
(
mbuf
 *, 
size_t
 
š™Ÿl_ÿ·c™y
);

1958 
mbuf_ä“
(
mbuf
 *);

1965 
size_t
 
mbuf_­³nd
(
mbuf
 *, cÚ¡ *
d©a
, size_ˆ
d©a_size
);

1974 
size_t
 
mbuf_š£¹
(
mbuf
 *, size_t, const *, size_t);

1977 
mbuf_»move
(
mbuf
 *, 
size_t
 
d©a_size
);

1985 
mbuf_»size
(
mbuf
 *, 
size_t
 
Ãw_size
);

1988 
mbuf_Œim
(
mbuf
 *);

1990 #ià
defšed
(
__ılu¥lus
)

1995 #ifdeà
MG_MODULE_LINES


2003 #iâdeà
CS_COMMON_BASE64_H_


2004 
	#CS_COMMON_BASE64_H_


	)

2006 #iâdeà
DISABLE_BASE64


2007 
	#DISABLE_BASE64
 0

	)

2010 #ià!
DISABLE_BASE64


2012 
	~<¡dio.h
>

2014 #ifdeà
__ılu¥lus


2018 (*
cs_ba£64_putc_t
)(, *);

2020 
	scs_ba£64_ùx
 {

2022 
cs_ba£64_putc_t
 
b64_putc
;

2023 
chunk
[3];

2024 
chunk_size
;

2025 *
u£r_d©a
;

2028 
cs_ba£64_š™
(
cs_ba£64_ùx
 *
ùx
, 
cs_ba£64_putc_t
 
putc
,

2029 *
u£r_d©a
);

2030 
cs_ba£64_upd©e
(
cs_ba£64_ùx
 *
ùx
, cÚ¡ *
¡r
, 
size_t
 
Ën
);

2031 
cs_ba£64_fšish
(
cs_ba£64_ùx
 *
ùx
);

2033 
cs_ba£64_’code
(cÚ¡ *
¤c
, 
¤c_Ën
, *
d¡
);

2034 
cs_åršt_ba£64
(
FILE
 *
f
, cÚ¡ *
¤c
, 
¤c_Ën
);

2035 
cs_ba£64_decode
(cÚ¡ *
s
, 
Ën
, *
d¡
, *
dec_Ën
);

2037 #ifdeà
__ılu¥lus


2044 #ifdeà
MG_MODULE_LINES


2052 #iâdeà
CS_COMMON_STR_UTIL_H_


2053 
	#CS_COMMON_STR_UTIL_H_


	)

2055 
	~<¡d¬g.h
>

2056 
	~<¡dlib.h
>

2061 #iâdeà
CS_ENABLE_STRDUP


2062 
	#CS_ENABLE_STRDUP
 0

	)

2065 #iâdeà
CS_ENABLE_TO64


2066 
	#CS_ENABLE_TO64
 0

	)

2073 
	#CS_STRINGIFY_LIT
(
x
è#x

	)

2084 
	#CS_STRINGIFY_MACRO
(
x
è
	`CS_STRINGIFY_LIT
(x)

	)

2086 #ifdeà
__ılu¥lus


2090 
size_t
 
c_¡ºËn
(cÚ¡ *
s
, size_ˆ
maxËn
);

2091 
c_¢´štf
(*
buf
, 
size_t
 
buf_size
, cÚ¡ *
fÜm©
, ...);

2092 
c_v¢´štf
(*
buf
, 
size_t
 
buf_size
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
);

2097 cÚ¡ *
c_¡º¡r
(cÚ¡ *
s
, cÚ¡ *
fšd
, 
size_t
 
¦’
);

2104 
cs_to_hex
(*
to
, cÚ¡ *
p
, 
size_t
 
Ën
);

2110 
cs_äom_hex
(*
to
, cÚ¡ *
p
, 
size_t
 
Ën
);

2112 #ià
CS_ENABLE_STRDUP


2113 *
¡rdup
(cÚ¡ *
¤c
);

2116 #ià
CS_ENABLE_TO64


2117 
	~<¡dšt.h
>

2121 
št64_t
 
cs_to64
(cÚ¡ *
s
);

2127 
mg_nÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
, 
size_t
 
Ën
);

2132 
mg_ÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
);

2149 
mg_a¥rštf
(**
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, ...);

2152 
mg_av´štf
(**
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, 
va_li¡
 
­
);

2167 cÚ¡ *
mg_Ãxt_comma_li¡_’Œy
(cÚ¡ *
li¡
, 
mg_¡r
 *
v®
,

2168 
mg_¡r
 *
eq_v®
);

2169 
mg_¡r
 
mg_Ãxt_comma_li¡_’Œy_n
(mg_¡¸
li¡
, mg_¡¸*
v®
,

2170 
mg_¡r
 *
eq_v®
);

2179 
mg_m©ch_´efix
(cÚ¡ *
·‰”n
, 
·‰”n_Ën
, cÚ¡ *
¡r
);

2180 
mg_m©ch_´efix_n
(cÚ¡ 
mg_¡r
 
·‰”n
, cÚ¡ mg_¡¸
¡r
);

2182 #ifdeà
__ılu¥lus


2187 #ifdeà
MG_MODULE_LINES


2223 #iâdeà
_SYS_QUEUE_H_


2224 
	#_SYS_QUEUE_H_


	)

2299 #ifdeà
QUEUE_MACRO_DEBUG


2301 
	sqm_Œaû
 {

2302 
Ï¡lše
;

2303 
´evlše
;

2304 cÚ¡ *
Ï¡fe
;

2305 cÚ¡ *
´evfe
;

2308 
	#TRACEBUF
 
qm_Œaû
 
Œaû
;

	)

2309 
	#TRACEBUF_INITIALIZER
 { 
__LINE__
, 0, 
__FILE__
, 
NULL
 } ,

	)

2310 
	#TRASHIT
(
x
èdØ{(xèğ(*)-1;} 0)

	)

2311 
	#QMD_SAVELINK
(
Çme
, 
lšk
è**Çmğ(*)&Öšk)

	)

2313 
	#QMD_TRACE_HEAD
(
h—d
) do { \

2314 (
h—d
)->
Œaû
.
´evlše
 = (h—d)->Œaû.
Ï¡lše
; \

2315 (
h—d
)->
Œaû
.
´evfe
 = (h—d)->Œaû.
Ï¡fe
; \

2316 (
h—d
)->
Œaû
.
Ï¡lše
 = 
__LINE__
; \

2317 (
h—d
)->
Œaû
.
Ï¡fe
 = 
__FILE__
; \

2318 } 0)

	)

2320 
	#QMD_TRACE_ELEM
(
–em
) do { \

2321 (
–em
)->
Œaû
.
´evlše
 = (–em)->Œaû.
Ï¡lše
; \

2322 (
–em
)->
Œaû
.
´evfe
 = (–em)->Œaû.
Ï¡fe
; \

2323 (
–em
)->
Œaû
.
Ï¡lše
 = 
__LINE__
; \

2324 (
–em
)->
Œaû
.
Ï¡fe
 = 
__FILE__
; \

2325 } 0)

	)

2328 
	#QMD_TRACE_ELEM
(
–em
)

	)

2329 
	#QMD_TRACE_HEAD
(
h—d
)

	)

2330 
	#QMD_SAVELINK
(
Çme
, 
lšk
)

	)

2331 
	#TRACEBUF


	)

2332 
	#TRACEBUF_INITIALIZER


	)

2333 
	#TRASHIT
(
x
)

	)

2336 #ifdeà
__ılu¥lus


2340 
	#QUEUE_TYPEOF
(
ty³
è
	)
type

2342 
	#QUEUE_TYPEOF
(
ty³
è
	)
type

2348 
	#SLIST_HEAD
(
Çme
, 
ty³
) \

2349 
	sÇme
 { \

2350 
ty³
 *
¦h_fœ¡
; \

2351 }

	)

2353 
	#SLIST_CLASS_HEAD
(
Çme
, 
ty³
) \

2354 
	sÇme
 { \

2355 
şass
 
ty³
 *
¦h_fœ¡
; \

2356 }

	)

2358 
	#SLIST_HEAD_INITIALIZER
(
h—d
) \

2359 { 
NULL
 }

	)

2361 
	#SLIST_ENTRY
(
ty³
) \

2363 
ty³
 *
¦e_Ãxt
; \

2364 }

	)

2366 
	#SLIST_CLASS_ENTRY
(
ty³
) \

2368 
şass
 
ty³
 *
¦e_Ãxt
; \

2369 }

	)

2374 
	#SLIST_EMPTY
(
h—d
è((h—d)->
¦h_fœ¡
 =ğ
NULL
)

	)

2376 
	#SLIST_FIRST
(
h—d
è((h—d)->
¦h_fœ¡
)

	)

2378 
	#SLIST_FOREACH
(
v¬
, 
h—d
, 
f›ld
) \

2379 (
v¬
èğ
	`SLIST_FIRST
((
h—d
)); \

2380 (
v¬
); \

2381 (
v¬
èğ
	`SLIST_NEXT
((v¬), 
f›ld
))

	)

2383 
	#SLIST_FOREACH_FROM
(
v¬
, 
h—d
, 
f›ld
) \

2384 (
v¬
èğ((v¬è? (v¬è: 
	`SLIST_FIRST
((
h—d
))); \

2385 (
v¬
); \

2386 (
v¬
èğ
	`SLIST_NEXT
((v¬), 
f›ld
))

	)

2388 
	#SLIST_FOREACH_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

2389 (
v¬
èğ
	`SLIST_FIRST
((
h—d
)); \

2390 (
v¬
è&& ((
tv¬
èğ
	`SLIST_NEXT
((v¬), 
f›ld
), 1); \

2391 (
v¬
èğ(
tv¬
))

	)

2393 
	#SLIST_FOREACH_FROM_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

2394 (
v¬
èğ((v¬è? (v¬è: 
	`SLIST_FIRST
((
h—d
))); \

2395 (
v¬
è&& ((
tv¬
èğ
	`SLIST_NEXT
((v¬), 
f›ld
), 1); \

2396 (
v¬
èğ(
tv¬
))

	)

2398 
	#SLIST_FOREACH_PREVPTR
(
v¬
, 
v¬p
, 
h—d
, 
f›ld
) \

2399 (
v¬p
èğ&
	`SLIST_FIRST
((
h—d
)); \

2400 ((
v¬
èğ*(
v¬p
)è!ğ
NULL
; \

2401 (
v¬p
èğ&
	`SLIST_NEXT
((
v¬
), 
f›ld
))

	)

2403 
	#SLIST_INIT
(
h—d
) do { \

2404 
	`SLIST_FIRST
((
h—d
)èğ
NULL
; \

2405 } 0)

	)

2407 
	#SLIST_INSERT_AFTER
(
¦i¡–m
, 
–m
, 
f›ld
) do { \

2408 
	`SLIST_NEXT
((
–m
), 
f›ld
èğSLIST_NEXT((
¦i¡–m
), field); \

2409 
	`SLIST_NEXT
((
¦i¡–m
), 
f›ld
èğ(
–m
); \

2410 } 0)

	)

2412 
	#SLIST_INSERT_HEAD
(
h—d
, 
–m
, 
f›ld
) do { \

2413 
	`SLIST_NEXT
((
–m
), 
f›ld
èğ
	`SLIST_FIRST
((
h—d
)); \

2414 
	`SLIST_FIRST
((
h—d
)èğ(
–m
); \

2415 } 0)

	)

2417 
	#SLIST_NEXT
(
–m
, 
f›ld
è(Ólm)->f›ld.
¦e_Ãxt
)

	)

2419 
	#SLIST_REMOVE
(
h—d
, 
–m
, 
ty³
, 
f›ld
) do { \

2420 
	`QMD_SAVELINK
(
ŞdÃxt
, (
–m
)->
f›ld
.
¦e_Ãxt
); \

2421 ià(
	`SLIST_FIRST
((
h—d
)è=ğ(
–m
)) { \

2422 
	`SLIST_REMOVE_HEAD
((
h—d
), 
f›ld
); \

2425 
	`QUEUE_TYPEOF
(
ty³
è*
cu»lm
 = 
	`SLIST_FIRST
(
h—d
); \

2426 
	`SLIST_NEXT
(
cu»lm
, 
f›ld
è!ğ(
–m
)) \

2427 
cu»lm
 = 
	`SLIST_NEXT
(cu»lm, 
f›ld
); \

2428 
	`SLIST_REMOVE_AFTER
(
cu»lm
, 
f›ld
); \

2430 
	`TRASHIT
(*
ŞdÃxt
); \

2431 } 0)

	)

2433 
	#SLIST_REMOVE_AFTER
(
–m
, 
f›ld
) do { \

2434 
	`SLIST_NEXT
(
–m
, 
f›ld
) = \

2435 
	`SLIST_NEXT
(SLIST_NEXT(
–m
, 
f›ld
), field); \

2436 } 0)

	)

2438 
	#SLIST_REMOVE_HEAD
(
h—d
, 
f›ld
) do { \

2439 
	`SLIST_FIRST
((
h—d
)èğ
	`SLIST_NEXT
(SLIST_FIRST((h—d)), 
f›ld
); \

2440 } 0)

	)

2442 
	#SLIST_SWAP
(
h—d1
, 
h—d2
, 
ty³
) do { \

2443 
	`QUEUE_TYPEOF
(
ty³
è*
sw­_fœ¡
 = 
	`SLIST_FIRST
(
h—d1
); \

2444 
	`SLIST_FIRST
(
h—d1
èğSLIST_FIRST(
h—d2
); \

2445 
	`SLIST_FIRST
(
h—d2
èğ
sw­_fœ¡
; \

2446 } 0)

	)

2451 
	#STAILQ_HEAD
(
Çme
, 
ty³
) \

2452 
	sÇme
 { \

2453 
ty³
 *
¡qh_fœ¡
; \

2454 
ty³
 **
¡qh_Ï¡
; \

2455 }

	)

2457 
	#STAILQ_CLASS_HEAD
(
Çme
, 
ty³
) \

2458 
	sÇme
 { \

2459 
şass
 
ty³
 *
¡qh_fœ¡
; \

2460 
şass
 
ty³
 **
¡qh_Ï¡
; \

2461 }

	)

2463 
	#STAILQ_HEAD_INITIALIZER
(
h—d
) \

2464 { 
NULL
, &(
h—d
).
¡qh_fœ¡
 }

	)

2466 
	#STAILQ_ENTRY
(
ty³
) \

2468 
ty³
 *
¡qe_Ãxt
; \

2469 }

	)

2471 
	#STAILQ_CLASS_ENTRY
(
ty³
) \

2473 
şass
 
ty³
 *
¡qe_Ãxt
; \

2474 }

	)

2479 
	#STAILQ_CONCAT
(
h—d1
, 
h—d2
) do { \

2480 ià(!
	`STAILQ_EMPTY
((
h—d2
))) { \

2481 *(
h—d1
)->
¡qh_Ï¡
 = (
h—d2
)->
¡qh_fœ¡
; \

2482 (
h—d1
)->
¡qh_Ï¡
 = (
h—d2
)->stqh_last; \

2483 
	`STAILQ_INIT
((
h—d2
)); \

2485 } 0)

	)

2487 
	#STAILQ_EMPTY
(
h—d
è((h—d)->
¡qh_fœ¡
 =ğ
NULL
)

	)

2489 
	#STAILQ_FIRST
(
h—d
è((h—d)->
¡qh_fœ¡
)

	)

2491 
	#STAILQ_FOREACH
(
v¬
, 
h—d
, 
f›ld
) \

2492 (
v¬
èğ
	`STAILQ_FIRST
((
h—d
)); \

2493 (
v¬
); \

2494 (
v¬
èğ
	`STAILQ_NEXT
((v¬), 
f›ld
))

	)

2496 
	#STAILQ_FOREACH_FROM
(
v¬
, 
h—d
, 
f›ld
) \

2497 (
v¬
èğ((v¬è? (v¬è: 
	`STAILQ_FIRST
((
h—d
))); \

2498 (
v¬
); \

2499 (
v¬
èğ
	`STAILQ_NEXT
((v¬), 
f›ld
))

	)

2501 
	#STAILQ_FOREACH_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

2502 (
v¬
èğ
	`STAILQ_FIRST
((
h—d
)); \

2503 (
v¬
è&& ((
tv¬
èğ
	`STAILQ_NEXT
((v¬), 
f›ld
), 1); \

2504 (
v¬
èğ(
tv¬
))

	)

2506 
	#STAILQ_FOREACH_FROM_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

2507 (
v¬
èğ((v¬è? (v¬è: 
	`STAILQ_FIRST
((
h—d
))); \

2508 (
v¬
è&& ((
tv¬
èğ
	`STAILQ_NEXT
((v¬), 
f›ld
), 1); \

2509 (
v¬
èğ(
tv¬
))

	)

2511 
	#STAILQ_INIT
(
h—d
) do { \

2512 
	`STAILQ_FIRST
((
h—d
)èğ
NULL
; \

2513 (
h—d
)->
¡qh_Ï¡
 = &
	`STAILQ_FIRST
((head)); \

2514 } 0)

	)

2516 
	#STAILQ_INSERT_AFTER
(
h—d
, 
tq–m
, 
–m
, 
f›ld
) do { \

2517 ià((
	`STAILQ_NEXT
((
–m
), 
f›ld
èğSTAILQ_NEXT((
tq–m
), f›ld)è=ğ
NULL
)\

2518 (
h—d
)->
¡qh_Ï¡
 = &
	`STAILQ_NEXT
((
–m
), 
f›ld
); \

2519 
	`STAILQ_NEXT
((
tq–m
), 
f›ld
èğ(
–m
); \

2520 } 0)

	)

2522 
	#STAILQ_INSERT_HEAD
(
h—d
, 
–m
, 
f›ld
) do { \

2523 ià((
	`STAILQ_NEXT
((
–m
), 
f›ld
èğ
	`STAILQ_FIRST
((
h—d
))è=ğ
NULL
) \

2524 (
h—d
)->
¡qh_Ï¡
 = &
	`STAILQ_NEXT
((
–m
), 
f›ld
); \

2525 
	`STAILQ_FIRST
((
h—d
)èğ(
–m
); \

2526 } 0)

	)

2528 
	#STAILQ_INSERT_TAIL
(
h—d
, 
–m
, 
f›ld
) do { \

2529 
	`STAILQ_NEXT
((
–m
), 
f›ld
èğ
NULL
; \

2530 *(
h—d
)->
¡qh_Ï¡
 = (
–m
); \

2531 (
h—d
)->
¡qh_Ï¡
 = &
	`STAILQ_NEXT
((
–m
), 
f›ld
); \

2532 } 0)

	)

2534 
	#STAILQ_LAST
(
h—d
, 
ty³
, 
f›ld
) \

2535 (
	`STAILQ_EMPTY
((
h—d
)è? 
NULL
 : \

2536 
	`__cÚš”of
((
h—d
)->
¡qh_Ï¡
, \

2537 
	`QUEUE_TYPEOF
(
ty³
), 
f›ld
.
¡qe_Ãxt
))

	)

2539 
	#STAILQ_NEXT
(
–m
, 
f›ld
è(Ólm)->f›ld.
¡qe_Ãxt
)

	)

2541 
	#STAILQ_REMOVE
(
h—d
, 
–m
, 
ty³
, 
f›ld
) do { \

2542 
	`QMD_SAVELINK
(
ŞdÃxt
, (
–m
)->
f›ld
.
¡qe_Ãxt
); \

2543 ià(
	`STAILQ_FIRST
((
h—d
)è=ğ(
–m
)) { \

2544 
	`STAILQ_REMOVE_HEAD
((
h—d
), 
f›ld
); \

2547 
	`QUEUE_TYPEOF
(
ty³
è*
cu»lm
 = 
	`STAILQ_FIRST
(
h—d
); \

2548 
	`STAILQ_NEXT
(
cu»lm
, 
f›ld
è!ğ(
–m
)) \

2549 
cu»lm
 = 
	`STAILQ_NEXT
(cu»lm, 
f›ld
); \

2550 
	`STAILQ_REMOVE_AFTER
(
h—d
, 
cu»lm
, 
f›ld
); \

2552 
	`TRASHIT
(*
ŞdÃxt
); \

2553 } 0)

	)

2555 
	#STAILQ_REMOVE_AFTER
(
h—d
, 
–m
, 
f›ld
) do { \

2556 ià((
	`STAILQ_NEXT
(
–m
, 
f›ld
) = \

2557 
	`STAILQ_NEXT
(STAILQ_NEXT(
–m
, 
f›ld
), f›ld)è=ğ
NULL
) \

2558 (
h—d
)->
¡qh_Ï¡
 = &
	`STAILQ_NEXT
((
–m
), 
f›ld
); \

2559 } 0)

	)

2561 
	#STAILQ_REMOVE_HEAD
(
h—d
, 
f›ld
) do { \

2562 ià((
	`STAILQ_FIRST
((
h—d
)) = \

2563 
	`STAILQ_NEXT
(
	`STAILQ_FIRST
((
h—d
)), 
f›ld
)è=ğ
NULL
) \

2564 (
h—d
)->
¡qh_Ï¡
 = &
	`STAILQ_FIRST
((head)); \

2565 } 0)

	)

2567 
	#STAILQ_SWAP
(
h—d1
, 
h—d2
, 
ty³
) do { \

2568 
	`QUEUE_TYPEOF
(
ty³
è*
sw­_fœ¡
 = 
	`STAILQ_FIRST
(
h—d1
); \

2569 
	`QUEUE_TYPEOF
(
ty³
è**
sw­_Ï¡
 = (
h—d1
)->
¡qh_Ï¡
; \

2570 
	`STAILQ_FIRST
(
h—d1
èğSTAILQ_FIRST(
h—d2
); \

2571 (
h—d1
)->
¡qh_Ï¡
 = (
h—d2
)->stqh_last; \

2572 
	`STAILQ_FIRST
(
h—d2
èğ
sw­_fœ¡
; \

2573 (
h—d2
)->
¡qh_Ï¡
 = 
sw­_Ï¡
; \

2574 ià(
	`STAILQ_EMPTY
(
h—d1
)) \

2575 (
h—d1
)->
¡qh_Ï¡
 = &
	`STAILQ_FIRST
(head1); \

2576 ià(
	`STAILQ_EMPTY
(
h—d2
)) \

2577 (
h—d2
)->
¡qh_Ï¡
 = &
	`STAILQ_FIRST
(head2); \

2578 } 0)

	)

2584 
	#LIST_HEAD
(
Çme
, 
ty³
) \

2585 
	sÇme
 { \

2586 
ty³
 *
lh_fœ¡
; \

2587 }

	)

2589 
	#LIST_CLASS_HEAD
(
Çme
, 
ty³
) \

2590 
	sÇme
 { \

2591 
şass
 
ty³
 *
lh_fœ¡
; \

2592 }

	)

2594 
	#LIST_HEAD_INITIALIZER
(
h—d
) \

2595 { 
NULL
 }

	)

2597 
	#LIST_ENTRY
(
ty³
) \

2599 
ty³
 *
Ë_Ãxt
; \

2600 
ty³
 **
Ë_´ev
; \

2601 }

	)

2603 
	#LIST_CLASS_ENTRY
(
ty³
) \

2605 
şass
 
ty³
 *
Ë_Ãxt
; \

2606 
şass
 
ty³
 **
Ë_´ev
; \

2607 }

	)

2613 #ià(
defšed
(
_KERNEL
è&& defšed(
INVARIANTS
))

2614 
	#QMD_LIST_CHECK_HEAD
(
h—d
, 
f›ld
) do { \

2615 ià(
	`LIST_FIRST
((
h—d
)è!ğ
NULL
 && \

2616 
	`LIST_FIRST
((
h—d
))->
f›ld
.
Ë_´ev
 != \

2617 &
	`LIST_FIRST
((
h—d
))) \

2618 
	`·nic
("Bad†i¡ h—d %°fœ¡->´ev !ğh—d", (
h—d
)); \

2619 } 0)

	)

2621 
	#QMD_LIST_CHECK_NEXT
(
–m
, 
f›ld
) do { \

2622 ià(
	`LIST_NEXT
((
–m
), 
f›ld
è!ğ
NULL
 && \

2623 
	`LIST_NEXT
((
–m
), 
f›ld
)->f›ld.
Ë_´ev
 != \

2624 &((
–m
)->
f›ld
.
Ë_Ãxt
)) \

2625 
	`·nic
("Bad†škƒlm %°Ãxt->´ev !ğ–m", (
–m
)); \

2626 } 0)

	)

2628 
	#QMD_LIST_CHECK_PREV
(
–m
, 
f›ld
) do { \

2629 ià(*(
–m
)->
f›ld
.
Ë_´ev
 != (elm)) \

2630 
	`·nic
("Bad†škƒlm %°´ev->Ãxˆ!ğ–m", (
–m
)); \

2631 } 0)

	)

2633 
	#QMD_LIST_CHECK_HEAD
(
h—d
, 
f›ld
)

	)

2634 
	#QMD_LIST_CHECK_NEXT
(
–m
, 
f›ld
)

	)

2635 
	#QMD_LIST_CHECK_PREV
(
–m
, 
f›ld
)

	)

2638 
	#LIST_EMPTY
(
h—d
è((h—d)->
lh_fœ¡
 =ğ
NULL
)

	)

2640 
	#LIST_FIRST
(
h—d
è((h—d)->
lh_fœ¡
)

	)

2642 
	#LIST_FOREACH
(
v¬
, 
h—d
, 
f›ld
) \

2643 (
v¬
èğ
	`LIST_FIRST
((
h—d
)); \

2644 (
v¬
); \

2645 (
v¬
èğ
	`LIST_NEXT
((v¬), 
f›ld
))

	)

2647 
	#LIST_FOREACH_FROM
(
v¬
, 
h—d
, 
f›ld
) \

2648 (
v¬
èğ((v¬è? (v¬è: 
	`LIST_FIRST
((
h—d
))); \

2649 (
v¬
); \

2650 (
v¬
èğ
	`LIST_NEXT
((v¬), 
f›ld
))

	)

2652 
	#LIST_FOREACH_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

2653 (
v¬
èğ
	`LIST_FIRST
((
h—d
)); \

2654 (
v¬
è&& ((
tv¬
èğ
	`LIST_NEXT
((v¬), 
f›ld
), 1); \

2655 (
v¬
èğ(
tv¬
))

	)

2657 
	#LIST_FOREACH_FROM_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

2658 (
v¬
èğ((v¬è? (v¬è: 
	`LIST_FIRST
((
h—d
))); \

2659 (
v¬
è&& ((
tv¬
èğ
	`LIST_NEXT
((v¬), 
f›ld
), 1); \

2660 (
v¬
èğ(
tv¬
))

	)

2662 
	#LIST_INIT
(
h—d
) do { \

2663 
	`LIST_FIRST
((
h—d
)èğ
NULL
; \

2664 } 0)

	)

2666 
	#LIST_INSERT_AFTER
(
li¡–m
, 
–m
, 
f›ld
) do { \

2667 
	`QMD_LIST_CHECK_NEXT
(
li¡–m
, 
f›ld
); \

2668 ià((
	`LIST_NEXT
((
–m
), 
f›ld
èğLIST_NEXT((
li¡–m
), f›ld)è!ğ
NULL
)\

2669 
	`LIST_NEXT
((
li¡–m
), 
f›ld
)->f›ld.
Ë_´ev
 = \

2670 &
	`LIST_NEXT
((
–m
), 
f›ld
); \

2671 
	`LIST_NEXT
((
li¡–m
), 
f›ld
èğ(
–m
); \

2672 (
–m
)->
f›ld
.
Ë_´ev
 = &
	`LIST_NEXT
((
li¡–m
), field); \

2673 } 0)

	)

2675 
	#LIST_INSERT_BEFORE
(
li¡–m
, 
–m
, 
f›ld
) do { \

2676 
	`QMD_LIST_CHECK_PREV
(
li¡–m
, 
f›ld
); \

2677 (
–m
)->
f›ld
.
Ë_´ev
 = (
li¡–m
)->field.le_prev; \

2678 
	`LIST_NEXT
((
–m
), 
f›ld
èğ(
li¡–m
); \

2679 *(
li¡–m
)->
f›ld
.
Ë_´ev
 = (
–m
); \

2680 (
li¡–m
)->
f›ld
.
Ë_´ev
 = &
	`LIST_NEXT
((
–m
), field); \

2681 } 0)

	)

2683 
	#LIST_INSERT_HEAD
(
h—d
, 
–m
, 
f›ld
) do { \

2684 
	`QMD_LIST_CHECK_HEAD
((
h—d
), 
f›ld
); \

2685 ià((
	`LIST_NEXT
((
–m
), 
f›ld
èğ
	`LIST_FIRST
((
h—d
))è!ğ
NULL
) \

2686 
	`LIST_FIRST
((
h—d
))->
f›ld
.
Ë_´ev
 = &
	`LIST_NEXT
((
–m
), field);\

2687 
	`LIST_FIRST
((
h—d
)èğ(
–m
); \

2688 (
–m
)->
f›ld
.
Ë_´ev
 = &
	`LIST_FIRST
((
h—d
)); \

2689 } 0)

	)

2691 
	#LIST_NEXT
(
–m
, 
f›ld
è(Ólm)->f›ld.
Ë_Ãxt
)

	)

2693 
	#LIST_PREV
(
–m
, 
h—d
, 
ty³
, 
f›ld
) \

2694 ((
–m
)->
f›ld
.
Ë_´ev
 =ğ&
	`LIST_FIRST
((
h—d
)è? 
NULL
 : \

2695 
	`__cÚš”of
((
–m
)->
f›ld
.
Ë_´ev
, \

2696 
	`QUEUE_TYPEOF
(
ty³
), 
f›ld
.
Ë_Ãxt
))

	)

2698 
	#LIST_REMOVE
(
–m
, 
f›ld
) do { \

2699 
	`QMD_SAVELINK
(
ŞdÃxt
, (
–m
)->
f›ld
.
Ë_Ãxt
); \

2700 
	`QMD_SAVELINK
(
Şd´ev
, (
–m
)->
f›ld
.
Ë_´ev
); \

2701 
	`QMD_LIST_CHECK_NEXT
(
–m
, 
f›ld
); \

2702 
	`QMD_LIST_CHECK_PREV
(
–m
, 
f›ld
); \

2703 ià(
	`LIST_NEXT
((
–m
), 
f›ld
è!ğ
NULL
) \

2704 
	`LIST_NEXT
((
–m
), 
f›ld
)->f›ld.
Ë_´ev
 = \

2705 (
–m
)->
f›ld
.
Ë_´ev
; \

2706 *(
–m
)->
f›ld
.
Ë_´ev
 = 
	`LIST_NEXT
((elm), field); \

2707 
	`TRASHIT
(*
ŞdÃxt
); \

2708 
	`TRASHIT
(*
Şd´ev
); \

2709 } 0)

	)

2711 
	#LIST_SWAP
(
h—d1
, 
h—d2
, 
ty³
, 
f›ld
) do { \

2712 
	`QUEUE_TYPEOF
(
ty³
è*
sw­_tmp
 = 
	`LIST_FIRST
(
h—d1
); \

2713 
	`LIST_FIRST
((
h—d1
)èğLIST_FIRST((
h—d2
)); \

2714 
	`LIST_FIRST
((
h—d2
)èğ
sw­_tmp
; \

2715 ià((
sw­_tmp
 = 
	`LIST_FIRST
((
h—d1
))è!ğ
NULL
) \

2716 
sw­_tmp
->
f›ld
.
Ë_´ev
 = &
	`LIST_FIRST
((
h—d1
)); \

2717 ià((
sw­_tmp
 = 
	`LIST_FIRST
((
h—d2
))è!ğ
NULL
) \

2718 
sw­_tmp
->
f›ld
.
Ë_´ev
 = &
	`LIST_FIRST
((
h—d2
)); \

2719 } 0)

	)

2724 
	#TAILQ_HEAD
(
Çme
, 
ty³
) \

2725 
	sÇme
 { \

2726 
ty³
 *
tqh_fœ¡
; \

2727 
ty³
 **
tqh_Ï¡
; \

2728 
TRACEBUF
 \

2729 }

	)

2731 
	#TAILQ_CLASS_HEAD
(
Çme
, 
ty³
) \

2732 
	sÇme
 { \

2733 
şass
 
ty³
 *
tqh_fœ¡
; \

2734 
şass
 
ty³
 **
tqh_Ï¡
; \

2735 
TRACEBUF
 \

2736 }

	)

2738 
	#TAILQ_HEAD_INITIALIZER
(
h—d
) \

2739 { 
NULL
, &(
h—d
).
tqh_fœ¡
, 
TRACEBUF_INITIALIZER
 }

	)

2741 
	#TAILQ_ENTRY
(
ty³
) \

2743 
ty³
 *
tqe_Ãxt
; \

2744 
ty³
 **
tqe_´ev
; \

2745 
TRACEBUF
 \

2746 }

	)

2748 
	#TAILQ_CLASS_ENTRY
(
ty³
) \

2750 
şass
 
ty³
 *
tqe_Ãxt
; \

2751 
şass
 
ty³
 **
tqe_´ev
; \

2752 
TRACEBUF
 \

2753 }

	)

2758 #ià(
defšed
(
_KERNEL
è&& defšed(
INVARIANTS
))

2759 
	#QMD_TAILQ_CHECK_HEAD
(
h—d
, 
f›ld
) do { \

2760 ià(!
	`TAILQ_EMPTY
(
h—d
) && \

2761 
	`TAILQ_FIRST
((
h—d
))->
f›ld
.
tqe_´ev
 != \

2762 &
	`TAILQ_FIRST
((
h—d
))) \

2763 
	`·nic
("Badaq h—d %°fœ¡->´ev !ğh—d", (
h—d
)); \

2764 } 0)

	)

2766 
	#QMD_TAILQ_CHECK_TAIL
(
h—d
, 
f›ld
) do { \

2767 ià(*(
h—d
)->
tqh_Ï¡
 !ğ
NULL
) \

2768 
	`·nic
("Badaq NEXT(%p->tqh_Ï¡è!ğNULL", (
h—d
)); \

2769 } 0)

	)

2771 
	#QMD_TAILQ_CHECK_NEXT
(
–m
, 
f›ld
) do { \

2772 ià(
	`TAILQ_NEXT
((
–m
), 
f›ld
è!ğ
NULL
 && \

2773 
	`TAILQ_NEXT
((
–m
), 
f›ld
)->f›ld.
tqe_´ev
 != \

2774 &((
–m
)->
f›ld
.
tqe_Ãxt
)) \

2775 
	`·nic
("Bad†škƒlm %°Ãxt->´ev !ğ–m", (
–m
)); \

2776 } 0)

	)

2778 
	#QMD_TAILQ_CHECK_PREV
(
–m
, 
f›ld
) do { \

2779 ià(*(
–m
)->
f›ld
.
tqe_´ev
 != (elm)) \

2780 
	`·nic
("Bad†škƒlm %°´ev->Ãxˆ!ğ–m", (
–m
)); \

2781 } 0)

	)

2783 
	#QMD_TAILQ_CHECK_HEAD
(
h—d
, 
f›ld
)

	)

2784 
	#QMD_TAILQ_CHECK_TAIL
(
h—d
, 
h—dÇme
)

	)

2785 
	#QMD_TAILQ_CHECK_NEXT
(
–m
, 
f›ld
)

	)

2786 
	#QMD_TAILQ_CHECK_PREV
(
–m
, 
f›ld
)

	)

2789 
	#TAILQ_CONCAT
(
h—d1
, 
h—d2
, 
f›ld
) do { \

2790 ià(!
	`TAILQ_EMPTY
(
h—d2
)) { \

2791 *(
h—d1
)->
tqh_Ï¡
 = (
h—d2
)->
tqh_fœ¡
; \

2792 (
h—d2
)->
tqh_fœ¡
->
f›ld
.
tqe_´ev
 = (
h—d1
)->
tqh_Ï¡
; \

2793 (
h—d1
)->
tqh_Ï¡
 = (
h—d2
)->tqh_last; \

2794 
	`TAILQ_INIT
((
h—d2
)); \

2795 
	`QMD_TRACE_HEAD
(
h—d1
); \

2796 
	`QMD_TRACE_HEAD
(
h—d2
); \

2798 } 0)

	)

2800 
	#TAILQ_EMPTY
(
h—d
è((h—d)->
tqh_fœ¡
 =ğ
NULL
)

	)

2802 
	#TAILQ_FIRST
(
h—d
è((h—d)->
tqh_fœ¡
)

	)

2804 
	#TAILQ_FOREACH
(
v¬
, 
h—d
, 
f›ld
) \

2805 (
v¬
èğ
	`TAILQ_FIRST
((
h—d
)); \

2806 (
v¬
); \

2807 (
v¬
èğ
	`TAILQ_NEXT
((v¬), 
f›ld
))

	)

2809 
	#TAILQ_FOREACH_FROM
(
v¬
, 
h—d
, 
f›ld
) \

2810 (
v¬
èğ((v¬è? (v¬è: 
	`TAILQ_FIRST
((
h—d
))); \

2811 (
v¬
); \

2812 (
v¬
èğ
	`TAILQ_NEXT
((v¬), 
f›ld
))

	)

2814 
	#TAILQ_FOREACH_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

2815 (
v¬
èğ
	`TAILQ_FIRST
((
h—d
)); \

2816 (
v¬
è&& ((
tv¬
èğ
	`TAILQ_NEXT
((v¬), 
f›ld
), 1); \

2817 (
v¬
èğ(
tv¬
))

	)

2819 
	#TAILQ_FOREACH_FROM_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

2820 (
v¬
èğ((v¬è? (v¬è: 
	`TAILQ_FIRST
((
h—d
))); \

2821 (
v¬
è&& ((
tv¬
èğ
	`TAILQ_NEXT
((v¬), 
f›ld
), 1); \

2822 (
v¬
èğ(
tv¬
))

	)

2824 
	#TAILQ_FOREACH_REVERSE
(
v¬
, 
h—d
, 
h—dÇme
, 
f›ld
) \

2825 (
v¬
èğ
	`TAILQ_LAST
((
h—d
), 
h—dÇme
); \

2826 (
v¬
); \

2827 (
v¬
èğ
	`TAILQ_PREV
((v¬), 
h—dÇme
, 
f›ld
))

	)

2829 
	#TAILQ_FOREACH_REVERSE_FROM
(
v¬
, 
h—d
, 
h—dÇme
, 
f›ld
) \

2830 (
v¬
èğ((v¬è? (v¬è: 
	`TAILQ_LAST
((
h—d
), 
h—dÇme
)); \

2831 (
v¬
); \

2832 (
v¬
èğ
	`TAILQ_PREV
((v¬), 
h—dÇme
, 
f›ld
))

	)

2834 
	#TAILQ_FOREACH_REVERSE_SAFE
(
v¬
, 
h—d
, 
h—dÇme
, 
f›ld
, 
tv¬
) \

2835 (
v¬
èğ
	`TAILQ_LAST
((
h—d
), 
h—dÇme
); \

2836 (
v¬
è&& ((
tv¬
èğ
	`TAILQ_PREV
((v¬), 
h—dÇme
, 
f›ld
), 1); \

2837 (
v¬
èğ(
tv¬
))

	)

2839 
	#TAILQ_FOREACH_REVERSE_FROM_SAFE
(
v¬
, 
h—d
, 
h—dÇme
, 
f›ld
, 
tv¬
) \

2840 (
v¬
èğ((v¬è? (v¬è: 
	`TAILQ_LAST
((
h—d
), 
h—dÇme
)); \

2841 (
v¬
è&& ((
tv¬
èğ
	`TAILQ_PREV
((v¬), 
h—dÇme
, 
f›ld
), 1); \

2842 (
v¬
èğ(
tv¬
))

	)

2844 
	#TAILQ_INIT
(
h—d
) do { \

2845 
	`TAILQ_FIRST
((
h—d
)èğ
NULL
; \

2846 (
h—d
)->
tqh_Ï¡
 = &
	`TAILQ_FIRST
((head)); \

2847 
	`QMD_TRACE_HEAD
(
h—d
); \

2848 } 0)

	)

2850 
	#TAILQ_INSERT_AFTER
(
h—d
, 
li¡–m
, 
–m
, 
f›ld
) do { \

2851 
	`QMD_TAILQ_CHECK_NEXT
(
li¡–m
, 
f›ld
); \

2852 ià((
	`TAILQ_NEXT
((
–m
), 
f›ld
èğTAILQ_NEXT((
li¡–m
), f›ld)è!ğ
NULL
)\

2853 
	`TAILQ_NEXT
((
–m
), 
f›ld
)->f›ld.
tqe_´ev
 = \

2854 &
	`TAILQ_NEXT
((
–m
), 
f›ld
); \

2856 (
h—d
)->
tqh_Ï¡
 = &
	`TAILQ_NEXT
((
–m
), 
f›ld
); \

2857 
	`QMD_TRACE_HEAD
(
h—d
); \

2859 
	`TAILQ_NEXT
((
li¡–m
), 
f›ld
èğ(
–m
); \

2860 (
–m
)->
f›ld
.
tqe_´ev
 = &
	`TAILQ_NEXT
((
li¡–m
), field); \

2861 
	`QMD_TRACE_ELEM
(&(
–m
)->
f›ld
); \

2862 
	`QMD_TRACE_ELEM
(&(
li¡–m
)->
f›ld
); \

2863 } 0)

	)

2865 
	#TAILQ_INSERT_BEFORE
(
li¡–m
, 
–m
, 
f›ld
) do { \

2866 
	`QMD_TAILQ_CHECK_PREV
(
li¡–m
, 
f›ld
); \

2867 (
–m
)->
f›ld
.
tqe_´ev
 = (
li¡–m
)->field.tqe_prev; \

2868 
	`TAILQ_NEXT
((
–m
), 
f›ld
èğ(
li¡–m
); \

2869 *(
li¡–m
)->
f›ld
.
tqe_´ev
 = (
–m
); \

2870 (
li¡–m
)->
f›ld
.
tqe_´ev
 = &
	`TAILQ_NEXT
((
–m
), field); \

2871 
	`QMD_TRACE_ELEM
(&(
–m
)->
f›ld
); \

2872 
	`QMD_TRACE_ELEM
(&(
li¡–m
)->
f›ld
); \

2873 } 0)

	)

2875 
	#TAILQ_INSERT_HEAD
(
h—d
, 
–m
, 
f›ld
) do { \

2876 
	`QMD_TAILQ_CHECK_HEAD
(
h—d
, 
f›ld
); \

2877 ià((
	`TAILQ_NEXT
((
–m
), 
f›ld
èğ
	`TAILQ_FIRST
((
h—d
))è!ğ
NULL
) \

2878 
	`TAILQ_FIRST
((
h—d
))->
f›ld
.
tqe_´ev
 = \

2879 &
	`TAILQ_NEXT
((
–m
), 
f›ld
); \

2881 (
h—d
)->
tqh_Ï¡
 = &
	`TAILQ_NEXT
((
–m
), 
f›ld
); \

2882 
	`TAILQ_FIRST
((
h—d
)èğ(
–m
); \

2883 (
–m
)->
f›ld
.
tqe_´ev
 = &
	`TAILQ_FIRST
((
h—d
)); \

2884 
	`QMD_TRACE_HEAD
(
h—d
); \

2885 
	`QMD_TRACE_ELEM
(&(
–m
)->
f›ld
); \

2886 } 0)

	)

2888 
	#TAILQ_INSERT_TAIL
(
h—d
, 
–m
, 
f›ld
) do { \

2889 
	`QMD_TAILQ_CHECK_TAIL
(
h—d
, 
f›ld
); \

2890 
	`TAILQ_NEXT
((
–m
), 
f›ld
èğ
NULL
; \

2891 (
–m
)->
f›ld
.
tqe_´ev
 = (
h—d
)->
tqh_Ï¡
; \

2892 *(
h—d
)->
tqh_Ï¡
 = (
–m
); \

2893 (
h—d
)->
tqh_Ï¡
 = &
	`TAILQ_NEXT
((
–m
), 
f›ld
); \

2894 
	`QMD_TRACE_HEAD
(
h—d
); \

2895 
	`QMD_TRACE_ELEM
(&(
–m
)->
f›ld
); \

2896 } 0)

	)

2898 
	#TAILQ_LAST
(
h—d
, 
h—dÇme
) \

2899 (*(((
h—dÇme
 *)((
h—d
)->
tqh_Ï¡
))->tqh_Ï¡))

	)

2901 
	#TAILQ_NEXT
(
–m
, 
f›ld
è(Ólm)->f›ld.
tqe_Ãxt
)

	)

2903 
	#TAILQ_PREV
(
–m
, 
h—dÇme
, 
f›ld
) \

2904 (*(((
h—dÇme
 *)((
–m
)->
f›ld
.
tqe_´ev
))->
tqh_Ï¡
))

	)

2906 
	#TAILQ_REMOVE
(
h—d
, 
–m
, 
f›ld
) do { \

2907 
	`QMD_SAVELINK
(
ŞdÃxt
, (
–m
)->
f›ld
.
tqe_Ãxt
); \

2908 
	`QMD_SAVELINK
(
Şd´ev
, (
–m
)->
f›ld
.
tqe_´ev
); \

2909 
	`QMD_TAILQ_CHECK_NEXT
(
–m
, 
f›ld
); \

2910 
	`QMD_TAILQ_CHECK_PREV
(
–m
, 
f›ld
); \

2911 ià((
	`TAILQ_NEXT
((
–m
), 
f›ld
)è!ğ
NULL
) \

2912 
	`TAILQ_NEXT
((
–m
), 
f›ld
)->f›ld.
tqe_´ev
 = \

2913 (
–m
)->
f›ld
.
tqe_´ev
; \

2915 (
h—d
)->
tqh_Ï¡
 = (
–m
)->
f›ld
.
tqe_´ev
; \

2916 
	`QMD_TRACE_HEAD
(
h—d
); \

2918 *(
–m
)->
f›ld
.
tqe_´ev
 = 
	`TAILQ_NEXT
((elm), field); \

2919 
	`TRASHIT
(*
ŞdÃxt
); \

2920 
	`TRASHIT
(*
Şd´ev
); \

2921 
	`QMD_TRACE_ELEM
(&(
–m
)->
f›ld
); \

2922 } 0)

	)

2924 
	#TAILQ_SWAP
(
h—d1
, 
h—d2
, 
ty³
, 
f›ld
) do { \

2925 
	`QUEUE_TYPEOF
(
ty³
è*
sw­_fœ¡
 = (
h—d1
)->
tqh_fœ¡
; \

2926 
	`QUEUE_TYPEOF
(
ty³
è**
sw­_Ï¡
 = (
h—d1
)->
tqh_Ï¡
; \

2927 (
h—d1
)->
tqh_fœ¡
 = (
h—d2
)->tqh_first; \

2928 (
h—d1
)->
tqh_Ï¡
 = (
h—d2
)->tqh_last; \

2929 (
h—d2
)->
tqh_fœ¡
 = 
sw­_fœ¡
; \

2930 (
h—d2
)->
tqh_Ï¡
 = 
sw­_Ï¡
; \

2931 ià((
sw­_fœ¡
 = (
h—d1
)->
tqh_fœ¡
è!ğ
NULL
) \

2932 
sw­_fœ¡
->
f›ld
.
tqe_´ev
 = &(
h—d1
)->
tqh_fœ¡
; \

2934 (
h—d1
)->
tqh_Ï¡
 = &(h—d1)->
tqh_fœ¡
; \

2935 ià((
sw­_fœ¡
 = (
h—d2
)->
tqh_fœ¡
è!ğ
NULL
) \

2936 
sw­_fœ¡
->
f›ld
.
tqe_´ev
 = &(
h—d2
)->
tqh_fœ¡
; \

2938 (
h—d2
)->
tqh_Ï¡
 = &(h—d2)->
tqh_fœ¡
; \

2939 } 0)

	)

2942 #ifdeà
MG_MODULE_LINES


2950 #iâdeà
CS_MONGOOSE_SRC_FEATURES_H_


2951 
	#CS_MONGOOSE_SRC_FEATURES_H_


	)

2953 #iâdeà
MG_DISABLE_HTTP_DIGEST_AUTH


2954 
	#MG_DISABLE_HTTP_DIGEST_AUTH
 0

	)

2957 #iâdeà
MG_DISABLE_HTTP_KEEP_ALIVE


2958 
	#MG_DISABLE_HTTP_KEEP_ALIVE
 0

	)

2961 #iâdeà
MG_DISABLE_PFS


2962 
	#MG_DISABLE_PFS
 0

	)

2965 #iâdeà
MG_DISABLE_WS_RANDOM_MASK


2966 
	#MG_DISABLE_WS_RANDOM_MASK
 0

	)

2969 #iâdeà
MG_ENABLE_ASYNC_RESOLVER


2970 
	#MG_ENABLE_ASYNC_RESOLVER
 1

	)

2973 #iâdeà
MG_ENABLE_BROADCAST


2974 
	#MG_ENABLE_BROADCAST
 0

	)

2977 #iâdeà
MG_ENABLE_COAP


2978 
	#MG_ENABLE_COAP
 0

	)

2981 #iâdeà
MG_ENABLE_DEBUG


2982 
	#MG_ENABLE_DEBUG
 0

	)

2985 #iâdeà
MG_ENABLE_DIRECTORY_LISTING


2986 
	#MG_ENABLE_DIRECTORY_LISTING
 0

	)

2989 #iâdeà
MG_ENABLE_DNS


2990 
	#MG_ENABLE_DNS
 1

	)

2993 #iâdeà
MG_ENABLE_DNS_SERVER


2994 
	#MG_ENABLE_DNS_SERVER
 0

	)

2997 #iâdeà
MG_ENABLE_FAKE_DAVLOCK


2998 
	#MG_ENABLE_FAKE_DAVLOCK
 0

	)

3001 #iâdeà
MG_ENABLE_FILESYSTEM


3002 
	#MG_ENABLE_FILESYSTEM
 0

	)

3005 #iâdeà
MG_ENABLE_GETADDRINFO


3006 
	#MG_ENABLE_GETADDRINFO
 0

	)

3009 #iâdeà
MG_ENABLE_HEXDUMP


3010 
	#MG_ENABLE_HEXDUMP
 
CS_ENABLE_STDIO


	)

3013 #iâdeà
MG_ENABLE_HTTP


3014 
	#MG_ENABLE_HTTP
 1

	)

3017 #iâdeà
MG_ENABLE_HTTP_CGI


3018 
	#MG_ENABLE_HTTP_CGI
 0

	)

3021 #iâdeà
MG_ENABLE_HTTP_SSI


3022 
	#MG_ENABLE_HTTP_SSI
 
MG_ENABLE_FILESYSTEM


	)

3025 #iâdeà
MG_ENABLE_HTTP_SSI_EXEC


3026 
	#MG_ENABLE_HTTP_SSI_EXEC
 0

	)

3029 #iâdeà
MG_ENABLE_HTTP_STREAMING_MULTIPART


3030 
	#MG_ENABLE_HTTP_STREAMING_MULTIPART
 0

	)

3033 #iâdeà
MG_ENABLE_HTTP_WEBDAV


3034 
	#MG_ENABLE_HTTP_WEBDAV
 0

	)

3037 #iâdeà
MG_ENABLE_HTTP_WEBSOCKET


3038 
	#MG_ENABLE_HTTP_WEBSOCKET
 
MG_ENABLE_HTTP


	)

3041 #iâdeà
MG_ENABLE_IPV6


3042 
	#MG_ENABLE_IPV6
 0

	)

3045 #iâdeà
MG_ENABLE_MQTT


3046 
	#MG_ENABLE_MQTT
 1

	)

3049 #iâdeà
MG_ENABLE_SOCKS


3050 
	#MG_ENABLE_SOCKS
 0

	)

3053 #iâdeà
MG_ENABLE_MQTT_BROKER


3054 
	#MG_ENABLE_MQTT_BROKER
 0

	)

3057 #iâdeà
MG_ENABLE_SSL


3058 
	#MG_ENABLE_SSL
 0

	)

3061 #iâdeà
MG_ENABLE_SYNC_RESOLVER


3062 
	#MG_ENABLE_SYNC_RESOLVER
 0

	)

3065 #iâdeà
MG_ENABLE_STDIO


3066 
	#MG_ENABLE_STDIO
 
CS_ENABLE_STDIO


	)

3069 #iâdeà
MG_NET_IF


3070 
	#MG_NET_IF
 
MG_NET_IF_SOCKET


	)

3073 #iâdeà
MG_SSL_IF


3074 
	#MG_SSL_IF
 
MG_SSL_IF_OPENSSL


	)

3077 #iâdeà
MG_ENABLE_THREADS


3078 #ifdeà
_WIN32


3079 
	#MG_ENABLE_THREADS
 0

	)

3081 
	#MG_ENABLE_THREADS
 0

	)

3085 #ià
MG_ENABLE_DEBUG
 && !
defšed
(
CS_ENABLE_DEBUG
)

3086 
	#CS_ENABLE_DEBUG
 1

	)

3090 #ià
MG_ENABLE_MQTT_BROKER
 && !
MG_ENABLE_MQTT


3091 #undeà
MG_ENABLE_MQTT


3092 
	#MG_ENABLE_MQTT
 1

	)

3095 #iâdeà
MG_ENABLE_HTTP_URL_REWRITES


3096 
	#MG_ENABLE_HTTP_URL_REWRITES
 \

3097 (
CS_PLATFORM
 =ğ
CS_P_WINDOWS
 || CS_PLATFORM =ğ
CS_P_UNIX
)

	)

3100 #iâdeà
MG_ENABLE_TUN


3101 
	#MG_ENABLE_TUN
 
MG_ENABLE_HTTP_WEBSOCKET


	)

3104 #iâdeà
MG_ENABLE_SNTP


3105 
	#MG_ENABLE_SNTP
 0

	)

3108 #iâdeà
MG_ENABLE_EXTRA_ERRORS_DESC


3109 
	#MG_ENABLE_EXTRA_ERRORS_DESC
 0

	)

3112 #iâdeà
MG_ENABLE_CALLBACK_USERDATA


3113 
	#MG_ENABLE_CALLBACK_USERDATA
 0

	)

3116 #ià
MG_ENABLE_CALLBACK_USERDATA


3117 
	#MG_UD_ARG
(
ud
è, 
	)
ud

3118 
	#MG_CB
(
cb
, 
ud
ècb, 
	)
ud

3120 
	#MG_UD_ARG
(
ud
)

	)

3121 
	#MG_CB
(
cb
, 
ud
è
	)
cb

3125 #ifdeà
MG_MODULE_LINES


3133 #iâdeà
CS_MONGOOSE_SRC_NET_IF_H_


3134 
	#CS_MONGOOSE_SRC_NET_IF_H_


	)

3148 #ifdeà
__ılu¥lus


3152 
	#MG_MAIN_IFACE
 0

	)

3154 
mg_mgr
;

3155 
mg_cÚÃùiÚ
;

3156 
sock‘_add»ss
;

3158 
mg_içû_vbË
;

3160 
	smg_içû
 {

3161 
mg_mgr
 *
mgr
;

3162 *
d©a
;

3163 cÚ¡ 
mg_içû_vbË
 *
vbË
;

3166 
	smg_içû_vbË
 {

3167 (*
š™
)(
mg_içû
 *
içû
);

3168 (*
ä“
)(
mg_içû
 *
içû
);

3169 (*
add_cÚn
)(
mg_cÚÃùiÚ
 *
nc
);

3170 (*
»move_cÚn
)(
mg_cÚÃùiÚ
 *
nc
);

3171 
time_t
 (*
pŞl
)(
mg_içû
 *
içû
, 
timeout_ms
);

3174 (*
li¡’_tı
)(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
);

3176 (*
li¡’_udp
)(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
);

3179 (*
cÚÃù_tı
)(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ 
sock‘_add»ss
 *
§
);

3181 (*
cÚÃù_udp
)(
mg_cÚÃùiÚ
 *
nc
);

3184 (*
tı_£nd
)(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
, 
size_t
 
Ën
);

3185 (*
udp_£nd
)(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
, 
size_t
 
Ën
);

3187 (*
»cved
)(
mg_cÚÃùiÚ
 *
nc
, 
size_t
 
Ën
);

3190 (*
ü—‹_cÚn
)(
mg_cÚÃùiÚ
 *
nc
);

3192 (*
de¡roy_cÚn
)(
mg_cÚÃùiÚ
 *
nc
);

3195 (*
sock_£t
)(
mg_cÚÃùiÚ
 *
nc
, 
sock_t
 
sock
);

3198 (*
g‘_cÚn_addr
)(
mg_cÚÃùiÚ
 *
nc
, 
»mÙe
,

3199 
sock‘_add»ss
 *
§
);

3202 cÚ¡ 
mg_içû_vbË
 *
mg_içûs
[];

3203 
mg_num_içûs
;

3206 
mg_içû
 *
mg_if_ü—‹_içû
(cÚ¡ 
mg_içû_vbË
 *
vbË
,

3207 
mg_mgr
 *
mgr
);

3213 
mg_içû
 *
mg_fšd_içû
(
mg_mgr
 *
mgr
,

3214 cÚ¡ 
mg_içû_vbË
 *
vbË
,

3215 
mg_içû
 *
äom
);

3222 
mg_cÚÃùiÚ
 *
mg_if_acû±_Ãw_cÚn
(mg_cÚÃùiÚ *
lc
);

3223 
mg_if_acû±_tı_cb
(
mg_cÚÃùiÚ
 *
nc
, 
sock‘_add»ss
 *
§
,

3224 
size_t
 
§_Ën
);

3227 
mg_if_cÚÃù_cb
(
mg_cÚÃùiÚ
 *
nc
, 
”r
);

3229 
mg_if_£Á_cb
(
mg_cÚÃùiÚ
 *
nc
, 
num_£Á
);

3236 
mg_if_»cv_tı_cb
(
mg_cÚÃùiÚ
 *
nc
, *
buf
, 
Ën
, 
own
);

3242 
mg_if_»cv_udp_cb
(
mg_cÚÃùiÚ
 *
nc
, *
buf
, 
Ën
,

3243 
sock‘_add»ss
 *
§
, 
size_t
 
§_Ën
);

3248 
mg_if_pŞl
(
mg_cÚÃùiÚ
 *
nc
, 
time_t
 
now
);

3251 
mg_if_tim”
(
mg_cÚÃùiÚ
 *
c
, 
now
);

3253 #ifdeà
__ılu¥lus


3258 #ifdeà
MG_MODULE_LINES


3266 #iâdeà
CS_MONGOOSE_SRC_SSL_IF_H_


3267 
	#CS_MONGOOSE_SRC_SSL_IF_H_


	)

3269 #ià
MG_ENABLE_SSL


3271 #ifdeà
__ılu¥lus


3275 
mg_s¦_if_ùx
;

3276 
mg_cÚÃùiÚ
;

3278 
mg_s¦_if_š™
();

3280 
	emg_s¦_if_»suÉ
 {

3281 
MG_SSL_OK
 = 0,

3282 
MG_SSL_WANT_READ
 = -1,

3283 
MG_SSL_WANT_WRITE
 = -2,

3284 
MG_SSL_ERROR
 = -3,

3287 
	smg_s¦_if_cÚn_·¿ms
 {

3288 cÚ¡ *
û¹
;

3289 cÚ¡ *
key
;

3290 cÚ¡ *
ÿ_û¹
;

3291 cÚ¡ *
£rv”_Çme
;

3292 cÚ¡ *
ch”_su™es
;

3293 cÚ¡ *
psk_id’t™y
;

3294 cÚ¡ *
psk_key
;

3297 
mg_s¦_if_»suÉ
 
mg_s¦_if_cÚn_š™
(

3298 
mg_cÚÃùiÚ
 *
nc
, cÚ¡ 
mg_s¦_if_cÚn_·¿ms
 *
·¿ms
,

3299 cÚ¡ **
”r_msg
);

3300 
mg_s¦_if_»suÉ
 
mg_s¦_if_cÚn_acû±
(
mg_cÚÃùiÚ
 *
nc
,

3301 
mg_cÚÃùiÚ
 *
lc
);

3302 
mg_s¦_if_cÚn_şo£_nÙify
(
mg_cÚÃùiÚ
 *
nc
);

3303 
mg_s¦_if_cÚn_ä“
(
mg_cÚÃùiÚ
 *
nc
);

3305 
mg_s¦_if_»suÉ
 
mg_s¦_if_hªdshake
(
mg_cÚÃùiÚ
 *
nc
);

3306 
mg_s¦_if_»ad
(
mg_cÚÃùiÚ
 *
nc
, *
buf
, 
size_t
 
buf_size
);

3307 
mg_s¦_if_wr™e
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
d©a
, 
size_t
 
Ën
);

3309 #ifdeà
__ılu¥lus


3316 #ifdeà
MG_MODULE_LINES


3346 #iâdeà
CS_MONGOOSE_SRC_NET_H_


3347 
	#CS_MONGOOSE_SRC_NET_H_


	)

3353 #iâdeà
MG_VPRINTF_BUFFER_SIZE


3354 
	#MG_VPRINTF_BUFFER_SIZE
 100

	)

3357 #ifdeà
MG_USE_READ_WRITE


3358 
	#MG_RECV_FUNC
(
s
, 
b
, 
l
, 
f
è
	`»ad
(s, b,†)

	)

3359 
	#MG_SEND_FUNC
(
s
, 
b
, 
l
, 
f
è
	`wr™e
(s, b,†)

	)

3361 
	#MG_RECV_FUNC
(
s
, 
b
, 
l
, 
f
è
	`»cv
(s, b,†, f)

	)

3362 
	#MG_SEND_FUNC
(
s
, 
b
, 
l
, 
f
è
	`£nd
(s, b,†, f)

	)

3365 #ifdeà
__ılu¥lus


3369 
	usock‘_add»ss
 {

3370 
sockaddr
 
§
;

3371 
sockaddr_š
 
sš
;

3372 #ià
MG_ENABLE_IPV6


3373 
sockaddr_š6
 
sš6
;

3375 
sockaddr
 
sš6
;

3379 
mg_cÚÃùiÚ
;

3385 (*
mg_ev’t_hªdËr_t
)(
	tmg_cÚÃùiÚ
 *
	tnc
, 
	tev
,

3386 *
	tev_d©a
 
	tMG_UD_ARG
(*
	tu£r_d©a
));

3389 
	#MG_EV_POLL
 0

	)

3390 
	#MG_EV_ACCEPT
 1

	)

3391 
	#MG_EV_CONNECT
 2

	)

3392 
	#MG_EV_RECV
 3

	)

3393 
	#MG_EV_SEND
 4

	)

3394 
	#MG_EV_CLOSE
 5

	)

3395 
	#MG_EV_TIMER
 6

	)

3400 
	smg_mgr
 {

3401 
mg_cÚÃùiÚ
 *
aùive_cÚÃùiÚs
;

3402 #ià
MG_ENABLE_HEXDUMP


3403 cÚ¡ *
hexdump_fe
;

3405 #ià
MG_ENABLE_BROADCAST


3406 
sock_t
 
ùl
[2];

3408 *
u£r_d©a
;

3409 
num_içûs
;

3410 
mg_içû
 **
içûs
;

3411 cÚ¡ *
Çme£rv”
;

3417 
	smg_cÚÃùiÚ
 {

3418 
mg_cÚÃùiÚ
 *
Ãxt
, *
´ev
;

3419 
mg_cÚÃùiÚ
 *
li¡’”
;

3420 
mg_mgr
 *
mgr
;

3422 
sock_t
 
sock
;

3423 
”r
;

3424 
sock‘_add»ss
 
§
;

3425 
size_t
 
»cv_mbuf_lim™
;

3426 
mbuf
 
»cv_mbuf
;

3427 
mbuf
 
£nd_mbuf
;

3428 
time_t
 
Ï¡_io_time
;

3429 
ev_tim”_time
;

3430 #ià
MG_ENABLE_SSL


3431 *
s¦_if_d©a
;

3433 
mg_ev’t_hªdËr_t
 
´Ùo_hªdËr
;

3434 *
´Ùo_d©a
;

3435 (*
´Ùo_d©a_de¡ruùÜ
)(*
´Ùo_d©a
);

3436 
mg_ev’t_hªdËr_t
 
hªdËr
;

3437 *
u£r_d©a
;

3439 *
v
;

3444 
mg_ev’t_hªdËr_t
 
f
;

3445 } 
´iv_1
;

3446 *
´iv_2
;

3447 *
mgr_d©a
;

3448 
mg_içû
 *
içû
;

3449 
æags
;

3451 
	#MG_F_LISTENING
 (1 << 0è

	)

3452 
	#MG_F_UDP
 (1 << 1è

	)

3453 
	#MG_F_RESOLVING
 (1 << 2è

	)

3454 
	#MG_F_CONNECTING
 (1 << 3è

	)

3455 
	#MG_F_SSL
 (1 << 4è

	)

3456 
	#MG_F_SSL_HANDSHAKE_DONE
 (1 << 5è

	)

3457 
	#MG_F_WANT_READ
 (1 << 6è

	)

3458 
	#MG_F_WANT_WRITE
 (1 << 7è

	)

3459 
	#MG_F_IS_WEBSOCKET
 (1 << 8è

	)

3462 
	#MG_F_SEND_AND_CLOSE
 (1 << 10è

	)

3463 
	#MG_F_CLOSE_IMMEDIATELY
 (1 << 11è

	)

3464 
	#MG_F_WEBSOCKET_NO_DEFRAG
 (1 << 12è

	)

3465 
	#MG_F_DELETE_CHUNK
 (1 << 13è

	)

3466 
	#MG_F_ENABLE_BROADCAST
 (1 << 14è

	)

3467 
	#MG_F_TUN_DO_NOT_RECONNECT
 (1 << 15è

	)

3469 
	#MG_F_USER_1
 (1 << 20è

	)

3470 
	#MG_F_USER_2
 (1 << 21)

	)

3471 
	#MG_F_USER_3
 (1 << 22)

	)

3472 
	#MG_F_USER_4
 (1 << 23)

	)

3473 
	#MG_F_USER_5
 (1 << 24)

	)

3474 
	#MG_F_USER_6
 (1 << 25)

	)

3485 
mg_mgr_š™
(
mg_mgr
 *
mgr
, *
u£r_d©a
);

3502 
	smg_mgr_š™_İts
 {

3503 cÚ¡ 
mg_içû_vbË
 *
maš_içû
;

3504 
num_içûs
;

3505 cÚ¡ 
mg_içû_vbË
 **
içûs
;

3506 cÚ¡ *
Çme£rv”
;

3515 
mg_mgr_š™_İt
(
mg_mgr
 *
mgr
, *
u£r_d©a
,

3516 
mg_mgr_š™_İts
 
İts
);

3523 
mg_mgr_ä“
(
mg_mgr
 *);

3533 
time_t
 
mg_mgr_pŞl
(
mg_mgr
 *, 
mli
);

3535 #ià
MG_ENABLE_BROADCAST


3548 
mg_brßdÿ¡
(
mg_mgr
 *
mgr
, 
mg_ev’t_hªdËr_t
 
cb
, *
d©a
,

3549 
size_t
 
Ën
);

3565 
mg_cÚÃùiÚ
 *
mg_Ãxt
(
mg_mgr
 *
mgr
, mg_cÚÃùiÚ *
c
);

3573 
	smg_add_sock_İts
 {

3574 *
u£r_d©a
;

3575 
æags
;

3576 cÚ¡ **
”rÜ_¡ršg
;

3577 
mg_içû
 *
içû
;

3586 
mg_cÚÃùiÚ
 *
mg_add_sock
(
mg_mgr
 *
mgr
, 
sock_t
 
sock
,

3587 
MG_CB
(
mg_ev’t_hªdËr_t
 
hªdËr
,

3588 *
u£r_d©a
));

3596 
mg_cÚÃùiÚ
 *
mg_add_sock_İt
(
mg_mgr
 *
mgr
, 
sock_t
 
sock
,

3597 
MG_CB
(
mg_ev’t_hªdËr_t
 
hªdËr
,

3598 *
u£r_d©a
),

3599 
mg_add_sock_İts
 
İts
);

3607 
	smg_bšd_İts
 {

3608 *
u£r_d©a
;

3609 
æags
;

3610 cÚ¡ **
”rÜ_¡ršg
;

3611 
mg_içû
 *
içû
;

3612 #ià
MG_ENABLE_SSL


3619 cÚ¡ *
s¦_û¹
;

3622 cÚ¡ *
s¦_key
;

3624 cÚ¡ *
s¦_ÿ_û¹
;

3636 cÚ¡ *
s¦_ch”_su™es
;

3645 
mg_cÚÃùiÚ
 *
mg_bšd
(
mg_mgr
 *
mgr
, cÚ¡ *
add»ss
,

3646 
MG_CB
(
mg_ev’t_hªdËr_t
 
hªdËr
,

3647 *
u£r_d©a
));

3666 
mg_cÚÃùiÚ
 *
mg_bšd_İt
(
mg_mgr
 *
mgr
, cÚ¡ *
add»ss
,

3667 
MG_CB
(
mg_ev’t_hªdËr_t
 
hªdËr
,

3668 *
u£r_d©a
),

3669 
mg_bšd_İts
 
İts
);

3672 
	smg_cÚÃù_İts
 {

3673 *
u£r_d©a
;

3674 
æags
;

3675 cÚ¡ **
”rÜ_¡ršg
;

3676 
mg_içû
 *
içû
;

3677 cÚ¡ *
Çme£rv”
;

3678 #ià
MG_ENABLE_SSL


3683 cÚ¡ *
s¦_û¹
;

3688 cÚ¡ *
s¦_key
;

3693 cÚ¡ *
s¦_ÿ_û¹
;

3705 cÚ¡ *
s¦_ch”_su™es
;

3713 cÚ¡ *
s¦_£rv”_Çme
;

3721 cÚ¡ *
s¦_psk_id’t™y
;

3722 cÚ¡ *
s¦_psk_key
;

3731 
mg_cÚÃùiÚ
 *
mg_cÚÃù
(
mg_mgr
 *
mgr
, cÚ¡ *
add»ss
,

3732 
MG_CB
(
mg_ev’t_hªdËr_t
 
hªdËr
,

3733 *
u£r_d©a
));

3783 
mg_cÚÃùiÚ
 *
mg_cÚÃù_İt
(
mg_mgr
 *
mgr
, cÚ¡ *
add»ss
,

3784 
MG_CB
(
mg_ev’t_hªdËr_t
 
hªdËr
,

3785 *
u£r_d©a
),

3786 
mg_cÚÃù_İts
 
İts
);

3788 #ià
MG_ENABLE_SSL
 && 
MG_NET_IF
 !ğ
MG_NET_IF_SIMPLELINK


3803 cÚ¡ *
mg_£t_s¦
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
û¹
,

3804 cÚ¡ *
ÿ_û¹
);

3814 
mg_£nd
(
mg_cÚÃùiÚ
 *, cÚ¡ *
buf
, 
Ën
);

3817 #ià
defšed
(
__GNUC__
)

3818 
__©Œibu‹__
((
fÜm©
(
´štf
, 2, 3)))

3827 
mg_´štf
(
mg_cÚÃùiÚ
 *, cÚ¡ *
fmt
, ...);

3830 
mg_v´štf
(
mg_cÚÃùiÚ
 *, cÚ¡ *
fmt
, 
va_li¡
 
­
);

3837 
mg_sock‘·œ
(
sock_t
[2], 
sock_ty³
);

3839 #ià
MG_ENABLE_SYNC_RESOLVER


3850 
mg_»sŞve
(cÚ¡ *
domaš_Çme
, *
_addr_buf
, 
size_t
 
buf_Ën
);

3873 
mg_check__aş
(cÚ¡ *
aş
, 
ušt32_t
 
»mÙe_
);

3899 
mg_£t_tim”
(
mg_cÚÃùiÚ
 *
c
, 
time¡amp
);

3904 
mg_time
();

3906 #ifdeà
__ılu¥lus


3911 #ifdeà
MG_MODULE_LINES


3923 #iâdeà
CS_MONGOOSE_SRC_URI_H_


3924 
	#CS_MONGOOSE_SRC_URI_H_


	)

3928 #ifdeà
__ılu¥lus


3955 
mg_·r£_uri
(cÚ¡ 
mg_¡r
 
uri
, mg_¡¸*
scheme
,

3956 
mg_¡r
 *
u£r_šfo
, mg_¡¸*
ho¡
,

3957 *
pÜt
, 
mg_¡r
 *
·th
, mg_¡¸*
qu”y
,

3958 
mg_¡r
 *
äagm’t
);

3969 
mg_as£mbË_uri
(cÚ¡ 
mg_¡r
 *
scheme
, cÚ¡ mg_¡¸*
u£r_šfo
,

3970 cÚ¡ 
mg_¡r
 *
ho¡
, 
pÜt
,

3971 cÚ¡ 
mg_¡r
 *
·th
, cÚ¡ mg_¡¸*
qu”y
,

3972 cÚ¡ 
mg_¡r
 *
äagm’t
, 
nÜm®ize_·th
,

3973 
mg_¡r
 *
uri
);

3975 
mg_nÜm®ize_uri_·th
(cÚ¡ 
mg_¡r
 *
š
, mg_¡¸*
out
);

3977 #ifdeà
__ılu¥lus


3981 #ifdeà
MG_MODULE_LINES


3993 #iâdeà
CS_MONGOOSE_SRC_UTIL_H_


3994 
	#CS_MONGOOSE_SRC_UTIL_H_


	)

3996 
	~<¡dio.h
>

4001 #ifdeà
__ılu¥lus


4005 #iâdeà
MG_MAX_PATH


4006 #ifdeà
PATH_MAX


4007 
	#MG_MAX_PATH
 
PATH_MAX


	)

4009 
	#MG_MAX_PATH
 256

	)

4022 cÚ¡ *
mg_sk
(cÚ¡ *
s
, cÚ¡ *
’d_¡ršg
,

4023 cÚ¡ *
d–im™”s
, 
mg_¡r
 *
v
);

4035 
mg_ba£64_decode
(cÚ¡ *
s
, 
Ën
, *
d¡
);

4042 
mg_ba£64_’code
(cÚ¡ *
¤c
, 
¤c_Ën
, *
d¡
);

4044 #ià
MG_ENABLE_FILESYSTEM


4052 
mg_¡©
(cÚ¡ *
·th
, 
cs_¡©_t
 *
¡
);

4061 
FILE
 *
mg_fİ’
(cÚ¡ *
·th
, cÚ¡ *
mode
);

4070 
mg_İ’
(cÚ¡ *
·th
, 
æag
, 
mode
);

4077 
size_t
 
mg_ä—d
(*
±r
, size_ˆ
size
, size_ˆ
couÁ
, 
FILE
 *
f
);

4084 
size_t
 
mg_fwr™e
(cÚ¡ *
±r
, size_ˆ
size
, size_ˆ
couÁ
, 
FILE
 *
f
);

4088 #ià
MG_ENABLE_THREADS


4095 *
mg_¡¬t_th»ad
(*(*
th»ad_func
)(*), *
th»ad_func_·¿m
);

4098 
mg_£t_şo£_Ú_exec
(
sock_t
);

4100 
	#MG_SOCK_STRINGIFY_IP
 1

	)

4101 
	#MG_SOCK_STRINGIFY_PORT
 2

	)

4102 
	#MG_SOCK_STRINGIFY_REMOTE
 4

	)

4117 
mg_cÚn_addr_to_¡r
(
mg_cÚÃùiÚ
 *
c
, *
buf
, 
size_t
 
Ën
,

4118 
æags
);

4119 #ià
MG_NET_IF
 =ğ
MG_NET_IF_SOCKET


4121 
mg_sock_to_¡r
(
sock_t
 
sock
, *
buf
, 
size_t
 
Ën
, 
æags
);

4129 
mg_sock_addr_to_¡r
(cÚ¡ 
sock‘_add»ss
 *
§
, *
buf
, 
size_t
 
Ën
,

4130 
æags
);

4132 #ià
MG_ENABLE_HEXDUMP


4141 
mg_hexdump
(cÚ¡ *
buf
, 
Ën
, *
d¡
, 
d¡_Ën
);

4144 
mg_hexdumpf
(
FILE
 *
å
, cÚ¡ *
buf
, 
Ën
);

4153 
mg_hexdump_cÚÃùiÚ
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

4154 cÚ¡ *
buf
, 
num_by‹s
, 
ev
);

4160 
mg_is_big_’dŸn
();

4165 
mg_mbuf_­³nd_ba£64_putc
(
ch
, *
u£r_d©a
);

4170 
mg_mbuf_­³nd_ba£64
(
mbuf
 *mbuf, cÚ¡ *
d©a
, 
size_t
 
Ën
);

4177 
mg_basic_auth_h—d”
(cÚ¡ 
mg_¡r
 
u£r
, cÚ¡ mg_¡¸
·ss
,

4178 
mbuf
 *
buf
);

4186 
mg_¡r
 
mg_u¾_’code
(cÚ¡ mg_¡¸
¤c
);

4188 #ifdeà
__ılu¥lus


4192 #ifdeà
MG_MODULE_LINES


4204 #iâdeà
CS_MONGOOSE_SRC_HTTP_H_


4205 
	#CS_MONGOOSE_SRC_HTTP_H_


	)

4207 #ià
MG_ENABLE_HTTP


4212 #ifdeà
__ılu¥lus


4216 #iâdeà
MG_MAX_HTTP_HEADERS


4217 
	#MG_MAX_HTTP_HEADERS
 20

	)

4220 #iâdeà
MG_MAX_HTTP_REQUEST_SIZE


4221 
	#MG_MAX_HTTP_REQUEST_SIZE
 1024

	)

4224 #iâdeà
MG_MAX_HTTP_SEND_MBUF


4225 
	#MG_MAX_HTTP_SEND_MBUF
 1024

	)

4228 #iâdeà
MG_CGI_ENVIRONMENT_SIZE


4229 
	#MG_CGI_ENVIRONMENT_SIZE
 8192

	)

4233 
	sh‰p_mes§ge
 {

4234 
mg_¡r
 
mes§ge
;

4235 
mg_¡r
 
body
;

4238 
mg_¡r
 
m‘hod
;

4239 
mg_¡r
 
uri
;

4240 
mg_¡r
 
´Ùo
;

4243 
»¥_code
;

4244 
mg_¡r
 
»¥_¡©us_msg
;

4254 
mg_¡r
 
qu”y_¡ršg
;

4257 
mg_¡r
 
h—d”_Çmes
[
MG_MAX_HTTP_HEADERS
];

4258 
mg_¡r
 
h—d”_v®ues
[
MG_MAX_HTTP_HEADERS
];

4261 #ià
MG_ENABLE_HTTP_WEBSOCKET


4263 
	swebsock‘_mes§ge
 {

4264 *
d©a
;

4265 
size_t
 
size
;

4266 
æags
;

4271 
	smg_h‰p_muÉ¬t_·¹
 {

4272 cÚ¡ *
fe_Çme
;

4273 cÚ¡ *
v¬_Çme
;

4274 
mg_¡r
 
d©a
;

4275 
¡©us
;

4276 *
u£r_d©a
;

4280 
	smg_ssi_ÿÎ_ùx
 {

4281 
h‰p_mes§ge
 *
»q
;

4282 
mg_¡r
 
fe
;

4283 
mg_¡r
 
¬g
;

4287 
	#MG_EV_HTTP_REQUEST
 100

	)

4288 
	#MG_EV_HTTP_REPLY
 101

	)

4289 
	#MG_EV_HTTP_CHUNK
 102

	)

4290 
	#MG_EV_SSI_CALL
 105

	)

4291 
	#MG_EV_SSI_CALL_CTX
 106

	)

4293 #ià
MG_ENABLE_HTTP_WEBSOCKET


4294 
	#MG_EV_WEBSOCKET_HANDSHAKE_REQUEST
 111

	)

4295 
	#MG_EV_WEBSOCKET_HANDSHAKE_DONE
 112

	)

4296 
	#MG_EV_WEBSOCKET_FRAME
 113

	)

4297 
	#MG_EV_WEBSOCKET_CONTROL_FRAME
 114

	)

4300 #ià
MG_ENABLE_HTTP_STREAMING_MULTIPART


4301 
	#MG_EV_HTTP_MULTIPART_REQUEST
 121

	)

4302 
	#MG_EV_HTTP_PART_BEGIN
 122

	)

4303 
	#MG_EV_HTTP_PART_DATA
 123

	)

4304 
	#MG_EV_HTTP_PART_END
 124

	)

4306 
	#MG_EV_HTTP_MULTIPART_REQUEST_END
 125

	)

4361 
mg_£t_´ÙocŞ_h‰p_websock‘
(
mg_cÚÃùiÚ
 *
nc
);

4363 #ià
MG_ENABLE_HTTP_WEBSOCKET


4378 
mg_£nd_websock‘_hªdshake
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
uri
,

4379 cÚ¡ *
exŒa_h—d”s
);

4391 
mg_£nd_websock‘_hªdshake2
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

4392 cÚ¡ *
ho¡
, cÚ¡ *
´ÙocŞ
,

4393 cÚ¡ *
exŒa_h—d”s
);

4396 
mg_£nd_websock‘_hªdshake3
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
·th
,

4397 cÚ¡ *
ho¡
, cÚ¡ *
´ÙocŞ
,

4398 cÚ¡ *
exŒa_h—d”s
, cÚ¡ *
u£r
,

4399 cÚ¡ *
·ss
);

4403 
mg_£nd_websock‘_hªdshake3v
(
mg_cÚÃùiÚ
 *
nc
,

4404 cÚ¡ 
mg_¡r
 
·th
,

4405 cÚ¡ 
mg_¡r
 
ho¡
,

4406 cÚ¡ 
mg_¡r
 
´ÙocŞ
,

4407 cÚ¡ 
mg_¡r
 
exŒa_h—d”s
,

4408 cÚ¡ 
mg_¡r
 
u£r
,

4409 cÚ¡ 
mg_¡r
 
·ss
);

4431 
mg_cÚÃùiÚ
 *
mg_cÚÃù_ws
(
mg_mgr
 *
mgr
,

4432 
MG_CB
(
mg_ev’t_hªdËr_t
 
ev’t_hªdËr
,

4433 *
u£r_d©a
),

4434 cÚ¡ *
u¾
, cÚ¡ *
´ÙocŞ
,

4435 cÚ¡ *
exŒa_h—d”s
);

4443 
mg_cÚÃùiÚ
 *
mg_cÚÃù_ws_İt
(

4444 
mg_mgr
 *
mgr
, 
MG_CB
(
mg_ev’t_hªdËr_t
 
ev_hªdËr
, *
u£r_d©a
),

4445 
mg_cÚÃù_İts
 
İts
, cÚ¡ *
u¾
, cÚ¡ *
´ÙocŞ
,

4446 cÚ¡ *
exŒa_h—d”s
);

4466 
mg_£nd_websock‘_äame
(
mg_cÚÃùiÚ
 *
nc
, 
İ_ªd_æags
,

4467 cÚ¡ *
d©a
, 
size_t
 
d©a_Ën
);

4475 
mg_£nd_websock‘_äamev
(
mg_cÚÃùiÚ
 *
nc
, 
İ_ªd_æags
,

4476 cÚ¡ 
mg_¡r
 *
¡ršgs
, 
num_¡ršgs
);

4484 
mg_´štf_websock‘_äame
(
mg_cÚÃùiÚ
 *
nc
, 
İ_ªd_æags
,

4485 cÚ¡ *
fmt
, ...);

4488 
	#WEBSOCKET_OP_CONTINUE
 0

	)

4489 
	#WEBSOCKET_OP_TEXT
 1

	)

4490 
	#WEBSOCKET_OP_BINARY
 2

	)

4491 
	#WEBSOCKET_OP_CLOSE
 8

	)

4492 
	#WEBSOCKET_OP_PING
 9

	)

4493 
	#WEBSOCKET_OP_PONG
 10

	)

4507 
	#WEBSOCKET_DONT_FIN
 0x100

	)

4522 
mg_u¾_decode
(cÚ¡ *
¤c
, 
¤c_Ën
, *
d¡
, 
d¡_Ën
,

4523 
is_fÜm_u¾_’coded
);

4525 
mg_hash_md5_v
(
size_t
 
num_msgs
, cÚ¡ 
ušt8_t
 *
msgs
[],

4526 cÚ¡ 
size_t
 *
msg_Ëns
, 
ušt8_t
 *
dige¡
);

4527 
mg_hash_sha1_v
(
size_t
 
num_msgs
, cÚ¡ 
ušt8_t
 *
msgs
[],

4528 cÚ¡ 
size_t
 *
msg_Ëns
, 
ušt8_t
 *
dige¡
);

4530 #ifdeà
__ılu¥lus


4537 #ifdeà
MG_MODULE_LINES


4544 #iâdeà
CS_MONGOOSE_SRC_HTTP_SERVER_H_


4545 
	#CS_MONGOOSE_SRC_HTTP_SERVER_H_


	)

4547 #ià
MG_ENABLE_HTTP


4549 #ifdeà
__ılu¥lus


4561 
mg_·r£_h‰p
(cÚ¡ *
s
, 
n
, 
h‰p_mes§ge
 *
hm
, 
is_»q
);

4569 
mg_¡r
 *
mg_g‘_h‰p_h—d”
(
h‰p_mes§ge
 *
hm
, cÚ¡ *
Çme
);

4586 
mg_h‰p_·r£_h—d”
(
mg_¡r
 *
hdr
, cÚ¡ *
v¬_Çme
, *
buf
,

4587 
size_t
 
buf_size
);

4595 
mg_g‘_h‰p_basic_auth
(
h‰p_mes§ge
 *
hm
, *
u£r
, 
size_t
 
u£r_Ën
,

4596 *
·ss
, 
size_t
 
·ss_Ën
);

4603 
mg_·r£_h‰p_basic_auth
(
mg_¡r
 *
hdr
, *
u£r
, 
size_t
 
u£r_Ën
,

4604 *
·ss
, 
size_t
 
·ss_Ën
);

4642 
size_t
 
mg_·r£_muÉ¬t
(cÚ¡ *
buf
, size_ˆ
buf_Ën
, *
v¬_Çme
,

4643 
size_t
 
v¬_Çme_Ën
, *
fe_Çme
,

4644 
size_t
 
fe_Çme_Ën
, cÚ¡ **
chunk
,

4645 
size_t
 *
chunk_Ën
);

4656 
mg_g‘_h‰p_v¬
(cÚ¡ 
mg_¡r
 *
buf
, cÚ¡ *
Çme
, *
d¡
,

4657 
size_t
 
d¡_Ën
);

4659 #ià
MG_ENABLE_FILESYSTEM


4664 
	smg_£rve_h‰p_İts
 {

4666 cÚ¡ *
docum’t_roÙ
;

4669 cÚ¡ *
šdex_fes
;

4680 cÚ¡ *
³r_dœeùÜy_auth_fe
;

4683 cÚ¡ *
auth_domaš
;

4693 cÚ¡ *
glob®_auth_fe
;

4696 cÚ¡ *
’abË_dœeùÜy_li¡šg
;

4756 cÚ¡ *
ssi_·‰”n
;

4759 cÚ¡ *
_aş
;

4761 #ià
MG_ENABLE_HTTP_URL_REWRITES


4786 cÚ¡ *
u¾_»wr™es
;

4790 cÚ¡ *
dav_docum’t_roÙ
;

4796 cÚ¡ *
dav_auth_fe
;

4799 cÚ¡ *
hidd’_fe_·‰”n
;

4802 cÚ¡ *
cgi_fe_·‰”n
;

4805 cÚ¡ *
cgi_š‹½»‹r
;

4811 cÚ¡ *
cu¡om_mime_ty³s
;

4817 cÚ¡ *
exŒa_h—d”s
;

4840 
mg_£rve_h‰p
(
mg_cÚÃùiÚ
 *
nc
, 
h‰p_mes§ge
 *
hm
,

4841 
mg_£rve_h‰p_İts
 
İts
);

4862 
mg_h‰p_£rve_fe
(
mg_cÚÃùiÚ
 *
nc
, 
h‰p_mes§ge
 *
hm
,

4863 cÚ¡ *
·th
, cÚ¡ 
mg_¡r
 
mime_ty³
,

4864 cÚ¡ 
mg_¡r
 
exŒa_h—d”s
);

4866 #ià
MG_ENABLE_HTTP_STREAMING_MULTIPART


4869 
mg_¡r
 (*
	tmg_fu_âame_â
)(
	tmg_cÚÃùiÚ
 *
	tnc
,

4870 
	tmg_¡r
 
	tâame
);

4904 
mg_fe_u¶ßd_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
, *
ev_d©a
,

4905 
mg_fu_âame_â
 
loÿl_Çme_â


4906 
MG_UD_ARG
(*
u£r_d©a
));

4937 
mg_»gi¡”_h‰p_’dpošt
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
uri_·th
,

4938 
MG_CB
(
mg_ev’t_hªdËr_t
 
hªdËr
,

4939 *
u£r_d©a
));

4941 
	smg_h‰p_’dpošt_İts
 {

4942 *
u£r_d©a
;

4944 cÚ¡ *
auth_domaš
;

4945 cÚ¡ *
auth_fe
;

4948 
mg_»gi¡”_h‰p_’dpošt_İt
(
mg_cÚÃùiÚ
 *
nc
,

4949 cÚ¡ *
uri_·th
,

4950 
mg_ev’t_hªdËr_t
 
hªdËr
,

4951 
mg_h‰p_’dpošt_İts
 
İts
);

4957 
mg_h‰p_check_dige¡_auth
(
h‰p_mes§ge
 *
hm
, cÚ¡ *
auth_domaš
,

4958 
FILE
 *
å
);

4966 
mg_check_dige¡_auth
(
mg_¡r
 
m‘hod
, mg_¡¸
uri
,

4967 
mg_¡r
 
u£ºame
, mg_¡¸
úÚû
,

4968 
mg_¡r
 
»¥Ú£
, mg_¡¸
qİ
,

4969 
mg_¡r
 
nc
, mg_¡¸
nÚû
,

4970 
mg_¡r
 
auth_domaš
, 
FILE
 *
å
);

4990 
mg_£nd_h‰p_chunk
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
buf
, 
size_t
 
Ën
);

4996 
mg_´štf_h‰p_chunk
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
fmt
, ...);

5011 
mg_£nd_»¥Ú£_lše
(
mg_cÚÃùiÚ
 *
nc
, 
¡©us_code
,

5012 cÚ¡ *
exŒa_h—d”s
);

5018 
mg_h‰p_£nd_”rÜ
(
mg_cÚÃùiÚ
 *
nc
, 
code
, cÚ¡ *
»asÚ
);

5031 
mg_h‰p_£nd_»dœeù
(
mg_cÚÃùiÚ
 *
nc
, 
¡©us_code
,

5032 cÚ¡ 
mg_¡r
 
loÿtiÚ
,

5033 cÚ¡ 
mg_¡r
 
exŒa_h—d”s
);

5049 
mg_£nd_h—d
(
mg_cÚÃùiÚ
 *
n
, 
¡©us_code
,

5050 
št64_t
 
cÚ‹Á_Ëngth
, cÚ¡ *
exŒa_h—d”s
);

5055 
mg_´štf_html_esÿ³
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
fmt
, ...);

5057 #ià
MG_ENABLE_HTTP_URL_REWRITES


5068 
mg_h‰p_»v”£_´oxy
(
mg_cÚÃùiÚ
 *
nc
,

5069 cÚ¡ 
h‰p_mes§ge
 *
hm
, 
mg_¡r
 
mouÁ
,

5070 
mg_¡r
 
up¡»am
);

5073 #ifdeà
__ılu¥lus


5080 #ifdeà
MG_MODULE_LINES


5087 #iâdeà
CS_MONGOOSE_SRC_HTTP_CLIENT_H_


5088 
	#CS_MONGOOSE_SRC_HTTP_CLIENT_H_


	)

5090 #ifdeà
__ılu¥lus


5118 
mg_cÚÃùiÚ
 *
mg_cÚÃù_h‰p
(

5119 
mg_mgr
 *
mgr
,

5120 
MG_CB
(
mg_ev’t_hªdËr_t
 
ev’t_hªdËr
, *
u£r_d©a
), cÚ¡ *
u¾
,

5121 cÚ¡ *
exŒa_h—d”s
, cÚ¡ *
po¡_d©a
);

5130 
mg_cÚÃùiÚ
 *
mg_cÚÃù_h‰p_İt
(

5131 
mg_mgr
 *
mgr
, 
MG_CB
(
mg_ev’t_hªdËr_t
 
ev_hªdËr
, *
u£r_d©a
),

5132 
mg_cÚÃù_İts
 
İts
, cÚ¡ *
u¾
, cÚ¡ *
exŒa_h—d”s
,

5133 cÚ¡ *
po¡_d©a
);

5136 
mg_h‰p_ü—‹_dige¡_auth_h—d”
(*
buf
, 
size_t
 
buf_Ën
,

5137 cÚ¡ *
m‘hod
, cÚ¡ *
uri
,

5138 cÚ¡ *
auth_domaš
, cÚ¡ *
u£r
,

5139 cÚ¡ *
·sswd
);

5141 #ifdeà
__ılu¥lus


5145 #ifdeà
MG_MODULE_LINES


5169 #iâdeà
CS_MONGOOSE_SRC_MQTT_H_


5170 
	#CS_MONGOOSE_SRC_MQTT_H_


	)

5174 
	smg_mq‰_mes§ge
 {

5175 
cmd
;

5176 
qos
;

5177 
Ën
;

5178 
mg_¡r
 
tİic
;

5179 
mg_¡r
 
·ylßd
;

5181 
ušt8_t
 
cÚÇck_»t_code
;

5182 
ušt16_t
 
mes§ge_id
;

5185 
ušt8_t
 
´ÙocŞ_v”siÚ
;

5186 
ušt8_t
 
cÚÃù_æags
;

5187 
ušt16_t
 
k“p_®ive_tim”
;

5188 
mg_¡r
 
´ÙocŞ_Çme
;

5189 
mg_¡r
 
ş›Á_id
;

5190 
mg_¡r
 
wl_tİic
;

5191 
mg_¡r
 
wl_mes§ge
;

5192 
mg_¡r
 
u£r_Çme
;

5193 
mg_¡r
 
·sswÜd
;

5196 
	smg_mq‰_tİic_ex´essiÚ
 {

5197 cÚ¡ *
	gtİic
;

5198 
ušt8_t
 
	gqos
;

5201 
	smg_£nd_mq‰_hªdshake_İts
 {

5202 
	gæags
;

5203 
ušt16_t
 
	gk“p_®ive
;

5204 cÚ¡ *
	gwl_tİic
;

5205 cÚ¡ *
	gwl_mes§ge
;

5206 cÚ¡ *
	gu£r_Çme
;

5207 cÚ¡ *
	g·sswÜd
;

5211 
	smg_mq‰_´Ùo_d©a
 {

5212 
ušt16_t
 
	gk“p_®ive
;

5213 
	gÏ¡_cÚŒŞ_time
;

5217 
	#MG_MQTT_CMD_CONNECT
 1

	)

5218 
	#MG_MQTT_CMD_CONNACK
 2

	)

5219 
	#MG_MQTT_CMD_PUBLISH
 3

	)

5220 
	#MG_MQTT_CMD_PUBACK
 4

	)

5221 
	#MG_MQTT_CMD_PUBREC
 5

	)

5222 
	#MG_MQTT_CMD_PUBREL
 6

	)

5223 
	#MG_MQTT_CMD_PUBCOMP
 7

	)

5224 
	#MG_MQTT_CMD_SUBSCRIBE
 8

	)

5225 
	#MG_MQTT_CMD_SUBACK
 9

	)

5226 
	#MG_MQTT_CMD_UNSUBSCRIBE
 10

	)

5227 
	#MG_MQTT_CMD_UNSUBACK
 11

	)

5228 
	#MG_MQTT_CMD_PINGREQ
 12

	)

5229 
	#MG_MQTT_CMD_PINGRESP
 13

	)

5230 
	#MG_MQTT_CMD_DISCONNECT
 14

	)

5233 
	#MG_MQTT_EVENT_BASE
 200

	)

5234 
	#MG_EV_MQTT_CONNECT
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_CONNECT
)

	)

5235 
	#MG_EV_MQTT_CONNACK
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_CONNACK
)

	)

5236 
	#MG_EV_MQTT_PUBLISH
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_PUBLISH
)

	)

5237 
	#MG_EV_MQTT_PUBACK
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_PUBACK
)

	)

5238 
	#MG_EV_MQTT_PUBREC
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_PUBREC
)

	)

5239 
	#MG_EV_MQTT_PUBREL
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_PUBREL
)

	)

5240 
	#MG_EV_MQTT_PUBCOMP
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_PUBCOMP
)

	)

5241 
	#MG_EV_MQTT_SUBSCRIBE
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_SUBSCRIBE
)

	)

5242 
	#MG_EV_MQTT_SUBACK
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_SUBACK
)

	)

5243 
	#MG_EV_MQTT_UNSUBSCRIBE
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_UNSUBSCRIBE
)

	)

5244 
	#MG_EV_MQTT_UNSUBACK
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_UNSUBACK
)

	)

5245 
	#MG_EV_MQTT_PINGREQ
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_PINGREQ
)

	)

5246 
	#MG_EV_MQTT_PINGRESP
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_PINGRESP
)

	)

5247 
	#MG_EV_MQTT_DISCONNECT
 (
MG_MQTT_EVENT_BASE
 + 
MG_MQTT_CMD_DISCONNECT
)

	)

5250 
	#MG_MQTT_RETAIN
 0x1

	)

5251 
	#MG_MQTT_DUP
 0x4

	)

5252 
	#MG_MQTT_QOS
(
qos
è((qosè<< 1)

	)

5253 
	#MG_MQTT_GET_QOS
(
æags
è(((æagsè&0x6è>> 1)

	)

5254 
	#MG_MQTT_SET_QOS
(
æags
, 
qos
è(æagsèğ((æagsè& ~0x6è| ((qosè<< 1)

	)

5257 
	#MG_MQTT_CLEAN_SESSION
 0x02

	)

5258 
	#MG_MQTT_HAS_WILL
 0x04

	)

5259 
	#MG_MQTT_WILL_RETAIN
 0x20

	)

5260 
	#MG_MQTT_HAS_PASSWORD
 0x40

	)

5261 
	#MG_MQTT_HAS_USER_NAME
 0x80

	)

5262 
	#MG_MQTT_GET_WILL_QOS
(
æags
è(((æagsè&0x18è>> 3)

	)

5263 
	#MG_MQTT_SET_WILL_QOS
(
æags
, 
qos
) \

5264 (
æags
èğ((æagsè& ~0x18è| ((
qos
è<< 3)

	)

5267 
	#MG_EV_MQTT_CONNACK_ACCEPTED
 0

	)

5268 
	#MG_EV_MQTT_CONNACK_UNACCEPTABLE_VERSION
 1

	)

5269 
	#MG_EV_MQTT_CONNACK_IDENTIFIER_REJECTED
 2

	)

5270 
	#MG_EV_MQTT_CONNACK_SERVER_UNAVAILABLE
 3

	)

5271 
	#MG_EV_MQTT_CONNACK_BAD_AUTH
 4

	)

5272 
	#MG_EV_MQTT_CONNACK_NOT_AUTHORIZED
 5

	)

5274 #ifdeà
__ılu¥lus


5291 
mg_£t_´ÙocŞ_mq‰
(
mg_cÚÃùiÚ
 *
nc
);

5294 
mg_£nd_mq‰_hªdshake
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
ş›Á_id
);

5297 
mg_£nd_mq‰_hªdshake_İt
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
ş›Á_id
,

5298 
mg_£nd_mq‰_hªdshake_İts
);

5301 
mg_mq‰_publish
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
tİic
,

5302 
ušt16_t
 
mes§ge_id
, 
æags
, cÚ¡ *
d©a
,

5303 
size_t
 
Ën
);

5306 
mg_mq‰_subsüibe
(
mg_cÚÃùiÚ
 *
nc
,

5307 cÚ¡ 
mg_mq‰_tİic_ex´essiÚ
 *
tİics
,

5308 
size_t
 
tİics_Ën
, 
ušt16_t
 
mes§ge_id
);

5311 
mg_mq‰_unsubsüibe
(
mg_cÚÃùiÚ
 *
nc
, **
tİics
,

5312 
size_t
 
tİics_Ën
, 
ušt16_t
 
mes§ge_id
);

5315 
mg_mq‰_discÚÃù
(
mg_cÚÃùiÚ
 *
nc
);

5318 
mg_mq‰_cÚÇck
(
mg_cÚÃùiÚ
 *
nc
, 
ušt8_t
 
»tuº_code
);

5321 
mg_mq‰_puback
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
mes§ge_id
);

5324 
mg_mq‰_pub»c
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
mes§ge_id
);

5327 
mg_mq‰_pub»l
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
mes§ge_id
);

5330 
mg_mq‰_pubcomp
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
mes§ge_id
);

5336 
mg_mq‰_suback
(
mg_cÚÃùiÚ
 *
nc
, 
ušt8_t
 *
qoss
, 
size_t
 
qoss_Ën
,

5337 
ušt16_t
 
mes§ge_id
);

5340 
mg_mq‰_unsuback
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
mes§ge_id
);

5343 
mg_mq‰_pšg
(
mg_cÚÃùiÚ
 *
nc
);

5346 
mg_mq‰_pÚg
(
mg_cÚÃùiÚ
 *
nc
);

5355 
mg_mq‰_Ãxt_subsüibe_tİic
(
mg_mq‰_mes§ge
 *
msg
,

5356 
mg_¡r
 *
tİic
, 
ušt8_t
 *
qos
, 
pos
);

5363 
mg_mq‰_m©ch_tİic_ex´essiÚ
(
mg_¡r
 
exp
, mg_¡¸
tİic
);

5369 
mg_mq‰_vm©ch_tİic_ex´essiÚ
(cÚ¡ *
exp
, 
mg_¡r
 
tİic
);

5371 #ifdeà
__ılu¥lus


5376 #ifdeà
MG_MODULE_LINES


5400 #iâdeà
CS_MONGOOSE_SRC_MQTT_BROKER_H_


5401 
	#CS_MONGOOSE_SRC_MQTT_BROKER_H_


	)

5403 #ià
MG_ENABLE_MQTT_BROKER


5408 #ifdeà
__ılu¥lus


5412 #iâdeà
MG_MQTT_MAX_SESSION_SUBSCRIPTIONS


5413 
	#MG_MQTT_MAX_SESSION_SUBSCRIPTIONS
 512

	)

5416 
mg_mq‰_brok”
;

5419 
	smg_mq‰_£ssiÚ
 {

5420 
mg_mq‰_brok”
 *
brk
;

5421 
LIST_ENTRY
(
mg_mq‰_£ssiÚ
è
lšk
;

5422 
mg_cÚÃùiÚ
 *
nc
;

5423 
size_t
 
num_subsütiÚs
;

5424 *
u£r_d©a
;

5425 
mg_mq‰_tİic_ex´essiÚ
 *
subsütiÚs
;

5429 
	smg_mq‰_brok”
 {

5430 
LIST_HEAD
(
_mg_£ssh—d
, 
mg_mq‰_£ssiÚ
è
£ssiÚs
;

5431 *
u£r_d©a
;

5435 
mg_mq‰_brok”_š™
(
mg_mq‰_brok”
 *
brk
, *
u£r_d©a
);

5462 
mg_mq‰_brok”
(
mg_cÚÃùiÚ
 *
brk
, 
ev
, *
d©a
);

5474 
mg_mq‰_£ssiÚ
 *
mg_mq‰_Ãxt
(
mg_mq‰_brok”
 *
brk
,

5475 
mg_mq‰_£ssiÚ
 *
s
);

5477 #ifdeà
__ılu¥lus


5483 #ifdeà
MG_MODULE_LINES


5495 #iâdeà
CS_MONGOOSE_SRC_DNS_H_


5496 
	#CS_MONGOOSE_SRC_DNS_H_


	)

5500 #ifdeà
__ılu¥lus


5504 
	#MG_DNS_A_RECORD
 0x01

	)

5505 
	#MG_DNS_CNAME_RECORD
 0x05

	)

5506 
	#MG_DNS_PTR_RECORD
 0x0ø

	)

5507 
	#MG_DNS_TXT_RECORD
 0x10

	)

5508 
	#MG_DNS_AAAA_RECORD
 0x1ø

	)

5509 
	#MG_DNS_SRV_RECORD
 0x21

	)

5510 
	#MG_DNS_MX_RECORD
 0x0à

	)

5511 
	#MG_DNS_ANY_RECORD
 0xff

	)

5512 
	#MG_DNS_NSEC_RECORD
 0x2f

	)

5514 
	#MG_MAX_DNS_QUESTIONS
 32

	)

5515 
	#MG_MAX_DNS_ANSWERS
 32

	)

5517 
	#MG_DNS_MESSAGE
 100

	)

5519 
	emg_dns_»sourû_»cÜd_kšd
 {

5520 
MG_DNS_INVALID_RECORD
 = 0,

5521 
MG_DNS_QUESTION
,

5522 
MG_DNS_ANSWER


5526 
	smg_dns_»sourû_»cÜd
 {

5527 
mg_¡r
 
Çme
;

5528 
¹y³
;

5529 
rşass
;

5530 
‰l
;

5531 
mg_dns_»sourû_»cÜd_kšd
 
kšd
;

5532 
mg_¡r
 
rd©a
;

5536 
	smg_dns_mes§ge
 {

5537 
mg_¡r
 
pkt
;

5538 
ušt16_t
 
æags
;

5539 
ušt16_t
 
Œª§ùiÚ_id
;

5540 
num_que¡iÚs
;

5541 
num_ªsw”s
;

5542 
mg_dns_»sourû_»cÜd
 
que¡iÚs
[
MG_MAX_DNS_QUESTIONS
];

5543 
mg_dns_»sourû_»cÜd
 
ªsw”s
[
MG_MAX_DNS_ANSWERS
];

5546 
mg_dns_»sourû_»cÜd
 *
mg_dns_Ãxt_»cÜd
(

5547 
mg_dns_mes§ge
 *
msg
, 
qu”y
, 
mg_dns_»sourû_»cÜd
 *
´ev
);

5560 
mg_dns_·r£_»cÜd_d©a
(
mg_dns_mes§ge
 *
msg
,

5561 
mg_dns_»sourû_»cÜd
 *
¼
, *
d©a
,

5562 
size_t
 
d©a_Ën
);

5567 
mg_£nd_dns_qu”y
(
mg_cÚÃùiÚ
 *
nc
, cÚ¡ *
Çme
,

5568 
qu”y_ty³
);

5575 
mg_dns_š£¹_h—d”
(
mbuf
 *
io
, 
size_t
 
pos
,

5576 
mg_dns_mes§ge
 *
msg
);

5586 
mg_dns_cİy_que¡iÚs
(
mbuf
 *
io
, 
mg_dns_mes§ge
 *
msg
);

5604 
mg_dns_’code_»cÜd
(
mbuf
 *
io
, 
mg_dns_»sourû_»cÜd
 *
¼
,

5605 cÚ¡ *
Çme
, 
size_t
 
Æ’
, cÚ¡ *
rd©a
,

5606 
size_t
 
¾’
);

5611 
mg_dns_’code_Çme
(
mbuf
 *
io
, cÚ¡ *
Çme
, 
size_t
 
Ën
);

5614 
mg_·r£_dns
(cÚ¡ *
buf
, 
Ën
, 
mg_dns_mes§ge
 *
msg
);

5629 
size_t
 
mg_dns_uncom´ess_Çme
(
mg_dns_mes§ge
 *
msg
, 
mg_¡r
 *
Çme
,

5630 *
d¡
, 
d¡_Ën
);

5644 
mg_£t_´ÙocŞ_dns
(
mg_cÚÃùiÚ
 *
nc
);

5646 #ifdeà
__ılu¥lus


5650 #ifdeà
MG_MODULE_LINES


5664 #iâdeà
CS_MONGOOSE_SRC_DNS_SERVER_H_


5665 
	#CS_MONGOOSE_SRC_DNS_SERVER_H_


	)

5667 #ià
MG_ENABLE_DNS_SERVER


5671 #ifdeà
__ılu¥lus


5675 
	#MG_DNS_SERVER_DEFAULT_TTL
 3600

	)

5677 
	smg_dns_»¶y
 {

5678 
mg_dns_mes§ge
 *
msg
;

5679 
mbuf
 *
io
;

5680 
size_t
 
¡¬t
;

5711 
mg_dns_»¶y
 
mg_dns_ü—‹_»¶y
(
mbuf
 *
io
,

5712 
mg_dns_mes§ge
 *
msg
);

5722 
mg_dns_»¶y_»cÜd
(
mg_dns_»¶y
 *
»¶y
,

5723 
mg_dns_»sourû_»cÜd
 *
que¡iÚ
,

5724 cÚ¡ *
Çme
, 
¹y³
, 
‰l
, cÚ¡ *
rd©a
,

5725 
size_t
 
rd©a_Ën
);

5739 
mg_dns_£nd_»¶y
(
mg_cÚÃùiÚ
 *
nc
, 
mg_dns_»¶y
 *
r
);

5741 #ifdeà
__ılu¥lus


5747 #ifdeà
MG_MODULE_LINES


5759 #iâdeà
CS_MONGOOSE_SRC_RESOLV_H_


5760 
	#CS_MONGOOSE_SRC_RESOLV_H_


	)

5764 #ifdeà
__ılu¥lus


5768 
	emg_»sŞve_”r
 {

5769 
MG_RESOLVE_OK
 = 0,

5770 
MG_RESOLVE_NO_ANSWERS
 = 1,

5771 
MG_RESOLVE_EXCEEDED_RETRY_COUNT
 = 2,

5772 
MG_RESOLVE_TIMEOUT
 = 3

5775 (*
mg_»sŞve_ÿÎback_t
)(
	tmg_dns_mes§ge
 *
	tdns_mes§ge
,

5776 *
	tu£r_d©a
, 
	tmg_»sŞve_”r
);

5779 
	smg_»sŞve_async_İts
 {

5780 cÚ¡ *
Çme£rv”
;

5781 
max_»Œ›s
;

5782 
timeout
;

5783 
acû±_l™”®
;

5784 
Úly_l™”®
;

5785 
mg_cÚÃùiÚ
 **
dns_cÚn
;

5789 
mg_»sŞve_async
(
mg_mgr
 *
mgr
, cÚ¡ *
Çme
, 
qu”y
,

5790 
mg_»sŞve_ÿÎback_t
 
cb
, *
d©a
);

5793 
mg_£t_Çme£rv”
(
mg_mgr
 *
mgr
, cÚ¡ *
Çme£rv”
);

5816 
mg_»sŞve_async_İt
(
mg_mgr
 *
mgr
, cÚ¡ *
Çme
, 
qu”y
,

5817 
mg_»sŞve_ÿÎback_t
 
cb
, *
d©a
,

5818 
mg_»sŞve_async_İts
 
İts
);

5825 
mg_»sŞve_äom_ho¡s_fe
(cÚ¡ *
ho¡
, 
sock‘_add»ss
 *
u§
);

5827 #ifdeà
__ılu¥lus


5831 #ifdeà
MG_MODULE_LINES


5865 #iâdeà
CS_MONGOOSE_SRC_COAP_H_


5866 
	#CS_MONGOOSE_SRC_COAP_H_


	)

5868 #ià
MG_ENABLE_COAP


5870 
	#MG_COAP_MSG_TYPE_FIELD
 0x2

	)

5871 
	#MG_COAP_CODE_CLASS_FIELD
 0x4

	)

5872 
	#MG_COAP_CODE_DETAIL_FIELD
 0x8

	)

5873 
	#MG_COAP_MSG_ID_FIELD
 0x10

	)

5874 
	#MG_COAP_TOKEN_FIELD
 0x20

	)

5875 
	#MG_COAP_OPTIOMG_FIELD
 0x40

	)

5876 
	#MG_COAP_PAYLOAD_FIELD
 0x80

	)

5878 
	#MG_COAP_ERROR
 0x10000

	)

5879 
	#MG_COAP_FORMAT_ERROR
 (
MG_COAP_ERROR
 | 0x20000)

	)

5880 
	#MG_COAP_IGNORE
 (
MG_COAP_ERROR
 | 0x40000)

	)

5881 
	#MG_COAP_NOT_ENOUGH_DATA
 (
MG_COAP_ERROR
 | 0x80000)

	)

5882 
	#MG_COAP_NETWORK_ERROR
 (
MG_COAP_ERROR
 | 0x100000)

	)

5884 
	#MG_COAP_MSG_CON
 0

	)

5885 
	#MG_COAP_MSG_NOC
 1

	)

5886 
	#MG_COAP_MSG_ACK
 2

	)

5887 
	#MG_COAP_MSG_RST
 3

	)

5888 
	#MG_COAP_MSG_MAX
 3

	)

5890 
	#MG_COAP_CODECLASS_REQUEST
 0

	)

5891 
	#MG_COAP_CODECLASS_RESP_OK
 2

	)

5892 
	#MG_COAP_CODECLASS_CLIENT_ERR
 4

	)

5893 
	#MG_COAP_CODECLASS_SRV_ERR
 5

	)

5895 
	#MG_COAP_EVENT_BASE
 300

	)

5896 
	#MG_EV_COAP_CON
 (
MG_COAP_EVENT_BASE
 + 
MG_COAP_MSG_CON
)

	)

5897 
	#MG_EV_COAP_NOC
 (
MG_COAP_EVENT_BASE
 + 
MG_COAP_MSG_NOC
)

	)

5898 
	#MG_EV_COAP_ACK
 (
MG_COAP_EVENT_BASE
 + 
MG_COAP_MSG_ACK
)

	)

5899 
	#MG_EV_COAP_RST
 (
MG_COAP_EVENT_BASE
 + 
MG_COAP_MSG_RST
)

	)

5906 
	smg_cßp_İtiÚ
 {

5907 
mg_cßp_İtiÚ
 *
Ãxt
;

5908 
ušt32_t
 
numb”
;

5909 
mg_¡r
 
v®ue
;

5913 
	smg_cßp_mes§ge
 {

5914 
ušt32_t
 
	gæags
;

5915 
ušt8_t
 
	gmsg_ty³
;

5916 
ušt8_t
 
	gcode_şass
;

5917 
ušt8_t
 
	gcode_d‘a
;

5918 
ušt16_t
 
	gmsg_id
;

5919 
mg_¡r
 
	gtok’
;

5920 
mg_cßp_İtiÚ
 *
	gİtiÚs
;

5921 
mg_¡r
 
	g·ylßd
;

5922 
mg_cßp_İtiÚ
 *
	gİtiomg_
;

5925 #ifdeà
__ılu¥lus


5930 
mg_£t_´ÙocŞ_cßp
(
mg_cÚÃùiÚ
 *
nc
);

5937 
mg_cßp_İtiÚ
 *
mg_cßp_add_İtiÚ
(
mg_cßp_mes§ge
 *
cm
,

5938 
ušt32_t
 
numb”
, *
v®ue
,

5939 
size_t
 
Ën
);

5945 
mg_cßp_ä“_İtiÚs
(
mg_cßp_mes§ge
 *
cm
);

5958 
ušt32_t
 
mg_cßp_£nd_mes§ge
(
mg_cÚÃùiÚ
 *
nc
,

5959 
mg_cßp_mes§ge
 *
cm
);

5966 
ušt32_t
 
mg_cßp_£nd_ack
(
mg_cÚÃùiÚ
 *
nc
, 
ušt16_t
 
msg_id
);

5983 
ušt32_t
 
mg_cßp_·r£
(
mbuf
 *
io
, 
mg_cßp_mes§ge
 *
cm
);

5990 
ušt32_t
 
mg_cßp_compo£
(
mg_cßp_mes§ge
 *
cm
, 
mbuf
 *
io
);

5992 #ifdeà
__ılu¥lus


5999 #ifdeà
MG_MODULE_LINES


6007 #iâdeà
CS_MONGOOSE_SRC_SNTP_H_


6008 
	#CS_MONGOOSE_SRC_SNTP_H_


	)

6010 #ià
MG_ENABLE_SNTP


6012 
	#MG_SNTP_EVENT_BASE
 500

	)

6018 
	#MG_SNTP_REPLY
 (
MG_SNTP_EVENT_BASE
 + 1)

	)

6021 
	#MG_SNTP_MALFORMED_REPLY
 (
MG_SNTP_EVENT_BASE
 + 2)

	)

6024 
	#MG_SNTP_FAILED
 (
MG_SNTP_EVENT_BASE
 + 3)

	)

6026 
	smg_¢_mes§ge
 {

6028 
kiss_of_d—th
;

6030 
time
;

6034 
mg_cÚÃùiÚ
 *
mg_¢_cÚÃù
(
mg_mgr
 *
mgr
,

6035 
MG_CB
(
mg_ev’t_hªdËr_t
 
ev’t_hªdËr
,

6036 *
u£r_d©a
),

6037 cÚ¡ *
¢_£rv”_Çme
);

6040 
mg_¢_£nd_»que¡
(
mg_cÚÃùiÚ
 *
c
);

6049 
mg_cÚÃùiÚ
 *
mg_¢_g‘_time
(
mg_mgr
 *
mgr
,

6050 
mg_ev’t_hªdËr_t
 
ev’t_hªdËr
,

6051 cÚ¡ *
¢_£rv”_Çme
);

6056 #ifdeà
MG_MODULE_LINES


6064 #iâdeà
CS_MONGOOSE_SRC_SOCKS_H_


6065 
	#CS_MONGOOSE_SRC_SOCKS_H_


	)

6067 #ià
MG_ENABLE_SOCKS


6069 
	#MG_SOCKS_VERSION
 5

	)

6071 
	#MG_SOCKS_HANDSHAKE_DONE
 
MG_F_USER_1


	)

6072 
	#MG_SOCKS_CONNECT_DONE
 
MG_F_USER_2


	)

6075 
	emg_socks_hªdshake_m‘hod
 {

6076 
	gMG_SOCKS_HANDSHAKE_NOAUTH
 = 0,

6077 
	gMG_SOCKS_HANDSHAKE_GSSAPI
 = 1,

6078 
	gMG_SOCKS_HANDSHAKE_USERPASS
 = 2,

6079 
	gMG_SOCKS_HANDSHAKE_FAILURE
 = 0xff,

6083 
	emg_socks_commªd
 {

6084 
	gMG_SOCKS_CMD_CONNECT
 = 1,

6085 
	gMG_SOCKS_CMD_BIND
 = 2,

6086 
	gMG_SOCKS_CMD_UDP_ASSOCIATE
 = 3,

6090 
	emg_socks_add»ss_ty³
 {

6091 
	gMG_SOCKS_ADDR_IPV4
 = 1,

6092 
	gMG_SOCKS_ADDR_DOMAIN
 = 3,

6093 
	gMG_SOCKS_ADDR_IPV6
 = 4,

6097 
	emg_socks_»¥Ú£
 {

6098 
	gMG_SOCKS_SUCCESS
 = 0,

6099 
	gMG_SOCKS_FAILURE
 = 1,

6100 
	gMG_SOCKS_NOT_ALLOWED
 = 2,

6101 
	gMG_SOCKS_NET_UNREACHABLE
 = 3,

6102 
	gMG_SOCKS_HOST_UNREACHABLE
 = 4,

6103 
	gMG_SOCKS_CONN_REFUSED
 = 5,

6104 
	gMG_SOCKS_TTL_EXPIRED
 = 6,

6105 
	gMG_SOCKS_CMD_NOT_SUPPORTED
 = 7,

6106 
	gMG_SOCKS_ADDR_NOT_SUPPORTED
 = 8,

6109 #ifdeà
__ılu¥lus


6114 
mg_£t_´ÙocŞ_socks
(
mg_cÚÃùiÚ
 *
c
);

6117 
mg_içû
 *
mg_socks_mk_içû
(
mg_mgr
 *, cÚ¡ *
´oxy_addr
);

6119 #ifdeà
__ılu¥lus


	@simplest_web_server.c

4 
	~"mÚgoo£.h
"

6 cÚ¡ *
	gs_h‰p_pÜt
 = "8000";

7 
mg_£rve_h‰p_İts
 
	gs_h‰p_£rv”_İts
;

9 
	$ev_hªdËr
(
mg_cÚÃùiÚ
 *
nc
, 
ev
, *
p
) {

10 ià(
ev
 =ğ
MG_EV_HTTP_REQUEST
) {

11 
	`mg_£rve_h‰p
(
nc
, (
h‰p_mes§ge
 *è
p
, 
s_h‰p_£rv”_İts
);

13 
	}
}

15 
	$maš
() {

16 
mg_mgr
 
mgr
;

17 
mg_cÚÃùiÚ
 *
nc
;

19 
	`mg_mgr_š™
(&
mgr
, 
NULL
);

20 
	`´štf
("S¹šg web s”v” oÀpÜˆ%s\n", 
s_h‰p_pÜt
);

21 
nc
 = 
	`mg_bšd
(&
mgr
, 
s_h‰p_pÜt
, 
ev_hªdËr
);

22 ià(
nc
 =ğ
NULL
) {

23 
	`´štf
("Failedo create†istener\n");

28 
	`mg_£t_´ÙocŞ_h‰p_websock‘
(
nc
);

29 
s_h‰p_£rv”_İts
.
docum’t_roÙ
 = ".";

30 
s_h‰p_£rv”_İts
.
’abË_dœeùÜy_li¡šg
 = "yes";

33 
	`mg_mgr_pŞl
(&
mgr
, 1000);

35 
	`mg_mgr_ä“
(&
mgr
);

38 
	}
}

	@
1
.
0
15
277
Edger8rSyntax/Arrays.cpp
Edger8rSyntax/Functions.cpp
Edger8rSyntax/Pointers.cpp
Edger8rSyntax/Types.cpp
Enclave.cpp
Enclave.h
Enclave_t.c
Enclave_t.h
TrustedLibrary/Libc.cpp
TrustedLibrary/Libcxx.cpp
TrustedLibrary/Thread.cpp
main.c
mongoose.c
mongoose.h
simplest_web_server.c
